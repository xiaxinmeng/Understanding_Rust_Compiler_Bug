{"sha": "e46b55d03847d5da02710dc7c53bed67edd007ad", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTQ2YjU1ZDAzODQ3ZDVkYTAyNzEwZGM3YzUzYmVkNjdlZGQwMDdhZA==", "commit": {"author": {"name": "Geoffrey Keating", "email": "geoffk@apple.com", "date": "2007-06-07T18:56:51Z"}, "committer": {"name": "Geoffrey Keating", "email": "geoffk@gcc.gnu.org", "date": "2007-06-07T18:56:51Z"}, "message": "Index: ChangeLog\n2007-06-06  Geoffrey Keating  <geoffk@apple.com>\n\t    Hui-May Chang <hm.chang@apple.com>\n\n\t* doc/invoke.texi (Darwin Options): Update documentation for\n\t-mmacosx-version-min.\n\t* config.gcc (*-*-darwin*): Set extra_gcc_objs.\n\t* config/darwin-driver.c: New file.\n\t* config/darwin.h (GCC_DRIVER_HOST_INITIALIZATION): New.\n\t* config/t-darwin (darwin-driver.o): New rule.\n\n\t* config/darwin-c.c (version_as_macro): Ignore low digit.\n\nIndex: testsuite/ChangeLog\n2007-06-06  Geoffrey Keating  <geoffk@apple.com>\n\n\t* gcc.dg/darwin-minversion-3.c: New.\n\nCo-Authored-By: Hui-May Chang <hm.chang@apple.com>\n\nFrom-SVN: r125537", "tree": {"sha": "d9d864d915cd9c3d17707352d3bf0704f21f26ab", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d9d864d915cd9c3d17707352d3bf0704f21f26ab"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e46b55d03847d5da02710dc7c53bed67edd007ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e46b55d03847d5da02710dc7c53bed67edd007ad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e46b55d03847d5da02710dc7c53bed67edd007ad", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e46b55d03847d5da02710dc7c53bed67edd007ad/comments", "author": {"login": "geoffk01", "id": 31905243, "node_id": "MDQ6VXNlcjMxOTA1MjQz", "avatar_url": "https://avatars.githubusercontent.com/u/31905243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/geoffk01", "html_url": "https://github.com/geoffk01", "followers_url": "https://api.github.com/users/geoffk01/followers", "following_url": "https://api.github.com/users/geoffk01/following{/other_user}", "gists_url": "https://api.github.com/users/geoffk01/gists{/gist_id}", "starred_url": "https://api.github.com/users/geoffk01/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/geoffk01/subscriptions", "organizations_url": "https://api.github.com/users/geoffk01/orgs", "repos_url": "https://api.github.com/users/geoffk01/repos", "events_url": "https://api.github.com/users/geoffk01/events{/privacy}", "received_events_url": "https://api.github.com/users/geoffk01/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "abea993f795f6b843d0a9ea036a93cb5d6f90bc1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/abea993f795f6b843d0a9ea036a93cb5d6f90bc1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/abea993f795f6b843d0a9ea036a93cb5d6f90bc1"}], "stats": {"total": 224, "additions": 208, "deletions": 16}, "files": [{"sha": "ba69834d817ccc6c4f687f889814235f9583a67d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -1,3 +1,15 @@\n+2007-06-06  Geoffrey Keating  <geoffk@apple.com>\n+\t    Hui-May Chang <hm.chang@apple.com>\n+\n+\t* doc/invoke.texi (Darwin Options): Update documentation for\n+\t-mmacosx-version-min.\n+\t* config.gcc (*-*-darwin*): Set extra_gcc_objs.\n+\t* config/darwin-driver.c: New file.\n+\t* config/darwin.h (GCC_DRIVER_HOST_INITIALIZATION): New.\n+\t* config/t-darwin (darwin-driver.o): New rule.\n+\n+\t* config/darwin-c.c (version_as_macro): Ignore low digit.\n+\n 2007-06-07  Uros Bizjak  <ubizjak@gmail.com>\n \n \t* config/i386/i386.md (standard sse constant splitter): Handle TFmode."}, {"sha": "24364e8b67b05ff8785e2b00b2d32f0b407b52e8", "filename": "gcc/config.gcc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig.gcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig.gcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig.gcc?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -393,6 +393,7 @@ case ${target} in\n   c_target_objs=\"darwin-c.o\"\n   cxx_target_objs=\"darwin-c.o\"\n   extra_objs=\"darwin.o\"\n+  extra_gcc_objs=\"darwin-driver.o\"\n   default_use_cxa_atexit=yes\n   case ${enable_threads} in\n     \"\" | yes | posix) thread_file='posix' ;;"}, {"sha": "04f5ada00bcbbd5966f88536895611064b1b1f41", "filename": "gcc/config/darwin-c.c", "status": "modified", "additions": 5, "deletions": 14, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Fdarwin-c.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Fdarwin-c.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin-c.c?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -567,8 +567,8 @@ find_subframework_header (cpp_reader *pfile, const char *header, cpp_dir **dirp)\n \n /* Return the value of darwin_macosx_version_min suitable for the\n    __ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ macro,\n-   so '10.4.2' becomes 1042.\n-   Print a warning if the version number is not known.  */\n+   so '10.4.2' becomes 1040.  The lowest digit is always zero.\n+   Print a warning if the version number can't be understood.  */\n static const char *\n version_as_macro (void)\n {\n@@ -579,18 +579,9 @@ version_as_macro (void)\n   if (! ISDIGIT (darwin_macosx_version_min[3]))\n     goto fail;\n   result[2] = darwin_macosx_version_min[3];\n-  if (darwin_macosx_version_min[4] != '\\0')\n-    {\n-      if (darwin_macosx_version_min[4] != '.')\n-\tgoto fail;\n-      if (! ISDIGIT (darwin_macosx_version_min[5]))\n-\tgoto fail;\n-      if (darwin_macosx_version_min[6] != '\\0')\n-\tgoto fail;\n-      result[3] = darwin_macosx_version_min[5];\n-    }\n-  else\n-    result[3] = '0';\n+  if (darwin_macosx_version_min[4] != '\\0'\n+      && darwin_macosx_version_min[4] != '.')\n+    goto fail;\n \n   return result;\n "}, {"sha": "2f7e09d14c6917114be4ba75d4740410ccf77129", "filename": "gcc/config/darwin-driver.c", "status": "added", "additions": 160, "deletions": 0, "changes": 160, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Fdarwin-driver.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Fdarwin-driver.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin-driver.c?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -0,0 +1,160 @@\n+/* Additional functions for the GCC driver on Darwin native.\n+   Copyright (C) 2006, 2007 Free Software Foundation, Inc.\n+   Contributed by Apple Computer Inc.\n+\n+This file is part of GCC.\n+\n+GCC is free software; you can redistribute it and/or modify\n+it under the terms of the GNU General Public License as published by\n+the Free Software Foundation; either version 2, or (at your option)\n+any later version.\n+\n+GCC is distributed in the hope that it will be useful,\n+but WITHOUT ANY WARRANTY; without even the implied warranty of\n+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+GNU General Public License for more details.\n+\n+You should have received a copy of the GNU General Public License\n+along with GCC; see the file COPYING.  If not, write to\n+the Free Software Foundation, 51 Franklin Street, Fifth Floor,\n+Boston, MA 02110-1301, USA.  */\n+\n+#ifndef CROSS_DIRECTORY_STRUCTURE\n+#include \"config.h\"\n+#include \"system.h\"\n+#include \"coretypes.h\"\n+#include \"tm.h\"\n+#include \"gcc.h\"\n+#include <sys/sysctl.h>\n+#include \"xregex.h\"\n+\n+#ifndef SWITCH_TAKES_ARG\n+#define SWITCH_TAKES_ARG(CHAR) DEFAULT_SWITCH_TAKES_ARG(CHAR)\n+#endif\n+\n+#ifndef WORD_SWITCH_TAKES_ARG\n+#define WORD_SWITCH_TAKES_ARG(STR) DEFAULT_WORD_SWITCH_TAKES_ARG (STR)\n+#endif\n+\n+/* When running on a Darwin system and using that system's headers and\n+   libraries, default the -mmacosx-version-min flag to be the version\n+   of the system on which the compiler is running.  */\n+\n+void\n+darwin_default_min_version (int * argc_p, char *** argv_p)\n+{\n+  const int argc = *argc_p;\n+  char ** const argv = *argv_p;\n+  int i;\n+  char osversion[32];\n+  size_t osversion_len = sizeof (osversion) - 1;\n+  static int osversion_name[2] = { CTL_KERN, KERN_OSRELEASE };\n+  char * version_p;\n+  char * version_pend;\n+  int major_vers;\n+  char minor_vers[6];\n+  static char new_flag[sizeof (\"-mmacosx-version-min=10.0.0\") + 6];\n+\n+  /* If the command-line is empty, just return.  */\n+  if (argc <= 1)\n+    return;\n+  /* Don't do this if the user has specified -b or -V at the start\n+     of the command-line.  */\n+  if (argv[1][0] == '-'\n+      && (argv[1][1] == 'V' ||\n+\t  ((argv[1][1] == 'b') && (NULL != strchr(argv[1] + 2,'-')))))\n+    return;\n+  \n+  /* Don't do this if the user specified -mmacosx-version-min= or\n+     -mno-macosx-version-min.  */\n+  for (i = 1; i < argc; i++)\n+    if (argv[i][0] == '-')\n+      {\n+\tconst char * const p = argv[i];\n+\tif (strncmp (p, \"-mno-macosx-version-min\", 23) == 0\n+\t    || strncmp (p, \"-mmacosx-version-min\", 20) == 0)\n+\t  return;\n+\t\n+\t/* It doesn't count if it's an argument to a different switch.  */\n+\tif (p[0] == '-'\n+\t    && ((SWITCH_TAKES_ARG (p[1]) > (p[2] != 0))\n+\t\t|| WORD_SWITCH_TAKES_ARG (p + 1)))\n+\t  i++;\n+      }\n+\n+  /* Retrieve the deployment target from the environment and insert\n+     it as a flag.  */\n+  {\n+    const char * macosx_deployment_target;\n+    macosx_deployment_target = getenv (\"MACOSX_DEPLOYMENT_TARGET\");\n+    if (macosx_deployment_target\n+\t/* Apparently, an empty string for MACOSX_DEPLOYMENT_TARGET means\n+\t   \"use the default\".  Or, possibly \"use 10.1\".  We choose\n+\t   to ignore the environment variable, as if it was never set.  */\n+\t&& macosx_deployment_target[0])\n+      {\n+\t++*argc_p;\n+\t*argv_p = xmalloc (sizeof (char *) * *argc_p);\n+\t(*argv_p)[0] = argv[0];\n+\t(*argv_p)[1] = concat (\"-mmacosx-version-min=\",\n+\t\t\t       macosx_deployment_target, NULL);\n+\tmemcpy (*argv_p + 2, argv + 1, (argc - 1) * sizeof (char *));\n+\treturn;\n+      }\n+  }\n+\n+  /* Determine the version of the running OS.  If we can't, warn user,\n+     and do nothing.  */\n+  if (sysctl (osversion_name, ARRAY_SIZE (osversion_name), osversion,\n+\t      &osversion_len, NULL, 0) == -1)\n+    {\n+      fprintf (stderr, \"sysctl for kern.osversion failed: %s\\n\",\n+\t       xstrerror (errno));\n+      return;\n+    }\n+\n+  /* Try to parse the first two parts of the OS version number.  Warn\n+     user and return if it doesn't make sense.  */\n+  if (! ISDIGIT (osversion[0]))\n+    goto parse_failed;\n+  major_vers = osversion[0] - '0';\n+  version_p = osversion + 1;\n+  if (ISDIGIT (*version_p))\n+    major_vers = major_vers * 10 + (*version_p++ - '0');\n+  if (major_vers > 4 + 9)\n+    goto parse_failed;\n+  if (*version_p++ != '.')\n+    goto parse_failed;\n+  version_pend = strchr(version_p, '.');\n+  if (!version_pend)\n+    goto parse_failed;\n+  if (! ISDIGIT (*version_p))\n+    goto parse_failed;\n+  strncpy(minor_vers, version_p, version_pend - version_p);\n+  minor_vers[version_pend - version_p] = '\\0';\n+  \n+  /* The major kernel version number is 4 plus the second OS version\n+     component.  */\n+  if (major_vers - 4 <= 4)\n+    /* On 10.4 and earlier, the old linker is used which does not\n+       support three-component system versions.  */\n+    sprintf (new_flag, \"-mmacosx-version-min=10.%d\", major_vers - 4);\n+  else\n+    sprintf (new_flag, \"-mmacosx-version-min=10.%d.%s\", major_vers - 4,\n+\t     minor_vers);\n+\n+  /* Add the new flag.  */\n+  ++*argc_p;\n+  *argv_p = xmalloc (sizeof (char *) * *argc_p);\n+  (*argv_p)[0] = argv[0];\n+  (*argv_p)[1] = new_flag;\n+  memcpy (*argv_p + 2, argv + 1, (argc - 1) * sizeof (char *));\n+  return;\n+  \n+ parse_failed:\n+  fprintf (stderr, \"couldn't understand kern.osversion `%.*s'\\n\",\n+\t   (int) osversion_len, osversion);\n+  return;\n+}\n+\n+#endif /* CROSS_DIRECTORY_STRUCTURE */"}, {"sha": "e135191c3fc9c623e2b2b1ce5e89a41334e7ffb1", "filename": "gcc/config/darwin.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Fdarwin.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Fdarwin.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.h?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -986,4 +986,10 @@ extern int flag_apple_kext;\n \n #define TARGET_HAS_TARGETCM 1\n \n+#ifndef CROSS_DIRECTORY_STRUCTURE\n+extern void darwin_default_min_version (int * argc, char *** argv);\n+#define GCC_DRIVER_HOST_INITIALIZATION \\\n+  darwin_default_min_version (&argc, &argv)\n+#endif /* CROSS_DIRECTORY_STRUCTURE */\n+\n #endif /* CONFIG_DARWIN_H */"}, {"sha": "2949e6baad02bd3fa161ed3f8358029c6c0e5430", "filename": "gcc/config/t-darwin", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Ft-darwin", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fconfig%2Ft-darwin", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Ft-darwin?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -12,6 +12,11 @@ darwin-c.o: $(srcdir)/config/darwin-c.c $(CONFIG_H) $(SYSTEM_H) coretypes.h \\\n \n gt-darwin.h : s-gtype ; @true\n \n+darwin-driver.o: $(srcdir)/config/darwin-driver.c \\\n+  $(CONFIG_H) $(SYSTEM_H) coretypes.h $(TM_H) $(GCC_H)\n+\t$(CC) -c $(ALL_CFLAGS) $(ALL_CPPFLAGS) $(INCLUDES) \\\n+\t  $(srcdir)/config/darwin-driver.c\n+\n # How to build crt3.o\n EXTRA_MULTILIB_PARTS=crt3.o\n # Pass -fno-tree-dominator-opts to work around bug 26840."}, {"sha": "220c5f573adbb2d46aea963e5668c5b56d876d1d", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -8763,8 +8763,10 @@ The earliest version of MacOS X that this executable will run on\n is @var{version}.  Typical values of @var{version} include @code{10.1},\n @code{10.2}, and @code{10.3.9}.\n \n-The default for this option is to make choices that seem to be most\n-useful.\n+If the compiler was built to use the system's headers by default,\n+then the default for this option is the system version on which the\n+compiler is running, otherwise the default is to make choices which\n+are compatible with as many systems and code bases as possible.\n \n @item -mkernel\n @opindex mkernel"}, {"sha": "d59c747e366314e5df54ea345291b4c4d9497784", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -1,3 +1,7 @@\n+2007-06-06  Geoffrey Keating  <geoffk@apple.com>\n+\n+\t* gcc.dg/darwin-minversion-3.c: New.\n+\n 2007-06-07  Uros Bizjak  <ubizjak@gmail.com>\n \n \t* gcc.target/i386/builtin-copysign.c: New test."}, {"sha": "d0c5934b449ece562d4fb3dbbe427169cb57ee52", "filename": "gcc/testsuite/gcc.dg/darwin-minversion-3.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Ftestsuite%2Fgcc.dg%2Fdarwin-minversion-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e46b55d03847d5da02710dc7c53bed67edd007ad/gcc%2Ftestsuite%2Fgcc.dg%2Fdarwin-minversion-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fdarwin-minversion-3.c?ref=e46b55d03847d5da02710dc7c53bed67edd007ad", "patch": "@@ -0,0 +1,11 @@\n+/* Test that most-minor versions greater than 9 work.  */\n+/* { dg-options \"-mmacosx-version-min=10.4.10\" } */\n+/* { dg-do compile { target *-*-darwin* } } */\n+\n+int main(void)\n+{\n+#if __ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ != 1040\n+  fail me;\n+#endif\n+  return 0;\n+}"}]}