{"sha": "348188bf59ad01b6575165ef52e72dd58d331735", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzQ4MTg4YmY1OWFkMDFiNjU3NTE2NWVmNTJlNzJkZDU4ZDMzMTczNQ==", "commit": {"author": {"name": "H.J. Lu", "email": "hongjiu.lu@intel.com", "date": "2017-11-15T19:30:58Z"}, "committer": {"name": "H.J. Lu", "email": "hjl@gcc.gnu.org", "date": "2017-11-15T19:30:58Z"}, "message": "i386: Add X86_TUNE_EMIT_VZEROUPPER\n\nAdd X86_TUNE_EMIT_VZEROUPPER to indicate if vzeroupper instruction should\nbe inserted before a transfer of control flow out of the function.  It is\nturned on by default unless we are tuning for KNL.  Users can always use\n-mzeroupper or -mno-zeroupper to override X86_TUNE_EMIT_VZEROUPPER.\n\ngcc/\n\n\tPR target/82990\n\t* config/i386/i386.c (pass_insert_vzeroupper::gate): Remove\n\tTARGET_AVX512ER check.\n\t(ix86_option_override_internal): Set MASK_VZEROUPPER if\n\tneither -mzeroupper nor -mno-zeroupper is used and\n\tTARGET_EMIT_VZEROUPPER is set.\n\t* config/i386/i386.h (TARGET_EMIT_VZEROUPPER): New.\n\t* config/i386/x86-tune.def: Add X86_TUNE_EMIT_VZEROUPPER.\n\ngcc/testsuite/\n\n\tPR target/82990\n\t* gcc.target/i386/pr82942-2.c: Add -mtune=knl.\n\t* gcc.target/i386/pr82990-1.c: New test.\n\t* gcc.target/i386/pr82990-2.c: Likewise.\n\t* gcc.target/i386/pr82990-3.c: Likewise.\n\t* gcc.target/i386/pr82990-4.c: Likewise.\n\t* gcc.target/i386/pr82990-5.c: Likewise.\n\t* gcc.target/i386/pr82990-6.c: Likewise.\n\t* gcc.target/i386/pr82990-7.c: Likewise.\n\nFrom-SVN: r254783", "tree": {"sha": "2cbdb40ab76164958e7ecb5cde1c55f5dbc40a67", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2cbdb40ab76164958e7ecb5cde1c55f5dbc40a67"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/348188bf59ad01b6575165ef52e72dd58d331735", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/348188bf59ad01b6575165ef52e72dd58d331735", "html_url": "https://github.com/Rust-GCC/gccrs/commit/348188bf59ad01b6575165ef52e72dd58d331735", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/348188bf59ad01b6575165ef52e72dd58d331735/comments", "author": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "41e181973e27274f2d188b9eff0c5935b76d559c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/41e181973e27274f2d188b9eff0c5935b76d559c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/41e181973e27274f2d188b9eff0c5935b76d559c"}], "stats": {"total": 94, "additions": 91, "deletions": 3}, "files": [{"sha": "eb4954e78c9c25a840a15bef6566daf2b3cf145b", "filename": "gcc/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -1,3 +1,14 @@\n+2017-11-15  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR target/82990\n+\t* config/i386/i386.c (pass_insert_vzeroupper::gate): Remove\n+\tTARGET_AVX512ER check.\n+\t(ix86_option_override_internal): Set MASK_VZEROUPPER if\n+\tneither -mzeroupper nor -mno-zeroupper is used and\n+\tTARGET_EMIT_VZEROUPPER is set.\n+\t* config/i386/i386.h (TARGET_EMIT_VZEROUPPER): New.\n+\t* config/i386/x86-tune.def: Add X86_TUNE_EMIT_VZEROUPPER.\n+\n 2017-11-15  Will Schmidt  <will_schmidt@vnet.ibm.com>\n \n \t* config/rs6000/rs6000.c (rs6000_gimple_fold_builtin): Add support for"}, {"sha": "c6ca071275563f2ff654f0ebd7bd15ace568e611", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -2497,7 +2497,7 @@ class pass_insert_vzeroupper : public rtl_opt_pass\n   /* opt_pass methods: */\n   virtual bool gate (function *)\n     {\n-      return TARGET_AVX && !TARGET_AVX512ER\n+      return TARGET_AVX\n \t     && TARGET_VZEROUPPER && flag_expensive_optimizations\n \t     && !optimize_size;\n     }\n@@ -4666,7 +4666,8 @@ ix86_option_override_internal (bool main_args_p,\n   if (TARGET_SEH && TARGET_CALL_MS2SYSV_XLOGUES)\n     sorry (\"-mcall-ms2sysv-xlogues isn%'t currently supported with SEH\");\n \n-  if (!(opts_set->x_target_flags & MASK_VZEROUPPER))\n+  if (!(opts_set->x_target_flags & MASK_VZEROUPPER)\n+      && TARGET_EMIT_VZEROUPPER)\n     opts->x_target_flags |= MASK_VZEROUPPER;\n   if (!(opts_set->x_target_flags & MASK_STV))\n     opts->x_target_flags |= MASK_STV;"}, {"sha": "a45e2df578374c65d3d9eccef98aead24cc72960", "filename": "gcc/config/i386/i386.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Fconfig%2Fi386%2Fi386.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Fconfig%2Fi386%2Fi386.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.h?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -517,6 +517,8 @@ extern unsigned char ix86_tune_features[X86_TUNE_LAST];\n \tix86_tune_features[X86_TUNE_AVOID_FALSE_DEP_FOR_BMI]\n #define TARGET_ONE_IF_CONV_INSN \\\n \tix86_tune_features[X86_TUNE_ONE_IF_CONV_INSN]\n+#define TARGET_EMIT_VZEROUPPER \\\n+\tix86_tune_features[X86_TUNE_EMIT_VZEROUPPER]\n \n /* Feature tests against the various architecture variations.  */\n enum ix86_arch_indices {"}, {"sha": "19fd2b52b30427458db65b668e79ef5181c52e21", "filename": "gcc/config/i386/x86-tune.def", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Fconfig%2Fi386%2Fx86-tune.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Fconfig%2Fi386%2Fx86-tune.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fx86-tune.def?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -543,3 +543,7 @@ DEF_TUNE (X86_TUNE_QIMODE_MATH, \"qimode_math\", ~0U)\n    arithmetic to 32bit via PROMOTE_MODE macro.  This code generation scheme\n    is usually used for RISC targets.  */\n DEF_TUNE (X86_TUNE_PROMOTE_QI_REGS, \"promote_qi_regs\", 0U)\n+\n+/* X86_TUNE_EMIT_VZEROUPPER: This enables vzeroupper instruction insertion\n+   before a transfer of control flow out of the function.  */\n+DEF_TUNE (X86_TUNE_EMIT_VZEROUPPER, \"emit_vzeroupper\", ~m_KNL)"}, {"sha": "06d87b981698ca607acfa9cf6787fbee0f4c7e49", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -1,3 +1,15 @@\n+2017-11-15  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR target/82990\n+\t* gcc.target/i386/pr82942-2.c: Add -mtune=knl.\n+\t* gcc.target/i386/pr82990-1.c: New test.\n+\t* gcc.target/i386/pr82990-2.c: Likewise.\n+\t* gcc.target/i386/pr82990-3.c: Likewise.\n+\t* gcc.target/i386/pr82990-4.c: Likewise.\n+\t* gcc.target/i386/pr82990-5.c: Likewise.\n+\t* gcc.target/i386/pr82990-6.c: Likewise.\n+\t* gcc.target/i386/pr82990-7.c: Likewise.\n+\n 2017-11-15  Will Schmidt  <will_schmidt@vnet.ibm.com>\n \n \t* gcc.target/powerpc/builtins-3-p9.c: Add -O1, update"}, {"sha": "ddb4e689659ba6f6892f212d03fee5def8c14474", "filename": "gcc/testsuite/gcc.target/i386/pr82942-2.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82942-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82942-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82942-2.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-mavx512f -mavx512er -O2\" } */\n+/* { dg-options \"-mavx512f -mavx512er -mtune=knl -O2\" } */\n \n #include \"pr82941-1.c\"\n "}, {"sha": "ff1d6d40eb2688c431bd234eff554d92d5c25f0f", "filename": "gcc/testsuite/gcc.target/i386/pr82990-1.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-1.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,14 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=knl -mvzeroupper\" } */\n+\n+#include <immintrin.h>\n+\n+extern __m512d y, z;\n+\n+void\n+pr82941 ()\n+{\n+  z = y;\n+}\n+\n+/* { dg-final { scan-assembler-times \"vzeroupper\" 1 } } */"}, {"sha": "0d3cb2333ddf529804bba183d0dbd3fd374b4a4c", "filename": "gcc/testsuite/gcc.target/i386/pr82990-2.c", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-2.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=skylake-avx512 -mno-vzeroupper\" } */\n+\n+#include \"pr82941-1.c\"\n+\n+/* { dg-final { scan-assembler-not \"vzeroupper\" } } */"}, {"sha": "201fa98d8d413ff23bffecb0deed9073ec2af216", "filename": "gcc/testsuite/gcc.target/i386/pr82990-3.c", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-3.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-mavx512f -mavx512er -mvzeroupper -O2\" } */\n+\n+#include \"pr82941-1.c\"\n+\n+/* { dg-final { scan-assembler-times \"vzeroupper\" 1 } } */"}, {"sha": "09f161c7291d98cad2892c2a43a093ee1fa88f90", "filename": "gcc/testsuite/gcc.target/i386/pr82990-4.c", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-4.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-mavx512f -mno-avx512er -mno-vzeroupper -O2\" } */\n+\n+#include \"pr82941-1.c\"\n+\n+/* { dg-final { scan-assembler-not \"vzeroupper\" } } */"}, {"sha": "9932bdc537568e9724e855db308bab071c0f03c9", "filename": "gcc/testsuite/gcc.target/i386/pr82990-5.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-5.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-5.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-5.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,14 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -mavx512f -mtune=generic\" } */\n+\n+#include <immintrin.h>\n+\n+extern __m512d y, z;\n+\n+void\n+pr82941 ()\n+{\n+  z = y;\n+}\n+\n+/* { dg-final { scan-assembler-times \"vzeroupper\" 1 } } */"}, {"sha": "063a61c111d7ff4db53eb7ff79e3b5482cf22846", "filename": "gcc/testsuite/gcc.target/i386/pr82990-6.c", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-6.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-6.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-6.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=skylake-avx512 -mtune=knl\" } */\n+\n+#include \"pr82941-1.c\"\n+\n+/* { dg-final { scan-assembler-not \"vzeroupper\" } } */"}, {"sha": "dedde8b854b997b022a12b8a3ff4fdd145415dbf", "filename": "gcc/testsuite/gcc.target/i386/pr82990-7.c", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-7.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/348188bf59ad01b6575165ef52e72dd58d331735/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-7.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr82990-7.c?ref=348188bf59ad01b6575165ef52e72dd58d331735", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=skylake-avx512 -mtune=generic -mtune-ctrl=^emit_vzeroupper\" } */\n+\n+#include \"pr82941-1.c\"\n+\n+/* { dg-final { scan-assembler-not \"vzeroupper\" } } */"}]}