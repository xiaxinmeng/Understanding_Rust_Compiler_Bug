{"sha": "d1039125cf7fb52634de26fe93cd892e15db2756", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDEwMzkxMjVjZjdmYjUyNjM0ZGUyNmZlOTNjZDg5MmUxNWRiMjc1Ng==", "commit": {"author": {"name": "Janus Weil", "email": "janus@gcc.gnu.org", "date": "2010-03-03T15:12:40Z"}, "committer": {"name": "Janus Weil", "email": "janus@gcc.gnu.org", "date": "2010-03-03T15:12:40Z"}, "message": "re PR fortran/43169 ([OOP] gfortran rejects pure procedure with select type construct)\n\n2010-03-03  Janus Weil  <janus@gcc.gnu.org>\n\n\tPR fortran/43169\n\t* resolve.c (resolve_code): Correctly set gfc_current_ns for\n\tEXEC_SELECT_TYPE.\n\t(gfc_impure_variable): Make it work with sub-namespaces (BLOCK etc).\n\t(gfc_pure): Ditto.\n\n\n2010-03-03  Janus Weil  <janus@gcc.gnu.org>\n\n\tPR fortran/43169\n\t* gfortran.dg/impure_assignment_3.f90: New.\n\nFrom-SVN: r157196", "tree": {"sha": "8870cecc1afada0f27f66dd2049bafb6ec5f3eb5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8870cecc1afada0f27f66dd2049bafb6ec5f3eb5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d1039125cf7fb52634de26fe93cd892e15db2756", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d1039125cf7fb52634de26fe93cd892e15db2756", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d1039125cf7fb52634de26fe93cd892e15db2756", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d1039125cf7fb52634de26fe93cd892e15db2756/comments", "author": {"login": "janusw", "id": 484108, "node_id": "MDQ6VXNlcjQ4NDEwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/484108?v=4", "gravatar_id": "", "url": "https://api.github.com/users/janusw", "html_url": "https://github.com/janusw", "followers_url": "https://api.github.com/users/janusw/followers", "following_url": "https://api.github.com/users/janusw/following{/other_user}", "gists_url": "https://api.github.com/users/janusw/gists{/gist_id}", "starred_url": "https://api.github.com/users/janusw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/janusw/subscriptions", "organizations_url": "https://api.github.com/users/janusw/orgs", "repos_url": "https://api.github.com/users/janusw/repos", "events_url": "https://api.github.com/users/janusw/events{/privacy}", "received_events_url": "https://api.github.com/users/janusw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "janusw", "id": 484108, "node_id": "MDQ6VXNlcjQ4NDEwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/484108?v=4", "gravatar_id": "", "url": "https://api.github.com/users/janusw", "html_url": "https://github.com/janusw", "followers_url": "https://api.github.com/users/janusw/followers", "following_url": "https://api.github.com/users/janusw/following{/other_user}", "gists_url": "https://api.github.com/users/janusw/gists{/gist_id}", "starred_url": "https://api.github.com/users/janusw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/janusw/subscriptions", "organizations_url": "https://api.github.com/users/janusw/orgs", "repos_url": "https://api.github.com/users/janusw/repos", "events_url": "https://api.github.com/users/janusw/events{/privacy}", "received_events_url": "https://api.github.com/users/janusw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ba34efc55ba605a18f858dc0d043ea90a07042a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2ba34efc55ba605a18f858dc0d043ea90a07042a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2ba34efc55ba605a18f858dc0d043ea90a07042a"}], "stats": {"total": 95, "additions": 88, "deletions": 7}, "files": [{"sha": "01f2f3c879337903e969ab141bdbb5a0123772b4", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=d1039125cf7fb52634de26fe93cd892e15db2756", "patch": "@@ -1,3 +1,11 @@\n+2010-03-03  Janus Weil  <janus@gcc.gnu.org>\n+\n+\tPR fortran/43169\n+\t* resolve.c (resolve_code): Correctly set gfc_current_ns for\n+\tEXEC_SELECT_TYPE.\n+\t(gfc_impure_variable): Make it work with sub-namespaces (BLOCK etc).\n+\t(gfc_pure): Ditto.\n+\n 2010-03-02  Paul Thomas  <pault@gcc.gnu.org>\n \n \tPR fortran/43180"}, {"sha": "10d880762c6b0da53931c008b521395cd343a5f4", "filename": "gcc/fortran/resolve.c", "status": "modified", "additions": 31, "deletions": 7, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ffortran%2Fresolve.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ffortran%2Fresolve.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fresolve.c?ref=d1039125cf7fb52634de26fe93cd892e15db2756", "patch": "@@ -8012,6 +8012,11 @@ resolve_code (gfc_code *code, gfc_namespace *ns)\n \t    case EXEC_OMP_DO:\n \t      gfc_resolve_omp_do_blocks (code, ns);\n \t      break;\n+\t    case EXEC_SELECT_TYPE:\n+\t      gfc_current_ns = code->ext.ns;\n+\t      gfc_resolve_blocks (code->block, gfc_current_ns);\n+\t      gfc_current_ns = ns;\n+\t      break;\n \t    case EXEC_OMP_WORKSHARE:\n \t      omp_workshare_save = omp_workshare_flag;\n \t      omp_workshare_flag = 1;\n@@ -11670,12 +11675,19 @@ int\n gfc_impure_variable (gfc_symbol *sym)\n {\n   gfc_symbol *proc;\n+  gfc_namespace *ns;\n \n   if (sym->attr.use_assoc || sym->attr.in_common)\n     return 1;\n \n-  if (sym->ns != gfc_current_ns)\n-    return !sym->attr.function;\n+  /* Check if the symbol's ns is inside the pure procedure.  */\n+  for (ns = gfc_current_ns; ns; ns = ns->parent)\n+    {\n+      if (ns == sym->ns)\n+\tbreak;\n+      if (ns->proc_name->attr.flavor == FL_PROCEDURE && !sym->attr.function)\n+\treturn 1;\n+    }\n \n   proc = sym->ns->proc_name;\n   if (sym->attr.dummy && gfc_pure (proc)\n@@ -11691,18 +11703,30 @@ gfc_impure_variable (gfc_symbol *sym)\n }\n \n \n-/* Test whether a symbol is pure or not.  For a NULL pointer, checks the\n-   symbol of the current procedure.  */\n+/* Test whether a symbol is pure or not.  For a NULL pointer, checks if the\n+   current namespace is inside a pure procedure.  */\n \n int\n gfc_pure (gfc_symbol *sym)\n {\n   symbol_attribute attr;\n+  gfc_namespace *ns;\n \n   if (sym == NULL)\n-    sym = gfc_current_ns->proc_name;\n-  if (sym == NULL)\n-    return 0;\n+    {\n+      /* Check if the current namespace or one of its parents\n+\tbelongs to a pure procedure.  */\n+      for (ns = gfc_current_ns; ns; ns = ns->parent)\n+\t{\n+\t  sym = ns->proc_name;\n+\t  if (sym == NULL)\n+\t    return 0;\n+\t  attr = sym->attr;\n+\t  if (attr.flavor == FL_PROCEDURE && (attr.pure || attr.elemental))\n+\t    return 1;\n+\t}\n+      return 0;\n+    }\n \n   attr = sym->attr;\n "}, {"sha": "b8e0ee7dd8da990b4e3ddd5c835521b8779422a7", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=d1039125cf7fb52634de26fe93cd892e15db2756", "patch": "@@ -1,3 +1,8 @@\n+2010-03-03  Janus Weil  <janus@gcc.gnu.org>\n+\n+\tPR fortran/43169\n+\t* gfortran.dg/impure_assignment_3.f90: New.\n+\n 2010-03-03  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR debug/43229"}, {"sha": "462ceb64d936b97bd1124498f9e407dd001ca037", "filename": "gcc/testsuite/gfortran.dg/impure_assignment_3.f90", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ftestsuite%2Fgfortran.dg%2Fimpure_assignment_3.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d1039125cf7fb52634de26fe93cd892e15db2756/gcc%2Ftestsuite%2Fgfortran.dg%2Fimpure_assignment_3.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fimpure_assignment_3.f90?ref=d1039125cf7fb52634de26fe93cd892e15db2756", "patch": "@@ -0,0 +1,44 @@\n+! { dg-do compile }\n+!\n+! PR 43169: [OOP] gfortran rejects PURE procedure with SELECT TYPE construct\n+!\n+! Original test case by Todd Hay <haymaker@mail.utexas.edu>\n+! Modified by Janus Weil <janus@gcc.gnu.org>\n+\n+  implicit none\n+  real :: g\n+\n+contains\n+\n+  pure subroutine sub1(x)\n+    type :: myType\n+      real :: a\n+    end type myType\n+    class(myType), intent(inout) :: x\n+    real :: r3\n+    select type(x)\n+    class is (myType)\n+      x%a = 42.\n+      r3 =  43.\n+      g = 44.             ! { dg-error \"Cannot assign to variable\" }\n+    end select\n+  end subroutine\n+\n+  pure subroutine sub2\n+    real :: r1\n+    block\n+      real :: r2\n+      r1 = 45.\n+      r2 = 46.\n+      g = 47.             ! { dg-error \"Cannot assign to variable\" }\n+    end block\n+  end subroutine\n+\n+  pure subroutine sub3\n+    block\n+      integer, save :: i  ! { dg-error \"cannot be specified in a PURE procedure\" }\n+      integer :: j = 5    ! { dg-error \"is not allowed in a PURE procedure\" }\n+    end block\n+  end subroutine\n+\n+end"}]}