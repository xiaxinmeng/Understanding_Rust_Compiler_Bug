{"sha": "b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjZmYmJlYTNjYTQ4OTIzOTBiNjQzZDNjMmMxYmY0NGExYTQyOGM4OA==", "commit": {"author": {"name": "Meador Inge", "email": "meadori@codesourcery.com", "date": "2012-06-21T20:20:30Z"}, "committer": {"name": "Meador Inge", "email": "meadori@gcc.gnu.org", "date": "2012-06-21T20:20:30Z"}, "message": "re PR c/53702 (ICE with -Wall and nested functions and unused typedef)\n\n\tPR c/53702\n\n\t* c-decl.c (c_push_function_context): Restore the behavior to reuse\n\tthe language function allocated for -Wunused-local-typedefs.\n\t(c_pop_function_context): If necessary, clear the language function\n\tcreated in c_push_function_context.  Always clear out the\n\tx_cur_stmt_list field of the restored language function.\n\ntestsuite/\n\t* gcc.dg/Wunused-local-typedefs.c: New testcase.\n\nFrom-SVN: r188860", "tree": {"sha": "0c88a3c22f7f5ed4598f0e757beea52db59e9943", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0c88a3c22f7f5ed4598f0e757beea52db59e9943"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/comments", "author": {"login": "meadori", "id": 296965, "node_id": "MDQ6VXNlcjI5Njk2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/296965?v=4", "gravatar_id": "", "url": "https://api.github.com/users/meadori", "html_url": "https://github.com/meadori", "followers_url": "https://api.github.com/users/meadori/followers", "following_url": "https://api.github.com/users/meadori/following{/other_user}", "gists_url": "https://api.github.com/users/meadori/gists{/gist_id}", "starred_url": "https://api.github.com/users/meadori/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/meadori/subscriptions", "organizations_url": "https://api.github.com/users/meadori/orgs", "repos_url": "https://api.github.com/users/meadori/repos", "events_url": "https://api.github.com/users/meadori/events{/privacy}", "received_events_url": "https://api.github.com/users/meadori/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "0619103bb2ec9b0c23df7b8d9aab613459090b16", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0619103bb2ec9b0c23df7b8d9aab613459090b16", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0619103bb2ec9b0c23df7b8d9aab613459090b16"}], "stats": {"total": 66, "additions": 62, "deletions": 4}, "files": [{"sha": "76c083c7b09e54968f6801aa0b59623cf04e490f", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "patch": "@@ -1,3 +1,12 @@\n+2012-06-21  Meador Inge  <meadori@codesourcery.com>\n+\n+\tPR c/53702\n+\t* c-decl.c (c_push_function_context): Restore the behavior to reuse\n+\tthe language function allocated for -Wunused-local-typedefs.\n+\t(c_pop_function_context): If necessary, clear the language function\n+\tcreated in c_push_function_context.  Always clear out the\n+\tx_cur_stmt_list field of the restored language function.\n+\n 2012-06-21   Sterling Augustine  <saugustine@google.com>\n         Cary Coutant  <ccoutant@google.com>\n "}, {"sha": "bbb437d8231163b12ee568d75efd70d03f6f5ff6", "filename": "gcc/c-decl.c", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2Fc-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2Fc-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-decl.c?ref=b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "patch": "@@ -8579,9 +8579,11 @@ check_for_loop_decls (location_t loc, bool turn_off_iso_c99_error)\n void\n c_push_function_context (void)\n {\n-  struct language_function *p;\n-  p = ggc_alloc_language_function ();\n-  cfun->language = p;\n+  struct language_function *p = cfun->language;\n+  /* cfun->language might have been already allocated by the use of\n+     -Wunused-local-typedefs.  In that case, just re-use it.  */\n+  if (p == NULL)\n+    cfun->language = p = ggc_alloc_cleared_language_function ();\n \n   p->base.x_stmt_tree = c_stmt_tree;\n   c_stmt_tree.x_cur_stmt_list\n@@ -8607,7 +8609,12 @@ c_pop_function_context (void)\n \n   pop_function_context ();\n   p = cfun->language;\n-  cfun->language = NULL;\n+\n+  /* When -Wunused-local-typedefs is in effect, cfun->languages is\n+     used to store data throughout the life time of the current cfun,\n+     So don't deallocate it.  */\n+  if (!warn_unused_local_typedefs)\n+    cfun->language = NULL;\n \n   if (DECL_STRUCT_FUNCTION (current_function_decl) == 0\n       && DECL_SAVED_TREE (current_function_decl) == NULL_TREE)\n@@ -8620,6 +8627,7 @@ c_pop_function_context (void)\n     }\n \n   c_stmt_tree = p->base.x_stmt_tree;\n+  p->base.x_stmt_tree.x_cur_stmt_list = NULL;\n   c_break_label = p->x_break_label;\n   c_cont_label = p->x_cont_label;\n   c_switch_stack = p->x_switch_stack;"}, {"sha": "48f5f4e79632f6fdf125dc1c6823df0d283afff9", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "patch": "@@ -1,3 +1,8 @@\n+2012-06-21  Meador Inge  <meadori@codesourcery.com>\n+\n+\tPR c/53702\n+\t* gcc.dg/Wunused-local-typedefs.c: New testcase.\n+\n 2012-06-21  Steven Bosscher  <steven@gcc.gnu.org>\n \n \t* testsuite/gcc.dg/pch/ident-1.c: New test."}, {"sha": "4c8c15ed20664527589f42c56a0cd6e32bb72370", "filename": "gcc/testsuite/gcc.dg/Wunused-local-typedefs.c", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2Ftestsuite%2Fgcc.dg%2FWunused-local-typedefs.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b6fbbea3ca4892390b643d3c2c1bf44a1a428c88/gcc%2Ftestsuite%2Fgcc.dg%2FWunused-local-typedefs.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2FWunused-local-typedefs.c?ref=b6fbbea3ca4892390b643d3c2c1bf44a1a428c88", "patch": "@@ -0,0 +1,36 @@\n+/*  Origin PR c/53702\n+    { dg-options \"-Wunused-local-typedefs\" }\n+    { dg-do compile }\n+*/\n+\n+/* Only test nested functions for C.  More tests that work for C and C++\n+   can be found in c-c++-common.\n+*/\n+\n+void\n+test0 ()\n+{\n+  typedef int foo; /* { dg-warning \"locally defined but not used\" } */\n+  void f ()\n+  {\n+  }\n+}\n+\n+void\n+test1 ()\n+{\n+  void f ()\n+  {\n+    typedef int foo; /* { dg-warning \"locally defined but not used\" } */\n+  }\n+}\n+\n+\n+void\n+test2 ()\n+{\n+  void f ()\n+  {\n+  }\n+  typedef int foo; /* { dg-warning \"locally defined but not used\" } */\n+}"}]}