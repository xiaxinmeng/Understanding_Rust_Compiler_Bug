{"sha": "870a0c2c3451169df67c0c82beaf865017e6e193", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODcwYTBjMmMzNDUxMTY5ZGY2N2MwYzgyYmVhZjg2NTAxN2U2ZTE5Mw==", "commit": {"author": {"name": "H.J. Lu", "email": "hjl@gnu.org", "date": "1999-05-27T12:11:03Z"}, "committer": {"name": "Jeff Law", "email": "law@gcc.gnu.org", "date": "1999-05-27T12:11:03Z"}, "message": "i386.c (output_fp_cc0_set): Don't check the JUMP_INSN code for conditional move.\n\n@\n        * i386.c (output_fp_cc0_set): Don't check the JUMP_INSN code for\n        conditional move.\n        (notice_update_cc, output_float_compare): Enable TARGET_CMOVE support.\n        (output_float_compare, output_fp_cc0_set): Fix the FLOAT comparison\n        for IEEE math and CC_FCOMI.\n        (put_jump_code): No IEEE if CC_FCOMI is set.\n\nFrom-SVN: r27204", "tree": {"sha": "3bec1b0c79f16bcc1ea798db666291a1a22d9f18", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3bec1b0c79f16bcc1ea798db666291a1a22d9f18"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/870a0c2c3451169df67c0c82beaf865017e6e193", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/870a0c2c3451169df67c0c82beaf865017e6e193", "html_url": "https://github.com/Rust-GCC/gccrs/commit/870a0c2c3451169df67c0c82beaf865017e6e193", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/870a0c2c3451169df67c0c82beaf865017e6e193/comments", "author": null, "committer": null, "parents": [{"sha": "aa2c277143a37c4321c9c10e4853512a27dc95a9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aa2c277143a37c4321c9c10e4853512a27dc95a9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aa2c277143a37c4321c9c10e4853512a27dc95a9"}], "stats": {"total": 168, "additions": 108, "deletions": 60}, "files": [{"sha": "3efedb64baa726e2ab66f5018105fd7f654388e5", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 108, "deletions": 60, "changes": 168, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/870a0c2c3451169df67c0c82beaf865017e6e193/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/870a0c2c3451169df67c0c82beaf865017e6e193/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=870a0c2c3451169df67c0c82beaf865017e6e193", "patch": "@@ -2995,7 +2995,8 @@ put_jump_code (code, reverse, file)\n      FILE *file;\n {\n   int flags = cc_prev_status.flags;\n-  int ieee = (TARGET_IEEE_FP && (flags & CC_IN_80387));\n+  int ieee = (TARGET_IEEE_FP && (flags & CC_IN_80387)\n+\t      && !(cc_prev_status.flags & CC_FCOMI));\n   const char *suffix;\n \n   if (flags & CC_Z_IN_NOT_C)\n@@ -3760,7 +3761,7 @@ notice_update_cc (exp)\n           if (stack_regs_mentioned_p (SET_SRC (XVECEXP (exp, 0, 0))))\n \t    {\n               cc_status.flags |= CC_IN_80387;\n-\t      if (0 && TARGET_CMOVE && stack_regs_mentioned_p\n+\t      if (TARGET_CMOVE && stack_regs_mentioned_p\n \t\t  (XEXP (SET_SRC (XVECEXP (exp, 0, 0)), 1)))\n \t\tcc_status.flags |= CC_FCOMI;\n \t    }\n@@ -4118,7 +4119,8 @@ output_float_compare (insn, operands)\n   int cc0_set = 1;\n   int i;\n \n-  if (0 && TARGET_CMOVE && STACK_REG_P (operands[1]))\n+  if (TARGET_CMOVE && STACK_REG_P (operands[1])\n+      && STACK_REG_P (operands[0]))\n     {\n       cc_status.flags |= CC_FCOMI;\n       cc_prev_status.flags &= ~CC_TEST_AX;\n@@ -4152,7 +4154,8 @@ output_float_compare (insn, operands)\n \t    {\n \t      output_asm_insn (AS2 (fucomip,%y1,%0), operands);\n \t      output_asm_insn (AS1 (fstp, %y0), operands);\n-\t      cc0_set = 0; \n+\t      if (!TARGET_IEEE_FP)\n+\t\tcc0_set = 0; \n \t    }\n \t  else\n \t    output_asm_insn (\"fucompp\", operands);\n@@ -4163,7 +4166,8 @@ output_float_compare (insn, operands)\n \t    {\n \t      output_asm_insn (AS2 (fcomip, %y1,%0), operands);\n \t      output_asm_insn (AS1 (fstp, %y0), operands);\n-\t      cc0_set = 0; \n+\t      if (!TARGET_IEEE_FP)\n+\t\tcc0_set = 0; \n \t    }\n \t  else\n \t    output_asm_insn (\"fcompp\", operands);\n@@ -4188,7 +4192,8 @@ output_float_compare (insn, operands)\n       if (cc_status.flags & CC_FCOMI)\n \t{\n \t  output_asm_insn (strcat (buf, AS2 (%z1,%y1,%0)), operands);\n-\t  cc0_set = 0; \n+\t  if (!TARGET_IEEE_FP)\n+\t    cc0_set = 0; \n \t}\n       else\n         output_asm_insn (strcat (buf, AS1 (%z1,%y1)), operands);\n@@ -4236,17 +4241,19 @@ output_fp_cc0_set (insn)\n   rtx next;\n   enum rtx_code code;\n \n-  xops[0] = gen_rtx_REG (HImode, 0);\n-  output_asm_insn (AS1 (fnsts%W0,%0), xops);\n+  if (!(cc_status.flags & CC_FCOMI))\n+    {\n+      xops[0] = gen_rtx_REG (HImode, 0);\n+      output_asm_insn (AS1 (fnsts%W0,%0), xops);\n+    }\n \n   if (! TARGET_IEEE_FP)\n     {\n       if (!(cc_status.flags & CC_REVERSED))\n         {\n           next = next_cc0_user (insn);\n-\n-          if (GET_CODE (next) == JUMP_INSN\n-              && GET_CODE (PATTERN (next)) == SET\n+  \n+          if (GET_CODE (PATTERN (next)) == SET\n               && SET_DEST (PATTERN (next)) == pc_rtx\n               && GET_CODE (SET_SRC (PATTERN (next))) == IF_THEN_ELSE)\n \t    code = GET_CODE (XEXP (SET_SRC (PATTERN (next)), 0));\n@@ -4271,8 +4278,7 @@ output_fp_cc0_set (insn)\n   if (next == NULL_RTX)\n     abort ();\n \n-  if (GET_CODE (next) == JUMP_INSN\n-      && GET_CODE (PATTERN (next)) == SET\n+  if (GET_CODE (PATTERN (next)) == SET\n       && SET_DEST (PATTERN (next)) == pc_rtx\n       && GET_CODE (SET_SRC (PATTERN (next))) == IF_THEN_ELSE)\n     code = GET_CODE (XEXP (SET_SRC (PATTERN (next)), 0));\n@@ -4295,61 +4301,103 @@ output_fp_cc0_set (insn)\n   else\n     abort ();\n \n-  xops[0] = gen_rtx_REG (QImode, 0);\n+  if (cc_status.flags & CC_FCOMI)\n+    {\n+      /* It is very tricky. We have to do it right. */\n \n-  switch (code)\n+      xops [0] = gen_rtx_REG (QImode, 0);\n+\n+      switch (code)\n+\t{\n+\tcase GT:\n+\tcase GE:\n+\t  break;\n+\n+\tcase LT:\n+\t  output_asm_insn (AS1 (setb,%b0), xops);\n+\t  output_asm_insn (AS1 (setp,%h0), xops);\n+\t  output_asm_insn (AS2 (cmp%B0,%b0,%h0), xops);\n+\t  break;\n+\n+\tcase LE:\n+\t  output_asm_insn (AS1 (setbe,%b0), xops);\n+\t  output_asm_insn (AS1 (setnp,%h0), xops);\n+\t  output_asm_insn (AS2 (xor%B0,%b0,%h0), xops);\n+\t  break;\n+\n+\tcase EQ:\n+\tcase NE:\n+\t  output_asm_insn (AS1 (setne,%b0), xops);\n+\t  output_asm_insn (AS1 (setp,%h0), xops);\n+\t  output_asm_insn (AS2 (or%B0,%b0,%h0), xops);\n+\t  break;\n+\n+\tcase GTU:\n+\tcase LTU:\n+\tcase GEU:\n+\tcase LEU:\n+\tdefault:\n+\t  abort ();\n+\t}\n+    }\n+  else\n     {\n-    case GT:\n-      xops[1] = GEN_INT (0x45);\n-      output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n-      /* je label */\n-      break;\n+      xops[0] = gen_rtx_REG (QImode, 0);\n \n-    case LT:\n-      xops[1] = GEN_INT (0x45);\n-      xops[2] = GEN_INT (0x01);\n-      output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n-      output_asm_insn (AS2 (cmp%B0,%2,%h0), xops);\n-      /* je label */\n-      break;\n+      switch (code)\n+\t{\n+\tcase GT:\n+\t  xops[1] = GEN_INT (0x45);\n+\t  output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n+\t  /* je label */\n+\t  break;\n \n-    case GE:\n-      xops[1] = GEN_INT (0x05);\n-      output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n-      /* je label */\n-      break;\n+\tcase LT:\n+\t  xops[1] = GEN_INT (0x45);\n+\t  xops[2] = GEN_INT (0x01);\n+\t  output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n+\t  output_asm_insn (AS2 (cmp%B0,%2,%h0), xops);\n+\t  /* je label */\n+\t  break;\n \n-    case LE:\n-      xops[1] = GEN_INT (0x45);\n-      xops[2] = GEN_INT (0x40);\n-      output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n-      output_asm_insn (AS1 (dec%B0,%h0), xops);\n-      output_asm_insn (AS2 (cmp%B0,%2,%h0), xops);\n-      /* jb label */\n-      break;\n+\tcase GE:\n+\t  xops[1] = GEN_INT (0x05);\n+\t  output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n+\t  /* je label */\n+\t  break;\n \n-    case EQ:\n-      xops[1] = GEN_INT (0x45);\n-      xops[2] = GEN_INT (0x40);\n-      output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n-      output_asm_insn (AS2 (cmp%B0,%2,%h0), xops);\n-      /* je label */\n-      break;\n+\tcase LE:\n+\t  xops[1] = GEN_INT (0x45);\n+\t  xops[2] = GEN_INT (0x40);\n+\t  output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n+\t  output_asm_insn (AS1 (dec%B0,%h0), xops);\n+\t  output_asm_insn (AS2 (cmp%B0,%2,%h0), xops);\n+\t  /* jb label */\n+\t  break;\n \n-    case NE:\n-      xops[1] = GEN_INT (0x44);\n-      xops[2] = GEN_INT (0x40);\n-      output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n-      output_asm_insn (AS2 (xor%B0,%2,%h0), xops);\n-      /* jne label */\n-      break;\n+\tcase EQ:\n+\t  xops[1] = GEN_INT (0x45);\n+\t  xops[2] = GEN_INT (0x40);\n+\t  output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n+\t  output_asm_insn (AS2 (cmp%B0,%2,%h0), xops);\n+\t  /* je label */\n+\t  break;\n \n-    case GTU:\n-    case LTU:\n-    case GEU:\n-    case LEU:\n-    default:\n-      abort ();\n+\tcase NE:\n+\t  xops[1] = GEN_INT (0x44);\n+\t  xops[2] = GEN_INT (0x40);\n+\t  output_asm_insn (AS2 (and%B0,%1,%h0), xops);\n+\t  output_asm_insn (AS2 (xor%B0,%2,%h0), xops);\n+\t  /* jne label */\n+\t  break;\n+\n+\tcase GTU:\n+\tcase LTU:\n+\tcase GEU:\n+\tcase LEU:\n+\tdefault:\n+\t  abort ();\n+\t}\n     }\n \n   return \"\";"}]}