{"sha": "1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWJiMmUxZDk2ZWIyM2QyMjg5NzY1Y2QwZmQ5ZWYxMGI3YTNiN2VhMw==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2019-07-08T08:13:48Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-08T08:13:48Z"}, "message": "[Ada] Crash on timed entry call with a delay given by a type conversion\n\nThis patch fixes a compiler crash in the compiler on a timed entry call\nwhose delay expression is a type conversion, when FLoat_Overflow checks\nare enabled.\n\n2019-07-08  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch9.adb (Expand_N_Timed_Entry_Call): Do not insert twice\n\tthe assignment statement that computes the delay value, to\n\tprevent improper tree sharing when the value is a type\n\tconversion and Float_Overflow checks are enabled.\n\ngcc/testsuite/\n\n\t* gnat.dg/entry1.adb, gnat.dg/entry1.ads: New testcase.\n\nFrom-SVN: r273210", "tree": {"sha": "b1108e19b45ac022aa019c1afef900cbf8b9c194", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b1108e19b45ac022aa019c1afef900cbf8b9c194"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "92c7734db7af1395be571c5ec023a38fb7b42adf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/92c7734db7af1395be571c5ec023a38fb7b42adf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/92c7734db7af1395be571c5ec023a38fb7b42adf"}], "stats": {"total": 115, "additions": 103, "deletions": 12}, "files": [{"sha": "1650732e2d68a389fe7f8524d7812dfaaeafcf31", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "patch": "@@ -1,3 +1,10 @@\n+2019-07-08  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* exp_ch9.adb (Expand_N_Timed_Entry_Call): Do not insert twice\n+\tthe assignment statement that computes the delay value, to\n+\tprevent improper tree sharing when the value is a type\n+\tconversion and Float_Overflow checks are enabled.\n+\n 2019-07-08  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* bindo.adb: Update the section on terminology to include new"}, {"sha": "e742ec3818c8728c8782bfafd035e03c2ce08b4b", "filename": "gcc/ada/exp_ch9.adb", "status": "modified", "additions": 13, "deletions": 12, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Fada%2Fexp_ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Fada%2Fexp_ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch9.adb?ref=1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "patch": "@@ -3887,6 +3887,7 @@ package body Exp_Ch9 is\n \n          if Unprotected then\n             Set_Protected_Formal (Formal, Defining_Identifier (New_Param));\n+            Set_Ekind (Defining_Identifier (New_Param), Ekind (Formal));\n          end if;\n \n          Append (New_Param, New_Plist);\n@@ -10711,7 +10712,7 @@ package body Exp_Ch9 is\n               Make_Defining_Identifier (Eloc,\n                 New_External_Name (Chars (Ename), 'A', Num_Accept));\n \n-            --  Link the acceptor to the original receiving entry\n+            --  Link the acceptor to the original receiving entry.\n \n             Set_Ekind           (PB_Ent, E_Procedure);\n             Set_Receiving_Entry (PB_Ent, Eent);\n@@ -12658,21 +12659,20 @@ package body Exp_Ch9 is\n           Object_Definition   => New_Occurrence_Of (Standard_Integer, Loc),\n           Expression          => D_Disc));\n \n-      --  Do the assignment at this stage only because the evaluation of the\n-      --  expression must not occur earlier (see ACVC C97302A).\n-\n-      Append_To (Stmts,\n-        Make_Assignment_Statement (Loc,\n-          Name       => New_Occurrence_Of (D, Loc),\n-          Expression => D_Conv));\n-\n       --  Parameter block processing\n \n       --  Manually create the parameter block for dispatching calls. In the\n       --  case of entries, the block has already been created during the call\n       --  to Build_Simple_Entry_Call.\n \n       if Is_Disp_Select then\n+         --  Compute the delay at this stage because the evaluation of\n+         --  its expression must not occur earlier (see ACVC C97302A).\n+\n+         Append_To (Stmts,\n+           Make_Assignment_Statement (Loc,\n+             Name       => New_Occurrence_Of (D, Loc),\n+             Expression => D_Conv));\n \n          --  Tagged kind processing, generate:\n          --    K : Ada.Tags.Tagged_Kind :=\n@@ -12855,8 +12855,8 @@ package body Exp_Ch9 is\n             Next (Stmt);\n          end loop;\n \n-         --  Do the assignment at this stage only because the evaluation\n-         --  of the expression must not occur earlier (see ACVC C97302A).\n+         --  Compute the delay at this stage because the evaluation of\n+         --  its expression must not occur earlier (see ACVC C97302A).\n \n          Insert_Before (Stmt,\n            Make_Assignment_Statement (Loc,\n@@ -14882,7 +14882,8 @@ package body Exp_Ch9 is\n \n          --  Ditto for a package declaration or a full type declaration, etc.\n \n-         elsif Nkind (N) = N_Package_Declaration\n+         elsif\n+           (Nkind (N) = N_Package_Declaration and then N /= Specification (N))\n            or else Nkind (N) in N_Declaration\n            or else Nkind (N) in N_Renaming_Declaration\n          then"}, {"sha": "25f6636f5f21b23b35dad740a4516408833d70f3", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "patch": "@@ -1,3 +1,7 @@\n+2019-07-08  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/entry1.adb, gnat.dg/entry1.ads: New testcase.\n+\n 2019-07-08  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/fixed_delete.adb: New testcase."}, {"sha": "7577a267124866963e1d740caf6fba0222437ad9", "filename": "gcc/testsuite/gnat.dg/entry1.adb", "status": "added", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Ftestsuite%2Fgnat.dg%2Fentry1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Ftestsuite%2Fgnat.dg%2Fentry1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fentry1.adb?ref=1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "patch": "@@ -0,0 +1,75 @@\n+--  { dg-do compile }\n+--  { dg-options \"-gnateF\" }\n+\n+PACKAGE BODY Entry1 IS\n+\n+   PROTECTED TYPE key_buffer IS\n+\n+      PROCEDURE clear;\n+\n+      ENTRY incr;\n+      ENTRY put (val : IN Natural);\n+      ENTRY get (val : OUT Natural);\n+\n+   PRIVATE\n+\n+      -- Stores Key states (key state controller)\n+      -- purpose: exclusive access\n+      max_len : Natural := 10;\n+\n+      cnt : Natural := 0;\n+\n+   END key_buffer;\n+\n+   PROTECTED BODY key_buffer IS\n+\n+      PROCEDURE clear IS\n+      BEGIN\n+         cnt := 0;\n+      END clear;\n+\n+      ENTRY incr WHEN cnt < max_len IS\n+      BEGIN\n+         cnt := cnt + 1;\n+      END;\n+\n+      ENTRY put (val : IN Natural) WHEN cnt < max_len IS\n+      BEGIN\n+         cnt := val;\n+      END put;\n+\n+      ENTRY get (val : OUT Natural) WHEN cnt > 0 IS\n+      BEGIN\n+         val := cnt;\n+      END get;\n+\n+   END key_buffer;\n+\n+   my_buffer : key_buffer;\n+\n+   FUNCTION pt2 (t : IN Float) RETURN Natural IS\n+      c : Natural;\n+      t2 : duration := duration (t);\n+   BEGIN\n+      SELECT\n+         my_buffer.get (c);\n+         RETURN c;\n+      OR\n+         DELAY t2;\n+         RETURN 0;\n+      END SELECT;\n+   END pt2;\n+\n+   FUNCTION pt (t : IN Float) RETURN Natural IS\n+      c : Natural;\n+   BEGIN\n+      SELECT\n+         my_buffer.get (c);\n+         RETURN c;\n+      OR\n+         DELAY Duration (t);\n+         RETURN 0;\n+      END SELECT;\n+   END pt;\n+\n+END Entry1;"}, {"sha": "7dcc7b5c38d5730bd4c4520fe8d3ca6b7e8f5c66", "filename": "gcc/testsuite/gnat.dg/entry1.ads", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Ftestsuite%2Fgnat.dg%2Fentry1.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3/gcc%2Ftestsuite%2Fgnat.dg%2Fentry1.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fentry1.ads?ref=1bb2e1d96eb23d2289765cd0fd9ef10b7a3b7ea3", "patch": "@@ -0,0 +1,4 @@\n+PACKAGE Entry1 IS\n+   FUNCTION pt (t : IN Float) RETURN Natural;\n+   FUNCTION pt2 (t : IN Float) RETURN Natural;\n+END Entry1;"}]}