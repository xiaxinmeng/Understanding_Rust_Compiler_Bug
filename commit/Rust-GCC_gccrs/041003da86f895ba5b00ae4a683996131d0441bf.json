{"sha": "041003da86f895ba5b00ae4a683996131d0441bf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDQxMDAzZGE4NmY4OTViYTViMDBhZTRhNjgzOTk2MTMxZDA0NDFiZg==", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-25T15:10:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-25T15:10:08Z"}, "message": "Merge #387\n\n387: Don't remove unreachable statements at HIR lowering r=philberty a=lrh2000\n\nThis is a legal code segment:\r\n```rust\r\nfn foo() -> i32 {\r\n    return 1;\r\n    let a = 1;\r\n    a\r\n}\r\n```\r\nAnd this is illegal:\r\n```rust\r\nfn foo() -> i32 {\r\n    return 1;\r\n    let a = 1.5;\r\n    a\r\n}\r\n```\r\nSo we shouldn't remove unreachable statements at HIR lowering. We can issue warnings for them, but they need to be kept so that their types can be checked.\r\n\r\n*(Original in https://github.com/Rust-GCC/gccrs/pull/364)*\n\nCo-authored-by: lrh2000 <lrh2000@pku.edu.cn>", "tree": {"sha": "a51292d9a0d11909025d31a17b69771b498f7d1f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a51292d9a0d11909025d31a17b69771b498f7d1f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/041003da86f895ba5b00ae4a683996131d0441bf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJghYZQCRBK7hj4Ov3rIwAABj4IAJE5avuWdjmuTo3jCvEqbPCy\nQraHgvY7VDcvp6Czdtmi4WWxBlBtuOszvszHeajj7khojQ2gr3XF7vtSIQHPvD1y\nylvtSGyMl53C/h0PdZa5n0L+5rEUnAJajLA00QlFaig/3cuC/86Hr4k0ypdKhCP/\nnf4+cQxz/doxgIHTo11P3qP9KT+4y3jE6rf6VIRFLOVjxjX1YXu/oxZOyORSF3Ut\nKB9YweiIRWsnnTIc0t2DFw7LZUX9kgowm3WGLVNjvTvSd3UxVE9t5jliz6U/GigA\n69YrQlvWPFj9QTonJUFHBX6WGg6d/36P9CWQy5RDaGnRi6RT12E/rvEAGV6mH6I=\n=hWRA\n-----END PGP SIGNATURE-----\n", "payload": "tree a51292d9a0d11909025d31a17b69771b498f7d1f\nparent de9af784e79926d01e8c030e999becc4b8bfad0f\nparent f48c7e87c5b9f7adbce961a0b081f59a5da999ab\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1619363408 +0000\ncommitter GitHub <noreply@github.com> 1619363408 +0000\n\nMerge #387\n\n387: Don't remove unreachable statements at HIR lowering r=philberty a=lrh2000\n\nThis is a legal code segment:\r\n```rust\r\nfn foo() -> i32 {\r\n    return 1;\r\n    let a = 1;\r\n    a\r\n}\r\n```\r\nAnd this is illegal:\r\n```rust\r\nfn foo() -> i32 {\r\n    return 1;\r\n    let a = 1.5;\r\n    a\r\n}\r\n```\r\nSo we shouldn't remove unreachable statements at HIR lowering. We can issue warnings for them, but they need to be kept so that their types can be checked.\r\n\r\n*(Original in https://github.com/Rust-GCC/gccrs/pull/364)*\n\nCo-authored-by: lrh2000 <lrh2000@pku.edu.cn>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/041003da86f895ba5b00ae4a683996131d0441bf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/041003da86f895ba5b00ae4a683996131d0441bf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/041003da86f895ba5b00ae4a683996131d0441bf/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de9af784e79926d01e8c030e999becc4b8bfad0f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/de9af784e79926d01e8c030e999becc4b8bfad0f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/de9af784e79926d01e8c030e999becc4b8bfad0f"}, {"sha": "f48c7e87c5b9f7adbce961a0b081f59a5da999ab", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f48c7e87c5b9f7adbce961a0b081f59a5da999ab", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f48c7e87c5b9f7adbce961a0b081f59a5da999ab"}], "stats": {"total": 66, "additions": 50, "deletions": 16}, "files": [{"sha": "61854a07cefc45574c9fff81c489f656f9bd5d6d", "filename": "gcc/rust/ast/rust-stmt.h", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Frust%2Fast%2Frust-stmt.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Frust%2Fast%2Frust-stmt.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-stmt.h?ref=041003da86f895ba5b00ae4a683996131d0441bf", "patch": "@@ -38,6 +38,8 @@ class EmptyStmt : public Stmt\n \n   EmptyStmt (Location locus) : locus (locus) {}\n \n+  Location get_locus_slow () const final override { return get_locus (); }\n+\n   Location get_locus () const { return locus; }\n \n   void accept_vis (ASTVisitor &vis) override;\n@@ -135,6 +137,8 @@ class LetStmt : public Stmt\n   LetStmt (LetStmt &&other) = default;\n   LetStmt &operator= (LetStmt &&other) = default;\n \n+  Location get_locus_slow () const final override { return get_locus (); }\n+\n   Location get_locus () const { return locus; }\n \n   void accept_vis (ASTVisitor &vis) override;"}, {"sha": "7ba5d32607a508fe10e54042ccc47104e773d7ba", "filename": "gcc/rust/hir/rust-ast-lower.cc", "status": "modified", "additions": 9, "deletions": 16, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Frust%2Fhir%2Frust-ast-lower.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Frust%2Fhir%2Frust-ast-lower.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower.cc?ref=041003da86f895ba5b00ae4a683996131d0441bf", "patch": "@@ -71,26 +71,16 @@ ASTLoweringBlock::visit (AST::BlockExpr &expr)\n   std::vector<std::unique_ptr<HIR::Stmt> > block_stmts;\n   bool block_did_terminate = false;\n   expr.iterate_stmts ([&] (AST::Stmt *s) mutable -> bool {\n+    if (block_did_terminate)\n+      rust_warning_at (s->get_locus_slow (), 0, \"unreachable statement\");\n+\n     bool terminated = false;\n     auto translated_stmt = ASTLoweringStmt::translate (s, &terminated);\n     block_stmts.push_back (std::unique_ptr<HIR::Stmt> (translated_stmt));\n-    block_did_terminate = terminated;\n-    return !block_did_terminate;\n-  });\n-\n-  // if there was a return expression everything after that becomes\n-  // unreachable code. This can be detected for any AST NodeIDs that have no\n-  // associated HIR Mappings\n-  expr.iterate_stmts ([&] (AST::Stmt *s) -> bool {\n-    HirId ref;\n-    if (!mappings->lookup_node_to_hir (mappings->get_current_crate (),\n-\t\t\t\t       s->get_node_id (), &ref))\n-      rust_warning_at (s->get_locus_slow (), 0, \"unreachable statement\");\n-\n+    block_did_terminate |= terminated;\n     return true;\n   });\n \n-  bool tail_reachable = !block_did_terminate;\n   if (expr.has_tail_expr () && block_did_terminate)\n     {\n       // warning unreachable tail expressions\n@@ -101,10 +91,13 @@ ASTLoweringBlock::visit (AST::BlockExpr &expr)\n   HIR::ExprWithoutBlock *tail_expr = nullptr;\n   if (expr.has_tail_expr ())\n     {\n-      tail_expr = (HIR::ExprWithoutBlock *) ASTLoweringExpr::translate (\n-\texpr.get_tail_expr ().get ());\n+      bool terminated = false;\n+      tail_expr = (HIR::ExprWithoutBlock *)\n+\tASTLoweringExpr::translate (expr.get_tail_expr ().get (), &terminated);\n+      block_did_terminate |= terminated;\n     }\n \n+  bool tail_reachable = !block_did_terminate;\n   auto crate_num = mappings->get_current_crate ();\n   Analysis::NodeMapping mapping (crate_num, expr.get_node_id (),\n \t\t\t\t mappings->get_next_hir_id (crate_num),"}, {"sha": "ba7d5f015e967cc47b089e1501f08b826ae983fa", "filename": "gcc/testsuite/rust.test/compile/deadcode2.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fdeadcode2.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fdeadcode2.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fdeadcode2.rs?ref=041003da86f895ba5b00ae4a683996131d0441bf", "patch": "@@ -0,0 +1,10 @@\n+fn foo() -> i32 {\n+    return 1;\n+\n+    let a = -1; // { dg-warning \"unreachable statement\" }\n+    a // { dg-warning \"unreachable expression\" }\n+}\n+\n+fn main() {\n+    foo();\n+}"}, {"sha": "8283231e45bef7d9d5047dd2c70b3a5d60582618", "filename": "gcc/testsuite/rust.test/xfail_compile/deadcode_err1.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Ftestsuite%2Frust.test%2Fxfail_compile%2Fdeadcode_err1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Ftestsuite%2Frust.test%2Fxfail_compile%2Fdeadcode_err1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fxfail_compile%2Fdeadcode_err1.rs?ref=041003da86f895ba5b00ae4a683996131d0441bf", "patch": "@@ -0,0 +1,11 @@\n+fn foo() -> i32 {\n+    return 1;\n+\n+    let mut a = 1; // { dg-warning \"unreachable statement\" }\n+    a = 1.1; // { dg-warning \"unreachable statement\" }\n+    // { dg-error \"expected .<integer>. got .<float>.\" \"\" { target { *-*-* } } .-1 }\n+}\n+\n+fn main() {\n+    foo();\n+}"}, {"sha": "8c0eb4617a76b3d8451f2e1c99f157cd70e831fe", "filename": "gcc/testsuite/rust.test/xfail_compile/deadcode_err2.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Ftestsuite%2Frust.test%2Fxfail_compile%2Fdeadcode_err2.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/041003da86f895ba5b00ae4a683996131d0441bf/gcc%2Ftestsuite%2Frust.test%2Fxfail_compile%2Fdeadcode_err2.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fxfail_compile%2Fdeadcode_err2.rs?ref=041003da86f895ba5b00ae4a683996131d0441bf", "patch": "@@ -0,0 +1,16 @@\n+fn foo() -> i32 {\n+    return 1;\n+    return 1.5; // { dg-error \"expected .i32. got .<float>.\" }\n+    // { dg-warning \"unreachable statement\" \"\" { target *-*-* } .-1 } \n+}\n+\n+fn bar() -> i32 {\n+    return 1.5; // { dg-error \"expected .i32. got .<float>.\" }\n+    return 1;\n+    // { dg-warning \"unreachable statement\" \"\" { target *-*-* } .-1 } \n+}\n+\n+fn main() {\n+    foo();\n+    bar();\n+}"}]}