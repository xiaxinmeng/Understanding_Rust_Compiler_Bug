{"sha": "821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODIxZGJlZWY0YjI1ZDdlZDVhZDRmOWJiNTA3ZTNiZDg1NzlkYTNhZg==", "commit": {"author": {"name": "Bin Cheng", "email": "bin.cheng@arm.com", "date": "2017-07-05T11:52:24Z"}, "committer": {"name": "Bin Cheng", "email": "amker@gcc.gnu.org", "date": "2017-07-05T11:52:24Z"}, "message": "tree-loop-distribution.c (enum fuse_type, [...]): New.\n\n\t* tree-loop-distribution.c (enum fuse_type, fuse_message): New.\n\t(partition_merge_into): New parameter.  Dump reason for fusion.\n\t(distribute_loop): Update use of partition_merge_into.\n\nFrom-SVN: r249986", "tree": {"sha": "439bf3d277b202410bfbc9a3137061af6bfeb5cc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/439bf3d277b202410bfbc9a3137061af6bfeb5cc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af", "html_url": "https://github.com/Rust-GCC/gccrs/commit/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af/comments", "author": null, "committer": null, "parents": [{"sha": "3be57c5600901c958769daf63d88264249afee7c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3be57c5600901c958769daf63d88264249afee7c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3be57c5600901c958769daf63d88264249afee7c"}], "stats": {"total": 72, "additions": 38, "deletions": 34}, "files": [{"sha": "c3e3a4a60f3baf9ff11e1bed6fd6f35faaf14408", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af", "patch": "@@ -1,3 +1,9 @@\n+2017-07-05  Bin Cheng  <bin.cheng@arm.com>\n+\n+\t* tree-loop-distribution.c (enum fuse_type, fuse_message): New.\n+\t(partition_merge_into): New parameter.  Dump reason for fusion.\n+\t(distribute_loop): Update use of partition_merge_into.\n+\n 2017-07-05  Bin Cheng  <bin.cheng@arm.com>\n \n \t* tree-loop-distribution.c (bb_top_order_index): New."}, {"sha": "f409e9461554678b451432ab19cd7b0136a1ecfb", "filename": "gcc/tree-loop-distribution.c", "status": "modified", "additions": 32, "deletions": 34, "changes": 66, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af/gcc%2Ftree-loop-distribution.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af/gcc%2Ftree-loop-distribution.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-loop-distribution.c?ref=821dbeef4b25d7ed5ad4f9bb507e3bd8579da3af", "patch": "@@ -545,15 +545,42 @@ partition_reduction_p (partition *partition)\n   return partition->reduction_p;\n }\n \n+/* Partitions are fused because of different reasons.  */\n+enum fuse_type\n+{\n+  FUSE_NON_BUILTIN = 0,\n+  FUSE_REDUCTION = 1,\n+  FUSE_SHARE_REF = 2,\n+  FUSE_SAME_SCC = 3,\n+  FUSE_FINALIZE = 4\n+};\n+\n+/* Description on different fusing reason.  */\n+static const char *fuse_message[] = {\n+  \"they are non-builtins\",\n+  \"they have reductions\",\n+  \"they have shared memory refs\",\n+  \"they are in the same dependence scc\",\n+  \"there is no point to distribute loop\"};\n+\n /* Merge PARTITION into the partition DEST.  */\n \n static void\n-partition_merge_into (partition *dest, partition *partition)\n+partition_merge_into (partition *dest, partition *partition, enum fuse_type ft)\n {\n   dest->kind = PKIND_NORMAL;\n   bitmap_ior_into (dest->stmts, partition->stmts);\n   if (partition_reduction_p (partition))\n     dest->reduction_p = true;\n+\n+  if (dump_file && (dump_flags & TDF_DETAILS))\n+    {\n+      fprintf (dump_file, \"Fuse partitions because %s:\\n\", fuse_message[ft]);\n+      fprintf (dump_file, \"  Part 1: \");\n+      dump_bitmap (dump_file, dest->stmts);\n+      fprintf (dump_file, \"  Part 2: \");\n+      dump_bitmap (dump_file, partition->stmts);\n+    }\n }\n \n \n@@ -1531,13 +1558,7 @@ distribute_loop (struct loop *loop, vec<gimple *> stmts,\n       for (++i; partitions.iterate (i, &partition); ++i)\n \tif (!partition_builtin_p (partition))\n \t  {\n-\t    if (dump_file && (dump_flags & TDF_DETAILS))\n-\t      {\n-\t\tfprintf (dump_file, \"fusing non-builtin partitions\\n\");\n-\t\tdump_bitmap (dump_file, into->stmts);\n-\t\tdump_bitmap (dump_file, partition->stmts);\n-\t      }\n-\t    partition_merge_into (into, partition);\n+\t    partition_merge_into (into, partition, FUSE_NON_BUILTIN);\n \t    partitions.unordered_remove (i);\n \t    partition_free (partition);\n \t    i--;\n@@ -1553,14 +1574,7 @@ distribute_loop (struct loop *loop, vec<gimple *> stmts,\n   for (i = i + 1; partitions.iterate (i, &partition); ++i)\n     if (partition_reduction_p (partition))\n       {\n-\tif (dump_file && (dump_flags & TDF_DETAILS))\n-\t  {\n-\t    fprintf (dump_file, \"fusing partitions\\n\");\n-\t    dump_bitmap (dump_file, into->stmts);\n-\t    dump_bitmap (dump_file, partition->stmts);\n-\t    fprintf (dump_file, \"because they have reductions\\n\");\n-\t  }\n-\tpartition_merge_into (into, partition);\n+\tpartition_merge_into (into, partition, FUSE_REDUCTION);\n \tpartitions.unordered_remove (i);\n \tpartition_free (partition);\n \ti--;\n@@ -1578,15 +1592,7 @@ distribute_loop (struct loop *loop, vec<gimple *> stmts,\n \t{\n \t  if (similar_memory_accesses (rdg, into, partition))\n \t    {\n-\t      if (dump_file && (dump_flags & TDF_DETAILS))\n-\t\t{\n-\t\t  fprintf (dump_file, \"fusing partitions\\n\");\n-\t\t  dump_bitmap (dump_file, into->stmts);\n-\t\t  dump_bitmap (dump_file, partition->stmts);\n-\t\t  fprintf (dump_file, \"because they have similar \"\n-\t\t\t   \"memory accesses\\n\");\n-\t\t}\n-\t      partition_merge_into (into, partition);\n+\t      partition_merge_into (into, partition, FUSE_SHARE_REF);\n \t      partitions.unordered_remove (j);\n \t      partition_free (partition);\n \t      j--;\n@@ -1678,15 +1684,7 @@ distribute_loop (struct loop *loop, vec<gimple *> stmts,\n \t  for (j = j + 1; partitions.iterate (j, &partition); ++j)\n \t    if (pg->vertices[j].component == i)\n \t      {\n-\t\tif (dump_file && (dump_flags & TDF_DETAILS))\n-\t\t  {\n-\t\t    fprintf (dump_file, \"fusing partitions\\n\");\n-\t\t    dump_bitmap (dump_file, first->stmts);\n-\t\t    dump_bitmap (dump_file, partition->stmts);\n-\t\t    fprintf (dump_file, \"because they are in the same \"\n-\t\t\t     \"dependence SCC\\n\");\n-\t\t  }\n-\t\tpartition_merge_into (first, partition);\n+\t\tpartition_merge_into (first, partition, FUSE_SAME_SCC);\n \t\tpartitions[j] = NULL;\n \t\tpartition_free (partition);\n \t\tPGDATA (j)->partition = NULL;"}]}