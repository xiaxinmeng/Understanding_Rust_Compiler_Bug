{"sha": "6788f5ca12b792117998e35270093704fa257857", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njc4OGY1Y2ExMmI3OTIxMTc5OThlMzUyNzAwOTM3MDRmYTI1Nzg1Nw==", "commit": {"author": {"name": "Geoffrey Keating", "email": "geoffk@apple.com", "date": "2003-03-19T03:23:44Z"}, "committer": {"name": "Geoffrey Keating", "email": "geoffk@gcc.gnu.org", "date": "2003-03-19T03:23:44Z"}, "message": "rs6000.c (rs6000_emit_prologue): Don't clone the result of machopic_function_base_name.\n\n\t* config/rs6000/rs6000.c (rs6000_emit_prologue): Don't clone\n\tthe result of machopic_function_base_name.\n\t* config/darwin.c (machopic_function_base_name): Use a gc-allocated\n\tstring rather than a static array.\n\nFrom-SVN: r64569", "tree": {"sha": "4d43639afd8328544c86b6630fd7a68f0f8f673d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4d43639afd8328544c86b6630fd7a68f0f8f673d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6788f5ca12b792117998e35270093704fa257857", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6788f5ca12b792117998e35270093704fa257857", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6788f5ca12b792117998e35270093704fa257857", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6788f5ca12b792117998e35270093704fa257857/comments", "author": {"login": "geoffk01", "id": 31905243, "node_id": "MDQ6VXNlcjMxOTA1MjQz", "avatar_url": "https://avatars.githubusercontent.com/u/31905243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/geoffk01", "html_url": "https://github.com/geoffk01", "followers_url": "https://api.github.com/users/geoffk01/followers", "following_url": "https://api.github.com/users/geoffk01/following{/other_user}", "gists_url": "https://api.github.com/users/geoffk01/gists{/gist_id}", "starred_url": "https://api.github.com/users/geoffk01/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/geoffk01/subscriptions", "organizations_url": "https://api.github.com/users/geoffk01/orgs", "repos_url": "https://api.github.com/users/geoffk01/repos", "events_url": "https://api.github.com/users/geoffk01/events{/privacy}", "received_events_url": "https://api.github.com/users/geoffk01/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "178274da22dd1139e61f1102de5e8f79a1bc9442", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/178274da22dd1139e61f1102de5e8f79a1bc9442", "html_url": "https://github.com/Rust-GCC/gccrs/commit/178274da22dd1139e61f1102de5e8f79a1bc9442"}], "stats": {"total": 35, "additions": 25, "deletions": 10}, "files": [{"sha": "4c8d0b41d5d010b886c112f90b7470a01c066b1c", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6788f5ca12b792117998e35270093704fa257857/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6788f5ca12b792117998e35270093704fa257857/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=6788f5ca12b792117998e35270093704fa257857", "patch": "@@ -18,6 +18,11 @@\n \n 2003-03-18  Geoffrey Keating  <geoffk@apple.com>\n \n+\t* config/rs6000/rs6000.c (rs6000_emit_prologue): Don't clone\n+\tthe result of machopic_function_base_name.\n+\t* config/darwin.c (machopic_function_base_name): Use a gc-allocated\n+\tstring rather than a static array.\n+\n \t* Makefile.in (emit-rtl.o): Add gt-emit-rtl.h to dependencies.\n \n \t* gengtype.c: Include rtl.h."}, {"sha": "934d99725bfd675fe2088989192a95f499f08b86", "filename": "gcc/config/darwin.c", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6788f5ca12b792117998e35270093704fa257857/gcc%2Fconfig%2Fdarwin.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6788f5ca12b792117998e35270093704fa257857/gcc%2Fconfig%2Fdarwin.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.c?ref=6788f5ca12b792117998e35270093704fa257857", "patch": "@@ -219,24 +219,26 @@ machopic_define_name (name)\n }\n \n /* This is a static to make inline functions work.  The rtx\n-   representing the PIC base symbol always points to here.  */\n+   representing the PIC base symbol always points to here.  \n \n-static char function_base[32];\n+   FIXME: The rest of the compiler doesn't expect strings to change.  */\n \n+static GTY(()) char * function_base;\n+static GTY(()) const char * function_base_func_name;\n static GTY(()) int current_pic_label_num;\n \n const char *\n machopic_function_base_name ()\n {\n-  static const char *name = NULL;\n-  static const char *current_name;\n+  const char *current_name;\n \n   /* if dynamic-no-pic is on, we should not get here */\n   if (MACHO_DYNAMIC_NO_PIC_P)\n     abort ();\n-  current_name = IDENTIFIER_POINTER (DECL_ASSEMBLER_NAME (current_function_decl));\n+  current_name = \n+    IDENTIFIER_POINTER (DECL_ASSEMBLER_NAME (current_function_decl));\n \n-  if (name != current_name)\n+  if (function_base_func_name != current_name)\n     {\n       current_function_uses_pic_offset_table = 1;\n \n@@ -246,13 +248,21 @@ machopic_function_base_name ()\n \t by the incredibly scientific test below.  This is because code in\n \t rs6000.c makes the same ugly test when loading the PIC reg.  */\n  \n+      /* It's hard to describe just how ugly this is.  The reason for\n+         the '%011d' is that after a PCH load, we can't change the\n+         size of the string, because PCH will have uniqued it and\n+         allocated it in the string pool.  */\n+      if (function_base == NULL)\n+\tfunction_base = \n+\t  (char *) ggc_alloc_string (\"\", sizeof (\"*\\\"L12345678901$pb\\\"\"));\n+\n       ++current_pic_label_num;\n       if (*current_name == '+' || *current_name == '-')\n-\tsprintf (function_base, \"*\\\"L-%d$pb\\\"\", current_pic_label_num);\n+\tsprintf (function_base, \"*\\\"L-%010d$pb\\\"\", current_pic_label_num);\n       else\n-\tsprintf (function_base, \"*L%d$pb\", current_pic_label_num);\n+\tsprintf (function_base, \"*\\\"L%011d$pb\\\"\", current_pic_label_num);\n \n-      name = current_name;\n+      function_base_func_name = current_name;\n     }\n \n   return function_base;"}, {"sha": "ff3f940fca9ac3f0d1e7848456efcd31ab1b7526", "filename": "gcc/config/rs6000/rs6000.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6788f5ca12b792117998e35270093704fa257857/gcc%2Fconfig%2Frs6000%2Frs6000.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6788f5ca12b792117998e35270093704fa257857/gcc%2Fconfig%2Frs6000%2Frs6000.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.c?ref=6788f5ca12b792117998e35270093704fa257857", "patch": "@@ -10799,7 +10799,7 @@ rs6000_emit_prologue ()\n     {\n       rtx dest = gen_rtx_REG (Pmode, LINK_REGISTER_REGNUM);\n       const char *picbase = machopic_function_base_name ();\n-      rtx src = gen_rtx_SYMBOL_REF (Pmode, ggc_alloc_string (picbase, -1));\n+      rtx src = gen_rtx_SYMBOL_REF (Pmode, picbase);\n \n       rs6000_maybe_dead (emit_insn (gen_load_macho_picbase (dest, src)));\n "}]}