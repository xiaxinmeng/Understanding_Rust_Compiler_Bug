{"sha": "8248cf4b7006af19298f0b944c212fe2b4b66bef", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODI0OGNmNGI3MDA2YWYxOTI5OGYwYjk0NGMyMTJmZTJiNGI2NmJlZg==", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2020-05-27T11:26:36Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-07-10T09:16:18Z"}, "message": "[Ada] Revert too late setting of Ekind on discriminants\n\ngcc/ada/\n\n\t* sem_ch3.adb (Process_Discriminants): Revert recent change to\n\tlocation of Set_Ekind; detect effectively volatile discriminants\n\tby their type only.", "tree": {"sha": "aa16477f833c4ab515f514b1629ef3417ad68736", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aa16477f833c4ab515f514b1629ef3417ad68736"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8248cf4b7006af19298f0b944c212fe2b4b66bef", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8248cf4b7006af19298f0b944c212fe2b4b66bef", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8248cf4b7006af19298f0b944c212fe2b4b66bef", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8248cf4b7006af19298f0b944c212fe2b4b66bef/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25af525c300abc790ef35bf2d8fb083a570b840a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/25af525c300abc790ef35bf2d8fb083a570b840a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/25af525c300abc790ef35bf2d8fb083a570b840a"}], "stats": {"total": 9, "additions": 6, "deletions": 3}, "files": [{"sha": "68bb5fcd503cccc7bfba862490b6858de787e3c8", "filename": "gcc/ada/sem_ch3.adb", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8248cf4b7006af19298f0b944c212fe2b4b66bef/gcc%2Fada%2Fsem_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8248cf4b7006af19298f0b944c212fe2b4b66bef/gcc%2Fada%2Fsem_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch3.adb?ref=8248cf4b7006af19298f0b944c212fe2b4b66bef", "patch": "@@ -19977,7 +19977,6 @@ package body Sem_Ch3 is\n          end if;\n \n          Set_Etype (Defining_Identifier (Discr), Discr_Type);\n-         Set_Ekind (Defining_Identifier (Discr), E_Discriminant);\n \n          --  If a discriminant specification includes the assignment compound\n          --  delimiter followed by an expression, the expression is the default\n@@ -20131,10 +20130,13 @@ package body Sem_Ch3 is\n \n          --  A discriminant cannot be effectively volatile (SPARK RM 7.1.3(4)).\n          --  This check is relevant only when SPARK_Mode is on as it is not a\n-         --  standard Ada legality rule.\n+         --  standard Ada legality rule. The only way for a discriminant to be\n+         --  effectively volatile is to have an effectively volatile type, so\n+         --  we check this directly, because the Ekind of Discr might not be\n+         --  set yet (to help preventing cascaded errors on derived types).\n \n          if SPARK_Mode = On\n-           and then Is_Effectively_Volatile (Defining_Identifier (Discr))\n+           and then Is_Effectively_Volatile (Discr_Type)\n          then\n             Error_Msg_N (\"discriminant cannot be volatile\", Discr);\n          end if;\n@@ -20176,6 +20178,7 @@ package body Sem_Ch3 is\n       Discr_Number := Uint_1;\n       while Present (Discr) loop\n          Id := Defining_Identifier (Discr);\n+         Set_Ekind (Id, E_Discriminant);\n          Init_Component_Location (Id);\n          Init_Esize (Id);\n          Set_Discriminant_Number (Id, Discr_Number);"}]}