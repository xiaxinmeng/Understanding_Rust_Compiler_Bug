{"sha": "f600f271b10d0214b111f2aa52a3d5740477e139", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjYwMGYyNzFiMTBkMDIxNGIxMTFmMmFhNTJhM2Q1NzQwNDc3ZTEzOQ==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2021-02-19T09:42:15Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2021-02-19T09:42:15Z"}, "message": "Fortran: Fix ubound simplifcation [PR99027]\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/99027\n\t* simplify.c (simplify_bound_dim): Honor DIMEN_ELEMENT\n\twhen using dim=.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/99027\n\t* gfortran.dg/ubound_1.f90: New test.", "tree": {"sha": "810888630a9f38f4684a76dba90c74deea810dd8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/810888630a9f38f4684a76dba90c74deea810dd8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f600f271b10d0214b111f2aa52a3d5740477e139", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f600f271b10d0214b111f2aa52a3d5740477e139", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f600f271b10d0214b111f2aa52a3d5740477e139", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f600f271b10d0214b111f2aa52a3d5740477e139/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6070e39cd0af6ac4a88004c8b1b6a900a8bbce36", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6070e39cd0af6ac4a88004c8b1b6a900a8bbce36", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6070e39cd0af6ac4a88004c8b1b6a900a8bbce36"}], "stats": {"total": 34, "additions": 33, "deletions": 1}, "files": [{"sha": "35f267db58850d4445203248b399b169a46d6baa", "filename": "gcc/fortran/simplify.c", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f600f271b10d0214b111f2aa52a3d5740477e139/gcc%2Ffortran%2Fsimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f600f271b10d0214b111f2aa52a3d5740477e139/gcc%2Ffortran%2Fsimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fsimplify.c?ref=f600f271b10d0214b111f2aa52a3d5740477e139", "patch": "@@ -4168,7 +4168,17 @@ simplify_bound_dim (gfc_expr *array, gfc_expr *kind, int d, int upper,\n     {\n       if (upper)\n \t{\n-\t  if (!gfc_ref_dimen_size (&ref->u.ar, d - 1, &result->value.integer, NULL))\n+\t  int d2 = 0, cnt = 0;\n+\t  for (int idx = 0; idx < ref->u.ar.dimen; ++idx)\n+\t    {\n+\t      if (ref->u.ar.dimen_type[idx] == DIMEN_ELEMENT)\n+\t\td2++;\n+\t      else if (cnt < d - 1)\n+\t\tcnt++;\n+\t      else\n+\t\tbreak;\n+\t    }\n+\t  if (!gfc_ref_dimen_size (&ref->u.ar, d2 + d - 1, &result->value.integer, NULL))\n \t    goto returnNull;\n \t}\n       else"}, {"sha": "7c588b026e145acc1180cf3e7a6679585d47adeb", "filename": "gcc/testsuite/gfortran.dg/ubound_1.f90", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f600f271b10d0214b111f2aa52a3d5740477e139/gcc%2Ftestsuite%2Fgfortran.dg%2Fubound_1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f600f271b10d0214b111f2aa52a3d5740477e139/gcc%2Ftestsuite%2Fgfortran.dg%2Fubound_1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fubound_1.f90?ref=f600f271b10d0214b111f2aa52a3d5740477e139", "patch": "@@ -0,0 +1,22 @@\n+! { dg-do run }\n+!\n+! PR fortran/99027\n+!\n+  program test\n+    integer, dimension (1:3,1:6) :: array\n+    integer, dimension (2:5,3:7,4:9,-4:2) :: array2\n+\n+    if (any ([4] /= ubound (array (1, 1:4)))) stop 1\n+    if (4 /= ubound (array (1, 1:4), dim=1)) stop 2\n+\n+    if (any (ubound (array2 (3,3,4,:))        /= [4+1+2])) stop 3\n+    if (     ubound (array2 (3,3,4,:), dim=1) /=  4+1+2 ) stop 4\n+\n+    if (any (ubound (array2 (3,:,4,:))        /= [7-3+1, 4+1+2])) stop 5\n+    if (     ubound (array2 (3,:,4,:), dim=1) /=  7-3+1       ) stop 6\n+    if (     ubound (array2 (3,:,4,:), dim=2) /=         4+1+2) stop 7\n+    if (any (ubound (array2 (3,:,4:4,:))        /= [7-3+1, 1, 4+1+2])) stop 8\n+    if (     ubound (array2 (3,:,4:4,:), dim=1) /=  7-3+1          ) stop 9\n+    if (     ubound (array2 (3,:,4:4,:), dim=2) /=         1       ) stop 10\n+    if (     ubound (array2 (3,:,4:4,:), dim=3) /=            4+1+2) stop 11\n+  end program test"}]}