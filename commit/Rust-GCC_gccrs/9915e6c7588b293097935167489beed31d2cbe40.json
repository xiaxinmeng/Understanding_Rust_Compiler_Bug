{"sha": "9915e6c7588b293097935167489beed31d2cbe40", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTkxNWU2Yzc1ODhiMjkzMDk3OTM1MTY3NDg5YmVlZDMxZDJjYmU0MA==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2007-04-06T09:25:51Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2007-04-06T09:25:51Z"}, "message": "2007-04-06  Ed Schonberg  <schonberg@adacore.com>\n\n\t* sem_ch10.adb (Install_Limited_Context_Clauses.\n\tExpand_Limited_With_Clause): Use a new copy of selector name in the\n\tcall to Make_With_Clause. This fixes the tree structure for ASIS\n\tpurposes. Nothing is changed in the compiler behaviour.\n\t(Process_Body_Clauses): Handle properly use clauses whose prefix is\n\ta package renaming.\n\t(Install_Limited_With_Clauses): Do not install non-limited view when it\n\tis still incomplete.\n\nFrom-SVN: r123592", "tree": {"sha": "0be756307718f8011bc07e0166daf2fd1b07eec5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0be756307718f8011bc07e0166daf2fd1b07eec5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9915e6c7588b293097935167489beed31d2cbe40", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9915e6c7588b293097935167489beed31d2cbe40", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9915e6c7588b293097935167489beed31d2cbe40", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9915e6c7588b293097935167489beed31d2cbe40/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "53ff7b048c6b847fd359e4283e42b2ff1c6ef0fd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/53ff7b048c6b847fd359e4283e42b2ff1c6ef0fd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/53ff7b048c6b847fd359e4283e42b2ff1c6ef0fd"}], "stats": {"total": 68, "additions": 50, "deletions": 18}, "files": [{"sha": "b34a5324aaff27f10d55467a02acac49075ba4c3", "filename": "gcc/ada/sem_ch10.adb", "status": "modified", "additions": 50, "deletions": 18, "changes": 68, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9915e6c7588b293097935167489beed31d2cbe40/gcc%2Fada%2Fsem_ch10.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9915e6c7588b293097935167489beed31d2cbe40/gcc%2Fada%2Fsem_ch10.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch10.adb?ref=9915e6c7588b293097935167489beed31d2cbe40", "patch": "@@ -305,6 +305,28 @@ package body Sem_Ch10 is\n             Subt_Mark : Node_Id;\n             Use_Item  : Node_Id;\n \n+            function Same_Unit (N : Node_Id; P : Entity_Id) return Boolean;\n+            --  In an expanded name in a use clause, if the prefix is a\n+            --  renamed package, the entity is set to the original package\n+            --  as a result, when checking whether the package appears in a\n+            --  previous with_clause, the renaming has to be taken into\n+            --  account, to prevent spurious or incorrect warnings. The\n+            --  common case is the use of Text_IO.\n+\n+            ---------------\n+            -- Same_Unit --\n+            ---------------\n+\n+            function Same_Unit (N : Node_Id; P : Entity_Id) return Boolean is\n+            begin\n+               return Entity (N) = P\n+                 or else\n+                   (Present (Renamed_Object (P))\n+                     and then Entity (N) = Renamed_Object (P));\n+            end Same_Unit;\n+\n+         --  Start of processing for Process_Body_Clauses\n+\n          begin\n             Used := False;\n             Used_Type_Or_Elab := False;\n@@ -338,7 +360,7 @@ package body Sem_Ch10 is\n \n                            UE := Use_Item;\n                            while Nkind (UE) = N_Expanded_Name loop\n-                              if Entity (Prefix (UE)) = Nam_Ent then\n+                              if Same_Unit (Prefix (UE), Nam_Ent) then\n                                  Used := True;\n                                  exit;\n                               end if;\n@@ -360,7 +382,7 @@ package body Sem_Ch10 is\n                   while Present (Subt_Mark)\n                     and then not Used_Type_Or_Elab\n                   loop\n-                     if Entity (Prefix (Subt_Mark)) = Nam_Ent then\n+                     if Same_Unit (Prefix (Subt_Mark), Nam_Ent) then\n                         Used_Type_Or_Elab := True;\n                      end if;\n \n@@ -3652,7 +3674,7 @@ package body Sem_Ch10 is\n               Make_With_Clause (Loc,\n                 Name => Make_Selected_Component (Loc,\n                   Prefix        => New_Copy_Tree (Prefix (Nam)),\n-                  Selector_Name => Selector_Name (Nam)));\n+                  Selector_Name => New_Copy (Selector_Name (Nam))));\n             Set_Parent (Withn, Parent (N));\n          end if;\n \n@@ -3767,21 +3789,31 @@ package body Sem_Ch10 is\n                   Def_Id := Defining_Identifier (Decl);\n                   Non_Lim_View := Non_Limited_View (Def_Id);\n \n-                  --  Convert an incomplete subtype declaration into a\n-                  --  corresponding non-limited view subtype declaration.\n-\n-                  Set_Subtype_Indication (Decl,\n-                    New_Reference_To (Non_Lim_View, Sloc (Def_Id)));\n-                  Set_Etype (Def_Id, Non_Lim_View);\n-                  Set_Ekind (Def_Id, Subtype_Kind (Ekind (Non_Lim_View)));\n-                  Set_Analyzed (Decl, False);\n-\n-                  --  Reanalyze the declaration, suppressing the call to\n-                  --  Enter_Name to avoid duplicate names.\n-\n-                  Analyze_Subtype_Declaration\n-                   (N    => Decl,\n-                    Skip => True);\n+                  if not Is_Incomplete_Type (Non_Lim_View) then\n+\n+                     --  Convert an incomplete subtype declaration into a\n+                     --  corresponding non-limited view subtype declaration.\n+                     --  This is usually the case when analyzing a body that\n+                     --  has regular with-clauses, when the spec has limited\n+                     --  ones.\n+                     --  if the non-limited view is still incomplete, it is\n+                     --  the dummy entry already created, and the declaration\n+                     --  cannot be reanalyzed. This is the case when installing\n+                     --  a parent unit that has limited with-clauses.\n+\n+                     Set_Subtype_Indication (Decl,\n+                       New_Reference_To (Non_Lim_View, Sloc (Def_Id)));\n+                     Set_Etype (Def_Id, Non_Lim_View);\n+                     Set_Ekind (Def_Id, Subtype_Kind (Ekind (Non_Lim_View)));\n+                     Set_Analyzed (Decl, False);\n+\n+                     --  Reanalyze the declaration, suppressing the call to\n+                     --  Enter_Name to avoid duplicate names.\n+\n+                     Analyze_Subtype_Declaration\n+                      (N    => Decl,\n+                       Skip => True);\n+                  end if;\n                end if;\n \n                Next (Decl);"}]}