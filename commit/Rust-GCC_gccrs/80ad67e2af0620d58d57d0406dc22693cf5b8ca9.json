{"sha": "80ad67e2af0620d58d57d0406dc22693cf5b8ca9", "node_id": "C_kwDOANBUbNoAKDgwYWQ2N2UyYWYwNjIwZDU4ZDU3ZDA0MDZkYzIyNjkzY2Y1YjhjYTk", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-01-06T08:29:34Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-01-06T08:29:34Z"}, "message": "ifcvt: Check for asm goto at the end of then_bb/else_bb in ifcvt [PR103908]\n\nOn the following testcase, RTL ifcvt sees then_bb\n(note 7 6 8 3 [bb 3] NOTE_INSN_BASIC_BLOCK)\n(insn 8 7 9 3 (set (mem/c:SI (symbol_ref:DI (\"b\") [flags 0x2]  <var_decl 0x7fdccf5b0cf0 b>) [1 b+0 S4 A32])\n        (const_int 1 [0x1])) \"pr103908.c\":6:7 81 {*movsi_internal}\n     (nil))\n(jump_insn 9 8 13 3 (parallel [\n            (asm_operands/v (\"# insn 1\") (\"\") 0 []\n                 []\n                 [\n                    (label_ref:DI 21)\n                ] pr103908.c:7)\n            (clobber (reg:CC 17 flags))\n        ]) \"pr103908.c\":7:5 -1\n     (expr_list:REG_UNUSED (reg:CC 17 flags)\n        (nil))\n -> 21)\nand similarly else_bb (just with a different asm_operands template).\nIt checks that those basic blocks have a single successor and\nuses last_active_insn which intentionally skips over JUMP_INSNs, sees\nboth basic blocks contain the same set and merges them (or if the\nsets are different, attempts some other noce optimization).\nBut we can't assume that the jump, even when it has only a single successor,\nhas no side-effects.\n\nThe following patch fixes it by punting if test_bb ends with a JUMP_INSN\nthat isn't onlyjump_p.\n\n2022-01-06  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR rtl-optimization/103908\n\t* ifcvt.c (bb_valid_for_noce_process_p): Punt on bbs ending with\n\tasm goto.\n\n\t* gcc.target/i386/pr103908.c: New test.", "tree": {"sha": "94bf1238eefebddbf7463608ac34c687b92e66f0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/94bf1238eefebddbf7463608ac34c687b92e66f0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/80ad67e2af0620d58d57d0406dc22693cf5b8ca9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/80ad67e2af0620d58d57d0406dc22693cf5b8ca9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/80ad67e2af0620d58d57d0406dc22693cf5b8ca9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/80ad67e2af0620d58d57d0406dc22693cf5b8ca9/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1935db296892bbd9fc597889237528bd7e080ab1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1935db296892bbd9fc597889237528bd7e080ab1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1935db296892bbd9fc597889237528bd7e080ab1"}], "stats": {"total": 30, "additions": 30, "deletions": 0}, "files": [{"sha": "9a3e4539fb734a00b22c030070f5b3a710c08550", "filename": "gcc/ifcvt.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80ad67e2af0620d58d57d0406dc22693cf5b8ca9/gcc%2Fifcvt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80ad67e2af0620d58d57d0406dc22693cf5b8ca9/gcc%2Fifcvt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fifcvt.c?ref=80ad67e2af0620d58d57d0406dc22693cf5b8ca9", "patch": "@@ -3064,6 +3064,12 @@ bb_valid_for_noce_process_p (basic_block test_bb, rtx cond,\n \n   if (!insn_valid_noce_process_p (last_insn, cc))\n     return false;\n+\n+  /* Punt on blocks ending with asm goto or jumps with other side-effects,\n+     last_active_insn ignores JUMP_INSNs.  */\n+  if (JUMP_P (BB_END (test_bb)) && !onlyjump_p (BB_END (test_bb)))\n+    return false;\n+\n   last_set = single_set (last_insn);\n \n   rtx x = SET_DEST (last_set);"}, {"sha": "7c57e1ddf6af79602bf136058644046fc8db1e9c", "filename": "gcc/testsuite/gcc.target/i386/pr103908.c", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/80ad67e2af0620d58d57d0406dc22693cf5b8ca9/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr103908.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/80ad67e2af0620d58d57d0406dc22693cf5b8ca9/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr103908.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr103908.c?ref=80ad67e2af0620d58d57d0406dc22693cf5b8ca9", "patch": "@@ -0,0 +1,24 @@\n+/* PR rtl-optimization/103908 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O1 -fdisable-tree-cselim -fno-tree-sink\" } */\n+/* { dg-final { scan-assembler \"# insn 1\" } } */\n+/* { dg-final { scan-assembler \"# insn 2\" } } */\n+\n+int a, b;\n+\n+void\n+foo (void)\n+{\n+  if (a)\n+    {\n+      b = 1;\n+      asm goto (\"# insn 1\" : : : : lab1);\n+    lab1:;\n+    }\n+  else\n+    {\n+      b = 1;\n+      asm goto (\"# insn 2\" : : : : lab2);\n+    lab2:;\n+    }\n+}"}]}