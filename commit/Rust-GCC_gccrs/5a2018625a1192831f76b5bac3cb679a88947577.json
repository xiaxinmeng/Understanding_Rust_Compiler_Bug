{"sha": "5a2018625a1192831f76b5bac3cb679a88947577", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWEyMDE4NjI1YTExOTI4MzFmNzZiNWJhYzNjYjY3OWE4ODk0NzU3Nw==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2017-10-17T15:52:21Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2017-10-17T15:52:21Z"}, "message": "[C++ PATCH 82560] missing dtor call\n\nhttps://gcc.gnu.org/ml/gcc-patches/2017-10/msg01068.html\n\tPR c++/82560\n\t* call.c (build_over_call): Don't pass tf_no_cleanup to nested\n\tcalls.\n\n\tPR c++/82560\n\t* g++.dg/cpp0x/pr82560.C: New.\n\nFrom-SVN: r253820", "tree": {"sha": "c6e2dd122287481cd4564e2e3db336f69861441d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c6e2dd122287481cd4564e2e3db336f69861441d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5a2018625a1192831f76b5bac3cb679a88947577", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a2018625a1192831f76b5bac3cb679a88947577", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5a2018625a1192831f76b5bac3cb679a88947577", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a2018625a1192831f76b5bac3cb679a88947577/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "816c4ba228ea728c3e07161528b8781d61e9af7f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/816c4ba228ea728c3e07161528b8781d61e9af7f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/816c4ba228ea728c3e07161528b8781d61e9af7f"}], "stats": {"total": 46, "additions": 42, "deletions": 4}, "files": [{"sha": "daf302fc34963ecd7727b43f27fd8ebbdf4e74ea", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=5a2018625a1192831f76b5bac3cb679a88947577", "patch": "@@ -1,5 +1,9 @@\n 2017-10-17  Nathan Sidwell  <nathan@acm.org>\n \n+\tPR c++/82560\n+\t* call.c (build_over_call): Don't pass tf_no_cleanup to nested\n+\tcalls.\n+\n \tPR middle-end/82546\n \t* cp-objcp-common.c (cp_tree_size): Reformat.  Adjust returns size\n \tof TYPE nodes."}, {"sha": "8f33ab51690927ba79450049e05ebf853462ed8a", "filename": "gcc/cp/call.c", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Fcp%2Fcall.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Fcp%2Fcall.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcall.c?ref=5a2018625a1192831f76b5bac3cb679a88947577", "patch": "@@ -7717,8 +7717,11 @@ build_over_call (struct z_candidate *cand, int flags, tsubst_flags_t complain)\n     }\n \n   /* N3276 magic doesn't apply to nested calls.  */\n-  int decltype_flag = (complain & tf_decltype);\n+  tsubst_flags_t decltype_flag = (complain & tf_decltype);\n   complain &= ~tf_decltype;\n+  /* No-Cleanup doesn't apply to nested calls either.  */\n+  tsubst_flags_t no_cleanup_complain = complain;\n+  complain &= ~tf_no_cleanup;\n \n   /* Find maximum size of vector to hold converted arguments.  */\n   parmlen = list_length (parm);\n@@ -7916,7 +7919,7 @@ build_over_call (struct z_candidate *cand, int flags, tsubst_flags_t complain)\n       if (flags & LOOKUP_NO_CONVERSION)\n \tconv->user_conv_p = true;\n \n-      tsubst_flags_t arg_complain = complain & (~tf_no_cleanup);\n+      tsubst_flags_t arg_complain = complain;\n       if (!conversion_warning)\n \targ_complain &= ~tf_warning;\n \n@@ -8164,7 +8167,8 @@ build_over_call (struct z_candidate *cand, int flags, tsubst_flags_t complain)\n       else if (default_ctor_p (fn))\n \t{\n \t  if (is_dummy_object (argarray[0]))\n-\t    return force_target_expr (DECL_CONTEXT (fn), void_node, complain);\n+\t    return force_target_expr (DECL_CONTEXT (fn), void_node,\n+\t\t\t\t      no_cleanup_complain);\n \t  else\n \t    return cp_build_indirect_ref (argarray[0], RO_NULL, complain);\n \t}\n@@ -9062,7 +9066,6 @@ build_new_method_call_1 (tree instance, tree fns, vec<tree, va_gc> **args,\n      static member function.  */\n   instance = mark_type_use (instance);\n \n-\n   /* Figure out whether to skip the first argument for the error\n      message we will display to users if an error occurs.  We don't\n      want to display any compiler-generated arguments.  The \"this\""}, {"sha": "f344a46479cebea35a78ba6a77cfb669158f7077", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=5a2018625a1192831f76b5bac3cb679a88947577", "patch": "@@ -1,5 +1,8 @@\n 2017-10-17  Nathan Sidwell  <nathan@acm.org>\n \n+\tPR c++/82560\n+\t* g++.dg/cpp0x/pr82560.C: New.\n+\n \tPR middle-end/82577\n \t* g++.dg/opt/pr82577.C: New.\n "}, {"sha": "3408bae518e5660cee7808b36993e27b82c99645", "filename": "gcc/testsuite/g++.dg/cpp0x/pr82560.C", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fpr82560.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a2018625a1192831f76b5bac3cb679a88947577/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fpr82560.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fpr82560.C?ref=5a2018625a1192831f76b5bac3cb679a88947577", "patch": "@@ -0,0 +1,28 @@\n+// { dg-do run { target c++11 } }\n+// PR82560, failed to destruct default arg inside new\n+\n+static int liveness = 0;\n+\n+struct Foo {\n+\n+  Foo (int) {\n+    liveness++;\n+  }\n+\n+  ~Foo() {\n+    liveness--;\n+  }\n+\n+};\n+\n+struct Bar {\n+  Bar (Foo = 0) { }\n+  ~Bar() { }\n+};\n+\n+int main()\n+{\n+  delete new Bar();\n+\n+  return liveness != 0;;\n+}"}]}