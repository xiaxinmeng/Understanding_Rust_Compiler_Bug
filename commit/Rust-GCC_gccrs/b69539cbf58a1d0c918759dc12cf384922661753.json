{"sha": "b69539cbf58a1d0c918759dc12cf384922661753", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjY5NTM5Y2JmNThhMWQwYzkxODc1OWRjMTJjZjM4NDkyMjY2MTc1Mw==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2016-02-12T11:57:54Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2016-02-12T11:57:54Z"}, "message": "re PR ipa/68672 (g++.dg/torture/pr68470.C: ICE: cannot update SSA form: statement uses released SSA name)\n\n\tPR ipa/68672\n\t* ipa-split.c (split_function): Don't compute/use main_part_return_p.\n\tCompute retval and retbnd early in all cases if split_part_return_p\n\tand return_bb is not EXIT.  Remove all clobber stmts and reset\n\tall debug stmts that refer to SSA_NAMEs defined in split part,\n\texcept if it is retval, in that case replace the old retval with the\n\tlhs of the call to the split part.\n\n\t* g++.dg/ipa/pr68672-1.C: New test.\n\t* g++.dg/ipa/pr68672-2.C: New test.\n\t* g++.dg/ipa/pr68672-3.C: New test.\n\nFrom-SVN: r233374", "tree": {"sha": "0bcf65910d9496d9b5e0acf1f0a34f108d659735", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0bcf65910d9496d9b5e0acf1f0a34f108d659735"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b69539cbf58a1d0c918759dc12cf384922661753", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b69539cbf58a1d0c918759dc12cf384922661753", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b69539cbf58a1d0c918759dc12cf384922661753", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b69539cbf58a1d0c918759dc12cf384922661753/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "4c707980691c4f1e52c41fac391d60dedd325633", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4c707980691c4f1e52c41fac391d60dedd325633", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4c707980691c4f1e52c41fac391d60dedd325633"}], "stats": {"total": 243, "additions": 216, "deletions": 27}, "files": [{"sha": "3588b15362fe21fee6c6a69912d1e1a4a0802312", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=b69539cbf58a1d0c918759dc12cf384922661753", "patch": "@@ -1,3 +1,13 @@\n+2016-02-12  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR ipa/68672\n+\t* ipa-split.c (split_function): Don't compute/use main_part_return_p.\n+\tCompute retval and retbnd early in all cases if split_part_return_p\n+\tand return_bb is not EXIT.  Remove all clobber stmts and reset\n+\tall debug stmts that refer to SSA_NAMEs defined in split part,\n+\texcept if it is retval, in that case replace the old retval with the\n+\tlhs of the call to the split part.\n+\n 2016-02-12  Kugan Vivekanandarajah  <kuganv@linaro.org>\n \n \trevert:"}, {"sha": "2528a7965022f75212dca4d3c9814313b14806c6", "filename": "gcc/ipa-split.c", "status": "modified", "additions": 68, "deletions": 27, "changes": 95, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Fipa-split.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Fipa-split.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-split.c?ref=b69539cbf58a1d0c918759dc12cf384922661753", "patch": "@@ -1244,28 +1244,13 @@ split_function (basic_block return_bb, struct split_point *split_point,\n \targs_to_pass.safe_push (arg);\n       }\n \n-  /* See if the split function or the main part will return.  */\n-  bool main_part_return_p = false;\n+  /* See if the split function will return.  */\n   bool split_part_return_p = false;\n   FOR_EACH_EDGE (e, ei, return_bb->preds)\n     {\n       if (bitmap_bit_p (split_point->split_bbs, e->src->index))\n \tsplit_part_return_p = true;\n-      else\n-\tmain_part_return_p = true;\n     }\n-  /* The main part also returns if we split on a fallthru edge\n-     and the split part returns.  */\n-  if (split_part_return_p)\n-    FOR_EACH_EDGE (e, ei, split_point->entry_bb->preds)\n-      {\n-\tif (! bitmap_bit_p (split_point->split_bbs, e->src->index)\n-\t    && single_succ_p (e->src))\n-\t  {\n-\t    main_part_return_p = true;\n-\t    break;\n-\t  }\n-      }\n \n   /* Add return block to what will become the split function.\n      We do not return; no return block is needed.  */\n@@ -1279,8 +1264,8 @@ split_function (basic_block return_bb, struct split_point *split_point,\n      FIXME: Once we are able to change return type, we should change function\n      to return void instead of just outputting function with undefined return\n      value.  For structures this affects quality of codegen.  */\n-  else if (!split_point->split_part_set_retval\n-           && (retval = find_retval (return_bb)))\n+  else if ((retval = find_retval (return_bb))\n+\t   && !split_point->split_part_set_retval)\n     {\n       bool redirected = true;\n       basic_block new_return_bb = create_basic_block (NULL, 0, return_bb);\n@@ -1308,12 +1293,10 @@ split_function (basic_block return_bb, struct split_point *split_point,\n     }\n   /* When we pass around the value, use existing return block.  */\n   else\n-    bitmap_set_bit (split_point->split_bbs, return_bb->index);\n-\n-  /* If the main part doesn't return pretend the return block wasn't\n-     found for all of the following.  */\n-  if (! main_part_return_p)\n-    return_bb = EXIT_BLOCK_PTR_FOR_FN (cfun);\n+    {\n+      bitmap_set_bit (split_point->split_bbs, return_bb->index);\n+      retbnd = find_retbnd (return_bb);\n+    }\n \n   /* If RETURN_BB has virtual operand PHIs, they must be removed and the\n      virtual operand marked for renaming as we change the CFG in a way that\n@@ -1382,6 +1365,44 @@ split_function (basic_block return_bb, struct split_point *split_point,\n       DECL_FUNCTION_CODE (node->decl) = (enum built_in_function) 0;\n     }\n \n+  /* If return_bb contains any clobbers that refer to SSA_NAMEs\n+     set in the split part, remove them.  Also reset debug stmts that\n+     refer to SSA_NAMEs set in the split part.  */\n+  if (return_bb != EXIT_BLOCK_PTR_FOR_FN (cfun))\n+    {\n+      gimple_stmt_iterator gsi = gsi_start_bb (return_bb);\n+      while (!gsi_end_p (gsi))\n+\t{\n+\t  tree op;\n+\t  ssa_op_iter iter;\n+\t  gimple *stmt = gsi_stmt (gsi);\n+\t  bool remove = false;\n+\t  if (gimple_clobber_p (stmt) || is_gimple_debug (stmt))\n+\t    FOR_EACH_SSA_TREE_OPERAND (op, stmt, iter, SSA_OP_USE)\n+\t      {\n+\t\tbasic_block bb = gimple_bb (SSA_NAME_DEF_STMT (op));\n+\t\tif (op != retval\n+\t\t    && bb\n+\t\t    && bb != return_bb\n+\t\t    && bitmap_bit_p (split_point->split_bbs, bb->index))\n+\t\t  {\n+\t\t    if (is_gimple_debug (stmt))\n+\t\t      {\n+\t\t\tgimple_debug_bind_reset_value (stmt);\n+\t\t\tupdate_stmt (stmt);\n+\t\t      }\n+\t\t    else\n+\t\t      remove = true;\n+\t\t    break;\n+\t\t  }\n+\t      }\n+\t  if (remove)\n+\t    gsi_remove (&gsi, true);\n+\t  else\n+\t    gsi_next (&gsi);\n+\t}\n+    }\n+\n   /* If the original function is instrumented then it's\n      part is also instrumented.  */\n   if (with_bounds)\n@@ -1499,9 +1520,7 @@ split_function (basic_block return_bb, struct split_point *split_point,\n          return value into and put call just before it.  */\n       if (return_bb != EXIT_BLOCK_PTR_FOR_FN (cfun))\n \t{\n-\t  real_retval = retval = find_retval (return_bb);\n-\t  retbnd = find_retbnd (return_bb);\n-\n+\t  real_retval = retval;\n \t  if (real_retval && split_point->split_part_set_retval)\n \t    {\n \t      gphi_iterator psi;\n@@ -1545,6 +1564,28 @@ split_function (basic_block return_bb, struct split_point *split_point,\n \t\t\t    break;\n \t\t\t  }\n \t\t      update_stmt (gsi_stmt (bsi));\n+\t\t      /* Also adjust clobbers and debug stmts in return_bb.  */\n+\t\t      for (bsi = gsi_start_bb (return_bb); !gsi_end_p (bsi);\n+\t\t\t   gsi_next (&bsi))\n+\t\t\t{\n+\t\t\t  gimple *stmt = gsi_stmt (bsi);\n+\t\t\t  if (gimple_clobber_p (stmt)\n+\t\t\t      || is_gimple_debug (stmt))\n+\t\t\t    {\n+\t\t\t      ssa_op_iter iter;\n+\t\t\t      use_operand_p use_p;\n+\t\t\t      bool update = false;\n+\t\t\t      FOR_EACH_SSA_USE_OPERAND (use_p, stmt, iter,\n+\t\t\t\t\t\t\tSSA_OP_USE)\n+\t\t\t\tif (USE_FROM_PTR (use_p) == real_retval)\n+\t\t\t\t  {\n+\t\t\t\t    SET_USE (use_p, retval);\n+\t\t\t\t    update = true;\n+\t\t\t\t  }\n+\t\t\t      if (update)\n+\t\t\t\tupdate_stmt (stmt);\n+\t\t\t    }\n+\t\t\t}\n \t\t    }\n \n \t\t  /* Replace retbnd with new one.  */"}, {"sha": "79f8f5a9e4f855e52875cb6550bffb96eb11ae04", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b69539cbf58a1d0c918759dc12cf384922661753", "patch": "@@ -1,3 +1,10 @@\n+2016-02-12  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR ipa/68672\n+\t* g++.dg/ipa/pr68672-1.C: New test.\n+\t* g++.dg/ipa/pr68672-2.C: New test.\n+\t* g++.dg/ipa/pr68672-3.C: New test.\n+\n 2016-02-12  Bernd Schmidt  <bschmidt@redhat.com>\n \n \tPR c/69522"}, {"sha": "fddabe17a434765729124c6682433873d8806850", "filename": "gcc/testsuite/g++.dg/ipa/pr68672-1.C", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-1.C?ref=b69539cbf58a1d0c918759dc12cf384922661753", "patch": "@@ -0,0 +1,20 @@\n+// PR ipa/68672\n+// { dg-do compile }\n+// { dg-options \"-O -finline-small-functions -fpartial-inlining --param=partial-inlining-entry-probability=100\" }\n+\n+void f2 (void *);\n+void *a;\n+struct C { virtual void m1 (); };\n+struct D { C *m2 () { if (a) __builtin_abort (); } };\n+D f1 ();\n+struct E { int e; ~E () { if (e) f2 (&e); } };\n+E *b;\n+struct I { virtual void m3 (); };\n+\n+void\n+I::m3 ()\n+{\n+  if (a)\n+    f1 ().m2 ()->m1 ();\n+  b->~E ();\n+}"}, {"sha": "f23ae80c7a2a67b528117276ac833c6e4c0f91ec", "filename": "gcc/testsuite/g++.dg/ipa/pr68672-2.C", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-2.C?ref=b69539cbf58a1d0c918759dc12cf384922661753", "patch": "@@ -0,0 +1,54 @@\n+// PR ipa/68672\n+// { dg-do compile }\n+// { dg-options \"-O3 --param=partial-inlining-entry-probability=100 -g\" }\n+\n+struct S { ~S () {} };\n+S *a;\n+int *b;\n+void bar ();\n+void baz ();\n+void fn (int *);\n+\n+static int\n+foo ()\n+{\n+  S *c = a;\n+  if (c)\n+    {\n+      bar ();\n+      if (a)\n+\t__builtin_abort ();\n+      baz ();\n+    }\n+  int p = *b;\n+  if (p)\n+    {\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+    }\n+  c->~S ();\n+  int q = 2 * p;\n+  int r = 3 * q;\n+  S *d = c;\n+  return p;\n+}\n+\n+void\n+use1 ()\n+{\n+  foo ();\n+}\n+\n+void\n+use2 ()\n+{\n+  foo ();\n+}\n+\n+void\n+use3 ()\n+{\n+  foo ();\n+}"}, {"sha": "971ddf6c6b75d5ad191b293857bf8e498602be2d", "filename": "gcc/testsuite/g++.dg/ipa/pr68672-3.C", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-3.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b69539cbf58a1d0c918759dc12cf384922661753/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-3.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fpr68672-3.C?ref=b69539cbf58a1d0c918759dc12cf384922661753", "patch": "@@ -0,0 +1,57 @@\n+// PR ipa/68672\n+// { dg-do compile }\n+// { dg-options \"-O3 --param=partial-inlining-entry-probability=100 -g\" }\n+\n+struct S { ~S () {} };\n+S *a, *e;\n+int *b;\n+void bar ();\n+void baz ();\n+void fn (int *);\n+void fn2 (S *);\n+\n+static int\n+foo ()\n+{\n+  S *c = a;\n+  if (c)\n+    {\n+      bar ();\n+      if (a)\n+\t__builtin_abort ();\n+      baz ();\n+    }\n+  int p = *b;\n+  S *f = e;\n+  if (p)\n+    {\n+      fn2 (f);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+      fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b); fn (b);\n+    }\n+  f->~S ();\n+  int q = 2 * p;\n+  int r = 3 * q;\n+  S *d = c;\n+  return p;\n+}\n+\n+void\n+use1 ()\n+{\n+  foo ();\n+}\n+\n+void\n+use2 ()\n+{\n+  foo ();\n+}\n+\n+void\n+use3 ()\n+{\n+  foo ();\n+}"}]}