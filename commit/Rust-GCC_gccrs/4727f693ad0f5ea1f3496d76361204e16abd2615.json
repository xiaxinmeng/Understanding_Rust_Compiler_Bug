{"sha": "4727f693ad0f5ea1f3496d76361204e16abd2615", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDcyN2Y2OTNhZDBmNWVhMWYzNDk2ZDc2MzYxMjA0ZTE2YWJkMjYxNQ==", "commit": {"author": {"name": "Bob Duff", "email": "duff@adacore.com", "date": "2018-01-11T08:53:48Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-01-11T08:53:48Z"}, "message": "[Ada] Null procedures not allowed in protected definitions\n\nThe syntax rules do not allow null procedures in protected definitions. This\npatch fixes a bug that accidentally allowed them.\n\n2018-01-11  Bob Duff  <duff@adacore.com>\n\ngcc/ada/\n\n\t* par-ch9.adb (P_Protected_Operation_Declaration_Opt): Give an error if\n\ta null procedure occurs in a protected definition.\n\ngcc/testsuite/\n\n\t* gnat.dg/protected_null.adb: New testcase.\n\nFrom-SVN: r256511", "tree": {"sha": "c27152b758c5e0df86a26a394d7f3033aeccd6f7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c27152b758c5e0df86a26a394d7f3033aeccd6f7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4727f693ad0f5ea1f3496d76361204e16abd2615", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4727f693ad0f5ea1f3496d76361204e16abd2615", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4727f693ad0f5ea1f3496d76361204e16abd2615", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4727f693ad0f5ea1f3496d76361204e16abd2615/comments", "author": {"login": "bobduff", "id": 29099567, "node_id": "MDQ6VXNlcjI5MDk5NTY3", "avatar_url": "https://avatars.githubusercontent.com/u/29099567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bobduff", "html_url": "https://github.com/bobduff", "followers_url": "https://api.github.com/users/bobduff/followers", "following_url": "https://api.github.com/users/bobduff/following{/other_user}", "gists_url": "https://api.github.com/users/bobduff/gists{/gist_id}", "starred_url": "https://api.github.com/users/bobduff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bobduff/subscriptions", "organizations_url": "https://api.github.com/users/bobduff/orgs", "repos_url": "https://api.github.com/users/bobduff/repos", "events_url": "https://api.github.com/users/bobduff/events{/privacy}", "received_events_url": "https://api.github.com/users/bobduff/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1ceee6a144f29ef39744316174a69e648c6c6582", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1ceee6a144f29ef39744316174a69e648c6c6582", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1ceee6a144f29ef39744316174a69e648c6c6582"}], "stats": {"total": 112, "additions": 79, "deletions": 33}, "files": [{"sha": "eaad418a5cb968ec87ea4b69c122eb41f063363a", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=4727f693ad0f5ea1f3496d76361204e16abd2615", "patch": "@@ -1,3 +1,8 @@\n+2018-01-11  Bob Duff  <duff@adacore.com>\n+\n+\t* par-ch9.adb (P_Protected_Operation_Declaration_Opt): Give an error if\n+\ta null procedure occurs in a protected definition.\n+\n 2018-01-11  Bob Duff  <duff@adacore.com>\n \n \t* binderr.ads, namet.ads: Minor reformatting."}, {"sha": "6d4c5098ac9098515639e190f1bc28156b7eb201", "filename": "gcc/ada/par-ch9.adb", "status": "modified", "additions": 55, "deletions": 33, "changes": 88, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Fada%2Fpar-ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Fada%2Fpar-ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fpar-ch9.adb?ref=4727f693ad0f5ea1f3496d76361204e16abd2615", "patch": "@@ -782,57 +782,79 @@ package body Ch9 is\n          return Decl;\n       end P_Entry_Or_Subprogram_With_Indicator;\n \n+      Result : Node_Id := Empty;\n+\n    --  Start of processing for P_Protected_Operation_Declaration_Opt\n \n    begin\n       --  This loop runs more than once only when a junk declaration\n       --  is skipped.\n \n       loop\n-         if Token = Tok_Pragma then\n-            return P_Pragma;\n+         case Token is\n+            when Tok_Pragma =>\n+               Result := P_Pragma;\n+               exit;\n \n-         elsif Token = Tok_Not or else Token = Tok_Overriding then\n-            return P_Entry_Or_Subprogram_With_Indicator;\n+            when Tok_Not | Tok_Overriding =>\n+               Result := P_Entry_Or_Subprogram_With_Indicator;\n+               exit;\n \n-         elsif Token = Tok_Entry then\n-            return P_Entry_Declaration;\n+            when Tok_Entry =>\n+               Result := P_Entry_Declaration;\n+               exit;\n \n-         elsif Token = Tok_Function or else Token = Tok_Procedure then\n-            return P_Subprogram (Pf_Decl_Pexp);\n+            when Tok_Function | Tok_Procedure =>\n+               Result := P_Subprogram (Pf_Decl_Pexp);\n+               exit;\n \n-         elsif Token = Tok_Identifier then\n-            L := New_List;\n-            P := Token_Ptr;\n-            Skip_Declaration (L);\n+            when Tok_Identifier =>\n+               L := New_List;\n+               P := Token_Ptr;\n+               Skip_Declaration (L);\n \n-            if Nkind (First (L)) = N_Object_Declaration then\n-               Error_Msg\n-                 (\"component must be declared in private part of \" &\n-                  \"protected type\", P);\n-            else\n-               Error_Msg\n-                 (\"illegal declaration in protected definition\", P);\n-            end if;\n+               if Nkind (First (L)) = N_Object_Declaration then\n+                  Error_Msg\n+                    (\"component must be declared in private part of \" &\n+                     \"protected type\", P);\n+               else\n+                  Error_Msg\n+                    (\"illegal declaration in protected definition\", P);\n+               end if;\n+               --  Continue looping\n \n-         elsif Token in Token_Class_Declk then\n-            Error_Msg_SC (\"illegal declaration in protected definition\");\n-            Resync_Past_Semicolon;\n+            when Tok_For =>\n+               Error_Msg_SC\n+                 (\"representation clause not allowed in protected definition\");\n+               Resync_Past_Semicolon;\n+               --  Continue looping\n \n-            --  Return now to avoid cascaded messages if next declaration\n-            --  is a valid component declaration.\n+            when others =>\n+               if Token in Token_Class_Declk then\n+                  Error_Msg_SC (\"illegal declaration in protected definition\");\n+                  Resync_Past_Semicolon;\n \n-            return Error;\n+                  --  Return now to avoid cascaded messages if next declaration\n+                  --  is a valid component declaration.\n \n-         elsif Token = Tok_For then\n-            Error_Msg_SC\n-              (\"representation clause not allowed in protected definition\");\n-            Resync_Past_Semicolon;\n+                  Result := Error;\n+               end if;\n \n-         else\n-            return Empty;\n-         end if;\n+               exit;\n+         end case;\n       end loop;\n+\n+      if Nkind (Result) = N_Subprogram_Declaration\n+        and then Nkind (Specification (Result)) =\n+                 N_Procedure_Specification\n+        and then Null_Present (Specification (Result))\n+      then\n+         Error_Msg_N\n+           (\"protected operation cannot be a null procedure\",\n+            Null_Statement (Specification (Result)));\n+      end if;\n+\n+      return Result;\n    end P_Protected_Operation_Declaration_Opt;\n \n    -----------------------------------"}, {"sha": "3bbd01c745eee7d38fba1251bd1a537cae725950", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=4727f693ad0f5ea1f3496d76361204e16abd2615", "patch": "@@ -1,3 +1,7 @@\n+2018-01-11  Bob Duff  <duff@adacore.com>\n+\n+\t* gnat.dg/protected_null.adb: New testcase.\n+\n 2018-01-11  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/expr_func3.adb, gnat.dg/expr_func3.ads: New testcase."}, {"sha": "c58fa2b27f2d972eebaa2c052d07d44556555c22", "filename": "gcc/testsuite/gnat.dg/protected_null.adb", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Ftestsuite%2Fgnat.dg%2Fprotected_null.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4727f693ad0f5ea1f3496d76361204e16abd2615/gcc%2Ftestsuite%2Fgnat.dg%2Fprotected_null.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fprotected_null.adb?ref=4727f693ad0f5ea1f3496d76361204e16abd2615", "patch": "@@ -0,0 +1,15 @@\n+--  { dg-do compile }\n+\n+procedure Proc is\n+   protected Po is\n+      procedure P is null;  --  { dg-error \" protected operation cannot be a null procedure\" }\n+   end Po;\n+   protected body Po is\n+      procedure P is\n+      begin\n+         null;\n+      end P;\n+   end Po;\n+begin\n+   null;\n+end;"}]}