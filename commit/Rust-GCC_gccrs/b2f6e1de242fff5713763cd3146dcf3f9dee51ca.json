{"sha": "b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjJmNmUxZGUyNDJmZmY1NzEzNzYzY2QzMTQ2ZGNmM2Y5ZGVlNTFjYQ==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-07-25T21:19:36Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-07-28T11:13:05Z"}, "message": "d: Compile-time reflection for supported built-ins (PR101127)\n\nIn order to allow user-code to determine whether a back-end builtin is\navailable without error, LANG_HOOKS_BUILTIN_FUNCTION_EXT_SCOPE has been\ndefined to delay putting back-end builtin functions until the ISA that\ndefines them has been declared.\n\nHowever in D, there is no global namespace.  All builtins get pushed\ninto the `gcc.builtins' module, which is constructed during the semantic\nanalysis pass, which has already finished by the time target attributes\nare evaluated.  So builtins are not pushed by the new langhook because\nthey would be ultimately ignored.  Builtins exposed to D code then can\nnow only be altered by the command-line.\n\n\tPR d/101127\n\ngcc/d/ChangeLog:\n\n\t* d-builtins.cc (d_builtin_function_ext_scope): New function.\n\t* d-lang.cc (LANG_HOOKS_BUILTIN_FUNCTION_EXT_SCOPE): Define.\n\t* d-tree.h (d_builtin_function_ext_scope): Declare.\n\ngcc/testsuite/ChangeLog:\n\n\t* gdc.dg/pr101127a.d: New test.\n\t* gdc.dg/pr101127b.d: New test.", "tree": {"sha": "b5e25559184ca505e2a59645a742ae9d8185b549", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b5e25559184ca505e2a59645a742ae9d8185b549"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e2136117487fa839f7601c3e22a2856978fb9d0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3e2136117487fa839f7601c3e22a2856978fb9d0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3e2136117487fa839f7601c3e22a2856978fb9d0"}], "stats": {"total": 33, "additions": 33, "deletions": 0}, "files": [{"sha": "ff2a5776dc54d5abb3c07f25599be74231a447e4", "filename": "gcc/d/d-builtins.cc", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Fd%2Fd-builtins.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Fd%2Fd-builtins.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-builtins.cc?ref=b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "patch": "@@ -1204,5 +1204,20 @@ d_builtin_function (tree decl)\n   return decl;\n }\n \n+/* Same as d_builtin_function, but used to delay putting in back-end builtin\n+   functions until the ISA that defines the builtin has been declared.\n+   However in D, there is no global namespace.  All builtins get pushed into the\n+   `gcc.builtins' module, which is constructed during the semantic analysis\n+   pass, which has already finished by the time target attributes are evaluated.\n+   So builtins are not pushed because they would be ultimately ignored.\n+   The purpose of having this function then is to improve compile-time\n+   reflection support to allow user-code to determine whether a given back end\n+   function is enabled by the ISA.  */\n+\n+tree\n+d_builtin_function_ext_scope (tree decl)\n+{\n+  return decl;\n+}\n \n #include \"gt-d-d-builtins.h\""}, {"sha": "6ad3823d910dcece0a7883708ebbabb14c3b8745", "filename": "gcc/d/d-lang.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Fd%2Fd-lang.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Fd%2Fd-lang.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-lang.cc?ref=b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "patch": "@@ -1745,6 +1745,7 @@ d_enum_underlying_base_type (const_tree type)\n #undef LANG_HOOKS_GET_ALIAS_SET\n #undef LANG_HOOKS_TYPES_COMPATIBLE_P\n #undef LANG_HOOKS_BUILTIN_FUNCTION\n+#undef LANG_HOOKS_BUILTIN_FUNCTION_EXT_SCOPE\n #undef LANG_HOOKS_REGISTER_BUILTIN_TYPE\n #undef LANG_HOOKS_FINISH_INCOMPLETE_DECL\n #undef LANG_HOOKS_GIMPLIFY_EXPR\n@@ -1776,6 +1777,7 @@ d_enum_underlying_base_type (const_tree type)\n #define LANG_HOOKS_GET_ALIAS_SET\t    d_get_alias_set\n #define LANG_HOOKS_TYPES_COMPATIBLE_P\t    d_types_compatible_p\n #define LANG_HOOKS_BUILTIN_FUNCTION\t    d_builtin_function\n+#define LANG_HOOKS_BUILTIN_FUNCTION_EXT_SCOPE d_builtin_function_ext_scope\n #define LANG_HOOKS_REGISTER_BUILTIN_TYPE    d_register_builtin_type\n #define LANG_HOOKS_FINISH_INCOMPLETE_DECL   d_finish_incomplete_decl\n #define LANG_HOOKS_GIMPLIFY_EXPR\t    d_gimplify_expr"}, {"sha": "b03d60a5c0e14dee0314ab8cbad476ffefa98c80", "filename": "gcc/d/d-tree.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Fd%2Fd-tree.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Fd%2Fd-tree.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-tree.h?ref=b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "patch": "@@ -502,6 +502,7 @@ extern const attribute_spec d_langhook_common_attribute_table[];\n extern Type *build_frontend_type (tree);\n \n extern tree d_builtin_function (tree);\n+extern tree d_builtin_function_ext_scope (tree);\n extern void d_init_builtins (void);\n extern void d_register_builtin_type (tree, const char *);\n extern void d_build_builtins_module (Module *);"}, {"sha": "b56398e1929b8d6d3cb428bed9cbc9f8d90cd06a", "filename": "gcc/testsuite/gdc.dg/pr101127a.d", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Ftestsuite%2Fgdc.dg%2Fpr101127a.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Ftestsuite%2Fgdc.dg%2Fpr101127a.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fpr101127a.d?ref=b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "patch": "@@ -0,0 +1,8 @@\n+// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=101127\n+// { dg-do compile { target i?86*-*-* x86_64-*-* } }\n+// { dg-additional-options \"-mavx\" }\n+\n+import gcc.builtins;\n+\n+static assert(__traits(compiles, __builtin_ia32_andps256));\n+static assert(__traits(compiles, __builtin_ia32_pmulhrsw128));"}, {"sha": "b462d75c4240908e1986d827978188d18fdf8834", "filename": "gcc/testsuite/gdc.dg/pr101127b.d", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Ftestsuite%2Fgdc.dg%2Fpr101127b.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b2f6e1de242fff5713763cd3146dcf3f9dee51ca/gcc%2Ftestsuite%2Fgdc.dg%2Fpr101127b.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fpr101127b.d?ref=b2f6e1de242fff5713763cd3146dcf3f9dee51ca", "patch": "@@ -0,0 +1,7 @@\n+// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=101127\n+// { dg-do compile { target i?86*-*-* x86_64-*-* } }\n+\n+import gcc.builtins;\n+\n+static assert(!__traits(compiles, __builtin_ia32_andps256));\n+static assert(!__traits(compiles, __builtin_ia32_pmulhrsw128));"}]}