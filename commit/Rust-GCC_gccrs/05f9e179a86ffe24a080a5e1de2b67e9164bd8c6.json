{"sha": "05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDVmOWUxNzlhODZmZmUyNGEwODBhNWUxZGUyYjY3ZTkxNjRiZDhjNg==", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-05-20T08:35:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-20T08:35:16Z"}, "message": "Merge #433\n\n433: Allow unused underscore identifiers r=philberty a=CohenArthur\n\nThis fixes #361 \n\nCo-authored-by: CohenArthur <arthur.cohen@epita.fr>", "tree": {"sha": "2c2de3c22368ec2cc89165caf0c4baf5d37b22a8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2c2de3c22368ec2cc89165caf0c4baf5d37b22a8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgph9ECRBK7hj4Ov3rIwAAPnQIAJjK8l4MqIWVTpgdL9qogaCS\nn1YiOMfI23IdnWrsx0c6qnZpavgWNtyInBjCbBcSaVAjn9phE+PDfixKzG/0jkKY\nrbeYS5Uc3SFoQO/IzBkpG0g+evh5GrEC7idNN2b1wkGYanY7MdNkTX1+HIke8wTa\nRdUygU4wUHHOi/PS5Yzz8DmEX+1Z++g2rZJn4gAZwEnJgz0E9Yhik2WRmYsKnbkK\nTY0r961Lgu/5FVAguuVvsa0RA7BX9bhVC0alj70hLGGNhm4oCNEmMxnKND74OelN\n6CHs2Qm0hMzHhS/UZ4EHWy04NSlY8m0jQytnDxJvoEdiDKrHr4jH92BqE1FJ79w=\n=WEZS\n-----END PGP SIGNATURE-----\n", "payload": "tree 2c2de3c22368ec2cc89165caf0c4baf5d37b22a8\nparent 4d71539414ca4e5edb51556b136b0b5eaee9a084\nparent f33f618e35e8d321270d978cf17037cc1be98ae9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1621499716 +0000\ncommitter GitHub <noreply@github.com> 1621499716 +0000\n\nMerge #433\n\n433: Allow unused underscore identifiers r=philberty a=CohenArthur\n\nThis fixes #361 \n\nCo-authored-by: CohenArthur <arthur.cohen@epita.fr>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d71539414ca4e5edb51556b136b0b5eaee9a084", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4d71539414ca4e5edb51556b136b0b5eaee9a084", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4d71539414ca4e5edb51556b136b0b5eaee9a084"}, {"sha": "f33f618e35e8d321270d978cf17037cc1be98ae9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f33f618e35e8d321270d978cf17037cc1be98ae9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f33f618e35e8d321270d978cf17037cc1be98ae9"}], "stats": {"total": 29, "additions": 25, "deletions": 4}, "files": [{"sha": "bd711105f35938ce6a02d01ddf9affab57505bae", "filename": "gcc/rust/resolve/rust-ast-resolve-unused.h", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Frust%2Fresolve%2Frust-ast-resolve-unused.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Frust%2Fresolve%2Frust-ast-resolve-unused.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-ast-resolve-unused.h?ref=05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "patch": "@@ -30,7 +30,13 @@ class ScanUnused\n   static void ScanRib (Rib *r)\n   {\n     r->iterate_decls ([&] (NodeId decl_node_id, Location locus) -> bool {\n-      if (!r->have_references_for_node (decl_node_id))\n+      CanonicalPath ident = CanonicalPath::create_empty ();\n+\n+      bool ok = r->lookup_canonical_path (decl_node_id, &ident);\n+      rust_assert (ok);\n+\n+      if (!r->have_references_for_node (decl_node_id)\n+\t  && ident.get ().at (0) != '_')\n \t{\n \t  rust_warning_at (locus, 0, \"unused name\");\n \t}"}, {"sha": "e45847e5df43538b20b9974bb38190e04846908d", "filename": "gcc/rust/resolve/rust-name-resolver.h", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Frust%2Fresolve%2Frust-name-resolver.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Frust%2Fresolve%2Frust-name-resolver.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fresolve%2Frust-name-resolver.h?ref=05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "patch": "@@ -114,6 +114,7 @@ class Rib\n       }\n \n     mappings[path] = id;\n+    reverse_mappings.insert (std::pair<NodeId, CanonicalPath> (id, path));\n     decls_within_rib.insert (std::pair<NodeId, Location> (id, locus));\n     references[id] = {};\n   }\n@@ -128,9 +129,21 @@ class Rib\n     return true;\n   }\n \n+  bool lookup_canonical_path (const NodeId &id, CanonicalPath *ident)\n+  {\n+    auto it = reverse_mappings.find (id);\n+    if (it == reverse_mappings.end ())\n+      return false;\n+\n+    *ident = it->second;\n+    return true;\n+  }\n+\n   void clear_name (const CanonicalPath &ident, NodeId id)\n   {\n     mappings.erase (ident);\n+    reverse_mappings.erase (id);\n+\n     for (auto &it : decls_within_rib)\n       {\n \tif (it.first == id)\n@@ -194,6 +207,7 @@ class Rib\n   CrateNum crate_num;\n   NodeId node_id;\n   std::map<CanonicalPath, NodeId> mappings;\n+  std::map<NodeId, CanonicalPath> reverse_mappings;\n   std::set<std::pair<NodeId, Location> > decls_within_rib;\n   std::map<NodeId, std::set<NodeId> > references;\n };"}, {"sha": "4004cd30b7b8ea349b145b46c3c55a1ce77b15b0", "filename": "gcc/testsuite/rust.test/compile/loop5.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Floop5.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Floop5.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Floop5.rs?ref=05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "patch": "@@ -4,7 +4,6 @@ fn main() {\n \n     // first number in Fibonacci sequence over 10:\n     let _fib = loop {\n-        // { dg-bogus \"unused name\" \"#361\" { xfail *-*-* } .-1 }\n         if b > 10 {\n             break b;\n         }"}, {"sha": "0cd844592b64d01f0dda16b0f4712e1225670812", "filename": "gcc/testsuite/rust.test/compile/loop7.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Floop7.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Floop7.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Floop7.rs?ref=05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "patch": "@@ -3,7 +3,6 @@ fn main() {\n     let mut b = 1;\n \n     let _fib = loop {\n-        // { dg-bogus \"unused name\" \"#361\" { xfail *-*-* } .-1 }\n         if (a % 2 == 0) {\n             continue;\n         }"}, {"sha": "3c0b24a391339805c0e0a87de3a346c858b1c61a", "filename": "gcc/testsuite/rust.test/compile/struct_base_init_1.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fstruct_base_init_1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fstruct_base_init_1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fstruct_base_init_1.rs?ref=05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "patch": "@@ -9,5 +9,4 @@ fn foo() -> Foo {\n \n fn main() {\n     let _f = Foo { a: 10, ..foo() };\n-    // { dg-bogus \"unused name\" \"#361\" { xfail *-*-* } .-1 }\n }"}, {"sha": "2c106c55df9f7beb205730e32059277eabeab556", "filename": "gcc/testsuite/rust.test/compile/underscore_id.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Funderscore_id.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05f9e179a86ffe24a080a5e1de2b67e9164bd8c6/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Funderscore_id.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Funderscore_id.rs?ref=05f9e179a86ffe24a080a5e1de2b67e9164bd8c6", "patch": "@@ -0,0 +1,4 @@\n+fn main() {\n+    let _unused_but_fine = 12;\n+    let unused = 12; // { dg-warning \"unused name\" }\n+}"}]}