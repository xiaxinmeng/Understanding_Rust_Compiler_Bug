{"sha": "46c4be98d1e759a406069487e5dbaad0346e7e7d", "node_id": "C_kwDOANBUbNoAKDQ2YzRiZTk4ZDFlNzU5YTQwNjA2OTQ4N2U1ZGJhYWQwMzQ2ZTdlN2Q", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2023-03-16T00:07:02Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2023-03-16T11:06:11Z"}, "message": "d: Fix closure fields don't get same alignment as local variable [PR109144]\n\nLocal variables with both non-local references and explicit alignment\ndid not propagate their alignment to either the closure field or closure\nframe type, resulting in the closure being misaligned. This is now\ncorrectly set-up when building the frame type.\n\n\tPR d/109144\n\ngcc/d/ChangeLog:\n\n\t* d-codegen.cc (build_frame_type): Set frame field and type alignment.\n\ngcc/testsuite/ChangeLog:\n\n\t* gdc.dg/torture/pr109144.d: New test.", "tree": {"sha": "9e524f4c20331799b404f8c1707e5263c271aebe", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9e524f4c20331799b404f8c1707e5263c271aebe"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/46c4be98d1e759a406069487e5dbaad0346e7e7d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/46c4be98d1e759a406069487e5dbaad0346e7e7d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/46c4be98d1e759a406069487e5dbaad0346e7e7d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/46c4be98d1e759a406069487e5dbaad0346e7e7d/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "63b25b8012400bed0c35d6e39549168ae131aefc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/63b25b8012400bed0c35d6e39549168ae131aefc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/63b25b8012400bed0c35d6e39549168ae131aefc"}], "stats": {"total": 14, "additions": 14, "deletions": 0}, "files": [{"sha": "5c6c300ecec08ee1f8f89c00a4ae6f01afab459b", "filename": "gcc/d/d-codegen.cc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/46c4be98d1e759a406069487e5dbaad0346e7e7d/gcc%2Fd%2Fd-codegen.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/46c4be98d1e759a406069487e5dbaad0346e7e7d/gcc%2Fd%2Fd-codegen.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-codegen.cc?ref=46c4be98d1e759a406069487e5dbaad0346e7e7d", "patch": "@@ -2706,6 +2706,11 @@ build_frame_type (tree ffi, FuncDeclaration *fd)\n       TREE_ADDRESSABLE (field) = TREE_ADDRESSABLE (vsym);\n       DECL_NONADDRESSABLE_P (field) = !TREE_ADDRESSABLE (vsym);\n       TREE_THIS_VOLATILE (field) = TREE_THIS_VOLATILE (vsym);\n+      SET_DECL_ALIGN (field, DECL_ALIGN (vsym));\n+\n+      /* Update alignment for frame record type.  */\n+      if (TYPE_ALIGN (frame_rec_type) < DECL_ALIGN (field))\n+\tSET_TYPE_ALIGN (frame_rec_type, DECL_ALIGN (field));\n \n       if (DECL_LANG_NRVO (vsym))\n \t{"}, {"sha": "32d3af7cd45aaa17a8424fb44dc4aa8dae038455", "filename": "gcc/testsuite/gdc.dg/torture/pr109144.d", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/46c4be98d1e759a406069487e5dbaad0346e7e7d/gcc%2Ftestsuite%2Fgdc.dg%2Ftorture%2Fpr109144.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/46c4be98d1e759a406069487e5dbaad0346e7e7d/gcc%2Ftestsuite%2Fgdc.dg%2Ftorture%2Fpr109144.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Ftorture%2Fpr109144.d?ref=46c4be98d1e759a406069487e5dbaad0346e7e7d", "patch": "@@ -0,0 +1,9 @@\n+// { dg-do run }\n+// { dg-skip-if \"needs gcc/config.d\" { ! d_runtime } }\n+void main()\n+{\n+    align(128) byte var;\n+    assert((cast(size_t) &var) % 128 == 0);\n+    var = 73;\n+    assert((() => var)() == 73);\n+}"}]}