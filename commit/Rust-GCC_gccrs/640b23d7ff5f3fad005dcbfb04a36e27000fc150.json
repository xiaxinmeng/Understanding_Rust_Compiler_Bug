{"sha": "640b23d7ff5f3fad005dcbfb04a36e27000fc150", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjQwYjIzZDdmZjVmM2ZhZDAwNWRjYmZiMDRhMzZlMjcwMDBmYzE1MA==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-01-10T18:46:57Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2020-01-10T18:46:57Z"}, "message": "PR c++/93173 - incorrect tree sharing.\n\nMy patch for 93033 wasn't sufficient to handle all the possible sharing\nintroduced by split_nonconstant_init, and it occurred to me that it would\nmake sense to use the same unsharing technique as unshare_body, namely\ncopy_if_shared.\n\n\tPR c++/93033\ngcc/\n\t* gimplify.c (copy_if_shared): No longer static.\n\t* gimplify.h: Declare it.\ngcc/cp/\n\t* cp-gimplify.c (cp_gimplify_init_expr, cp_gimplify_expr): Use\n\tcopy_if_shared after cp_genericize_tree.\n\t* typeck2.c (split_nonconstant_init): Don't unshare here.\n\nFrom-SVN: r280126", "tree": {"sha": "61f43978030d8d42b472bfc871aed800deaa0e66", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/61f43978030d8d42b472bfc871aed800deaa0e66"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/640b23d7ff5f3fad005dcbfb04a36e27000fc150", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/640b23d7ff5f3fad005dcbfb04a36e27000fc150", "html_url": "https://github.com/Rust-GCC/gccrs/commit/640b23d7ff5f3fad005dcbfb04a36e27000fc150", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/640b23d7ff5f3fad005dcbfb04a36e27000fc150/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "9b0700571fe390afcca32dcb3b2122640e628c95", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9b0700571fe390afcca32dcb3b2122640e628c95", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9b0700571fe390afcca32dcb3b2122640e628c95"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "75c87718efa837bfe816f1dbc26515946a4c8d3e", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -1,3 +1,9 @@\n+2020-01-10  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/93173 - incorrect tree sharing.\n+\t* gimplify.c (copy_if_shared): No longer static.\n+\t* gimplify.h: Declare it.\n+\n 2020-01-10  Richard Sandiford  <richard.sandiford@arm.com>\n \n \t* doc/invoke.texi (-msve-vector-bits=): Document that"}, {"sha": "96bbcc9166ae9262c436f73a29661cae89859062", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -1,3 +1,11 @@\n+2020-01-10  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/93173 - incorrect tree sharing.\n+\tPR c++/93033\n+\t* cp-gimplify.c (cp_gimplify_init_expr, cp_gimplify_expr): Use\n+\tcopy_if_shared after cp_genericize_tree.\n+\t* typeck2.c (split_nonconstant_init): Don't unshare here.\n+\n 2020-01-08  Jason Merrill  <jason@redhat.com>\n \n \t* cp-gimplify.c (cp_gimplify_expr) [TARGET_EXPR]: Check"}, {"sha": "3d764bb6928968c517851ef451372aa47d60fe13", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -537,6 +537,7 @@ cp_gimplify_init_expr (tree *expr_p, gimple_seq *pre_p)\n       replace_placeholders (from, to);\n       from = split_nonconstant_init (to, from);\n       cp_genericize_tree (&from, false);\n+      copy_if_shared (&from);\n       *expr_p = from;\n       return;\n     }\n@@ -712,6 +713,7 @@ cp_gimplify_expr (tree *expr_p, gimple_seq *pre_p, gimple_seq *post_p)\n \thash_set<tree> pset;\n \tcp_walk_tree (expr_p, cp_fold_r, &pset, NULL);\n \tcp_genericize_tree (expr_p, false);\n+\tcopy_if_shared (expr_p);\n \tret = GS_OK;\n \tinput_location = loc;\n       }"}, {"sha": "f36a5649ae65b63c53be034635bdcc2fa9e535c9", "filename": "gcc/cp/typeck2.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fcp%2Ftypeck2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fcp%2Ftypeck2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck2.c?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -34,7 +34,6 @@ along with GCC; see the file COPYING3.  If not see\n #include \"intl.h\"\n #include \"gcc-rich-location.h\"\n #include \"target.h\"\n-#include \"gimplify.h\"\n \n static tree\n process_init_constructor (tree type, tree init, int nested, int flags,\n@@ -792,8 +791,7 @@ split_nonconstant_init (tree dest, tree init)\n \t}\n       else if (init)\n \t{\n-\t  tree ie = build2 (INIT_EXPR, void_type_node,\n-\t\t\t    unshare_expr (dest), init);\n+\t  tree ie = build2 (INIT_EXPR, void_type_node, dest, init);\n \t  code = add_stmt_to_compound (ie, code);\n \t}\n     }"}, {"sha": "00d264fc90f405ca17ff7888e92c89cceb69637d", "filename": "gcc/gimplify.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -937,7 +937,7 @@ copy_if_shared_r (tree *tp, int *walk_subtrees, void *data)\n /* Unshare most of the shared trees rooted at *TP.  DATA is passed to the\n    copy_if_shared_r callback unmodified.  */\n \n-static inline void\n+void\n copy_if_shared (tree *tp, void *data)\n {\n   walk_tree (tp, copy_if_shared_r, data, NULL);"}, {"sha": "9bb8c67b5930a44bc3471e05cca1fad8d579c746", "filename": "gcc/gimplify.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fgimplify.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Fgimplify.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.h?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -62,6 +62,7 @@ extern tree get_initialized_tmp_var (tree, gimple_seq *, gimple_seq * = NULL,\n extern void declare_vars (tree, gimple *, bool);\n extern void gimple_add_tmp_var (tree);\n extern void gimple_add_tmp_var_fn (struct function *, tree);\n+extern void copy_if_shared (tree *, void * = NULL);\n extern tree unshare_expr (tree);\n extern tree unshare_expr_without_location (tree);\n extern tree voidify_wrapper_expr (tree, tree);"}, {"sha": "04a8f5c21df569edc3bd34479da2a038d240815b", "filename": "gcc/testsuite/g++.dg/cpp0x/initlist-new3.C", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Finitlist-new3.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/640b23d7ff5f3fad005dcbfb04a36e27000fc150/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Finitlist-new3.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Finitlist-new3.C?ref=640b23d7ff5f3fad005dcbfb04a36e27000fc150", "patch": "@@ -0,0 +1,13 @@\n+// PR c++/93173\n+// { dg-do compile { target c++11 } }\n+\n+template<typename> struct S1 {\n+  S1(S1 &);\n+  ~S1();\n+};\n+struct S2 {\n+  S1<void> x;\n+  int y;\n+  int z;\n+};\n+void f(S1<void> x, int y, int z) { new S2{x, y, z}; }"}]}