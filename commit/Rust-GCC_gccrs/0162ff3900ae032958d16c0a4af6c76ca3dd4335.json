{"sha": "0162ff3900ae032958d16c0a4af6c76ca3dd4335", "node_id": "C_kwDOANBUbNoAKDAxNjJmZjM5MDBhZTAzMjk1OGQxNmMwYTRhZjZjNzZjYTNkZDQzMzU", "commit": {"author": {"name": "Owen Avery", "email": "powerboat9.gamer@gmail.com", "date": "2023-05-29T03:44:57Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2023-05-30T08:33:50Z"}, "message": "Fix handling of single fragments in repetitions\n\ngcc/rust/ChangeLog:\n\n\t* expand/rust-macro-substitute-ctx.cc\n\t(SubstituteCtx::check_repetition_amount):\n\tIgnore single fragments while checking repetition amount.\n\ngcc/testsuite/ChangeLog:\n\n\t* rust/compile/issue-2207.rs: New test.\n\nSigned-off-by: Owen Avery <powerboat9.gamer@gmail.com>", "tree": {"sha": "0f425776e9a63efc548ca2a2d05bf6f9771b45ab", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0f425776e9a63efc548ca2a2d05bf6f9771b45ab"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0162ff3900ae032958d16c0a4af6c76ca3dd4335", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0162ff3900ae032958d16c0a4af6c76ca3dd4335", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0162ff3900ae032958d16c0a4af6c76ca3dd4335", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0162ff3900ae032958d16c0a4af6c76ca3dd4335/comments", "author": {"login": "powerboat9", "id": 7397652, "node_id": "MDQ6VXNlcjczOTc2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/7397652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/powerboat9", "html_url": "https://github.com/powerboat9", "followers_url": "https://api.github.com/users/powerboat9/followers", "following_url": "https://api.github.com/users/powerboat9/following{/other_user}", "gists_url": "https://api.github.com/users/powerboat9/gists{/gist_id}", "starred_url": "https://api.github.com/users/powerboat9/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/powerboat9/subscriptions", "organizations_url": "https://api.github.com/users/powerboat9/orgs", "repos_url": "https://api.github.com/users/powerboat9/repos", "events_url": "https://api.github.com/users/powerboat9/events{/privacy}", "received_events_url": "https://api.github.com/users/powerboat9/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d806801404fc7628a3d022da92b73cd06197f49", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d806801404fc7628a3d022da92b73cd06197f49", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2d806801404fc7628a3d022da92b73cd06197f49"}], "stats": {"total": 48, "additions": 31, "deletions": 17}, "files": [{"sha": "85c9d7e01764df22ffeb66751f6b0a48fc6fe025", "filename": "gcc/rust/expand/rust-macro-substitute-ctx.cc", "status": "modified", "additions": 19, "deletions": 17, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0162ff3900ae032958d16c0a4af6c76ca3dd4335/gcc%2Frust%2Fexpand%2Frust-macro-substitute-ctx.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0162ff3900ae032958d16c0a4af6c76ca3dd4335/gcc%2Frust%2Fexpand%2Frust-macro-substitute-ctx.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fexpand%2Frust-macro-substitute-ctx.cc?ref=0162ff3900ae032958d16c0a4af6c76ca3dd4335", "patch": "@@ -77,31 +77,33 @@ SubstituteCtx::check_repetition_amount (size_t pattern_start,\n \n \t      auto &fragment = it->second;\n \n-\t      size_t repeat_amount = fragment.get_match_amount ();\n-\t      if (!first_fragment_found)\n+\t      if (!fragment.is_single_fragment ())\n \t\t{\n-\t\t  first_fragment_found = true;\n-\t\t  expected_repetition_amount = repeat_amount;\n-\t\t}\n-\t      else\n-\t\t{\n-\t\t  if (repeat_amount != expected_repetition_amount\n-\t\t      && !fragment.is_single_fragment ())\n+\t\t  size_t repeat_amount = fragment.get_match_amount ();\n+\t\t  if (!first_fragment_found)\n+\t\t    {\n+\t\t      first_fragment_found = true;\n+\t\t      expected_repetition_amount = repeat_amount;\n+\t\t    }\n+\t\t  else\n \t\t    {\n-\t\t      rust_error_at (\n-\t\t\tfrag_token->get_locus (),\n-\t\t\t\"different amount of matches used in merged \"\n-\t\t\t\"repetitions: expected %lu, got %lu\",\n-\t\t\t(unsigned long) expected_repetition_amount,\n-\t\t\t(unsigned long) repeat_amount);\n-\t\t      is_valid = false;\n+\t\t      if (repeat_amount != expected_repetition_amount)\n+\t\t\t{\n+\t\t\t  rust_error_at (\n+\t\t\t    frag_token->get_locus (),\n+\t\t\t    \"different amount of matches used in merged \"\n+\t\t\t    \"repetitions: expected %lu, got %lu\",\n+\t\t\t    (unsigned long) expected_repetition_amount,\n+\t\t\t    (unsigned long) repeat_amount);\n+\t\t\t  is_valid = false;\n+\t\t\t}\n \t\t    }\n \t\t}\n \t    }\n \t}\n     }\n \n-  return is_valid;\n+  return is_valid && first_fragment_found;\n }\n \n std::vector<std::unique_ptr<AST::Token>>"}, {"sha": "cdc64fac9d38cc622ff166f73936b6d673f7aee6", "filename": "gcc/testsuite/rust/compile/issue-2207.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0162ff3900ae032958d16c0a4af6c76ca3dd4335/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-2207.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0162ff3900ae032958d16c0a4af6c76ca3dd4335/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-2207.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fissue-2207.rs?ref=0162ff3900ae032958d16c0a4af6c76ca3dd4335", "patch": "@@ -0,0 +1,12 @@\n+macro_rules! finish {\n+    (+ - + * + /) => {}\n+}\n+\n+macro_rules! foo {\n+    () => { foo!(+ - * /); };\n+    ($a:tt $($b:tt)*) => { finish!($($a $b)*); }\n+}\n+\n+pub fn bar() {\n+    foo!();\n+}"}]}