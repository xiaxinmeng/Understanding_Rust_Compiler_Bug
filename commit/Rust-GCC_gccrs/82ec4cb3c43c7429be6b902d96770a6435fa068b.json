{"sha": "82ec4cb3c43c7429be6b902d96770a6435fa068b", "node_id": "C_kwDOANBUbNoAKDgyZWM0Y2IzYzQzYzc0MjliZTZiOTAyZDk2NzcwYTY0MzVmYTA2OGI", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2021-11-15T14:44:11Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2021-11-15T14:44:11Z"}, "message": "Fortran: openmp: Add support for thread_limit clause on target\n\ngcc/fortran/ChangeLog:\n\n\t* openmp.c (OMP_TARGET_CLAUSES): Add thread_limit.\n\t* trans-openmp.c (gfc_split_omp_clauses): Add thread_limit also to\n\tteams.\n\nlibgomp/ChangeLog:\n\n\t* testsuite/libgomp.fortran/thread-limit-1.f90: New test.", "tree": {"sha": "9cb809e747eb18bdd4f07def4fb5178d775fce71", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9cb809e747eb18bdd4f07def4fb5178d775fce71"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/82ec4cb3c43c7429be6b902d96770a6435fa068b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82ec4cb3c43c7429be6b902d96770a6435fa068b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/82ec4cb3c43c7429be6b902d96770a6435fa068b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82ec4cb3c43c7429be6b902d96770a6435fa068b/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2e1ac548594c5f482b6e9e9cfa25f9cc090bf84", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b2e1ac548594c5f482b6e9e9cfa25f9cc090bf84", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b2e1ac548594c5f482b6e9e9cfa25f9cc090bf84"}], "stats": {"total": 46, "additions": 45, "deletions": 1}, "files": [{"sha": "d120be814677e4d70be6828b75e39affeaf28502", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82ec4cb3c43c7429be6b902d96770a6435fa068b/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82ec4cb3c43c7429be6b902d96770a6435fa068b/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=82ec4cb3c43c7429be6b902d96770a6435fa068b", "patch": "@@ -3563,7 +3563,8 @@ gfc_match_oacc_routine (void)\n   (omp_mask (OMP_CLAUSE_DEVICE) | OMP_CLAUSE_MAP | OMP_CLAUSE_IF\t\\\n    | OMP_CLAUSE_DEPEND | OMP_CLAUSE_NOWAIT | OMP_CLAUSE_PRIVATE\t\t\\\n    | OMP_CLAUSE_FIRSTPRIVATE | OMP_CLAUSE_DEFAULTMAP\t\t\t\\\n-   | OMP_CLAUSE_IS_DEVICE_PTR | OMP_CLAUSE_IN_REDUCTION)\n+   | OMP_CLAUSE_IS_DEVICE_PTR | OMP_CLAUSE_IN_REDUCTION\t\t\t\\\n+   | OMP_CLAUSE_THREAD_LIMIT)\n #define OMP_TARGET_DATA_CLAUSES \\\n   (omp_mask (OMP_CLAUSE_DEVICE) | OMP_CLAUSE_MAP | OMP_CLAUSE_IF\t\\\n    | OMP_CLAUSE_USE_DEVICE_PTR | OMP_CLAUSE_USE_DEVICE_ADDR)"}, {"sha": "5b3c310ba5945e73ff61d1178a3bb09dd6f68dbf", "filename": "gcc/fortran/trans-openmp.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82ec4cb3c43c7429be6b902d96770a6435fa068b/gcc%2Ffortran%2Ftrans-openmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82ec4cb3c43c7429be6b902d96770a6435fa068b/gcc%2Ffortran%2Ftrans-openmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-openmp.c?ref=82ec4cb3c43c7429be6b902d96770a6435fa068b", "patch": "@@ -5870,6 +5870,8 @@ gfc_split_omp_clauses (gfc_code *code,\n \t    = code->ext.omp_clauses->lists[OMP_LIST_IS_DEVICE_PTR];\n \t  clausesa[GFC_OMP_SPLIT_TARGET].device\n \t    = code->ext.omp_clauses->device;\n+\t  clausesa[GFC_OMP_SPLIT_TARGET].thread_limit\n+\t    = code->ext.omp_clauses->thread_limit;\n \t  for (int i = 0; i < OMP_DEFAULTMAP_CAT_NUM; i++)\n \t    clausesa[GFC_OMP_SPLIT_TARGET].defaultmap[i]\n \t      = code->ext.omp_clauses->defaultmap[i];"}, {"sha": "bca69fbb466bd652096cfafba5af347875a96d76", "filename": "libgomp/testsuite/libgomp.fortran/thread-limit-1.f90", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82ec4cb3c43c7429be6b902d96770a6435fa068b/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fthread-limit-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82ec4cb3c43c7429be6b902d96770a6435fa068b/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fthread-limit-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fthread-limit-1.f90?ref=82ec4cb3c43c7429be6b902d96770a6435fa068b", "patch": "@@ -0,0 +1,41 @@\n+! { dg-additional-options \"-fdump-tree-original\" }\n+\n+! { dg-final { scan-tree-dump-times \"#pragma omp teams thread_limit\\\\(9\\\\)\" 1 \"original\" } }\n+! { dg-final { scan-tree-dump-times \"#pragma omp target thread_limit\\\\(9\\\\)\" 1 \"original\" } }\n+\n+! { dg-final { scan-tree-dump-times \"#pragma omp target nowait thread_limit\\\\(4\\\\)\" 1 \"original\" } }\n+! { dg-final { scan-tree-dump-times \"#pragma omp parallel num_threads\\\\(1\\\\)\" 1 \"original\" } }\n+\n+! { dg-final { scan-tree-dump-times \"#pragma omp target thread_limit\\\\(6\\\\)\" 1 \"original\" } }\n+\n+\n+module m\n+  use omp_lib\n+  implicit none\n+contains\n+\n+subroutine uncalled()\n+    !$omp target teams thread_limit (9)\n+    !$omp end target teams\n+end\n+\n+subroutine foo ()\n+  block\n+    !$omp target parallel nowait thread_limit (4) num_threads (1)\n+    if (omp_get_thread_limit () > 4) &\n+      stop 1\n+    !$omp end target parallel\n+  end block\n+  !$omp taskwait\n+end\n+end module\n+\n+program main\n+  use m\n+  implicit none\n+  !$omp target thread_limit (6)\n+    if (omp_get_thread_limit () > 6) &\n+      stop 2\n+  !$omp end target\n+  call foo ()\n+end"}]}