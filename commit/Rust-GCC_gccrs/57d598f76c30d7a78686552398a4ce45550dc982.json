{"sha": "57d598f76c30d7a78686552398a4ce45550dc982", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTdkNTk4Zjc2YzMwZDdhNzg2ODY1NTIzOThhNGNlNDU1NTBkYzk4Mg==", "commit": {"author": {"name": "Sebastian Pop", "email": "sebastian.pop@amd.com", "date": "2011-03-12T22:05:38Z"}, "committer": {"name": "Sebastian Pop", "email": "spop@gcc.gnu.org", "date": "2011-03-12T22:05:38Z"}, "message": "Fix PR47127: call cloog_state_malloc and cloog_state_free only once.\n\n2011-03-12  Sebastian Pop  <sebastian.pop@amd.com>\n\n\tPR tree-optimization/47127\n\t* graphite-clast-to-gimple.c (build_cloog_prog): Removed state\n\tparameter.\n\t(set_cloog_options): Same.\n\t(scop_to_clast): Same.\n\t(print_clast_stmt): Do not call cloog_state_malloc and\n\tcloog_state_free.\n\t(print_generated_program): Same.\n\t(gloog): Same.\n\t* graphite-clast-to-gimple.h (cloog_state): Declared.\n\t(scop_to_clast): Adjust declaration.\n\t* graphite.c (cloog_state): Defined here.\n\t(graphite_initialize): Call cloog_state_malloc.\n\t(graphite_finalize): Call cloog_state_free.\n\nFrom-SVN: r170907", "tree": {"sha": "7668cf622bac8898324ae5e873bfafe28e1a1293", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7668cf622bac8898324ae5e873bfafe28e1a1293"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/57d598f76c30d7a78686552398a4ce45550dc982", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/57d598f76c30d7a78686552398a4ce45550dc982", "html_url": "https://github.com/Rust-GCC/gccrs/commit/57d598f76c30d7a78686552398a4ce45550dc982", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/57d598f76c30d7a78686552398a4ce45550dc982/comments", "author": null, "committer": {"login": "sebpop", "id": 568397, "node_id": "MDQ6VXNlcjU2ODM5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/568397?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sebpop", "html_url": "https://github.com/sebpop", "followers_url": "https://api.github.com/users/sebpop/followers", "following_url": "https://api.github.com/users/sebpop/following{/other_user}", "gists_url": "https://api.github.com/users/sebpop/gists{/gist_id}", "starred_url": "https://api.github.com/users/sebpop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sebpop/subscriptions", "organizations_url": "https://api.github.com/users/sebpop/orgs", "repos_url": "https://api.github.com/users/sebpop/repos", "events_url": "https://api.github.com/users/sebpop/events{/privacy}", "received_events_url": "https://api.github.com/users/sebpop/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2e49964fd8691ca13e33df656da7fc4b27c1a77b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e49964fd8691ca13e33df656da7fc4b27c1a77b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2e49964fd8691ca13e33df656da7fc4b27c1a77b"}], "stats": {"total": 65, "additions": 41, "deletions": 24}, "files": [{"sha": "0cc0f8a2ebd3f9ebc19d9cea8b270d93c523e5e4", "filename": "gcc/ChangeLog", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=57d598f76c30d7a78686552398a4ce45550dc982", "patch": "@@ -1,3 +1,20 @@\n+2011-03-12  Sebastian Pop  <sebastian.pop@amd.com>\n+\n+\tPR tree-optimization/47127\n+\t* graphite-clast-to-gimple.c (build_cloog_prog): Removed state\n+\tparameter.\n+\t(set_cloog_options): Same.\n+\t(scop_to_clast): Same.\n+\t(print_clast_stmt): Do not call cloog_state_malloc and\n+\tcloog_state_free.\n+\t(print_generated_program): Same.\n+\t(gloog): Same.\n+\t* graphite-clast-to-gimple.h (cloog_state): Declared.\n+\t(scop_to_clast): Adjust declaration.\n+\t* graphite.c (cloog_state): Defined here.\n+\t(graphite_initialize): Call cloog_state_malloc.\n+\t(graphite_finalize): Call cloog_state_free.\n+\n 2011-03-11  Jason Merrill  <jason@redhat.com>\n \n \t* attribs.c (lookup_attribute_spec): Take const_tree."}, {"sha": "41356dc814ae829ea62f738700beaa5ae72bb0d5", "filename": "gcc/graphite-clast-to-gimple.c", "status": "modified", "additions": 15, "deletions": 22, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2Fgraphite-clast-to-gimple.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2Fgraphite-clast-to-gimple.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgraphite-clast-to-gimple.c?ref=57d598f76c30d7a78686552398a4ce45550dc982", "patch": "@@ -1236,7 +1236,7 @@ init_cloog_input_file (int scop_number)\n \n static void\n build_cloog_prog (scop_p scop, CloogProgram *prog,\n-                  CloogOptions *options, CloogState *state ATTRIBUTE_UNUSED)\n+                  CloogOptions *options)\n {\n   int i;\n   int max_nb_loops = scop_max_loop_depth (scop);\n@@ -1249,7 +1249,7 @@ build_cloog_prog (scop_p scop, CloogProgram *prog,\n \n   cloog_program_set_context\n     (prog, new_Cloog_Domain_from_ppl_Pointset_Powerset (SCOP_CONTEXT (scop),\n-      scop_nb_params (scop), state));\n+      scop_nb_params (scop), cloog_state));\n   nbs = unify_scattering_dimensions (scop);\n   scaldims = (int *) xmalloc (nbs * (sizeof (int)));\n   cloog_program_set_nb_scattdims (prog, nbs);\n@@ -1267,16 +1267,16 @@ build_cloog_prog (scop_p scop, CloogProgram *prog,\n \tcontinue;\n \n       /* Build the new statement and its block.  */\n-      stmt = cloog_statement_alloc (state, pbb_index (pbb));\n+      stmt = cloog_statement_alloc (cloog_state, pbb_index (pbb));\n       dom = new_Cloog_Domain_from_ppl_Pointset_Powerset (PBB_DOMAIN (pbb),\n                                                          scop_nb_params (scop),\n-                                                         state);\n+                                                         cloog_state);\n       block = cloog_block_alloc (stmt, 0, NULL, pbb_dim_iter_domain (pbb));\n       cloog_statement_set_usr (stmt, pbb);\n \n       /* Build loop list.  */\n       {\n-        CloogLoop *new_loop_list = cloog_loop_malloc (state);\n+        CloogLoop *new_loop_list = cloog_loop_malloc (cloog_state);\n         cloog_loop_set_next (new_loop_list, loop_list);\n         cloog_loop_set_domain (new_loop_list, dom);\n         cloog_loop_set_block (new_loop_list, block);\n@@ -1303,7 +1303,7 @@ build_cloog_prog (scop_p scop, CloogProgram *prog,\n \tscat = PBB_TRANSFORMED_SCATTERING (pbb);\n         dom = new_Cloog_Scattering_from_ppl_Polyhedron\n           (scat, scop_nb_params (scop), pbb_nb_scattering_transform (pbb),\n-           state);\n+           cloog_state);\n \n         cloog_set_next_scattering (new_scattering, scattering);\n         cloog_set_scattering (new_scattering, dom);\n@@ -1360,9 +1360,9 @@ build_cloog_prog (scop_p scop, CloogProgram *prog,\n /* Return the options that will be used in GLOOG.  */\n \n static CloogOptions *\n-set_cloog_options (CloogState *state ATTRIBUTE_UNUSED)\n+set_cloog_options (void)\n {\n-  CloogOptions *options = cloog_options_malloc (state);\n+  CloogOptions *options = cloog_options_malloc (cloog_state);\n \n   /* Change cloog output language to C.  If we do use FORTRAN instead, cloog\n      will stop e.g. with \"ERROR: unbounded loops not allowed in FORTRAN.\", if\n@@ -1411,12 +1411,10 @@ set_cloog_options (CloogState *state ATTRIBUTE_UNUSED)\n void\n print_clast_stmt (FILE *file, struct clast_stmt *stmt)\n {\n-  CloogState *state = cloog_state_malloc ();\n-  CloogOptions *options = set_cloog_options (state);\n+  CloogOptions *options = set_cloog_options ();\n \n   clast_pprint (file, stmt, 0, options);\n   cloog_options_free (options);\n-  cloog_state_free (state);\n }\n \n /* Prints STMT to STDERR.  */\n@@ -1432,14 +1430,14 @@ debug_clast_stmt (struct clast_stmt *stmt)\n    without a program.  */\n \n cloog_prog_clast\n-scop_to_clast (scop_p scop, CloogState *state)\n+scop_to_clast (scop_p scop)\n {\n-  CloogOptions *options = set_cloog_options (state);\n+  CloogOptions *options = set_cloog_options ();\n   cloog_prog_clast pc;\n \n   /* Connect new cloog prog generation to graphite.  */\n   pc.prog = cloog_program_malloc ();\n-  build_cloog_prog (scop, pc.prog, options, state);\n+  build_cloog_prog (scop, pc.prog, options);\n   pc.prog = cloog_program_generate (pc.prog, options);\n   pc.stmt = cloog_clast_create (pc.prog, options);\n \n@@ -1452,10 +1450,9 @@ scop_to_clast (scop_p scop, CloogState *state)\n void\n print_generated_program (FILE *file, scop_p scop)\n {\n-  CloogState *state = cloog_state_malloc ();\n-  CloogOptions *options = set_cloog_options (state);\n+  CloogOptions *options = set_cloog_options ();\n \n-  cloog_prog_clast pc = scop_to_clast (scop, state);\n+  cloog_prog_clast pc = scop_to_clast (scop);\n \n   fprintf (file, \"       (prog: \\n\");\n   cloog_program_print (file, pc.prog);\n@@ -1506,13 +1503,11 @@ gloog (scop_p scop, htab_t bb_pbb_mapping)\n   ifsese if_region = NULL;\n   htab_t newivs_index, params_index;\n   cloog_prog_clast pc;\n-  CloogState *state;\n \n-  state = cloog_state_malloc ();\n   timevar_push (TV_GRAPHITE_CODE_GEN);\n   gloog_error = false;\n \n-  pc = scop_to_clast (scop, state);\n+  pc = scop_to_clast (scop);\n \n   if (dump_file && (dump_flags & TDF_DETAILS))\n     {\n@@ -1577,8 +1572,6 @@ gloog (scop_p scop, htab_t bb_pbb_mapping)\n \t       num_no_dependency);\n     }\n \n-  cloog_state_free (state);\n-\n   return !gloog_error;\n }\n #endif"}, {"sha": "9d599d6d0754e6592849b629a5ed6fd097cc881b", "filename": "gcc/graphite-clast-to-gimple.h", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2Fgraphite-clast-to-gimple.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2Fgraphite-clast-to-gimple.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgraphite-clast-to-gimple.h?ref=57d598f76c30d7a78686552398a4ce45550dc982", "patch": "@@ -22,6 +22,9 @@ along with GCC; see the file COPYING3.  If not see\n #define GCC_GRAPHITE_CLAST_TO_GIMPLE_H\n \n #include \"graphite-cloog-util.h\"\n+\n+extern CloogState *cloog_state;\n+\n /* Data structure for CLooG program representation.  */\n \n typedef struct cloog_prog_clast {\n@@ -35,10 +38,10 @@ typedef struct bb_pbb_def\n {\n   basic_block bb;\n   poly_bb_p pbb;\n-}bb_pbb_def;\n+} bb_pbb_def;\n \n extern bool gloog (scop_p, htab_t);\n-extern cloog_prog_clast scop_to_clast (scop_p, CloogState *);\n+extern cloog_prog_clast scop_to_clast (scop_p);\n extern void debug_clast_stmt (struct clast_stmt *);\n extern void print_clast_stmt (FILE *, struct clast_stmt *);\n "}, {"sha": "b013447443f009154512419000c64f5fe98b8355", "filename": "gcc/graphite.c", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2Fgraphite.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57d598f76c30d7a78686552398a4ce45550dc982/gcc%2Fgraphite.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgraphite.c?ref=57d598f76c30d7a78686552398a4ce45550dc982", "patch": "@@ -54,6 +54,8 @@ along with GCC; see the file COPYING3.  If not see\n #include \"graphite-clast-to-gimple.h\"\n #include \"graphite-sese-to-poly.h\"\n \n+CloogState *cloog_state;\n+\n /* Print global statistics to FILE.  */\n \n static void\n@@ -206,6 +208,7 @@ graphite_initialize (void)\n   ppl_initialized = ppl_initialize ();\n   gcc_assert (ppl_initialized == 0);\n \n+  cloog_state = cloog_state_malloc ();\n   cloog_initialize ();\n \n   if (dump_file && dump_flags)\n@@ -229,6 +232,7 @@ graphite_finalize (bool need_cfg_cleanup_p)\n       tree_estimate_probability ();\n     }\n \n+  cloog_state_free (cloog_state);\n   cloog_finalize ();\n   ppl_finalize ();\n   free_original_copy_tables ();"}]}