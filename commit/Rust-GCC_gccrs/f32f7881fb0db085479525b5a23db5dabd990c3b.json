{"sha": "f32f7881fb0db085479525b5a23db5dabd990c3b", "node_id": "C_kwDOANBUbNoAKGYzMmY3ODgxZmIwZGIwODU0Nzk1MjViNWEyM2RiNWRhYmQ5OTBjM2I", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2023-04-04T03:20:13Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2023-04-13T18:59:31Z"}, "message": "c++: make trait of incomplete type a permerror [PR109277]\n\nAn incomplete type argument to several traits is specified to be undefined\nbehavior in the library; since it's a compile-time property, we diagnose\nit.  But apparently some code was relying on the previous behavior of not\ndiagnosing.  So let's make it a permerror.\n\nThe assert in cxx_incomplete_type_diagnostic didn't like that, and I don't\nsee the point of having the assert, so let's just remove it.\n\n\tPR c++/109277\n\ngcc/cp/ChangeLog:\n\n\t* semantics.cc (check_trait_type): Handle incomplete type directly.\n\t* typeck2.cc (cxx_incomplete_type_diagnostic): Remove assert.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/ext/is_convertible5.C: New test.", "tree": {"sha": "9c687d279c56460fd9745b892383a15c38f6416f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9c687d279c56460fd9745b892383a15c38f6416f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f32f7881fb0db085479525b5a23db5dabd990c3b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f32f7881fb0db085479525b5a23db5dabd990c3b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f32f7881fb0db085479525b5a23db5dabd990c3b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f32f7881fb0db085479525b5a23db5dabd990c3b/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fdb8c06b3d6c1ec5fb517ce7d1a88ab1d8ec7958", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fdb8c06b3d6c1ec5fb517ce7d1a88ab1d8ec7958", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fdb8c06b3d6c1ec5fb517ce7d1a88ab1d8ec7958"}], "stats": {"total": 18, "additions": 13, "deletions": 5}, "files": [{"sha": "45e0b0e81d30a6c389af2beed03d5c105d824b08", "filename": "gcc/cp/semantics.cc", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f32f7881fb0db085479525b5a23db5dabd990c3b/gcc%2Fcp%2Fsemantics.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f32f7881fb0db085479525b5a23db5dabd990c3b/gcc%2Fcp%2Fsemantics.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsemantics.cc?ref=f32f7881fb0db085479525b5a23db5dabd990c3b", "patch": "@@ -12107,7 +12107,12 @@ check_trait_type (tree type, int kind = 1)\n   if (VOID_TYPE_P (type))\n     return true;\n \n-  return !!complete_type_or_else (strip_array_types (type), NULL_TREE);\n+  type = complete_type (strip_array_types (type));\n+  if (!COMPLETE_TYPE_P (type)\n+      && cxx_incomplete_type_diagnostic (NULL_TREE, type, DK_PERMERROR)\n+      && !flag_permissive)\n+    return false;\n+  return true;\n }\n \n /* Process a trait expression.  */"}, {"sha": "bf03967a71f07bcff1ef39d7352770dc15b62392", "filename": "gcc/cp/typeck2.cc", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f32f7881fb0db085479525b5a23db5dabd990c3b/gcc%2Fcp%2Ftypeck2.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f32f7881fb0db085479525b5a23db5dabd990c3b/gcc%2Fcp%2Ftypeck2.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck2.cc?ref=f32f7881fb0db085479525b5a23db5dabd990c3b", "patch": "@@ -298,10 +298,6 @@ cxx_incomplete_type_diagnostic (location_t loc, const_tree value,\n {\n   bool is_decl = false, complained = false;\n \n-  gcc_assert (diag_kind == DK_WARNING \n-\t      || diag_kind == DK_PEDWARN \n-\t      || diag_kind == DK_ERROR);\n-\n   /* Avoid duplicate error message.  */\n   if (TREE_CODE (type) == ERROR_MARK)\n     return false;"}, {"sha": "ab9be05afea95dd74ad04035258f275aa0b04318", "filename": "gcc/testsuite/g++.dg/ext/is_convertible5.C", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f32f7881fb0db085479525b5a23db5dabd990c3b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fis_convertible5.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f32f7881fb0db085479525b5a23db5dabd990c3b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fis_convertible5.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fext%2Fis_convertible5.C?ref=f32f7881fb0db085479525b5a23db5dabd990c3b", "patch": "@@ -0,0 +1,7 @@\n+// PR c++/109277\n+// { dg-do compile { target c++11 } }\n+// { dg-options -fpermissive }\n+\n+struct a;\n+struct b{};\n+static_assert (!__is_convertible (a, b), \"\"); // { dg-warning \"incomplete\" }"}]}