{"sha": "6b8ecbc6d6652d061d7c72c64352d51eca2df6ca", "node_id": "C_kwDOANBUbNoAKDZiOGVjYmM2ZDY2NTJkMDYxZDdjNzJjNjQzNTJkNTFlY2EyZGY2Y2E", "commit": {"author": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2021-11-27T20:43:52Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2021-11-30T21:10:06Z"}, "message": "Fortran: improve expansion of constant array expressions within constructors\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/102787\n\t* array.c (expand_constructor): When encountering a constant array\n\texpression or array section within a constructor, simplify it to\n\tenable better expansion.\n\ngcc/testsuite/ChangeLog:\n\n\t* gfortran.dg/array_constructor_54.f90: New test.", "tree": {"sha": "e3b75288123b3aa54ba5a481ddb2a66c35ecb67d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e3b75288123b3aa54ba5a481ddb2a66c35ecb67d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca/comments", "author": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a3e75c1491cd2d501081210925a89a65b1c1e5e5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a3e75c1491cd2d501081210925a89a65b1c1e5e5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a3e75c1491cd2d501081210925a89a65b1c1e5e5"}], "stats": {"total": 29, "additions": 29, "deletions": 0}, "files": [{"sha": "fbc66097c80916fa5820834c7f5f9f51353524b2", "filename": "gcc/fortran/array.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca/gcc%2Ffortran%2Farray.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca/gcc%2Ffortran%2Farray.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Farray.c?ref=6b8ecbc6d6652d061d7c72c64352d51eca2df6ca", "patch": "@@ -1804,6 +1804,12 @@ expand_constructor (gfc_constructor_base base)\n       if (empty_constructor)\n \tempty_ts = e->ts;\n \n+      /* Simplify constant array expression/section within constructor.  */\n+      if (e->expr_type == EXPR_VARIABLE && e->rank > 0 && e->ref\n+\t  && e->symtree && e->symtree->n.sym\n+\t  && e->symtree->n.sym->attr.flavor == FL_PARAMETER)\n+\tgfc_simplify_expr (e, 0);\n+\n       if (e->expr_type == EXPR_ARRAY)\n \t{\n \t  if (!expand_constructor (e->value.constructor))"}, {"sha": "44d2f9fdf42705862bd2ef3795970ff1a277dfe6", "filename": "gcc/testsuite/gfortran.dg/array_constructor_54.f90", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca/gcc%2Ftestsuite%2Fgfortran.dg%2Farray_constructor_54.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6b8ecbc6d6652d061d7c72c64352d51eca2df6ca/gcc%2Ftestsuite%2Fgfortran.dg%2Farray_constructor_54.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Farray_constructor_54.f90?ref=6b8ecbc6d6652d061d7c72c64352d51eca2df6ca", "patch": "@@ -0,0 +1,23 @@\n+! { dg-do compile }\n+! { dg-options \"-fdump-tree-original -Warray-temporaries\" }\n+! { dg-final { scan-tree-dump-not \"stride\" \"original\" } }\n+! Verify that no temporary array is generated for a constant array constructor\n+! See e.g. PR fortran/102717, PR fortran/102787\n+\n+program p\n+  integer, parameter :: a(*)   = [1,2,3,4]\n+  integer, parameter :: b(2,3) = reshape([1,2,3,4,5,6], shape (b))\n+  print *, [a]\n+  print *, [a( : ) ]\n+  print *, [a( ::1)]\n+  print *, [a( ::2)]\n+  print *, [a(1:2:1)]\n+  print *, [a(4:1:-2)]\n+  print *, [a([3,2])]\n+  print *, [a,1]\n+  print *, [1,a]\n+  print *, [a,a]\n+  print *, [b(:,3:1:-2)]\n+  print *, [1,b(1,[2,1,3])]\n+  print *, [a,b]\n+end"}]}