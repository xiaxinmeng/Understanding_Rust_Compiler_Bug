{"sha": "fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmQxZDljMWFmN2M3YWZhNDNlYmFjMTYyZjk0Mjc0MjBlYTIzMTRmZg==", "commit": {"author": {"name": "Marc Poulhi\u00e8s", "email": "dkm@kataplop.net", "date": "2021-08-12T11:44:55Z"}, "committer": {"name": "Marc", "email": "dkm@kataplop.net", "date": "2021-08-18T20:59:43Z"}, "message": "hir: lower Module\n\nLower AST::Module to HIR::ModuleBodied.\nAdd HIR::ModuleBodied::get_items to access module's items.\n\nFix tests that are already using module.\n\nref #432", "tree": {"sha": "9558f576df838d85451cad8a3b5c6ad4105c1438", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9558f576df838d85451cad8a3b5c6ad4105c1438"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/comments", "author": {"login": "dkm", "id": 87603, "node_id": "MDQ6VXNlcjg3NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/87603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dkm", "html_url": "https://github.com/dkm", "followers_url": "https://api.github.com/users/dkm/followers", "following_url": "https://api.github.com/users/dkm/following{/other_user}", "gists_url": "https://api.github.com/users/dkm/gists{/gist_id}", "starred_url": "https://api.github.com/users/dkm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dkm/subscriptions", "organizations_url": "https://api.github.com/users/dkm/orgs", "repos_url": "https://api.github.com/users/dkm/repos", "events_url": "https://api.github.com/users/dkm/events{/privacy}", "received_events_url": "https://api.github.com/users/dkm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dkm", "id": 87603, "node_id": "MDQ6VXNlcjg3NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/87603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dkm", "html_url": "https://github.com/dkm", "followers_url": "https://api.github.com/users/dkm/followers", "following_url": "https://api.github.com/users/dkm/following{/other_user}", "gists_url": "https://api.github.com/users/dkm/gists{/gist_id}", "starred_url": "https://api.github.com/users/dkm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dkm/subscriptions", "organizations_url": "https://api.github.com/users/dkm/orgs", "repos_url": "https://api.github.com/users/dkm/repos", "events_url": "https://api.github.com/users/dkm/events{/privacy}", "received_events_url": "https://api.github.com/users/dkm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37a6b4ae78070b136d86bb0a7f207b8c2af69383", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37a6b4ae78070b136d86bb0a7f207b8c2af69383", "html_url": "https://github.com/Rust-GCC/gccrs/commit/37a6b4ae78070b136d86bb0a7f207b8c2af69383"}], "stats": {"total": 61, "additions": 52, "deletions": 9}, "files": [{"sha": "bcf83ee63b628bf2e563dc4e162493e4eeb30c80", "filename": "gcc/rust/hir/rust-ast-lower-item.h", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h?ref=fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "patch": "@@ -29,6 +29,7 @@\n #include \"rust-ast-lower-pattern.h\"\n #include \"rust-ast-lower-block.h\"\n #include \"rust-ast-lower-extern.h\"\n+#include \"rust-hir-full-decls.h\"\n \n namespace Rust {\n namespace HIR {\n@@ -54,6 +55,43 @@ class ASTLoweringItem : public ASTLoweringBase\n     return resolver.translated;\n   }\n \n+  void visit (AST::Module &module) override\n+  {\n+    auto crate_num = mappings->get_current_crate ();\n+    Analysis::NodeMapping mapping (crate_num, module.get_node_id (),\n+\t\t\t\t   mappings->get_next_hir_id (crate_num),\n+\t\t\t\t   mappings->get_next_localdef_id (crate_num));\n+\n+    // should be lowered from module.get_vis()\n+    HIR::Visibility vis = HIR::Visibility::create_public ();\n+\n+    auto items = std::vector<std::unique_ptr<Item> > ();\n+\n+    for (auto &item : module.get_items ())\n+      {\n+\tauto transitem = translate (item.get ());\n+\titems.push_back (std::unique_ptr<Item> (transitem));\n+      }\n+\n+    // should be lowered/copied from module.get_in/outer_attrs()\n+    AST::AttrVec inner_attrs;\n+    AST::AttrVec outer_attrs;\n+\n+    translated\n+      = new HIR::ModuleBodied (mapping, module.get_name (), module.get_locus (),\n+\t\t\t       std::move (items), std::move (vis),\n+\t\t\t       std::move (inner_attrs),\n+\t\t\t       std::move (outer_attrs));\n+\n+    mappings->insert_defid_mapping (mapping.get_defid (), translated);\n+    mappings->insert_hir_item (mapping.get_crate_num (), mapping.get_hirid (),\n+\t\t\t       translated);\n+    mappings->insert_module (mapping.get_crate_num (), mapping.get_hirid (),\n+\t\t\t     static_cast<Module *> (translated));\n+    mappings->insert_location (crate_num, mapping.get_hirid (),\n+\t\t\t       module.get_locus ());\n+  }\n+\n   void visit (AST::TypeAlias &alias) override\n   {\n     std::vector<std::unique_ptr<HIR::WhereClauseItem> > where_clause_items;"}, {"sha": "32ee317edb6cb60609e2429c7351b16e3c7c5508", "filename": "gcc/rust/hir/tree/rust-hir-item.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-item.h?ref=fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "patch": "@@ -718,6 +718,8 @@ class ModuleBodied : public Module\n \n   void accept_vis (HIRVisitor &vis) override;\n \n+  std::vector<std::unique_ptr<Item> > &get_items () { return items; };\n+\n   /* Override that runs the function recursively on all items contained within\n    * the module. */\n   void add_crate_name (std::vector<std::string> &names) const override;"}, {"sha": "41c3b510dece89834471e9fab7a655792b41ef57", "filename": "gcc/testsuite/rust/compile/torture/all_doc_comment_line_blocks.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fall_doc_comment_line_blocks.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fall_doc_comment_line_blocks.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fall_doc_comment_line_blocks.rs?ref=fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "patch": "@@ -9,7 +9,7 @@\n \n /// outer doc line for module\n /** outer doc block for module               */\n-pub mod module\n+pub mod module // { dg-warning \"unused name\" }\n {\n   //!  inner line doc\n   //!! inner line doc!\n@@ -24,21 +24,23 @@ pub mod module\n   /**  outer block doc */\n   /*** block comment   */\n \n-  mod block_doc_comments\n+  mod block_doc_comments // { dg-warning \"unused name\" }\n   {\n     /*   /* */  /** */  /*! */  */\n     /*!  /* */  /** */  /*! */  */\n     /**  /* */  /** */  /*! */  */\n-    mod item { }\n+    mod item { } // { dg-warning \"unused name\" }\n   }\n \n-  pub mod empty\n+  pub mod empty // { dg-warning \"unused name\" }\n   {\n     //!\n     /*!*/\n     //\n \n     ///\n+    // the following warning is issued one line earlier\n+    // { dg-warning \"unused name\" }\n     mod doc { }\n     /**/\n     /***/"}, {"sha": "e5ed91189c5d46fa675088851663f7ec20aedb20", "filename": "gcc/testsuite/rust/compile/torture/all_doc_comment_line_blocks_crlf.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fall_doc_comment_line_blocks_crlf.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd1d9c1af7c7afa43ebac162f9427420ea2314ff/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fall_doc_comment_line_blocks_crlf.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fall_doc_comment_line_blocks_crlf.rs?ref=fd1d9c1af7c7afa43ebac162f9427420ea2314ff", "patch": "@@ -9,7 +9,7 @@\n \r\n /// outer doc line for module\r\n /** outer doc block for module               */\r\n-pub mod module\r\n+pub mod module // { dg-warning \"unused name\" }\r\n {\r\n   //!  inner line doc\r\n   //!! inner line doc!\r\n@@ -24,22 +24,23 @@ pub mod module\n   /**  outer block doc */\r\n   /*** block comment   */\r\n \r\n-  mod block_doc_comments\r\n+  mod block_doc_comments // { dg-warning \"unused name\" }\r\n   {\r\n     /*   /* */  /** */  /*! */  */\r\n     /*!  /* */  /** */  /*! */  */\r\n     /**  /* */  /** */  /*! */  */\r\n-    mod item { }\r\n+    mod item { } // { dg-warning \"unused name\" }\r\n   }\r\n \r\n-  pub mod empty\r\n+  pub mod empty // { dg-warning \"unused name\" }\r\n   {\r\n     //!\r\n     /*!*/\r\n     //\r\n \r\n     ///\r\n-    mod doc { }\r\n+    mod doc { }    // { dg-warning \"unused name\" }\r\n+\r\n     /**/\r\n     /***/\r\n   }\r"}]}