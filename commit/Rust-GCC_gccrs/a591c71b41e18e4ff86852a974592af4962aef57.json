{"sha": "a591c71b41e18e4ff86852a974592af4962aef57", "node_id": "C_kwDOANBUbNoAKGE1OTFjNzFiNDFlMThlNGZmODY4NTJhOTc0NTkyYWY0OTYyYWVmNTc", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-01-28T18:02:26Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-01-28T18:02:26Z"}, "message": "store-merging: Fix up a -fcompare-debug bug in get_status_for_store_merging [PR104263]\n\nAs mentioned in the PRthe following testcase fails, because the last\nstmt of a bb with -g is a debug stmt and get_status_for_store_merging\nuses gimple_seq_last_stmt (bb_seq (bb)) when testing if it is valid\nfor store merging.  The debug stmt isn't valid, while a stmt at that\nposition with -g0 is valid and so the divergence.\n\nAs we walk the whole bb already, this patch just remembers the last\nnon-debug stmt, so that we don't need to skip backwards debug stmts at the\nend of the bb to find last real stmt.\n\n2022-01-28  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR tree-optimization/104263\n\t* gimple-ssa-store-merging.cc (get_status_for_store_merging): For\n\tcfun->can_throw_non_call_exceptions && cfun->eh test whether\n\tlast non-debug stmt in the bb is store_valid_for_store_merging_p\n\trather than last stmt.\n\n\t* gcc.dg/pr104263.c: New test.", "tree": {"sha": "beb18d6e1804d566e8412e19556fa0dfd6e98a03", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/beb18d6e1804d566e8412e19556fa0dfd6e98a03"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a591c71b41e18e4ff86852a974592af4962aef57", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a591c71b41e18e4ff86852a974592af4962aef57", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a591c71b41e18e4ff86852a974592af4962aef57", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a591c71b41e18e4ff86852a974592af4962aef57/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "90c31ff339015ddd89ac519656fbd23a36ee6271", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/90c31ff339015ddd89ac519656fbd23a36ee6271", "html_url": "https://github.com/Rust-GCC/gccrs/commit/90c31ff339015ddd89ac519656fbd23a36ee6271"}], "stats": {"total": 30, "additions": 29, "deletions": 1}, "files": [{"sha": "e2e2157f1cb7fd1af80df2dd6c3945b85bb53c96", "filename": "gcc/gimple-ssa-store-merging.cc", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a591c71b41e18e4ff86852a974592af4962aef57/gcc%2Fgimple-ssa-store-merging.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a591c71b41e18e4ff86852a974592af4962aef57/gcc%2Fgimple-ssa-store-merging.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-ssa-store-merging.cc?ref=a591c71b41e18e4ff86852a974592af4962aef57", "patch": "@@ -5364,6 +5364,7 @@ get_status_for_store_merging (basic_block bb)\n   unsigned int num_constructors = 0;\n   gimple_stmt_iterator gsi;\n   edge e;\n+  gimple *last_stmt = NULL;\n \n   for (gsi = gsi_after_labels (bb); !gsi_end_p (gsi); gsi_next (&gsi))\n     {\n@@ -5372,6 +5373,8 @@ get_status_for_store_merging (basic_block bb)\n       if (is_gimple_debug (stmt))\n \tcontinue;\n \n+      last_stmt = stmt;\n+\n       if (store_valid_for_store_merging_p (stmt) && ++num_statements >= 2)\n \tbreak;\n \n@@ -5398,7 +5401,7 @@ get_status_for_store_merging (basic_block bb)\n     return BB_INVALID;\n \n   if (cfun->can_throw_non_call_exceptions && cfun->eh\n-      && store_valid_for_store_merging_p (gimple_seq_last_stmt (bb_seq (bb)))\n+      && store_valid_for_store_merging_p (last_stmt)\n       && (e = find_fallthru_edge (bb->succs))\n       && e->dest == bb->next_bb)\n     return BB_EXTENDED_VALID;"}, {"sha": "79b548c629ceed52088e50dd3e999edeebc074fc", "filename": "gcc/testsuite/gcc.dg/pr104263.c", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a591c71b41e18e4ff86852a974592af4962aef57/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104263.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a591c71b41e18e4ff86852a974592af4962aef57/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104263.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr104263.c?ref=a591c71b41e18e4ff86852a974592af4962aef57", "patch": "@@ -0,0 +1,25 @@\n+/* PR tree-optimization/104263 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fcompare-debug -fnon-call-exceptions -fno-inline-small-functions\" } */\n+\n+int n;\n+\n+int\n+bar (void)\n+{\n+  int a;\n+\n+  n = 0;\n+  a = 0;\n+\n+  return n;\n+}\n+\n+__attribute__ ((pure, returns_twice)) int\n+foo (void)\n+{\n+  n = bar () + 1;\n+  foo ();\n+\n+  return 0;\n+}"}]}