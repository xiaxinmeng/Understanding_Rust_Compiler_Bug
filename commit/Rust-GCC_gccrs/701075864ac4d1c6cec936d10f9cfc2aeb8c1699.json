{"sha": "701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "node_id": "C_kwDOANBUbNoAKDcwMTA3NTg2NGFjNGQxYzZjZWM5MzZkMTBmOWNmYzJhZWI4YzE2OTk", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-10-01T08:30:16Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-10-01T08:30:16Z"}, "message": "c++: Fix handling of __thread/thread_local extern vars declared at function scope [PR102496]\n\nThe introduction of push_local_extern_decl_alias in\nr11-3699-g4e62aca0e0520e4ed2532f2d8153581190621c1a\nbroke tls vars, while the decl they are created for has the tls model\nset properly, nothing sets it for the alias that is actually used,\nso accesses to it are done as if they were normal variables.\nThis is then diagnosed at link time if the definition of the extern\nvars is __thread/thread_local.\n\n2021-10-01  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR c++/102496\n\t* name-lookup.c (push_local_extern_decl_alias): Return early even for\n\ttls vars with non-dependent type when processing_template_decl.  For\n\tCP_DECL_THREAD_LOCAL_P vars call set_decl_tls_model on alias.\n\n\t* g++.dg/tls/pr102496-1.C: New test.\n\t* g++.dg/tls/pr102496-2.C: New test.", "tree": {"sha": "33bb4e31a455a2a4d53ee7307485c7303569dde2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/33bb4e31a455a2a4d53ee7307485c7303569dde2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "html_url": "https://github.com/Rust-GCC/gccrs/commit/701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a7f20ed26416b56df6f3c8240f3c65a5715b17d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a7f20ed26416b56df6f3c8240f3c65a5715b17d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3a7f20ed26416b56df6f3c8240f3c65a5715b17d"}], "stats": {"total": 33, "additions": 32, "deletions": 1}, "files": [{"sha": "c414a1091b449826a91188667dc58932281c715d", "filename": "gcc/cp/name-lookup.c", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/gcc%2Fcp%2Fname-lookup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/gcc%2Fcp%2Fname-lookup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.c?ref=701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "patch": "@@ -3375,7 +3375,10 @@ set_decl_context_in_fn (tree ctx, tree decl)\n void\n push_local_extern_decl_alias (tree decl)\n {\n-  if (dependent_type_p (TREE_TYPE (decl)))\n+  if (dependent_type_p (TREE_TYPE (decl))\n+      || (processing_template_decl\n+\t  && VAR_P (decl)\n+\t  && CP_DECL_THREAD_LOCAL_P (decl)))\n     return;\n   /* EH specs were not part of the function type prior to c++17, but\n      we still can't go pushing dependent eh specs into the namespace.  */\n@@ -3471,6 +3474,8 @@ push_local_extern_decl_alias (tree decl)\n \t  push_nested_namespace (ns);\n \t  alias = do_pushdecl (alias, /* hiding= */true);\n \t  pop_nested_namespace (ns);\n+\t  if (VAR_P (decl) && CP_DECL_THREAD_LOCAL_P (decl))\n+\t    set_decl_tls_model (alias, DECL_TLS_MODEL (decl));\n \t}\n     }\n "}, {"sha": "8220e1e663ac5e7b624b51e15eaf3f8cfc92a98c", "filename": "gcc/testsuite/g++.dg/tls/pr102496-1.C", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr102496-1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr102496-1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr102496-1.C?ref=701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "patch": "@@ -0,0 +1,20 @@\n+// PR c++/102496\n+// { dg-do link { target c++11 } }\n+// { dg-require-effective-target tls }\n+// { dg-add-options tls }\n+// { dg-additional-sources pr102496-2.C }\n+\n+template <int N>\n+int\n+foo ()\n+{\n+  extern __thread int t1;\n+  return t1;\n+}\n+\n+int\n+main ()\n+{\n+  extern __thread int t2;\n+  return foo <0> () + t2;\n+}"}, {"sha": "a71a9cddc34fe512f5b04c21db081a65150005f1", "filename": "gcc/testsuite/g++.dg/tls/pr102496-2.C", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr102496-2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/701075864ac4d1c6cec936d10f9cfc2aeb8c1699/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr102496-2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftls%2Fpr102496-2.C?ref=701075864ac4d1c6cec936d10f9cfc2aeb8c1699", "patch": "@@ -0,0 +1,6 @@\n+// PR c++/102496\n+// { dg-do compile { target c++11 } }\n+// { dg-require-effective-target tls }\n+\n+__thread int t1;\n+__thread int t2;"}]}