{"sha": "395848255cfa88f6f0f33a9b14c79e584a05d6fc", "node_id": "C_kwDOANBUbNoAKDM5NTg0ODI1NWNmYTg4ZjZmMGYzM2E5YjE0Yzc5ZTU4NGEwNWQ2ZmM", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2021-11-10T21:23:12Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2021-11-16T22:35:15Z"}, "message": "c-family: don't cache large vecs\n\nPatrick observed recently that an element of the vector cache could be\narbitrarily large.  Let's only cache relatively small vecs.\n\ngcc/c-family/ChangeLog:\n\n\t* c-common.c (release_tree_vector): Only cache vecs smaller than\n\t16 elements.", "tree": {"sha": "2da3124e22bf61524abb557a9c0b83fab2e211ed", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2da3124e22bf61524abb557a9c0b83fab2e211ed"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/395848255cfa88f6f0f33a9b14c79e584a05d6fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/395848255cfa88f6f0f33a9b14c79e584a05d6fc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/395848255cfa88f6f0f33a9b14c79e584a05d6fc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/395848255cfa88f6f0f33a9b14c79e584a05d6fc/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6dc90c4dbb6f9589dea9c670c3468496bb207de5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6dc90c4dbb6f9589dea9c670c3468496bb207de5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6dc90c4dbb6f9589dea9c670c3468496bb207de5"}], "stats": {"total": 12, "additions": 10, "deletions": 2}, "files": [{"sha": "90e8ec87b6b9b21276df755d6dee69338ff980b0", "filename": "gcc/c-family/c-common.c", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/395848255cfa88f6f0f33a9b14c79e584a05d6fc/gcc%2Fc-family%2Fc-common.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/395848255cfa88f6f0f33a9b14c79e584a05d6fc/gcc%2Fc-family%2Fc-common.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-common.c?ref=395848255cfa88f6f0f33a9b14c79e584a05d6fc", "patch": "@@ -8213,8 +8213,16 @@ release_tree_vector (vec<tree, va_gc> *vec)\n {\n   if (vec != NULL)\n     {\n-      vec->truncate (0);\n-      vec_safe_push (tree_vector_cache, vec);\n+      if (vec->allocated () >= 16)\n+\t/* Don't cache vecs that have expanded more than once.  On a p64\n+\t   target, vecs double in alloc size with each power of 2 elements, e.g\n+\t   at 16 elements the alloc increases from 128 to 256 bytes.  */\n+\tvec_free (vec);\n+      else\n+\t{\n+\t  vec->truncate (0);\n+\t  vec_safe_push (tree_vector_cache, vec);\n+\t}\n     }\n }\n "}]}