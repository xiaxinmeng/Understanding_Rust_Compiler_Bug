{"sha": "fab72592d86d11b89a01f0f3c2c9c329d43466c1", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmFiNzI1OTJkODZkMTFiODlhMDFmMGYzYzJjOWMzMjlkNDM0NjZjMQ==", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2020-11-03T21:06:29Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2020-11-03T21:26:02Z"}, "message": "[OpenACC] Use proper location to 'inform' of enclosing parent compute construct\n\nBug fix for recent commit beddd1762ad2bbe84dd776c54489153f83f21e56 \"[OpenACC]\nMore precise diagnostics for 'gang', 'worker', 'vector' clauses with arguments\non 'loop' only allowed in 'kernels' regions\":\n\n> [...], and 'inform' at the location of the enclosing parent\n> compute construct/[...].\n\nNow really.\n\n\tgcc/\n\t* omp-low.c (scan_omp_for) <OpenACC>: Use proper location to\n\t'inform' of enclosing parent compute construct.\n\tgcc/testsuite/\n\t* c-c++-common/goacc/pr92793-1.c: Extend.\n\t* gfortran.dg/goacc/pr92793-1.f90: Likewise.", "tree": {"sha": "445a2dc949c8e911cea9fdd89a841d67e4d2522f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/445a2dc949c8e911cea9fdd89a841d67e4d2522f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fab72592d86d11b89a01f0f3c2c9c329d43466c1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fab72592d86d11b89a01f0f3c2c9c329d43466c1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fab72592d86d11b89a01f0f3c2c9c329d43466c1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fab72592d86d11b89a01f0f3c2c9c329d43466c1/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12d05123053359903c2859c72ce29749662b3ab5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/12d05123053359903c2859c72ce29749662b3ab5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/12d05123053359903c2859c72ce29749662b3ab5"}], "stats": {"total": 115, "additions": 104, "deletions": 11}, "files": [{"sha": "ea9008b61c41c5245c46d284ea636dca9688ec2d", "filename": "gcc/omp-low.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fab72592d86d11b89a01f0f3c2c9c329d43466c1/gcc%2Fomp-low.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fab72592d86d11b89a01f0f3c2c9c329d43466c1/gcc%2Fomp-low.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.c?ref=fab72592d86d11b89a01f0f3c2c9c329d43466c1", "patch": "@@ -2443,7 +2443,7 @@ scan_omp_for (gomp_for *stmt, omp_context *outer_ctx)\n \t\t\t  \"argument not permitted on %qs clause\",\n \t\t\t  omp_clause_code_name[OMP_CLAUSE_CODE (c)]);\n \t\tif (tgt)\n-\t\t  inform (gimple_location (outer_ctx->stmt),\n+\t\t  inform (gimple_location (tgt->stmt),\n \t\t\t  \"enclosing parent compute construct\");\n \t\telse if (oacc_get_fn_attrib (current_function_decl))\n \t\t  inform (DECL_SOURCE_LOCATION (current_function_decl),"}, {"sha": "71a556e275133dc2e067ae2632d6c24d6952ef07", "filename": "gcc/testsuite/c-c++-common/goacc/pr92793-1.c", "status": "modified", "additions": 53, "deletions": 5, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fab72592d86d11b89a01f0f3c2c9c329d43466c1/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fpr92793-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fab72592d86d11b89a01f0f3c2c9c329d43466c1/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fpr92793-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fpr92793-1.c?ref=fab72592d86d11b89a01f0f3c2c9c329d43466c1", "patch": "@@ -57,7 +57,7 @@ reduction(-:sum  ) /* { dg-line sum2 } */ \\\n \n \n void\n-a_sl() {\n+gwv_sl_1() {\n #pragma acc serial loop /* { dg-message \"9: enclosing parent compute construct\" } */ \\\n     gang(num:5) /* { dg-error \"5: argument not permitted on 'gang' clause\" } */ \\\n   worker(num:5) /* { dg-error \"3: argument not permitted on 'worker' clause\" } */ \\\n@@ -67,7 +67,25 @@ a_sl() {\n }\n \n void\n-a_s_l() {\n+gwv_sl_2() {\n+#pragma acc serial loop /* { dg-message \"9: enclosing parent compute construct\" } */\n+  for (int i = 0; i < 10; i++)\n+    {\n+#pragma acc loop /* { dg-bogus \"enclosing parent compute construct\" } */\n+      for (int j = 0; j < 10; j++)\n+\t{\n+#pragma acc loop \\\n+        gang(num:5) /* { dg-error \"9: argument not permitted on 'gang' clause\" } */ \\\n+    worker(num:5) /* { dg-error \"5: argument not permitted on 'worker' clause\" } */ \\\n+  vector(length:5) /* { dg-error \"3: argument not permitted on 'vector' clause\" } */\n+\t  for (int k = 0; k < 10; k++)\n+\t    ;\n+\t}\n+    }\n+}\n+\n+void\n+gwv_s_l() {\n #pragma acc serial /* { dg-message \"9: enclosing parent compute construct\" } */\n   {\n #pragma acc loop \\\n@@ -76,18 +94,48 @@ a_s_l() {\n   vector(length:5) /* { dg-error \"3: argument not permitted on 'vector' clause\" } */\n     for (int i = 0; i < 10; i++)\n       ;\n+\n+#pragma acc loop\n+    for (int i = 0; i < 10; i++)\n+      {\n+#pragma acc loop /* { dg-bogus \"enclosing parent compute construct\" } */\n+\tfor (int j = 0; j < 10; j++)\n+\t  {\n+#pragma acc loop \\\n+         gang(num:5) /* { dg-error \"10: argument not permitted on 'gang' clause\" } */ \\\n+      worker(num:5) /* { dg-error \"7: argument not permitted on 'worker' clause\" } */ \\\n+    vector(length:5) /* { dg-error \"5: argument not permitted on 'vector' clause\" } */\n+\t    for (int k = 0; k < 10; k++)\n+\t      ;\n+\t  }\n+      }\n   }\n }\n \n-void a_r();\n-#pragma acc routine(a_r)\n+void gwv_r();\n+#pragma acc routine(gwv_r)\n \n void\n-a_r() { /* { dg-message \"1: enclosing routine\" } */\n+gwv_r() { /* { dg-message \"1: enclosing routine\" } */\n #pragma acc loop \\\n    gang(num:5) /* { dg-error \"4: argument not permitted on 'gang' clause\" } */ \\\n     worker(num:5) /* { dg-error \"5: argument not permitted on 'worker' clause\" } */ \\\n   vector(length:5) /* { dg-error \"3: argument not permitted on 'vector' clause\" } */\n   for (int i = 0; i < 10; i++)\n     ;\n+\n+#pragma acc loop\n+    for (int i = 0; i < 10; i++)\n+      {\n+#pragma acc loop\n+\tfor (int j = 0; j < 10; j++)\n+\t  {\n+#pragma acc loop \\\n+     gang(num:5) /* { dg-error \"6: argument not permitted on 'gang' clause\" } */ \\\n+   worker(num:5) /* { dg-error \"4: argument not permitted on 'worker' clause\" } */ \\\n+     vector(length:5) /* { dg-error \"6: argument not permitted on 'vector' clause\" } */\n+\t    for (int k = 0; k < 10; k++)\n+\t      ;\n+\t  }\n+      }\n }"}, {"sha": "422131ba4734587cb1cea905cb31cd09b4ab7b70", "filename": "gcc/testsuite/gfortran.dg/goacc/pr92793-1.f90", "status": "modified", "additions": 50, "deletions": 5, "changes": 55, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fab72592d86d11b89a01f0f3c2c9c329d43466c1/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fpr92793-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fab72592d86d11b89a01f0f3c2c9c329d43466c1/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fpr92793-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fpr92793-1.f90?ref=fab72592d86d11b89a01f0f3c2c9c329d43466c1", "patch": "@@ -47,7 +47,7 @@ subroutine check ()\n end subroutine check\n \n \n-subroutine gwv_sl ()\n+subroutine gwv_sl_1 ()\n   implicit none (type, external)\n   integer :: i\n \n@@ -59,11 +59,30 @@ subroutine gwv_sl ()\n   do i = 0, 10\n   end do\n   !$acc end serial loop\n-end subroutine gwv_sl\n+end subroutine gwv_sl_1\n+\n+subroutine gwv_sl_2 ()\n+  implicit none (type, external)\n+  integer :: i, j, k\n+\n+  !$acc serial loop ! { dg-message \"77: enclosing parent compute construct\" }\n+  do i = 0, 10\n+     !$acc loop ! { dg-bogus \"enclosing parent compute construct\" }\n+     do j = 0, 10\n+        !$acc loop &\n+        !$acc &           gang(num:5) & ! { dg-error \"35: argument not permitted on 'gang' clause\" }\n+        !$acc &      worker(num:5) & ! { dg-error \"32: argument not permitted on 'worker' clause\" }\n+        !$acc &    vector(length:5) ! { dg-error \"33: argument not permitted on 'vector' clause\" }\n+        do k = 0, 10\n+        end do\n+     end do\n+  end do\n+  !$acc end serial loop\n+end subroutine gwv_sl_2\n \n subroutine gwv_s_l ()\n   implicit none (type, external)\n-  integer :: i\n+  integer :: i, j, k\n \n   !$acc serial ! { dg-message \"72: enclosing parent compute construct\" }\n   !$acc loop &\n@@ -72,12 +91,25 @@ subroutine gwv_s_l ()\n   !$acc &      vector(length:5) ! { dg-error \"29: argument not permitted on 'vector' clause\" }\n   do i = 0, 10\n   end do\n-  !$acc end serial\n+\n+  !$acc loop\n+  do i = 0, 10\n+     !$acc loop ! { dg-bogus \"enclosing parent compute construct\" }\n+     do j = 0, 10\n+        !$acc loop &\n+        !$acc &           gang(num:5) & ! { dg-error \"35: argument not permitted on 'gang' clause\" }\n+        !$acc &      worker(num:5) & ! { dg-error \"32: argument not permitted on 'worker' clause\" }\n+        !$acc &        vector(length:5) ! { dg-error \"37: argument not permitted on 'vector' clause\" }\n+        do k = 0, 10\n+        end do\n+     end do\n+  end do\n+!$acc end serial\n end subroutine gwv_s_l\n \n subroutine gwv_r () ! { dg-message \"16: enclosing routine\" }\n   implicit none (type, external)\n-  integer :: i\n+  integer :: i, j, k\n \n   !$acc routine(gwv_r)\n \n@@ -87,4 +119,17 @@ subroutine gwv_r () ! { dg-message \"16: enclosing routine\" }\n   !$acc &    vector(length:5) ! { dg-error \"27: argument not permitted on 'vector' clause\" }\n   do i = 0, 10\n   end do\n+\n+  !$acc loop\n+  do i = 0, 10\n+     !$acc loop\n+     do j = 0, 10\n+        !$acc loop &\n+        !$acc &       gang(num:5) & ! { dg-error \"31: argument not permitted on 'gang' clause\" }\n+        !$acc &     worker(num:5) & ! { dg-error \"31: argument not permitted on 'worker' clause\" }\n+        !$acc &       vector(length:5) ! { dg-error \"36: argument not permitted on 'vector' clause\" }\n+        do k = 0, 10\n+        end do\n+     end do\n+  end do\n end subroutine gwv_r"}]}