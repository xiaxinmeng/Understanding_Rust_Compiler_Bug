{"sha": "a8d7631d333c22e38a067d32d11fd2b60cf1d960", "node_id": "C_kwDOANBUbNoAKGE4ZDc2MzFkMzMzYzIyZTM4YTA2N2QzMmQxMWZkMmI2MGNmMWQ5NjA", "commit": {"author": {"name": "Iain Sandoe", "email": "iain@sandoe.co.uk", "date": "2023-04-01T16:23:51Z"}, "committer": {"name": "Iain Sandoe", "email": "iain@sandoe.co.uk", "date": "2023-04-09T02:15:04Z"}, "message": "c++, coroutines: Fix block nests when the function has no top-level bind.\n\nWhen the function contains no local vars and also no nested scopes, there\nis no top-level bind expression.  Because the rewritten coroutine body will\nrequire both local vars and contain nested scopes, we add a bind expression\nto such functions.  When this was done the necessary scope blocks were\nomitted which leads to disconnected function content.\n\nFixed by adding a new block to the added bind expression.\n\nSigned-off-by: Iain Sandoe <iain@sandoe.co.uk>\n\ngcc/cp/ChangeLog:\n\n\t* coroutines.cc (coro_rewrite_function_body): Ensure that added\n\tbind expressions have scope blocks.", "tree": {"sha": "3a9f30bbd5505e226cc219815c92bf0638c47e3d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3a9f30bbd5505e226cc219815c92bf0638c47e3d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a8d7631d333c22e38a067d32d11fd2b60cf1d960", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8d7631d333c22e38a067d32d11fd2b60cf1d960", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a8d7631d333c22e38a067d32d11fd2b60cf1d960", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8d7631d333c22e38a067d32d11fd2b60cf1d960/comments", "author": {"login": "iains", "id": 4039407, "node_id": "MDQ6VXNlcjQwMzk0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/4039407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iains", "html_url": "https://github.com/iains", "followers_url": "https://api.github.com/users/iains/followers", "following_url": "https://api.github.com/users/iains/following{/other_user}", "gists_url": "https://api.github.com/users/iains/gists{/gist_id}", "starred_url": "https://api.github.com/users/iains/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iains/subscriptions", "organizations_url": "https://api.github.com/users/iains/orgs", "repos_url": "https://api.github.com/users/iains/repos", "events_url": "https://api.github.com/users/iains/events{/privacy}", "received_events_url": "https://api.github.com/users/iains/received_events", "type": "User", "site_admin": false}, "committer": {"login": "iains", "id": 4039407, "node_id": "MDQ6VXNlcjQwMzk0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/4039407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iains", "html_url": "https://github.com/iains", "followers_url": "https://api.github.com/users/iains/followers", "following_url": "https://api.github.com/users/iains/following{/other_user}", "gists_url": "https://api.github.com/users/iains/gists{/gist_id}", "starred_url": "https://api.github.com/users/iains/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iains/subscriptions", "organizations_url": "https://api.github.com/users/iains/orgs", "repos_url": "https://api.github.com/users/iains/repos", "events_url": "https://api.github.com/users/iains/events{/privacy}", "received_events_url": "https://api.github.com/users/iains/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f04ebb49468bc99b58e8726b6ddcff47086d562", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0f04ebb49468bc99b58e8726b6ddcff47086d562", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0f04ebb49468bc99b58e8726b6ddcff47086d562"}], "stats": {"total": 4, "additions": 4, "deletions": 0}, "files": [{"sha": "59a240ebd403996494dd8004c1e41a667b9d6cf7", "filename": "gcc/cp/coroutines.cc", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8d7631d333c22e38a067d32d11fd2b60cf1d960/gcc%2Fcp%2Fcoroutines.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8d7631d333c22e38a067d32d11fd2b60cf1d960/gcc%2Fcp%2Fcoroutines.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcoroutines.cc?ref=a8d7631d333c22e38a067d32d11fd2b60cf1d960", "patch": "@@ -4113,6 +4113,10 @@ coro_rewrite_function_body (location_t fn_start, tree fnbody, tree orig,\n       tree bind_wrap = build3_loc (fn_start, BIND_EXPR, void_type_node,\n \t\t\t\t   NULL, NULL, NULL);\n       BIND_EXPR_BODY (bind_wrap) = fnbody;\n+      /* Ensure we have a block to connect up the scopes.  */\n+      tree new_blk = make_node (BLOCK);\n+      BIND_EXPR_BLOCK (bind_wrap) = new_blk;\n+      BLOCK_SUBBLOCKS (top_block) = new_blk;\n       fnbody = bind_wrap;\n     }\n "}]}