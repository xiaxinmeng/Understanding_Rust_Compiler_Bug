{"sha": "5cee5f94000ee5eabce9b223c44c7923c1c69f61", "node_id": "C_kwDOANBUbNoAKDVjZWU1Zjk0MDAwZWU1ZWFiY2U5YjIyM2M0NGM3OTIzYzFjNjlmNjE", "commit": {"author": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-10-31T14:35:57Z"}, "committer": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-11-01T12:20:57Z"}, "message": "i386: correct integer division modeling in znver.md\n\nIn znver.md, division instructions have descriptions like\n\n(define_insn_reservation \"znver1_idiv_DI\" 41\n                        (and (eq_attr \"cpu\" \"znver1,znver2\")\n                             (and (eq_attr \"type\" \"idiv\")\n                                  (and (eq_attr \"mode\" \"DI\")\n                                       (eq_attr \"memory\" \"none\"))))\n                        \"znver1-double,znver1-ieu2*41\")\n\nwhich says that DImode idiv has latency 41 (which is correct) and that\nit occupies 2nd integer execution unit for 41 consecutive cycles, but\nthat is not correct:\n\n1) the division instruction is partially pipelined, and has throughput\n   1/14, not 1/41;\n\n2) for the most part it occupies a separate division unit, not the\n   general arithmetic unit.\n\nEvidently, interaction of such 41-cycle paths with the rest of\nreservations causes a combinatorial explosion in the automaton.\n\nFix this by modeling the integer division unit properly, and correcting\nreservations to use the measured reciprocal throughput of those\ninstructions (available from uops.info). A similar correction for\nfloating-point divisions is left for a followup patch.\n\nTop 5 znver table sizes, before:\n\n68692 r znver1_ieu_check\n68692 r znver1_ieu_transitions\n99792 r znver1_ieu_min_issue_delay\n428108 r znver1_fp_min_issue_delay\n856216 r znver1_fp_transitions\n\nAfter:\n\n1454 r znver1_ieu_translate\n1454 r znver1_translate\n2304 r znver1_ieu_transitions\n428108 r znver1_fp_min_issue_delay\n856216 r znver1_fp_transitions\n\ngcc/ChangeLog:\n\n\tPR target/87832\n\t* config/i386/znver.md (znver1_idiv): New automaton.\n\t(znver1-idiv): New unit.\n\t(znver1_idiv_DI): Correct unit and cycles in the reservation.\n\t(znver1_idiv_SI): Ditto.\n\t(znver1_idiv_HI): Ditto.\n\t(znver1_idiv_QI): Ditto.\n\t(znver1_idiv_mem_DI): Ditto.\n\t(znver1_idiv_mem_SI): Ditto.\n\t(znver1_idiv_mem_HI): Ditto.\n\t(znver1_idiv_mem_QI): Ditto.\n\t(znver3_idiv_DI): Ditto.\n\t(znver3_idiv_SI): Ditto.\n\t(znver3_idiv_HI): Ditto.\n\t(znver3_idiv_QI): Ditto.\n\t(znver3_idiv_mem_DI): Ditto.\n\t(znver3_idiv_mem_SI): Ditto.\n\t(znver3_idiv_mem_HI): Ditto.\n\t(znver3_idiv_mem_QI): Ditto.", "tree": {"sha": "628e3f4e76dc49e92652b88160826ebdc6e01bef", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/628e3f4e76dc49e92652b88160826ebdc6e01bef"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5cee5f94000ee5eabce9b223c44c7923c1c69f61", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5cee5f94000ee5eabce9b223c44c7923c1c69f61", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5cee5f94000ee5eabce9b223c44c7923c1c69f61", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5cee5f94000ee5eabce9b223c44c7923c1c69f61/comments", "author": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0122faae30fe1ad1dfa8c69f3d3f0428b996b600", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0122faae30fe1ad1dfa8c69f3d3f0428b996b600", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0122faae30fe1ad1dfa8c69f3d3f0428b996b600"}], "stats": {"total": 39, "additions": 21, "deletions": 18}, "files": [{"sha": "4aa098fd80cca2b2807aceb7983b3fb10a127d9d", "filename": "gcc/config/i386/znver.md", "status": "modified", "additions": 21, "deletions": 18, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5cee5f94000ee5eabce9b223c44c7923c1c69f61/gcc%2Fconfig%2Fi386%2Fznver.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5cee5f94000ee5eabce9b223c44c7923c1c69f61/gcc%2Fconfig%2Fi386%2Fznver.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fznver.md?ref=5cee5f94000ee5eabce9b223c44c7923c1c69f61", "patch": "@@ -23,8 +23,8 @@\n \n ;; AMD znver1, znver2 and znver3 Scheduling\n ;; Modeling automatons for zen decoders, integer execution pipes,\n-;; AGU pipes and floating point execution units.\n-(define_automaton \"znver1, znver1_ieu, znver1_fp, znver1_agu\")\n+;; SIMD/FP domain, AGU pipes, and dividers.\n+(define_automaton \"znver1, znver1_ieu, znver1_fp, znver1_agu, znver1_idiv\")\n \n ;; Decoders unit has 4 decoders and all of them can decode fast path\n ;; and vector type instructions.\n@@ -93,6 +93,9 @@\n \t\t\t\t      +znver1-fp2+znver1-fp3\n \t\t\t\t      +znver1-agu0+znver1-agu1+znver2-agu2\")\n \n+;; Dividers\n+(define_cpu_unit \"znver1-idiv\" \"znver1_idiv\")\n+\n ;; Call instruction\n (define_insn_reservation \"znver1_call\" 1\n \t\t\t (and (eq_attr \"cpu\" \"znver1\")\n@@ -176,113 +179,113 @@\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-ieu2*41\")\n+\t\t\t \"znver1-double,znver1-idiv*14\")\n \n (define_insn_reservation \"znver1_idiv_SI\" 25\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-ieu2*25\")\n+\t\t\t \"znver1-double,znver1-idiv*14\")\n \n (define_insn_reservation \"znver1_idiv_HI\" 17\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"HI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-ieu2*17\")\n+\t\t\t \"znver1-double,znver1-idiv*14\")\n \n (define_insn_reservation \"znver1_idiv_QI\" 12\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"QI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-direct,znver1-ieu2*12\")\n+\t\t\t \"znver1-direct,znver1-idiv*13\")\n \n ;; Mem operands\n (define_insn_reservation \"znver1_idiv_mem_DI\" 45\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-ieu2*41\")\n+\t\t\t \"znver1-double,znver1-load,znver1-idiv*14\")\n \n (define_insn_reservation \"znver1_idiv_mem_SI\" 29\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-ieu2*25\")\n+\t\t\t \"znver1-double,znver1-load,znver1-idiv*14\")\n \n (define_insn_reservation \"znver1_idiv_mem_HI\" 21\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"HI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-ieu2*17\")\n+\t\t\t \"znver1-double,znver1-load,znver1-idiv*14\")\n \n (define_insn_reservation \"znver1_idiv_mem_QI\" 16\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"QI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-direct,znver1-load,znver1-ieu2*12\")\n+\t\t\t \"znver1-direct,znver1-load,znver1-idiv*13\")\n \n (define_insn_reservation \"znver3_idiv_DI\" 18\n \t\t\t (and (eq_attr \"cpu\" \"znver3\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-ieu2*18\")\n+\t\t\t \"znver1-double,znver1-idiv*7\")\n \n (define_insn_reservation \"znver3_idiv_SI\" 12\n \t\t\t (and (eq_attr \"cpu\" \"znver3\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-ieu2*12\")\n+\t\t\t \"znver1-double,znver1-idiv*6\")\n \n (define_insn_reservation \"znver3_idiv_HI\" 10\n \t\t\t (and (eq_attr \"cpu\" \"znver3\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"HI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-ieu2*10\")\n+\t\t\t \"znver1-double,znver1-idiv*4\")\n \n (define_insn_reservation \"znver3_idiv_QI\" 9\n \t\t\t (and (eq_attr \"cpu\" \"znver3\")\n \t\t\t      (and (eq_attr \"type\" \"idiv\")\n \t\t\t\t   (and (eq_attr \"mode\" \"QI\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-direct,znver1-ieu2*9\")\n+\t\t\t \"znver1-direct,znver1-idiv*4\")\n \n (define_insn_reservation \"znver3_idiv_mem_DI\" 22\n                          (and (eq_attr \"cpu\" \"znver3\")\n                               (and (eq_attr \"type\" \"idiv\")\n                                    (and (eq_attr \"mode\" \"DI\")\n                                         (eq_attr \"memory\" \"load\"))))\n-                         \"znver1-double,znver1-load,znver1-ieu2*22\")\n+                         \"znver1-double,znver1-load,znver1-idiv*7\")\n \n (define_insn_reservation \"znver3_idiv_mem_SI\" 16\n                          (and (eq_attr \"cpu\" \"znver3\")\n                               (and (eq_attr \"type\" \"idiv\")\n                                    (and (eq_attr \"mode\" \"SI\")\n                                         (eq_attr \"memory\" \"load\"))))\n-                         \"znver1-double,znver1-load,znver1-ieu2*16\")\n+                         \"znver1-double,znver1-load,znver1-idiv*6\")\n \n (define_insn_reservation \"znver3_idiv_mem_HI\" 14\n                          (and (eq_attr \"cpu\" \"znver3\")\n                               (and (eq_attr \"type\" \"idiv\")\n                                    (and (eq_attr \"mode\" \"HI\")\n                                         (eq_attr \"memory\" \"load\"))))\n-                         \"znver1-double,znver1-load,znver1-ieu2*10\")\n+                         \"znver1-double,znver1-load,znver1-idiv*4\")\n \n (define_insn_reservation \"znver3_idiv_mem_QI\" 13\n                          (and (eq_attr \"cpu\" \"znver3\")\n                               (and (eq_attr \"type\" \"idiv\")\n                                    (and (eq_attr \"mode\" \"QI\")\n                                         (eq_attr \"memory\" \"load\"))))\n-                         \"znver1-direct,znver1-load,znver1-ieu2*9\")\n+                         \"znver1-direct,znver1-load,znver1-idiv*4\")\n \n ;; STR ISHIFT which are micro coded.\n ;; Fix me: Latency need to be rechecked."}]}