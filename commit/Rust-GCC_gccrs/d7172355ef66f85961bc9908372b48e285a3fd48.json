{"sha": "d7172355ef66f85961bc9908372b48e285a3fd48", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDcxNzIzNTVlZjY2Zjg1OTYxYmM5OTA4MzcyYjQ4ZTI4NWEzZmQ0OA==", "commit": {"author": {"name": "Uros Bizjak", "email": "uros@gcc.gnu.org", "date": "2013-07-23T09:45:30Z"}, "committer": {"name": "Uros Bizjak", "email": "uros@gcc.gnu.org", "date": "2013-07-23T09:45:30Z"}, "message": "fpu-387.h (get_fpu_rounding_mode): Read rounding mode from SSE mxcsr register on x86_64.\n\n\t* config/fpu-387.h (get_fpu_rounding_mode): Read rounding mode\n\tfrom SSE mxcsr register on x86_64.\n\nFrom-SVN: r201161", "tree": {"sha": "66075d6c03d929790aa9ef04762111706d295821", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/66075d6c03d929790aa9ef04762111706d295821"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d7172355ef66f85961bc9908372b48e285a3fd48", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d7172355ef66f85961bc9908372b48e285a3fd48", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d7172355ef66f85961bc9908372b48e285a3fd48", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d7172355ef66f85961bc9908372b48e285a3fd48/comments", "author": null, "committer": null, "parents": [{"sha": "3c68decc48adbff9d077d8e506baa5fb5df76c4e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3c68decc48adbff9d077d8e506baa5fb5df76c4e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3c68decc48adbff9d077d8e506baa5fb5df76c4e"}], "stats": {"total": 44, "additions": 32, "deletions": 12}, "files": [{"sha": "940d41444a5b1ff656bf958b78ebf924d49ae4f9", "filename": "libgfortran/ChangeLog", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d7172355ef66f85961bc9908372b48e285a3fd48/libgfortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d7172355ef66f85961bc9908372b48e285a3fd48/libgfortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2FChangeLog?ref=d7172355ef66f85961bc9908372b48e285a3fd48", "patch": "@@ -1,4 +1,9 @@\n-2013-07-21   Ond\u0159ej B\u00edlka  <neleai@seznam.cz>\n+2013-07-23  Uros Bizjak  <ubizjak@gmail.com>\n+\n+\t* config/fpu-387.h (get_fpu_rounding_mode): Read rounding mode\n+\tfrom SSE mxcsr register on x86_64.\n+\n+2013-07-21  Ond\u0159ej B\u00edlka  <neleai@seznam.cz>\n \n \t* io/transfer.c: Fix comment typos.\n "}, {"sha": "b35c315445cf12d0c5104596d64e507e7d9b9c8b", "filename": "libgfortran/config/fpu-387.h", "status": "modified", "additions": 26, "deletions": 11, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d7172355ef66f85961bc9908372b48e285a3fd48/libgfortran%2Fconfig%2Ffpu-387.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d7172355ef66f85961bc9908372b48e285a3fd48/libgfortran%2Fconfig%2Ffpu-387.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fconfig%2Ffpu-387.h?ref=d7172355ef66f85961bc9908372b48e285a3fd48", "patch": "@@ -102,11 +102,11 @@ has_sse (void)\n /* i387 rounding modes.  */\n \n #define _FPU_RC_NEAREST 0x0\n-#define _FPU_RC_DOWN    0x400\n-#define _FPU_RC_UP      0x800\n-#define _FPU_RC_ZERO    0xc00\n+#define _FPU_RC_DOWN    0x1\n+#define _FPU_RC_UP      0x2\n+#define _FPU_RC_ZERO    0x3\n \n-#define _FPU_RC_MASK    0xc00\n+#define _FPU_RC_MASK    0x3\n \n \n void\n@@ -202,8 +202,9 @@ set_fpu_rounding_mode (int round)\n \n   __asm__ __volatile__ (\"fnstcw\\t%0\" : \"=m\" (cw));\n \n-  cw &= ~_FPU_RC_MASK;\n-  cw |= round_mode;\n+  /* The x87 round control bits are shifted by 10 bits.  */\n+  cw &= ~(_FPU_RC_MASK << 10);\n+  cw |= round_mode << 10;\n \n   __asm__ __volatile__ (\"fldcw\\t%0\" : : \"m\" (cw));\n \n@@ -213,9 +214,9 @@ set_fpu_rounding_mode (int round)\n \n       __asm__ __volatile__ (\"%vstmxcsr\\t%0\" : \"=m\" (cw_sse));\n \n-      /* The SSE round control bits are shifted by 3 bits.  */\n-      cw_sse &= ~(_FPU_RC_MASK << 3);\n-      cw_sse |= round_mode << 3;\n+      /* The SSE round control bits are shifted by 13 bits.  */\n+      cw_sse &= ~(_FPU_RC_MASK << 13);\n+      cw_sse |= round_mode << 13;\n \n       __asm__ __volatile__ (\"%vldmxcsr\\t%0\" : : \"m\" (cw_sse));\n     }\n@@ -224,13 +225,27 @@ set_fpu_rounding_mode (int round)\n int\n get_fpu_rounding_mode (void)\n {\n+  int round_mode;\n+\n+#ifdef __x86_64__\n+  unsigned int cw;\n+\n+  __asm__ __volatile__ (\"%vstmxcsr\\t%0\" : \"=m\" (cw));\n+\n+  /* The SSE round control bits are shifted by 13 bits.  */\n+  round_mode = cw >> 13;\n+#else\n   unsigned short cw;\n \n   __asm__ __volatile__ (\"fnstcw\\t%0\" : \"=m\" (cw));\n \n-  cw &= _FPU_RC_MASK;\n+  /* The x87 round control bits are shifted by 10 bits.  */\n+  round_mode = cw >> 10;\n+#endif\n+\n+  round_mode &= _FPU_RC_MASK;\n \n-  switch (cw)\n+  switch (round_mode)\n     {\n     case _FPU_RC_NEAREST:\n       return GFC_FPE_TONEAREST;"}]}