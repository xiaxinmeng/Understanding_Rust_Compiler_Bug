{"sha": "855bb43f6d0bee5a74b5d3739456ca34b4609a50", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODU1YmI0M2Y2ZDBiZWU1YTc0YjVkMzczOTQ1NmNhMzRiNDYwOWE1MA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-12-01T15:25:06Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-12-01T15:25:06Z"}, "message": "Improve double-word mod even on powerpc [PR97459]\n\nI have noticed that while my (already committed, thanks for review)\npatch works on x86, it doesn't work on powerpc*.  The problem is that\nwe don't have lshr double-word optab (neither TImode nor for -m32 DImode),\nbut as expander has code for double-word shift, that doesn't really matter.\nAs the implementation is prepared to punt whenever something can't be\nexpanded with OPTAB_DIRECT and in the end also punts if any library calls\nwould be emitted, the optab_handler checks were just to save compile time.\n\nOn the other side, for even divisors, we know that (1 << bit) % (2 * x)\nfor bit > 0 will never be equal to 1, because both dividend and divisor\nare even and so remainder will be even too, so we can save some compile time\nby adding an early exit.\n\nThe even divisors can be handled with the approach Thomas wrote about\n(perhaps generalized into divisors equal to what expand_doubleword_mod\ncan handle times some power of two where we can handle power of two modulo\ncheaply), but that would be done in a different function...\nAnd we could use ctz to find the power of two...\n\n2020-12-01  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR rtl-optimization/97459\n\t* optabs.c (expand_doubleword_mod): Punt early for even op1.\n\t(expand_binop): Don't require lshr_optab double-word handler.", "tree": {"sha": "8839e8e947d1c3ff16361bafe25a84050e414c53", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8839e8e947d1c3ff16361bafe25a84050e414c53"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/855bb43f6d0bee5a74b5d3739456ca34b4609a50", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/855bb43f6d0bee5a74b5d3739456ca34b4609a50", "html_url": "https://github.com/Rust-GCC/gccrs/commit/855bb43f6d0bee5a74b5d3739456ca34b4609a50", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/855bb43f6d0bee5a74b5d3739456ca34b4609a50/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "404d0ca7820bbf258e2edfac423403ee31b48a7b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/404d0ca7820bbf258e2edfac423403ee31b48a7b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/404d0ca7820bbf258e2edfac423403ee31b48a7b"}], "stats": {"total": 3, "additions": 1, "deletions": 2}, "files": [{"sha": "3b116d39fb750540f6ef588c8c5d6f5a40b830c9", "filename": "gcc/optabs.c", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/855bb43f6d0bee5a74b5d3739456ca34b4609a50/gcc%2Foptabs.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/855bb43f6d0bee5a74b5d3739456ca34b4609a50/gcc%2Foptabs.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Foptabs.c?ref=855bb43f6d0bee5a74b5d3739456ca34b4609a50", "patch": "@@ -949,7 +949,7 @@ expand_doubleword_mult (machine_mode mode, rtx op0, rtx op1, rtx target,\n static rtx\n expand_doubleword_mod (machine_mode mode, rtx op0, rtx op1, bool unsignedp)\n {\n-  if (INTVAL (op1) <= 1)\n+  if (INTVAL (op1) <= 1 || (INTVAL (op1) & 1) == 0)\n     return NULL_RTX;\n \n   rtx_insn *last = get_last_insn ();\n@@ -2004,7 +2004,6 @@ expand_binop (machine_mode mode, optab binoptab, rtx op0, rtx op1,\n       && CONST_INT_P (op1)\n       && is_int_mode (mode, &int_mode)\n       && GET_MODE_SIZE (int_mode) == 2 * UNITS_PER_WORD\n-      && optab_handler (lshr_optab, int_mode) != CODE_FOR_nothing\n       && optab_handler (and_optab, word_mode) != CODE_FOR_nothing\n       && optab_handler (add_optab, word_mode) != CODE_FOR_nothing\n       && optimize_insn_for_speed_p ())"}]}