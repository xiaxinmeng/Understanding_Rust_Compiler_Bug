{"sha": "ea4e32181d7a36055b57421abd0ced4735654cf6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZWE0ZTMyMTgxZDdhMzYwNTViNTc0MjFhYmQwY2VkNDczNTY1NGNmNg==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2021-06-22T17:44:57Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2021-06-22T17:44:57Z"}, "message": "analyzer: fix ICE on malloc/alloca param type mismatch [PR101143]\n\ngcc/analyzer/ChangeLog:\n\tPR analyzer/101143\n\t* region-model.cc (compat_types_p): New function.\n\t(region_model::create_region_for_heap_alloc): Convert assertion to\n\tan error check.\n\t(region_model::create_region_for_alloca): Likewise.\n\ngcc/testsuite/ChangeLog:\n\tPR analyzer/101143\n\t* gcc.dg/analyzer/pr101143.c: New test.\n\nSigned-off-by: David Malcolm <dmalcolm@redhat.com>", "tree": {"sha": "e663c5ac66e3598c449de2a86a263115313f1101", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e663c5ac66e3598c449de2a86a263115313f1101"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ea4e32181d7a36055b57421abd0ced4735654cf6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ea4e32181d7a36055b57421abd0ced4735654cf6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ea4e32181d7a36055b57421abd0ced4735654cf6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ea4e32181d7a36055b57421abd0ced4735654cf6/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "83bd60452df732a048de601c45e292a9ccec3514", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/83bd60452df732a048de601c45e292a9ccec3514", "html_url": "https://github.com/Rust-GCC/gccrs/commit/83bd60452df732a048de601c45e292a9ccec3514"}], "stats": {"total": 37, "additions": 33, "deletions": 4}, "files": [{"sha": "ee11e82bdf2acaf21f5dc31ad2c13d05cafae5cf", "filename": "gcc/analyzer/region-model.cc", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea4e32181d7a36055b57421abd0ced4735654cf6/gcc%2Fanalyzer%2Fregion-model.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea4e32181d7a36055b57421abd0ced4735654cf6/gcc%2Fanalyzer%2Fregion-model.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fanalyzer%2Fregion-model.cc?ref=ea4e32181d7a36055b57421abd0ced4735654cf6", "patch": "@@ -1443,6 +1443,17 @@ assert_compat_types (tree src_type, tree dst_type)\n     }\n }\n \n+/* Return true if SRC_TYPE can be converted to DST_TYPE as a no-op.  */\n+\n+static bool\n+compat_types_p (tree src_type, tree dst_type)\n+{\n+  if (src_type && dst_type && !VOID_TYPE_P (dst_type))\n+    if (!(useless_type_conversion_p (src_type, dst_type)))\n+      return false;\n+  return true;\n+}\n+\n /* Get the region for PV within this region_model,\n    emitting any diagnostics to CTXT.  */\n \n@@ -3402,8 +3413,8 @@ const region *\n region_model::create_region_for_heap_alloc (const svalue *size_in_bytes)\n {\n   const region *reg = m_mgr->create_region_for_heap_alloc ();\n-  assert_compat_types (size_in_bytes->get_type (), size_type_node);\n-  set_dynamic_extents (reg, size_in_bytes);\n+  if (compat_types_p (size_in_bytes->get_type (), size_type_node))\n+    set_dynamic_extents (reg, size_in_bytes);\n   return reg;\n }\n \n@@ -3414,8 +3425,8 @@ const region *\n region_model::create_region_for_alloca (const svalue *size_in_bytes)\n {\n   const region *reg = m_mgr->create_region_for_alloca (m_current_frame);\n-  assert_compat_types (size_in_bytes->get_type (), size_type_node);\n-  set_dynamic_extents (reg, size_in_bytes);\n+  if (compat_types_p (size_in_bytes->get_type (), size_type_node))\n+    set_dynamic_extents (reg, size_in_bytes);\n   return reg;\n }\n "}, {"sha": "bcc0974d4e3aad1e24ab4628cade924587db762e", "filename": "gcc/testsuite/gcc.dg/analyzer/pr101143.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ea4e32181d7a36055b57421abd0ced4735654cf6/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fpr101143.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ea4e32181d7a36055b57421abd0ced4735654cf6/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fpr101143.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fpr101143.c?ref=ea4e32181d7a36055b57421abd0ced4735654cf6", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-additional-options \"-Wno-builtin-declaration-mismatch\" } */\n+\n+extern void *malloc (unsigned int);\n+extern void *alloca (unsigned int);\n+extern void unknown_fn (void *);\n+\n+void *\n+test_malloc (void)\n+{\n+  return malloc (sizeof (int));\n+}\n+\n+void *\n+test_alloca (void)\n+{\n+  void *p = alloca (sizeof (int));\n+  unknown_fn (p);\n+}"}]}