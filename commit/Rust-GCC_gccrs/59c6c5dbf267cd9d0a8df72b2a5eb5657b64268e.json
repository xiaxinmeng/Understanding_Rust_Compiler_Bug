{"sha": "59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e", "node_id": "C_kwDOANBUbNoAKDU5YzZjNWRiZjI2N2NkOWQwYThkZjcyYjJhNWViNTY1N2I2NDI2OGU", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2022-10-14T15:36:51Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2022-11-02T19:51:40Z"}, "message": "Add 'libgomp.oacc-fortran/declare-allocatable-1-runtime.f90'\n\n... which is 'libgomp.oacc-fortran/declare-allocatable-1.f90' adjusted\nfor missing support for OpenACC \"Changes from Version 2.0 to 2.5\":\n\"The 'declare create' directive with a Fortran 'allocatable' has new behavior\".\nThus, after 'allocate'/before 'deallocate', call 'acc_create'/'acc_delete'\nmanually.\n\n\tlibgomp/\n\t* testsuite/libgomp.oacc-fortran/declare-allocatable-1-runtime.f90:\n\tNew.", "tree": {"sha": "4fe77440485f7b7bfc77078f0778290069f3e097", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4fe77440485f7b7bfc77078f0778290069f3e097"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8c357d884b16cb3c14cba8a61be5b53fd04a6bfe", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8c357d884b16cb3c14cba8a61be5b53fd04a6bfe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8c357d884b16cb3c14cba8a61be5b53fd04a6bfe"}], "stats": {"total": 278, "additions": 278, "deletions": 0}, "files": [{"sha": "e4cb9c378a34b29d5d19dd8a80cc52dab48a02c9", "filename": "libgomp/testsuite/libgomp.oacc-fortran/declare-allocatable-1-runtime.f90", "status": "added", "additions": 278, "deletions": 0, "changes": 278, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fdeclare-allocatable-1-runtime.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fdeclare-allocatable-1-runtime.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fdeclare-allocatable-1-runtime.f90?ref=59c6c5dbf267cd9d0a8df72b2a5eb5657b64268e", "patch": "@@ -0,0 +1,278 @@\n+! Test OpenACC 'declare create' with allocatable arrays.\n+\n+! { dg-do run }\n+\n+!TODO-OpenACC-declare-allocate\n+! Missing support for OpenACC \"Changes from Version 2.0 to 2.5\":\n+! \"The 'declare create' directive with a Fortran 'allocatable' has new behavior\".\n+! Thus, after 'allocate'/before 'deallocate', call 'acc_create'/'acc_delete'\n+! manually.\n+\n+!TODO { dg-additional-options -fno-inline } for stable results regarding OpenACC 'routine'.\n+\n+! { dg-additional-options -fopt-info-all-omp }\n+! { dg-additional-options -foffload=-fopt-info-all-omp }\n+\n+! { dg-additional-options --param=openacc-privatization=noisy }\n+! { dg-additional-options -foffload=--param=openacc-privatization=noisy }\n+! Prune a few: uninteresting, and potentially varying depending on GCC configuration (data types):\n+! { dg-prune-output {note: variable '[Di]\\.[0-9]+' declared in block isn't candidate for adjusting OpenACC privatization level: not addressable} }\n+\n+! { dg-additional-options -Wopenacc-parallelism }\n+\n+! It's only with Tcl 8.5 (released in 2007) that \"the variable 'varName'\n+! passed to 'incr' may be unset, and in that case, it will be set to [...]\",\n+! so to maintain compatibility with earlier Tcl releases, we manually\n+! initialize counter variables:\n+! { dg-line l_dummy[variable c 0] }\n+! { dg-message dummy {} { target iN-VAl-Id } l_dummy } to avoid\n+! \"WARNING: dg-line var l_dummy defined, but not used\".\n+\n+\n+module vars\n+  implicit none\n+  integer, parameter :: n = 100\n+  real*8, allocatable :: b(:)\n+ !$acc declare create (b)\n+end module vars\n+\n+program test\n+  use vars\n+  use openacc\n+  implicit none\n+  real*8 :: a\n+  integer :: i\n+\n+  interface\n+     subroutine sub1\n+       !$acc routine gang\n+     end subroutine sub1\n+\n+     subroutine sub2\n+     end subroutine sub2\n+\n+     real*8 function fun1 (ix)\n+       integer ix\n+       !$acc routine seq\n+     end function fun1\n+\n+     real*8 function fun2 (ix)\n+       integer ix\n+       !$acc routine seq\n+     end function fun2\n+  end interface\n+\n+  if (allocated (b)) error stop\n+\n+  ! Test local usage of an allocated declared array.\n+\n+  allocate (b(n))\n+  call acc_create (b)\n+\n+  if (.not.allocated (b)) error stop\n+  if (.not.acc_is_present (b)) error stop\n+\n+  a = 2.0\n+\n+  !$acc parallel loop ! { dg-line l[incr c] }\n+  ! { dg-note {variable 'i' in 'private' clause is candidate for adjusting OpenACC privatization level} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' ought to be adjusted for OpenACC privatization level: 'vector'} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' adjusted for OpenACC privatization level: 'vector'} {} { target { ! openacc_host_selected } } l$c }\n+  ! { dg-note {variable 'i\\.[0-9]+' in 'private' clause isn't candidate for adjusting OpenACC privatization level: not addressable} {} { target *-*-* } l$c }\n+  ! { dg-optimized {assigned OpenACC gang vector loop parallelism} {} { target *-*-* } l$c }\n+  do i = 1, n\n+     b(i) = i * a\n+  end do\n+\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc update host(b)\n+\n+  do i = 1, n\n+     if (b(i) /= i*a) error stop\n+  end do\n+\n+  call acc_delete (b)\n+  deallocate (b)\n+\n+  ! Test the usage of an allocated declared array inside an acc\n+  ! routine subroutine.\n+\n+  allocate (b(n))\n+  call acc_create (b)\n+\n+  if (.not.allocated (b)) error stop\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc parallel\n+  call sub1 ! { dg-line l[incr c] }\n+  ! { dg-optimized {assigned OpenACC gang worker vector loop parallelism} {} { target *-*-* } l$c }\n+  !$acc end parallel\n+\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc update host(b)\n+\n+  do i = 1, n\n+     if (b(i) /= i*2) error stop\n+  end do\n+\n+  call acc_delete (b)\n+  deallocate (b)\n+\n+  ! Test the usage of an allocated declared array inside a host\n+  ! subroutine.\n+\n+  call sub2\n+\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc update host(b)\n+\n+  do i = 1, n\n+     if (b(i) /= 1.0) error stop\n+  end do\n+\n+  call acc_delete (b)\n+  deallocate (b)\n+\n+  if (allocated (b)) error stop\n+\n+  ! Test the usage of an allocated declared array inside an acc\n+  ! routine function.\n+\n+  allocate (b(n))\n+  call acc_create (b)\n+\n+  if (.not.allocated (b)) error stop\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc parallel loop ! { dg-line l[incr c] }\n+  ! { dg-note {variable 'i' in 'private' clause is candidate for adjusting OpenACC privatization level} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' ought to be adjusted for OpenACC privatization level: 'vector'} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' adjusted for OpenACC privatization level: 'vector'} {} { target { ! openacc_host_selected } } l$c }\n+  ! { dg-note {variable 'i\\.[0-9]+' in 'private' clause isn't candidate for adjusting OpenACC privatization level: not addressable} {} { target *-*-* } l$c }\n+  ! { dg-optimized {assigned OpenACC gang vector loop parallelism} {} { target *-*-* } l$c }\n+  do i = 1, n\n+     b(i) = 1.0\n+  end do\n+\n+  !$acc parallel loop ! { dg-line l[incr c] }\n+  ! { dg-note {variable 'i' in 'private' clause is candidate for adjusting OpenACC privatization level} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' ought to be adjusted for OpenACC privatization level: 'vector'} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' adjusted for OpenACC privatization level: 'vector'} {} { target { ! openacc_host_selected } } l$c }\n+  ! { dg-note {variable 'i\\.[0-9]+' in 'private' clause isn't candidate for adjusting OpenACC privatization level: not addressable} {} { target *-*-* } l$c }\n+  ! { dg-optimized {assigned OpenACC gang vector loop parallelism} {} { target *-*-* } l$c }\n+  do i = 1, n\n+     b(i) = fun1 (i) ! { dg-line l[incr c] }\n+     ! { dg-optimized {assigned OpenACC seq loop parallelism} {} { target *-*-* } l$c }\n+  end do\n+\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc update host(b)\n+\n+  do i = 1, n\n+     if (b(i) /= i) error stop\n+  end do\n+\n+  call acc_delete (b)\n+  deallocate (b)\n+\n+  ! Test the usage of an allocated declared array inside a host\n+  ! function.\n+\n+  allocate (b(n))\n+  call acc_create (b)\n+\n+  if (.not.allocated (b)) error stop\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc parallel loop ! { dg-line l[incr c] }\n+  ! { dg-note {variable 'i' in 'private' clause is candidate for adjusting OpenACC privatization level} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' ought to be adjusted for OpenACC privatization level: 'vector'} {} { target *-*-* } l$c }\n+  !   { dg-note {variable 'i' adjusted for OpenACC privatization level: 'vector'} {} { target { ! openacc_host_selected } } l$c }\n+  ! { dg-note {variable 'i\\.[0-9]+' in 'private' clause isn't candidate for adjusting OpenACC privatization level: not addressable} {} { target *-*-* } l$c }\n+  ! { dg-optimized {assigned OpenACC gang vector loop parallelism} {} { target *-*-* } l$c }\n+  do i = 1, n\n+     b(i) = 1.0\n+  end do\n+\n+  !$acc update host(b)\n+\n+  do i = 1, n\n+     b(i) = fun2 (i)\n+  end do\n+\n+  if (.not.acc_is_present (b)) error stop\n+\n+  do i = 1, n\n+     if (b(i) /= i*i) error stop\n+  end do\n+\n+  call acc_delete (b)\n+  deallocate (b)\n+end program test ! { dg-line l[incr c] }\n+! { dg-bogus {note: variable 'overflow\\.[0-9]+' declared in block isn't candidate for adjusting OpenACC privatization level: not addressable} {TODO n/a} { xfail *-*-* } l$c }\n+! { dg-bogus {note: variable 'not_prev_allocated\\.[0-9]+' declared in block isn't candidate for adjusting OpenACC privatization level: not addressable} {TODO n/a} { xfail *-*-* } l$c }\n+! { dg-bogus {note: variable 'parm\\.[0-9]+' declared in block isn't candidate for adjusting OpenACC privatization level: artificial} {TODO n/a} { xfail *-*-* } l$c }\n+\n+! Set each element in array 'b' at index i to i*2.\n+\n+subroutine sub1 ! { dg-line subroutine_sub1 }\n+  use vars\n+  implicit none\n+  integer i\n+  !$acc routine gang\n+  ! { dg-bogus {[Ww]arning: region is worker partitioned but does not contain worker partitioned code} {TODO default 'gang' 'vector'} { xfail *-*-* } subroutine_sub1 }\n+\n+  !$acc loop ! { dg-line l[incr c] }\n+  ! { dg-note {variable 'i' in 'private' clause isn't candidate for adjusting OpenACC privatization level: not addressable} {} { target *-*-* } l$c }\n+  ! { dg-optimized {assigned OpenACC gang vector loop parallelism} {} { target *-*-* } l$c }\n+  do i = 1, n\n+     b(i) = i*2\n+  end do\n+end subroutine sub1\n+\n+! Allocate array 'b', and set it to all 1.0.\n+\n+subroutine sub2\n+  use vars\n+  use openacc\n+  implicit none\n+  integer i\n+\n+  allocate (b(n))\n+  call acc_create (b)\n+\n+  if (.not.allocated (b)) error stop\n+  if (.not.acc_is_present (b)) error stop\n+\n+  !$acc parallel loop ! { dg-line l[incr c] }\n+  ! { dg-note {variable 'i' in 'private' clause isn't candidate for adjusting OpenACC privatization level: not addressable} {} { target *-*-* } l$c }\n+  ! { dg-optimized {assigned OpenACC gang vector loop parallelism} {} { target *-*-* } l$c }\n+  do i = 1, n\n+     b(i) = 1.0\n+  end do\n+end subroutine sub2\n+\n+! Return b(i) * i;\n+\n+real*8 function fun1 (i)\n+  use vars\n+  implicit none\n+  integer i\n+  !$acc routine seq\n+\n+  fun1 = b(i) * i\n+end function fun1\n+\n+! Return b(i) * i * i;\n+\n+real*8 function fun2 (i)\n+  use vars\n+  implicit none\n+  integer i\n+\n+  fun2 = b(i) * i * i\n+end function fun2"}]}