{"sha": "9ce1688bb8b00bafc041e375b453d9f957cc1424", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWNlMTY4OGJiOGIwMGJhZmMwNDFlMzc1YjQ1M2Q5Zjk1N2NjMTQyNA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2015-09-10T07:35:56Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2015-09-10T07:35:56Z"}, "message": "re PR c++/67523 (ICE with invalid combined simd inside of a template)\n\n\tPR c++/67523\n\t* gimplify.c (gimplify_omp_for): If inner stmt is not found\n\tfor combined loop, assert seen_error () and return GS_ERROR.\n\n\t* g++.dg/gomp/pr67523.C: New test.\n\nFrom-SVN: r227611", "tree": {"sha": "f51d0f7d9eee3b4530c7e4ea6af775f87749c576", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f51d0f7d9eee3b4530c7e4ea6af775f87749c576"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9ce1688bb8b00bafc041e375b453d9f957cc1424", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9ce1688bb8b00bafc041e375b453d9f957cc1424", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9ce1688bb8b00bafc041e375b453d9f957cc1424", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9ce1688bb8b00bafc041e375b453d9f957cc1424/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7da8534d1e1ec7b1470ea556b1444c5173799348", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7da8534d1e1ec7b1470ea556b1444c5173799348", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7da8534d1e1ec7b1470ea556b1444c5173799348"}], "stats": {"total": 56, "additions": 51, "deletions": 5}, "files": [{"sha": "fb9bbb787dc351194726ca15c66add50591112e6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=9ce1688bb8b00bafc041e375b453d9f957cc1424", "patch": "@@ -1,5 +1,9 @@\n 2015-09-10  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/67523\n+\t* gimplify.c (gimplify_omp_for): If inner stmt is not found\n+\tfor combined loop, assert seen_error () and return GS_ERROR.\n+\n \tPR middle-end/67521\n \t* gimplify.c (gimplify_omp_for): Don't call omp_add_variable\n \tif decl is already in outer->variables."}, {"sha": "10f84d47ec26ebaec7c8a8a8cea58d82cfe6f9c8", "filename": "gcc/gimplify.c", "status": "modified", "additions": 15, "deletions": 5, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=9ce1688bb8b00bafc041e375b453d9f957cc1424", "patch": "@@ -7001,7 +7001,7 @@ find_combined_omp_for (tree *tp, int *walk_subtrees, void *)\n static enum gimplify_status\n gimplify_omp_for (tree *expr_p, gimple_seq *pre_p)\n {\n-  tree for_stmt, orig_for_stmt, decl, var, t;\n+  tree for_stmt, orig_for_stmt, inner_for_stmt = NULL_TREE, decl, var, t;\n   enum gimplify_status ret = GS_ALL_DONE;\n   enum gimplify_status tret;\n   gomp_for *gfor;\n@@ -7044,6 +7044,19 @@ gimplify_omp_for (tree *expr_p, gimple_seq *pre_p)\n \t  }\n     }\n \n+  if (OMP_FOR_INIT (for_stmt) == NULL_TREE)\n+    {\n+      gcc_assert (TREE_CODE (for_stmt) != OACC_LOOP);\n+      inner_for_stmt = walk_tree (&OMP_FOR_BODY (for_stmt),\n+\t\t\t\t  find_combined_omp_for, NULL, NULL);\n+      if (inner_for_stmt == NULL_TREE)\n+\t{\n+\t  gcc_assert (seen_error ());\n+\t  *expr_p = NULL_TREE;\n+\t  return GS_ERROR;\n+\t}\n+    }\n+\n   gimplify_scan_omp_clauses (&OMP_FOR_CLAUSES (for_stmt), pre_p,\n \t\t\t     simd ? ORT_SIMD : ORT_WORKSHARE);\n   if (TREE_CODE (for_stmt) == OMP_DISTRIBUTE)\n@@ -7079,10 +7092,7 @@ gimplify_omp_for (tree *expr_p, gimple_seq *pre_p)\n \n   if (OMP_FOR_INIT (for_stmt) == NULL_TREE)\n     {\n-      gcc_assert (TREE_CODE (for_stmt) != OACC_LOOP);\n-      for_stmt = walk_tree (&OMP_FOR_BODY (for_stmt), find_combined_omp_for,\n-\t\t\t    NULL, NULL);\n-      gcc_assert (for_stmt != NULL_TREE);\n+      for_stmt = inner_for_stmt;\n       gimplify_omp_ctxp->combined_loop = true;\n     }\n "}, {"sha": "8a06e5169d96f274327250e8450caed8d7dd2dd2", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=9ce1688bb8b00bafc041e375b453d9f957cc1424", "patch": "@@ -1,5 +1,8 @@\n 2015-09-10  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/67523\n+\t* g++.dg/gomp/pr67523.C: New test.\n+\n \tPR c++/67522\n \t* g++.dg/gomp/pr67522.C: New test.\n "}, {"sha": "fb12c8c4695d6d46fbb085247f0de7b2b896be7f", "filename": "gcc/testsuite/g++.dg/gomp/pr67523.C", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr67523.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9ce1688bb8b00bafc041e375b453d9f957cc1424/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr67523.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr67523.C?ref=9ce1688bb8b00bafc041e375b453d9f957cc1424", "patch": "@@ -0,0 +1,29 @@\n+// PR c++/67523\n+// { dg-do compile }\n+// { dg-options \"-fopenmp\" }\n+\n+struct S { int s; };\n+\n+template <typename T>\n+void foo (T &x, T &y)\n+{\n+#pragma omp for simd\n+  for (T i = x; i < y; i++)\t// { dg-error \"used with class iteration variable\" }\n+    ;\n+#pragma omp parallel for simd\n+  for (T i = x; i < y; i++)\t// { dg-error \"used with class iteration variable\" }\n+    ;\n+#pragma omp target teams distribute parallel for simd\n+  for (T i = x; i < y; i++)\t// { dg-error \"used with class iteration variable\" }\n+    ;\n+#pragma omp target teams distribute simd\n+  for (T i = x; i < y; i++)\t// { dg-error \"used with class iteration variable\" }\n+    ;\n+}\n+\n+void\n+bar ()\n+{\n+  S x, y;\n+  foo <S> (x, y);\n+}"}]}