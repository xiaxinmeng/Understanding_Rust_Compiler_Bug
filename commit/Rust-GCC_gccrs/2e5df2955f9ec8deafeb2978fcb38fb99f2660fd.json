{"sha": "2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmU1ZGYyOTU1ZjllYzhkZWFmZWIyOTc4ZmNiMzhmYjk5ZjI2NjBmZA==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2018-08-21T14:46:34Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-08-21T14:46:34Z"}, "message": "[Ada] Spurious \"Duplicated symbol\" error with discriminated tasks\n\nThis patch fixes a spurious error in a program that contains a\ndiscriminated task type and several of its subtype in the same\ndeclarative part, when the corresponding discriminant constraints are\nexpressions.\n\n2018-08-21  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_util.ads, sem_util.adb (New_External_Entity): Type of\n\tSuffix_Index must be Int, not Nat, so that a negative value can\n\tbe used to generate a unique name for an external object, as\n\tspecified in Tbuild.New_External_Name.\n\t(Scope_Within): Handle private type whose completion is a\n\tsynchronized type (For unnesting).\n\t* itypes.ads, itypes.adb (Create_Itype): Ditto\n\t* sem_ch3.adb (Constrain_Corresponding_Record): Generate a\n\tunique name for the created subtype, because there may be\n\tseveral discriminated tasks present in the same scope, and each\n\tneeds its distinct corresponding record subtype.\n\ngcc/testsuite/\n\n\t* gnat.dg/task1.adb, gnat.dg/task1.ads, gnat.dg/task1_pkg.adb,\n\tgnat.dg/task1_pkg.ads: New testcase.\n\nFrom-SVN: r263716", "tree": {"sha": "cbf64f4e30b3edf5001151630d175f1f3adafefb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cbf64f4e30b3edf5001151630d175f1f3adafefb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c4b9b2916ceb22b57d72fee8f775e02a8851d086", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4b9b2916ceb22b57d72fee8f775e02a8851d086", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c4b9b2916ceb22b57d72fee8f775e02a8851d086"}], "stats": {"total": 76, "additions": 71, "deletions": 5}, "files": [{"sha": "df4a9dbdf9c39c1359c90a94e71445617cd59225", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -1,3 +1,17 @@\n+2018-08-21  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_util.ads, sem_util.adb (New_External_Entity): Type of\n+\tSuffix_Index must be Int, not Nat, so that a negative value can\n+\tbe used to generate a unique name for an external object, as\n+\tspecified in Tbuild.New_External_Name.\n+\t(Scope_Within): Handle private type whose completion is a\n+\tsynchronized type (For unnesting).\n+\t* itypes.ads, itypes.adb (Create_Itype): Ditto\n+\t* sem_ch3.adb (Constrain_Corresponding_Record): Generate a\n+\tunique name for the created subtype, because there may be\n+\tseveral discriminated tasks present in the same scope, and each\n+\tneeds its distinct corresponding record subtype.\n+\n 2018-08-21  Yannick Moy  <moy@adacore.com>\n \n \t* doc/gnat_ugn/gnat_and_program_execution.rst: Update"}, {"sha": "6640c57bac1935207e2ee1edc4b3404ace088485", "filename": "gcc/ada/itypes.adb", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fitypes.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fitypes.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fitypes.adb?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -42,7 +42,7 @@ package body Itypes is\n       Related_Nod  : Node_Id;\n       Related_Id   : Entity_Id := Empty;\n       Suffix       : Character := ' ';\n-      Suffix_Index : Nat       := 0;\n+      Suffix_Index : Int       := 0;\n       Scope_Id     : Entity_Id := Current_Scope) return Entity_Id\n    is\n       Typ : Entity_Id;"}, {"sha": "1513c8afff797ffc61d5df34ba4aa76e80c83403", "filename": "gcc/ada/itypes.ads", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fitypes.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fitypes.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fitypes.ads?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -110,7 +110,7 @@ package Itypes is\n       Related_Nod  : Node_Id;\n       Related_Id   : Entity_Id := Empty;\n       Suffix       : Character := ' ';\n-      Suffix_Index : Nat       := 0;\n+      Suffix_Index : Int       := 0;\n       Scope_Id     : Entity_Id := Current_Scope) return Entity_Id;\n    --  Used to create a new Itype\n    --"}, {"sha": "d12ccc9c9a969d779b3eef5a557c9b06b9b1c72b", "filename": "gcc/ada/sem_ch3.adb", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fsem_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fsem_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch3.adb?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -9453,6 +9453,7 @@ package body Sem_Ch3 is\n               (Derived_Type, Save_Discr_Constr);\n             Set_Stored_Constraint\n               (Derived_Type, Expand_To_Stored_Constraint (Parent_Type, Discs));\n+\n             Replace_Components (Derived_Type, New_Decl);\n          end if;\n \n@@ -13692,7 +13693,8 @@ package body Sem_Ch3 is\n       Related_Nod : Node_Id) return Entity_Id\n    is\n       T_Sub : constant Entity_Id :=\n-                Create_Itype (E_Record_Subtype, Related_Nod, Corr_Rec, 'C');\n+                Create_Itype (E_Record_Subtype,\n+                  Related_Nod, Corr_Rec, 'C', Suffix_Index => -1);\n \n    begin\n       Set_Etype             (T_Sub, Corr_Rec);"}, {"sha": "a8ea805d467a31e9538940a447bc77cb02dedcd7", "filename": "gcc/ada/sem_util.adb", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fsem_util.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fsem_util.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.adb?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -20997,7 +20997,7 @@ package body Sem_Util is\n       Sloc_Value   : Source_Ptr;\n       Related_Id   : Entity_Id;\n       Suffix       : Character;\n-      Suffix_Index : Nat := 0;\n+      Suffix_Index : Int := 0;\n       Prefix       : Character := ' ') return Entity_Id\n    is\n       N : constant Entity_Id :=\n@@ -24039,6 +24039,15 @@ package body Sem_Util is\n            and then Outer = Protected_Body_Subprogram (Curr)\n          then\n             return True;\n+\n+         --  OUtside of its scope, a synchronized type may just be\n+         --  private.\n+\n+         elsif Is_Private_Type (Curr)\n+           and then Present (Full_View (Curr))\n+            and then Is_Concurrent_Type (Full_View (Curr))\n+         then\n+            return Scope_Within (Full_View (Curr), Outer);\n          end if;\n       end loop;\n "}, {"sha": "74d670dabbaca9de67795ba1abea7779a5e73a72", "filename": "gcc/ada/sem_util.ads", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fsem_util.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Fada%2Fsem_util.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.ads?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -2326,7 +2326,7 @@ package Sem_Util is\n       Sloc_Value   : Source_Ptr;\n       Related_Id   : Entity_Id;\n       Suffix       : Character;\n-      Suffix_Index : Nat := 0;\n+      Suffix_Index : Int := 0;\n       Prefix       : Character := ' ') return Entity_Id;\n    --  This function creates an N_Defining_Identifier node for an internal\n    --  created entity, such as an implicit type or subtype, or a record"}, {"sha": "5d4bdbd8d1918b4c2616afbca4ae340b4012223f", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -1,3 +1,8 @@\n+2018-08-21  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/task1.adb, gnat.dg/task1.ads, gnat.dg/task1_pkg.adb,\n+\tgnat.dg/task1_pkg.ads: New testcase.\n+\n 2018-08-21  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* gnat.dg/linkedlist.adb: New testcase."}, {"sha": "1f1d1e960d7cfc8fdd25ce899b8af92ef8e699b2", "filename": "gcc/testsuite/gnat.dg/task1.adb", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1.adb?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -0,0 +1,5 @@\n+--  { dg-do assemble }\n+\n+package body Task1 is\n+   procedure Dummy is null;\n+end Task1;"}, {"sha": "8908915248b45a301483b99f4a0d8b538a9b672f", "filename": "gcc/testsuite/gnat.dg/task1.ads", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1.ads?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -0,0 +1,10 @@\n+with Task1_Pkg; use Task1_Pkg;\n+\n+package Task1 is\n+   TAB : constant Typ_Task_Par_Tab := (others => (Dummy => FALSE));\n+\n+   T1 : Typ_Task (TAB (1).Dummy);\n+   T2 : Typ_Task (TAB (2).Dummy);\n+\n+   procedure Dummy;\n+end Task1;"}, {"sha": "abd0a3657d9b19a3c396fc4704170c319e3b8278", "filename": "gcc/testsuite/gnat.dg/task1_pkg.adb", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1_pkg.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1_pkg.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1_pkg.adb?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -0,0 +1,11 @@\n+package body Task1_Pkg is\n+   task body Typ_Task is\n+   begin\n+      loop\n+         null;\n+      end loop;\n+   end Typ_Task;\n+\n+begin\n+   null;\n+end Task1_Pkg;"}, {"sha": "183d2395e848d7012d234e917d4d12aa28738a11", "filename": "gcc/testsuite/gnat.dg/task1_pkg.ads", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1_pkg.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5df2955f9ec8deafeb2978fcb38fb99f2660fd/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1_pkg.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Ftask1_pkg.ads?ref=2e5df2955f9ec8deafeb2978fcb38fb99f2660fd", "patch": "@@ -0,0 +1,10 @@\n+package Task1_Pkg is\n+   subtype Typ_Bool is boolean;\n+\n+   type Typ_Task_Par is record\n+      Dummy : Typ_Bool;\n+   end record;\n+\n+   type Typ_Task_Par_Tab is array (1 .. 33) of aliased Typ_Task_Par;\n+   task type Typ_Task (dummy : Typ_Bool);\n+end Task1_Pkg;"}]}