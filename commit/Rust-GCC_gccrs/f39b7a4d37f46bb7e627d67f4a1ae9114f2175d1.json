{"sha": "f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "node_id": "C_kwDOANBUbNoAKGYzOWI3YTRkMzdmNDZiYjdlNjI3ZDY3ZjRhMWFlOTExNGYyMTc1ZDE", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-12-19T10:14:55Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-12-19T10:14:55Z"}, "message": "hwasan: Add libhwasan_preinit.o\n\nI've noticed an inconsistency with the other sanitizers.\nFor -fsanitize={address,thread,leak} we link into binaries\nlib*san_preinit.o such that the -lasan, -ltsan or -llsan libraries\nare initialized as early as possible through .preinit_array.\nThe hwasan library has the same thing, but we strangely compiled\nit into the library (where it apparently didn't do anything,\n.preinit_array doesn't seem to be created for shared libraries),\nrather than installing it like in the other 3 cases.\n\nThe following patch handles it for hwasan similarly to asan, tsan and lsan.\n\nI don't have any hw with hwasan support, so I've just checked it\nbuilds and installs as expected and that\ngcc -fsanitize=hwaddress -o a a.c -mlam=u57\non trivial main results in .preinit_array section in the binary.\n\n2022-12-19  Jakub Jelinek  <jakub@redhat.com>\n\n\t* config/gnu-user.h (LIBHWASAN_EARLY_SPEC): Add libhwasan_preinit.o\n\tto link spec if not -shared.\n\n\t* hwasan/Makefile.am (nodist_toolexeclib_HEADERS): Set to\n\tlibhwasan_preinit.o.\n\t(hwasan_files): Remove hwasan_preinit.cpp.\n\t(libhwasan_preinit.o): Copy from hwasan_preinit.o.\n\t* hwasan/Makefile.in: Regenerated.", "tree": {"sha": "d1732db3d2c0c583042c4285e0b7a74bff469b5c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d1732db3d2c0c583042c4285e0b7a74bff469b5c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61f9fe404933552a1858414f8181936d63a88ca2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/61f9fe404933552a1858414f8181936d63a88ca2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/61f9fe404933552a1858414f8181936d63a88ca2"}], "stats": {"total": 70, "additions": 51, "deletions": 19}, "files": [{"sha": "edb3aa6e451b3a5b4e8b9ff1052d0af1ba7efc03", "filename": "gcc/config/gnu-user.h", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/gcc%2Fconfig%2Fgnu-user.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/gcc%2Fconfig%2Fgnu-user.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fgnu-user.h?ref=f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "patch": "@@ -138,7 +138,8 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n   LD_STATIC_OPTION \" --whole-archive -lasan --no-whole-archive \" \\\n   LD_DYNAMIC_OPTION \"}}%{!static-libasan:-lasan}\"\n #undef LIBHWASAN_EARLY_SPEC\n-#define LIBHWASAN_EARLY_SPEC \"%{static-libhwasan:%{!shared:\" \\\n+#define LIBHWASAN_EARLY_SPEC \"%{!shared:libhwasan_preinit%O%s} \" \\\n+  \"%{static-libhwasan:%{!shared:\" \\\n   LD_STATIC_OPTION \" --whole-archive -lhwasan --no-whole-archive \" \\\n   LD_DYNAMIC_OPTION \"}}%{!static-libhwasan:-lhwasan}\"\n #undef LIBTSAN_EARLY_SPEC"}, {"sha": "5a89189f6d8f95da8b40d5485e38a8ae4e71c312", "filename": "libsanitizer/hwasan/Makefile.am", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/libsanitizer%2Fhwasan%2FMakefile.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/libsanitizer%2Fhwasan%2FMakefile.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libsanitizer%2Fhwasan%2FMakefile.am?ref=f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "patch": "@@ -12,6 +12,7 @@ AM_CCASFLAGS = $(EXTRA_ASFLAGS)\n ACLOCAL_AMFLAGS = -I $(top_srcdir) -I $(top_srcdir)/config\n \n toolexeclib_LTLIBRARIES = libhwasan.la\n+nodist_toolexeclib_HEADERS = libhwasan_preinit.o\n \n hwasan_files = \\\n \thwasan_allocation_functions.cpp \\\n@@ -28,7 +29,6 @@ hwasan_files = \\\n \thwasan_memintrinsics.cpp \\\n \thwasan_new_delete.cpp \\\n \thwasan_poisoning.cpp \\\n-\thwasan_preinit.cpp \\\n \thwasan_report.cpp \\\n \thwasan_setjmp_aarch64.S \\\n \thwasan_setjmp_x86_64.S \\\n@@ -49,6 +49,9 @@ libhwasan_la_LIBADD += $(LIBSTDCXX_RAW_CXX_LDFLAGS)\n \n libhwasan_la_LDFLAGS = -version-info `grep -v '^\\#' $(srcdir)/libtool-version` $(link_libhwasan)\n \n+libhwasan_preinit.o: hwasan_preinit.o\n+\tcp $< $@\n+\n # Work around what appears to be a GNU make bug handling MAKEFLAGS\n # values defined in terms of make variables, as is the case for CC and\n # friends when we are called from the top level Makefile."}, {"sha": "4240aa9014717450f21612ca438e5a1e20b552c3", "filename": "libsanitizer/hwasan/Makefile.in", "status": "modified", "additions": 45, "deletions": 17, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/libsanitizer%2Fhwasan%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1/libsanitizer%2Fhwasan%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libsanitizer%2Fhwasan%2FMakefile.in?ref=f39b7a4d37f46bb7e627d67f4a1ae9114f2175d1", "patch": "@@ -14,6 +14,7 @@\n \n @SET_MAKE@\n \n+\n VPATH = @srcdir@\n am__is_gnu_make = { \\\n   if test -z '$(MAKELEVEL)'; then \\\n@@ -141,7 +142,8 @@ am__uninstall_files_from_dir = { \\\n     || { echo \" ( cd '$$dir' && rm -f\" $$files \")\"; \\\n          $(am__cd) \"$$dir\" && rm -f $$files; }; \\\n   }\n-am__installdirs = \"$(DESTDIR)$(toolexeclibdir)\"\n+am__installdirs = \"$(DESTDIR)$(toolexeclibdir)\" \\\n+\t\"$(DESTDIR)$(toolexeclibdir)\"\n LTLIBRARIES = $(toolexeclib_LTLIBRARIES)\n am__DEPENDENCIES_1 =\n libhwasan_la_DEPENDENCIES =  \\\n@@ -152,10 +154,9 @@ am__objects_1 = hwasan_allocation_functions.lo hwasan_allocator.lo \\\n \thwasan_fuchsia.lo hwasan_globals.lo hwasan_interceptors.lo \\\n \thwasan_interceptors_vfork.lo hwasan_linux.lo \\\n \thwasan_memintrinsics.lo hwasan_new_delete.lo \\\n-\thwasan_poisoning.lo hwasan_preinit.lo hwasan_report.lo \\\n-\thwasan_setjmp_aarch64.lo hwasan_setjmp_x86_64.lo \\\n-\thwasan_tag_mismatch_aarch64.lo hwasan_thread.lo \\\n-\thwasan_thread_list.lo hwasan_type_test.lo\n+\thwasan_poisoning.lo hwasan_report.lo hwasan_setjmp_aarch64.lo \\\n+\thwasan_setjmp_x86_64.lo hwasan_tag_mismatch_aarch64.lo \\\n+\thwasan_thread.lo hwasan_thread_list.lo hwasan_type_test.lo\n am_libhwasan_la_OBJECTS = $(am__objects_1)\n libhwasan_la_OBJECTS = $(am_libhwasan_la_OBJECTS)\n AM_V_lt = $(am__v_lt_@AM_V@)\n@@ -233,6 +234,7 @@ am__can_run_installinfo = \\\n     n|no|NO) false;; \\\n     *) (install-info --version) >/dev/null 2>&1;; \\\n   esac\n+HEADERS = $(nodist_toolexeclib_HEADERS)\n am__tagged_files = $(HEADERS) $(SOURCES) $(TAGS_FILES) $(LISP)\n # Read a list of newline-separated strings from the standard input,\n # and print each of them once, without duplicates.  Input order is\n@@ -415,6 +417,7 @@ AM_CXXFLAGS = -Wall -W -Wno-unused-parameter -Wwrite-strings -pedantic \\\n AM_CCASFLAGS = $(EXTRA_ASFLAGS)\n ACLOCAL_AMFLAGS = -I $(top_srcdir) -I $(top_srcdir)/config\n toolexeclib_LTLIBRARIES = libhwasan.la\n+nodist_toolexeclib_HEADERS = libhwasan_preinit.o\n hwasan_files = \\\n \thwasan_allocation_functions.cpp \\\n \thwasan_allocator.cpp \\\n@@ -430,7 +433,6 @@ hwasan_files = \\\n \thwasan_memintrinsics.cpp \\\n \thwasan_new_delete.cpp \\\n \thwasan_poisoning.cpp \\\n-\thwasan_preinit.cpp \\\n \thwasan_report.cpp \\\n \thwasan_setjmp_aarch64.S \\\n \thwasan_setjmp_x86_64.S \\\n@@ -575,7 +577,6 @@ distclean-compile:\n @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_memintrinsics.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_new_delete.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_poisoning.Plo@am__quote@\n-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_preinit.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_report.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_setjmp_aarch64.Plo@am__quote@\n @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hwasan_setjmp_x86_64.Plo@am__quote@\n@@ -631,6 +632,27 @@ mostlyclean-libtool:\n \n clean-libtool:\n \t-rm -rf .libs _libs\n+install-nodist_toolexeclibHEADERS: $(nodist_toolexeclib_HEADERS)\n+\t@$(NORMAL_INSTALL)\n+\t@list='$(nodist_toolexeclib_HEADERS)'; test -n \"$(toolexeclibdir)\" || list=; \\\n+\tif test -n \"$$list\"; then \\\n+\t  echo \" $(MKDIR_P) '$(DESTDIR)$(toolexeclibdir)'\"; \\\n+\t  $(MKDIR_P) \"$(DESTDIR)$(toolexeclibdir)\" || exit 1; \\\n+\tfi; \\\n+\tfor p in $$list; do \\\n+\t  if test -f \"$$p\"; then d=; else d=\"$(srcdir)/\"; fi; \\\n+\t  echo \"$$d$$p\"; \\\n+\tdone | $(am__base_list) | \\\n+\twhile read files; do \\\n+\t  echo \" $(INSTALL_HEADER) $$files '$(DESTDIR)$(toolexeclibdir)'\"; \\\n+\t  $(INSTALL_HEADER) $$files \"$(DESTDIR)$(toolexeclibdir)\" || exit $$?; \\\n+\tdone\n+\n+uninstall-nodist_toolexeclibHEADERS:\n+\t@$(NORMAL_UNINSTALL)\n+\t@list='$(nodist_toolexeclib_HEADERS)'; test -n \"$(toolexeclibdir)\" || list=; \\\n+\tfiles=`for p in $$list; do echo $$p; done | sed -e 's|^.*/||'`; \\\n+\tdir='$(DESTDIR)$(toolexeclibdir)'; $(am__uninstall_files_from_dir)\n \n ID: $(am__tagged_files)\n \t$(am__define_uniq_tagged_files); mkid -fID $$unique\n@@ -685,9 +707,9 @@ distclean-tags:\n \t-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags\n check-am: all-am\n check: check-am\n-all-am: Makefile $(LTLIBRARIES)\n+all-am: Makefile $(LTLIBRARIES) $(HEADERS)\n installdirs:\n-\tfor dir in \"$(DESTDIR)$(toolexeclibdir)\"; do \\\n+\tfor dir in \"$(DESTDIR)$(toolexeclibdir)\" \"$(DESTDIR)$(toolexeclibdir)\"; do \\\n \t  test -z \"$$dir\" || $(MKDIR_P) \"$$dir\"; \\\n \tdone\n install: install-am\n@@ -749,7 +771,8 @@ install-dvi: install-dvi-am\n \n install-dvi-am:\n \n-install-exec-am: install-toolexeclibLTLIBRARIES\n+install-exec-am: install-nodist_toolexeclibHEADERS \\\n+\tinstall-toolexeclibLTLIBRARIES\n \n install-html: install-html-am\n \n@@ -789,7 +812,8 @@ ps: ps-am\n \n ps-am:\n \n-uninstall-am: uninstall-toolexeclibLTLIBRARIES\n+uninstall-am: uninstall-nodist_toolexeclibHEADERS \\\n+\tuninstall-toolexeclibLTLIBRARIES\n \n .MAKE: install-am install-strip\n \n@@ -800,17 +824,21 @@ uninstall-am: uninstall-toolexeclibLTLIBRARIES\n \tinfo-am install install-am install-data install-data-am \\\n \tinstall-dvi install-dvi-am install-exec install-exec-am \\\n \tinstall-html install-html-am install-info install-info-am \\\n-\tinstall-man install-pdf install-pdf-am install-ps \\\n-\tinstall-ps-am install-strip install-toolexeclibLTLIBRARIES \\\n-\tinstallcheck installcheck-am installdirs maintainer-clean \\\n-\tmaintainer-clean-generic mostlyclean mostlyclean-compile \\\n-\tmostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \\\n-\ttags tags-am uninstall uninstall-am \\\n+\tinstall-man install-nodist_toolexeclibHEADERS install-pdf \\\n+\tinstall-pdf-am install-ps install-ps-am install-strip \\\n+\tinstall-toolexeclibLTLIBRARIES installcheck installcheck-am \\\n+\tinstalldirs maintainer-clean maintainer-clean-generic \\\n+\tmostlyclean mostlyclean-compile mostlyclean-generic \\\n+\tmostlyclean-libtool pdf pdf-am ps ps-am tags tags-am uninstall \\\n+\tuninstall-am uninstall-nodist_toolexeclibHEADERS \\\n \tuninstall-toolexeclibLTLIBRARIES\n \n .PRECIOUS: Makefile\n \n \n+libhwasan_preinit.o: hwasan_preinit.o\n+\tcp $< $@\n+\n # Tell versions [3.59,3.63) of GNU make to not export all variables.\n # Otherwise a system limit (for SysV at least) may be exceeded.\n .NOEXPORT:"}]}