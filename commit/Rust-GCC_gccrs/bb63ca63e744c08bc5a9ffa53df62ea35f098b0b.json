{"sha": "bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmI2M2NhNjNlNzQ0YzA4YmM1YTlmZmE1M2RmNjJlYTM1ZjA5OGIwYg==", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2020-05-11T13:26:09Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2020-05-12T06:22:19Z"}, "message": "tree-optimization/95045 - fix SM with exit exiting multiple loops\n\nSince we apply SM to an edge which exits multiple loops we have\nto make sure to commit insertions on it immediately since otherwise\nstore order is not preserved.\n\n2020-05-12  Richard Biener  <rguenther@suse.de>\n\n\tPR tree-optimization/95045\n\t* dbgcnt.def (lim): Add debug-counter.\n\t* tree-ssa-loop-im.c: Include dbgcnt.h.\n\t(find_refs_for_sm): Use lim debug counter for store motion\n\tcandidates.\n\t(do_store_motion): Rename form store_motion.  Commit edge\n\tinsertions...\n\t(store_motion_loop): ... here.\n\t(tree_ssa_lim): Adjust.", "tree": {"sha": "569b640d80261e4a5f3ea0abe8d3b4b7d1a6d691", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/569b640d80261e4a5f3ea0abe8d3b4b7d1a6d691"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7a2e715c9af2611040319f7139aee21054bcb8b7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7a2e715c9af2611040319f7139aee21054bcb8b7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7a2e715c9af2611040319f7139aee21054bcb8b7"}], "stats": {"total": 28, "additions": 23, "deletions": 5}, "files": [{"sha": "9b8b5aee9f6779f2ec1e5f3cb453086fcdc9ccb6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "patch": "@@ -1,3 +1,15 @@\n+2020-05-12  Richard Biener  <rguenther@suse.de>\n+\n+\tPR tree-optimization/95045\n+\t* dbgcnt.def (lim): Add debug-counter.\n+\t* tree-ssa-loop-im.c: Include dbgcnt.h.\n+\t(find_refs_for_sm): Use lim debug counter for store motion\n+\tcandidates.\n+\t(do_store_motion): Rename form store_motion.  Commit edge\n+\tinsertions...\n+\t(store_motion_loop): ... here.\n+\t(tree_ssa_lim): Adjust.\n+\n 2020-05-11  Kelvin Nilsen  <kelvin@gcc.gnu.org>\n \n \t* config/rs6000/altivec.h (vec_clzm): Rename to vec_cntlzm."}, {"sha": "3998c9636aacabcc84feddae51101e9c086a5db5", "filename": "gcc/dbgcnt.def", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/gcc%2Fdbgcnt.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/gcc%2Fdbgcnt.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdbgcnt.def?ref=bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "patch": "@@ -174,6 +174,7 @@ DEBUG_COUNTER (ipa_sra_params)\n DEBUG_COUNTER (ipa_sra_retvalues)\n DEBUG_COUNTER (ira_move)\n DEBUG_COUNTER (ivopts_loop)\n+DEBUG_COUNTER (lim)\n DEBUG_COUNTER (local_alloc_for_sched)\n DEBUG_COUNTER (match)\n DEBUG_COUNTER (merged_ipa_icf)"}, {"sha": "0d77aaa08a55a7172557698848df495b0859246b", "filename": "gcc/tree-ssa-loop-im.c", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/gcc%2Ftree-ssa-loop-im.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bb63ca63e744c08bc5a9ffa53df62ea35f098b0b/gcc%2Ftree-ssa-loop-im.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-loop-im.c?ref=bb63ca63e744c08bc5a9ffa53df62ea35f098b0b", "patch": "@@ -47,6 +47,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"alias.h\"\n #include \"builtins.h\"\n #include \"tree-dfa.h\"\n+#include \"dbgcnt.h\"\n \n /* TODO:  Support for predicated code motion.  I.e.\n \n@@ -2862,7 +2863,7 @@ find_refs_for_sm (class loop *loop, bitmap sm_executed, bitmap refs_to_sm)\n   EXECUTE_IF_AND_COMPL_IN_BITMAP (refs, sm_executed, 0, i, bi)\n     {\n       ref = memory_accesses.refs_list[i];\n-      if (can_sm_ref_p (loop, ref))\n+      if (can_sm_ref_p (loop, ref) && dbg_cnt (lim))\n \tbitmap_set_bit (refs_to_sm, i);\n     }\n }\n@@ -2900,7 +2901,12 @@ store_motion_loop (class loop *loop, bitmap sm_executed)\n     {\n       find_refs_for_sm (loop, sm_executed, sm_in_loop);\n       if (!bitmap_empty_p (sm_in_loop))\n-\thoist_memory_references (loop, sm_in_loop, exits);\n+\t{\n+\t  hoist_memory_references (loop, sm_in_loop, exits);\n+\t  /* Commit edge inserts here to preserve the order of stores\n+\t     when an exit exits multiple loops.  */\n+\t  gsi_commit_edge_inserts ();\n+\t}\n     }\n   exits.release ();\n \n@@ -2915,7 +2921,7 @@ store_motion_loop (class loop *loop, bitmap sm_executed)\n    loops.  */\n \n static void\n-store_motion (void)\n+do_store_motion (void)\n {\n   class loop *loop;\n   bitmap sm_executed = BITMAP_ALLOC (&lim_bitmap_obstack);\n@@ -2924,7 +2930,6 @@ store_motion (void)\n     store_motion_loop (loop, sm_executed);\n \n   BITMAP_FREE (sm_executed);\n-  gsi_commit_edge_inserts ();\n }\n \n /* Fills ALWAYS_EXECUTED_IN information for basic blocks of LOOP, i.e.\n@@ -3141,7 +3146,7 @@ tree_ssa_lim (void)\n \n   /* Execute store motion.  Force the necessary invariants to be moved\n      out of the loops as well.  */\n-  store_motion ();\n+  do_store_motion ();\n \n   /* Move the expressions that are expensive enough.  */\n   todo = move_computations ();"}]}