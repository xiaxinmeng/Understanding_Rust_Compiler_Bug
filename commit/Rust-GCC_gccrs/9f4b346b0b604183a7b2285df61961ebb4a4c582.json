{"sha": "9f4b346b0b604183a7b2285df61961ebb4a4c582", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWY0YjM0NmIwYjYwNDE4M2E3YjIyODVkZjYxOTYxZWJiNGE0YzU4Mg==", "commit": {"author": {"name": "Bob Duff", "email": "duff@adacore.com", "date": "2018-05-29T09:28:59Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-05-29T09:28:59Z"}, "message": "[Ada] Preliminary work to avoid full pathnames in ALI files\n\nNormally, ALI files refer to source files using simple names. This allows files\nto be moved around without disturbing things (causing extra recompilations,\netc). However, for configuration files, the full pathname is stored. This patch\npreparates the code base to store the simple name in this case.\n\n2018-05-29  Bob Duff  <duff@adacore.com>\n\ngcc/ada/\n\n\t* lib-writ.adb (Write_ALI): Cleanup: avoid use of global var; call new\n\tTo_Lower function.\n\t* libgnat/s-casuti.ads, libgnat/s-casuti.adb (To_Upper, To_Lower,\n\tTo_Mixed): New functions.\n\t* osint.adb: Cleanup: use Is_Directory_Separator, which correctly\n\tallows both '\\' and '/' on Windows.\n\nFrom-SVN: r260860", "tree": {"sha": "9b90ec6496d0506cb5101ef9cbff8c45513b3a5c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9b90ec6496d0506cb5101ef9cbff8c45513b3a5c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9f4b346b0b604183a7b2285df61961ebb4a4c582", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9f4b346b0b604183a7b2285df61961ebb4a4c582", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9f4b346b0b604183a7b2285df61961ebb4a4c582", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9f4b346b0b604183a7b2285df61961ebb4a4c582/comments", "author": {"login": "bobduff", "id": 29099567, "node_id": "MDQ6VXNlcjI5MDk5NTY3", "avatar_url": "https://avatars.githubusercontent.com/u/29099567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bobduff", "html_url": "https://github.com/bobduff", "followers_url": "https://api.github.com/users/bobduff/followers", "following_url": "https://api.github.com/users/bobduff/following{/other_user}", "gists_url": "https://api.github.com/users/bobduff/gists{/gist_id}", "starred_url": "https://api.github.com/users/bobduff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bobduff/subscriptions", "organizations_url": "https://api.github.com/users/bobduff/orgs", "repos_url": "https://api.github.com/users/bobduff/repos", "events_url": "https://api.github.com/users/bobduff/events{/privacy}", "received_events_url": "https://api.github.com/users/bobduff/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "0c46b4263c49f008485b25eafffbe685c3c9031f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0c46b4263c49f008485b25eafffbe685c3c9031f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0c46b4263c49f008485b25eafffbe685c3c9031f"}], "stats": {"total": 70, "additions": 51, "deletions": 19}, "files": [{"sha": "b0bf034dee03dab54338d9bacd40aa55e9733c17", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=9f4b346b0b604183a7b2285df61961ebb4a4c582", "patch": "@@ -1,3 +1,12 @@\n+2018-05-29  Bob Duff  <duff@adacore.com>\n+\n+\t* lib-writ.adb (Write_ALI): Cleanup: avoid use of global var; call new\n+\tTo_Lower function.\n+\t* libgnat/s-casuti.ads, libgnat/s-casuti.adb (To_Upper, To_Lower,\n+\tTo_Mixed): New functions.\n+\t* osint.adb: Cleanup: use Is_Directory_Separator, which correctly\n+\tallows both '\\' and '/' on Windows.\n+\n 2018-05-28  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* repinfo.ads: Minor fixes and tweaks in comments."}, {"sha": "9896a832554e4d82389fb89156c1a1b1cb6ac881", "filename": "gcc/ada/lib-writ.adb", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Flib-writ.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Flib-writ.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flib-writ.adb?ref=9f4b346b0b604183a7b2285df61961ebb4a4c582", "patch": "@@ -1539,15 +1539,21 @@ package body Lib.Writ is\n             --  Normal case of a unit entry with a source index\n \n             if Sind > No_Source_File then\n-               Fname := File_Name (Sind);\n+               --  We never want directory information in ALI files\n+               --  ???But back out this change temporarily until\n+               --  gprbuild is fixed.\n \n-               --  Ensure that on platforms where the file names are not case\n-               --  sensitive, the recorded file name is in lower case.\n+               if False then\n+                  Fname := Strip_Directory (File_Name (Sind));\n+               else\n+                  Fname := File_Name (Sind);\n+               end if;\n+\n+               --  Ensure that on platforms where the file names are not\n+               --  case sensitive, the recorded file name is in lower case.\n \n                if not File_Names_Case_Sensitive then\n-                  Get_Name_String (Fname);\n-                  To_Lower (Name_Buffer (1 .. Name_Len));\n-                  Fname := Name_Find;\n+                  Fname := Name_Find (To_Lower (Get_Name_String (Fname)));\n                end if;\n \n                Write_Info_Name_May_Be_Quoted (Fname);"}, {"sha": "345ee8aeada58ef138213cbd8924c3b08d00e5d2", "filename": "gcc/ada/libgnat/s-casuti.adb", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Flibgnat%2Fs-casuti.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Flibgnat%2Fs-casuti.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-casuti.adb?ref=9f4b346b0b604183a7b2285df61961ebb4a4c582", "patch": "@@ -58,6 +58,13 @@ package body System.Case_Util is\n       end loop;\n    end To_Lower;\n \n+   function To_Lower (A : String) return String is\n+      Result : String := A;\n+   begin\n+      To_Lower (Result);\n+      return Result;\n+   end To_Lower;\n+\n    --------------\n    -- To_Mixed --\n    --------------\n@@ -77,6 +84,13 @@ package body System.Case_Util is\n       end loop;\n    end To_Mixed;\n \n+   function To_Mixed (A : String) return String is\n+      Result : String := A;\n+   begin\n+      To_Mixed (Result);\n+      return Result;\n+   end To_Mixed;\n+\n    --------------\n    -- To_Upper --\n    --------------\n@@ -102,4 +116,11 @@ package body System.Case_Util is\n       end loop;\n    end To_Upper;\n \n+   function To_Upper (A : String) return String is\n+      Result : String := A;\n+   begin\n+      To_Upper (Result);\n+      return Result;\n+   end To_Upper;\n+\n end System.Case_Util;"}, {"sha": "7df35f11776e3cc17d504182d232c7204e866957", "filename": "gcc/ada/libgnat/s-casuti.ads", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Flibgnat%2Fs-casuti.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Flibgnat%2Fs-casuti.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-casuti.ads?ref=9f4b346b0b604183a7b2285df61961ebb4a4c582", "patch": "@@ -49,16 +49,19 @@ package System.Case_Util is\n    --  returns the input argument unchanged.\n \n    procedure To_Upper (A : in out String);\n+   function To_Upper (A : String) return String;\n    --  Folds all characters of string A to upper case\n \n    function To_Lower (A : Character) return Character;\n    --  Converts A to lower case if it is an upper case letter, otherwise\n    --  returns the input argument unchanged.\n \n    procedure To_Lower (A : in out String);\n+   function To_Lower (A : String) return String;\n    --  Folds all characters of string A to lower case\n \n    procedure To_Mixed (A : in out String);\n+   function To_Mixed (A : String) return String;\n    --  Converts A to mixed case (i.e. lower case, except for initial\n    --  character and any character after an underscore, which are\n    --  converted to upper case."}, {"sha": "e7644b1fe5d7a0cf2224b93ac7c14f2d836f1275", "filename": "gcc/ada/osint.adb", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Fosint.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9f4b346b0b604183a7b2285df61961ebb4a4c582/gcc%2Fada%2Fosint.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.adb?ref=9f4b346b0b604183a7b2285df61961ebb4a4c582", "patch": "@@ -830,9 +830,7 @@ package body Osint is\n                   Add_Suffix := False;\n                   exit;\n \n-               elsif Name_Buffer (J) = '/' or else\n-                     Name_Buffer (J) = Directory_Separator\n-               then\n+               elsif Is_Directory_Separator (Name_Buffer (J)) then\n                   exit;\n                end if;\n             end loop;\n@@ -905,9 +903,7 @@ package body Osint is\n                      Add_Suffix := False;\n                      exit;\n \n-                  elsif Canonical_Name (J) = '/' or else\n-                        Canonical_Name (J) = Directory_Separator\n-                  then\n+                  elsif Is_Directory_Separator (Canonical_Name (J)) then\n                      exit;\n                   end if;\n                end loop;\n@@ -1501,7 +1497,7 @@ package body Osint is\n       --  Add a directory separator at the end of the directory if necessary\n       --  so that we can directly append a file to the directory\n \n-      if Search_Dir (Search_Dir'Last) /= Directory_Separator then\n+      if not Is_Directory_Separator (Search_Dir (Search_Dir'Last)) then\n          Local_Search_Dir :=\n            new String'(Search_Dir & String'(1 => Directory_Separator));\n       else\n@@ -1553,7 +1549,7 @@ package body Osint is\n                raise Program_Error;\n             end if;\n \n-            if Buffer (Path_Len) /= Directory_Separator then\n+            if not Is_Directory_Separator (Buffer (Path_Len)) then\n                Path_Len := Path_Len + 1;\n                Buffer (Path_Len) := Directory_Separator;\n             end if;\n@@ -1964,9 +1960,7 @@ package body Osint is\n       Fptr := File_Name'First;\n \n       for J in reverse File_Name'Range loop\n-         if File_Name (J) = Directory_Separator\n-           or else File_Name (J) = '/'\n-         then\n+         if Is_Directory_Separator (File_Name (J)) then\n             if J = File_Name'Last then\n                Fail (\"File name missing\");\n             end if;\n@@ -2221,8 +2215,7 @@ package body Osint is\n       --  Ditto for suffix, e.g. in \"gcc-4.1\", the suffix is \"-4.1\"\n \n       for J in reverse 1 .. Name_Len loop\n-         if Name_Buffer (J) = '/'\n-           or else Name_Buffer (J) = Directory_Separator\n+         if Is_Directory_Separator (Name_Buffer (J))\n            or else Name_Buffer (J) = ':'\n          then\n             Start_Of_Prefix := J + 1;"}]}