{"sha": "de10fca02a806c8c323041c5e904abaaef510fc0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGUxMGZjYTAyYTgwNmM4YzMyMzA0MWM1ZTkwNGFiYWFlZjUxMGZjMA==", "commit": {"author": {"name": "Sandra Loosemore", "email": "sandra@codesourcery.com", "date": "2017-10-26T20:49:48Z"}, "committer": {"name": "Sandra Loosemore", "email": "sandra@gcc.gnu.org", "date": "2017-10-26T20:49:48Z"}, "message": "nios2.c: Include xregex.h.\n\n2017-10-26  Sandra Loosemore  <sandra@codesourcery.com>\n\n\tgcc/\n\t* config/nios2/nios2.c: Include xregex.h.\n\t(nios2_gprel_sec_regex): New.\n\t(nios2_option_overide): Initialize it.  Don't allow GP-relative \n\taddressing with PIC.\n\t(nios2_small_section_name_p): Check for regex match.\n\t* config/nios2/nios2.opt (mgprel-sec=): New option.\n\t* doc/invoke.texi (Option Summary): Add -mgprel-sec.\n\t(Nios II Options): Document -mgprel-sec.\n\n\tgcc/testsuite/\n\t* gcc.target/nios2/gpopt-gprel-sec.c: New.\n\nFrom-SVN: r254123", "tree": {"sha": "f40537de19218fb2bcb55461d96038ae8d100d5d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f40537de19218fb2bcb55461d96038ae8d100d5d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/de10fca02a806c8c323041c5e904abaaef510fc0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/de10fca02a806c8c323041c5e904abaaef510fc0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/de10fca02a806c8c323041c5e904abaaef510fc0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/de10fca02a806c8c323041c5e904abaaef510fc0/comments", "author": {"login": "SandraLoosemore", "id": 104087111, "node_id": "U_kgDOBjQ-Rw", "avatar_url": "https://avatars.githubusercontent.com/u/104087111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SandraLoosemore", "html_url": "https://github.com/SandraLoosemore", "followers_url": "https://api.github.com/users/SandraLoosemore/followers", "following_url": "https://api.github.com/users/SandraLoosemore/following{/other_user}", "gists_url": "https://api.github.com/users/SandraLoosemore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SandraLoosemore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SandraLoosemore/subscriptions", "organizations_url": "https://api.github.com/users/SandraLoosemore/orgs", "repos_url": "https://api.github.com/users/SandraLoosemore/repos", "events_url": "https://api.github.com/users/SandraLoosemore/events{/privacy}", "received_events_url": "https://api.github.com/users/SandraLoosemore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "31498bee1acc00d89ea82c9c8614aa65f1eff2e8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/31498bee1acc00d89ea82c9c8614aa65f1eff2e8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/31498bee1acc00d89ea82c9c8614aa65f1eff2e8"}], "stats": {"total": 95, "additions": 94, "deletions": 1}, "files": [{"sha": "7ee9da214c4a420a87fff740c987648c19e10389", "filename": "gcc/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=de10fca02a806c8c323041c5e904abaaef510fc0", "patch": "@@ -1,3 +1,14 @@\n+2017-10-26  Sandra Loosemore  <sandra@codesourcery.com>\n+\n+\t* config/nios2/nios2.c: Include xregex.h.\n+\t(nios2_gprel_sec_regex): New.\n+\t(nios2_option_overide): Initialize it.  Don't allow GP-relative \n+\taddressing with PIC.\n+\t(nios2_small_section_name_p): Check for regex match.\n+\t* config/nios2/nios2.opt (mgprel-sec=): New option.\n+\t* doc/invoke.texi (Option Summary): Add -mgprel-sec.\n+\t(Nios II Options): Document -mgprel-sec.\n+\n 2017-10-26  Jim Wilson  <wilson@tuliptree.org>\n \n \t* doc/invoke.texi (-fdebug-prefix-map): Expand documentation."}, {"sha": "3aade7b4543aed6a9dc0c54d79dca7732d5f22bb", "filename": "gcc/config/nios2/nios2.c", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Fconfig%2Fnios2%2Fnios2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Fconfig%2Fnios2%2Fnios2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnios2%2Fnios2.c?ref=de10fca02a806c8c323041c5e904abaaef510fc0", "patch": "@@ -49,6 +49,7 @@\n #include \"stor-layout.h\"\n #include \"builtins.h\"\n #include \"tree-pass.h\"\n+#include \"xregex.h\"\n \n /* This file should be included last.  */\n #include \"target-def.h\"\n@@ -103,6 +104,9 @@ static int custom_code_index[256];\n /* Set to true if any conflicts (re-use of a code between 0-255) are found.  */\n static bool custom_code_conflict = false;\n \n+/* State for command-line options.  */\n+regex_t nios2_gprel_sec_regex;\n+\n \f\n /* Definition of builtin function types for nios2.  */\n \n@@ -1371,6 +1375,23 @@ nios2_option_override (void)\n \tnios2_gpopt_option = gpopt_local;\n     }\n \n+  /* GP-relative addressing doesn't make sense for PIC.  */\n+  if (flag_pic)\n+    { \n+      if (nios2_gpopt_option != gpopt_none)\n+        error (\"-mgpopt not supported with PIC.\");\n+      if (nios2_gprel_sec)\n+        error (\"-mgprel-sec= not supported with PIC.\");\n+    }\n+\n+  /* Process -mgprel-sec=.  */\n+  if (nios2_gprel_sec)\n+    {\n+      if (regcomp (&nios2_gprel_sec_regex, nios2_gprel_sec, \n+\t\t   REG_EXTENDED | REG_NOSUB))\n+\terror (\"-mgprel-sec= argument is not a valid regular expression.\");\n+    }\n+\n   /* If we don't have mul, we don't have mulx either!  */\n   if (!TARGET_HAS_MUL && TARGET_HAS_MULX)\n     target_flags &= ~MASK_HAS_MULX;\n@@ -2268,7 +2289,9 @@ nios2_small_section_name_p (const char *section)\n   return (strcmp (section, \".sbss\") == 0\n \t  || strncmp (section, \".sbss.\", 6) == 0\n \t  || strcmp (section, \".sdata\") == 0\n-\t  || strncmp (section, \".sdata.\", 7) == 0);\n+\t  || strncmp (section, \".sdata.\", 7) == 0\n+\t  || (nios2_gprel_sec \n+\t      && regexec (&nios2_gprel_sec_regex, section, 0, NULL, 0) == 0));\n }\n \n /* Return true if EXP should be placed in the small data section.  */"}, {"sha": "d08405e64b8795c11d8ad4cbd4cbb7ac68802d7b", "filename": "gcc/config/nios2/nios2.opt", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Fconfig%2Fnios2%2Fnios2.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Fconfig%2Fnios2%2Fnios2.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnios2%2Fnios2.opt?ref=de10fca02a806c8c323041c5e904abaaef510fc0", "patch": "@@ -586,3 +586,7 @@ Enable generation of R2 BMX instructions.\n mcdx\n Target Report Mask(HAS_CDX)\n Enable generation of R2 CDX instructions.\n+\n+mgprel-sec=\n+Target RejectNegative Joined Var(nios2_gprel_sec) Init(NULL)\n+Regular expression matching additional GP-addressible small-data section names."}, {"sha": "d2001cac1997afce6bf9996cad1b9ecd8f11d1f8", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=de10fca02a806c8c323041c5e904abaaef510fc0", "patch": "@@ -948,6 +948,7 @@ Objective-C and Objective-C++ Dialects}.\n \n @emph{Nios II Options}\n @gccoptlist{-G @var{num}  -mgpopt=@var{option}  -mgpopt  -mno-gpopt @gol\n+-mgprel-sec=@var{regexp} @gol\n -mel  -meb @gol\n -mno-bypass-cache  -mbypass-cache @gol\n -mno-cache-volatile  -mcache-volatile @gol\n@@ -21171,6 +21172,18 @@ GOT data sections.  In this case, the 16-bit offset for GP-relative\n addressing may not be large enough to allow access to the entire \n small data section.\n \n+@item -mgprel-sec=@var{regexp}\n+@opindex mgprel-sec\n+This option specifies additional section names that can be accessed via\n+GP-relative addressing.  It is most useful in conjunction with \n+@code{section} attributes on variable declarations \n+(@pxref{Common Variable Attributes}) and a custom linker script.  \n+The @var{regexp} is a POSIX Extended Regular Expression.\n+\n+This option does not affect the behavior of the @option{-G} option, and \n+and the specified sections are in addition to the standard @code{.sdata} \n+and @code{.sbss} small-data sections that are recognized by @option{-mgpopt}.\n+\n @item -mel\n @itemx -meb\n @opindex mel"}, {"sha": "f8d82499939ae737736b83e937486b41449f3f87", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=de10fca02a806c8c323041c5e904abaaef510fc0", "patch": "@@ -1,3 +1,7 @@\n+2017-10-26  Sandra Loosemore  <sandra@codesourcery.com>\n+\n+\t* gcc.target/nios2/gpopt-gprel-sec.c: New.\n+\n 2017-10-26  Olga Makhotina  <olga.makhotina@intel.com>\n \n \t* gcc.target/i386/avx512f-vcmpps-1.c (_mm512_cmpeq_ps_mask,"}, {"sha": "1083fe6e6abc9bff0c31f24d355e298e2c14035c", "filename": "gcc/testsuite/gcc.target/nios2/gpopt-gprel-sec.c", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Ftestsuite%2Fgcc.target%2Fnios2%2Fgpopt-gprel-sec.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/de10fca02a806c8c323041c5e904abaaef510fc0/gcc%2Ftestsuite%2Fgcc.target%2Fnios2%2Fgpopt-gprel-sec.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnios2%2Fgpopt-gprel-sec.c?ref=de10fca02a806c8c323041c5e904abaaef510fc0", "patch": "@@ -0,0 +1,38 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O -mgpopt=local -mgprel-sec=\\\\.frog.+\" } */\n+\n+extern int a __attribute__ ((section (\".frog1\")));\n+static volatile int b __attribute__ ((section (\".frog2\"))) = 1;\n+extern int c __attribute__ ((section (\".data\")));\n+static volatile int d __attribute__ ((section (\".data\"))) = 2;\n+\n+extern int e;\n+static volatile int f = 3;\n+\n+volatile int g __attribute__ ((weak)) = 4;\n+\n+extern int h[100];\n+static int i[100];\n+static int j[100] __attribute__ ((section (\".sdata\")));\n+\n+typedef int (*ftype) (int);\n+extern int foo (int);\n+\n+extern int bar (int, int*, int*, int*, ftype);\n+\n+int baz (void)\n+{\n+  return bar (a + b + c + d + e + f + g, h, i, j, foo);\n+}\n+\n+/* { dg-final { scan-assembler \"%gprel\\\\(a\\\\)\" } } */\n+/* { dg-final { scan-assembler \"%gprel\\\\(b\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(c\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(d\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(e\\\\)\" } } */\n+/* { dg-final { scan-assembler \"%gprel\\\\(f\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(g\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(h\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(i\\\\)\" } } */\n+/* { dg-final { scan-assembler \"%gprel\\\\(j\\\\)\" } } */\n+/* { dg-final { scan-assembler-not \"%gprel\\\\(foo\\\\)\" } } */"}]}