{"sha": "a6f969f4cb4b8363b2f20f942d36dd96906ba253", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTZmOTY5ZjRjYjRiODM2M2IyZjIwZjk0MmQzNmRkOTY5MDZiYTI1Mw==", "commit": {"author": {"name": "Andrew Stubbs", "email": "ams@codesourcery.com", "date": "2011-08-19T15:05:22Z"}, "committer": {"name": "Andrew Stubbs", "email": "ams@gcc.gnu.org", "date": "2011-08-19T15:05:22Z"}, "message": "tree-ssa-math-opts.c (is_widening_mult_rhs_p): Handle constants beyond conversions.\n\n2011-08-19  Andrew Stubbs  <ams@codesourcery.com>\n\n\tgcc/\n\t* tree-ssa-math-opts.c (is_widening_mult_rhs_p): Handle constants\n\tbeyond conversions.\n\t(convert_mult_to_widen): Convert constant inputs to the right type.\n\t(convert_plusminus_to_widen): Don't automatically reject inputs that\n\tare not an SSA_NAME.\n\tConvert constant inputs to the right type.\n\n\tgcc/testsuite/\n\t* gcc.target/arm/wmul-11.c: New file.\n\t* gcc.target/arm/wmul-12.c: New file.\n\t* gcc.target/arm/wmul-13.c: New file.\n\nFrom-SVN: r177910", "tree": {"sha": "488815969f4c2cccebc3b8d2cb76b788a482e153", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/488815969f4c2cccebc3b8d2cb76b788a482e153"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a6f969f4cb4b8363b2f20f942d36dd96906ba253", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a6f969f4cb4b8363b2f20f942d36dd96906ba253", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a6f969f4cb4b8363b2f20f942d36dd96906ba253", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a6f969f4cb4b8363b2f20f942d36dd96906ba253/comments", "author": {"login": "ams-cs", "id": 2235130, "node_id": "MDQ6VXNlcjIyMzUxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/2235130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ams-cs", "html_url": "https://github.com/ams-cs", "followers_url": "https://api.github.com/users/ams-cs/followers", "following_url": "https://api.github.com/users/ams-cs/following{/other_user}", "gists_url": "https://api.github.com/users/ams-cs/gists{/gist_id}", "starred_url": "https://api.github.com/users/ams-cs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ams-cs/subscriptions", "organizations_url": "https://api.github.com/users/ams-cs/orgs", "repos_url": "https://api.github.com/users/ams-cs/repos", "events_url": "https://api.github.com/users/ams-cs/events{/privacy}", "received_events_url": "https://api.github.com/users/ams-cs/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "75161d2ca5a9a3c94e5c2ce6365046693a964368", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/75161d2ca5a9a3c94e5c2ce6365046693a964368", "html_url": "https://github.com/Rust-GCC/gccrs/commit/75161d2ca5a9a3c94e5c2ce6365046693a964368"}], "stats": {"total": 76, "additions": 71, "deletions": 5}, "files": [{"sha": "f1b85a428f2377cf48cfb7af4b582dad1228cb46", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a6f969f4cb4b8363b2f20f942d36dd96906ba253", "patch": "@@ -1,3 +1,12 @@\n+2011-08-19  Andrew Stubbs  <ams@codesourcery.com>\n+\n+\t* tree-ssa-math-opts.c (is_widening_mult_rhs_p): Handle constants\n+\tbeyond conversions.\n+\t(convert_mult_to_widen): Convert constant inputs to the right type.\n+\t(convert_plusminus_to_widen): Don't automatically reject inputs that\n+\tare not an SSA_NAME.\n+\tConvert constant inputs to the right type.\n+\n 2011-08-19  Andrew Stubbs  <ams@codesourcery.com>\n \n \t* tree-ssa-math-opts.c (convert_plusminus_to_widen): Convert add_rhs"}, {"sha": "ced6263db50d22d5bff33ca399e7b2e956d2a29a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a6f969f4cb4b8363b2f20f942d36dd96906ba253", "patch": "@@ -1,3 +1,9 @@\n+2011-08-19  Andrew Stubbs  <ams@codesourcery.com>\n+\n+\t* gcc.target/arm/wmul-11.c: New file.\n+\t* gcc.target/arm/wmul-12.c: New file.\n+\t* gcc.target/arm/wmul-13.c: New file.\n+\n 2011-08-19  Andrew Stubbs  <ams@codesourcery.com>\n \n \t* gcc.target/arm/wmul-10.c: New file."}, {"sha": "904f0153a8e80811b74a3eb78dbd90c1154be7a9", "filename": "gcc/testsuite/gcc.target/arm/wmul-11.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-11.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-11.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-11.c?ref=a6f969f4cb4b8363b2f20f942d36dd96906ba253", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2\" } */\n+/* { dg-require-effective-target arm_dsp } */\n+\n+long long\n+foo (int *b)\n+{\n+  return 10 * (long long)*b;\n+}\n+\n+/* { dg-final { scan-assembler \"smull\" } } */"}, {"sha": "556e53f8e44b2fcddcd23f02ca6b067f7be48590", "filename": "gcc/testsuite/gcc.target/arm/wmul-12.c", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-12.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-12.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-12.c?ref=a6f969f4cb4b8363b2f20f942d36dd96906ba253", "patch": "@@ -0,0 +1,12 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2\" } */\n+/* { dg-require-effective-target arm_dsp } */\n+\n+long long\n+foo (int *b, int *c)\n+{\n+  int tmp = *b * *c;\n+  return 10 + (long long)tmp;\n+}\n+\n+/* { dg-final { scan-assembler \"smlal\" } } */"}, {"sha": "a73d80f63c3a45fe61ea77e51e1d70818da80eea", "filename": "gcc/testsuite/gcc.target/arm/wmul-13.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-13.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-13.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Farm%2Fwmul-13.c?ref=a6f969f4cb4b8363b2f20f942d36dd96906ba253", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2\" } */\n+/* { dg-require-effective-target arm_dsp } */\n+\n+long long\n+foo (int *a, int *b)\n+{\n+  return *a + (long long)*b * 10;\n+}\n+\n+/* { dg-final { scan-assembler \"smlal\" } } */"}, {"sha": "63506477a3990db22a6c2ab0a6bf9bb791110fa6", "filename": "gcc/tree-ssa-math-opts.c", "status": "modified", "additions": 22, "deletions": 5, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftree-ssa-math-opts.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a6f969f4cb4b8363b2f20f942d36dd96906ba253/gcc%2Ftree-ssa-math-opts.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-math-opts.c?ref=a6f969f4cb4b8363b2f20f942d36dd96906ba253", "patch": "@@ -1995,7 +1995,16 @@ is_widening_mult_rhs_p (tree type, tree rhs, tree *type_out,\n \t      : rhs_code != FIXED_CONVERT_EXPR)\n \t    rhs1 = rhs;\n \t  else\n-\t    rhs1 = gimple_assign_rhs1 (stmt);\n+\t    {\n+\t      rhs1 = gimple_assign_rhs1 (stmt);\n+\n+\t      if (TREE_CODE (rhs1) == INTEGER_CST)\n+\t\t{\n+\t\t  *new_rhs_out = rhs1;\n+\t\t  *type_out = NULL;\n+\t\t  return true;\n+\t\t}\n+\t    }\n \t}\n       else\n \trhs1 = rhs;\n@@ -2164,6 +2173,12 @@ convert_mult_to_widen (gimple stmt, gimple_stmt_iterator *gsi)\n       rhs2 = build_and_insert_cast (gsi, loc, tmp, rhs2);\n     }\n \n+  /* Handle constants.  */\n+  if (TREE_CODE (rhs1) == INTEGER_CST)\n+    rhs1 = fold_convert (type1, rhs1);\n+  if (TREE_CODE (rhs2) == INTEGER_CST)\n+    rhs2 = fold_convert (type2, rhs2);\n+\n   gimple_assign_set_rhs1 (stmt, rhs1);\n   gimple_assign_set_rhs2 (stmt, rhs2);\n   gimple_assign_set_rhs_code (stmt, WIDEN_MULT_EXPR);\n@@ -2215,17 +2230,13 @@ convert_plusminus_to_widen (gimple_stmt_iterator *gsi, gimple stmt,\n       if (is_gimple_assign (rhs1_stmt))\n \trhs1_code = gimple_assign_rhs_code (rhs1_stmt);\n     }\n-  else\n-    return false;\n \n   if (TREE_CODE (rhs2) == SSA_NAME)\n     {\n       rhs2_stmt = SSA_NAME_DEF_STMT (rhs2);\n       if (is_gimple_assign (rhs2_stmt))\n \trhs2_code = gimple_assign_rhs_code (rhs2_stmt);\n     }\n-  else\n-    return false;\n \n   /* Allow for one conversion statement between the multiply\n      and addition/subtraction statement.  If there are more than\n@@ -2373,6 +2384,12 @@ convert_plusminus_to_widen (gimple_stmt_iterator *gsi, gimple stmt,\n     add_rhs = build_and_insert_cast (gsi, loc, create_tmp_var (type, NULL),\n \t\t\t\t     add_rhs);\n \n+  /* Handle constants.  */\n+  if (TREE_CODE (mult_rhs1) == INTEGER_CST)\n+    rhs1 = fold_convert (type1, mult_rhs1);\n+  if (TREE_CODE (mult_rhs2) == INTEGER_CST)\n+    rhs2 = fold_convert (type2, mult_rhs2);\n+\n   gimple_assign_set_rhs_with_ops_1 (gsi, wmult_code, mult_rhs1, mult_rhs2,\n \t\t\t\t    add_rhs);\n   update_stmt (gsi_stmt (*gsi));"}]}