{"sha": "a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "node_id": "C_kwDOANBUbNoAKGE4MmNlOWM4ZDE1NWVjZGEyZDFjNjQ3ZDVjNTg4ZjI5ZTIxZWY0YTM", "commit": {"author": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2023-01-25T22:19:54Z"}, "committer": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2023-01-26T17:59:17Z"}, "message": "opts: SANITIZE_ADDRESS wrongly cleared [PR108543]\n\nHere we crash on a null fndecl ultimately because we haven't defined\nthe built-ins described in sanitizer.def.  So\nbuiltin_decl_explicit (BUILT_IN_ASAN_POINTER_SUBTRACT);\nreturns NULL_TREE, causing an ICE later.\n\nDEF_SANITIZER_BUILTIN only actually defines the built-ins when flag_sanitize\nhas SANITIZE_ADDRESS, or some of the other SANITIZE_*, but it doesn't check\nSANITIZE_KERNEL_ADDRESS or SANITIZE_USER_ADDRESS.  Unfortunately, with\n-fsanitize=address -fno-sanitize=kernel-address\nor\n-fsanitize=kernel-address -fno-sanitize=address\nSANITIZE_ADDRESS ends up being unset from flag_sanitize even though\n_USER/_KERNEL are set.  That's because -fsanitize=address means\nSANITIZE_ADDRESS | SANITIZE_USER_ADDRESS and -fsanitize=kernel-address\nis SANITIZE_ADDRESS | SANITIZE_KERNEL_ADDRESS but parse_sanitizer_options\ndoes\n  flags &= ~sanitizer_opts[i].flag;\nso the subsequent -fno- unsets SANITIZE_ADDRESS.  Then no sanitizer\nbuilt-ins are actually defined.\n\nI'm not sure why SANITIZE_ADDRESS isn't just SANITIZE_USER_ADDRESS |\nSANITIZE_KERNEL_ADDRESS, I don't think we need 3 bits.\n\n\tPR middle-end/108543\n\ngcc/ChangeLog:\n\n\t* opts.cc (parse_sanitizer_options): Don't always clear SANITIZE_ADDRESS\n\tif it was previously set.\n\ngcc/testsuite/ChangeLog:\n\n\t* c-c++-common/asan/pointer-subtract-5.c: New test.\n\t* c-c++-common/asan/pointer-subtract-6.c: New test.\n\t* c-c++-common/asan/pointer-subtract-7.c: New test.\n\t* c-c++-common/asan/pointer-subtract-8.c: New test.", "tree": {"sha": "f1734094f3c014be00b7230cba8bc907c7a8155b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f1734094f3c014be00b7230cba8bc907c7a8155b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/comments", "author": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6dd4578f4779b27b2115d78226ff7df46c939061", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6dd4578f4779b27b2115d78226ff7df46c939061", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6dd4578f4779b27b2115d78226ff7df46c939061"}], "stats": {"total": 69, "additions": 68, "deletions": 1}, "files": [{"sha": "a032cd4ce5821bac5b4f10d5ec961d8c4b4c4d2a", "filename": "gcc/opts.cc", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Fopts.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Fopts.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fopts.cc?ref=a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "patch": "@@ -2246,7 +2246,14 @@ parse_sanitizer_options (const char *p, location_t loc, int scode,\n \t\t  flags |= sanitizer_opts[i].flag;\n \t      }\n \t    else\n-\t      flags &= ~sanitizer_opts[i].flag;\n+\t      {\n+\t\tflags &= ~sanitizer_opts[i].flag;\n+\t\t/* Don't always clear SANITIZE_ADDRESS if it was previously\n+\t\t   set: -fsanitize=address -fno-sanitize=kernel-address should\n+\t\t   leave SANITIZE_ADDRESS set.  */\n+\t\tif (flags & (SANITIZE_KERNEL_ADDRESS | SANITIZE_USER_ADDRESS))\n+\t\t  flags |= SANITIZE_ADDRESS;\n+\t      }\n \t    found = true;\n \t    break;\n \t  }"}, {"sha": "867eda0e61eb0841524dd5e2ed0e74d18771fed9", "filename": "gcc/testsuite/c-c++-common/asan/pointer-subtract-5.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-5.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-5.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-5.c?ref=a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "patch": "@@ -0,0 +1,15 @@\n+/* PR middle-end/108543 */\n+/* { dg-do compile  } */\n+/* { dg-options \"-fsanitize=address -fno-sanitize=kernel-address -fsanitize=pointer-subtract\" } */\n+\n+struct S {\n+  long _M_p;\n+};\n+\n+typedef struct S S;\n+\n+__PTRDIFF_TYPE__\n+f (S __x, S __y)\n+{\n+  return &__x._M_p - &__y._M_p;\n+}"}, {"sha": "785b90b3d9837ce7aa6015d0e92ac4b54a309e2a", "filename": "gcc/testsuite/c-c++-common/asan/pointer-subtract-6.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-6.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-6.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-6.c?ref=a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "patch": "@@ -0,0 +1,15 @@\n+/* PR middle-end/108543 */\n+/* { dg-do compile  } */\n+/* { dg-options \"-fsanitize=kernel-address -fno-sanitize=address -fsanitize=pointer-subtract\" } */\n+\n+struct S {\n+  long _M_p;\n+};\n+\n+typedef struct S S;\n+\n+__PTRDIFF_TYPE__\n+f (S __x, S __y)\n+{\n+  return &__x._M_p - &__y._M_p;\n+}"}, {"sha": "11b63401b8cebe570b7d1dd2b4224b4a9ae09f30", "filename": "gcc/testsuite/c-c++-common/asan/pointer-subtract-7.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-7.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-7.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-7.c?ref=a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "patch": "@@ -0,0 +1,15 @@\n+/* PR middle-end/108543 */\n+/* { dg-do compile  } */\n+/* { dg-options \"-fno-sanitize=kernel-address -fsanitize=address -fsanitize=pointer-subtract\" } */\n+\n+struct S {\n+  long _M_p;\n+};\n+\n+typedef struct S S;\n+\n+__PTRDIFF_TYPE__\n+f (S __x, S __y)\n+{\n+  return &__x._M_p - &__y._M_p;\n+}"}, {"sha": "ac2b9c3c1d930b920c296fb094488956badb73e7", "filename": "gcc/testsuite/c-c++-common/asan/pointer-subtract-8.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-8.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-8.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fasan%2Fpointer-subtract-8.c?ref=a82ce9c8d155ecda2d1c647d5c588f29e21ef4a3", "patch": "@@ -0,0 +1,15 @@\n+/* PR middle-end/108543 */\n+/* { dg-do compile  } */\n+/* { dg-options \"-fno-sanitize=address -fsanitize=kernel-address -fsanitize=pointer-subtract\" } */\n+\n+struct S {\n+  long _M_p;\n+};\n+\n+typedef struct S S;\n+\n+__PTRDIFF_TYPE__\n+f (S __x, S __y)\n+{\n+  return &__x._M_p - &__y._M_p;\n+}"}]}