{"sha": "87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODdhNWUwZThjNjVjMDA2NmY0OTdkNTRlODhmZjJjMWRjNmViM2E5Nw==", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2017-12-15T13:43:30Z"}, "committer": {"name": "Richard Biener", "email": "rguenth@gcc.gnu.org", "date": "2017-12-15T13:43:30Z"}, "message": "re PR sanitizer/83388 (reference statement index not found error with -fsanitize=null)\n\n2017-12-15  Richard Biener  <rguenther@suse.de>\n\n\tPR lto/83388\n\t* internal-fn.def (IFN_NOP): Add.\n\t* internal-fn.c (expand_NOP): Do nothing.\n\t* lto-streamer-in.c (input_function): Instead of removing\n\tsanitizer calls replace them with IFN_NOP calls.\n\n\t* gcc.dg/lto/pr83388_0.c: New testcase.\n\nFrom-SVN: r255694", "tree": {"sha": "a442253ccfb98e3c85928b6d9227ba0d841b55f8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a442253ccfb98e3c85928b6d9227ba0d841b55f8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "html_url": "https://github.com/Rust-GCC/gccrs/commit/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "fc47ef60c5d11d0302a4f4831080fde792430781", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fc47ef60c5d11d0302a4f4831080fde792430781", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fc47ef60c5d11d0302a4f4831080fde792430781"}], "stats": {"total": 64, "additions": 56, "deletions": 8}, "files": [{"sha": "3282f489370807c3a96c7f2181dcd23beb95e497", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "patch": "@@ -1,3 +1,11 @@\n+2017-12-15  Richard Biener  <rguenther@suse.de>\n+\n+\tPR lto/83388\n+\t* internal-fn.def (IFN_NOP): Add.\n+\t* internal-fn.c (expand_NOP): Do nothing.\n+\t* lto-streamer-in.c (input_function): Instead of removing\n+\tsanitizer calls replace them with IFN_NOP calls.\n+\n 2017-12-15  Richard Sandiford  <richard.sandiford@linaro.org>\n \t    Alan Hayward  <alan.hayward@arm.com>\n \t    David Sherwood  <david.sherwood@arm.com>"}, {"sha": "21e7b104eec3b38e4ee683e6bae60c7366190492", "filename": "gcc/internal-fn.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Finternal-fn.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Finternal-fn.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Finternal-fn.c?ref=87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "patch": "@@ -2722,6 +2722,14 @@ expand_DIVMOD (internal_fn, gcall *call_stmt)\n \t       target, VOIDmode, EXPAND_NORMAL);\n }\n \n+/* Expand a NOP.  */\n+\n+static void\n+expand_NOP (internal_fn, gcall *)\n+{\n+  /* Nothing.  But it shouldn't really prevail.  */\n+}\n+\n /* Expand a call to FN using the operands in STMT.  FN has a single\n    output operand and NARGS input operands.  */\n "}, {"sha": "07f9208b0acdf04a540c6fcf92bb0e49bc785156", "filename": "gcc/internal-fn.def", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Finternal-fn.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Finternal-fn.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Finternal-fn.def?ref=87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "patch": "@@ -254,6 +254,9 @@ DEF_INTERNAL_FN (LAUNDER, ECF_LEAF | ECF_NOTHROW | ECF_NOVOPS, NULL)\n /* Divmod function.  */\n DEF_INTERNAL_FN (DIVMOD, ECF_CONST | ECF_LEAF, NULL)\n \n+/* A NOP function with arbitrary arguments and return value.  */\n+DEF_INTERNAL_FN (NOP, ECF_CONST | ECF_LEAF | ECF_NOTHROW, NULL)\n+\n #undef DEF_INTERNAL_INT_FN\n #undef DEF_INTERNAL_FLT_FN\n #undef DEF_INTERNAL_FLT_FLOATN_FN"}, {"sha": "a313b25907d71a1f5a35a9e85f686833d9c9a5fd", "filename": "gcc/lto-streamer-in.c", "status": "modified", "additions": 14, "deletions": 8, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Flto-streamer-in.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Flto-streamer-in.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-in.c?ref=87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "patch": "@@ -1136,41 +1136,47 @@ input_function (tree fn_decl, struct data_in *data_in,\n \t      if (is_gimple_call (stmt)\n \t\t  && gimple_call_internal_p (stmt))\n \t\t{\n+\t\t  bool replace = false;\n \t\t  switch (gimple_call_internal_fn (stmt))\n \t\t    {\n \t\t    case IFN_UBSAN_NULL:\n \t\t      if ((flag_sanitize\n \t\t\t  & (SANITIZE_NULL | SANITIZE_ALIGNMENT)) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    case IFN_UBSAN_BOUNDS:\n \t\t      if ((flag_sanitize & SANITIZE_BOUNDS) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    case IFN_UBSAN_VPTR:\n \t\t      if ((flag_sanitize & SANITIZE_VPTR) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    case IFN_UBSAN_OBJECT_SIZE:\n \t\t      if ((flag_sanitize & SANITIZE_OBJECT_SIZE) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    case IFN_UBSAN_PTR:\n \t\t      if ((flag_sanitize & SANITIZE_POINTER_OVERFLOW) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    case IFN_ASAN_MARK:\n \t\t      if ((flag_sanitize & SANITIZE_ADDRESS) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    case IFN_TSAN_FUNC_EXIT:\n \t\t      if ((flag_sanitize & SANITIZE_THREAD) == 0)\n-\t\t\tremove = true;\n+\t\t\treplace = true;\n \t\t      break;\n \t\t    default:\n \t\t      break;\n \t\t    }\n-\t\t  gcc_assert (!remove || gimple_call_lhs (stmt) == NULL_TREE);\n+\t\t  if (replace)\n+\t\t    {\n+\t\t      gimple_call_set_internal_fn (as_a <gcall *> (stmt),\n+\t\t\t\t\t\t   IFN_NOP);\n+\t\t      update_stmt (stmt);\n+\t\t    }\n \t\t}\n \t    }\n \t  if (remove)"}, {"sha": "1477cabcacbf039b748ed6cd09e9300fbad00da1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "patch": "@@ -1,3 +1,8 @@\n+2017-12-15  Richard Biener  <rguenther@suse.de>\n+\n+\tPR lto/83388\n+\t* gcc.dg/lto/pr83388_0.c: New testcase.\n+\n 2017-12-15  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/expr_func2.ads, gnat.dg/expr_func2.adb: New testcase."}, {"sha": "4febbac06da05a53548f611ded1cd8f625ece959", "filename": "gcc/testsuite/gcc.dg/lto/pr83388_0.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Ftestsuite%2Fgcc.dg%2Flto%2Fpr83388_0.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97/gcc%2Ftestsuite%2Fgcc.dg%2Flto%2Fpr83388_0.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Flto%2Fpr83388_0.c?ref=87a5e0e8c65c0066f497d54e88ff2c1dc6eb3a97", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-lto-do link } */\n+/* { dg-lto-options { { -O2 -flto -fsanitize=null } { -O0 -flto -fsanitize=null } } } */\n+/* { dg-extra-ld-options { -fno-sanitize=null -r -nostdlib } } */\n+\n+enum { a } e(void);\n+struct C {\n+    int d;\n+} c;\n+long f;\n+void g(long);\n+static void i(_Bool h) {\n+    struct C *a = ({ ({ &c; }); });\n+    if (e()) {\n+\tint b = a->d;\n+\tg(f);\n+    }\n+}\n+void j(void) { i(a); }"}]}