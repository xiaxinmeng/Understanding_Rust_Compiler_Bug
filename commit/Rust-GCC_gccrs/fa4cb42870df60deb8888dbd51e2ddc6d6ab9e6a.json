{"sha": "fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a", "node_id": "C_kwDOANBUbNoAKGZhNGNiNDI4NzBkZjYwZGViODg4OGRiZDUxZTJkZGM2ZDZhYjllNmE", "commit": {"author": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2023-04-14T18:45:19Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2023-04-14T18:50:02Z"}, "message": "Fortran: fix compile-time simplification of SET_EXPONENT [PR109511]\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/109511\n\t* simplify.cc (gfc_simplify_set_exponent): Fix implementation of\n\tcompile-time simplification of intrinsic SET_EXPONENT for argument\n\tX < 1 and for I < 0.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/109511\n\t* gfortran.dg/set_exponent_1.f90: New test.", "tree": {"sha": "59e44f0a3f40031dd7c72d9aa5b3af0359e567ca", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/59e44f0a3f40031dd7c72d9aa5b3af0359e567ca"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a/comments", "author": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "94a21e008c4778e446321b1355f61abc75a076be", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94a21e008c4778e446321b1355f61abc75a076be", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94a21e008c4778e446321b1355f61abc75a076be"}], "stats": {"total": 48, "additions": 42, "deletions": 6}, "files": [{"sha": "b65854c102173573e32bd200316c811f836c78a2", "filename": "gcc/fortran/simplify.cc", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a/gcc%2Ffortran%2Fsimplify.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a/gcc%2Ffortran%2Fsimplify.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fsimplify.cc?ref=fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a", "patch": "@@ -7364,7 +7364,7 @@ gfc_simplify_set_exponent (gfc_expr *x, gfc_expr *i)\n {\n   gfc_expr *result;\n   mpfr_t exp, absv, log2, pow2, frac;\n-  unsigned long exp2;\n+  long exp2;\n \n   if (x->expr_type != EXPR_CONSTANT || i->expr_type != EXPR_CONSTANT)\n     return NULL;\n@@ -7396,19 +7396,19 @@ gfc_simplify_set_exponent (gfc_expr *x, gfc_expr *i)\n   mpfr_abs (absv, x->value.real, GFC_RND_MODE);\n   mpfr_log2 (log2, absv, GFC_RND_MODE);\n \n-  mpfr_trunc (log2, log2);\n+  mpfr_floor (log2, log2);\n   mpfr_add_ui (exp, log2, 1, GFC_RND_MODE);\n \n   /* Old exponent value, and fraction.  */\n   mpfr_ui_pow (pow2, 2, exp, GFC_RND_MODE);\n \n-  mpfr_div (frac, absv, pow2, GFC_RND_MODE);\n+  mpfr_div (frac, x->value.real, pow2, GFC_RND_MODE);\n \n   /* New exponent.  */\n-  exp2 = (unsigned long) mpz_get_d (i->value.integer);\n-  mpfr_mul_2exp (result->value.real, frac, exp2, GFC_RND_MODE);\n+  exp2 = mpz_get_si (i->value.integer);\n+  mpfr_mul_2si (result->value.real, frac, exp2, GFC_RND_MODE);\n \n-  mpfr_clears (absv, log2, pow2, frac, NULL);\n+  mpfr_clears (absv, log2, exp, pow2, frac, NULL);\n \n   return range_check (result, \"SET_EXPONENT\");\n }"}, {"sha": "4c063e8330bdebe34f1c59386324db797a6c97e3", "filename": "gcc/testsuite/gfortran.dg/set_exponent_1.f90", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a/gcc%2Ftestsuite%2Fgfortran.dg%2Fset_exponent_1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a/gcc%2Ftestsuite%2Fgfortran.dg%2Fset_exponent_1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fset_exponent_1.f90?ref=fa4cb42870df60deb8888dbd51e2ddc6d6ab9e6a", "patch": "@@ -0,0 +1,36 @@\n+! { dg-do run }\n+! PR fortran/109511\n+! Check compile-time simplification of SET_EXPONENT against runtime\n+\n+program exponent\n+  implicit none\n+  integer :: i\n+  i = 0\n+  print *, i, set_exponent(1., 0), set_exponent(1., i)\n+  if (set_exponent(1., 0) /= set_exponent(1., i)) stop 1\n+  i = 1\n+  print *, i, set_exponent(1., 1), set_exponent(1., i)\n+  if (set_exponent(1., 1) /= set_exponent(1., i)) stop 2\n+  i = 2\n+  print *, i, set_exponent(-1.75, 2), set_exponent(-1.75, i)\n+  if (set_exponent(-1.75, 2) /= set_exponent(-1.75, i)) stop 3\n+  print *, i, set_exponent(0.1875, 2), set_exponent(0.1875, i)\n+  if (set_exponent(0.1875, 2) /= set_exponent(0.1875, i)) stop 4\n+  i = 3\n+  print *, i, set_exponent(0.75, 3), set_exponent(0.75, i)\n+  if (set_exponent(0.75, 3) /= set_exponent(0.75, i)) stop 5\n+  i = 4\n+  print *, i, set_exponent(-2.5, 4), set_exponent(-2.5, i)\n+  if (set_exponent(-2.5, 4) /= set_exponent(-2.5, i)) stop 6\n+  i = -1\n+  print *, i, set_exponent(1., -1), set_exponent(1., i)\n+  if (set_exponent(1., -1) /= set_exponent(1., i)) stop 7\n+  i = -2\n+  print *, i, set_exponent(1.125, -2), set_exponent(1.125, i)\n+  if (set_exponent(1.125, -2) /= set_exponent(1.125, i)) stop 8\n+  print *, i, set_exponent(-0.25, -2), set_exponent(-0.25, i)\n+  if (set_exponent(-0.25, -2) /= set_exponent(-0.25, i)) stop 9\n+  i = -3\n+  print *, i, set_exponent(0.75, -3), set_exponent(0.75, i)\n+  if (set_exponent(0.75, -3) /= set_exponent(0.75, i)) stop 10\n+end program exponent"}]}