{"sha": "b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjliZmJmNDU0MTlhNjQxYzBiOTJiMTk1NGI5NGI3M2NiM2RmYjkzNQ==", "commit": {"author": {"name": "Vadim Godunko", "email": "godunko@adacore.com", "date": "2019-09-17T08:01:37Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-09-17T08:01:37Z"}, "message": "[Ada] Avoid to close irrelevant file descriptors\n\n'Close' subprogram of GNAT.Expect can close irrelevant file descriptors\nwhen 'Expect' was terminated by Process_Died exception and any file open\noperations was done before call to 'Close'.\n\n2019-09-17  Vadim Godunko  <godunko@adacore.com>\n\ngcc/ada/\n\n\t* libgnat/g-expect.ads, libgnat/g-expect.adb (Close_Input): New\n\tsubprogram.\n\t(Get_Command_Output): Call Close_Input to close input stream.\n\t(Expect_Internal): Likewise.\n\t(Close): Likewise.\n\t* libgnat/g-exptty.adb (Close): Likewise.\n\ngcc/testsuite/\n\n\t* gnat.dg/expect3.adb: New testcase.\n\nFrom-SVN: r275781", "tree": {"sha": "3414ebf9359be4033522a266d02d86152200964d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3414ebf9359be4033522a266d02d86152200964d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/comments", "author": {"login": "godunko", "id": 23206960, "node_id": "MDQ6VXNlcjIzMjA2OTYw", "avatar_url": "https://avatars.githubusercontent.com/u/23206960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/godunko", "html_url": "https://github.com/godunko", "followers_url": "https://api.github.com/users/godunko/followers", "following_url": "https://api.github.com/users/godunko/following{/other_user}", "gists_url": "https://api.github.com/users/godunko/gists{/gist_id}", "starred_url": "https://api.github.com/users/godunko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/godunko/subscriptions", "organizations_url": "https://api.github.com/users/godunko/orgs", "repos_url": "https://api.github.com/users/godunko/repos", "events_url": "https://api.github.com/users/godunko/events{/privacy}", "received_events_url": "https://api.github.com/users/godunko/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "ee7c961db9da34d3e437eba0088f7291a7a5dfb4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ee7c961db9da34d3e437eba0088f7291a7a5dfb4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ee7c961db9da34d3e437eba0088f7291a7a5dfb4"}], "stats": {"total": 97, "additions": 83, "deletions": 14}, "files": [{"sha": "c952898352fac1bd2a13d97b197d18bdab307470", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "patch": "@@ -1,3 +1,12 @@\n+2019-09-17  Vadim Godunko  <godunko@adacore.com>\n+\n+\t* libgnat/g-expect.ads, libgnat/g-expect.adb (Close_Input): New\n+\tsubprogram.\n+\t(Get_Command_Output): Call Close_Input to close input stream.\n+\t(Expect_Internal): Likewise.\n+\t(Close): Likewise.\n+\t* libgnat/g-exptty.adb (Close): Likewise.\n+\n 2019-09-17  Piotr Trojanek  <trojanek@adacore.com>\n \n \t* sem_util.ads, sem_util.adb (Is_Attribute_Old): New utility"}, {"sha": "b44c7a5f016691ec1250655cc0815c8bc7cc8ccb", "filename": "gcc/ada/libgnat/g-expect.adb", "status": "modified", "additions": 32, "deletions": 11, "changes": 43, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2Flibgnat%2Fg-expect.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2Flibgnat%2Fg-expect.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-expect.adb?ref=b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "patch": "@@ -222,15 +222,17 @@ package body GNAT.Expect is\n       Next_Filter    : Filter_List;\n \n    begin\n-      if Descriptor.Input_Fd /= Invalid_FD then\n-         Close (Descriptor.Input_Fd);\n-      end if;\n+      Close_Input (Descriptor);\n \n-      if Descriptor.Error_Fd /= Descriptor.Output_Fd then\n+      if Descriptor.Error_Fd /= Descriptor.Output_Fd\n+        and then Descriptor.Error_Fd /= Invalid_FD\n+      then\n          Close (Descriptor.Error_Fd);\n       end if;\n \n-      Close (Descriptor.Output_Fd);\n+      if Descriptor.Output_Fd /= Invalid_FD then\n+         Close (Descriptor.Output_Fd);\n+      end if;\n \n       --  ??? Should have timeouts for different signals\n \n@@ -267,6 +269,27 @@ package body GNAT.Expect is\n       Close (Descriptor, Status);\n    end Close;\n \n+   -----------------\n+   -- Close_Input --\n+   -----------------\n+\n+   procedure Close_Input (Pid : in out Process_Descriptor) is\n+   begin\n+      if Pid.Input_Fd /= Invalid_FD then\n+         Close (Pid.Input_Fd);\n+      end if;\n+\n+      if Pid.Output_Fd = Pid.Input_Fd then\n+         Pid.Output_Fd := Invalid_FD;\n+      end if;\n+\n+      if Pid.Error_Fd = Pid.Input_Fd then\n+         Pid.Error_Fd := Invalid_FD;\n+      end if;\n+\n+      Pid.Input_Fd := Invalid_FD;\n+   end Close_Input;\n+\n    ------------\n    -- Expect --\n    ------------\n@@ -667,8 +690,7 @@ package body GNAT.Expect is\n                   Result := Expect_Internal_Error;\n \n                   if D /= 0 then\n-                     Close (Descriptors (D).Input_Fd);\n-                     Descriptors (D).Input_Fd := Invalid_FD;\n+                     Close_Input (Descriptors (D).all);\n                   end if;\n \n                   return;\n@@ -707,9 +729,9 @@ package body GNAT.Expect is\n                         --  Error or End of file\n \n                         if N <= 0 then\n-                           Close (Descriptors (D).Input_Fd);\n-                           Descriptors (D).Input_Fd := Invalid_FD;\n+                           Close_Input (Descriptors (D).all);\n                            Result := Expect_Process_Died;\n+\n                            return;\n \n                         else\n@@ -931,8 +953,7 @@ package body GNAT.Expect is\n          Send (Process, Input);\n       end if;\n \n-      Close (Process.Input_Fd);\n-      Process.Input_Fd := Invalid_FD;\n+      Close_Input (Process);\n \n       declare\n          Result : Expect_Match;"}, {"sha": "77bb579212bf8396fdb8475c2da7efb9b427743b", "filename": "gcc/ada/libgnat/g-expect.ads", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2Flibgnat%2Fg-expect.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2Flibgnat%2Fg-expect.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-expect.ads?ref=b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "patch": "@@ -613,6 +613,10 @@ private\n    --  spawns the child process (based on Cmd). On systems that support fork,\n    --  this procedure is executed inside the newly created process.\n \n+   procedure Close_Input (Pid : in out Process_Descriptor);\n+   --  Closes input file descriptor. Set Input_Fd to Invalid_Fd as well as\n+   --  Output_Fd and Error_Fd when they share same file descriptor.\n+\n    type Process_Descriptor is tagged record\n       Pid              : aliased Process_Id := Invalid_Pid;\n       Input_Fd         : GNAT.OS_Lib.File_Descriptor := GNAT.OS_Lib.Invalid_FD;"}, {"sha": "4f0300fbd8d63206bf5ed14ae0f681f8ff44e26f", "filename": "gcc/ada/libgnat/g-exptty.adb", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2Flibgnat%2Fg-exptty.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Fada%2Flibgnat%2Fg-exptty.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-exptty.adb?ref=b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "patch": "@@ -93,9 +93,7 @@ package body GNAT.Expect.TTY is\n          --  signal, so this needs to be done while the file descriptors are\n          --  still open (it used to be after the closes and that was wrong).\n \n-         if Descriptor.Input_Fd /= Invalid_FD then\n-            Close (Descriptor.Input_Fd);\n-         end if;\n+         Close_Input (Descriptor);\n \n          if Descriptor.Error_Fd /= Descriptor.Output_Fd\n            and then Descriptor.Error_Fd /= Invalid_FD"}, {"sha": "caed11b9ba3919c9c06bb65228e3ad573fda035c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "patch": "@@ -1,3 +1,7 @@\n+2019-09-17  Vadim Godunko  <godunko@adacore.com>\n+\n+\t* gnat.dg/expect3.adb: New testcase.\n+\n 2019-09-17  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/predicate13.adb, gnat.dg/predicate13.ads: New"}, {"sha": "a833ea9945b8cd900ae391c9a1b1bdfc56dd5c62", "filename": "gcc/testsuite/gnat.dg/expect3.adb", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Ftestsuite%2Fgnat.dg%2Fexpect3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9bfbf45419a641c0b92b1954b94b73cb3dfb935/gcc%2Ftestsuite%2Fgnat.dg%2Fexpect3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fexpect3.adb?ref=b9bfbf45419a641c0b92b1954b94b73cb3dfb935", "patch": "@@ -0,0 +1,33 @@\n+--  { dg-do run }\n+\n+with Ada.Text_IO;\n+\n+with GNAT.Expect.TTY;\n+with GNAT.OS_Lib;\n+\n+procedure Expect3 is\n+   Pid    : GNAT.Expect.TTY.TTY_Process_Descriptor;\n+   Args   : GNAT.OS_Lib.Argument_List (1 .. 0);\n+   Result : GNAT.Expect.Expect_Match;\n+\n+begin\n+   Pid.Non_Blocking_Spawn (\"true\", Args);\n+\n+   begin\n+      Pid.Expect (Result, \".*\");\n+\n+      raise Program_Error;\n+\n+   exception\n+      when GNAT.Expect.Process_Died =>\n+         declare\n+            File : Ada.Text_IO.File_Type;\n+\n+         begin\n+            Ada.Text_IO.Create (File);\n+            Pid.Close;\n+            Ada.Text_IO.Put_Line (File, \"Test of write operation\");\n+            Ada.Text_IO.Close (File);\n+         end;\n+   end;\n+end Expect3;\n\\ No newline at end of file"}]}