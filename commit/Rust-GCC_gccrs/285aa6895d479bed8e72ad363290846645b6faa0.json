{"sha": "285aa6895d479bed8e72ad363290846645b6faa0", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Mjg1YWE2ODk1ZDQ3OWJlZDhlNzJhZDM2MzI5MDg0NjY0NWI2ZmFhMA==", "commit": {"author": {"name": "Eugene Rozenfeld", "email": "erozen@microsoft.com", "date": "2021-08-03T01:36:09Z"}, "committer": {"name": "Eugene Rozenfeld", "email": "erozen@microsoft.com", "date": "2021-08-03T21:36:33Z"}, "message": "Fix indirect call inlining with AutoFDO\n\nThe histogram value for indirect calls was incorrectly set up.\nThat is fixed now.\n\nWith this change the tree-prof tests checking indirect call inlining with AutoFDO\nin gcc.dg and g++.dg are passing.\n\nResolves:\nPR gcov-profile/71672 - inlining indirect calls does not work with autofdo\n\ngcc/ChangeLog:\n\tPR gcov-profile/71672\n\t* auto-profile.c (afdo_indirect_call): Fix setup of the historgram value for indirect calls.", "tree": {"sha": "90d3dc66ddf7d0008b575b91b69b4f0889231d1f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/90d3dc66ddf7d0008b575b91b69b4f0889231d1f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/285aa6895d479bed8e72ad363290846645b6faa0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/285aa6895d479bed8e72ad363290846645b6faa0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/285aa6895d479bed8e72ad363290846645b6faa0", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/285aa6895d479bed8e72ad363290846645b6faa0/comments", "author": {"login": "erozenfeld", "id": 10624223, "node_id": "MDQ6VXNlcjEwNjI0MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/10624223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erozenfeld", "html_url": "https://github.com/erozenfeld", "followers_url": "https://api.github.com/users/erozenfeld/followers", "following_url": "https://api.github.com/users/erozenfeld/following{/other_user}", "gists_url": "https://api.github.com/users/erozenfeld/gists{/gist_id}", "starred_url": "https://api.github.com/users/erozenfeld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erozenfeld/subscriptions", "organizations_url": "https://api.github.com/users/erozenfeld/orgs", "repos_url": "https://api.github.com/users/erozenfeld/repos", "events_url": "https://api.github.com/users/erozenfeld/events{/privacy}", "received_events_url": "https://api.github.com/users/erozenfeld/received_events", "type": "User", "site_admin": false}, "committer": {"login": "erozenfeld", "id": 10624223, "node_id": "MDQ6VXNlcjEwNjI0MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/10624223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erozenfeld", "html_url": "https://github.com/erozenfeld", "followers_url": "https://api.github.com/users/erozenfeld/followers", "following_url": "https://api.github.com/users/erozenfeld/following{/other_user}", "gists_url": "https://api.github.com/users/erozenfeld/gists{/gist_id}", "starred_url": "https://api.github.com/users/erozenfeld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erozenfeld/subscriptions", "organizations_url": "https://api.github.com/users/erozenfeld/orgs", "repos_url": "https://api.github.com/users/erozenfeld/repos", "events_url": "https://api.github.com/users/erozenfeld/events{/privacy}", "received_events_url": "https://api.github.com/users/erozenfeld/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9265b378531391498ec1727f67a45da72a6c07e9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9265b378531391498ec1727f67a45da72a6c07e9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9265b378531391498ec1727f67a45da72a6c07e9"}], "stats": {"total": 13, "additions": 9, "deletions": 4}, "files": [{"sha": "4c1fc6b536bcb0f986cad3b0cdf58b5407bfb63d", "filename": "gcc/auto-profile.c", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/285aa6895d479bed8e72ad363290846645b6faa0/gcc%2Fauto-profile.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/285aa6895d479bed8e72ad363290846645b6faa0/gcc%2Fauto-profile.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fauto-profile.c?ref=285aa6895d479bed8e72ad363290846645b6faa0", "patch": "@@ -1009,13 +1009,18 @@ afdo_indirect_call (gimple_stmt_iterator *gsi, const icall_target_map &map,\n \n   histogram_value hist = gimple_alloc_histogram_value (\n       cfun, HIST_TYPE_INDIR_CALL, stmt, callee);\n-  hist->n_counters = 3;\n+  hist->n_counters = 4;\n   hist->hvalue.counters = XNEWVEC (gcov_type, hist->n_counters);\n   gimple_add_histogram_value (cfun, stmt, hist);\n \n-  hist->hvalue.counters[0] = direct_call->profile_id;\n-  hist->hvalue.counters[1] = max_iter->second;\n-  hist->hvalue.counters[2] = total;\n+  // Total counter\n+  hist->hvalue.counters[0] = total;\n+  // Number of value/counter pairs\n+  hist->hvalue.counters[1] = 1;\n+  // Value\n+  hist->hvalue.counters[2] = direct_call->profile_id;\n+  // Counter\n+  hist->hvalue.counters[3] = max_iter->second;\n \n   if (!transform)\n     return;"}]}