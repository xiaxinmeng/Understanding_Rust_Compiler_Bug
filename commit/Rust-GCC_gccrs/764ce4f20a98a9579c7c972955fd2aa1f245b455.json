{"sha": "764ce4f20a98a9579c7c972955fd2aa1f245b455", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzY0Y2U0ZjIwYTk4YTk1NzljN2M5NzI5NTVmZDJhYTFmMjQ1YjQ1NQ==", "commit": {"author": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2012-06-04T16:51:24Z"}, "committer": {"name": "Aldy Hernandez", "email": "aldyh@gcc.gnu.org", "date": "2012-06-04T16:51:24Z"}, "message": "re PR middle-end/47530 ([trans-mem] tail call optimization problem with _ITM_commitTransaction)\n\n        PR middle-end/47530\n        * trans-mem.c (expand_block_edges): Do not skip the first\n        statement when resetting the BB.\n\nFrom-SVN: r188190", "tree": {"sha": "227fc61acb843d8ba0a7ed57f7251484fbfc265c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/227fc61acb843d8ba0a7ed57f7251484fbfc265c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/764ce4f20a98a9579c7c972955fd2aa1f245b455", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/764ce4f20a98a9579c7c972955fd2aa1f245b455", "html_url": "https://github.com/Rust-GCC/gccrs/commit/764ce4f20a98a9579c7c972955fd2aa1f245b455", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/764ce4f20a98a9579c7c972955fd2aa1f245b455/comments", "author": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "be6b029b8cdf4c17a9f040332b8345f0fa13ed43", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/be6b029b8cdf4c17a9f040332b8345f0fa13ed43", "html_url": "https://github.com/Rust-GCC/gccrs/commit/be6b029b8cdf4c17a9f040332b8345f0fa13ed43"}], "stats": {"total": 46, "additions": 45, "deletions": 1}, "files": [{"sha": "174c1c131a34a9cd008dd7b63990936e7b946eab", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/764ce4f20a98a9579c7c972955fd2aa1f245b455/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/764ce4f20a98a9579c7c972955fd2aa1f245b455/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=764ce4f20a98a9579c7c972955fd2aa1f245b455", "patch": "@@ -1,3 +1,9 @@\n+2012-06-04  Aldy Hernandez  <aldyh@redhat.com>\n+\n+\tPR middle-end/47530\n+\t* trans-mem.c (expand_block_edges): Do not skip the first\n+\tstatement when resetting the BB.\n+\n 2012-06-04  Richard Guenther  <rguenther@suse.de>\n \n \t* tree-data-ref.c (stores_from_loop): Remove."}, {"sha": "c98e07e541868cfead6d69739b2282b784d28a61", "filename": "gcc/testsuite/g++.dg/tm/pr47530-2.C", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/764ce4f20a98a9579c7c972955fd2aa1f245b455/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftm%2Fpr47530-2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/764ce4f20a98a9579c7c972955fd2aa1f245b455/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftm%2Fpr47530-2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftm%2Fpr47530-2.C?ref=764ce4f20a98a9579c7c972955fd2aa1f245b455", "patch": "@@ -0,0 +1,35 @@\n+// { dg-do compile }\n+// { dg-options \"-fgnu-tm -O2 -fno-inline -fdump-tree-tmedge\" }\n+\n+class RBTree\n+{\n+    struct RBNode\n+    {\n+      RBNode* next;\n+    };\n+\n+  public:\n+    RBNode* sentinel;\n+    __attribute__((transaction_safe)) bool lookup();\n+};\n+\n+bool RBTree::lookup()\n+{\n+  RBNode* x = sentinel;\n+  while (x)\n+    x = x->next;\n+  return false;\n+}\n+\n+\n+RBTree* SET;\n+\n+void bench_test()\n+{\n+  __transaction_atomic { \n+      SET->lookup();\n+    }\n+}\n+\n+// { dg-final { scan-tree-dump-times \"ITM_commitTransaction.*tail call\" 0 \"tmedge\" } }\n+// { dg-final { cleanup-tree-dump \"tmedge\" } }"}, {"sha": "5aae8b213f11f2f8463e0062d0213258cfd3e528", "filename": "gcc/trans-mem.c", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/764ce4f20a98a9579c7c972955fd2aa1f245b455/gcc%2Ftrans-mem.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/764ce4f20a98a9579c7c972955fd2aa1f245b455/gcc%2Ftrans-mem.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftrans-mem.c?ref=764ce4f20a98a9579c7c972955fd2aa1f245b455", "patch": "@@ -2591,6 +2591,7 @@ expand_block_edges (struct tm_region *region, basic_block bb)\n \n   for (gsi = gsi_start_bb (bb); !gsi_end_p (gsi); )\n     {\n+      bool do_next = true;\n       gimple stmt = gsi_stmt (gsi);\n \n       /* ??? TM_COMMIT (and any other tm builtin function) in a nested\n@@ -2612,6 +2613,7 @@ expand_block_edges (struct tm_region *region, basic_block bb)\n \t      make_tm_edge (stmt, bb, region);\n \t      bb = e->dest;\n \t      gsi = gsi_start_bb (bb);\n+\t      do_next = false;\n \t    }\n \n \t  /* Delete any tail-call annotation that may have been added.\n@@ -2620,7 +2622,8 @@ expand_block_edges (struct tm_region *region, basic_block bb)\n \t  gimple_call_set_tail (stmt, false);\n \t}\n \n-      gsi_next (&gsi);\n+      if (do_next)\n+\tgsi_next (&gsi);\n     }\n }\n "}]}