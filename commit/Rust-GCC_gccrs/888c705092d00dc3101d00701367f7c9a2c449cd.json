{"sha": "888c705092d00dc3101d00701367f7c9a2c449cd", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODg4YzcwNTA5MmQwMGRjMzEwMWQwMDcwMTM2N2Y3YzlhMmM0NDljZA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-02-22T17:17:17Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-02-22T17:17:17Z"}, "message": "re PR target/70465 (Poor code for x87 asm)\n\n\tPR target/70465\n\t* reg-stack.c (emit_swap_insn): Treat (float_extend:?F (mem:?F))\n\tand (const_double:?F) like (mem:?F) for the purpose of fxch %st(1)\n\telimination by swapping fld*.\n\n\t* gcc.target/i386/pr70465-2.c: New test.\n\nFrom-SVN: r245654", "tree": {"sha": "1eea20ef1542e6beef457d80e3db01e9f8e09c54", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1eea20ef1542e6beef457d80e3db01e9f8e09c54"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/888c705092d00dc3101d00701367f7c9a2c449cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/888c705092d00dc3101d00701367f7c9a2c449cd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/888c705092d00dc3101d00701367f7c9a2c449cd", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/888c705092d00dc3101d00701367f7c9a2c449cd/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6d3daa1afb14de9fe828fa26e2cb2762a90247b0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6d3daa1afb14de9fe828fa26e2cb2762a90247b0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6d3daa1afb14de9fe828fa26e2cb2762a90247b0"}], "stats": {"total": 54, "additions": 49, "deletions": 5}, "files": [{"sha": "7585f37940bb1dd88db1b484359703a56d928c7e", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=888c705092d00dc3101d00701367f7c9a2c449cd", "patch": "@@ -1,3 +1,10 @@\n+2017-02-22  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/70465\n+\t* reg-stack.c (emit_swap_insn): Treat (float_extend:?F (mem:?F))\n+\tand (const_double:?F) like (mem:?F) for the purpose of fxch %st(1)\n+\telimination by swapping fld*.\n+\n 2017-02-22  Richard Biener  <rguenther@suse.de>\n \n \tPR tree-optimization/79673"}, {"sha": "41ae7e4fb9cdba8935b2210dc72396104b1b9a5e", "filename": "gcc/reg-stack.c", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2Freg-stack.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2Freg-stack.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Freg-stack.c?ref=888c705092d00dc3101d00701367f7c9a2c449cd", "patch": "@@ -895,12 +895,16 @@ emit_swap_insn (rtx_insn *insn, stack_ptr regstack, rtx reg)\n \t just use\n \t   fld b\n \t   fld a\n-         if possible.  */\n+\t if possible.  Similarly for fld1, fldz, fldpi etc. instead of any\n+\t of the loads or for float extension from memory.  */\n \n+      i1src = SET_SRC (i1set);\n+      if (GET_CODE (i1src) == FLOAT_EXTEND)\n+\ti1src = XEXP (i1src, 0);\n       if (REG_P (i1dest)\n \t  && REGNO (i1dest) == FIRST_STACK_REG\n-\t  && MEM_P (SET_SRC (i1set))\n-\t  && !side_effects_p (SET_SRC (i1set))\n+\t  && (MEM_P (i1src) || GET_CODE (i1src) == CONST_DOUBLE)\n+\t  && !side_effects_p (i1src)\n \t  && hard_regno == FIRST_STACK_REG + 1\n \t  && i1 != BB_HEAD (current_block))\n \t{\n@@ -930,16 +934,19 @@ emit_swap_insn (rtx_insn *insn, stack_ptr regstack, rtx reg)\n \t      && (i2set = single_set (i2)) != NULL_RTX)\n \t    {\n \t      rtx i2dest = *get_true_reg (&SET_DEST (i2set));\n+\t      rtx i2src = SET_SRC (i2set);\n+\t      if (GET_CODE (i2src) == FLOAT_EXTEND)\n+\t\ti2src = XEXP (i2src, 0);\n \t      /* If the last two insns before insn that involve\n \t\t stack regs are loads, where the latter (i1)\n \t\t pushes onto the register stack and thus\n \t\t moves the value from the first load (i2) from\n \t\t %st to %st(1), consider swapping them.  */\n \t      if (REG_P (i2dest)\n \t\t  && REGNO (i2dest) == FIRST_STACK_REG\n-\t\t  && MEM_P (SET_SRC (i2set))\n+\t\t  && (MEM_P (i2src) || GET_CODE (i2src) == CONST_DOUBLE)\n \t\t  /* Ensure i2 doesn't have other side-effects.  */\n-\t\t  && !side_effects_p (SET_SRC (i2set))\n+\t\t  && !side_effects_p (i2src)\n \t\t  /* And that the two instructions can actually be\n \t\t     swapped, i.e. there shouldn't be any stores\n \t\t     in between i2 and i1 that might alias with"}, {"sha": "395620c6c540ed7e2ba5aee7f749f5475670a28d", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=888c705092d00dc3101d00701367f7c9a2c449cd", "patch": "@@ -1,3 +1,8 @@\n+2017-02-22  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/70465\n+\t* gcc.target/i386/pr70465-2.c: New test.\n+\n 2017-02-21  Uros Bizjak  <ubizjak@gmail.com>\n \n \t* gcc.dg/pr61441.c: Use dg-add-options ieee."}, {"sha": "71b683aad70ef304ca047faadea8cebad6897924", "filename": "gcc/testsuite/gcc.target/i386/pr70465-2.c", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr70465-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/888c705092d00dc3101d00701367f7c9a2c449cd/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr70465-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr70465-2.c?ref=888c705092d00dc3101d00701367f7c9a2c449cd", "patch": "@@ -0,0 +1,25 @@\n+/* PR target/70465 */\n+/* { dg-do compile } */\n+/* { dg-options \"-Ofast -mfpmath=387 -fomit-frame-pointer\" } */\n+/* { dg-final { scan-assembler-not \"fxch\\t%st.1\" } } */\n+\n+extern float d[1024];\n+\n+static inline long double\n+foo (long double a, long double b)\n+{\n+  return a < b ? a : b;\n+}\n+\n+static inline long double\n+bar (long double a, long double b)\n+{\n+  return a > b ? a : b;\n+}\n+\n+float\n+baz (void)\n+{\n+  long double c = d[0];\n+  return foo (bar (c, 0.0l), 1.0l);\n+}"}]}