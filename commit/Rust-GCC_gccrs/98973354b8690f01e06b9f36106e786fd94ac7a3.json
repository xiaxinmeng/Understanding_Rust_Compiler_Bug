{"sha": "98973354b8690f01e06b9f36106e786fd94ac7a3", "node_id": "C_kwDOANBUbNoAKDk4OTczMzU0Yjg2OTBmMDFlMDZiOWYzNjEwNmU3ODZmZDk0YWM3YTM", "commit": {"author": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2022-08-26T22:03:53Z"}, "committer": {"name": "Marek Polacek", "email": "polacek@redhat.com", "date": "2022-08-29T21:26:44Z"}, "message": "c++: Fix C++11 attribute propagation [PR106712]\n\nWhen we have\n\n  [[noreturn]] int fn1 [[nodiscard]](), fn2();\n\n\"noreturn\" should apply to both fn1 and fn2 but \"nodiscard\" only to fn1:\n[dcl.pre]/3: \"The attribute-specifier-seq appertains to each of\nthe entities declared by the declarators of the init-declarator-list.\"\n[dcl.spec.general]: \"The attribute-specifier-seq affects the type\nonly for the declaration it appears in, not other declarations involving\nthe same type.\"\n\nAs Ed Catmur correctly analyzed, this is because, for the test above,\nwe call start_decl with prefix_attributes=noreturn, but this line:\n\n  attributes = attr_chainon (attributes, prefix_attributes);\n\nresults in attributes == prefix_attributes, because chainon sees\nthat attributes is null so it just returns prefix_attributes.  Then\nin grokdeclarator we reach\n\n  *attrlist = attr_chainon (*attrlist, declarator->std_attributes);\n\nwhich modifies prefix_attributes so now it's \"noreturn, nodiscard\"\nand so fn2 is wrongly marked nodiscard as well.  Fixed by reversing\nthe order of arguments to attr_chainon.  That way, we tack the prefix\nattributes onto ->std_attributes, avoiding modifying prefix_attributes.\n\n\tPR c++/106712\n\ngcc/cp/ChangeLog:\n\n\t* decl.cc (grokdeclarator): Reverse the order of arguments to\n\tattr_chainon.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/cpp0x/gen-attrs-77.C: New test.", "tree": {"sha": "d35a699724295da39bc88de9784227bab996feb6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d35a699724295da39bc88de9784227bab996feb6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/98973354b8690f01e06b9f36106e786fd94ac7a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/98973354b8690f01e06b9f36106e786fd94ac7a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/98973354b8690f01e06b9f36106e786fd94ac7a3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/98973354b8690f01e06b9f36106e786fd94ac7a3/comments", "author": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mpolacek", "id": 10496300, "node_id": "MDQ6VXNlcjEwNDk2MzAw", "avatar_url": "https://avatars.githubusercontent.com/u/10496300?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mpolacek", "html_url": "https://github.com/mpolacek", "followers_url": "https://api.github.com/users/mpolacek/followers", "following_url": "https://api.github.com/users/mpolacek/following{/other_user}", "gists_url": "https://api.github.com/users/mpolacek/gists{/gist_id}", "starred_url": "https://api.github.com/users/mpolacek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mpolacek/subscriptions", "organizations_url": "https://api.github.com/users/mpolacek/orgs", "repos_url": "https://api.github.com/users/mpolacek/repos", "events_url": "https://api.github.com/users/mpolacek/events{/privacy}", "received_events_url": "https://api.github.com/users/mpolacek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b504149d2c92ddfcfab62ea6d1ed49ae72493e38", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b504149d2c92ddfcfab62ea6d1ed49ae72493e38", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b504149d2c92ddfcfab62ea6d1ed49ae72493e38"}], "stats": {"total": 19, "additions": 18, "deletions": 1}, "files": [{"sha": "b72b2a8456b2ddc5bff6b67fe5df8884d04a39d6", "filename": "gcc/cp/decl.cc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/98973354b8690f01e06b9f36106e786fd94ac7a3/gcc%2Fcp%2Fdecl.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/98973354b8690f01e06b9f36106e786fd94ac7a3/gcc%2Fcp%2Fdecl.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.cc?ref=98973354b8690f01e06b9f36106e786fd94ac7a3", "patch": "@@ -13474,7 +13474,7 @@ grokdeclarator (const cp_declarator *declarator,\n       /* [dcl.meaning]/1: The optional attribute-specifier-seq following\n \t a declarator-id appertains to the entity that is declared.  */\n       if (declarator->std_attributes != error_mark_node)\n-\t*attrlist = attr_chainon (*attrlist, declarator->std_attributes);\n+\t*attrlist = attr_chainon (declarator->std_attributes, *attrlist);\n       else\n \t/* We should have already diagnosed the issue (c++/78344).  */\n \tgcc_assert (seen_error ());"}, {"sha": "2c41c62f33bcb18a912b445a1961a3a3e74e57c4", "filename": "gcc/testsuite/g++.dg/cpp0x/gen-attrs-77.C", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/98973354b8690f01e06b9f36106e786fd94ac7a3/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fgen-attrs-77.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/98973354b8690f01e06b9f36106e786fd94ac7a3/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fgen-attrs-77.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fgen-attrs-77.C?ref=98973354b8690f01e06b9f36106e786fd94ac7a3", "patch": "@@ -0,0 +1,17 @@\n+// PR c++/106712\n+// { dg-do compile { target c++11 } }\n+\n+[[noreturn]] int f1 [[nodiscard]](), f2 ();\n+[[nodiscard]] int f3 (), f4 ();\n+int f5 [[nodiscard]](), f6 ();\n+\n+int\n+main ()\n+{\n+  f1 (); // { dg-warning \"ignoring\" }\n+  f2 ();\n+  f3 (); // { dg-warning \"ignoring\" }\n+  f4 (); // { dg-warning \"ignoring\" }\n+  f5 (); // { dg-warning \"ignoring\" }\n+  f6 ();\n+}"}]}