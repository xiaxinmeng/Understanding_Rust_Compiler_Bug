{"sha": "caed5c92712701509413c579fb004faa965e4004", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Y2FlZDVjOTI3MTI3MDE1MDk0MTNjNTc5ZmIwMDRmYWE5NjVlNDAwNA==", "commit": {"author": {"name": "Qing Zhao", "email": "qing.zhao@oracle.com", "date": "2017-11-17T05:32:05Z"}, "committer": {"name": "Jeff Law", "email": "law@gcc.gnu.org", "date": "2017-11-17T05:32:05Z"}, "message": "re PR middle-end/78809 (Inline strcmp with small constant strings)\n\n2017-11-15  Qing Zhao <qing.zhao@oracle.com>\n\n\tPR middle-end/78809\n\t* gimple-fold.c (gimple_fold_builtin_string_compare): Add handling\n\tof replacing call to strncmp with corresponding call to strcmp when\n\tmeeting conditions.\n\n\tPR middle-end/78809\n\t* gcc.dg/strcmpopt_1.c: New test.\n\nFrom-SVN: r254856", "tree": {"sha": "e6a25de7a4c912e87fdd28ec9a45b3cfc6aa2388", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e6a25de7a4c912e87fdd28ec9a45b3cfc6aa2388"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/caed5c92712701509413c579fb004faa965e4004", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/caed5c92712701509413c579fb004faa965e4004", "html_url": "https://github.com/Rust-GCC/gccrs/commit/caed5c92712701509413c579fb004faa965e4004", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/caed5c92712701509413c579fb004faa965e4004/comments", "author": {"login": "qingzhao69", "id": 89154636, "node_id": "MDQ6VXNlcjg5MTU0NjM2", "avatar_url": "https://avatars.githubusercontent.com/u/89154636?v=4", "gravatar_id": "", "url": "https://api.github.com/users/qingzhao69", "html_url": "https://github.com/qingzhao69", "followers_url": "https://api.github.com/users/qingzhao69/followers", "following_url": "https://api.github.com/users/qingzhao69/following{/other_user}", "gists_url": "https://api.github.com/users/qingzhao69/gists{/gist_id}", "starred_url": "https://api.github.com/users/qingzhao69/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/qingzhao69/subscriptions", "organizations_url": "https://api.github.com/users/qingzhao69/orgs", "repos_url": "https://api.github.com/users/qingzhao69/repos", "events_url": "https://api.github.com/users/qingzhao69/events{/privacy}", "received_events_url": "https://api.github.com/users/qingzhao69/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5958557b750254f28954d1ed6a3ce0b9cb48c6fb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5958557b750254f28954d1ed6a3ce0b9cb48c6fb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5958557b750254f28954d1ed6a3ce0b9cb48c6fb"}], "stats": {"total": 55, "additions": 55, "deletions": 0}, "files": [{"sha": "9352b48ccf3d1e223754cc9e1d4ff204486571b8", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/caed5c92712701509413c579fb004faa965e4004/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/caed5c92712701509413c579fb004faa965e4004/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=caed5c92712701509413c579fb004faa965e4004", "patch": "@@ -1,3 +1,10 @@\n+2017-11-15  Qing Zhao <qing.zhao@oracle.com>\n+\n+\tPR middle-end/78809\n+\t* gimple-fold.c (gimple_fold_builtin_string_compare): Add handling\n+\tof replacing call to strncmp with corresponding call to strcmp when\n+\tmeeting conditions.\n+\n 2017-11-17  Sergey Shalnov  <Sergey.Shalnov@intel.com>\n \n \t* config/i386/x86-tune.def (X86_TUNE_AVX256_OPTIMAL): Add tuning"}, {"sha": "1ed63833b732aa019a60c0ec6d499b4ac873a7ac", "filename": "gcc/gimple-fold.c", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/caed5c92712701509413c579fb004faa965e4004/gcc%2Fgimple-fold.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/caed5c92712701509413c579fb004faa965e4004/gcc%2Fgimple-fold.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-fold.c?ref=caed5c92712701509413c579fb004faa965e4004", "patch": "@@ -2258,6 +2258,21 @@ gimple_fold_builtin_string_compare (gimple_stmt_iterator *gsi)\n       return true;\n     }\n \n+  /* If length is larger than the length of one constant string, \n+     replace strncmp with corresponding strcmp */ \n+  if (fcode == BUILT_IN_STRNCMP \n+      && length > 0\n+      && ((p2 && (size_t) length > strlen (p2)) \n+          || (p1 && (size_t) length > strlen (p1))))\n+    {\n+      tree fn = builtin_decl_implicit (BUILT_IN_STRCMP);\n+      if (!fn)\n+        return false;\n+      gimple *repl = gimple_build_call (fn, 2, str1, str2);\n+      replace_call_with_call_and_fold (gsi, repl);\n+      return true;\n+    }\n+\n   return false;\n }\n "}, {"sha": "d597fe606ccb4349cd6ecb14af69091d7a3989c6", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/caed5c92712701509413c579fb004faa965e4004/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/caed5c92712701509413c579fb004faa965e4004/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=caed5c92712701509413c579fb004faa965e4004", "patch": "@@ -1,3 +1,8 @@\n+2017-11-15  Qing Zhao  <qing.zhao@oracle.com <mailto:qing.zhao@oracle.com>>\n+\n+\tPR middle-end/78809\n+\t* gcc.dg/strcmpopt_1.c: New test.\n+\n 2017-11-16  Joseph Myers  <joseph@codesourcery.com>\n \n \t* gcc.dg/c18-version-1.c, gcc.dg/c18-version-2.c: New tests."}, {"sha": "40596a20b40088d643ccc0a4f60e5cf5005a8a2b", "filename": "gcc/testsuite/gcc.dg/strcmpopt_1.c", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/caed5c92712701509413c579fb004faa965e4004/gcc%2Ftestsuite%2Fgcc.dg%2Fstrcmpopt_1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/caed5c92712701509413c579fb004faa965e4004/gcc%2Ftestsuite%2Fgcc.dg%2Fstrcmpopt_1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fstrcmpopt_1.c?ref=caed5c92712701509413c579fb004faa965e4004", "patch": "@@ -0,0 +1,28 @@\n+/* { dg-do run } */\n+/* { dg-options \"-fdump-tree-gimple\" } */\n+\n+#include <string.h>\n+#include <stdlib.h>\n+\n+int cmp1 (char *p)\n+{\n+  return strncmp (p, \"fis\", 4);\n+}\n+int cmp2 (char *q)\n+{\n+  return strncmp (\"fis\", q, 4);\n+}\n+\n+int main ()\n+{\n+\n+  char *p = \"fish\";\n+  char *q = \"fis\\0\";\n+\n+  if (cmp1 (p) == 0 || cmp2 (q) != 0)\n+    abort ();\n+\n+  return 0;\n+}\n+\n+/* { dg-final { scan-tree-dump-times \"strcmp \\\\(\" 2 \"gimple\" } } */"}]}