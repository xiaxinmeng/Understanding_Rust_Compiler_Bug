{"sha": "3b4441db79de403b90038af98f8641c19ff0953b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2I0NDQxZGI3OWRlNDAzYjkwMDM4YWY5OGY4NjQxYzE5ZmYwOTUzYg==", "commit": {"author": {"name": "Dodji Seketeli", "email": "dodji@redhat.com", "date": "2012-09-28T12:51:30Z"}, "committer": {"name": "Dodji Seketeli", "email": "dodji@gcc.gnu.org", "date": "2012-09-28T12:51:30Z"}, "message": "PR c++/29028 - Missed unused warning on using declaration\n\nIn the example of the patch, g++ fails to warn that the variable N::i\n(introduced via a using declaration) is unused.\n\nThis is because as we want to emit the warning in poplevel, when we\nwalk the local bindings returned by getdecls, we forget that a\nVAR_DECL introduced by a using declaration is represented by a\nTREE_LIST which TREE_VALUE is the VAR_DECL, and we wrongly look for a\nbare VAR_DECL.\n\nFixed thus and tested on x86_64-unknown-linux-gnu against trunk.\n\ngcc/cp/\n\n\t* decl.c (poplevel<warn_unused*>): Do not forget that some local\n\tbindings are represented by a TREE_LIST.\n\ngcc/testsuite/\n\n\t* g++.dg/warn/Wunused-var-18.C: New test.\n\nFrom-SVN: r191829", "tree": {"sha": "62e97833b7985d32ad245d045f3f22483e828606", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/62e97833b7985d32ad245d045f3f22483e828606"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3b4441db79de403b90038af98f8641c19ff0953b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b4441db79de403b90038af98f8641c19ff0953b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3b4441db79de403b90038af98f8641c19ff0953b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b4441db79de403b90038af98f8641c19ff0953b/comments", "author": null, "committer": null, "parents": [{"sha": "2be9064dedcf93581e0596151454573d8c37f8be", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2be9064dedcf93581e0596151454573d8c37f8be", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2be9064dedcf93581e0596151454573d8c37f8be"}], "stats": {"total": 71, "additions": 51, "deletions": 20}, "files": [{"sha": "3ba5de4eb7a5e22413b499dba06d4d6cb2c28216", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=3b4441db79de403b90038af98f8641c19ff0953b", "patch": "@@ -1,3 +1,9 @@\n+2012-09-25  Dodji Seketeli  <dodji@redhat.com>\n+\n+\tPR c++/29028 - Missed unused warning on using declaration\n+\t* decl.c (poplevel<warn_unused*>): Do not forget that some local\n+\tbindings are represented by a TREE_LIST.\n+\n 2012-09-25  Dodji Seketeli  <dodji@redhat.com>\n \n \tPR c++/53551 - -Wunused-local-typedefs misses uses"}, {"sha": "078b1486615e519ebe2bbbd27006c3b7bad5dc0a", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 26, "deletions": 20, "changes": 46, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=3b4441db79de403b90038af98f8641c19ff0953b", "patch": "@@ -617,26 +617,32 @@ poplevel (int keep, int reverse, int functionbody)\n   /* Before we remove the declarations first check for unused variables.  */\n   if ((warn_unused_variable || warn_unused_but_set_variable)\n       && !processing_template_decl)\n-    for (decl = getdecls (); decl; decl = TREE_CHAIN (decl))\n-      if (TREE_CODE (decl) == VAR_DECL\n-\t  && (! TREE_USED (decl) || !DECL_READ_P (decl))\n-\t  && ! DECL_IN_SYSTEM_HEADER (decl)\n-\t  && DECL_NAME (decl) && ! DECL_ARTIFICIAL (decl)\n-\t  && TREE_TYPE (decl) != error_mark_node\n-\t  && (!CLASS_TYPE_P (TREE_TYPE (decl))\n-\t      || !TYPE_HAS_NONTRIVIAL_DESTRUCTOR (TREE_TYPE (decl))))\n-\t{\n-\t  if (! TREE_USED (decl))\n-\t    warning (OPT_Wunused_variable, \"unused variable %q+D\", decl);\n-\t  else if (DECL_CONTEXT (decl) == current_function_decl\n-\t\t   && TREE_CODE (TREE_TYPE (decl)) != REFERENCE_TYPE\n-\t\t   && errorcount == unused_but_set_errorcount)\n-\t    {\n-\t      warning (OPT_Wunused_but_set_variable,\n-\t\t       \"variable %q+D set but not used\", decl); \n-\t      unused_but_set_errorcount = errorcount;\n-\t    }\n-\t}\n+    for (tree d = getdecls (); d; d = TREE_CHAIN (d))\n+      {\n+\t/* There are cases where D itself is a TREE_LIST.  See in\n+\t   push_local_binding where the list of decls returned by\n+\t   getdecls is built.  */\n+\tdecl = TREE_CODE (d) == TREE_LIST ? TREE_VALUE (d) : d;\n+\tif (TREE_CODE (decl) == VAR_DECL\n+\t    && (! TREE_USED (decl) || !DECL_READ_P (decl))\n+\t    && ! DECL_IN_SYSTEM_HEADER (decl)\n+\t    && DECL_NAME (decl) && ! DECL_ARTIFICIAL (decl)\n+\t    && TREE_TYPE (decl) != error_mark_node\n+\t    && (!CLASS_TYPE_P (TREE_TYPE (decl))\n+\t\t|| !TYPE_HAS_NONTRIVIAL_DESTRUCTOR (TREE_TYPE (decl))))\n+\t  {\n+\t    if (! TREE_USED (decl))\n+\t      warning (OPT_Wunused_variable, \"unused variable %q+D\", decl);\n+\t    else if (DECL_CONTEXT (decl) == current_function_decl\n+\t\t     && TREE_CODE (TREE_TYPE (decl)) != REFERENCE_TYPE\n+\t\t     && errorcount == unused_but_set_errorcount)\n+\t      {\n+\t\twarning (OPT_Wunused_but_set_variable,\n+\t\t\t \"variable %q+D set but not used\", decl);\n+\t\tunused_but_set_errorcount = errorcount;\n+\t      }\n+\t  }\n+      }\n \n   /* Remove declarations for all the DECLs in this level.  */\n   for (link = decls; link; link = TREE_CHAIN (link))"}, {"sha": "407184d17bedb1897d884cb3c81adbedbd21abcb", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=3b4441db79de403b90038af98f8641c19ff0953b", "patch": "@@ -1,3 +1,8 @@\n+2012-09-25  Dodji Seketeli  <dodji@redhat.com>\n+\n+\tPR c++/29028 - Missed unused warning on using declaration\n+\t* g++.dg/warn/Wunused-var-18.C: New test.\n+\n 2012-09-25  Dodji Seketeli  <dodji@redhat.com>\n \n \tPR c++/53551 - -Wunused-local-typedefs misses uses"}, {"sha": "0339663721ce1c900d70c0628bebd3ed35fb9647", "filename": "gcc/testsuite/g++.dg/warn/Wunused-var-18.C", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWunused-var-18.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4441db79de403b90038af98f8641c19ff0953b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWunused-var-18.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2FWunused-var-18.C?ref=3b4441db79de403b90038af98f8641c19ff0953b", "patch": "@@ -0,0 +1,14 @@\n+// Origin: PR c++/29028\n+// { dg-options \"-Wunused\" }\n+// { dg-do compile }\n+\n+namespace N\n+{\n+    int i; // { dg-warning \"unused variable\" }\n+}\n+\n+void\n+f ()\n+{\n+    using N::i;\n+}"}]}