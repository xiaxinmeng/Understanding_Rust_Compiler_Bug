{"sha": "2d7ad38707e1fd71193d440198cc0726092b9015", "node_id": "C_kwDOANBUbNoAKDJkN2FkMzg3MDdlMWZkNzExOTNkNDQwMTk4Y2MwNzI2MDkyYjkwMTU", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2023-04-11T14:06:12Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2023-04-12T06:48:23Z"}, "message": "tree-optimization/109469 - SLP with returns-twice region start\n\nThe following avoids an SLP region starting with a returns-twice\ncall where we cannot insert stmts at the head.\n\n\tPR tree-optimization/109469\n\t* tree-vect-slp.cc (vect_slp_function): Skip region starts with\n\ta returns-twice call.\n\n\t* gcc.dg/torture/pr109469.c: New testcase.", "tree": {"sha": "91e801925d680b0c6030a8e4913d1009b8882c84", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/91e801925d680b0c6030a8e4913d1009b8882c84"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2d7ad38707e1fd71193d440198cc0726092b9015", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d7ad38707e1fd71193d440198cc0726092b9015", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2d7ad38707e1fd71193d440198cc0726092b9015", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d7ad38707e1fd71193d440198cc0726092b9015/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e3e708dbadaae7b504af7fc4410015624793f02", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6e3e708dbadaae7b504af7fc4410015624793f02", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6e3e708dbadaae7b504af7fc4410015624793f02"}], "stats": {"total": 34, "additions": 31, "deletions": 3}, "files": [{"sha": "d05a93b67833b9802c90e16a9670c530b0ec1620", "filename": "gcc/testsuite/gcc.dg/torture/pr109469.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d7ad38707e1fd71193d440198cc0726092b9015/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr109469.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d7ad38707e1fd71193d440198cc0726092b9015/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr109469.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftorture%2Fpr109469.c?ref=2d7ad38707e1fd71193d440198cc0726092b9015", "patch": "@@ -0,0 +1,15 @@\n+/* { dg-do compile } */\n+\n+__attribute__((returns_twice)) int foo();\n+\n+struct xio myproc;\n+struct xio {\n+  void (*read_proc)();\n+  void (*write_proc)();\n+};\n+\n+void dummy_write_proc() {\n+  switch (foo())\n+  default:\n+    myproc.read_proc = myproc.write_proc = dummy_write_proc;\n+}"}, {"sha": "d73deaecce0cef78eda5fff9909da5b5406902ee", "filename": "gcc/tree-vect-slp.cc", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2d7ad38707e1fd71193d440198cc0726092b9015/gcc%2Ftree-vect-slp.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2d7ad38707e1fd71193d440198cc0726092b9015/gcc%2Ftree-vect-slp.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-slp.cc?ref=2d7ad38707e1fd71193d440198cc0726092b9015", "patch": "@@ -7671,10 +7671,23 @@ vect_slp_function (function *fun)\n \t{\n \t  r |= vect_slp_bbs (bbs, NULL);\n \t  bbs.truncate (0);\n-\t  bbs.quick_push (bb);\n \t}\n-      else\n-\tbbs.safe_push (bb);\n+\n+      /* We need to be able to insert at the head of the region which\n+\t we cannot for region starting with a returns-twice call.  */\n+      if (bbs.is_empty ())\n+\tif (gcall *first = safe_dyn_cast <gcall *> (first_stmt (bb)))\n+\t  if (gimple_call_flags (first) & ECF_RETURNS_TWICE)\n+\t    {\n+\t      if (dump_enabled_p ())\n+\t\tdump_printf_loc (MSG_MISSED_OPTIMIZATION, vect_location,\n+\t\t\t\t \"skipping bb%d as start of region as it \"\n+\t\t\t\t \"starts with returns-twice call\\n\",\n+\t\t\t\t bb->index);\n+\t      continue;\n+\t    }\n+\n+      bbs.safe_push (bb);\n \n       /* When we have a stmt ending this block and defining a\n \t value we have to insert on edges when inserting after it for"}]}