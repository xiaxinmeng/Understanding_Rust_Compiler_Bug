{"sha": "a30e53454663b6b8fab469d249341c514a6395f6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTMwZTUzNDU0NjYzYjZiOGZhYjQ2OWQyNDkzNDFjNTE0YTYzOTVmNg==", "commit": {"author": {"name": "Sebastian Pop", "email": "sebastian.pop@amd.com", "date": "2010-12-16T22:54:17Z"}, "committer": {"name": "Sebastian Pop", "email": "spop@gcc.gnu.org", "date": "2010-12-16T22:54:17Z"}, "message": "Fix PR46924: Do not detect reductions outside the current SESE region.\n\n2010-12-16  Sebastian Pop  <sebastian.pop@amd.com>\n\n\tPR tree-optimization/46924\n\t* graphite-sese-to-poly.c (detect_commutative_reduction): Do not\n\tdetect reductions outside the current SESE region.\n\t* sese.h (stmt_in_sese_p): New.\n\t(defined_in_sese_p): Call stmt_in_sese_p.\n\n\t* gcc.dg/graphite/pr46924.c: New.\n\nFrom-SVN: r167962", "tree": {"sha": "a641dbfe3a54dffdf98a22c0dcc0ee96689e0352", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a641dbfe3a54dffdf98a22c0dcc0ee96689e0352"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a30e53454663b6b8fab469d249341c514a6395f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a30e53454663b6b8fab469d249341c514a6395f6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a30e53454663b6b8fab469d249341c514a6395f6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a30e53454663b6b8fab469d249341c514a6395f6/comments", "author": null, "committer": {"login": "sebpop", "id": 568397, "node_id": "MDQ6VXNlcjU2ODM5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/568397?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sebpop", "html_url": "https://github.com/sebpop", "followers_url": "https://api.github.com/users/sebpop/followers", "following_url": "https://api.github.com/users/sebpop/following{/other_user}", "gists_url": "https://api.github.com/users/sebpop/gists{/gist_id}", "starred_url": "https://api.github.com/users/sebpop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sebpop/subscriptions", "organizations_url": "https://api.github.com/users/sebpop/orgs", "repos_url": "https://api.github.com/users/sebpop/repos", "events_url": "https://api.github.com/users/sebpop/events{/privacy}", "received_events_url": "https://api.github.com/users/sebpop/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "114dae43305796626be7257e51fd53c7e5085f44", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/114dae43305796626be7257e51fd53c7e5085f44", "html_url": "https://github.com/Rust-GCC/gccrs/commit/114dae43305796626be7257e51fd53c7e5085f44"}], "stats": {"total": 59, "additions": 50, "deletions": 9}, "files": [{"sha": "cde0107e17c6839eef46452df1e8f584278deae3", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a30e53454663b6b8fab469d249341c514a6395f6", "patch": "@@ -1,3 +1,11 @@\n+2010-12-16  Sebastian Pop  <sebastian.pop@amd.com>\n+\n+\tPR tree-optimization/46924\n+\t* graphite-sese-to-poly.c (detect_commutative_reduction): Do not\n+\tdetect reductions outside the current SESE region.\n+\t* sese.h (stmt_in_sese_p): New.\n+\t(defined_in_sese_p): Call stmt_in_sese_p.\n+\n 2010-12-16  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR tree-optimization/46966"}, {"sha": "49250b67382afb02d7395dbb959ab55ca38856ea", "filename": "gcc/graphite-sese-to-poly.c", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Fgraphite-sese-to-poly.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Fgraphite-sese-to-poly.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgraphite-sese-to-poly.c?ref=a30e53454663b6b8fab469d249341c514a6395f6", "patch": "@@ -2858,12 +2858,12 @@ initial_value_for_loop_phi (gimple phi)\n   return NULL_TREE;\n }\n \n-/* Detect commutative and associative scalar reductions starting at\n-   the loop closed phi node STMT.  Return the phi node of the\n-   reduction cycle, or NULL.  */\n+/* Detect commutative and associative scalar reductions belonging to\n+   the SCOP starting at the loop closed phi node STMT.  Return the phi\n+   node of the reduction cycle, or NULL.  */\n \n static gimple\n-detect_commutative_reduction (gimple stmt, VEC (gimple, heap) **in,\n+detect_commutative_reduction (scop_p scop, gimple stmt, VEC (gimple, heap) **in,\n \t\t\t      VEC (gimple, heap) **out)\n {\n   if (scalar_close_phi_node_p (stmt))\n@@ -2880,7 +2880,10 @@ detect_commutative_reduction (gimple stmt, VEC (gimple, heap) **in,\n       gcc_assert (gimple_phi_num_args (stmt) == 1);\n \n       def = SSA_NAME_DEF_STMT (arg);\n-      loop_phi = detect_commutative_reduction (def, in, out);\n+      if (!stmt_in_sese_p (def, SCOP_REGION (scop)))\n+\treturn NULL;\n+\n+      loop_phi = detect_commutative_reduction (scop, def, in, out);\n \n       if (loop_phi)\n \t{\n@@ -3019,7 +3022,7 @@ rewrite_commutative_reductions_out_of_ssa_close_phi (scop_p scop,\n   VEC (gimple, heap) *in = VEC_alloc (gimple, heap, 10);\n   VEC (gimple, heap) *out = VEC_alloc (gimple, heap, 10);\n \n-  detect_commutative_reduction (close_phi, &in, &out);\n+  detect_commutative_reduction (scop, close_phi, &in, &out);\n   res = VEC_length (gimple, in) > 0;\n   if (res)\n     translate_scalar_reduction_to_array (scop, in, out);"}, {"sha": "97807d820089ffb7bc9f2f56d4488327e8bd821a", "filename": "gcc/sese.h", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Fsese.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Fsese.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fsese.h?ref=a30e53454663b6b8fab469d249341c514a6395f6", "patch": "@@ -114,15 +114,22 @@ bb_in_sese_p (basic_block bb, sese region)\n   return bb_in_region (bb, entry, exit);\n }\n \n+/* Returns true when STMT is defined in REGION.  */\n+\n+static inline bool\n+stmt_in_sese_p (gimple stmt, sese region)\n+{\n+  basic_block bb = gimple_bb (stmt);\n+  return bb && bb_in_sese_p (bb, region);\n+}\n+\n /* Returns true when NAME is defined in REGION.  */\n \n static inline bool\n defined_in_sese_p (tree name, sese region)\n {\n   gimple stmt = SSA_NAME_DEF_STMT (name);\n-  basic_block bb = gimple_bb (stmt);\n-\n-  return bb && bb_in_sese_p (bb, region);\n+  return stmt_in_sese_p (stmt, region);\n }\n \n /* Returns true when LOOP is in REGION.  */"}, {"sha": "df91d0995ad76bf1cdddfa615075b8938a5eb157", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a30e53454663b6b8fab469d249341c514a6395f6", "patch": "@@ -1,3 +1,8 @@\n+2010-12-16  Sebastian Pop  <sebastian.pop@amd.com>\n+\n+\tPR tree-optimization/46924\n+\t* gcc.dg/graphite/pr46924.c: New.\n+\n 2010-12-16  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR tree-optimization/46966"}, {"sha": "5788c2c008f8629c512bcfb39133d430348acb56", "filename": "gcc/testsuite/gcc.dg/graphite/pr46924.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Ftestsuite%2Fgcc.dg%2Fgraphite%2Fpr46924.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a30e53454663b6b8fab469d249341c514a6395f6/gcc%2Ftestsuite%2Fgcc.dg%2Fgraphite%2Fpr46924.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgraphite%2Fpr46924.c?ref=a30e53454663b6b8fab469d249341c514a6395f6", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-options \"-O -fgraphite-identity -ffast-math -fno-tree-loop-im\" } */\n+\n+struct S\n+{\n+  int n;\n+  float *a;\n+};\n+\n+float foo (struct S *s)\n+{\n+  float f = 0, g=0;\n+  int i;\n+  for (i = 0; i < s->n; i++)\n+    f += s->a[i];\n+  for (i = 0; i < s->n; i++)\n+    ;\n+  return f;\n+}"}]}