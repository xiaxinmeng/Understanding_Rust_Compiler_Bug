{"sha": "be6bb3fc57e2af376e5c18eeca51119e87a55ee3", "node_id": "C_kwDOANBUbNoAKGJlNmJiM2ZjNTdlMmFmMzc2ZTVjMThlZWNhNTExMTllODdhNTVlZTM", "commit": {"author": {"name": "Richard Kenner", "email": "kenner@adacore.com", "date": "2021-11-16T14:39:57Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2021-12-01T10:24:41Z"}, "message": "[Ada] Fix issues with ignored ghost code and unnesting\n\ngcc/ada/\n\n\t* frontend.adb (Frontend): Do unnesting after ignored ghost code\n\thas been removed.\n\t* inline.adb (Analyze_Inlined_Bodies): Don't put ignored ghost\n\tentities on inlined subprogram list.", "tree": {"sha": "1d50d1498e024a3413c26384480c616008d6afa7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1d50d1498e024a3413c26384480c616008d6afa7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/be6bb3fc57e2af376e5c18eeca51119e87a55ee3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/be6bb3fc57e2af376e5c18eeca51119e87a55ee3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/be6bb3fc57e2af376e5c18eeca51119e87a55ee3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/be6bb3fc57e2af376e5c18eeca51119e87a55ee3/comments", "author": {"login": "richardkenner", "id": 56170968, "node_id": "MDQ6VXNlcjU2MTcwOTY4", "avatar_url": "https://avatars.githubusercontent.com/u/56170968?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richardkenner", "html_url": "https://github.com/richardkenner", "followers_url": "https://api.github.com/users/richardkenner/followers", "following_url": "https://api.github.com/users/richardkenner/following{/other_user}", "gists_url": "https://api.github.com/users/richardkenner/gists{/gist_id}", "starred_url": "https://api.github.com/users/richardkenner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richardkenner/subscriptions", "organizations_url": "https://api.github.com/users/richardkenner/orgs", "repos_url": "https://api.github.com/users/richardkenner/repos", "events_url": "https://api.github.com/users/richardkenner/events{/privacy}", "received_events_url": "https://api.github.com/users/richardkenner/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dbdb6b93a2808d5c3d518e9675d058fab3b8f89b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbdb6b93a2808d5c3d518e9675d058fab3b8f89b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dbdb6b93a2808d5c3d518e9675d058fab3b8f89b"}], "stats": {"total": 26, "additions": 16, "deletions": 10}, "files": [{"sha": "b78fc9cf30d68002b69a106794fcf999b3e6c394", "filename": "gcc/ada/frontend.adb", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/be6bb3fc57e2af376e5c18eeca51119e87a55ee3/gcc%2Fada%2Ffrontend.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/be6bb3fc57e2af376e5c18eeca51119e87a55ee3/gcc%2Fada%2Ffrontend.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Ffrontend.adb?ref=be6bb3fc57e2af376e5c18eeca51119e87a55ee3", "patch": "@@ -473,12 +473,6 @@ begin\n                Check_Elaboration_Scenarios;\n             end if;\n \n-            --  At this stage we can unnest subprogram bodies if required\n-\n-            if Total_Errors_Detected = 0 then\n-               Exp_Unst.Unnest_Subprograms (Cunit (Main_Unit));\n-            end if;\n-\n             --  List library units if requested\n \n             if List_Units then\n@@ -494,12 +488,19 @@ begin\n             Sem_Warn.Output_Unused_Warnings_Off_Warnings;\n \n             --  Remove any ignored Ghost code as it must not appear in the\n-            --  executable. This action must be performed last because it\n+            --  executable. This action must be performed very late because it\n             --  heavily alters the tree.\n \n             if Operating_Mode = Generate_Code or else GNATprove_Mode then\n                Remove_Ignored_Ghost_Code;\n             end if;\n+\n+            --  At this stage we can unnest subprogram bodies if required\n+\n+            if Total_Errors_Detected = 0 then\n+               Exp_Unst.Unnest_Subprograms (Cunit (Main_Unit));\n+            end if;\n+\n          end if;\n       end if;\n    end;"}, {"sha": "11a5523f4b7eec6c8509c9fbd147a2250e6719d4", "filename": "gcc/ada/inline.adb", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/be6bb3fc57e2af376e5c18eeca51119e87a55ee3/gcc%2Fada%2Finline.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/be6bb3fc57e2af376e5c18eeca51119e87a55ee3/gcc%2Fada%2Finline.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Finline.adb?ref=be6bb3fc57e2af376e5c18eeca51119e87a55ee3", "patch": "@@ -1087,9 +1087,14 @@ package body Inline is\n          --  subprograms for the unit.\n \n          for Index in Inlined.First .. Inlined.Last loop\n-            if Is_Called (Inlined.Table (Index).Name) then\n-               Add_Inlined_Subprogram (Inlined.Table (Index).Name);\n-            end if;\n+            declare\n+               E : constant Subprogram_Kind_Id := Inlined.Table (Index).Name;\n+\n+            begin\n+               if Is_Called (E) and then not Is_Ignored_Ghost_Entity (E) then\n+                  Add_Inlined_Subprogram (E);\n+               end if;\n+            end;\n          end loop;\n \n          Pop_Scope;"}]}