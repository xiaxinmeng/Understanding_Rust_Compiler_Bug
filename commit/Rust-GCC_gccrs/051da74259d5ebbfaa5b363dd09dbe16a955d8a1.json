{"sha": "051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDUxZGE3NDI1OWQ1ZWJiZmFhNWIzNjNkZDA5ZGJlMTZhOTU1ZDhhMQ==", "commit": {"author": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2020-05-12T16:17:34Z"}, "committer": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2020-05-12T16:17:45Z"}, "message": "libcpp: Enable Intel CET on Intel CET enabled host for jit\n\nSince on Intel CET enabled host, dlopen in Intel CET enabled applications\nfails on shared libraries which aren't Intel CET enabled, compile with\n-fcf-protection on Intel CET enabled host when jit is enabled to enable\nIntel CET on libgccjit.\n\n\t* Makefile.in (CET_HOST_FLAGS): New.\n\t(COMPILER): Add $(CET_HOST_FLAGS).\n\t* configure.ac: Add GCC_CET_HOST_FLAGS(CET_HOST_FLAGS) and\n\tAC_SUBST(CET_HOST_FLAGS).  Clear CET_HOST_FLAGS if jit isn't\n\tenabled.\n\t* aclocal.m4: Regenerated.\n\t* configure: Likewise.", "tree": {"sha": "a94dd898309fea2bc4cab17cc7e7b5e5f5de2813", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a94dd898309fea2bc4cab17cc7e7b5e5f5de2813"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/comments", "author": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e9c5bb0fd22fb4573d270de241d9b56de17f7f5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e9c5bb0fd22fb4573d270de241d9b56de17f7f5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7e9c5bb0fd22fb4573d270de241d9b56de17f7f5"}], "stats": {"total": 182, "additions": 180, "deletions": 2}, "files": [{"sha": "f6b7c01af97b58a867c8a337e0d95f41aac6e559", "filename": "libcpp/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2FChangeLog?ref=051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "patch": "@@ -1,3 +1,13 @@\n+2020-05-12  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\t* Makefile.in (CET_HOST_FLAGS): New.\n+\t(COMPILER): Add $(CET_HOST_FLAGS).\n+\t* configure.ac: Add GCC_CET_HOST_FLAGS(CET_HOST_FLAGS) and\n+\tAC_SUBST(CET_HOST_FLAGS).  Clear CET_HOST_FLAGS if jit isn't\n+\tenabled.\n+\t* aclocal.m4: Regenerated.\n+\t* configure: Likewise.\n+\n 2020-05-08  Nathan Sidwell  <nathan@acm.org>\n \n \tReimplement directives only processing, support raw literals."}, {"sha": "ebbca07f542e67c1198506f1b39882711c95efd6", "filename": "libcpp/Makefile.in", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2FMakefile.in?ref=051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "patch": "@@ -58,6 +58,7 @@ CXXDEPMODE = @CXXDEPMODE@\n DEPDIR = @DEPDIR@\n NOEXCEPTION_FLAGS = @noexception_flags@\n PICFLAG = @PICFLAG@\n+CET_HOST_FLAGS = @CET_HOST_FLAGS@\n \n datarootdir = @datarootdir@\n datadir = @datadir@\n@@ -73,9 +74,10 @@ depcomp = $(SHELL) $(srcdir)/../depcomp\n INCLUDES = -I$(srcdir) -I. -I$(srcdir)/../include @INCINTL@ \\\n \t-I$(srcdir)/include\n \n-ALL_CFLAGS = $(CFLAGS) $(WARN_CFLAGS) $(INCLUDES) $(CPPFLAGS) $(PICFLAG)\n+ALL_CFLAGS = $(CFLAGS) $(WARN_CFLAGS) $(INCLUDES) $(CPPFLAGS) $(PICFLAG) \\\n+\t$(CET_HOST_FLAGS)\n ALL_CXXFLAGS = $(CXXFLAGS) $(WARN_CXXFLAGS) $(NOEXCEPTION_FLAGS) $(INCLUDES) \\\n-\t$(CPPFLAGS) $(PICFLAG)\n+\t$(CPPFLAGS) $(PICFLAG) $(CET_HOST_FLAGS)\n \n # The name of the compiler to use.\n COMPILER = $(CXX)"}, {"sha": "70c3eff750b0237ded9308a0c7abdac57a4f958d", "filename": "libcpp/aclocal.m4", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2Faclocal.m4", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2Faclocal.m4", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2Faclocal.m4?ref=051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "patch": "@@ -13,8 +13,10 @@\n \n m4_ifndef([AC_CONFIG_MACRO_DIRS], [m4_defun([_AM_CONFIG_MACRO_DIRS], [])m4_defun([AC_CONFIG_MACRO_DIRS], [_AM_CONFIG_MACRO_DIRS($@)])])\n m4_include([../config/acx.m4])\n+m4_include([../config/cet.m4])\n m4_include([../config/codeset.m4])\n m4_include([../config/depstand.m4])\n+m4_include([../config/enable.m4])\n m4_include([../config/gettext-sister.m4])\n m4_include([../config/iconv.m4])\n m4_include([../config/lead-dot.m4])"}, {"sha": "64bbf5457910f6677dbfa22f67321ac341b45fc7", "filename": "libcpp/configure", "status": "modified", "additions": 153, "deletions": 0, "changes": 153, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2Fconfigure", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2Fconfigure", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2Fconfigure?ref=051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "patch": "@@ -623,6 +623,7 @@ ac_includes_default=\"\\\n #endif\"\n \n ac_subst_vars='LTLIBOBJS\n+CET_HOST_FLAGS\n PICFLAG\n MAINT\n USED_CATALOGS\n@@ -735,6 +736,7 @@ enable_maintainer_mode\n enable_checking\n enable_canonical_system_headers\n enable_host_shared\n+enable_cet\n enable_valgrind_annotations\n '\n       ac_precious_vars='build_alias\n@@ -1375,6 +1377,7 @@ Optional Features:\n   --enable-canonical-system-headers\n                           enable or disable system headers canonicalization\n   --enable-host-shared    build host code as shared libraries\n+  --enable-cet            enable Intel CET in host libraries [default=auto]\n   --enable-valgrind-annotations\n                           enable valgrind runtime interaction\n \n@@ -7443,6 +7446,156 @@ fi\n \n \n \n+# Enable Intel CET on Intel CET enabled host if jit is enabled.\n+ # Check whether --enable-cet was given.\n+if test \"${enable_cet+set}\" = set; then :\n+  enableval=$enable_cet;\n+      case \"$enableval\" in\n+       yes|no|auto) ;;\n+       *) as_fn_error $? \"Unknown argument to enable/disable cet\" \"$LINENO\" 5 ;;\n+                          esac\n+\n+else\n+  enable_cet=auto\n+fi\n+\n+\n+{ $as_echo \"$as_me:${as_lineno-$LINENO}: checking for CET support\" >&5\n+$as_echo_n \"checking for CET support... \" >&6; }\n+\n+case \"$host\" in\n+  i[34567]86-*-linux* | x86_64-*-linux*)\n+    may_have_cet=yes\n+    save_CFLAGS=\"$CFLAGS\"\n+    CFLAGS=\"$CFLAGS -fcf-protection\"\n+    case \"$enable_cet\" in\n+      auto)\n+\t# Check if target supports multi-byte NOPs\n+\t# and if assembler supports CET insn.\n+\tcat confdefs.h - <<_ACEOF >conftest.$ac_ext\n+/* end confdefs.h.  */\n+\n+int\n+main ()\n+{\n+\n+#if !defined(__SSE2__)\n+#error target does not support multi-byte NOPs\n+#else\n+asm (\"setssbsy\");\n+#endif\n+\n+  ;\n+  return 0;\n+}\n+_ACEOF\n+if ac_fn_c_try_compile \"$LINENO\"; then :\n+  enable_cet=yes\n+else\n+  enable_cet=no\n+fi\n+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext\n+\t;;\n+      yes)\n+\t# Check if assembler supports CET.\n+\tcat confdefs.h - <<_ACEOF >conftest.$ac_ext\n+/* end confdefs.h.  */\n+\n+int\n+main ()\n+{\n+asm (\"setssbsy\");\n+  ;\n+  return 0;\n+}\n+_ACEOF\n+if ac_fn_c_try_compile \"$LINENO\"; then :\n+\n+else\n+  as_fn_error $? \"assembler with CET support is required for --enable-cet\" \"$LINENO\" 5\n+fi\n+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext\n+\t;;\n+    esac\n+    CFLAGS=\"$save_CFLAGS\"\n+    ;;\n+  *)\n+    may_have_cet=no\n+    enable_cet=no\n+    ;;\n+esac\n+\n+if test x$may_have_cet = xyes; then\n+  save_LDFLAGS=\"$LDFLAGS\"\n+  LDFLAGS=\"$LDFLAGS -Wl,-z,ibt,-z,shstk\"\n+  if test \"$cross_compiling\" = yes; then :\n+  { { $as_echo \"$as_me:${as_lineno-$LINENO}: error: in \\`$ac_pwd':\" >&5\n+$as_echo \"$as_me: error: in \\`$ac_pwd':\" >&2;}\n+as_fn_error $? \"cannot run test program while cross compiling\n+See \\`config.log' for more details\" \"$LINENO\" 5; }\n+else\n+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext\n+/* end confdefs.h.  */\n+\n+static void\n+foo (void)\n+{\n+}\n+\n+static void\n+__attribute__ ((noinline, noclone))\n+xxx (void (*f) (void))\n+{\n+  f ();\n+}\n+\n+static void\n+__attribute__ ((noinline, noclone))\n+bar (void)\n+{\n+  xxx (foo);\n+}\n+\n+int\n+main ()\n+{\n+  bar ();\n+  return 0;\n+}\n+\n+_ACEOF\n+if ac_fn_c_try_run \"$LINENO\"; then :\n+  have_cet=no\n+else\n+  have_cet=yes\n+fi\n+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \\\n+  conftest.$ac_objext conftest.beam conftest.$ac_ext\n+fi\n+\n+  LDFLAGS=\"$save_LDFLAGS\"\n+  if test x$enable_cet = xno -a x$have_cet = xyes; then\n+    as_fn_error $? \"Intel CET must be enabled on Intel CET enabled host\" \"$LINENO\" 5\n+  fi\n+fi\n+if test x$enable_cet = xyes; then\n+  CET_HOST_FLAGS=\"-fcf-protection\"\n+  { $as_echo \"$as_me:${as_lineno-$LINENO}: result: yes\" >&5\n+$as_echo \"yes\" >&6; }\n+else\n+  { $as_echo \"$as_me:${as_lineno-$LINENO}: result: no\" >&5\n+$as_echo \"no\" >&6; }\n+fi\n+\n+case x$enable_languages in\n+*jit*)\n+  ;;\n+*)\n+  CET_HOST_FLAGS=\n+  ;;\n+esac\n+\n+\n # Check whether --enable-valgrind-annotations was given.\n if test \"${enable_valgrind_annotations+set}\" = set; then :\n   enableval=$enable_valgrind_annotations;"}, {"sha": "540efeb4629b57dd874961bf270012f67bd56539", "filename": "libcpp/configure.ac", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2Fconfigure.ac", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/051da74259d5ebbfaa5b363dd09dbe16a955d8a1/libcpp%2Fconfigure.ac", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2Fconfigure.ac?ref=051da74259d5ebbfaa5b363dd09dbe16a955d8a1", "patch": "@@ -206,6 +206,17 @@ AC_ARG_ENABLE(host-shared,\n [PICFLAG=-fPIC], [PICFLAG=])\n AC_SUBST(PICFLAG)\n \n+# Enable Intel CET on Intel CET enabled host if jit is enabled.\n+GCC_CET_HOST_FLAGS(CET_HOST_FLAGS)\n+case x$enable_languages in\n+*jit*)\n+  ;;\n+*)\n+  CET_HOST_FLAGS=\n+  ;;\n+esac\n+AC_SUBST(CET_HOST_FLAGS)\n+\n AC_ARG_ENABLE(valgrind-annotations,\n [AS_HELP_STRING([--enable-valgrind-annotations],\n \t\t[enable valgrind runtime interaction])], [],"}]}