{"sha": "8dd57939c20b5e218404a838f514429f8e414dea", "node_id": "C_kwDOANBUbNoAKDhkZDU3OTM5YzIwYjVlMjE4NDA0YTgzOGY1MTQ0MjlmOGU0MTRkZWE", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-03-29T06:33:30Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-03-29T06:37:48Z"}, "message": "tree-ssa-math-opts: Move PROP_gimple_opt_math from sincos pass to powcabs [PR109301]\n\nThe following testcase ICEs since the sincos and vect pass order has\nbeen swapped.  It is not valid to replace vector sqrt (sqrt (x)) with\npow (x, 0.25) because build_real on vector type is invalid (could be\nhandled by using build_uniform_cst and adjusting type passed to\nbuild_real) but more importantly because nothing checks if we can\nactually do vector pow.\nWhile we have pow_optab, apparently no target defines it, so it doesn't\nseem to be worth bothering with for now and the patch just punts on\nnon-scalar sqrts.\nI think the other simplifications next to it are fine, as they mostly\nuse CBRT which doesn't even have internal function (so is a builtin\nonly and therefore always scalar), or have already pow in the IL (which\ndoesn't have optab and shouldn't be thus vector either).\nIt is true that with <bits/math-vector.h> we do vectorize some calls to\npow or cbrt (but don't handle others strangely), but those aren't using\ninternal functions but simd clones and so match.pd doesn't know anything\nabout those (at least for now).\n\nThe following patch fixes it by mostly restoring the state before\nr13-1763 where canonicalize_math_p () was true only until the end of the\npass which transformed pow or pow-like calls before vectorization (formerly\nsincos pass, now it is powcabs pass).\npowcabs is a pass in the spot sincos was happening before, so the\nonly change was defer the sin+cos simplification into cexpi to a later\nnew pass (except for the name moving with it) and none of the\ncanonicalize_math_p () guarded simplification in match.pd seem to rely\non those sin+cos -> cexpi simplifications and canonicalize_math_p is\nthe only user of this property.\n\n2023-03-29  Jakub Jelinek  <jakub@redhat.com>\n\t    Richard Biener  <rguenther@suse.de>\n\n\tPR tree-optimization/109301\n\t* tree-ssa-math-opts.cc (pass_data_cse_sincos): Change\n\tproperties_provided from PROP_gimple_opt_math to 0.\n\t(pass_data_expand_powcabs): Change properties_provided from 0 to\n\tPROP_gimple_opt_math.\n\n\t* gcc.dg/pr109301.c: New test.", "tree": {"sha": "8d0bcdff7ce8588399da07ad56a6d6d1793b0095", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8d0bcdff7ce8588399da07ad56a6d6d1793b0095"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8dd57939c20b5e218404a838f514429f8e414dea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8dd57939c20b5e218404a838f514429f8e414dea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8dd57939c20b5e218404a838f514429f8e414dea", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8dd57939c20b5e218404a838f514429f8e414dea/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c9954996cd647daf0ba03e34dd279b97982f671f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c9954996cd647daf0ba03e34dd279b97982f671f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c9954996cd647daf0ba03e34dd279b97982f671f"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "ab26ea6b6aa3241784f2987fc5de0b080244d8e0", "filename": "gcc/testsuite/gcc.dg/pr109301.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8dd57939c20b5e218404a838f514429f8e414dea/gcc%2Ftestsuite%2Fgcc.dg%2Fpr109301.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8dd57939c20b5e218404a838f514429f8e414dea/gcc%2Ftestsuite%2Fgcc.dg%2Fpr109301.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr109301.c?ref=8dd57939c20b5e218404a838f514429f8e414dea", "patch": "@@ -0,0 +1,13 @@\n+/* PR tree-optimization/109301 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O3 -ffast-math\" } */\n+\n+double x[256];\n+\n+void\n+foo (void)\n+{\n+  for (int i = 0; i < 256; ++i)\n+    for (int j = 0; j < 8; ++j)\n+      x[i] = __builtin_pow (x[i], 0.5);\n+}"}, {"sha": "15eed3e960c4b38818c62f9cdb990015b8c0a2aa", "filename": "gcc/tree-ssa-math-opts.cc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8dd57939c20b5e218404a838f514429f8e414dea/gcc%2Ftree-ssa-math-opts.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8dd57939c20b5e218404a838f514429f8e414dea/gcc%2Ftree-ssa-math-opts.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-math-opts.cc?ref=8dd57939c20b5e218404a838f514429f8e414dea", "patch": "@@ -2237,7 +2237,7 @@ const pass_data pass_data_cse_sincos =\n   OPTGROUP_NONE, /* optinfo_flags */\n   TV_TREE_SINCOS, /* tv_id */\n   PROP_ssa, /* properties_required */\n-  PROP_gimple_opt_math, /* properties_provided */\n+  0, /* properties_provided */\n   0, /* properties_destroyed */\n   0, /* todo_flags_start */\n   TODO_update_ssa, /* todo_flags_finish */\n@@ -2331,7 +2331,7 @@ const pass_data pass_data_expand_powcabs =\n   OPTGROUP_NONE, /* optinfo_flags */\n   TV_TREE_POWCABS, /* tv_id */\n   PROP_ssa, /* properties_required */\n-  0, /* properties_provided */\n+  PROP_gimple_opt_math, /* properties_provided */\n   0, /* properties_destroyed */\n   0, /* todo_flags_start */\n   TODO_update_ssa, /* todo_flags_finish */"}]}