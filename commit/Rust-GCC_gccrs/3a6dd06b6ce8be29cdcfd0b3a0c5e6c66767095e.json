{"sha": "3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2E2ZGQwNmI2Y2U4YmUyOWNkY2ZkMGIzYTBjNWU2YzY2NzY3MDk1ZQ==", "commit": {"author": {"name": "Claudiu Zissulescu", "email": "claziss@gmail.com", "date": "2019-11-11T15:40:09Z"}, "committer": {"name": "Claudiu Zissulescu", "email": "claziss@gcc.gnu.org", "date": "2019-11-11T15:40:09Z"}, "message": "[ARC] Fix legitimize pic address.\n\nThere are cases when an pic address gets complicated, and it needs to\nbe resolved via force_reg function found in\nprepare_move_operands. When this happens, we need to disambiguate the\npic address and re-legitimize it.\n\ngcc/\nxxxx-xx-xx  Claudiu Zissulescu  <claziss@synopsys.com>\n\n\t* config/arc/arc.c (arc_legitimize_pic_address): Consider UNSPECs\n\tas well, if interesting recover the symbol and re-legitimize the\n\tpic address.\n\ngcc/testsuite/\nxxxx-xx-xx  Claudiu Zissulescu  <claziss@synopsys.com>\n\n\t* gcc.target/arc/pic-2.c: New file.\n\nFrom-SVN: r278056", "tree": {"sha": "d2c6f9613e5f0c63d11504626c807694ee3fa4ac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d2c6f9613e5f0c63d11504626c807694ee3fa4ac"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/comments", "author": {"login": "claziss", "id": 2761368, "node_id": "MDQ6VXNlcjI3NjEzNjg=", "avatar_url": "https://avatars.githubusercontent.com/u/2761368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/claziss", "html_url": "https://github.com/claziss", "followers_url": "https://api.github.com/users/claziss/followers", "following_url": "https://api.github.com/users/claziss/following{/other_user}", "gists_url": "https://api.github.com/users/claziss/gists{/gist_id}", "starred_url": "https://api.github.com/users/claziss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/claziss/subscriptions", "organizations_url": "https://api.github.com/users/claziss/orgs", "repos_url": "https://api.github.com/users/claziss/repos", "events_url": "https://api.github.com/users/claziss/events{/privacy}", "received_events_url": "https://api.github.com/users/claziss/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "e22c2220273615294dc7fb11867267ca92694358", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e22c2220273615294dc7fb11867267ca92694358", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e22c2220273615294dc7fb11867267ca92694358"}], "stats": {"total": 49, "additions": 49, "deletions": 0}, "files": [{"sha": "ff62a22d1ef3068e158527a0dca41b4b1db6ac63", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "patch": "@@ -1,3 +1,9 @@\n+2019-11-11  Claudiu Zissulescu <claziss@gmail.com>\n+\n+\t* config/arc/arc.c (arc_legitimize_pic_address): Consider UNSPECs\n+\tas well, if interesting recover the symbol and re-legitimize the\n+\tpic address.\n+\n 2019-11-11  Martin Liska  <mliska@suse.cz>\n \n \t* dbgcnt.def (DEBUG_COUNTER): Sort counters"}, {"sha": "c2d38dd0d583c94df8b43356c0d17e7a6bd1804e", "filename": "gcc/config/arc/arc.c", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2Fconfig%2Farc%2Farc.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2Fconfig%2Farc%2Farc.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Farc%2Farc.c?ref=3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "patch": "@@ -6219,6 +6219,22 @@ arc_legitimize_pic_address (rtx addr)\n \n   switch (GET_CODE (addr))\n     {\n+    case UNSPEC:\n+      /* Can be one or our GOT or GOTOFFPC unspecs.  This situation\n+\t happens when an address is not a legitimate constant and we\n+\t need the resolve it via force_reg in\n+\t prepare_move_operands.  */\n+      switch (XINT (addr, 1))\n+\t{\n+\tcase ARC_UNSPEC_GOT:\n+\tcase ARC_UNSPEC_GOTOFFPC:\n+\t  /* Recover the symbol ref.  */\n+\t  addr = XVECEXP (addr, 0, 0);\n+\t  break;\n+\tdefault:\n+\t  return addr;\n+\t}\n+      /* Fall through.  */\n     case SYMBOL_REF:\n       /* TLS symbols are handled in different place.  */\n       if (SYMBOL_REF_TLS_MODEL (addr))"}, {"sha": "06d98511d0de090dae05f6a3113f675bf9b4e550", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "patch": "@@ -1,3 +1,7 @@\n+2019-11-11  Claudiu Zissulescu <claziss@gmail.com>\n+\n+\t* gcc.target/arc/pic-2.c: New file.\n+\n 2019-11-11  Tobias Burnus  <tobias@codesourcery.com>\n \t    Mark Eggleston  <mark.eggleston@codethink.com>\n "}, {"sha": "4b0e17126e91611ba9bc9ce91e6700bf1f6ac5d6", "filename": "gcc/testsuite/gcc.target/arc/pic-2.c", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2Ftestsuite%2Fgcc.target%2Farc%2Fpic-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e/gcc%2Ftestsuite%2Fgcc.target%2Farc%2Fpic-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Farc%2Fpic-2.c?ref=3a6dd06b6ce8be29cdcfd0b3a0c5e6c66767095e", "patch": "@@ -0,0 +1,23 @@\n+/* { dg-do compile } */\n+/* { dg-skip-if \"PIC not available for ARC6xx\" { arc6xx } } */\n+/* { dg-options \"-mno-sdata -O2 -fpic -fno-builtin\" } */\n+\n+/* Check if we resolve correctly complex PIC addresses.  */\n+\n+char *foo (unsigned size)\n+{\n+  static char buf[32];\n+  register int i;\n+\n+  if (size > 31)\n+    size = 31;\n+\n+  for (i = 0; i < size; i++)\n+    {\n+      buf[i] = ' ';\n+    }\n+  buf[size] = '\\0';\n+  return buf;\n+}\n+\n+/* { dg-final { scan-assembler \"@buf.\\[0-9\\]\\+@pcl-1\" } } */"}]}