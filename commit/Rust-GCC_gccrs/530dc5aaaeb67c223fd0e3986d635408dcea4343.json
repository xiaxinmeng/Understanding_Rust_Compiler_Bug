{"sha": "530dc5aaaeb67c223fd0e3986d635408dcea4343", "node_id": "C_kwDOANBUbNoAKDUzMGRjNWFhYWViNjdjMjIzZmQwZTM5ODZkNjM1NDA4ZGNlYTQzNDM", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-08-26T07:28:48Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-08-26T07:28:48Z"}, "message": "internal-fn, tree-cfg: Fix .TRAP handling and another __builtin_trap vops issue [PR106099]\n\nThis patch fixes 2 __builtin_unreachable/__builtin_trap related issues.\nOne (first hunk) is that CDDCE happily removes calls to .TRAP ()\ninternal-fn as useless.  The problem is that the internal-fn is\nECF_CONST | ECF_NORETURN, doesn't have lhs and so DCE thinks it doesn't\nhave side-effects and removes it.  __builtin_unreachable which has\nthe same ECF_* flags works fine, as since PR44485 we implicitly add\nECF_LOOPING_CONST_OR_PURE to ECF_CONST | ECF_NORETURN builtins, but\ndo it in flags_from_decl_or_type which isn't called for internal-fns.\nAs IFN_TRAP is the only ifn with such flags, it seems easier to\nadd it explicitly.\n\nThe other issue (which on the testcase can be seen only with the\nfirst bug unfixed) is that execute_fixup_cfg can add a __builtin_trap\nwhich needs vops, but nothing adds it and it can appear in many passes\nwhich don't have corresponding TODO_update_ssa_only_virtuals etc.\nFixed similarly as last time but emitting ifn there instead.\n\n2022-08-26  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR tree-optimization/106099\n\t* internal-fn.def (TRAP): Add ECF_LOOPING_CONST_OR_PURE flag.\n\t* tree-cfg.cc (execute_fixup_cfg): Add IFN_TRAP instead of\n\t__builtin_trap to avoid the need of vops.\n\n\t* gcc.dg/pr106099.c: New test.", "tree": {"sha": "726aed837f295b9dfe8c694191948969ebbafa16", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/726aed837f295b9dfe8c694191948969ebbafa16"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/530dc5aaaeb67c223fd0e3986d635408dcea4343", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/530dc5aaaeb67c223fd0e3986d635408dcea4343", "html_url": "https://github.com/Rust-GCC/gccrs/commit/530dc5aaaeb67c223fd0e3986d635408dcea4343", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/530dc5aaaeb67c223fd0e3986d635408dcea4343/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eb4879ab9053085a59b8d1594ef76487948bba7e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eb4879ab9053085a59b8d1594ef76487948bba7e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/eb4879ab9053085a59b8d1594ef76487948bba7e"}], "stats": {"total": 27, "additions": 19, "deletions": 8}, "files": [{"sha": "5e672183f4def9d0cdc29cf12fe17e8cff928f9f", "filename": "gcc/internal-fn.def", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/530dc5aaaeb67c223fd0e3986d635408dcea4343/gcc%2Finternal-fn.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/530dc5aaaeb67c223fd0e3986d635408dcea4343/gcc%2Finternal-fn.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Finternal-fn.def?ref=530dc5aaaeb67c223fd0e3986d635408dcea4343", "patch": "@@ -458,7 +458,8 @@ DEF_INTERNAL_FN (SPACESHIP, ECF_CONST | ECF_LEAF | ECF_NOTHROW, NULL)\n \n /* __builtin_trap created from/for __builtin_unreachable.  */\n DEF_INTERNAL_FN (TRAP, ECF_CONST | ECF_LEAF | ECF_NORETURN\n-\t\t       | ECF_NOTHROW | ECF_COLD, NULL)\n+\t\t       | ECF_NOTHROW | ECF_COLD | ECF_LOOPING_CONST_OR_PURE,\n+\t\t NULL)\n \n #undef DEF_INTERNAL_INT_FN\n #undef DEF_INTERNAL_FLT_FN"}, {"sha": "01b11442b2f362347c1d8bc14ca5e97c54a82683", "filename": "gcc/testsuite/gcc.dg/pr106099.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/530dc5aaaeb67c223fd0e3986d635408dcea4343/gcc%2Ftestsuite%2Fgcc.dg%2Fpr106099.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/530dc5aaaeb67c223fd0e3986d635408dcea4343/gcc%2Ftestsuite%2Fgcc.dg%2Fpr106099.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr106099.c?ref=530dc5aaaeb67c223fd0e3986d635408dcea4343", "patch": "@@ -0,0 +1,10 @@\n+/* PR tree-optimization/106099 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O -fharden-compares -fno-tree-forwprop -fno-tree-ch -fno-tree-dominator-opts -fno-tree-ccp -funreachable-traps --param=scev-max-expr-size=1\" } */\n+\n+void\n+foo (void)\n+{\n+  for (unsigned i = 0; i == 0; i++)\n+    __builtin_printf (\"%d\", i);\n+}"}, {"sha": "91ec33c80a41e1e0cc6224e137dd42144724a168", "filename": "gcc/tree-cfg.cc", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/530dc5aaaeb67c223fd0e3986d635408dcea4343/gcc%2Ftree-cfg.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/530dc5aaaeb67c223fd0e3986d635408dcea4343/gcc%2Ftree-cfg.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-cfg.cc?ref=530dc5aaaeb67c223fd0e3986d635408dcea4343", "patch": "@@ -9878,16 +9878,16 @@ execute_fixup_cfg (void)\n \t    {\n \t      if (stmt && is_gimple_call (stmt))\n \t\tgimple_call_set_ctrl_altering (stmt, false);\n-\t      tree fndecl = builtin_decl_unreachable ();\n-\t      stmt = gimple_build_call (fndecl, 0);\n+\t      stmt = gimple_build_builtin_unreachable (UNKNOWN_LOCATION);\n \t      gimple_stmt_iterator gsi = gsi_last_bb (bb);\n \t      gsi_insert_after (&gsi, stmt, GSI_NEW_STMT);\n \t      if (!cfun->after_inlining)\n-\t\t{\n-\t\t  gcall *call_stmt = dyn_cast <gcall *> (stmt);\n-\t\t  node->create_edge (cgraph_node::get_create (fndecl),\n-\t\t\t\t     call_stmt, bb->count);\n-\t\t}\n+\t\tif (tree fndecl = gimple_call_fndecl (stmt))\n+\t\t  {\n+\t\t    gcall *call_stmt = dyn_cast <gcall *> (stmt);\n+\t\t    node->create_edge (cgraph_node::get_create (fndecl),\n+\t\t\t\t       call_stmt, bb->count);\n+\t\t  }\n \t    }\n \t}\n     }"}]}