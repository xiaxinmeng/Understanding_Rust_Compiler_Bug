{"sha": "4a8548473e9241313033cbd0ff3e37ab1f6971fe", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NGE4NTQ4NDczZTkyNDEzMTMwMzNjYmQwZmYzZTM3YWIxZjY5NzFmZQ==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2014-01-24T14:05:17Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2014-01-24T14:05:17Z"}, "message": "[multiple changes]\n\n2014-01-24  Ed Schonberg  <schonberg@adacore.com>\n\n\t* sem_util.adb (Is_Post_State): In a postcondition, a selected\n\tcomponent that denotes an implicit dereference is a reference\n\tto the post state of the subprogram.\n\n2014-01-24  Robert Dewar  <dewar@adacore.com>\n\n\t* sem_ch6.adb (Analyze_Subprogram_Body_Helper): SPARK_Mode OFF\n\tfor generated subprograms.\n\t(Analyze_Subprogram_Specification): Ditto.\n\n2014-01-24  Vincent Celier  <celier@adacore.com>\n\n\t* prj-dect.adb (Check_Attribute_Allowed): Detect more forbidden\n\tattributes in package Builder of aggregate and aggregate library\n\tprojects.\n\t* prj-nmsc.adb (Process_Naming_Scheme.Check.Check_Aggregate):\n\tRemove procedure (Process_Naming_Scheme.Check.Check_Aggregated):\n\tRemove parameters.  Change error message from \"... externally\n\tbuild library ...\" to \"... externally built project ...\".\n\t(Process_Naming_Scheme.Check): Do not do any check in aggregate\n\tproject, as attribute Library_Dir and Library_Name have already\n\tbeen detected as forbidden.\n\n2014-01-24  Vincent Celier  <celier@adacore.com>\n\n\t* prj-env.adb (Find_Project): If cached project path is not in\n\tproject directory, look in current directory first and use cached\n\tproject path only if project is not found in project directory.\n\nFrom-SVN: r207032", "tree": {"sha": "cc7968fa417787b85b2e39f85773e76f1db53f9f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cc7968fa417787b85b2e39f85773e76f1db53f9f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4a8548473e9241313033cbd0ff3e37ab1f6971fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4a8548473e9241313033cbd0ff3e37ab1f6971fe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4a8548473e9241313033cbd0ff3e37ab1f6971fe", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4a8548473e9241313033cbd0ff3e37ab1f6971fe/comments", "author": null, "committer": null, "parents": [{"sha": "a6ae518ff7855e89b8b1e578e2124fd0a79f3f84", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a6ae518ff7855e89b8b1e578e2124fd0a79f3f84", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a6ae518ff7855e89b8b1e578e2124fd0a79f3f84"}], "stats": {"total": 237, "additions": 139, "deletions": 98}, "files": [{"sha": "8c6087a7b46d67a109cac02daa04596ef115b60e", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=4a8548473e9241313033cbd0ff3e37ab1f6971fe", "patch": "@@ -1,3 +1,34 @@\n+2014-01-24  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_util.adb (Is_Post_State): In a postcondition, a selected\n+\tcomponent that denotes an implicit dereference is a reference\n+\tto the post state of the subprogram.\n+\n+2014-01-24  Robert Dewar  <dewar@adacore.com>\n+\n+\t* sem_ch6.adb (Analyze_Subprogram_Body_Helper): SPARK_Mode OFF\n+\tfor generated subprograms.\n+\t(Analyze_Subprogram_Specification): Ditto.\n+\n+2014-01-24  Vincent Celier  <celier@adacore.com>\n+\n+\t* prj-dect.adb (Check_Attribute_Allowed): Detect more forbidden\n+\tattributes in package Builder of aggregate and aggregate library\n+\tprojects.\n+\t* prj-nmsc.adb (Process_Naming_Scheme.Check.Check_Aggregate):\n+\tRemove procedure (Process_Naming_Scheme.Check.Check_Aggregated):\n+\tRemove parameters.  Change error message from \"... externally\n+\tbuild library ...\" to \"... externally built project ...\".\n+\t(Process_Naming_Scheme.Check): Do not do any check in aggregate\n+\tproject, as attribute Library_Dir and Library_Name have already\n+\tbeen detected as forbidden.\n+\n+2014-01-24  Vincent Celier  <celier@adacore.com>\n+\n+\t* prj-env.adb (Find_Project): If cached project path is not in\n+\tproject directory, look in current directory first and use cached\n+\tproject path only if project is not found in project directory.\n+\n 2014-01-24  Robert Dewar  <dewar@adacore.com>\n \n \t* sem_util.adb, lib-xref.adb: Correct false positive warnings."}, {"sha": "2ce031046eef42499f02358def1cd22dff015d46", "filename": "gcc/ada/prj-dect.adb", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fprj-dect.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fprj-dect.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fprj-dect.adb?ref=4a8548473e9241313033cbd0ff3e37ab1f6971fe", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 2001-2011, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2001-2013, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -253,6 +253,16 @@ package body Prj.Dect is\n               or else Name = Snames.Name_Exec_Dir\n               or else Name = Snames.Name_Source_Dirs\n               or else Name = Snames.Name_Inherit_Source_Path\n+              or else\n+                (Qualif = Aggregate and then Name = Snames.Name_Library_Dir)\n+              or else\n+                (Qualif = Aggregate and then Name = Snames.Name_Library_Name)\n+              or else Name = Snames.Name_Main\n+              or else Name = Snames.Name_Roots\n+              or else Name = Snames.Name_Externally_Built\n+              or else Name = Snames.Name_Executable\n+              or else Name = Snames.Name_Executable_Suffix\n+              or else Name = Snames.Name_Default_Switches\n             then\n                Error_Msg_Name_1 := Name;\n                Error_Msg"}, {"sha": "79436721b0ef8002729516214e8bd52e99a2e6e1", "filename": "gcc/ada/prj-env.adb", "status": "modified", "additions": 52, "deletions": 19, "changes": 71, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fprj-env.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fprj-env.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fprj-env.adb?ref=4a8548473e9241313033cbd0ff3e37ab1f6971fe", "patch": "@@ -2229,19 +2229,20 @@ package body Prj.Env is\n       Directory          : String;\n       Path               : out Namet.Path_Name_Type)\n    is\n+      Result  : String_Access;\n+      Has_Dot : Boolean := False;\n+      Key     : Name_Id;\n+\n       File : constant String := Project_File_Name;\n       --  Have to do a copy, in case the parameter is Name_Buffer, which we\n-      --  modify below\n+      --  modify below.\n \n-      function Try_Path_Name is new Find_Name_In_Path\n-        (Check_Filename => Is_Regular_File);\n-      --  Find a file in the project search path\n-\n-      --  Local Declarations\n+      Cached_Path : Namet.Path_Name_Type;\n+      --  This should be commented rather than making us guess from the name???\n \n-      Result  : String_Access;\n-      Has_Dot : Boolean := False;\n-      Key     : Name_Id;\n+      function Try_Path_Name is new\n+        Find_Name_In_Path (Check_Filename => Is_Regular_File);\n+      --  Find a file in the project search path\n \n    --  Start of processing for Find_Project\n \n@@ -2259,12 +2260,7 @@ package body Prj.Env is\n       Name_Len := File'Length;\n       Name_Buffer (1 .. Name_Len) := File;\n       Key := Name_Find;\n-      Path := Projects_Paths.Get (Self.Cache, Key);\n-\n-      if Path /= No_Path then\n-         Debug_Decrease_Indent;\n-         return;\n-      end if;\n+      Cached_Path := Projects_Paths.Get (Self.Cache, Key);\n \n       --  Check if File contains an extension (a dot before a\n       --  directory separator). If it is the case we do not try project file\n@@ -2283,13 +2279,42 @@ package body Prj.Env is\n \n       if not Is_Absolute_Path (File) then\n \n+         --  If we have found project in the cache, check if in the directory\n+\n+         if Cached_Path /= No_Path then\n+            declare\n+               Cached : constant String := Get_Name_String (Cached_Path);\n+            begin\n+               if (not Has_Dot\n+                    and then Cached =\n+                      GNAT.OS_Lib.Normalize_Pathname\n+                        (File & Project_File_Extension,\n+                         Directory      => Directory,\n+                         Resolve_Links  => Opt.Follow_Links_For_Files,\n+                         Case_Sensitive => True))\n+                 or else\n+                   Cached =\n+                     GNAT.OS_Lib.Normalize_Pathname\n+                       (File,\n+                        Directory      => Directory,\n+                        Resolve_Links  => Opt.Follow_Links_For_Files,\n+                        Case_Sensitive => True)\n+               then\n+                  Path := Cached_Path;\n+                  Debug_Decrease_Indent;\n+                  return;\n+               end if;\n+            end;\n+         end if;\n+\n          --  First we try <directory>/<file_name>.<extension>\n \n          if not Has_Dot then\n-            Result := Try_Path_Name\n-              (Self,\n-               Directory & Directory_Separator &\n-               File & Project_File_Extension);\n+            Result :=\n+              Try_Path_Name\n+                (Self,\n+                 Directory & Directory_Separator &\n+                   File & Project_File_Extension);\n          end if;\n \n          --  Then we try <directory>/<file_name>\n@@ -2300,6 +2325,14 @@ package body Prj.Env is\n          end if;\n       end if;\n \n+      --  If we found the path in the cache, this is the one\n+\n+      if Result = null and then Cached_Path /= No_Path then\n+         Path := Cached_Path;\n+         Debug_Decrease_Indent;\n+         return;\n+      end if;\n+\n       --  Then we try <file_name>.<extension>\n \n       if Result = null and then not Has_Dot then"}, {"sha": "54c4e4e3a44b6ee4c4f70316b85ca774451ca690", "filename": "gcc/ada/prj-nmsc.adb", "status": "modified", "additions": 7, "deletions": 69, "changes": 76, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fprj-nmsc.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fprj-nmsc.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fprj-nmsc.adb?ref=4a8548473e9241313033cbd0ff3e37ab1f6971fe", "patch": "@@ -8395,71 +8395,14 @@ package body Prj.Nmsc is\n          In_Aggregate_Lib : Boolean;\n          Data             : in out Tree_Processing_Data)\n       is\n-         procedure Check_Aggregate\n-           (Project : Project_Id;\n-            Data    : in out Tree_Processing_Data);\n-         --  Check the aggregate project attributes, reject any not supported\n-         --  attributes.\n-\n-         procedure Check_Aggregated\n-           (Project : Project_Id;\n-            Data    : in out Tree_Processing_Data);\n-         --  Check aggregated projects which should not be externally built.\n-         --  What is Data??? if same as outer Data, why passed???\n-         --  What exact check is performed here??? Seems a bad idea to have\n-         --  two procedures with such close names ???\n-\n-         ---------------------\n-         -- Check_Aggregate --\n-         ---------------------\n-\n-         procedure Check_Aggregate\n-           (Project : Project_Id;\n-            Data    : in out Tree_Processing_Data)\n-         is\n-            procedure Check_Not_Defined (Name : Name_Id);\n-            --  Report an error if Var is defined\n-\n-            -----------------------\n-            -- Check_Not_Defined --\n-            -----------------------\n-\n-            procedure Check_Not_Defined (Name : Name_Id) is\n-               Var : constant Prj.Variable_Value :=\n-                       Prj.Util.Value_Of\n-                         (Name, Project.Decl.Attributes, Data.Tree.Shared);\n-            begin\n-               if not Var.Default then\n-                  Error_Msg_Name_1 := Name;\n-                  Error_Msg\n-                    (Data.Flags, \"wrong attribute %% in aggregate library\",\n-                     Var.Location, Project);\n-               end if;\n-            end Check_Not_Defined;\n-\n-         --  Start of processing for Check_Aggregate\n-\n-         begin\n-            Check_Not_Defined (Snames.Name_Library_Dir);\n-            Check_Not_Defined (Snames.Name_Library_Interface);\n-            Check_Not_Defined (Snames.Name_Library_Name);\n-            Check_Not_Defined (Snames.Name_Library_Ali_Dir);\n-            Check_Not_Defined (Snames.Name_Library_Src_Dir);\n-            Check_Not_Defined (Snames.Name_Library_Options);\n-            Check_Not_Defined (Snames.Name_Library_Standalone);\n-            Check_Not_Defined (Snames.Name_Library_Kind);\n-            Check_Not_Defined (Snames.Name_Leading_Library_Options);\n-            Check_Not_Defined (Snames.Name_Library_Version);\n-         end Check_Aggregate;\n+         procedure Check_Aggregated;\n+         --  Check aggregated projects which should not be externally built\n \n          ----------------------\n          -- Check_Aggregated --\n          ----------------------\n \n-         procedure Check_Aggregated\n-           (Project : Project_Id;\n-            Data    : in out Tree_Processing_Data)\n-         is\n+         procedure Check_Aggregated is\n             L : Aggregated_Project_List;\n \n          begin\n@@ -8478,7 +8421,7 @@ package body Prj.Nmsc is\n                      Error_Msg_Name_1 := L.Project.Display_Name;\n                      Error_Msg\n                        (Data.Flags,\n-                        \"cannot aggregate externally build library %%\",\n+                        \"cannot aggregate externally built project %%\",\n                         Var.Location, Project);\n                   end if;\n                end;\n@@ -8504,10 +8447,10 @@ package body Prj.Nmsc is\n \n          case Project.Qualifier is\n             when Aggregate =>\n-               Check_Aggregated (Project, Data);\n+               Check_Aggregated;\n \n             when Aggregate_Library =>\n-               Check_Aggregated (Project, Data);\n+               Check_Aggregated;\n \n                if Project.Object_Directory = No_Path_Information then\n                   Project.Object_Directory := Project.Directory;\n@@ -8532,12 +8475,7 @@ package body Prj.Nmsc is\n \n          Check_Configuration (Project, Data);\n \n-         --  For aggregate project check no library attributes are defined\n-\n-         if Project.Qualifier = Aggregate then\n-            Check_Aggregate (Project, Data);\n-\n-         else\n+         if Project.Qualifier /= Aggregate then\n             Check_Library_Attributes (Project, Data);\n             Check_Package_Naming (Project, Data);\n "}, {"sha": "3fa6183f6b85dbee7b3586ded2a71f2e81568dc8", "filename": "gcc/ada/sem_ch6.adb", "status": "modified", "additions": 31, "deletions": 8, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fsem_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fsem_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch6.adb?ref=4a8548473e9241313033cbd0ff3e37ab1f6971fe", "patch": "@@ -2995,9 +2995,17 @@ package body Sem_Ch6 is\n \n             Push_Scope (Spec_Id);\n \n-            --  Set SPARK_Mode from spec if spec had a SPARK_Mode pragma\n+            --  Set SPARK_Mode\n \n-            if Present (SPARK_Pragma (Spec_Id))\n+            --  For internally generated subprogram, always off\n+\n+            if not Comes_From_Source (Spec_Id) then\n+               SPARK_Mode := Off;\n+               SPARK_Mode_Pragma := Empty;\n+\n+            --  Inherited from spec\n+\n+            elsif Present (SPARK_Pragma (Spec_Id))\n               and then not SPARK_Pragma_Inherited (Spec_Id)\n             then\n                SPARK_Mode_Pragma := SPARK_Pragma (Spec_Id);\n@@ -3058,12 +3066,19 @@ package body Sem_Ch6 is\n               (Body_Id, Body_Id, 'b', Set_Ref => False, Force => True);\n             Install_Formals (Body_Id);\n \n-            --  Set SPARK_Mode from context\n+            Push_Scope (Body_Id);\n \n-            Set_SPARK_Pragma (Body_Id, SPARK_Mode_Pragma);\n-            Set_SPARK_Pragma_Inherited (Body_Id, True);\n+            --  Set SPARK_Mode from context or OFF for internal routine\n \n-            Push_Scope (Body_Id);\n+            if Comes_From_Source (Body_Id) then\n+               Set_SPARK_Pragma (Body_Id, SPARK_Mode_Pragma);\n+               Set_SPARK_Pragma_Inherited (Body_Id, True);\n+            else\n+               Set_SPARK_Pragma (Body_Id, Empty);\n+               Set_SPARK_Pragma_Inherited (Body_Id, False);\n+               SPARK_Mode := Off;\n+               SPARK_Mode_Pragma := Empty;\n+            end if;\n          end if;\n \n          --  For stubs and bodies with no previous spec, generate references to\n@@ -3609,8 +3624,16 @@ package body Sem_Ch6 is\n \n       Generate_Definition (Designator);\n \n-      Set_SPARK_Pragma (Designator, SPARK_Mode_Pragma);\n-      Set_SPARK_Pragma_Inherited (Designator, True);\n+      --  Set SPARK mode, always off for internal routines, otherwise set\n+      --  from current context (may be overwritten later with explicit pragma)\n+\n+      if Comes_From_Source (Designator) then\n+         Set_SPARK_Pragma (Designator, SPARK_Mode_Pragma);\n+         Set_SPARK_Pragma_Inherited (Designator, True);\n+      else\n+         Set_SPARK_Pragma (Designator, Empty);\n+         Set_SPARK_Pragma_Inherited (Designator, False);\n+      end if;\n \n       if Debug_Flag_C then\n          Write_Str (\"==> subprogram spec \");"}, {"sha": "cf00b2f40d9cdec02df9880ec370584bf42b0b80", "filename": "gcc/ada/sem_util.adb", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fsem_util.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4a8548473e9241313033cbd0ff3e37ab1f6971fe/gcc%2Fada%2Fsem_util.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.adb?ref=4a8548473e9241313033cbd0ff3e37ab1f6971fe", "patch": "@@ -2618,7 +2618,13 @@ package body Sem_Util is\n             elsif Nkind_In (N, N_Expanded_Name, N_Identifier) then\n                Ent := Entity (N);\n \n-               if No (Ent) or else Ekind (Ent) in Assignable_Kind then\n+               --  The entity may be modifiable through an implicit dereference\n+\n+               if No (Ent)\n+                 or else Ekind (Ent) in Assignable_Kind\n+                 or else (Is_Access_Type (Etype (Ent))\n+                           and then Nkind (Parent (N)) = N_Selected_Component)\n+               then\n                   Post_State_Seen := True;\n                   return Abandon;\n                end if;"}]}