{"sha": "2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmNkYzg5MDlkMzgyMWY5N2ZiYTJhYTA2MzM5NmExYTA5ZTFmYTE0Yw==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@act-europe.fr", "date": "2003-11-10T09:42:57Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2003-11-10T09:42:57Z"}, "message": "re PR ada/12950 (Ada runtime is not relocatable)\n\n\tPR 12950\n\t* osint.ads, osint.adb (Relocate_Path, Executable_Suffix): New\n\tfunctions. Used to handle dynamic prefix relocation, via set_std_prefix.\n\tReplace GNAT_ROOT by GCC_ROOT.\n\n\t* Make-lang.in: Use new function Relocate_Path to generate sdefault.adb\n\nFrom-SVN: r73407", "tree": {"sha": "4723d970820033048fc611b3074e148191a1a633", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4723d970820033048fc611b3074e148191a1a633"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/comments", "author": null, "committer": null, "parents": [{"sha": "64323f62a668e5e88d0efae2eec9165d0d4fb8da", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/64323f62a668e5e88d0efae2eec9165d0d4fb8da", "html_url": "https://github.com/Rust-GCC/gccrs/commit/64323f62a668e5e88d0efae2eec9165d0d4fb8da"}], "stats": {"total": 158, "additions": 144, "deletions": 14}, "files": [{"sha": "bb635ba1b56c74d59392884365a92f4e9e33557b", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "patch": "@@ -1,3 +1,12 @@\n+2003-11-10  Arnaud Charlet  <charlet@act-europe.fr>\n+\n+\tPR 12950\n+\t* osint.ads, osint.adb (Relocate_Path, Executable_Suffix): New\n+\tfunctions. Used to handle dynamic prefix relocation, via set_std_prefix.\n+\tReplace GNAT_ROOT by GCC_ROOT.\n+\n+\t* Make-lang.in: Use new function Relocate_Path to generate sdefault.adb\n+\n 2003-11-06  Zack Weinberg  <zack@codesourcery.com>\n \n \t* misc.c (fp_prec_to_size, fp_size_to_prec): Use GET_MODE_PRECISION"}, {"sha": "0adc2f4f764a6683c0224889bc61c6908d3dd06b", "filename": "gcc/ada/Make-lang.in", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2FMake-lang.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2FMake-lang.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FMake-lang.in?ref=2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "patch": "@@ -1075,26 +1075,28 @@ ada/sdefault.adb: ada/stamp-sdefault ; @true\n ada/stamp-sdefault : $(srcdir)/version.c $(srcdir)/move-if-change \\\n  Makefile\n \t$(ECHO) \"pragma Style_Checks (Off);\" >tmp-sdefault.adb\n+\t$(ECHO) \"with Osint; use Osint;\" >>tmp-sdefault.adb\n \t$(ECHO) \"package body Sdefault is\" >>tmp-sdefault.adb\n-\t$(ECHO) \"   S1 : aliased constant String := \\\"$(ADA_INCLUDE_DIR)/\\\";\" >>tmp-sdefault.adb\n-\t$(ECHO) \"   S2 : aliased constant String := \\\"$(ADA_RTL_OBJ_DIR)/\\\";\" >>tmp-sdefault.adb\n-\t$(ECHO) \"   S3 : aliased constant String := \\\"$(target)/\\\";\" >>tmp-sdefault.adb\n-\t$(ECHO) \"   S4 : aliased constant String := \\\"$(libsubdir)/\\\";\" >>tmp-sdefault.adb\n+\t$(ECHO) \"   S0 : constant String := \\\"$(prefix)/\\\";\" >>tmp-sdefault.adb\n+\t$(ECHO) \"   S1 : constant String := \\\"$(ADA_INCLUDE_DIR)/\\\";\" >>tmp-sdefault.adb\n+\t$(ECHO) \"   S2 : constant String := \\\"$(ADA_RTL_OBJ_DIR)/\\\";\" >>tmp-sdefault.adb\n+\t$(ECHO) \"   S3 : constant String := \\\"$(target)/\\\";\" >>tmp-sdefault.adb\n+\t$(ECHO) \"   S4 : constant String := \\\"$(libsubdir)/\\\";\" >>tmp-sdefault.adb\n \t$(ECHO) \"   function Include_Dir_Default_Name return String_Ptr is\" >>tmp-sdefault.adb\n \t$(ECHO) \"   begin\" >>tmp-sdefault.adb\n-\t$(ECHO) \"      return new String'(S1);\" >>tmp-sdefault.adb\n+\t$(ECHO) \"      return Relocate_Path (S0, S1);\" >>tmp-sdefault.adb\n \t$(ECHO) \"   end Include_Dir_Default_Name;\" >>tmp-sdefault.adb\n \t$(ECHO) \"   function Object_Dir_Default_Name return String_Ptr is\" >>tmp-sdefault.adb\n \t$(ECHO) \"   begin\" >>tmp-sdefault.adb\n-\t$(ECHO) \"      return new String'(S2);\" >>tmp-sdefault.adb\n+\t$(ECHO) \"      return Relocate_Path (S0, S2);\" >>tmp-sdefault.adb\n \t$(ECHO) \"   end Object_Dir_Default_Name;\" >>tmp-sdefault.adb\n \t$(ECHO) \"   function Target_Name return String_Ptr is\" >>tmp-sdefault.adb\n \t$(ECHO) \"   begin\" >>tmp-sdefault.adb\n-\t$(ECHO) \"      return new String'(S3);\" >>tmp-sdefault.adb\n+\t$(ECHO) \"      return Relocate_Path (S0, S3);\" >>tmp-sdefault.adb\n \t$(ECHO) \"   end Target_Name;\" >>tmp-sdefault.adb\n \t$(ECHO) \"   function Search_Dir_Prefix return String_Ptr is\" >>tmp-sdefault.adb\n \t$(ECHO) \"   begin\" >>tmp-sdefault.adb\n-\t$(ECHO) \"      return new String'(S4);\" >>tmp-sdefault.adb\n+\t$(ECHO) \"      return Relocate_Path (S0, S4);\" >>tmp-sdefault.adb\n \t$(ECHO) \"   end Search_Dir_Prefix;\" >>tmp-sdefault.adb\n \t$(ECHO) \"end Sdefault;\" >> tmp-sdefault.adb\n \t$(srcdir)/move-if-change tmp-sdefault.adb ada/sdefault.adb"}, {"sha": "e5608509208ee961cb3ade53069f6402efe0f3c8", "filename": "gcc/ada/osint.adb", "status": "modified", "additions": 114, "deletions": 6, "changes": 120, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2Fosint.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2Fosint.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.adb?ref=2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "patch": "@@ -24,12 +24,13 @@\n --                                                                          --\n ------------------------------------------------------------------------------\n \n-with Fmap;     use Fmap;\n+with Fmap;             use Fmap;\n with Hostparm;\n-with Namet;    use Namet;\n-with Opt;      use Opt;\n-with Output;   use Output;\n-with Sdefault; use Sdefault;\n+with Namet;            use Namet;\n+with Opt;              use Opt;\n+with Output;           use Output;\n+with Sdefault;         use Sdefault;\n+with System.Case_Util; use System.Case_Util;\n with Table;\n \n with Unchecked_Conversion;\n@@ -42,6 +43,10 @@ package body Osint is\n    Running_Program : Program_Type := Unspecified;\n    Program_Set     : Boolean      := False;\n \n+   Std_Prefix      : String_Ptr;\n+   --  Standard prefix, computed dynamically the first time Relocate_Path\n+   --  is called, and cached for subsequent calls.\n+\n    -------------------------------------\n    -- Use of Name_Find and Name_Enter --\n    -------------------------------------\n@@ -71,6 +76,14 @@ package body Osint is\n    function Concat (String_One : String; String_Two : String) return String;\n    --  Concatenates 2 strings and returns the result of the concatenation\n \n+   function Executable_Prefix return String_Ptr;\n+   --  Returns the name of the root directory where the executable is stored.\n+   --  The executable must be located in a directory called \"bin\", or\n+   --  under root/lib/gcc-lib/..., or under root/libexec/gcc/... Thus, if\n+   --  the executable is stored in directory \"/foo/bar/bin\", this routine\n+   --  returns \"/foo/bar/\".\n+   --  Return \"\" if the location is not recognized as described above.\n+\n    function Update_Path (Path : String_Ptr) return String_Ptr;\n    --  Update the specified path to replace the prefix with the location\n    --  where GNAT is installed. See the file prefix.c in GCC for details.\n@@ -735,6 +748,63 @@ package body Osint is\n       return Name_Enter;\n    end Executable_Name;\n \n+   -------------------------\n+   -- Executable_Prefix --\n+   -------------------------\n+\n+   function Executable_Prefix return String_Ptr is\n+      Exec_Name : String (1 .. Len_Arg (0));\n+\n+      function Get_Install_Dir (Exec : String) return String_Ptr;\n+      --  S is the executable name preceeded by the absolute or relative\n+      --  path, e.g. \"c:\\usr\\bin\\gcc.exe\" or \"..\\bin\\gcc\".\n+\n+      ---------------------\n+      -- Get_Install_Dir --\n+      ---------------------\n+\n+      function Get_Install_Dir (Exec : String) return String_Ptr is\n+      begin\n+         for J in reverse Exec'Range loop\n+            if Is_Directory_Separator (Exec (J)) then\n+               if J < Exec'Last - 5 then\n+                  if (To_Lower (Exec (J + 1)) = 'l'\n+                      and then To_Lower (Exec (J + 2)) = 'i'\n+                      and then To_Lower (Exec (J + 3)) = 'b')\n+                    or else\n+                      (To_Lower (Exec (J + 1)) = 'b'\n+                       and then To_Lower (Exec (J + 2)) = 'i'\n+                       and then To_Lower (Exec (J + 3)) = 'n')\n+                  then\n+                     return new String'(Exec (Exec'First .. J));\n+                  end if;\n+               end if;\n+            end if;\n+         end loop;\n+\n+         return new String'(\"\");\n+      end Get_Install_Dir;\n+\n+   --  Beginning of Executable_Prefix\n+\n+   begin\n+      Osint.Fill_Arg (Exec_Name'Address, 0);\n+\n+      --  First determine if a path prefix was placed in front of the\n+      --  executable name.\n+\n+      for J in reverse Exec_Name'Range loop\n+         if Is_Directory_Separator (Exec_Name (J)) then\n+            return Get_Install_Dir (Exec_Name);\n+         end if;\n+      end loop;\n+\n+      --  If you are here, the user has typed the executable name with no\n+      --  directory prefix.\n+\n+      return Get_Install_Dir (GNAT.OS_Lib.Locate_Exec_On_Path (Exec_Name).all);\n+   end Executable_Prefix;\n+\n    ------------------\n    -- Exit_Program --\n    ------------------\n@@ -2074,6 +2144,44 @@ package body Osint is\n \n    end Read_Source_File;\n \n+   -------------------\n+   -- Relocate_Path --\n+   -------------------\n+\n+   function Relocate_Path\n+     (Prefix : String;\n+      Path   : String) return String_Ptr\n+   is\n+      S : String_Ptr;\n+\n+      procedure set_std_prefix (S : String; Len : Integer);\n+      pragma Import (C, set_std_prefix);\n+\n+   begin\n+      if Std_Prefix = null then\n+         Std_Prefix := Executable_Prefix;\n+\n+         if Std_Prefix.all /= \"\" then\n+            --  Remove trailing directory separator when calling set_std_prefix\n+\n+            set_std_prefix (Std_Prefix.all, Std_Prefix'Length - 1);\n+         end if;\n+      end if;\n+\n+      if Path (Prefix'Range) = Prefix then\n+         if Std_Prefix.all /= \"\" then\n+            S := new String\n+              (1 .. Std_Prefix'Length + Path'Last - Prefix'Last);\n+            S (1 .. Std_Prefix'Length) := Std_Prefix.all;\n+            S (Std_Prefix'Length + 1 .. S'Last) :=\n+              Path (Prefix'Last + 1 .. Path'Last);\n+            return S;\n+         end if;\n+      end if;\n+\n+      return new String'(Path);\n+   end Relocate_Path;\n+\n    -----------------\n    -- Set_Program --\n    -----------------\n@@ -2493,7 +2601,7 @@ package body Osint is\n \n       In_Length      : constant Integer := Path'Length;\n       In_String      : String (1 .. In_Length + 1);\n-      Component_Name : aliased String := \"GNAT\" & ASCII.NUL;\n+      Component_Name : aliased String := \"GCC\" & ASCII.NUL;\n       Result_Ptr     : Address;\n       Result_Length  : Integer;\n       Out_String     : String_Ptr;"}, {"sha": "5f137b7c7faa29c02bb39e636deb238d3fe1e3b9", "filename": "gcc/ada/osint.ads", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2Fosint.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cdc8909d3821f97fba2aa063396a1a09e1fa14c/gcc%2Fada%2Fosint.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.ads?ref=2cdc8909d3821f97fba2aa063396a1a09e1fa14c", "patch": "@@ -202,6 +202,17 @@ package Osint is\n       return           String_Access;\n    --  Convert a canonical syntax file specification to host syntax.\n \n+   function Relocate_Path\n+     (Prefix : String;\n+      Path   : String) return String_Ptr;\n+   --  Given an absolute path and a prefix, if Path starts with Prefix,\n+   --  replace the Prefix substring with the root installation directory.\n+   --  By default, try to compute the root installation directory by looking\n+   --  at the executable name as it was typed on the command line and, if\n+   --  needed, use the PATH environment variable.\n+   --  If the above computation fails, return Path.\n+   --  This function assumes that Prefix'First = Path'First\n+\n    -------------------------\n    -- Search Dir Routines --\n    -------------------------"}]}