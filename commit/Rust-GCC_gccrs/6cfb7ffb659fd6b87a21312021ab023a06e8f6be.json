{"sha": "6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "node_id": "C_kwDOANBUbNoAKDZjZmI3ZmZiNjU5ZmQ2Yjg3YTIxMzEyMDIxYWIwMjNhMDZlOGY2YmU", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-02-15T12:47:39Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-02-15T12:49:34Z"}, "message": "libstdc++: Add missing constexpr to uses-allocator construction utilities [PR104542]\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/104542\n\t* include/bits/uses_allocator_args.h (make_obj_using_allocator)\n\t(uninitialized_construct_using_allocator): Add constexpr.\n\t* testsuite/20_util/uses_allocator/make_obj.cc: Check constexpr.\n\t* testsuite/20_util/uses_allocator/uninitialized_construct.cc: New test.", "tree": {"sha": "25c6cd86886a89df762c311db87514bd524dcfd7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/25c6cd86886a89df762c311db87514bd524dcfd7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d03a67dc69251dc86c0772a432380a6e9bcb8617", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d03a67dc69251dc86c0772a432380a6e9bcb8617", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d03a67dc69251dc86c0772a432380a6e9bcb8617"}], "stats": {"total": 51, "additions": 48, "deletions": 3}, "files": [{"sha": "d92dd1f0901b40128eed404d0765c0be3b14090d", "filename": "libstdc++-v3/include/bits/uses_allocator_args.h", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fuses_allocator_args.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fuses_allocator_args.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fuses_allocator_args.h?ref=6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "patch": "@@ -196,7 +196,7 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n     }\n \n   template<typename _Tp, typename _Alloc, typename... _Args>\n-    inline _Tp\n+    constexpr _Tp\n     make_obj_using_allocator(const _Alloc& __a, _Args&&... __args)\n     {\n       return std::make_from_tuple<_Tp>(\n@@ -205,7 +205,7 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n     }\n \n   template<typename _Tp, typename _Alloc, typename... _Args>\n-    inline _Tp*\n+    constexpr _Tp*\n     uninitialized_construct_using_allocator(_Tp* __p, const _Alloc& __a,\n \t\t\t\t\t    _Args&&... __args)\n     {"}, {"sha": "2dd0f819657297583af4c4cb3c61fd7d8e93bc7a", "filename": "libstdc++-v3/testsuite/20_util/uses_allocator/make_obj.cc", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fuses_allocator%2Fmake_obj.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fuses_allocator%2Fmake_obj.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fuses_allocator%2Fmake_obj.cc?ref=6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "patch": "@@ -142,7 +142,7 @@ test01()\n   VERIFY( c2.alloc_id == 1 );\n }\n \n-void \n+void\n test02()\n {\n   decltype(auto) b\n@@ -389,6 +389,34 @@ test08()\n   std::make_obj_using_allocator<X>(a);\n }\n \n+constexpr bool\n+test_pr104542()\n+{\n+  // PR libstdc++/104542 - missing constexpr\n+  std::allocator<void> a;\n+  int i = std::make_obj_using_allocator<int>(a, 1);\n+\n+  struct X {\n+    using allocator_type = std::allocator<long>;\n+    constexpr X(std::allocator_arg_t, std::allocator<int>, int i) : i(i+1) { }\n+    int i;\n+  };\n+\n+  X x = std::make_obj_using_allocator<X>(a, i);\n+\n+  struct Y {\n+    using allocator_type = std::allocator<char>;\n+    constexpr Y(X x, std::allocator<int>) : i(x.i+1) { }\n+    int i;\n+  };\n+\n+  Y y = std::make_obj_using_allocator<Y>(a, x);\n+\n+  return y.i == 3;\n+}\n+\n+static_assert( test_pr104542() );\n+\n int\n main()\n {"}, {"sha": "f403cbe99cc6f7de449d71a85929fc5b188460da", "filename": "libstdc++-v3/testsuite/20_util/uses_allocator/uninitialized_construct.cc", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fuses_allocator%2Funinitialized_construct.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cfb7ffb659fd6b87a21312021ab023a06e8f6be/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fuses_allocator%2Funinitialized_construct.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fuses_allocator%2Funinitialized_construct.cc?ref=6cfb7ffb659fd6b87a21312021ab023a06e8f6be", "patch": "@@ -0,0 +1,17 @@\n+// { dg-options \"-std=gnu++20\" }\n+// { dg-do compile { target c++20 } }\n+\n+#include <memory>\n+\n+constexpr bool\n+test_pr104542()\n+{\n+  // PR libstdc++/104542 - missing constexpr\n+  std::allocator<int> a;\n+  int* p = a.allocate(1);\n+  int i = *std::uninitialized_construct_using_allocator<int>(p, a, 999);\n+  a.deallocate(p, 1);\n+  return i == 999;\n+}\n+\n+static_assert( test_pr104542() );"}]}