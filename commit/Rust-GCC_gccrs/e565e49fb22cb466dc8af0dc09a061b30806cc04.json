{"sha": "e565e49fb22cb466dc8af0dc09a061b30806cc04", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTU2NWU0OWZiMjJjYjQ2NmRjOGFmMGRjMDlhMDYxYjMwODA2Y2MwNA==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2019-12-20T11:22:52Z"}, "committer": {"name": "Tobias Burnus", "email": "burnus@gcc.gnu.org", "date": "2019-12-20T11:22:52Z"}, "message": "Improve is-coindexed check for OpenACC/OpenMP\n\n        gcc/fortran/\n        * openmp.c (resolve_omp_clauses): Move is-coindexed check from here ...\n        (gfc_match_omp_variable_list): ... to here.\n\n        gcc/testsuite/\n        * gfortran.dg/goacc/coindexed-1.f90: New.\n\nFrom-SVN: r279637", "tree": {"sha": "8777317532d57be3672b1f1824d9f20928205f39", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8777317532d57be3672b1f1824d9f20928205f39"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e565e49fb22cb466dc8af0dc09a061b30806cc04", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e565e49fb22cb466dc8af0dc09a061b30806cc04", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e565e49fb22cb466dc8af0dc09a061b30806cc04", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e565e49fb22cb466dc8af0dc09a061b30806cc04/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "74a7b87a008bfaca392980dfedb30730a8f256e4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/74a7b87a008bfaca392980dfedb30730a8f256e4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/74a7b87a008bfaca392980dfedb30730a8f256e4"}], "stats": {"total": 54, "additions": 51, "deletions": 3}, "files": [{"sha": "d382ac056668b84dd19aba1668850e54d3e5cf65", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=e565e49fb22cb466dc8af0dc09a061b30806cc04", "patch": "@@ -1,3 +1,8 @@\n+2019-12-20  Tobias Burnus  <tobias@codesourcery.com>\n+\n+\t* openmp.c (resolve_omp_clauses): Move is-coindexed check from here ...\n+\t(gfc_match_omp_variable_list): ... to here.\n+\n 2019-12-19  Julian Brown  <julian@codesourcery.com>\n \n \t* openmp.c (resolve_oacc_data_clauses): Don't disallow allocatable"}, {"sha": "01964f964d790f493312a56799e4130f191d5545", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=e565e49fb22cb466dc8af0dc09a061b30806cc04", "patch": "@@ -274,6 +274,11 @@ gfc_match_omp_variable_list (const char *str, gfc_omp_namelist **list,\n \t\tdefault:\n \t\t  break;\n \t\t}\n+\t      if (gfc_is_coindexed (expr))\n+\t\t{\n+\t\t  gfc_error (\"List item shall not be coindexed at %C\");\n+\t\t  goto cleanup;\n+\t\t}\n \t    }\n \t  gfc_set_sym_referenced (sym);\n \t  p = gfc_get_omp_namelist ();\n@@ -4544,9 +4549,6 @@ resolve_omp_clauses (gfc_code *code, gfc_omp_clauses *omp_clauses,\n \t\t      gfc_error (\"%qs in %s clause at %L is not a proper \"\n \t\t\t\t \"array section\", n->sym->name, name,\n \t\t\t\t &n->where);\n-\t\t    else if (gfc_is_coindexed (n->expr))\n-\t\t      gfc_error (\"Entry shall not be coindexed in %s \"\n-\t\t\t\t \"clause at %L\", name, &n->where);\n \t\t    else\n \t\t      {\n \t\t\tint i;"}, {"sha": "8f2aba2f7edf7241c00f80d7b0d8011f712e9a52", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e565e49fb22cb466dc8af0dc09a061b30806cc04", "patch": "@@ -1,3 +1,7 @@\n+2019-12-20  Tobias Burnus  <tobias@codesourcery.com>\n+\n+\t* gfortran.dg/goacc/coindexed-1.f90: New.\n+\n 2019-12-20  Tobias Burnus  <tobias@codesourcery.com>\n \n \t* gfortran.dg/goacc/data-clauses.f95: Remove now"}, {"sha": "7e0d1dd8c5de4be0cc159624f6bc281293a31171", "filename": "gcc/testsuite/gfortran.dg/goacc/coindexed-1.f90", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fcoindexed-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e565e49fb22cb466dc8af0dc09a061b30806cc04/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fcoindexed-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fcoindexed-1.f90?ref=e565e49fb22cb466dc8af0dc09a061b30806cc04", "patch": "@@ -0,0 +1,37 @@\n+! { dg-do compile }\n+! { dg-additional-options \"-fcoarray=single\" }\n+! \n+subroutine check_coindexed()\n+implicit none\n+type t\n+  integer :: i\n+end type t\n+type t2\n+  integer, allocatable :: i[:]\n+  type(t), allocatable :: x[:]\n+end type t2\n+type(t), allocatable :: A(:)[:], B(:)[:]\n+type(t) :: D(1)[*], E[*]\n+type(t2) :: C\n+save :: D, E\n+\n+! Coarrays are fine if they are local/not coindexed:\n+\n+!$acc enter data copyin(D(1)%i)\n+!$acc enter data copyin(A(1))\n+!$acc enter data copyin(B(1)%i)\n+!$acc enter data copyin(C%i)\n+!$acc enter data copyin(C%x%i) \n+!$acc enter data copyin(C%i)\n+!$acc enter data copyin(C%x%i) \n+\n+! Does not like the '[' after the identifier:\n+!$acc enter data copyin(E[2]) ! { dg-error \"Syntax error in OpenMP variable list\" }\n+\n+!$acc enter data copyin(D(1)[2]%i) ! { dg-error \"List item shall not be coindexed\" }\n+!$acc enter data copyin(A(1)[4])   ! { dg-error \"List item shall not be coindexed\" }\n+!$acc enter data copyin(B(1)[4]%i) ! { dg-error \"List item shall not be coindexed\" }\n+!$acc enter data copyin(C%i[2])    ! { dg-error \"List item shall not be coindexed\" }\n+!$acc enter data copyin(C%x[4]%i)  ! { dg-error \"List item shall not be coindexed\" }\n+\n+end"}]}