{"sha": "c89956cba9d1a5fbf059f7880ff49418718a2965", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Yzg5OTU2Y2JhOWQxYTVmYmYwNTlmNzg4MGZmNDk0MTg3MThhMjk2NQ==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2020-09-16T21:21:32Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2020-09-18T21:38:34Z"}, "message": "analyzer: handle strdup and strndup\n\ngcc/analyzer/ChangeLog:\n\t* sm-malloc.cc (malloc_state_machine::on_stmt): Handle strdup and\n\tstrndup as being malloc-like allocators.\n\ngcc/testsuite/ChangeLog:\n\t* gcc.dg/analyzer/strdup-1.c: New test.\n\t* gcc.dg/analyzer/strndup-1.c: New test.", "tree": {"sha": "a4c2d0c4f393dd43f96f9e9060488debff8e2caf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a4c2d0c4f393dd43f96f9e9060488debff8e2caf"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c89956cba9d1a5fbf059f7880ff49418718a2965", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c89956cba9d1a5fbf059f7880ff49418718a2965", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c89956cba9d1a5fbf059f7880ff49418718a2965", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c89956cba9d1a5fbf059f7880ff49418718a2965/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1a1808cd19afd93fc4134fbd8376346d05bdba8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e1a1808cd19afd93fc4134fbd8376346d05bdba8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e1a1808cd19afd93fc4134fbd8376346d05bdba8"}], "stats": {"total": 46, "additions": 45, "deletions": 1}, "files": [{"sha": "90d1da14586d2c41d17a98a4bc9b64b1a4cc15f9", "filename": "gcc/analyzer/sm-malloc.cc", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c89956cba9d1a5fbf059f7880ff49418718a2965/gcc%2Fanalyzer%2Fsm-malloc.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c89956cba9d1a5fbf059f7880ff49418718a2965/gcc%2Fanalyzer%2Fsm-malloc.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fanalyzer%2Fsm-malloc.cc?ref=c89956cba9d1a5fbf059f7880ff49418718a2965", "patch": "@@ -984,7 +984,9 @@ malloc_state_machine::on_stmt (sm_context *sm_ctxt,\n \t    || is_std_named_call_p (callee_fndecl, \"malloc\", call, 1)\n \t    || is_std_named_call_p (callee_fndecl, \"calloc\", call, 2)\n \t    || is_named_call_p (callee_fndecl, \"__builtin_malloc\", call, 1)\n-\t    || is_named_call_p (callee_fndecl, \"__builtin_calloc\", call, 2))\n+\t    || is_named_call_p (callee_fndecl, \"__builtin_calloc\", call, 2)\n+\t    || is_named_call_p (callee_fndecl, \"strdup\", call, 1)\n+\t    || is_named_call_p (callee_fndecl, \"strndup\", call, 2))\n \t  {\n \t    on_allocator_call (sm_ctxt, call, m_malloc);\n \t    return true;"}, {"sha": "6b950ca23a99d37d526c9ed5c651c6931537630d", "filename": "gcc/testsuite/gcc.dg/analyzer/strdup-1.c", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c89956cba9d1a5fbf059f7880ff49418718a2965/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fstrdup-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c89956cba9d1a5fbf059f7880ff49418718a2965/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fstrdup-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fstrdup-1.c?ref=c89956cba9d1a5fbf059f7880ff49418718a2965", "patch": "@@ -0,0 +1,21 @@\n+#include <string.h>\n+#include <stdlib.h>\n+\n+extern void requires_nonnull (void *ptr)\n+  __attribute__((nonnull));\n+\n+void test_1 (const char *s)\n+{\n+  char *p = strdup (s); /* { dg-message \"allocated here\" } */\n+} /* { dg-warning \"leak of 'p'\" } */\n+\n+void test_2 (const char *s)\n+{\n+  char *p = strdup (s);\n+  free (p);\n+}\n+void test_3 (const char *s)\n+{\n+  char *p = strdup (s); /* { dg-message \"this call could return NULL\" } */\n+  requires_nonnull (p); /* { dg-warning \"use of possibly-NULL 'p'\" } */\n+}"}, {"sha": "23d9b6070ceae73887c4c2511b05d041e9ab5368", "filename": "gcc/testsuite/gcc.dg/analyzer/strndup-1.c", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c89956cba9d1a5fbf059f7880ff49418718a2965/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fstrndup-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c89956cba9d1a5fbf059f7880ff49418718a2965/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fstrndup-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Fstrndup-1.c?ref=c89956cba9d1a5fbf059f7880ff49418718a2965", "patch": "@@ -0,0 +1,21 @@\n+#include <string.h>\n+#include <stdlib.h>\n+\n+extern void requires_nonnull (void *ptr)\n+  __attribute__((nonnull));\n+\n+void test_1 (const char *s)\n+{\n+  char *p = strndup (s, 42); /* { dg-message \"allocated here\" } */\n+} /* { dg-warning \"leak of 'p'\" } */\n+\n+void test_2 (const char *s)\n+{\n+  char *p = strndup (s, 42);\n+  free (p);\n+}\n+void test_3 (const char *s)\n+{\n+  char *p = strndup (s, 42); /* { dg-message \"this call could return NULL\" } */\n+  requires_nonnull (p); /* { dg-warning \"use of possibly-NULL 'p'\" } */\n+}"}]}