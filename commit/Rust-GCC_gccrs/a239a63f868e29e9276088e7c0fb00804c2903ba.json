{"sha": "a239a63f868e29e9276088e7c0fb00804c2903ba", "node_id": "C_kwDOANBUbNoAKGEyMzlhNjNmODY4ZTI5ZTkyNzYwODhlN2MwZmIwMDgwNGMyOTAzYmE", "commit": {"author": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2022-11-04T21:24:42Z"}, "committer": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2022-11-07T19:59:21Z"}, "message": "Improve multiplication by powers of 2 in range-ops.\n\nFor unsigned numbers, multiplication by X, where X is a power of 2 is\n[0,0][X,+INF].\n\nThis patch causes a regression to g++.dg/pr71488.C where\n-Wstringop-overflow gets the same IL as before, but better ranges\ncause it to issue a bogus warning.  I will create a PR with some\nnotes.\n\nNo discernible changes in performance.\n\nTested on x86-64 Linux.\n\n\tPR tree-optimization/55157\n\ngcc/ChangeLog:\n\n\t* range-op.cc (operator_mult::wi_fold): Optimize multiplications\n\tby powers of 2.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.dg/tree-ssa/pr55157.c: New test.", "tree": {"sha": "90e71e763b7c61617545033ba4522df8073f847b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/90e71e763b7c61617545033ba4522df8073f847b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a239a63f868e29e9276088e7c0fb00804c2903ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a239a63f868e29e9276088e7c0fb00804c2903ba", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a239a63f868e29e9276088e7c0fb00804c2903ba", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a239a63f868e29e9276088e7c0fb00804c2903ba/comments", "author": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "committer": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "03ed4e57e3d46a61513b3d1ab1720997aec8cf71", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/03ed4e57e3d46a61513b3d1ab1720997aec8cf71", "html_url": "https://github.com/Rust-GCC/gccrs/commit/03ed4e57e3d46a61513b3d1ab1720997aec8cf71"}], "stats": {"total": 35, "additions": 33, "deletions": 2}, "files": [{"sha": "a13e88840a64063a9d529749344e66b190be9888", "filename": "gcc/range-op.cc", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a239a63f868e29e9276088e7c0fb00804c2903ba/gcc%2Frange-op.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a239a63f868e29e9276088e7c0fb00804c2903ba/gcc%2Frange-op.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frange-op.cc?ref=a239a63f868e29e9276088e7c0fb00804c2903ba", "patch": "@@ -1911,8 +1911,20 @@ operator_mult::wi_fold (irange &r, tree type,\n   // diff = max - min\n   prod2 = prod3 - prod0;\n   if (wi::geu_p (prod2, sizem1))\n-    // The range covers all values.\n-    r.set_varying (type);\n+    {\n+      // Multiplying by X, where X is a power of 2 is [0,0][X,+INF].\n+      if (TYPE_UNSIGNED (type) && rh_lb == rh_ub\n+\t  && wi::exact_log2 (rh_lb) != -1 && prec > 1)\n+\t{\n+\t  r.set (type, rh_lb, wi::max_value (prec, sign));\n+\t  int_range<2> zero;\n+\t  zero.set_zero (type);\n+\t  r.union_ (zero);\n+\t}\n+      else\n+\t// The range covers all values.\n+\tr.set_varying (type);\n+    }\n   else\n     {\n       wide_int new_lb = wide_int::from (prod0, prec, sign);"}, {"sha": "bbdda45bd6473290557ad002c70e2b1a6535cc0e", "filename": "gcc/testsuite/gcc.dg/tree-ssa/pr55157.c", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a239a63f868e29e9276088e7c0fb00804c2903ba/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr55157.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a239a63f868e29e9276088e7c0fb00804c2903ba/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr55157.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr55157.c?ref=a239a63f868e29e9276088e7c0fb00804c2903ba", "patch": "@@ -0,0 +1,19 @@\n+// { dg-do compile }\n+// { dg-options \"-O2 -fdump-tree-evrp\" }\n+\n+void gg(void);\n+int f(unsigned t)\n+{\n+  unsigned g = t*16;\n+  if (g==0)  return 1;\n+  gg();\n+  gg();\n+  gg();\n+  gg();\n+  gg();\n+  gg();\n+  if (g<=4)  return 1;\n+  return 0;\n+}\n+\n+// { dg-final { scan-tree-dump-times \" if \" 1 \"evrp\" } }"}]}