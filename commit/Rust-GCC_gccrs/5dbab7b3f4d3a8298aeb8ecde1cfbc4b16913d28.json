{"sha": "5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWRiYWI3YjNmNGQzYTgyOThhZWI4ZWNkZTFjZmJjNGIxNjkxM2QyOA==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-11-27T12:15:44Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-11-27T20:27:14Z"}, "message": "libphobos: Fix segfault at run-time when using custom Fibers (PR 98025)\n\nWhen libphobos is configured with --enable-cet, this adds extra fields\nto the Fiber class to support the ucontext_t fallback implementation.\nThese fields get omitted when compiling user code unless they also used\n`-fversion=CET' to build their project, which resulted in data being\noverwritten from within swapcontext().\n\nOn reviewing the ucontext_t definitions, it was found that the shadow\nstack fields were missing, and the struct size didn't match up on X32.\nThis has been fixed in upstream druntime and merged down here.\n\nReviewed-on: https://github.com/dlang/druntime/pull/3293\n\nlibphobos/ChangeLog:\n\n\tPR d/98025\n\t* Makefile.in: Regenerate.\n\t* configure: Regenerate.\n\t* configure.ac (DCFG_ENABLE_CET): Substitute.\n\t* libdruntime/MERGE: Merge upstream druntime 0fe7974c.\n\t* libdruntime/Makefile.in: Regenerate.\n\t* libdruntime/core/thread.d: Import gcc.config.\n\t(class Fiber): Add ucontext_t fields when GNU_Enable_CET is true.\n\t* libdruntime/gcc/config.d.in (GNU_Enable_CET): Define.\n\t* src/Makefile.in: Regenerate.\n\t* testsuite/Makefile.in: Regenerate.", "tree": {"sha": "b4ea6ea1b7e373db2ffae2e9cb7b4e2b50a9bbe1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b4ea6ea1b7e373db2ffae2e9cb7b4e2b50a9bbe1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b2f370fa915d74dff066d4b0340ddb459728046", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6b2f370fa915d74dff066d4b0340ddb459728046", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6b2f370fa915d74dff066d4b0340ddb459728046"}], "stats": {"total": 52, "additions": 43, "deletions": 9}, "files": [{"sha": "a13959298197767bd43c011a3108ebf8c852c5ed", "filename": "libphobos/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2FMakefile.in?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -217,6 +217,7 @@ CPPFLAGS = @CPPFLAGS@\n CYGPATH_W = @CYGPATH_W@\n DCFG_ARM_EABI_UNWINDER = @DCFG_ARM_EABI_UNWINDER@\n DCFG_DLPI_TLS_MODID = @DCFG_DLPI_TLS_MODID@\n+DCFG_ENABLE_CET = @DCFG_ENABLE_CET@\n DCFG_HAVE_64BIT_ATOMICS = @DCFG_HAVE_64BIT_ATOMICS@\n DCFG_HAVE_ATOMIC_BUILTINS = @DCFG_HAVE_ATOMIC_BUILTINS@\n DCFG_HAVE_LIBATOMIC = @DCFG_HAVE_LIBATOMIC@"}, {"sha": "77a3125cbd6d7ad712b28734030542163aa2c0c9", "filename": "libphobos/configure", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Fconfigure", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Fconfigure", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fconfigure?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -722,6 +722,7 @@ LIBTOOL\n CFLAGS_FOR_BUILD\n CC_FOR_BUILD\n AR\n+DCFG_ENABLE_CET\n CET_DFLAGS\n CET_FLAGS\n RANLIB\n@@ -5652,11 +5653,20 @@ fi\n \n \n # To ensure that runtime code for CET is compiled in, add in D version flags.\n-if test \"$enable_cet\" = yes; then\n+if test x$enable_cet = xyes; then :\n+\n   CET_DFLAGS=\"$CET_FLAGS -fversion=CET\"\n+  DCFG_ENABLE_CET=true\n+\n+else\n+\n+  CET_DFLAGS=\n+  DCFG_ENABLE_CET=false\n \n fi\n \n+\n+\n # This should be inherited in the recursive make, but ensure it is defined.\n test \"$AR\" || AR=ar\n \n@@ -11744,7 +11754,7 @@ else\n   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2\n   lt_status=$lt_dlunknown\n   cat > conftest.$ac_ext <<_LT_EOF\n-#line 11747 \"configure\"\n+#line 11757 \"configure\"\n #include \"confdefs.h\"\n \n #if HAVE_DLFCN_H\n@@ -11850,7 +11860,7 @@ else\n   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2\n   lt_status=$lt_dlunknown\n   cat > conftest.$ac_ext <<_LT_EOF\n-#line 11853 \"configure\"\n+#line 11863 \"configure\"\n #include \"confdefs.h\"\n \n #if HAVE_DLFCN_H"}, {"sha": "2d51e465a153535ee8f310697dd40b1a122dd46f", "filename": "libphobos/configure.ac", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Fconfigure.ac", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Fconfigure.ac", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fconfigure.ac?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -69,10 +69,15 @@ AC_PROG_MAKE_SET\n GCC_CET_FLAGS(CET_FLAGS)\n AC_SUBST(CET_FLAGS)\n # To ensure that runtime code for CET is compiled in, add in D version flags.\n-if test \"$enable_cet\" = yes; then\n+AS_IF([test x$enable_cet = xyes], [\n   CET_DFLAGS=\"$CET_FLAGS -fversion=CET\"\n-  AC_SUBST(CET_DFLAGS)\n-fi\n+  DCFG_ENABLE_CET=true\n+], [\n+  CET_DFLAGS=\n+  DCFG_ENABLE_CET=false\n+])\n+AC_SUBST(CET_DFLAGS)\n+AC_SUBST(DCFG_ENABLE_CET)\n \n # This should be inherited in the recursive make, but ensure it is defined.\n test \"$AR\" || AR=ar"}, {"sha": "7162844b9b6a3d3dd52b20c915c7e128ff3b4800", "filename": "libphobos/libdruntime/MERGE", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2FMERGE", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2FMERGE", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2FMERGE?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -1,4 +1,4 @@\n-d37ef985a97eb446371ab4b2315a52b87233fbf3\n+0fe7974cf53b75db59461de2a3d6e53ce933d297\n \n The first line of this file holds the git revision number of the last\n merge done from the dlang/druntime repository."}, {"sha": "99ee8b92afae18660831dc176d697ac79f0a6c4d", "filename": "libphobos/libdruntime/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2FMakefile.in?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -577,6 +577,7 @@ CPPFLAGS = @CPPFLAGS@\n CYGPATH_W = @CYGPATH_W@\n DCFG_ARM_EABI_UNWINDER = @DCFG_ARM_EABI_UNWINDER@\n DCFG_DLPI_TLS_MODID = @DCFG_DLPI_TLS_MODID@\n+DCFG_ENABLE_CET = @DCFG_ENABLE_CET@\n DCFG_HAVE_64BIT_ATOMICS = @DCFG_HAVE_64BIT_ATOMICS@\n DCFG_HAVE_ATOMIC_BUILTINS = @DCFG_HAVE_ATOMIC_BUILTINS@\n DCFG_HAVE_LIBATOMIC = @DCFG_HAVE_LIBATOMIC@"}, {"sha": "2e518aefa8456154b4f1ff28c985a2ad03f7258b", "filename": "libphobos/libdruntime/core/sys/posix/ucontext.d", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2Fcore%2Fsys%2Fposix%2Fucontext.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2Fcore%2Fsys%2Fposix%2Fucontext.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2Fcore%2Fsys%2Fposix%2Fucontext.d?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -114,7 +114,7 @@ version (CRuntime_Glibc)\n \n             enum NGREG = 23;\n \n-            alias c_long            greg_t;\n+            alias long              greg_t;\n             alias greg_t[NGREG]     gregset_t;\n             alias _libc_fpstate*    fpregset_t;\n         }\n@@ -123,7 +123,7 @@ version (CRuntime_Glibc)\n         {\n             gregset_t   gregs;\n             fpregset_t  fpregs;\n-            c_ulong[8]  __reserved1;\n+            ulong[8]    __reserved1;\n         }\n \n         struct ucontext_t\n@@ -134,6 +134,7 @@ version (CRuntime_Glibc)\n             mcontext_t      uc_mcontext;\n             sigset_t        uc_sigmask;\n             _libc_fpstate   __fpregs_mem;\n+            ulong[4]        __ssp;\n         }\n     }\n     else version (X86)\n@@ -205,6 +206,7 @@ version (CRuntime_Glibc)\n             mcontext_t      uc_mcontext;\n             sigset_t        uc_sigmask;\n             _libc_fpstate   __fpregs_mem;\n+            c_ulong[4]      __ssp;\n         }\n     }\n     else version (HPPA)"}, {"sha": "7506a8b3ee38c81a664a4b01dacafecd37494f08", "filename": "libphobos/libdruntime/core/thread.d", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2Fcore%2Fthread.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2Fcore%2Fthread.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2Fcore%2Fthread.d?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -52,6 +52,7 @@ version (Solaris)\n version (GNU)\n {\n     import gcc.builtins;\n+    import gcc.config;\n     version (GNU_StackGrowsDown)\n         version = StackGrowsDown;\n }\n@@ -5123,6 +5124,15 @@ private:\n         ucontext_t              m_utxt  = void;\n         ucontext_t*             m_ucur  = null;\n     }\n+    else static if (GNU_Enable_CET)\n+    {\n+        // When libphobos was built with --enable-cet, these fields need to\n+        // always be present in the Fiber class layout.\n+        import core.sys.posix.ucontext;\n+        static ucontext_t       sm_utxt = void;\n+        ucontext_t              m_utxt  = void;\n+        ucontext_t*             m_ucur  = null;\n+    }\n \n \n private:"}, {"sha": "9ac7d055271d2ab57e4590f3a14d94b7981e697e", "filename": "libphobos/libdruntime/gcc/config.d.in", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2Fgcc%2Fconfig.d.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Flibdruntime%2Fgcc%2Fconfig.d.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2Fgcc%2Fconfig.d.in?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -49,3 +49,6 @@ enum GNU_Have_LibAtomic = @DCFG_HAVE_LIBATOMIC@;\n \n // Do we have qsort_r function\n enum Have_Qsort_R = @DCFG_HAVE_QSORT_R@;\n+\n+// Whether libphobos been configured with --enable-cet.\n+enum GNU_Enable_CET = @DCFG_ENABLE_CET@;"}, {"sha": "2e721783d068170be5aa87f793c941267671d0dc", "filename": "libphobos/src/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Fsrc%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Fsrc%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fsrc%2FMakefile.in?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -333,6 +333,7 @@ CPPFLAGS = @CPPFLAGS@\n CYGPATH_W = @CYGPATH_W@\n DCFG_ARM_EABI_UNWINDER = @DCFG_ARM_EABI_UNWINDER@\n DCFG_DLPI_TLS_MODID = @DCFG_DLPI_TLS_MODID@\n+DCFG_ENABLE_CET = @DCFG_ENABLE_CET@\n DCFG_HAVE_64BIT_ATOMICS = @DCFG_HAVE_64BIT_ATOMICS@\n DCFG_HAVE_ATOMIC_BUILTINS = @DCFG_HAVE_ATOMIC_BUILTINS@\n DCFG_HAVE_LIBATOMIC = @DCFG_HAVE_LIBATOMIC@"}, {"sha": "c38a4688258f3ff110d21ca08129bfe6a4550ee2", "filename": "libphobos/testsuite/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Ftestsuite%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28/libphobos%2Ftestsuite%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Ftestsuite%2FMakefile.in?ref=5dbab7b3f4d3a8298aeb8ecde1cfbc4b16913d28", "patch": "@@ -161,6 +161,7 @@ CPPFLAGS = @CPPFLAGS@\n CYGPATH_W = @CYGPATH_W@\n DCFG_ARM_EABI_UNWINDER = @DCFG_ARM_EABI_UNWINDER@\n DCFG_DLPI_TLS_MODID = @DCFG_DLPI_TLS_MODID@\n+DCFG_ENABLE_CET = @DCFG_ENABLE_CET@\n DCFG_HAVE_64BIT_ATOMICS = @DCFG_HAVE_64BIT_ATOMICS@\n DCFG_HAVE_ATOMIC_BUILTINS = @DCFG_HAVE_ATOMIC_BUILTINS@\n DCFG_HAVE_LIBATOMIC = @DCFG_HAVE_LIBATOMIC@"}]}