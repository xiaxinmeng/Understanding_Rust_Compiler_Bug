{"sha": "baff22c48bdee9cb644b7336bf6f20f799531507", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmFmZjIyYzQ4YmRlZTljYjY0NGI3MzM2YmY2ZjIwZjc5OTUzMTUwNw==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-05-27T08:25:56Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-05-27T08:25:56Z"}, "message": "openmp: Fix up omp_declare_variant{s,_alt} htab handling\n\nThis patch fixes a GC ICE.  During debugging, I've found that during\ngimplification we can actually call omp_resolve_declare_variant multiple\ntimes and it would create a new magic declare_variant_alt FUNCTION_DECL\neach time, which is undesirable, once we have such a decl, we should just\nuse that.  The other problem is that there was no cgraph node removal hook.\nAs the omp_declare_variants htab is used just early during gimplification,\nwe can just clear the whole htab, rather than trying to lookup and remove\na particular entry.  The other hash table is used later as well and that\none uses just DECL_UID as hash, so in that case the patch removes the elt.\n\n2020-05-27  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR middle-end/95315\n\t* omp-general.c (omp_declare_variant_remove_hook): New function.\n\t(omp_resolve_declare_variant): Always return base if it is already\n\tdeclare_variant_alt magic decl itself.  Register\n\tomp_declare_variant_remove_hook as cgraph node removal hook.\n\n\t* gcc.dg/gomp/pr95315.c: New test.", "tree": {"sha": "4f364b848f4423d8b072c1c08da38a0c0ef1e43b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4f364b848f4423d8b072c1c08da38a0c0ef1e43b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/baff22c48bdee9cb644b7336bf6f20f799531507", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/baff22c48bdee9cb644b7336bf6f20f799531507", "html_url": "https://github.com/Rust-GCC/gccrs/commit/baff22c48bdee9cb644b7336bf6f20f799531507", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/baff22c48bdee9cb644b7336bf6f20f799531507/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "79ea774f9a9d36d986152d93f9eae4a9ba36b37b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/79ea774f9a9d36d986152d93f9eae4a9ba36b37b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/79ea774f9a9d36d986152d93f9eae4a9ba36b37b"}], "stats": {"total": 38, "additions": 38, "deletions": 0}, "files": [{"sha": "ed2764416e40f09da32e0932f265be1b7ad4b443", "filename": "gcc/omp-general.c", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/baff22c48bdee9cb644b7336bf6f20f799531507/gcc%2Fomp-general.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/baff22c48bdee9cb644b7336bf6f20f799531507/gcc%2Fomp-general.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-general.c?ref=baff22c48bdee9cb644b7336bf6f20f799531507", "patch": "@@ -1695,6 +1695,28 @@ omp_resolve_late_declare_variant (tree alt)\n   return varentry2->variant->decl;\n }\n \n+/* Hook to adjust hash tables on cgraph_node removal.  */\n+\n+static void\n+omp_declare_variant_remove_hook (struct cgraph_node *node, void *)\n+{\n+  if (!node->declare_variant_alt)\n+    return;\n+\n+  /* Drop this hash table completely.  */\n+  omp_declare_variants = NULL;\n+  /* And remove node from the other hash table.  */\n+  if (omp_declare_variant_alt)\n+    {\n+      omp_declare_variant_base_entry entry;\n+      entry.base = NULL;\n+      entry.node = node;\n+      entry.variants = NULL;\n+      omp_declare_variant_alt->remove_elt_with_hash (&entry,\n+\t\t\t\t\t\t     DECL_UID (node->decl));\n+    }\n+}\n+\n /* Try to resolve declare variant, return the variant decl if it should\n    be used instead of base, or base otherwise.  */\n \n@@ -1715,6 +1737,11 @@ omp_resolve_declare_variant (tree base)\n \tbreak;\n       if (TREE_CODE (TREE_PURPOSE (TREE_VALUE (attr))) != FUNCTION_DECL)\n \tcontinue;\n+      cgraph_node *node = cgraph_node::get (base);\n+      /* If this is already a magic decl created by this function,\n+\t don't process it again.  */\n+      if (node && node->declare_variant_alt)\n+\treturn base;\n       switch (omp_context_selector_matches (TREE_VALUE (TREE_VALUE (attr))))\n \t{\n \tcase 0:\n@@ -1823,6 +1850,12 @@ omp_resolve_declare_variant (tree base)\n \t    }\n \t}\n \n+      static struct cgraph_node_hook_list *node_removal_hook_holder;\n+      if (node_removal_hook_holder)\n+\tnode_removal_hook_holder\n+\t  = symtab->add_cgraph_removal_hook (omp_declare_variant_remove_hook,\n+\t\t\t\t\t     NULL);\n+\n       if (omp_declare_variants == NULL)\n \tomp_declare_variants\n \t  = hash_table<omp_declare_variant_hasher>::create_ggc (64);"}, {"sha": "4981e0b89499a2ad5d6d544c8e6a20e96469ba1d", "filename": "gcc/testsuite/gcc.dg/gomp/pr95315.c", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/baff22c48bdee9cb644b7336bf6f20f799531507/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr95315.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/baff22c48bdee9cb644b7336bf6f20f799531507/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr95315.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr95315.c?ref=baff22c48bdee9cb644b7336bf6f20f799531507", "patch": "@@ -0,0 +1,5 @@\n+/* PR middle-end/95315 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fopenmp --param ggc-min-heapsize=0\" } */\n+\n+#include \"../../c-c++-common/gomp/declare-variant-5.c\""}]}