{"sha": "7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6N2M2NTczMzlkNmE0YTY3MWI0Y2Q4YmM2MmJhNGUwZGY2YmZjN2M3Mg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2021-02-25T21:47:53Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2021-02-26T03:57:48Z"}, "message": "c++: Fix class NTTP constness handling [PR98810]\n\nHere, when substituting still-dependent args into an alias template, we see\na non-const type because the default argument is non-const, and is not a\ntemplate parm object because it's still dependent.\n\ngcc/cp/ChangeLog:\n\n\tPR c++/98810\n\t* pt.c (tsubst_copy) [VIEW_CONVERT_EXPR]: Add const\n\tto a class non-type template argument that needs it.\n\ngcc/testsuite/ChangeLog:\n\n\tPR c++/98810\n\t* g++.dg/cpp2a/nontype-class-defarg1.C: New test.", "tree": {"sha": "12e25384d7e0d1bab3e76732dfa2f27b0e03eadc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/12e25384d7e0d1bab3e76732dfa2f27b0e03eadc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0159535adb0e7400f2c6922f14a7602f6b90cf69", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0159535adb0e7400f2c6922f14a7602f6b90cf69", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0159535adb0e7400f2c6922f14a7602f6b90cf69"}], "stats": {"total": 33, "additions": 24, "deletions": 9}, "files": [{"sha": "6a2c4f372efdba0d592aa69ba1023791615de653", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 18, "deletions": 9, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72", "patch": "@@ -16826,18 +16826,27 @@ tsubst_copy (tree t, tree args, tsubst_flags_t complain, tree in_decl)\n \t    {\n \t      /* Wrapper to make a C++20 template parameter object const.  */\n \t      op = tsubst_copy (op, args, complain, in_decl);\n-\t      if (TREE_CODE (op) == TEMPLATE_PARM_INDEX)\n+\t      if (!CP_TYPE_CONST_P (TREE_TYPE (op)))\n \t\t{\n+\t\t  /* The template argument is not const, presumably because\n+\t\t     it is still dependent, and so not the const template parm\n+\t\t     object.  */\n \t\t  tree type = tsubst (TREE_TYPE (t), args, complain, in_decl);\n-\t\t  return build1 (code, type, op);\n-\t\t}\n-\t      else\n-\t\t{\n-\t\t  gcc_assert (CP_TYPE_CONST_P (TREE_TYPE (op))\n-\t\t\t      || (TREE_CODE (op) == IMPLICIT_CONV_EXPR\n-\t\t\t\t  && IMPLICIT_CONV_EXPR_NONTYPE_ARG (op)));\n-\t\t  return op;\n+\t\t  gcc_checking_assert (same_type_ignoring_top_level_qualifiers_p\n+\t\t\t\t       (type, TREE_TYPE (op)));\n+\t\t  if (TREE_CODE (op) == CONSTRUCTOR\n+\t\t      || TREE_CODE (op) == IMPLICIT_CONV_EXPR)\n+\t\t    {\n+\t\t      /* Don't add a wrapper to these.  */\n+\t\t      op = copy_node (op);\n+\t\t      TREE_TYPE (op) = type;\n+\t\t    }\n+\t\t  else\n+\t\t    /* Do add a wrapper otherwise (in particular, if op is\n+\t\t       another TEMPLATE_PARM_INDEX).  */\n+\t\t    op = build1 (code, type, op);\n \t\t}\n+\t      return op;\n \t    }\n \t  /* force_paren_expr can also create a VIEW_CONVERT_EXPR.  */\n \t  else if (code == VIEW_CONVERT_EXPR && REF_PARENTHESIZED_P (t))"}, {"sha": "85e50ff8069be4ac1835f5223176449e689adee4", "filename": "gcc/testsuite/g++.dg/cpp2a/nontype-class-defarg1.C", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fnontype-class-defarg1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fnontype-class-defarg1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fnontype-class-defarg1.C?ref=7c657339d6a4a671b4cd8bc62ba4e0df6bfc7c72", "patch": "@@ -0,0 +1,6 @@\n+// PR c++/98810\n+// { dg-do compile { target c++20 } }\n+\n+template <auto> struct a {};\n+template <int i, a <i> s = a <i> {}> using b = a <s>;\n+template <int i> constexpr auto g (const b <i> &) { return true; };"}]}