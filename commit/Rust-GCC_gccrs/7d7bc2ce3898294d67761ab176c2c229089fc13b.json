{"sha": "7d7bc2ce3898294d67761ab176c2c229089fc13b", "node_id": "C_kwDOANBUbNoAKDdkN2JjMmNlMzg5ODI5NGQ2Nzc2MWFiMTc2YzJjMjI5MDg5ZmMxM2I", "commit": {"author": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-03-14T12:53:10Z"}, "committer": {"name": "Philip Herron", "email": "philip.herron@embecosm.com", "date": "2022-03-14T12:57:01Z"}, "message": "Fix memory corruption in generation of builtin functions\n\nWhen we compile normal language functions we maintain a stack of the\ncurrent function declaration and associated return addresses. This is used\nwhile building up the GCC tree graph. When we generate builtin intrinsic\nfunctions such as offset or size_of were missing their associated push_fn\nbut still performed a pop_fn on completion this resulted in a corrupt\nstack which valgrind shown as bad read/writes.\n\nThis patch removes the pop_fn calls since no fncontext stack is required here for these intrinsics.\n\nFixes #1024", "tree": {"sha": "0feabb302e2ce7cc2652b235a1e498788df57f6e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0feabb302e2ce7cc2652b235a1e498788df57f6e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7d7bc2ce3898294d67761ab176c2c229089fc13b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7d7bc2ce3898294d67761ab176c2c229089fc13b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7d7bc2ce3898294d67761ab176c2c229089fc13b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7d7bc2ce3898294d67761ab176c2c229089fc13b/comments", "author": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philberty", "id": 84585, "node_id": "MDQ6VXNlcjg0NTg1", "avatar_url": "https://avatars.githubusercontent.com/u/84585?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philberty", "html_url": "https://github.com/philberty", "followers_url": "https://api.github.com/users/philberty/followers", "following_url": "https://api.github.com/users/philberty/following{/other_user}", "gists_url": "https://api.github.com/users/philberty/gists{/gist_id}", "starred_url": "https://api.github.com/users/philberty/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philberty/subscriptions", "organizations_url": "https://api.github.com/users/philberty/orgs", "repos_url": "https://api.github.com/users/philberty/repos", "events_url": "https://api.github.com/users/philberty/events{/privacy}", "received_events_url": "https://api.github.com/users/philberty/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41f402f0b19c7e4f19f8d4d65d15223d2752f302", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/41f402f0b19c7e4f19f8d4d65d15223d2752f302", "html_url": "https://github.com/Rust-GCC/gccrs/commit/41f402f0b19c7e4f19f8d4d65d15223d2752f302"}], "stats": {"total": 15, "additions": 11, "deletions": 4}, "files": [{"sha": "5fde694f1d88bf05377bccfd35a530bb0045a442", "filename": "gcc/rust/backend/rust-compile-intrinsic.cc", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7d7bc2ce3898294d67761ab176c2c229089fc13b/gcc%2Frust%2Fbackend%2Frust-compile-intrinsic.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7d7bc2ce3898294d67761ab176c2c229089fc13b/gcc%2Frust%2Fbackend%2Frust-compile-intrinsic.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-intrinsic.cc?ref=7d7bc2ce3898294d67761ab176c2c229089fc13b", "patch": "@@ -304,8 +304,6 @@ offset_intrinsic_handler (Context *ctx, TyTy::BaseType *fntype_tyty)\n \n   gcc_assert (TREE_CODE (bind_tree) == BIND_EXPR);\n   DECL_SAVED_TREE (fndecl) = bind_tree;\n-\n-  ctx->pop_fn ();\n   ctx->push_function (fndecl);\n \n   return fndecl;\n@@ -393,8 +391,6 @@ sizeof_intrinsic_handler (Context *ctx, TyTy::BaseType *fntype_tyty)\n \n   gcc_assert (TREE_CODE (bind_tree) == BIND_EXPR);\n   DECL_SAVED_TREE (fndecl) = bind_tree;\n-\n-  ctx->pop_fn ();\n   ctx->push_function (fndecl);\n \n   return fndecl;"}, {"sha": "109540934a830d7d1f5cbff88a3561e7a0a8965e", "filename": "gcc/testsuite/rust/compile/torture/issue-1024.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7d7bc2ce3898294d67761ab176c2c229089fc13b/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fissue-1024.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7d7bc2ce3898294d67761ab176c2c229089fc13b/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fissue-1024.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fissue-1024.rs?ref=7d7bc2ce3898294d67761ab176c2c229089fc13b", "patch": "@@ -0,0 +1,11 @@\n+extern \"rust-intrinsic\" {\n+    pub fn size_of<T>() -> usize;\n+}\n+\n+fn test() -> usize {\n+    unsafe { size_of::<i32>() }\n+}\n+\n+fn main() {\n+    let _a = test();\n+}"}]}