{"sha": "dda85bc274e1148a0c576a8cb085bffadd0e54ab", "node_id": "C_kwDOANBUbNoAKGRkYTg1YmMyNzRlMTE0OGEwYzU3NmE4Y2IwODViZmZhZGQwZTU0YWI", "commit": {"author": {"name": "Dimitar Dimitrov", "email": "dimitar@dinux.eu", "date": "2021-11-21T13:55:53Z"}, "committer": {"name": "Dimitar Dimitrov", "email": "dimitar@dinux.eu", "date": "2021-12-08T19:18:30Z"}, "message": "pru: Fixup flags for .pru_irq_map section\n\nAssign correct flags for the .pru_irq_map section, which the\nPRU remoteproc host loader introduced in Linux kernel 5.10:\n  https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c75c9fdac66efd8b54773368254ef330c276171b\n\ngcc/ChangeLog:\n\n\t* config/pru/pru.c (pru_section_type_flags): New function.\n\t(TARGET_SECTION_TYPE_FLAGS): Wire it.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.target/pru/pru_irq_map.c: New test.\n\nSigned-off-by: Dimitar Dimitrov <dimitar@dinux.eu>", "tree": {"sha": "2b292f595c964a999c5c9b62458e114007d2a9f6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2b292f595c964a999c5c9b62458e114007d2a9f6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dda85bc274e1148a0c576a8cb085bffadd0e54ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dda85bc274e1148a0c576a8cb085bffadd0e54ab", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dda85bc274e1148a0c576a8cb085bffadd0e54ab", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dda85bc274e1148a0c576a8cb085bffadd0e54ab/comments", "author": null, "committer": null, "parents": [{"sha": "e4c2b55b4cefc574a4c2b0b06928220edb9b3f2c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e4c2b55b4cefc574a4c2b0b06928220edb9b3f2c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e4c2b55b4cefc574a4c2b0b06928220edb9b3f2c"}], "stats": {"total": 27, "additions": 27, "deletions": 0}, "files": [{"sha": "01d283fd9e7d6a486cd5f1f9baa0691598f8d2a7", "filename": "gcc/config/pru/pru.c", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dda85bc274e1148a0c576a8cb085bffadd0e54ab/gcc%2Fconfig%2Fpru%2Fpru.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dda85bc274e1148a0c576a8cb085bffadd0e54ab/gcc%2Fconfig%2Fpru%2Fpru.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fpru%2Fpru.c?ref=dda85bc274e1148a0c576a8cb085bffadd0e54ab", "patch": "@@ -2022,6 +2022,23 @@ pru_assemble_integer (rtx x, unsigned int size, int aligned_p)\n     }\n }\n \n+/* Implement TARGET_SECTION_TYPE_FLAGS.  */\n+\n+static unsigned int\n+pru_section_type_flags (tree decl, const char *name, int reloc)\n+{\n+  unsigned int flags = default_section_type_flags (decl, name, reloc);\n+\n+  /* The .pru_irq_map section is not meant to be loaded into the target\n+     memory.  Instead its contents are read by the host remoteproc loader.\n+     To prevent being marked as a loadable (allocated) section, the\n+     .pru_irq_map section is intercepted and marked as a debug section.  */\n+  if (!strcmp (name, \".pru_irq_map\"))\n+    flags = SECTION_DEBUG | SECTION_RETAIN;\n+\n+  return flags;\n+}\n+\n /* Implement TARGET_ASM_FILE_START.  */\n \n static void\n@@ -3071,6 +3088,8 @@ pru_unwind_word_mode (void)\n #define TARGET_ASM_FUNCTION_PROLOGUE pru_asm_function_prologue\n #undef TARGET_ASM_INTEGER\n #define TARGET_ASM_INTEGER pru_assemble_integer\n+#undef TARGET_SECTION_TYPE_FLAGS\n+#define TARGET_SECTION_TYPE_FLAGS pru_section_type_flags\n \n #undef TARGET_ASM_FILE_START\n #define TARGET_ASM_FILE_START pru_file_start"}, {"sha": "4f9a5e71b01b8d69c465e3faaba9b7b3ac7a2a9f", "filename": "gcc/testsuite/gcc.target/pru/pru_irq_map.c", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dda85bc274e1148a0c576a8cb085bffadd0e54ab/gcc%2Ftestsuite%2Fgcc.target%2Fpru%2Fpru_irq_map.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dda85bc274e1148a0c576a8cb085bffadd0e54ab/gcc%2Ftestsuite%2Fgcc.target%2Fpru%2Fpru_irq_map.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fpru%2Fpru_irq_map.c?ref=dda85bc274e1148a0c576a8cb085bffadd0e54ab", "patch": "@@ -0,0 +1,8 @@\n+/* Test the special handling of .pru_irq_map section.  */\n+\n+/* { dg-do compile } */\n+\n+int my_int_map __attribute__((section(\".pru_irq_map\")));\n+\n+/* Section must not have the allocated flag.  */\n+/* { dg-final { scan-assembler \"\\.section\\[ \\t\\]+.pru_irq_map,\\[ \\]*\\\"\\\",[ ]*@progbits\" } } */"}]}