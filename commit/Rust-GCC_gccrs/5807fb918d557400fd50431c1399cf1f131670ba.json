{"sha": "5807fb918d557400fd50431c1399cf1f131670ba", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTgwN2ZiOTE4ZDU1NzQwMGZkNTA0MzFjMTM5OWNmMWYxMzE2NzBiYQ==", "commit": {"author": {"name": "Maxim Ostapenko", "email": "m.ostapenko@samsung.com", "date": "2017-01-18T16:06:31Z"}, "committer": {"name": "Maxim Ostapenko", "email": "chefmax@gcc.gnu.org", "date": "2017-01-18T16:06:31Z"}, "message": "re PR lto/79061 ([LTO][ASAN] LTO plus ASAN fails with \"AddressSanitizer: initialization-order-fiasco\")\n\n\tPR lto/79061\ngcc/\n\n\t* asan.c (get_translation_unit_decl): New function.\n\t(asan_add_global): Extract modules file name from globals\n\tTRANSLATION_UNIT_DECL in lto mode.\n\t* tree.c (build_translation_unit_decl): Add source location for newly\n\tbuilt TRANSLATION_UNIT_DECL.\n\ngcc/lto/\n\n\t* lto.c (lto_read_decls): accept location cache for\n\tTRANSLATION_UNIT_DECL.\n\t\ngcc/testsuite/\n\n\t* gcc.dg/cpp/mi1.c: Adjust testcase.\n\t* gcc.dg/pch/cpp-3.c: Likewise.\n\nFrom-SVN: r244581", "tree": {"sha": "7bc51d9df5797da527b28b3f4b7ecb580608b1e4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7bc51d9df5797da527b28b3f4b7ecb580608b1e4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5807fb918d557400fd50431c1399cf1f131670ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5807fb918d557400fd50431c1399cf1f131670ba", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5807fb918d557400fd50431c1399cf1f131670ba", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5807fb918d557400fd50431c1399cf1f131670ba/comments", "author": null, "committer": null, "parents": [{"sha": "0c6299bbfd50c064913bbc0e1d810848f66d8994", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0c6299bbfd50c064913bbc0e1d810848f66d8994", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0c6299bbfd50c064913bbc0e1d810848f66d8994"}], "stats": {"total": 63, "additions": 58, "deletions": 5}, "files": [{"sha": "8c4b9888527a4ee10e82c96457b956fbb5501c58", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -1,3 +1,12 @@\n+2017-01-18  Maxim Ostapenko  <m.ostapenko@samsung.com>\n+\n+\tPR lto/79061\n+\t* asan.c (get_translation_unit_decl): New function.\n+\t(asan_add_global): Extract modules file name from globals\n+\tTRANSLATION_UNIT_DECL in lto mode.\n+\t* tree.c (build_translation_unit_decl): Add source location for newly\n+\tbuilt TRANSLATION_UNIT_DECL.\n+\n 2017-01-18  Matthias Klose  <doko@ubuntu.com>\n \n        * doc/install.texi: Allow default for --with-target-bdw-gc-include."}, {"sha": "9a59fe4f100e862f59224d71017cac8d055947b6", "filename": "gcc/asan.c", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Fasan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Fasan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fasan.c?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -2372,6 +2372,22 @@ asan_needs_odr_indicator_p (tree decl)\n \t  && TREE_PUBLIC (decl));\n }\n \n+/* For given DECL return its corresponding TRANSLATION_UNIT_DECL.  */\n+\n+static const_tree\n+get_translation_unit_decl (tree decl)\n+{\n+  const_tree context = decl;\n+  while (context && TREE_CODE (context) != TRANSLATION_UNIT_DECL)\n+    {\n+      if (TREE_CODE (context) == BLOCK)\n+\tcontext = BLOCK_SUPERCONTEXT (context);\n+      else\n+\tcontext = get_containing_scope (context);\n+    }\n+  return context;\n+}\n+\n /* Append description of a single global DECL into vector V.\n    TYPE is __asan_global struct type as returned by asan_global_struct.  */\n \n@@ -2391,7 +2407,14 @@ asan_add_global (tree decl, tree type, vec<constructor_elt, va_gc> *v)\n     pp_string (&asan_pp, \"<unknown>\");\n   str_cst = asan_pp_string (&asan_pp);\n \n-  pp_string (&module_name_pp, main_input_filename);\n+  const char *filename = main_input_filename;\n+  if (in_lto_p)\n+    {\n+      const_tree translation_unit_decl = get_translation_unit_decl (decl);\n+      if (translation_unit_decl)\n+\tfilename = DECL_SOURCE_FILE (translation_unit_decl);\n+    }\n+  pp_string (&module_name_pp, filename);\n   module_name_cst = asan_pp_string (&module_name_pp);\n \n   if (asan_needs_local_alias (decl))"}, {"sha": "5a208575833795aef98a4e157a7708b6bb324f09", "filename": "gcc/lto/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Flto%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Flto%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2FChangeLog?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -1,3 +1,9 @@\n+2017-01-18  Maxim Ostapenko  <m.ostapenko@samsung.com>\n+\n+\tPR lto/79061\n+\t* lto.c (lto_read_decls): accept location cache for\n+\tTRANSLATION_UNIT_DECL.\n+\n 2017-01-11  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR middle-end/50199"}, {"sha": "c65e7cdbd389c7a299082ac136bc7e7f56993382", "filename": "gcc/lto/lto.c", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Flto%2Flto.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Flto%2Flto.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto.c?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -1707,7 +1707,13 @@ lto_read_decls (struct lto_file_decl_data *decl_data, const void *data,\n \t      && (TREE_CODE (first) == IDENTIFIER_NODE\n \t\t  || TREE_CODE (first) == INTEGER_CST\n \t\t  || TREE_CODE (first) == TRANSLATION_UNIT_DECL))\n-\t    continue;\n+\t    {\n+\t      /* For TRANSLATION_UNIT_DECL we need to accept location cache now\n+\t         to avoid possible reverting during following unify_scc call.  */\n+\t      if (TREE_CODE (first) == TRANSLATION_UNIT_DECL)\n+\t\tdata_in->location_cache.accept_location_cache ();\n+\t      continue;\n+\t    }\n \n \t  /* Try to unify the SCC with already existing ones.  */\n \t  if (!flag_ltrans"}, {"sha": "480a09b78c350db703589c0258d5bb21180099c7", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -1,3 +1,9 @@\n+2017-01-18  Maxim Ostapenko  <m.ostapenko@samsung.com>\n+\n+\tPR lto/79061\n+\t* gcc.dg/cpp/mi1.c: Adjust testcase.\n+\t* gcc.dg/pch/cpp-3.c: Likewise.\n+\n 2016-01-18  Bill Schmidt  <wschmidt@linux.vnet.ibm.com>\n \n \t* gcc.target/powerpc/p8vector-builtin-8.c: Add new form for"}, {"sha": "9817431b646a23df5958642c73724fa2808348a6", "filename": "gcc/testsuite/gcc.dg/cpp/mi1.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftestsuite%2Fgcc.dg%2Fcpp%2Fmi1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftestsuite%2Fgcc.dg%2Fcpp%2Fmi1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fcpp%2Fmi1.c?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -13,7 +13,7 @@\n \n /* { dg-do compile }\n    { dg-options \"-H\" }\n-   { dg-message \"mi1c\\.h\\n\\[^\\n\\]*mi1cc\\.h\\n\\[^\\n\\]*mi1nd\\.h\\n\\[^\\n\\]*mi1ndp\\.h\\n\\[^\\n\\]*mi1x\\.h\" \"redundant include check\" { target *-*-* } 0 } */\n+   { dg-message \"mi1c\\.h\\n\\[^\\n\\]*mi1cc\\.h\\n\\[^\\n\\]*mi1nd\\.h\\n\\[^\\n\\]*mi1ndp\\.h\\n\\[^\\n\\]*mi1x\\.h\\n\\[^\\n\\]*mi1\\.c\" \"redundant include check\" { target *-*-* } 0 } */\n \n #include \"mi1c.h\"\n #include \"mi1c.h\""}, {"sha": "d635706b4fd71b3b36d66c49528cde590eb1d9f9", "filename": "gcc/testsuite/gcc.dg/pch/cpp-3.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftestsuite%2Fgcc.dg%2Fpch%2Fcpp-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftestsuite%2Fgcc.dg%2Fpch%2Fcpp-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpch%2Fcpp-3.c?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -1,7 +1,7 @@\n /* PR preprocessor/36649 */\n /* { dg-do compile } */\n /* { dg-options \"-H -I.\" } */\n-/* { dg-message \"cpp-3.h\\[^\\n\\]*(\\n\\[^\\n\\]*cpp-3.c)?\\n\\[^\\n\\]*cpp-3a.h\\n\\[^\\n\\]*cpp-3b.h\" \"\" { target *-*-* } 0 } */\n+/* { dg-message \"cpp-3.h\\[^\\n\\]*(\\n\\[^\\n\\]*cpp-3.c)?\\n\\[^\\n\\]*cpp-3a.h\\n\\[^\\n\\]*cpp-3b.h\\n\\[^\\n\\]*cpp-3.c\" \"\" { target *-*-* } 0 } */\n \n #include \"cpp-3.h\"\n #include \"cpp-3a.h\""}, {"sha": "59fe8d4aff4d8ba951be77326baf2755cc97d6f2", "filename": "gcc/tree.c", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftree.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5807fb918d557400fd50431c1399cf1f131670ba/gcc%2Ftree.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree.c?ref=5807fb918d557400fd50431c1399cf1f131670ba", "patch": "@@ -4758,7 +4758,10 @@ vec<tree, va_gc> *all_translation_units;\n tree\n build_translation_unit_decl (tree name)\n {\n-  tree tu = build_decl (UNKNOWN_LOCATION, TRANSLATION_UNIT_DECL,\n+  linemap_add (line_table, LC_ENTER, false, main_input_filename, 1);\n+  location_t loc = linemap_line_start (line_table, 1, 0);\n+  linemap_add (line_table, LC_LEAVE, false, NULL, 0);\n+  tree tu = build_decl (loc, TRANSLATION_UNIT_DECL,\n \t\t\tname, NULL_TREE);\n   TRANSLATION_UNIT_LANGUAGE (tu) = lang_hooks.name;\n   vec_safe_push (all_translation_units, tu);"}]}