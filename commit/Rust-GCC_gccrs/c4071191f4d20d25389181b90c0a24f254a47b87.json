{"sha": "c4071191f4d20d25389181b90c0a24f254a47b87", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzQwNzExOTFmNGQyMGQyNTM4OTE4MWI5MGMwYTI0ZjI1NGE0N2I4Nw==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2018-11-14T09:01:47Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2018-11-14T09:01:47Z"}, "message": "re PR tree-optimization/87977 (ICE: verify_ssa failed (error: definition in block 4 follows the use))\n\n\tPR tree-optimization/87977\n\t* tree-ssa-math-opts.c (optimize_recip_sqrt): Don't reuse division\n\tstmt, build a new one and replace the old one with it.  Formatting fix.\n\tCall release_ssa_name (x) if !has_other_use and !delete_div.\n\t(pass_cse_reciprocals::execute): Before calling optimize_recip_sqrt\n\tverify lhs of stmt is still def.\n\n\t* gcc.dg/recip_sqrt_mult_1.c: Add -fcompare-debug to dg-options.\n\t* gcc.dg/recip_sqrt_mult_2.c: Likewise.\n\t* gcc.dg/recip_sqrt_mult_3.c: Likewise.\n\t* gcc.dg/recip_sqrt_mult_4.c: Likewise.\n\t* gcc.dg/recip_sqrt_mult_5.c: Likewise.\n\nFrom-SVN: r266098", "tree": {"sha": "67c8f5e231a7aebefb6f2d37deeea480644fd560", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/67c8f5e231a7aebefb6f2d37deeea480644fd560"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c4071191f4d20d25389181b90c0a24f254a47b87", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4071191f4d20d25389181b90c0a24f254a47b87", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c4071191f4d20d25389181b90c0a24f254a47b87", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4071191f4d20d25389181b90c0a24f254a47b87/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "38e601118ca88adf0a472750b0da83f0ef1798a7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/38e601118ca88adf0a472750b0da83f0ef1798a7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/38e601118ca88adf0a472750b0da83f0ef1798a7"}], "stats": {"total": 41, "additions": 33, "deletions": 8}, "files": [{"sha": "cbd89695b1d887a6b20f221839a4dbb51a9df37c", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,3 +1,12 @@\n+2018-11-14  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR tree-optimization/87977\n+\t* tree-ssa-math-opts.c (optimize_recip_sqrt): Don't reuse division\n+\tstmt, build a new one and replace the old one with it.  Formatting fix.\n+\tCall release_ssa_name (x) if !has_other_use and !delete_div.\n+\t(pass_cse_reciprocals::execute): Before calling optimize_recip_sqrt\n+\tverify lhs of stmt is still def.\n+\n 2018-11-13  Peter Bergner  <bergner@linux.ibm.com>\n \n \tPR rtl-optimization/87507"}, {"sha": "eb871d03d7c4cf60b4b1fe40f84e500ab5c5c8e2", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,3 +1,12 @@\n+2018-11-14  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR tree-optimization/87977\n+\t* gcc.dg/recip_sqrt_mult_1.c: Add -fcompare-debug to dg-options.\n+\t* gcc.dg/recip_sqrt_mult_2.c: Likewise.\n+\t* gcc.dg/recip_sqrt_mult_3.c: Likewise.\n+\t* gcc.dg/recip_sqrt_mult_4.c: Likewise.\n+\t* gcc.dg/recip_sqrt_mult_5.c: Likewise.\n+\n 2018-11-13  Peter Bergner  <bergner@linux.ibm.com>\n \n \tPR rtl-optimization/87507"}, {"sha": "e057306a4ee89514f7a0b1651e024ad4339b3d3f", "filename": "gcc/testsuite/gcc.dg/recip_sqrt_mult_1.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_1.c?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-Ofast -fdump-tree-recip\" } */\n+/* { dg-options \"-Ofast -fdump-tree-recip -fcompare-debug\" } */\n \n double res, res2, tmp;\n void"}, {"sha": "6ff284b60d3a14bf4764f191ea697acedbfed94c", "filename": "gcc/testsuite/gcc.dg/recip_sqrt_mult_2.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_2.c?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-Ofast -fdump-tree-optimized\" } */\n+/* { dg-options \"-Ofast -fdump-tree-optimized -fcompare-debug\" } */\n \n float\n foo (float a)"}, {"sha": "7a8305de72745df20f4840538c4f999426eee551", "filename": "gcc/testsuite/gcc.dg/recip_sqrt_mult_3.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_3.c?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-Ofast -fdump-tree-optimized\" } */\n+/* { dg-options \"-Ofast -fdump-tree-optimized -fcompare-debug\" } */\n \n double\n foo (double a)"}, {"sha": "3b8c1ec600f2b1c7478c777822aadff3706cf000", "filename": "gcc/testsuite/gcc.dg/recip_sqrt_mult_4.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_4.c?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-Ofast -fdump-tree-recip\" } */\n+/* { dg-options \"-Ofast -fdump-tree-recip -fcompare-debug\" } */\n \n /* The main path doesn't have any multiplications.\n    Avoid introducing them in the recip pass.  */"}, {"sha": "27c6cd2e5128336b0812cce52ea70245c66a726d", "filename": "gcc/testsuite/gcc.dg/recip_sqrt_mult_5.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_5.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_5.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Frecip_sqrt_mult_5.c?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-Ofast -fdump-tree-recip\" } */\n+/* { dg-options \"-Ofast -fdump-tree-recip -fcompare-debug\" } */\n \n /* We want to do the recip_sqrt transformations here there is already\n    a multiplication on the main path.  */"}, {"sha": "d21077734e6040d7b0f298bab35ada863f0e916e", "filename": "gcc/tree-ssa-math-opts.c", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftree-ssa-math-opts.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4071191f4d20d25389181b90c0a24f254a47b87/gcc%2Ftree-ssa-math-opts.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-math-opts.c?ref=c4071191f4d20d25389181b90c0a24f254a47b87", "patch": "@@ -652,8 +652,12 @@ optimize_recip_sqrt (gimple_stmt_iterator *def_gsi, tree def)\n \t  print_gimple_stmt (dump_file, stmt, 0, TDF_NONE);\n \t  fprintf (dump_file, \"with new division\\n\");\n \t}\n-      gimple_assign_set_lhs (stmt, sqr_ssa_name);\n-      gimple_assign_set_rhs2 (stmt, a);\n+      stmt\n+\t= gimple_build_assign (sqr_ssa_name, gimple_assign_rhs_code (stmt),\n+\t\t\t       gimple_assign_rhs1 (stmt), a);\n+      gsi_insert_before (def_gsi, stmt, GSI_SAME_STMT);\n+      gsi_remove (def_gsi, true);\n+      *def_gsi = gsi_for_stmt (stmt);\n       fold_stmt_inplace (def_gsi);\n       update_stmt (stmt);\n \n@@ -704,7 +708,7 @@ optimize_recip_sqrt (gimple_stmt_iterator *def_gsi, tree def)\n \n       gimple *new_stmt\n \t= gimple_build_assign (x, MULT_EXPR,\n-\t\t\t\torig_sqrt_ssa_name, sqr_ssa_name);\n+\t\t\t       orig_sqrt_ssa_name, sqr_ssa_name);\n       gsi_insert_after (def_gsi, new_stmt, GSI_NEW_STMT);\n       update_stmt (stmt);\n     }\n@@ -715,6 +719,8 @@ optimize_recip_sqrt (gimple_stmt_iterator *def_gsi, tree def)\n       gsi_remove (&gsi2, true);\n       release_defs (stmt);\n     }\n+  else\n+    release_ssa_name (x);\n }\n \n /* Look for floating-point divisions among DEF's uses, and try to\n@@ -951,6 +957,7 @@ pass_cse_reciprocals::execute (function *fun)\n \t      stmt = gsi_stmt (gsi);\n \t      if (flag_unsafe_math_optimizations\n \t\t  && is_gimple_assign (stmt)\n+\t\t  && gimple_assign_lhs (stmt) == def\n \t\t  && !stmt_can_throw_internal (cfun, stmt)\n \t\t  && gimple_assign_rhs_code (stmt) == RDIV_EXPR)\n \t\toptimize_recip_sqrt (&gsi, def);"}]}