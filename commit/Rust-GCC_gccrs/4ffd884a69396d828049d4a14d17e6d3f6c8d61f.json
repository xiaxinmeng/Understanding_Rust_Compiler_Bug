{"sha": "4ffd884a69396d828049d4a14d17e6d3f6c8d61f", "node_id": "C_kwDOANBUbNoAKDRmZmQ4ODRhNjkzOTZkODI4MDQ5ZDRhMTRkMTdlNmQzZjZjOGQ2MWY", "commit": {"author": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2022-08-09T07:37:41Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2022-08-09T07:37:41Z"}, "message": "const-checker: Add `is_const_extern_fn` helper function\n\nCo-authored-by: philberty <philip.herron@embecosm.com>", "tree": {"sha": "9f498600f878ccd86cca5872dccdde1f0dd44b1b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9f498600f878ccd86cca5872dccdde1f0dd44b1b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4ffd884a69396d828049d4a14d17e6d3f6c8d61f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4ffd884a69396d828049d4a14d17e6d3f6c8d61f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4ffd884a69396d828049d4a14d17e6d3f6c8d61f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4ffd884a69396d828049d4a14d17e6d3f6c8d61f/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "084f959076c10d54bdb5c80cad10a0aac5756ea4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/084f959076c10d54bdb5c80cad10a0aac5756ea4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/084f959076c10d54bdb5c80cad10a0aac5756ea4"}], "stats": {"total": 34, "additions": 23, "deletions": 11}, "files": [{"sha": "ad0a2cfc5c54c2f4e231ac3f05972f0a27c9962a", "filename": "gcc/rust/checks/errors/rust-const-checker.cc", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4ffd884a69396d828049d4a14d17e6d3f6c8d61f/gcc%2Frust%2Fchecks%2Ferrors%2Frust-const-checker.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4ffd884a69396d828049d4a14d17e6d3f6c8d61f/gcc%2Frust%2Fchecks%2Ferrors%2Frust-const-checker.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fchecks%2Ferrors%2Frust-const-checker.cc?ref=4ffd884a69396d828049d4a14d17e6d3f6c8d61f", "patch": "@@ -37,6 +37,21 @@ ConstChecker::go (HIR::Crate &crate)\n     item->accept_vis (*this);\n }\n \n+bool\n+ConstChecker::is_const_extern_fn (HIR::ExternalFunctionItem &fn)\n+{\n+  // FIXME: Is it really how we want to handle `rustc_const_stable`\n+  // and `rustc_const_unstable`?\n+  // TODO: Add these attributes to the attribute check and handle\n+  // `stable` and `unstable` as well\n+  return std::any_of (\n+    fn.get_outer_attrs ().begin (), fn.get_outer_attrs ().end (),\n+    [] (const AST::Attribute &attr) {\n+      // `starts_with` in C++11...\n+      return attr.get_path ().as_string ().rfind (\"rustc_const_\", 0) == 0;\n+    });\n+}\n+\n void\n ConstChecker::visit (IdentifierExpr &ident_expr)\n {}\n@@ -261,17 +276,7 @@ ConstChecker::check_function_call (HirId fn_id, Location locus)\n     {\n       {\n \tauto fn = static_cast<ExternalFunctionItem *> (maybe_extern_item);\n-\tauto is_const_extern = std::any_of (\n-\t  fn->get_outer_attrs ().begin (), fn->get_outer_attrs ().end (),\n-\t  [] (const AST::Attribute &attr) {\n-\t    // `starts_with` in C++11...\n-\t    // FIXME: Is it really how we want to handle `rustc_const_stable`\n-\t    // and `rustc_const_unstable`?\n-\t    // TODO: Add these attributes to the attribute check and handle\n-\t    // `stable` and `unstable` as well\n-\t    return attr.get_path ().as_string ().rfind (\"rustc_const_\", 0) == 0;\n-\t  });\n-\tif (!is_const_extern)\n+\tif (!is_const_extern_fn (*fn))\n \t  is_error = true;\n       }\n     }"}, {"sha": "608ea3e075073e791a9b16b0caa5fc7b43cacd3c", "filename": "gcc/rust/checks/errors/rust-const-checker.h", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4ffd884a69396d828049d4a14d17e6d3f6c8d61f/gcc%2Frust%2Fchecks%2Ferrors%2Frust-const-checker.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4ffd884a69396d828049d4a14d17e6d3f6c8d61f/gcc%2Frust%2Fchecks%2Ferrors%2Frust-const-checker.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fchecks%2Ferrors%2Frust-const-checker.h?ref=4ffd884a69396d828049d4a14d17e6d3f6c8d61f", "patch": "@@ -33,6 +33,13 @@ class ConstChecker : public HIRFullVisitor\n \n   void go (HIR::Crate &crate);\n \n+  /**\n+   * Check if an item is a const extern item or not\n+   * TODO: Move this to a const compilation context class or an attribute\n+   * checking class\n+   */\n+  static bool is_const_extern_fn (HIR::ExternalFunctionItem &fn);\n+\n private:\n   /**\n    * Check that only const functions are called in const contexts"}]}