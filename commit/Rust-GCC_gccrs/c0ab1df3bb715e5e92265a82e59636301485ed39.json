{"sha": "c0ab1df3bb715e5e92265a82e59636301485ed39", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzBhYjFkZjNiYjcxNWU1ZTkyMjY1YTgyZTU5NjM2MzAxNDg1ZWQzOQ==", "commit": {"author": {"name": "Andrew Pinski", "email": "andrew_pinski@playstation.sony.com", "date": "2008-09-03T18:48:27Z"}, "committer": {"name": "Andrew Pinski", "email": "pinskia@gcc.gnu.org", "date": "2008-09-03T18:48:27Z"}, "message": "re PR middle-end/37293 (r139762 breaks libstdc++ build on darwin)\n\n2008-09-03  Andrew Pinski  <andrew_pinski@playstation.sony.com>\n\n        PR middle-end/37293\n        * cgraphunit.c (update_call_expr): Remove eh regions from statements\n        which become non throw.\n        (cgraph_function_versioning): Also clear DECL_WEAK.  Call\n        update_call_expr after updating the flags on the decl.\n\n2008-09-03  Andrew Pinski  <andrew_pinski@playstation.sony.com>\n\n        PR middle-end/37293\n        * g++.dg/torture/ipa-cp-1.C: New test.\n\nFrom-SVN: r139946", "tree": {"sha": "f12ed025cfd8c06144adcdfe53b80184b92b779d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f12ed025cfd8c06144adcdfe53b80184b92b779d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c0ab1df3bb715e5e92265a82e59636301485ed39", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c0ab1df3bb715e5e92265a82e59636301485ed39", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c0ab1df3bb715e5e92265a82e59636301485ed39", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c0ab1df3bb715e5e92265a82e59636301485ed39/comments", "author": null, "committer": null, "parents": [{"sha": "39ecc018798bc85d22bfc3c3155986ab5b35f5ac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/39ecc018798bc85d22bfc3c3155986ab5b35f5ac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/39ecc018798bc85d22bfc3c3155986ab5b35f5ac"}], "stats": {"total": 50, "additions": 46, "deletions": 4}, "files": [{"sha": "dbea60b119cd6f1f0a69c3a3d1b8d93c4aff9504", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c0ab1df3bb715e5e92265a82e59636301485ed39", "patch": "@@ -1,3 +1,11 @@\n+2008-09-03  Andrew Pinski  <andrew_pinski@playstation.sony.com>\n+\n+\tPR middle-end/37293\n+\t* cgraphunit.c (update_call_expr): Remove eh regions from statements\n+\twhich become non throw.\n+\t(cgraph_function_versioning): Also clear DECL_WEAK.  Call\n+\tupdate_call_expr after updating the flags on the decl.\n+\n 2008-09-03  Jan Hubicka  <jh@suse.cz>\n \n \tPR tree-optimization/37315"}, {"sha": "7c845733327e718aa021937c855d90f17e627f8a", "filename": "gcc/cgraphunit.c", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2Fcgraphunit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2Fcgraphunit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraphunit.c?ref=c0ab1df3bb715e5e92265a82e59636301485ed39", "patch": "@@ -1417,7 +1417,14 @@ update_call_expr (struct cgraph_node *new_version)\n \n   /* Update the call expr on the edges to call the new version.  */\n   for (e = new_version->callers; e; e = e->next_caller)\n-    gimple_call_set_fndecl (e->call_stmt, new_version->decl);\n+    {\n+      struct function *inner_function = DECL_STRUCT_FUNCTION (e->caller->decl);\n+      gimple_call_set_fndecl (e->call_stmt, new_version->decl);\n+      /* Update EH information too, just in case.  */\n+      if (!stmt_could_throw_p (e->call_stmt)\n+          && lookup_stmt_eh_region_fn (inner_function, e->call_stmt))\n+        remove_stmt_from_eh_region_fn (inner_function, e->call_stmt);\n+    }\n }\n \n \n@@ -1524,20 +1531,24 @@ cgraph_function_versioning (struct cgraph_node *old_version_node,\n \n   /* Copy the OLD_VERSION_NODE function tree to the new version.  */\n   tree_function_versioning (old_decl, new_decl, tree_map, false, args_to_skip);\n-  /* Update the call_expr on the edges to call the new version node. */\n-  update_call_expr (new_version_node);\n \n   /* Update the new version's properties.\n-     Make The new version visible only within this translation unit.\n+     Make The new version visible only within this translation unit.  Make sure\n+     that is not weak also.\n      ??? We cannot use COMDAT linkage because there is no\n      ABI support for this.  */\n   DECL_EXTERNAL (new_version_node->decl) = 0;\n   DECL_ONE_ONLY (new_version_node->decl) = 0;\n   TREE_PUBLIC (new_version_node->decl) = 0;\n   DECL_COMDAT (new_version_node->decl) = 0;\n+  DECL_WEAK (new_version_node->decl) = 0;\n   new_version_node->local.externally_visible = 0;\n   new_version_node->local.local = 1;\n   new_version_node->lowered = true;\n+  \n+  /* Update the call_expr on the edges to call the new version node. */\n+  update_call_expr (new_version_node);\n+  \n   cgraph_call_function_insertion_hooks (new_version_node);\n   return new_version_node;\n }"}, {"sha": "3120d1c9e748b286103af5de7dbaa0b0f816cb2f", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c0ab1df3bb715e5e92265a82e59636301485ed39", "patch": "@@ -1,3 +1,8 @@\n+2008-09-03  Andrew Pinski  <andrew_pinski@playstation.sony.com>\n+\n+\tPR middle-end/37293\n+\t* g++.dg/torture/ipa-cp-1.C: New test.\n+\n 2008-09-03  David Edelsohn  <edelsohn@gnu.org>\n \n \t* g++.dg/ext/java-2.C: Disable on AIX."}, {"sha": "37c046d87b4e2803bcb783a3cc4b101fd1c40fa6", "filename": "gcc/testsuite/g++.dg/torture/ipa-cp-1.C", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fipa-cp-1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c0ab1df3bb715e5e92265a82e59636301485ed39/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fipa-cp-1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fipa-cp-1.C?ref=c0ab1df3bb715e5e92265a82e59636301485ed39", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-do compile } */\n+\n+// With IPA-CP, this caused a problem on darwin, where\n+// _M_reset is being cloned, it was still being marked\n+// as weak and then we had to change the calls to the\n+// newly marked function for the non throwing behavior.\n+\n+int&  f(int&);\n+inline void _M_reset(int &_M_vbp) throw()\n+{\n+  f(_M_vbp);\n+}\n+extern int _S_last_request;\n+void _M_allocate_single_object() throw()\n+{\n+  _M_reset(_S_last_request);\n+  _M_reset(_S_last_request);\n+}"}]}