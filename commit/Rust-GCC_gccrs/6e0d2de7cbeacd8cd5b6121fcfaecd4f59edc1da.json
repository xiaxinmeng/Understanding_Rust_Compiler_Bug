{"sha": "6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmUwZDJkZTdjYmVhY2Q4Y2Q1YjYxMjFmY2ZhZWNkNGY1OWVkYzFkYQ==", "commit": {"author": {"name": "Janus Weil", "email": "janus@gcc.gnu.org", "date": "2009-01-16T12:03:51Z"}, "committer": {"name": "Janus Weil", "email": "janus@gcc.gnu.org", "date": "2009-01-16T12:03:51Z"}, "message": "re PR fortran/38152 (procedure pointers as module variables)\n\n2009-01-16  Janus Weil  <janus@gcc.gnu.org>\n\n\tPR fortran/38152\n\t* expr.c (gfc_check_pointer_assign): Allow use-associated procedure\n\tpointers as lvalue.\n\t* trans-decl.c (get_proc_pointer_decl,gfc_create_module_variable):\n\tEnable procedure pointers as module variables.\n\n\n2009-01-16  Janus Weil  <janus@gcc.gnu.org>\n\n\tPR fortran/38152\n\t* gfortran.dg/proc_ptr_13.f90: New.\n\nFrom-SVN: r143430", "tree": {"sha": "96162b336e41edda3555f07921d678132a5db943", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/96162b336e41edda3555f07921d678132a5db943"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/comments", "author": {"login": "janusw", "id": 484108, "node_id": "MDQ6VXNlcjQ4NDEwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/484108?v=4", "gravatar_id": "", "url": "https://api.github.com/users/janusw", "html_url": "https://github.com/janusw", "followers_url": "https://api.github.com/users/janusw/followers", "following_url": "https://api.github.com/users/janusw/following{/other_user}", "gists_url": "https://api.github.com/users/janusw/gists{/gist_id}", "starred_url": "https://api.github.com/users/janusw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/janusw/subscriptions", "organizations_url": "https://api.github.com/users/janusw/orgs", "repos_url": "https://api.github.com/users/janusw/repos", "events_url": "https://api.github.com/users/janusw/events{/privacy}", "received_events_url": "https://api.github.com/users/janusw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "janusw", "id": 484108, "node_id": "MDQ6VXNlcjQ4NDEwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/484108?v=4", "gravatar_id": "", "url": "https://api.github.com/users/janusw", "html_url": "https://github.com/janusw", "followers_url": "https://api.github.com/users/janusw/followers", "following_url": "https://api.github.com/users/janusw/following{/other_user}", "gists_url": "https://api.github.com/users/janusw/gists{/gist_id}", "starred_url": "https://api.github.com/users/janusw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/janusw/subscriptions", "organizations_url": "https://api.github.com/users/janusw/orgs", "repos_url": "https://api.github.com/users/janusw/repos", "events_url": "https://api.github.com/users/janusw/events{/privacy}", "received_events_url": "https://api.github.com/users/janusw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "27d62fa48ebe95d491dfa048beda55d30a37bd9b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/27d62fa48ebe95d491dfa048beda55d30a37bd9b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/27d62fa48ebe95d491dfa048beda55d30a37bd9b"}], "stats": {"total": 67, "additions": 62, "deletions": 5}, "files": [{"sha": "6bdcdbf214f1226d12893173cf16efc5add311db", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "patch": "@@ -1,3 +1,11 @@\n+2009-01-16  Janus Weil  <janus@gcc.gnu.org>\n+\n+\tPR fortran/38152\n+\t* expr.c (gfc_check_pointer_assign): Allow use-associated procedure\n+\tpointers as lvalue.\n+\t* trans-decl.c (get_proc_pointer_decl,gfc_create_module_variable):\n+\tEnable procedure pointers as module variables.\n+\n 2009-01-14  Steven G. Kargl  <kargl@gcc.gnu.org>\n \n \t* ChangeLog-2007: Clean out svn merge droppings."}, {"sha": "5d772626ff9e5691bc4644d1ede9da733270e3d0", "filename": "gcc/fortran/expr.c", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ffortran%2Fexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ffortran%2Fexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fexpr.c?ref=6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "patch": "@@ -3043,7 +3043,8 @@ gfc_check_pointer_assign (gfc_expr *lvalue, gfc_expr *rvalue)\n     }\n \n   if (lvalue->symtree->n.sym->attr.flavor == FL_PROCEDURE\n-      && lvalue->symtree->n.sym->attr.use_assoc)\n+      && lvalue->symtree->n.sym->attr.use_assoc\n+      && !lvalue->symtree->n.sym->attr.proc_pointer)\n     {\n       gfc_error (\"'%s' in the pointer assignment at %L cannot be an \"\n \t\t \"l-value since it is a procedure\","}, {"sha": "200948b968a02d95e4823a69807ab037498c9043", "filename": "gcc/fortran/trans-decl.c", "status": "modified", "additions": 18, "deletions": 4, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ffortran%2Ftrans-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ffortran%2Ftrans-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.c?ref=6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "patch": "@@ -1174,11 +1174,24 @@ get_proc_pointer_decl (gfc_symbol *sym)\n       && sym->ns->proc_name->backend_decl == current_function_decl)\n       || sym->attr.contained)\n     gfc_add_decl_to_function (decl);\n-  else\n+  else if (sym->ns->proc_name->attr.flavor != FL_MODULE)\n     gfc_add_decl_to_parent_function (decl);\n \n   sym->backend_decl = decl;\n \n+  /* If a variable is USE associated, it's always external.  */\n+  if (sym->attr.use_assoc)\n+    {\n+      DECL_EXTERNAL (decl) = 1;\n+      TREE_PUBLIC (decl) = 1;\n+    }\n+  else if (sym->module && sym->ns->proc_name->attr.flavor == FL_MODULE)\n+    {\n+      /* This is the declaration of a module variable.  */\n+      TREE_PUBLIC (decl) = 1;\n+      TREE_STATIC (decl) = 1;\n+    }\n+\n   if (!sym->attr.use_assoc\n \t&& (sym->attr.save != SAVE_NONE || sym->attr.data\n \t      || (sym->value && sym->ns->proc_name->attr.is_main_program)))\n@@ -3121,11 +3134,12 @@ gfc_create_module_variable (gfc_symbol * sym)\n       gfc_module_add_decl (cur_module, TYPE_STUB_DECL (decl));\n     }\n \n-  /* Only output variables and array valued, or derived type,\n-     parameters.  */\n+  /* Only output variables, procedure pointers and array valued,\n+     or derived type, parameters.  */\n   if (sym->attr.flavor != FL_VARIABLE\n \t&& !(sym->attr.flavor == FL_PARAMETER\n-\t       && (sym->attr.dimension || sym->ts.type == BT_DERIVED)))\n+\t       && (sym->attr.dimension || sym->ts.type == BT_DERIVED))\n+\t&& !(sym->attr.flavor == FL_PROCEDURE && sym->attr.proc_pointer))\n     return;\n \n   if ((sym->attr.in_common || sym->attr.in_equivalence) && sym->backend_decl)"}, {"sha": "ac03e178defadc9d7fa88baa30063f909ce1e6f6", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "patch": "@@ -1,3 +1,8 @@\n+2009-01-16  Janus Weil  <janus@gcc.gnu.org>\n+\n+\tPR fortran/38152\n+\t* gfortran.dg/proc_ptr_13.f90: New.\n+\n 2009-01-15  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/38850"}, {"sha": "a7f391f1b2dabb60452bc1518261e2541f7ba898", "filename": "gcc/testsuite/gfortran.dg/proc_ptr_13.f90", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ftestsuite%2Fgfortran.dg%2Fproc_ptr_13.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da/gcc%2Ftestsuite%2Fgfortran.dg%2Fproc_ptr_13.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fproc_ptr_13.f90?ref=6e0d2de7cbeacd8cd5b6121fcfaecd4f59edc1da", "patch": "@@ -0,0 +1,29 @@\n+! { dg-do compile }\n+!\n+! PR 38152: Procedure pointers as module variables.\n+!\n+! Contributed by Daniel Kraft <domob@gcc.gnu.org>\n+\n+MODULE myfortran_binding\n+\n+  IMPLICIT NONE\n+  PROCEDURE(error_stop), POINTER :: error_handler\n+\n+CONTAINS\n+\n+  LOGICAL FUNCTION myfortran_shutdown ()\n+    CALL error_handler ()\n+  END FUNCTION myfortran_shutdown\n+\n+  SUBROUTINE error_stop ()\n+  END SUBROUTINE error_stop\n+\n+END MODULE myfortran_binding\n+\n+\n+use myfortran_binding\n+external foo\n+error_handler => foo\n+end\n+\n+! { dg-final { cleanup-modules \"myfortran_binding\" } }"}]}