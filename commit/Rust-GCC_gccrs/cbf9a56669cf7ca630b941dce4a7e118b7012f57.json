{"sha": "cbf9a56669cf7ca630b941dce4a7e118b7012f57", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Y2JmOWE1NjY2OWNmN2NhNjMwYjk0MWRjZTRhN2UxMThiNzAxMmY1Nw==", "commit": {"author": {"name": "Bernd Edlinger", "email": "bernd.edlinger@hotmail.de", "date": "2015-01-16T17:49:56Z"}, "committer": {"name": "Bernd Edlinger", "email": "edlinger@gcc.gnu.org", "date": "2015-01-16T17:49:56Z"}, "message": "sanititer.def (BUILT_IN_TSAN_VPTR_UPDATE): Fixed parameters.\n\n2015-01-16  Bernd Edlinger  <bernd.edlinger@hotmail.de>\n\n        * sanititer.def (BUILT_IN_TSAN_VPTR_UPDATE): Fixed parameters.\n        * tsan.c (instrument_expr): Fixed parameters of __tsan_vptr_update.\n\ngcc/testsuite/ChangeLog\n2015-01-16  Bernd Edlinger  <bernd.edlinger@hotmail.de>\n\n        * g++.dg/tsan/vptr_benign_race.C: New testcase.\n        * g++.dg/tsan/vptr_harmful_race.C: New testcase.\n\nFrom-SVN: r219761", "tree": {"sha": "9027a397ba33ba154f6736baa3e9a09c58342c16", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9027a397ba33ba154f6736baa3e9a09c58342c16"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/cbf9a56669cf7ca630b941dce4a7e118b7012f57", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cbf9a56669cf7ca630b941dce4a7e118b7012f57", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cbf9a56669cf7ca630b941dce4a7e118b7012f57", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cbf9a56669cf7ca630b941dce4a7e118b7012f57/comments", "author": {"login": "bernd-edlinger", "id": 17638929, "node_id": "MDQ6VXNlcjE3NjM4OTI5", "avatar_url": "https://avatars.githubusercontent.com/u/17638929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bernd-edlinger", "html_url": "https://github.com/bernd-edlinger", "followers_url": "https://api.github.com/users/bernd-edlinger/followers", "following_url": "https://api.github.com/users/bernd-edlinger/following{/other_user}", "gists_url": "https://api.github.com/users/bernd-edlinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/bernd-edlinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bernd-edlinger/subscriptions", "organizations_url": "https://api.github.com/users/bernd-edlinger/orgs", "repos_url": "https://api.github.com/users/bernd-edlinger/repos", "events_url": "https://api.github.com/users/bernd-edlinger/events{/privacy}", "received_events_url": "https://api.github.com/users/bernd-edlinger/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "39dac19e286a8b23b0e3bdde6ba18b65f3f919f8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/39dac19e286a8b23b0e3bdde6ba18b65f3f919f8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/39dac19e286a8b23b0e3bdde6ba18b65f3f919f8"}], "stats": {"total": 121, "additions": 119, "deletions": 2}, "files": [{"sha": "ae633bf2f10404aa5e31b4e6ce02ae1ead85608d", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=cbf9a56669cf7ca630b941dce4a7e118b7012f57", "patch": "@@ -1,3 +1,8 @@\n+2015-01-16  Bernd Edlinger  <bernd.edlinger@hotmail.de>\n+\n+\t* sanititer.def (BUILT_IN_TSAN_VPTR_UPDATE): Fixed parameters.\n+\t* tsan.c (instrument_expr): Fixed parameters of __tsan_vptr_update.\n+\n 2015-01-16  Kyrylo Tkachov  <kyrylo.tkachov@arm.com>\n \n \t* config/arm/arm.md: Move comment about splitting Thumb1 patterns to..."}, {"sha": "7d149105b995ed3fd4455dd65fe2958449a4bd4d", "filename": "gcc/sanitizer.def", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Fsanitizer.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Fsanitizer.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fsanitizer.def?ref=cbf9a56669cf7ca630b941dce4a7e118b7012f57", "patch": "@@ -167,7 +167,7 @@ DEF_SANITIZER_BUILTIN(BUILT_IN_TSAN_FUNC_ENTRY, \"__tsan_func_entry\",\n DEF_SANITIZER_BUILTIN(BUILT_IN_TSAN_FUNC_EXIT, \"__tsan_func_exit\",\n \t\t      BT_FN_VOID_PTR, ATTR_NOTHROW_LEAF_LIST)\n DEF_SANITIZER_BUILTIN(BUILT_IN_TSAN_VPTR_UPDATE, \"__tsan_vptr_update\",\n-\t\t      BT_FN_VOID_PTR, ATTR_NOTHROW_LEAF_LIST)\n+\t\t      BT_FN_VOID_PTR_PTR, ATTR_NOTHROW_LEAF_LIST)\n DEF_SANITIZER_BUILTIN(BUILT_IN_TSAN_READ1, \"__tsan_read1\",\n \t\t      BT_FN_VOID_PTR, ATTR_NOTHROW_LEAF_LIST)\n DEF_SANITIZER_BUILTIN(BUILT_IN_TSAN_READ2, \"__tsan_read2\","}, {"sha": "cc0ab53cf63ee362247ce1119d813bde02111799", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=cbf9a56669cf7ca630b941dce4a7e118b7012f57", "patch": "@@ -1,3 +1,8 @@\n+2015-01-16  Bernd Edlinger  <bernd.edlinger@hotmail.de>\n+\n+\t* g++.dg/tsan/vptr_benign_race.C: New testcase.\n+\t* g++.dg/tsan/vptr_harmful_race.C: New testcase.\n+\n 2015-01-16  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/60056"}, {"sha": "283684bcfa9c8108618a706d359cdceb73ccc730", "filename": "gcc/testsuite/g++.dg/tsan/vptr_benign_race.C", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftsan%2Fvptr_benign_race.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftsan%2Fvptr_benign_race.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftsan%2Fvptr_benign_race.C?ref=cbf9a56669cf7ca630b941dce4a7e118b7012f57", "patch": "@@ -0,0 +1,49 @@\n+#include <pthread.h>\n+#include <semaphore.h>\n+#include <stdio.h>\n+\n+struct A {\n+  A() {\n+    sem_init(&sem_, 0, 0);\n+  }\n+  virtual void F() {\n+  }\n+  void Done() {\n+    sem_post(&sem_);\n+  }\n+  virtual ~A() {\n+  }\n+  sem_t sem_;\n+};\n+\n+struct B : A {\n+  virtual void F() {\n+  }\n+  virtual ~B() {\n+    sem_wait(&sem_);\n+    sem_destroy(&sem_);\n+  }\n+};\n+\n+static A *obj = new B;\n+\n+void *Thread1(void *x) {\n+  obj->F();\n+  obj->Done();\n+  return NULL;\n+}\n+\n+void *Thread2(void *x) {\n+  delete obj;\n+  return NULL;\n+}\n+\n+int main() {\n+  pthread_t t[2];\n+  pthread_create(&t[0], NULL, Thread1, NULL);\n+  pthread_create(&t[1], NULL, Thread2, NULL);\n+  pthread_join(t[0], NULL);\n+  pthread_join(t[1], NULL);\n+  fprintf(stderr, \"PASS\\n\");\n+}\n+/* { dg-output \"PASS.*\" } */"}, {"sha": "1473f93ed24ccaefd046061ef353caf12fc0d0b5", "filename": "gcc/testsuite/g++.dg/tsan/vptr_harmful_race.C", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftsan%2Fvptr_harmful_race.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftsan%2Fvptr_harmful_race.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftsan%2Fvptr_harmful_race.C?ref=cbf9a56669cf7ca630b941dce4a7e118b7012f57", "patch": "@@ -0,0 +1,58 @@\n+/* { dg-shouldfail \"tsan\" } */\n+/* { dg-additional-options \"-ldl\" } */\n+\n+#include <pthread.h>\n+#include <semaphore.h>\n+#include <stdio.h>\n+#include <unistd.h>\n+#include \"tsan_barrier.h\"\n+\n+static pthread_barrier_t barrier;\n+\n+struct A {\n+  A() {\n+    sem_init(&sem_, 0, 0);\n+  }\n+  virtual void F() {\n+  }\n+  void Done() {\n+    sem_post(&sem_);\n+  }\n+  virtual ~A() {\n+    sem_wait(&sem_);\n+    sem_destroy(&sem_);\n+  }\n+  sem_t sem_;\n+};\n+\n+struct B : A {\n+  virtual void F() {\n+  }\n+  virtual ~B() { }\n+};\n+\n+static A *obj = new B;\n+\n+void *Thread1(void *x) {\n+  obj->F();\n+  obj->Done();\n+  barrier_wait(&barrier);\n+  return NULL;\n+}\n+\n+void *Thread2(void *x) {\n+  barrier_wait(&barrier);\n+  delete obj;\n+  return NULL;\n+}\n+\n+int main() {\n+  barrier_init(&barrier, 2);\n+  pthread_t t[2];\n+  pthread_create(&t[0], NULL, Thread1, NULL);\n+  pthread_create(&t[1], NULL, Thread2, NULL);\n+  pthread_join(t[0], NULL);\n+  pthread_join(t[1], NULL);\n+}\n+\n+/* { dg-output \"WARNING: ThreadSanitizer: data race on vptr.*(\\n|\\r\\n|\\r)\" } */"}, {"sha": "ae89d5fdaf618c8f0c288e96689fce5345a1d927", "filename": "gcc/tsan.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cbf9a56669cf7ca630b941dce4a7e118b7012f57/gcc%2Ftsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftsan.c?ref=cbf9a56669cf7ca630b941dce4a7e118b7012f57", "patch": "@@ -249,7 +249,7 @@ instrument_expr (gimple_stmt_iterator gsi, tree expr, bool is_write)\n   else\n     {\n       builtin_decl = builtin_decl_implicit (BUILT_IN_TSAN_VPTR_UPDATE);\n-      g = gimple_build_call (builtin_decl, 1, expr_ptr);\n+      g = gimple_build_call (builtin_decl, 2, expr_ptr, unshare_expr (rhs));\n     }\n   gimple_set_location (g, loc);\n   gimple_seq_add_stmt_without_update (&seq, g);"}]}