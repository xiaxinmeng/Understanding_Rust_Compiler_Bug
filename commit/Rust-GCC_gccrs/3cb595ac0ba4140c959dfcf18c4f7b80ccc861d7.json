{"sha": "3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2NiNTk1YWMwYmE0MTQwYzk1OWRmY2YxOGM0ZjdiODBjY2M4NjFkNw==", "commit": {"author": {"name": "Mikael Morin", "email": "mikael@gcc.gnu.org", "date": "2010-07-30T16:41:55Z"}, "committer": {"name": "Mikael Morin", "email": "mikael@gcc.gnu.org", "date": "2010-07-30T16:41:55Z"}, "message": "gfortran.h (gfc_release_symbol): New prototype.\n\n2010-07-30  Mikael Morin  <mikael@gcc.gnu.org>\n\n\t* gfortran.h (gfc_release_symbol): New prototype.\n\t* symbol.c (gfc_release_symbol): New. Code taken from free_sym_tree.\n\t(gfc_undo_symbols, free_sym_tree, gfc_free_finalizer):\n\tUse gfc_release_symbol.\n\t* parse.c (gfc_fixup_sibling_symbols): Ditto.\n\t* resolve.c (resolve_symbol): Ditto.\n\nFrom-SVN: r162719", "tree": {"sha": "456986113aabb474edce8322001f1bfe8270a975", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/456986113aabb474edce8322001f1bfe8270a975"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/comments", "author": null, "committer": null, "parents": [{"sha": "2d5bfc67abf07302897ced5f0e620dc0e31820c2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2d5bfc67abf07302897ced5f0e620dc0e31820c2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2d5bfc67abf07302897ced5f0e620dc0e31820c2"}], "stats": {"total": 82, "additions": 40, "deletions": 42}, "files": [{"sha": "04676ee38369e6638318cb162521b3da4a50ca28", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "patch": "@@ -1,3 +1,12 @@\n+2010-07-30  Mikael Morin  <mikael@gcc.gnu.org>\n+\n+\t* gfortran.h (gfc_release_symbol): New prototype.\n+\t* symbol.c (gfc_release_symbol): New. Code taken from free_sym_tree.\n+\t(gfc_undo_symbols, free_sym_tree, gfc_free_finalizer):\n+\tUse gfc_release_symbol.\n+\t* parse.c (gfc_fixup_sibling_symbols): Ditto.\n+\t* resolve.c (resolve_symbol): Ditto.\n+\n 2010-07-29  Tobias Burnus  <burnus@net-b.de>\n \n \tPR fortran/45087"}, {"sha": "d623d0dac0ded97d3b4553c43cb58d2f2b8d3fa5", "filename": "gcc/fortran/gfortran.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.h?ref=3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "patch": "@@ -2523,6 +2523,7 @@ gfc_symtree *gfc_get_unique_symtree (gfc_namespace *);\n gfc_user_op *gfc_get_uop (const char *);\n gfc_user_op *gfc_find_uop (const char *, gfc_namespace *);\n void gfc_free_symbol (gfc_symbol *);\n+void gfc_release_symbol (gfc_symbol *);\n gfc_symbol *gfc_new_symbol (const char *, gfc_namespace *);\n gfc_symtree* gfc_find_symtree_in_proc (const char *, gfc_namespace *);\n int gfc_find_symbol (const char *, gfc_namespace *, int, gfc_symbol **);"}, {"sha": "989d6448b3bdcdea7b655f7d67727d5060dae771", "filename": "gcc/fortran/parse.c", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fparse.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fparse.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fparse.c?ref=3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "patch": "@@ -3792,10 +3792,7 @@ gfc_fixup_sibling_symbols (gfc_symbol *sym, gfc_namespace *siblings)\n \t  st->n.sym = sym;\n \t  sym->refs++;\n \n-\t  /* Free the old (local) symbol.  */\n-\t  old_sym->refs--;\n-\t  if (old_sym->refs == 0)\n-\t    gfc_free_symbol (old_sym);\n+\t  gfc_release_symbol (old_sym);\n \t}\n \n fixup_contained:"}, {"sha": "6ccc565ea3e247839d0c0c6cee70b81025ab8c79", "filename": "gcc/fortran/resolve.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fresolve.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fresolve.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fresolve.c?ref=3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "patch": "@@ -11382,9 +11382,7 @@ resolve_symbol (gfc_symbol *sym)\n \t    {\n \t      this_symtree = gfc_find_symtree (gfc_current_ns->sym_root,\n \t\t\t\t\t       sym->name);\n-\t      sym->refs--;\n-\t      if (!sym->refs)\n-\t\tgfc_free_symbol (sym);\n+\t      gfc_release_symbol (sym);\n \t      symtree->n.sym->refs++;\n \t      this_symtree->n.sym = symtree->n.sym;\n \t      return;"}, {"sha": "e713cd83192e563f59fca0064db7b4980ae26062", "filename": "gcc/fortran/symbol.c", "status": "modified", "additions": 28, "deletions": 35, "changes": 63, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fsymbol.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7/gcc%2Ffortran%2Fsymbol.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fsymbol.c?ref=3cb595ac0ba4140c959dfcf18c4f7b80ccc861d7", "patch": "@@ -2502,6 +2502,31 @@ gfc_free_symbol (gfc_symbol *sym)\n }\n \n \n+/* Decrease the reference counter and free memory when we reach zero.  */\n+void\n+gfc_release_symbol (gfc_symbol *sym)\n+{\n+  if (sym == NULL)\n+    return;\n+\n+  if (sym->formal_ns != NULL && sym->refs == 2)\n+    {\n+      /* As formal_ns contains a reference to sym, delete formal_ns just\n+\t before the deletion of sym.  */\n+      gfc_namespace *ns = sym->formal_ns;\n+      sym->formal_ns = NULL;\n+      gfc_free_namespace (ns);\n+    }\n+\n+  sym->refs--;\n+  if (sym->refs > 0)\n+    return;\n+\n+  gcc_assert (sym->refs == 0);\n+  gfc_free_symbol (sym);\n+}\n+\n+\n /* Allocate and initialize a new symbol node.  */\n \n gfc_symbol *\n@@ -2893,11 +2918,7 @@ gfc_undo_symbols (void)\n \n \t  gfc_delete_symtree (&p->ns->sym_root, p->name);\n \n-\t  p->refs--;\n-\t  if (p->refs < 0)\n-\t    gfc_internal_error (\"gfc_undo_symbols(): Negative refs\");\n-\t  if (p->refs == 0)\n-\t    gfc_free_symbol (p);\n+\t  gfc_release_symbol (p);\n \t  continue;\n \t}\n \n@@ -3107,35 +3128,13 @@ free_uop_tree (gfc_symtree *uop_tree)\n static void\n free_sym_tree (gfc_symtree *sym_tree)\n {\n-  gfc_namespace *ns;\n-  gfc_symbol *sym;\n-\n   if (sym_tree == NULL)\n     return;\n \n   free_sym_tree (sym_tree->left);\n   free_sym_tree (sym_tree->right);\n \n-  sym = sym_tree->n.sym;\n-\n-  sym->refs--;\n-  if (sym->refs < 0)\n-    gfc_internal_error (\"free_sym_tree(): Negative refs\");\n-\n-  if (sym->formal_ns != NULL && sym->refs == 1)\n-    {\n-      /* As formal_ns contains a reference to sym, delete formal_ns just\n-         before the deletion of sym.  */\n-      ns = sym->formal_ns;\n-      sym->formal_ns = NULL;\n-      gfc_free_namespace (ns);\n-    }\n-  else if (sym->refs == 0)\n-    {\n-      /* Go ahead and delete the symbol.  */\n-      gfc_free_symbol (sym);\n-    }\n-\n+  gfc_release_symbol (sym_tree->n.sym);\n   gfc_free (sym_tree);\n }\n \n@@ -3189,13 +3188,7 @@ gfc_free_finalizer (gfc_finalizer* el)\n {\n   if (el)\n     {\n-      if (el->proc_sym)\n-\t{\n-\t  --el->proc_sym->refs;\n-\t  if (!el->proc_sym->refs)\n-\t    gfc_free_symbol (el->proc_sym);\n-\t}\n-\n+      gfc_release_symbol (el->proc_sym);\n       gfc_free (el);\n     }\n }"}]}