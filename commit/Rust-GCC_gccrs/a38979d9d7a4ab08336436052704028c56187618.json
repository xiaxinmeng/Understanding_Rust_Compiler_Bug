{"sha": "a38979d9d7a4ab08336436052704028c56187618", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTM4OTc5ZDlkN2E0YWIwODMzNjQzNjA1MjcwNDAyOGM1NjE4NzYxOA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-01-22T08:50:53Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-01-22T08:50:53Z"}, "message": "openmp: Teach omp_code_to_statement about rest of OpenMP statements\n\nThe omp_code_to_statement function added with the initial OpenACC support\nonly handled small subset of the OpenMP statements, leading to ICE if\nany other OpenMP directive appeared inside of OpenACC directive.\n\n2020-01-22  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR fortran/93329\n\t* openmp.c (omp_code_to_statement): Handle remaining EXEC_OMP_*\n\tcases.\n\n\t* gfortran.dg/goacc/pr93329.f90: New test.", "tree": {"sha": "874a306b03c7a122a71ead76e83a91a9a708f494", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/874a306b03c7a122a71ead76e83a91a9a708f494"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a38979d9d7a4ab08336436052704028c56187618", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a38979d9d7a4ab08336436052704028c56187618", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a38979d9d7a4ab08336436052704028c56187618", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a38979d9d7a4ab08336436052704028c56187618/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5a8ea165926cb0737ab03bc48c18dc5198ab5305", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a8ea165926cb0737ab03bc48c18dc5198ab5305", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5a8ea165926cb0737ab03bc48c18dc5198ab5305"}], "stats": {"total": 311, "additions": 310, "deletions": 1}, "files": [{"sha": "031c75bb5e5fbf000d19b7498883b319ff651541", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=a38979d9d7a4ab08336436052704028c56187618", "patch": "@@ -1,3 +1,9 @@\n+2020-01-22  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/93329\n+\t* openmp.c (omp_code_to_statement): Handle remaining EXEC_OMP_*\n+\tcases.\n+\n 2020-01-21  Tobias Burnus  <tobias@codesourcery.com>\n \n \tPR fortran/93309"}, {"sha": "3c6138556396ec00cac727b2d7dc382ef5fe047d", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=a38979d9d7a4ab08336436052704028c56187618", "patch": "@@ -5898,6 +5898,81 @@ omp_code_to_statement (gfc_code *code)\n       return ST_OMP_PARALLEL_WORKSHARE;\n     case EXEC_OMP_DO:\n       return ST_OMP_DO;\n+    case EXEC_OMP_ATOMIC:\n+      return ST_OMP_ATOMIC;\n+    case EXEC_OMP_BARRIER:\n+      return ST_OMP_BARRIER;\n+    case EXEC_OMP_CANCEL:\n+      return ST_OMP_CANCEL;\n+    case EXEC_OMP_CANCELLATION_POINT:\n+      return ST_OMP_CANCELLATION_POINT;\n+    case EXEC_OMP_FLUSH:\n+      return ST_OMP_FLUSH;\n+    case EXEC_OMP_DISTRIBUTE:\n+      return ST_OMP_DISTRIBUTE;\n+    case EXEC_OMP_DISTRIBUTE_PARALLEL_DO:\n+      return ST_OMP_DISTRIBUTE_PARALLEL_DO;\n+    case EXEC_OMP_DISTRIBUTE_PARALLEL_DO_SIMD:\n+      return ST_OMP_DISTRIBUTE_PARALLEL_DO_SIMD;\n+    case EXEC_OMP_DISTRIBUTE_SIMD:\n+      return ST_OMP_DISTRIBUTE_SIMD;\n+    case EXEC_OMP_DO_SIMD:\n+      return ST_OMP_DO_SIMD;\n+    case EXEC_OMP_SIMD:\n+      return ST_OMP_SIMD;\n+    case EXEC_OMP_TARGET:\n+      return ST_OMP_TARGET;\n+    case EXEC_OMP_TARGET_DATA:\n+      return ST_OMP_TARGET_DATA;\n+    case EXEC_OMP_TARGET_ENTER_DATA:\n+      return ST_OMP_TARGET_ENTER_DATA;\n+    case EXEC_OMP_TARGET_EXIT_DATA:\n+      return ST_OMP_TARGET_EXIT_DATA;\n+    case EXEC_OMP_TARGET_PARALLEL:\n+      return ST_OMP_TARGET_PARALLEL;\n+    case EXEC_OMP_TARGET_PARALLEL_DO:\n+      return ST_OMP_TARGET_PARALLEL_DO;\n+    case EXEC_OMP_TARGET_PARALLEL_DO_SIMD:\n+      return ST_OMP_TARGET_PARALLEL_DO_SIMD;\n+    case EXEC_OMP_TARGET_SIMD:\n+      return ST_OMP_TARGET_SIMD;\n+    case EXEC_OMP_TARGET_TEAMS:\n+      return ST_OMP_TARGET_TEAMS;\n+    case EXEC_OMP_TARGET_TEAMS_DISTRIBUTE:\n+      return ST_OMP_TARGET_TEAMS_DISTRIBUTE;\n+    case EXEC_OMP_TARGET_TEAMS_DISTRIBUTE_PARALLEL_DO:\n+      return ST_OMP_TARGET_TEAMS_DISTRIBUTE_PARALLEL_DO;\n+    case EXEC_OMP_TARGET_TEAMS_DISTRIBUTE_PARALLEL_DO_SIMD:\n+      return ST_OMP_TARGET_TEAMS_DISTRIBUTE_PARALLEL_DO_SIMD;\n+    case EXEC_OMP_TARGET_TEAMS_DISTRIBUTE_SIMD:\n+      return ST_OMP_TARGET_TEAMS_DISTRIBUTE_SIMD;\n+    case EXEC_OMP_TARGET_UPDATE:\n+      return ST_OMP_TARGET_UPDATE;\n+    case EXEC_OMP_TASKGROUP:\n+      return ST_OMP_TASKGROUP;\n+    case EXEC_OMP_TASKLOOP:\n+      return ST_OMP_TASKLOOP;\n+    case EXEC_OMP_TASKLOOP_SIMD:\n+      return ST_OMP_TASKLOOP_SIMD;\n+    case EXEC_OMP_TASKWAIT:\n+      return ST_OMP_TASKWAIT;\n+    case EXEC_OMP_TASKYIELD:\n+      return ST_OMP_TASKYIELD;\n+    case EXEC_OMP_TEAMS:\n+      return ST_OMP_TEAMS;\n+    case EXEC_OMP_TEAMS_DISTRIBUTE:\n+      return ST_OMP_TEAMS_DISTRIBUTE;\n+    case EXEC_OMP_TEAMS_DISTRIBUTE_PARALLEL_DO:\n+      return ST_OMP_TEAMS_DISTRIBUTE_PARALLEL_DO;\n+    case EXEC_OMP_TEAMS_DISTRIBUTE_PARALLEL_DO_SIMD:\n+      return ST_OMP_TEAMS_DISTRIBUTE_PARALLEL_DO_SIMD;\n+    case EXEC_OMP_TEAMS_DISTRIBUTE_SIMD:\n+      return ST_OMP_TEAMS_DISTRIBUTE_SIMD;\n+    case EXEC_OMP_PARALLEL_DO:\n+      return ST_OMP_PARALLEL_DO;\n+    case EXEC_OMP_PARALLEL_DO_SIMD:\n+      return ST_OMP_PARALLEL_DO_SIMD;\n+\n     default:\n       gcc_unreachable ();\n     }"}, {"sha": "0c04921f60d9806f4c06a61b81f017aec33e176a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a38979d9d7a4ab08336436052704028c56187618", "patch": "@@ -1,4 +1,9 @@\n-2020-01-22  Jun Ma <JunMa@linux.alibaba.com>\n+2020-01-22  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/93329\n+\t* gfortran.dg/goacc/pr93329.f90: New test.\n+\n+2020-01-22  Jun Ma  <JunMa@linux.alibaba.com>\n \n \t* g++.dg/coroutines/coro1-missing-await-method.C: New test.\n "}, {"sha": "aed264a03e990d8b775dbeff4fb788bbd8474773", "filename": "gcc/testsuite/gfortran.dg/goacc/pr93329.f90", "status": "added", "additions": 223, "deletions": 0, "changes": 223, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fpr93329.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a38979d9d7a4ab08336436052704028c56187618/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fpr93329.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fpr93329.f90?ref=a38979d9d7a4ab08336436052704028c56187618", "patch": "@@ -0,0 +1,223 @@\n+! PR fortran/93329\n+! { dg-do compile { target fopenmp } }\n+! { dg-additional-options \"-fopenmp\" }\n+\n+  integer :: x, y, z\n+  integer :: a(32)\n+!$acc kernels copyout(x)\n+!$omp target map(from:x)\t! { dg-error \"OMP TARGET directive cannot be specified within\" }\n+  x = 5\n+!$omp end target\n+!$acc end kernels\n+  print *, x\n+!$acc kernels\n+!$omp atomic\t\t\t! { dg-error \"OMP ATOMIC directive cannot be specified within\" }\n+  x = x + 1\n+!$omp end atomic\n+!$acc end kernels\n+!$acc kernels\n+!$omp barrier\t\t\t! { dg-error \"OMP BARRIER directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp cancel parallel\t\t! { dg-error \"OMP CANCEL directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp cancellation point parallel\t! { dg-error \"OMP CANCELLATION POINT directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp flush\t\t\t! { dg-error \"OMP FLUSH directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp distribute\t\t! { dg-error \"OMP DISTRIBUTE directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp distribute parallel do\t! { dg-error \"OMP DISTRIBUTE PARALLEL DO directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp distribute parallel do simd\t! { dg-error \"OMP DISTRIBUTE PARALLEL DO SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp distribute simd\t\t! { dg-error \"OMP DISTRIBUTE SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp do simd\t\t\t! { dg-error \"OMP DO SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp simd\t\t\t! { dg-error \"OMP SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target data map(from: x)\t! { dg-error \"OMP TARGET DATA directive cannot be specified within\" }\n+!$omp end target data\n+!$acc end kernels\n+!$acc kernels\n+!$omp target enter data map(to: x)\t! { dg-error \"OMP TARGET ENTER DATA directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp target exit data map(from: x)\t! { dg-error \"OMP TARGET EXIT DATA directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!!$omp target parallel\n+!!$omp end target parallel\n+!$acc end kernels\n+!$acc kernels\n+!$omp target parallel do\t! { dg-error \"OMP TARGET PARALLEL DO directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target parallel do simd\t! { dg-error \"OMP TARGET PARALLEL DO SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target simd\t\t! { dg-error \"OMP TARGET SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target teams\t\t! { dg-error \"OMP TARGET TEAMS directive cannot be specified within\" }\n+!$omp end target teams\n+!$acc end kernels\n+!$acc kernels\n+!$omp target teams distribute\t! { dg-error \"OMP TARGET TEAMS DISTRIBUTE directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target teams distribute parallel do\t! { dg-error \"OMP TARGET TEAMS DISTRIBUTE PARALLEL DO directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target teams distribute parallel do simd\t! { dg-error \"OMP TARGET TEAMS DISTRIBUTE PARALLEL DO SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target teams distribute simd\t! { dg-error \"OMP TARGET TEAMS DISTRIBUTE SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp target update to(x)\t! { dg-error \"OMP TARGET UPDATE directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp taskgroup\t\t\t! { dg-error \"OMP TASKGROUP directive cannot be specified within\" }\n+!$omp end taskgroup\n+!$acc end kernels\n+!$acc kernels\n+!$omp taskloop\t\t\t! { dg-error \"OMP TASKLOOP directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp taskloop simd\t\t! { dg-error \"OMP TASKLOOP SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp taskwait\t\t\t! { dg-error \"OMP TASKWAIT directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp taskyield\t\t\t! { dg-error \"OMP TASKYIELD directive cannot be specified within\" }\n+!$acc end kernels\n+!$acc kernels\n+!$omp teams\t\t\t! { dg-error \"OMP TEAMS directive cannot be specified within\" }\n+!$omp end teams\n+!$acc end kernels\n+!$acc kernels\n+!$omp teams distribute\t\t! { dg-error \"OMP TEAMS DISTRIBUTE directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp teams distribute parallel do\t! { dg-error \"OMP TEAMS DISTRIBUTE PARALLEL DO directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp teams distribute parallel do simd\t! { dg-error \"OMP TEAMS DISTRIBUTE PARALLEL DO SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp teams distribute simd\t! { dg-error \"OMP TEAMS DISTRIBUTE SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp parallel do\t\t! { dg-error \"OMP PARALLEL DO directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp parallel do simd\t\t! { dg-error \"OMP PARALLEL DO SIMD directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+!$acc kernels\n+!$omp parallel\t\t\t! { dg-error \"OMP PARALLEL directive cannot be specified within\" }\n+!$omp end parallel\n+!$acc end kernels\n+!$acc kernels\n+!$omp parallel sections\t\t! { dg-error \"OMP PARALLEL SECTIONS directive cannot be specified within\" }\n+  y = 1\n+!$omp section\n+  z = 2\n+!$omp end parallel sections\n+!$acc end kernels\n+!$acc kernels\n+!$omp sections\t\t\t! { dg-error \"OMP SECTIONS directive cannot be specified within\" }\n+  y = 1\n+!$omp section\n+  z = 2\n+!$omp end sections\n+!$acc end kernels\n+!$acc kernels\n+!$omp ordered\t\t\t! { dg-error \"OMP ORDERED directive cannot be specified within\" }\n+!$omp end ordered\n+!$acc end kernels\n+!$acc kernels\n+!$omp critical\t\t\t! { dg-error \"OMP CRITICAL directive cannot be specified within\" }\n+!$omp end critical\n+!$acc end kernels\n+!$acc kernels\n+!$omp master\t\t\t! { dg-error \"OMP MASTER directive cannot be specified within\" }\n+!$omp end master\n+!$acc end kernels\n+!$acc kernels\n+!$omp single\t\t\t! { dg-error \"OMP SINGLE directive cannot be specified within\" }\n+!$omp end single\n+!$acc end kernels\n+!$acc kernels\n+!$omp task\t\t\t! { dg-error \"OMP TASK directive cannot be specified within\" }\n+!$omp end task\n+!$acc end kernels\n+!$acc kernels\n+!$omp workshare\t\t\t! { dg-error \"OMP WORKSHARE directive cannot be specified within\" }\n+  a(:) = 1\n+!$omp end workshare\n+!$acc end kernels\n+!$acc kernels\n+!$omp parallel workshare\t! { dg-error \"OMP PARALLEL WORKSHARE directive cannot be specified within\" }\n+  a(:) = 1\n+!$omp end parallel workshare\n+!$acc end kernels\n+!$acc kernels\n+!$omp do\t\t\t! { dg-error \"OMP DO directive cannot be specified within\" }\n+  do x = 0, 2\n+  end do\n+!$acc end kernels\n+end"}]}