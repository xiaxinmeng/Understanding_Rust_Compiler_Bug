{"sha": "0143b277c9b17215ab3d4b361e1aef431799e813", "node_id": "C_kwDOANBUbNoAKDAxNDNiMjc3YzliMTcyMTVhYjNkNGIzNjFlMWFlZjQzMTc5OWU4MTM", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2022-09-30T14:04:22Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2022-10-06T21:43:14Z"}, "message": "c++: fix broken conversion in coroutines\n\nYou can't use CONVERT_EXPR to convert between two class types.\n\nVIEW_CONVERT_EXPR takes liberties with the C++ type system, but is probably\nsafe in this context.  Let's also only use it when the type isn't already\nwhat we want.\n\ngcc/cp/ChangeLog:\n\n\t* coroutines.cc (expand_one_await_expression): Change conversion\n\tto VIEW_CONVERT_EXPR.\n\t* cp-gimplify.cc (cp_genericize_r) [CONVERT_EXPR]: Add assert.", "tree": {"sha": "b8b1af7a80fd3c9ee61805b089de2bf6b118ae65", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b8b1af7a80fd3c9ee61805b089de2bf6b118ae65"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0143b277c9b17215ab3d4b361e1aef431799e813", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0143b277c9b17215ab3d4b361e1aef431799e813", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0143b277c9b17215ab3d4b361e1aef431799e813", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0143b277c9b17215ab3d4b361e1aef431799e813/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "49b9a8c8cc498b1ed2f566bee858e651e14ba37b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/49b9a8c8cc498b1ed2f566bee858e651e14ba37b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/49b9a8c8cc498b1ed2f566bee858e651e14ba37b"}], "stats": {"total": 6, "additions": 5, "deletions": 1}, "files": [{"sha": "60b846600b923b30b2d692412d2ca28b66052542", "filename": "gcc/cp/coroutines.cc", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0143b277c9b17215ab3d4b361e1aef431799e813/gcc%2Fcp%2Fcoroutines.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0143b277c9b17215ab3d4b361e1aef431799e813/gcc%2Fcp%2Fcoroutines.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcoroutines.cc?ref=0143b277c9b17215ab3d4b361e1aef431799e813", "patch": "@@ -1728,7 +1728,10 @@ expand_one_await_expression (tree *stmt, tree *await_expr, void *d)\n     }\n   else\n     {\n-      r = build1_loc (loc, CONVERT_EXPR, void_coro_handle_type, suspend);\n+      r = suspend;\n+      if (!same_type_ignoring_top_level_qualifiers_p (susp_type,\n+\t\t\t\t\t\t      void_coro_handle_type))\n+\tr = build1_loc (loc, VIEW_CONVERT_EXPR, void_coro_handle_type, r);\n       r = build2_loc (loc, INIT_EXPR, void_coro_handle_type, data->conthand, r);\n       r = build1 (CONVERT_EXPR, void_type_node, r);\n       append_to_statement_list (r, &body_list);"}, {"sha": "5d26e59d098a325a91814dc423120a11de10b622", "filename": "gcc/cp/cp-gimplify.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0143b277c9b17215ab3d4b361e1aef431799e813/gcc%2Fcp%2Fcp-gimplify.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0143b277c9b17215ab3d4b361e1aef431799e813/gcc%2Fcp%2Fcp-gimplify.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.cc?ref=0143b277c9b17215ab3d4b361e1aef431799e813", "patch": "@@ -1589,6 +1589,7 @@ cp_genericize_r (tree *stmt_p, int *walk_subtrees, void *data)\n       break;\n \n     case CONVERT_EXPR:\n+      gcc_checking_assert (!AGGREGATE_TYPE_P (TREE_TYPE (stmt)));\n       gcc_assert (!CONVERT_EXPR_VBASE_PATH (stmt));\n       break;\n "}]}