{"sha": "2af2f55a500adad73451f3b859cfaa8974920caf", "node_id": "C_kwDOANBUbNoAKDJhZjJmNTVhNTAwYWRhZDczNDUxZjNiODU5Y2ZhYTg5NzQ5MjBjYWY", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-11-30T08:48:59Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-11-30T08:49:54Z"}, "message": "c++: Small incremental tweak to source_location::current() folding\n\nI've already committed the patch, but perhaps we shouldn't do it in cp_fold\nwhere it will be folded even for warnings etc. and the locations might not\nbe the final yet.  This patch moves it to cp_fold_r so that it is done just\nonce for each function and just once for each static initializer.\n\n2021-11-30  Jakub Jelinek  <jakub@redhat.com>\n\n\t* cp-gimplify.c (cp_fold_r): Perform folding of\n\tstd::source_location::current() calls here...\n\t(cp_fold): ... rather than here.", "tree": {"sha": "c89fb66e50d84fb5bdecf9b2e4fabcf2c5ac4bf6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c89fb66e50d84fb5bdecf9b2e4fabcf2c5ac4bf6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2af2f55a500adad73451f3b859cfaa8974920caf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2af2f55a500adad73451f3b859cfaa8974920caf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2af2f55a500adad73451f3b859cfaa8974920caf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2af2f55a500adad73451f3b859cfaa8974920caf/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c39d77f252e895306ef88c1efb3eff04e4232554", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c39d77f252e895306ef88c1efb3eff04e4232554", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c39d77f252e895306ef88c1efb3eff04e4232554"}], "stats": {"total": 15, "additions": 7, "deletions": 8}, "files": [{"sha": "0988655eebab0a129e02d441ddcc1eaa09850f8c", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2af2f55a500adad73451f3b859cfaa8974920caf/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2af2f55a500adad73451f3b859cfaa8974920caf/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=2af2f55a500adad73451f3b859cfaa8974920caf", "patch": "@@ -930,6 +930,13 @@ cp_fold_r (tree *stmt_p, int *walk_subtrees, void *data)\n \t}\n       break;\n \n+    case CALL_EXPR:\n+      if (tree fndecl = cp_get_callee_fndecl_nofold (stmt))\n+\tif (DECL_IMMEDIATE_FUNCTION_P (fndecl)\n+\t    && source_location_current_p (fndecl))\n+\t  *stmt_p = stmt = cxx_constant_value (stmt);\n+      break;\n+\n     default:\n       break;\n     }\n@@ -2672,14 +2679,6 @@ cp_fold (tree x)\n \tint sv = optimize, nw = sv;\n \ttree callee = get_callee_fndecl (x);\n \n-\tif (tree fndecl = cp_get_callee_fndecl_nofold (x))\n-\t  if (DECL_IMMEDIATE_FUNCTION_P (fndecl)\n-\t      && source_location_current_p (fndecl))\n-\t    {\n-\t      x = cxx_constant_value (x);\n-\t      break;\n-\t    }\n-\n \t/* Some built-in function calls will be evaluated at compile-time in\n \t   fold ().  Set optimize to 1 when folding __builtin_constant_p inside\n \t   a constexpr function so that fold_builtin_1 doesn't fold it to 0.  */"}]}