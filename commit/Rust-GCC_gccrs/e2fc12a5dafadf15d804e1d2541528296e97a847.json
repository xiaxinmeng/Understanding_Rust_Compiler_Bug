{"sha": "e2fc12a5dafadf15d804e1d2541528296e97a847", "node_id": "C_kwDOANBUbNoAKGUyZmMxMmE1ZGFmYWRmMTVkODA0ZTFkMjU0MTUyODI5NmU5N2E4NDc", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2023-01-12T10:40:49Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2023-01-13T13:34:20Z"}, "message": "libstdc++: Fix unintended layout change to std::basic_filebuf [PR108331]\n\nGCC 13 has a new implementation of gthr-win32.h which supports C++11\nmutexes, threads etc. but this causes an unintended ABI break. The\n__gthread_mutex_t type is always used in std::basic_filebuf even in\nC++98, so independent of whether C++11 sync primitives work or not.\nBecause that type changed for the win32 thread model, we have a layout\nchange in std::basic_filebuf. The member is completely unused, it just\ngets passed to the std::__basic_file constructor and ignored. So we\ndon't need that mutex to actually work, we just need its layout to not\nchange.\n\nIntroduce a new __gthr_win32_legacy_mutex_t struct in gthr-win32.h with\nthe old layout, and conditionally use that in std::basic_filebuf.\n\n\tPR libstdc++/108331\n\nlibgcc/ChangeLog:\n\n\t* config/i386/gthr-win32.h (__gthr_win32_legacy_mutex_t): New\n\tstruct matching the previous __gthread_mutex_t struct.\n\t(__GTHREAD_LEGACY_MUTEX_T): Define.\n\nlibstdc++-v3/ChangeLog:\n\n\t* config/io/c_io_stdio.h (__c_lock): Define as a typedef for\n\t__GTHREAD_LEGACY_MUTEX_T if defined.", "tree": {"sha": "e4d9e046e730a5a3b7ebb417d85ae1fa772c5c9f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e4d9e046e730a5a3b7ebb417d85ae1fa772c5c9f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e2fc12a5dafadf15d804e1d2541528296e97a847", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e2fc12a5dafadf15d804e1d2541528296e97a847", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e2fc12a5dafadf15d804e1d2541528296e97a847", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e2fc12a5dafadf15d804e1d2541528296e97a847/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57d104ab0f515d12ba12270a415a76f55c235574", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/57d104ab0f515d12ba12270a415a76f55c235574", "html_url": "https://github.com/Rust-GCC/gccrs/commit/57d104ab0f515d12ba12270a415a76f55c235574"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "050c7a21fccb4595284a38d09b9e656b7c10100a", "filename": "libgcc/config/i386/gthr-win32.h", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2fc12a5dafadf15d804e1d2541528296e97a847/libgcc%2Fconfig%2Fi386%2Fgthr-win32.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2fc12a5dafadf15d804e1d2541528296e97a847/libgcc%2Fconfig%2Fi386%2Fgthr-win32.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Fconfig%2Fi386%2Fgthr-win32.h?ref=e2fc12a5dafadf15d804e1d2541528296e97a847", "patch": "@@ -381,6 +381,14 @@ typedef struct timespec __gthread_time_t;\n #define __GTHREAD_COND_INIT_FUNCTION __gthread_cond_init_function\n #define __GTHREAD_TIME_INIT {0, 0}\n \n+// Libstdc++ std::basic_filebuf needs the old definition of __gthread_mutex_t\n+// for layout purposes, but doesn't actually use it.\n+typedef struct {\n+  long __unused1;\n+  void *__unused2;\n+} __gthr_win32_legacy_mutex_t;\n+#define __GTHREAD_LEGACY_MUTEX_T __gthr_win32_legacy_mutex_t\n+\n #if defined (_WIN32) && !defined(__CYGWIN__)\n #define MINGW32_SUPPORTS_MT_EH 1\n /* Mingw runtime >= v0.3 provides a magic variable that is set to nonzero"}, {"sha": "e9e6e3ef4d876b48931bf0f4829d47d695198566", "filename": "libstdc++-v3/config/io/c_io_stdio.h", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e2fc12a5dafadf15d804e1d2541528296e97a847/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fc_io_stdio.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e2fc12a5dafadf15d804e1d2541528296e97a847/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fc_io_stdio.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfig%2Fio%2Fc_io_stdio.h?ref=e2fc12a5dafadf15d804e1d2541528296e97a847", "patch": "@@ -39,7 +39,14 @@ namespace std _GLIBCXX_VISIBILITY(default)\n {\n _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \n+#ifdef __GTHREAD_LEGACY_MUTEX_T\n+  // The layout of __gthread_mutex_t changed in GCC 13, but libstdc++ doesn't\n+  // actually use the basic_filebuf::_M_lock member, so define it consistently\n+  // with the old __gthread_mutex_t to avoid an unnecessary layout change:\n+  typedef __GTHREAD_LEGACY_MUTEX_T __c_lock;\n+#else\n   typedef __gthread_mutex_t __c_lock;\n+#endif\n \n   // for basic_file.h\n   typedef FILE __c_file;"}]}