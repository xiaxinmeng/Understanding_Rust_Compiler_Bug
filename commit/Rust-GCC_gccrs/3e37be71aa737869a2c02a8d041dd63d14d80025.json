{"sha": "3e37be71aa737869a2c02a8d041dd63d14d80025", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2UzN2JlNzFhYTczNzg2OWEyYzAyYThkMDQxZGQ2M2QxNGQ4MDAyNQ==", "commit": {"author": {"name": "Philippe Gil", "email": "gil@adacore.com", "date": "2011-08-29T09:30:33Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2011-08-29T09:30:33Z"}, "message": "prj.adb (Reset_Units_In_Table): New procedure.\n\n2011-08-29  Philippe Gil  <gil@adacore.com>\n\n\t* prj.adb (Reset_Units_In_Table): New procedure.\n\tReset units to avoid access to freed memory.\n\nFrom-SVN: r178178", "tree": {"sha": "9ea8ca204bce1acb4eaa22138aaf1c77875ff9b7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9ea8ca204bce1acb4eaa22138aaf1c77875ff9b7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3e37be71aa737869a2c02a8d041dd63d14d80025", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3e37be71aa737869a2c02a8d041dd63d14d80025", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3e37be71aa737869a2c02a8d041dd63d14d80025", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3e37be71aa737869a2c02a8d041dd63d14d80025/comments", "author": null, "committer": null, "parents": [{"sha": "94fb7608441bd960315df71ce953d9a88a9f74a3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94fb7608441bd960315df71ce953d9a88a9f74a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94fb7608441bd960315df71ce953d9a88a9f74a3"}], "stats": {"total": 43, "additions": 37, "deletions": 6}, "files": [{"sha": "b28557c68be28e799804ac4ce568a880703bfdf0", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3e37be71aa737869a2c02a8d041dd63d14d80025/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3e37be71aa737869a2c02a8d041dd63d14d80025/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=3e37be71aa737869a2c02a8d041dd63d14d80025", "patch": "@@ -1,3 +1,8 @@\n+2011-08-29  Philippe Gil  <gil@adacore.com>\n+\n+\t* prj.adb (Reset_Units_In_Table): New procedure.\n+\tReset units to avoid access to freed memory.\n+\n 2011-08-29  Thomas Quinot  <quinot@adacore.com>\n \n \t* get_scos.adb: When reading a P statement SCO without a pragma name"}, {"sha": "e68b18786d536358f30ab40e20008ae7ffe10b3a", "filename": "gcc/ada/prj.adb", "status": "modified", "additions": 32, "deletions": 6, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3e37be71aa737869a2c02a8d041dd63d14d80025/gcc%2Fada%2Fprj.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3e37be71aa737869a2c02a8d041dd63d14d80025/gcc%2Fada%2Fprj.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fprj.adb?ref=3e37be71aa737869a2c02a8d041dd63d14d80025", "patch": "@@ -71,6 +71,10 @@ package body Prj is\n    procedure Free_List (Languages : in out Language_List);\n    --  Free memory allocated for the list of languages or sources\n \n+   procedure Reset_Units_In_Table (Table : in out Units_Htable.Instance);\n+   --  reset to No_Unit_Index Unit.File_Names (Spec).Unit &\n+   --  Unit.File_Names (Impl).Unit for all Unis of the Table\n+\n    procedure Free_Units (Table : in out Units_Htable.Instance);\n    --  Free memory allocated for unit information in the project\n \n@@ -941,6 +945,29 @@ package body Prj is\n       end loop;\n    end Free_List;\n \n+   --------------------------\n+   -- Reset_Units_In_Table --\n+   --------------------------\n+\n+   procedure Reset_Units_In_Table (Table : in out Units_Htable.Instance) is\n+      Unit : Unit_Index;\n+\n+   begin\n+      Unit := Units_Htable.Get_First (Table);\n+      while Unit /= No_Unit_Index loop\n+         if Unit.File_Names (Spec) /= null then\n+            Unit.File_Names (Spec).Unit := No_Unit_Index;\n+         end if;\n+\n+         if Unit.File_Names (Impl) /= null then\n+            Unit.File_Names (Impl).Unit := No_Unit_Index;\n+         end if;\n+\n+         Unit := Units_Htable.Get_Next (Table);\n+      end loop;\n+\n+   end Reset_Units_In_Table;\n+\n    ----------------\n    -- Free_Units --\n    ----------------\n@@ -954,13 +981,10 @@ package body Prj is\n    begin\n       Unit := Units_Htable.Get_First (Table);\n       while Unit /= No_Unit_Index loop\n-         if Unit.File_Names (Spec) /= null then\n-            Unit.File_Names (Spec).Unit := No_Unit_Index;\n-         end if;\n \n-         if Unit.File_Names (Impl) /= null then\n-            Unit.File_Names (Impl).Unit := No_Unit_Index;\n-         end if;\n+         --  we cannot reset Unit.File_Names (Impl or Spec).Unit here as\n+         --  Source_Data buffer is freed by the following instruction\n+         --  Free_List (Tree.Projects, Free_Project => True);\n \n          Unchecked_Free (Unit);\n          Unit := Units_Htable.Get_Next (Table);\n@@ -1003,6 +1027,7 @@ package body Prj is\n          Source_Paths_Htable.Reset (Tree.Source_Paths_HT);\n          Source_Files_Htable.Reset (Tree.Source_Files_HT);\n \n+         Reset_Units_In_Table (Tree.Units_HT);\n          Free_List (Tree.Projects, Free_Project => True);\n          Free_Units (Tree.Units_HT);\n \n@@ -1048,6 +1073,7 @@ package body Prj is\n \n       Tree.Replaced_Source_Number := 0;\n \n+      Reset_Units_In_Table (Tree.Units_HT);\n       Free_List (Tree.Projects, Free_Project => True);\n       Free_Units (Tree.Units_HT);\n    end Reset;"}]}