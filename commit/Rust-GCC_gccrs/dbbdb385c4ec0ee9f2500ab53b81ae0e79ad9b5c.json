{"sha": "dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGJiZGIzODVjNGVjMGVlOWYyNTAwYWI1M2I4MWFlMGU3OWFkOWI1Yw==", "commit": {"author": {"name": "Richard Henderson", "email": "rth@redhat.com", "date": "2009-09-22T15:14:24Z"}, "committer": {"name": "Richard Henderson", "email": "rth@gcc.gnu.org", "date": "2009-09-22T15:14:24Z"}, "message": "mmix.c (TARGET_ASM_TRAMPOLINE_TEMPLATE): New.\n\n        * gcc/config/mmix/mmix.c (TARGET_ASM_TRAMPOLINE_TEMPLATE): New.\n        (TARGET_TRAMPOLINE_INIT): New.\n        (mmix_trampoline_size): Remove.\n        (mmix_asm_trampoline_template): Rename from mmix_trampoline_template;\n        make static.  Remove out-of-date tetra vs octa comment.\n        (mmix_trampoline_init): Rename from mmix_initialize_trampoline;\n        make static; update for hook parameters.\n        * config/mmix/mmix.h (TRAMPOLINE_TEMPLATE): Remove.\n        (INITIALIZE_TRAMPOLINE): Remove.\n        (TRAMPOLINE_SIZE): Use a constant instead of mmix_trampoline_size.\n        (TRAMPOLINE_ALIGNMENT): New.\n        * gcc/config/mmix/mmix-protos.h: Update.\n\nFrom-SVN: r152002", "tree": {"sha": "26ddfb03a63c9708e6c2954ed414176954b5ce8f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/26ddfb03a63c9708e6c2954ed414176954b5ce8f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/comments", "author": null, "committer": null, "parents": [{"sha": "a1d29c8cfeb14b3e9dff1cde0443bb8b80739245", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a1d29c8cfeb14b3e9dff1cde0443bb8b80739245", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a1d29c8cfeb14b3e9dff1cde0443bb8b80739245"}], "stats": {"total": 78, "additions": 44, "deletions": 34}, "files": [{"sha": "efcf989ebc1a1a3f1bcf7a58217e2a77467c9523", "filename": "gcc/ChangeLog", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "patch": "@@ -163,6 +163,19 @@\n \t(INITIALIZE_TRAMPOLINE): Move code to mips_trampoline_init;\n \tupdate for hook parameters.\n \n+\t* gcc/config/mmix/mmix.c (TARGET_ASM_TRAMPOLINE_TEMPLATE): New.\n+\t(TARGET_TRAMPOLINE_INIT): New.\n+\t(mmix_trampoline_size): Remove.\n+\t(mmix_asm_trampoline_template): Rename from mmix_trampoline_template;\n+\tmake static.  Remove out-of-date tetra vs octa comment.\n+\t(mmix_trampoline_init): Rename from mmix_initialize_trampoline;\n+\tmake static; update for hook parameters.\n+\t* config/mmix/mmix.h (TRAMPOLINE_TEMPLATE): Remove.\n+\t(INITIALIZE_TRAMPOLINE): Remove.\n+\t(TRAMPOLINE_SIZE): Use a constant instead of mmix_trampoline_size.\n+\t(TRAMPOLINE_ALIGNMENT): New.\n+\t* gcc/config/mmix/mmix-protos.h: Update.\n+\n 2009-09-22  Jakub Jelinek  <jakub@redhat.com>\n \n \t* config/rs6000/rs6000.c (bdesc_2arg): Fix CODE_FOR_vector_gt* codes"}, {"sha": "957164b468b371e6fca16a0d2c45cfcd66ad2f91", "filename": "gcc/config/mmix/mmix-protos.h", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2Fconfig%2Fmmix%2Fmmix-protos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2Fconfig%2Fmmix%2Fmmix-protos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fmmix%2Fmmix-protos.h?ref=dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "patch": "@@ -25,8 +25,6 @@ extern int mmix_initial_elimination_offset (int, int);\n extern int mmix_starting_frame_offset (void);\n extern int mmix_function_arg_regno_p (int, int);\n extern void mmix_function_profiler (FILE *, int);\n-extern void mmix_trampoline_template (FILE *);\n-extern int mmix_trampoline_size;\n extern int mmix_reversible_cc_mode (enum machine_mode);\n extern int mmix_register_move_cost\n   (enum machine_mode, enum reg_class, enum reg_class);\n@@ -80,7 +78,6 @@ extern rtx mmix_dynamic_chain_address (rtx);\n extern rtx mmix_return_addr_rtx (int, rtx);\n extern rtx mmix_eh_return_stackadj_rtx (void);\n extern rtx mmix_eh_return_handler_rtx (void);\n-extern void mmix_initialize_trampoline (rtx, rtx, rtx);\n extern int mmix_constant_address_p (rtx);\n extern int mmix_legitimate_constant_p (rtx);\n extern void mmix_print_operand (FILE *, rtx, int);"}, {"sha": "b589db96ea68acd781086580da30ddc36ef09e90", "filename": "gcc/config/mmix/mmix.c", "status": "modified", "additions": 29, "deletions": 24, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2Fconfig%2Fmmix%2Fmmix.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2Fconfig%2Fmmix%2Fmmix.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fmmix%2Fmmix.c?ref=dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "patch": "@@ -141,6 +141,8 @@ static enum machine_mode mmix_promote_function_mode (const_tree,\n static bool mmix_pass_by_reference (CUMULATIVE_ARGS *,\n \t\t\t\t    enum machine_mode, const_tree, bool);\n static bool mmix_frame_pointer_required (void);\n+static void mmix_asm_trampoline_template (FILE *);\n+static void mmix_trampoline_init (rtx, tree, rtx);\n \n /* Target structure macros.  Listed by node.  See `Using and Porting GCC'\n    for a general description.  */\n@@ -212,6 +214,11 @@ static bool mmix_frame_pointer_required (void);\n #undef TARGET_FRAME_POINTER_REQUIRED\n #define TARGET_FRAME_POINTER_REQUIRED mmix_frame_pointer_required\n \n+#undef TARGET_ASM_TRAMPOLINE_TEMPLATE\n+#define TARGET_ASM_TRAMPOLINE_TEMPLATE mmix_asm_trampoline_template\n+#undef TARGET_TRAMPOLINE_INIT\n+#define TARGET_TRAMPOLINE_INIT mmix_trampoline_init\n+\n struct gcc_target targetm = TARGET_INITIALIZER;\n \n /* Functions that are expansions for target macros.\n@@ -886,46 +893,44 @@ mmix_setup_incoming_varargs (CUMULATIVE_ARGS *args_so_farp,\n     internal_error (\"MMIX Internal: Last named vararg would not fit in a register\");\n }\n \n-/* TRAMPOLINE_SIZE.  */\n-/* Four 4-byte insns plus two 8-byte values.  */\n-int mmix_trampoline_size = 32;\n-\n-\n-/* TRAMPOLINE_TEMPLATE.  */\n+/* TARGET_ASM_TRAMPOLINE_TEMPLATE.  */\n \n-void\n-mmix_trampoline_template (FILE *stream)\n+static void\n+mmix_asm_trampoline_template (FILE *stream)\n {\n   /* Read a value into the static-chain register and jump somewhere.  The\n      static chain is stored at offset 16, and the function address is\n      stored at offset 24.  */\n-  /* FIXME: GCC copies this using *intsize* (tetra), when it should use\n-     register size (octa).  */\n+\n   fprintf (stream, \"\\tGETA $255,1F\\n\\t\");\n-  fprintf (stream, \"LDOU %s,$255,0\\n\\t\",\n-\t   reg_names[MMIX_STATIC_CHAIN_REGNUM]);\n+  fprintf (stream, \"LDOU %s,$255,0\\n\\t\", reg_names[MMIX_STATIC_CHAIN_REGNUM]);\n   fprintf (stream, \"LDOU $255,$255,8\\n\\t\");\n   fprintf (stream, \"GO $255,$255,0\\n\");\n   fprintf (stream, \"1H\\tOCTA 0\\n\\t\");\n   fprintf (stream, \"OCTA 0\\n\");\n }\n \n-/* INITIALIZE_TRAMPOLINE.  */\n+/* TARGET_TRAMPOLINE_INIT.  */\n /* Set the static chain and function pointer field in the trampoline.\n    We also SYNCID here to be sure (doesn't matter in the simulator, but\n    some day it will).  */\n \n-void\n-mmix_initialize_trampoline (rtx trampaddr, rtx fnaddr, rtx static_chain)\n-{\n-  emit_move_insn (gen_rtx_MEM (DImode, plus_constant (trampaddr, 16)),\n-\t\t  static_chain);\n-  emit_move_insn (gen_rtx_MEM (DImode,\n-\t\t\t       plus_constant (trampaddr, 24)),\n-\t\t  fnaddr);\n-  emit_insn (gen_sync_icache (validize_mem (gen_rtx_MEM (DImode,\n-\t\t\t\t\t\t\t trampaddr)),\n-\t\t\t      GEN_INT (mmix_trampoline_size - 1)));\n+static void\n+mmix_trampoline_init (rtx m_tramp, tree fndecl, rtx static_chain)\n+{\n+  rtx fnaddr = XEXP (DECL_RTL (fndecl), 0);\n+  rtx mem;\n+\n+  emit_block_move (m_tramp, assemble_trampoline_template (),\n+\t\t   GEN_INT (2*UNITS_PER_WORD), BLOCK_OP_NORMAL);\n+\n+  mem = adjust_address (m_tramp, DImode, 2*UNITS_PER_WORD);\n+  emit_move_insn (mem, static_chain);\n+  mem = adjust_address (m_tramp, DImode, 3*UNITS_PER_WORD);\n+  emit_move_insn (mem, fnaddr);\n+\n+  mem = adjust_address (m_tramp, DImode, 0);\n+  emit_insn (gen_sync_icache (mem, GEN_INT (TRAMPOLINE_SIZE - 1)));\n }\n \n /* We must exclude constant addresses that have an increment that is not a"}, {"sha": "1e76e460939267b5c908ca299d21342b3feee612", "filename": "gcc/config/mmix/mmix.h", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2Fconfig%2Fmmix%2Fmmix.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c/gcc%2Fconfig%2Fmmix%2Fmmix.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fmmix%2Fmmix.h?ref=dbbdb385c4ec0ee9f2500ab53b81ae0e79ad9b5c", "patch": "@@ -651,13 +651,8 @@ typedef struct { int regs; int lib; } CUMULATIVE_ARGS;\n \n /* Node: Trampolines */\n \n-#define TRAMPOLINE_TEMPLATE(FILE) \\\n- mmix_trampoline_template (FILE)\n-\n-#define TRAMPOLINE_SIZE mmix_trampoline_size\n-#define INITIALIZE_TRAMPOLINE(ADDR, FNADDR, STATIC_CHAIN) \\\n- mmix_initialize_trampoline (ADDR, FNADDR, STATIC_CHAIN)\n-\n+#define TRAMPOLINE_SIZE\t\t(4*UNITS_PER_WORD)\n+#define TRAMPOLINE_ALIGNMENT\tBITS_PER_WORD\n \n /* Node: Addressing Modes */\n "}]}