{"sha": "eeb145317b42d5203056851435457d9189a7303d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZWViMTQ1MzE3YjQyZDUyMDMwNTY4NTE0MzU0NTdkOTE4OWE3MzAzZA==", "commit": {"author": {"name": "Paul Thomas", "email": "pault@gcc.gnu.org", "date": "2020-12-29T17:44:48Z"}, "committer": {"name": "Paul Thomas", "email": "pault@gcc.gnu.org", "date": "2020-12-29T17:44:48Z"}, "message": "Fortran: Correct missing structure constructor comps. [PR97612].\n\n2020-12-29  Paul Thomas  <pault@gcc.gnu.org>\n\ngcc/fortran\n\tPR fortran/97612\n\t* primary.c (build_actual_constructor): Missing allocatable\n\tcomponents are set unallocated using EXPR_NULL. Then missing\n\tcomponents are tested for a default initializer.\n\ngcc/testsuite/\n\tPR fortran/97612\n\t* gfortran.dg/structure_constructor_17.f90: New test.", "tree": {"sha": "cb2e5812591f450f58c157376d43638c34c5f325", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cb2e5812591f450f58c157376d43638c34c5f325"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/eeb145317b42d5203056851435457d9189a7303d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eeb145317b42d5203056851435457d9189a7303d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/eeb145317b42d5203056851435457d9189a7303d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eeb145317b42d5203056851435457d9189a7303d/comments", "author": null, "committer": null, "parents": [{"sha": "feae0af82753e06fbff6103da5fbb3b28e1ddbd7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/feae0af82753e06fbff6103da5fbb3b28e1ddbd7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/feae0af82753e06fbff6103da5fbb3b28e1ddbd7"}], "stats": {"total": 53, "additions": 42, "deletions": 11}, "files": [{"sha": "93d74737284b9bc7a89acab7ad91cbecf72569d8", "filename": "gcc/fortran/primary.c", "status": "modified", "additions": 21, "deletions": 11, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/eeb145317b42d5203056851435457d9189a7303d/gcc%2Ffortran%2Fprimary.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/eeb145317b42d5203056851435457d9189a7303d/gcc%2Ffortran%2Fprimary.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fprimary.c?ref=eeb145317b42d5203056851435457d9189a7303d", "patch": "@@ -3003,26 +3003,36 @@ build_actual_constructor (gfc_structure_ctor_component **comp_head,\n \t  continue;\n \t}\n \n-      /* If it was not found, try the default initializer if there's any;\n+      /* If it was not found, apply NULL expression to set the component as\n+\t unallocated. Then try the default initializer if there's any;\n \t otherwise, it's an error unless this is a deferred parameter.  */\n       if (!comp_iter)\n \t{\n-\t  if (comp->initializer)\n-\t    {\n-\t      if (!gfc_notify_std (GFC_STD_F2003, \"Structure constructor \"\n-\t\t\t\t   \"with missing optional arguments at %C\"))\n-\t\treturn false;\n-\t      value = gfc_copy_expr (comp->initializer);\n-\t    }\n-\t  else if (comp->attr.allocatable\n-\t\t   || (comp->ts.type == BT_CLASS\n-\t\t       && CLASS_DATA (comp)->attr.allocatable))\n+\t  /* F2018 7.5.10: If an allocatable component has no corresponding\n+\t     component-data-source, then that component has an allocation\n+\t     status of unallocated....  */\n+\t  if (comp->attr.allocatable\n+\t      || (comp->ts.type == BT_CLASS\n+\t\t  && CLASS_DATA (comp)->attr.allocatable))\n \t    {\n \t      if (!gfc_notify_std (GFC_STD_F2008, \"No initializer for \"\n \t\t\t\t   \"allocatable component %qs given in the \"\n \t\t\t\t   \"structure constructor at %C\", comp->name))\n \t\treturn false;\n+\t      value = gfc_get_null_expr (&gfc_current_locus);\n+\t    }\n+\t  /* ....(Preceeding sentence) If a component with default\n+\t     initialization has no corresponding component-data-source, then\n+\t     the default initialization is applied to that component.  */\n+\t  else if (comp->initializer)\n+\t    {\n+\t      if (!gfc_notify_std (GFC_STD_F2003, \"Structure constructor \"\n+\t\t\t\t   \"with missing optional arguments at %C\"))\n+\t\treturn false;\n+\t      value = gfc_copy_expr (comp->initializer);\n \t    }\n+\t  /* Do not trap components such as the string length for deferred\n+\t     length character components.  */\n \t  else if (!comp->attr.artificial)\n \t    {\n \t      gfc_error (\"No initializer for component %qs given in the\""}, {"sha": "8b8230c6f7e1fb5a92309abd1913d29d845d80fd", "filename": "gcc/testsuite/gfortran.dg/structure_constructor_17.f90", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/eeb145317b42d5203056851435457d9189a7303d/gcc%2Ftestsuite%2Fgfortran.dg%2Fstructure_constructor_17.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/eeb145317b42d5203056851435457d9189a7303d/gcc%2Ftestsuite%2Fgfortran.dg%2Fstructure_constructor_17.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fstructure_constructor_17.f90?ref=eeb145317b42d5203056851435457d9189a7303d", "patch": "@@ -0,0 +1,21 @@\n+! { dg-do compile }\n+!\n+! Test the fix for PR97612.\n+!\n+! Contributed by Martin Stein  <mscfd@gmx.net>\n+!\n+program constructor_allocatable\n+  implicit none\n+\n+  type :: s\n+    integer, dimension(:), allocatable :: u\n+  end type s\n+\n+  type :: t\n+    type(s), dimension(:), allocatable :: x\n+  end type t\n+\n+  type(t) :: a = t()\n+  if (allocated (a%x)) stop 1\n+\n+end program constructor_allocatable"}]}