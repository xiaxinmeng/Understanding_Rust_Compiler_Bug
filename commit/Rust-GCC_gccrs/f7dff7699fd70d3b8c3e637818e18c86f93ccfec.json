{"sha": "f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjdkZmY3Njk5ZmQ3MGQzYjhjM2U2Mzc4MThlMThjODZmOTNjY2ZlYw==", "commit": {"author": {"name": "Andre Vieira", "email": "andre.simoesdiasvieira@arm.com", "date": "2020-01-16T10:28:02Z"}, "committer": {"name": "Andre Vieira", "email": "andre.simoesdiasvieira@arm.com", "date": "2020-01-16T10:28:02Z"}, "message": "PR tree-optimization/92429 do not fold when updating epilogue statements\n\nThis patch addresses the problem reported in PR92429.  When creating an\nepilogue for vectorization we have to replace the SSA_NAMEs in the\nPATTERN_DEF_SEQs and RELATED_STMTs of the epilogue's loop_vec_infos. When doing\nthis we were using simplify_replace_tree which always folds the replacement.\nThis may lead to a different tree-node than the one which was analyzed in\nvect_loop_analyze.  In turn the new tree-node may require a different\nvectorization than the one we had prepared for which caused the ICE in\nquestion.\n\ngcc/ChangeLog:\n2020-01-16  Andre Vieira  <andre.simoesdiasvieira@arm.com>\n\n\tPR tree-optimization/92429\n\t* tree-ssa-loop-niter.h (simplify_replace_tree): Add parameter.\n\t* tree-ssa-loop-niter.c (simplify_replace_tree): Add parameter to\n\tcontrol folding.\n\t* tree-vect-loop.c (update_epilogue_vinfo): Do not fold when replacing\n\ttree.\n\ngcc/testsuite/ChangeLog:\n2020-01-16  Andre Vieira  <andre.simoesdiasvieira@arm.com>\n\n\tPR tree-optimization/92429\n\t* gcc.dg/vect/pr92429.c: New test.", "tree": {"sha": "af31f070a180f10ce3976fea11218eab523cbd19", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/af31f070a180f10ce3976fea11218eab523cbd19"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/comments", "author": {"login": "avieira-arm", "id": 68072104, "node_id": "MDQ6VXNlcjY4MDcyMTA0", "avatar_url": "https://avatars.githubusercontent.com/u/68072104?v=4", "gravatar_id": "", "url": "https://api.github.com/users/avieira-arm", "html_url": "https://github.com/avieira-arm", "followers_url": "https://api.github.com/users/avieira-arm/followers", "following_url": "https://api.github.com/users/avieira-arm/following{/other_user}", "gists_url": "https://api.github.com/users/avieira-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/avieira-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/avieira-arm/subscriptions", "organizations_url": "https://api.github.com/users/avieira-arm/orgs", "repos_url": "https://api.github.com/users/avieira-arm/repos", "events_url": "https://api.github.com/users/avieira-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/avieira-arm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "avieira-arm", "id": 68072104, "node_id": "MDQ6VXNlcjY4MDcyMTA0", "avatar_url": "https://avatars.githubusercontent.com/u/68072104?v=4", "gravatar_id": "", "url": "https://api.github.com/users/avieira-arm", "html_url": "https://github.com/avieira-arm", "followers_url": "https://api.github.com/users/avieira-arm/followers", "following_url": "https://api.github.com/users/avieira-arm/following{/other_user}", "gists_url": "https://api.github.com/users/avieira-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/avieira-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/avieira-arm/subscriptions", "organizations_url": "https://api.github.com/users/avieira-arm/orgs", "repos_url": "https://api.github.com/users/avieira-arm/repos", "events_url": "https://api.github.com/users/avieira-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/avieira-arm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3b5757ea87ad2274b841340335bf7536204e615b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b5757ea87ad2274b841340335bf7536204e615b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3b5757ea87ad2274b841340335bf7536204e615b"}], "stats": {"total": 30, "additions": 25, "deletions": 5}, "files": [{"sha": "d21ec86a2dd190f271647a23416021561fed827e", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "patch": "@@ -1,3 +1,12 @@\n+2020-01-16  Andre Vieira  <andre.simoesdiasvieira@arm.com>\n+\n+\tPR tree-optimization/92429\n+\t* tree-ssa-loop-niter.h (simplify_replace_tree): Add parameter.\n+\t* tree-ssa-loop-niter.c (simplify_replace_tree): Add parameter to\n+\tcontrol folding.\n+\t* tree-vect-loop.c (update_epilogue_vinfo): Do not fold when replacing\n+\ttree.\n+\n 2020-01-16  Richard Sandiford  <richard.sandiford@arm.com>\n \n \t* config/aarch64/aarch64.c (aarch64_split_sve_subreg_move): Apply"}, {"sha": "0d8aa6063a73be21d64869d38dec60791957cb28", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "patch": "@@ -1,3 +1,8 @@\n+2020-01-16  Andre Vieira  <andre.simoesdiasvieira@arm.com>\n+\n+\tPR tree-optimization/92429\n+\t* gcc.dg/vect/pr92429.c: New test.\n+\n 2020-01-16  Tobias Burnus  <tobias@codesourcery.com>\n \n \tPR fortran/93253"}, {"sha": "6e6df0bfdb898de948c917640ff488b19cf7911f", "filename": "gcc/tree-ssa-loop-niter.c", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftree-ssa-loop-niter.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftree-ssa-loop-niter.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-loop-niter.c?ref=f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "patch": "@@ -1934,7 +1934,8 @@ number_of_iterations_cond (class loop *loop,\n \n tree\n simplify_replace_tree (tree expr, tree old, tree new_tree,\n-\t\t       tree (*valueize) (tree, void*), void *context)\n+\t\t       tree (*valueize) (tree, void*), void *context,\n+\t\t       bool do_fold)\n {\n   unsigned i, n;\n   tree ret = NULL_TREE, e, se;\n@@ -1966,7 +1967,7 @@ simplify_replace_tree (tree expr, tree old, tree new_tree,\n   for (i = 0; i < n; i++)\n     {\n       e = TREE_OPERAND (expr, i);\n-      se = simplify_replace_tree (e, old, new_tree, valueize, context);\n+      se = simplify_replace_tree (e, old, new_tree, valueize, context, do_fold);\n       if (e == se)\n \tcontinue;\n \n@@ -1976,7 +1977,7 @@ simplify_replace_tree (tree expr, tree old, tree new_tree,\n       TREE_OPERAND (ret, i) = se;\n     }\n \n-  return (ret ? fold (ret) : expr);\n+  return (ret ? (do_fold ? fold (ret) : ret) : expr);\n }\n \n /* Expand definitions of ssa names in EXPR as long as they are simple"}, {"sha": "eb8d1579479cf6df66f9486c7ce6f9ac20a02e2a", "filename": "gcc/tree-ssa-loop-niter.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftree-ssa-loop-niter.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftree-ssa-loop-niter.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-loop-niter.h?ref=f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "patch": "@@ -58,7 +58,7 @@ extern void free_numbers_of_iterations_estimates (class loop *);\n extern void free_numbers_of_iterations_estimates (function *);\n extern tree simplify_replace_tree (tree, tree,\n \t\t\t\t   tree, tree (*)(tree, void *) = NULL,\n-\t\t\t\t   void * = NULL);\n+\t\t\t\t   void * = NULL, bool do_fold = true);\n extern void substitute_in_loop_info (class loop *, tree, tree);\n \n #endif /* GCC_TREE_SSA_LOOP_NITER_H */"}, {"sha": "e5fb434bd4e5d98587791287d51d3e8ea7d1460f", "filename": "gcc/tree-vect-loop.c", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftree-vect-loop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7dff7699fd70d3b8c3e637818e18c86f93ccfec/gcc%2Ftree-vect-loop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-loop.c?ref=f7dff7699fd70d3b8c3e637818e18c86f93ccfec", "patch": "@@ -8434,8 +8434,13 @@ update_epilogue_loop_vinfo (class loop *epilogue, tree advance)\n \t    gimple_set_op (stmt, j, *new_op);\n \t  else\n \t    {\n+\t      /* PR92429: The last argument of simplify_replace_tree disables\n+\t\t folding when replacing arguments.  This is required as\n+\t\t otherwise you might end up with different statements than the\n+\t\t ones analyzed in vect_loop_analyze, leading to different\n+\t\t vectorization.  */\n \t      op = simplify_replace_tree (op, NULL_TREE, NULL_TREE,\n-\t\t\t\t     &find_in_mapping, &mapping);\n+\t\t\t\t\t  &find_in_mapping, &mapping, false);\n \t      gimple_set_op (stmt, j, op);\n \t    }\n \t}"}]}