{"sha": "2810dfab5c2abd27245d8b4e508bb40e955c095f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjgxMGRmYWI1YzJhYmQyNzI0NWQ4YjRlNTA4YmI0MGU5NTVjMDk1Zg==", "commit": {"author": {"name": "Steven G. Kargl", "email": "kargl@gcc.gnu.org", "date": "2019-04-22T21:00:40Z"}, "committer": {"name": "Steven G. Kargl", "email": "kargl@gcc.gnu.org", "date": "2019-04-22T21:00:40Z"}, "message": "re PR fortran/90166 (Compiler Fails at Assembler)\n\n2019-04-19  Steven G. Kargl  <kargl@gcc.gnu.org>\n\n\tPR fortran/90166\n\t* decl.c (in_module_or_interface): New function to check that the\n\tcurrent state is in a module, submodule, or interface.\n\t(gfc_match_prefix): Use it.\n\n2019-04-19  Steven G. Kargl  <kargl@gcc.gnu.org>\n\n\tPR fortran/90166\n\t* gfortran.dg/submodule_22.f08: Add additional dg-error comments.\n\nFrom-SVN: r270495", "tree": {"sha": "3a61002b0d34f901ace9c7a1d225d2c5f7996503", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3a61002b0d34f901ace9c7a1d225d2c5f7996503"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2810dfab5c2abd27245d8b4e508bb40e955c095f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2810dfab5c2abd27245d8b4e508bb40e955c095f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2810dfab5c2abd27245d8b4e508bb40e955c095f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2810dfab5c2abd27245d8b4e508bb40e955c095f/comments", "author": null, "committer": null, "parents": [{"sha": "f2b6aeeab219cc41ebc763e8e8378f83287d3591", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f2b6aeeab219cc41ebc763e8e8378f83287d3591", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f2b6aeeab219cc41ebc763e8e8378f83287d3591"}], "stats": {"total": 49, "additions": 45, "deletions": 4}, "files": [{"sha": "12cb55c2dcb9d9e18f69d6b106f0211152f04021", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=2810dfab5c2abd27245d8b4e508bb40e955c095f", "patch": "@@ -1,3 +1,10 @@\n+2019-04-19  Steven G. Kargl  <kargl@gcc.gnu.org>\n+\n+\tPR fortran/90166\n+\t* decl.c (in_module_or_interface): New function to check that the\n+\tcurrent state is in a module, submodule, or interface.\n+\t(gfc_match_prefix): Use it.\n+\n 2019-04-22  Paul Thomas  <pault@gcc.gnu.org>\n \n \tPR fortran/57284"}, {"sha": "66f1094aa3d9f45f5d3522a3e1b1b747be2ba241", "filename": "gcc/fortran/decl.c", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ffortran%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ffortran%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fdecl.c?ref=2810dfab5c2abd27245d8b4e508bb40e955c095f", "patch": "@@ -6070,6 +6070,28 @@ gfc_match_data_decl (void)\n   return m;\n }\n \n+static bool\n+in_module_or_interface(void)\n+{\n+  if (gfc_current_state () == COMP_MODULE\n+      || gfc_current_state () == COMP_SUBMODULE \n+      || gfc_current_state () == COMP_INTERFACE)\n+    return true;\n+\n+  if (gfc_state_stack->state == COMP_CONTAINS\n+      || gfc_state_stack->state == COMP_FUNCTION\n+      || gfc_state_stack->state == COMP_SUBROUTINE)\n+    {\n+      gfc_state_data *p;\n+      for (p = gfc_state_stack->previous; p ; p = p->previous)\n+\t{\n+\t  if (p->state == COMP_MODULE || p->state == COMP_SUBMODULE \n+\t      || p->state == COMP_INTERFACE)\n+\t    return true;\n+\t}\n+    }\n+    return false;\n+}\n \n /* Match a prefix associated with a function or subroutine\n    declaration.  If the typespec pointer is nonnull, then a typespec\n@@ -6103,6 +6125,13 @@ gfc_match_prefix (gfc_typespec *ts)\n \t  if (!gfc_notify_std (GFC_STD_F2008, \"MODULE prefix at %C\"))\n \t    goto error;\n \n+\t  if (!in_module_or_interface ())\n+\t    {\n+\t      gfc_error (\"MODULE prefix at %C found outside of a module, \"\n+\t\t\t \"submodule, or interface\");\n+\t      goto error;\n+\t    }\n+\n \t  current_attr.module_procedure = 1;\n \t  found_prefix = true;\n \t}"}, {"sha": "e22996fde9c6298751d307a73fb1ccac22c842b6", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=2810dfab5c2abd27245d8b4e508bb40e955c095f", "patch": "@@ -1,3 +1,8 @@\n+2019-04-22  Steven G. Kargl  <kargl@gcc.gnu.org>\n+\n+\tPR fortran/90166\n+\t* gfortran.dg/submodule_22.f08: Add additional dg-error comments.\n+\n 2019-04-22  Paul Thomas  <pault@gcc.gnu.org>\n \n \tPR fortran/57284"}, {"sha": "eab398fd3d3f9be48458e9a7bdb180e176d378ec", "filename": "gcc/testsuite/gfortran.dg/submodule_22.f08", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ftestsuite%2Fgfortran.dg%2Fsubmodule_22.f08", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2810dfab5c2abd27245d8b4e508bb40e955c095f/gcc%2Ftestsuite%2Fgfortran.dg%2Fsubmodule_22.f08", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fsubmodule_22.f08?ref=2810dfab5c2abd27245d8b4e508bb40e955c095f", "patch": "@@ -40,8 +40,8 @@ end subroutine sub2\n \n submodule (mtop:submod:subsubmod) subsubsubmod ! { dg-error \"Syntax error in SUBMODULE statement\" }\n contains\n-  module subroutine sub3\n-    r = 2.0\n-    s = 2.0\n-  end subroutine sub3\n+  module subroutine sub3  ! { dg-error \"found outside of a module\" }\n+    r = 2.0               ! { dg-error \"Unexpected assignment\" }\n+    s = 2.0               ! { dg-error \"Unexpected assignment\" }\n+  end subroutine sub3     ! { dg-error \"Expecting END PROGRAM statement\" }\n end"}]}