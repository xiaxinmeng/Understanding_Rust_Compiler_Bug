{"sha": "676b5525e8333005bdc1c596ed086f1da27a450f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njc2YjU1MjVlODMzMzAwNWJkYzFjNTk2ZWQwODZmMWRhMjdhNDUwZg==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-08-08T09:10:30Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-08-08T09:10:30Z"}, "message": "openmp: Handle clauses with gimple sequences in convert_nonlocal_omp_clauses properly\n\nIf the walk_body on the various sequences of reduction, lastprivate and/or linear\nclauses needs to create a temporary variable, we should declare that variable\nin that sequence rather than outside, where it would need to be privatized inside of\nthe construct.\n\n2020-08-08  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR fortran/93553\n\t* tree-nested.c (convert_nonlocal_omp_clauses): For\n\tOMP_CLAUSE_REDUCTION, OMP_CLAUSE_LASTPRIVATE and OMP_CLAUSE_LINEAR\n\tsave info->new_local_var_chain around walks of the clause gimple\n\tsequences and declare_vars if needed into the sequence.\n\n2020-08-08  Tobias Burnus  <tobias@codesourcery.com>\n\n\tPR fortran/93553\n\t* testsuite/libgomp.fortran/pr93553.f90: New test.", "tree": {"sha": "a73f71ff5498a86738b5637348e0d94f03984230", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a73f71ff5498a86738b5637348e0d94f03984230"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/676b5525e8333005bdc1c596ed086f1da27a450f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/676b5525e8333005bdc1c596ed086f1da27a450f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/676b5525e8333005bdc1c596ed086f1da27a450f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/676b5525e8333005bdc1c596ed086f1da27a450f/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87d6dae308d604bad111b1c0bfea7835888eed8d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87d6dae308d604bad111b1c0bfea7835888eed8d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/87d6dae308d604bad111b1c0bfea7835888eed8d"}], "stats": {"total": 67, "additions": 57, "deletions": 10}, "files": [{"sha": "f74a727dea15f5da963bfe4326a042e78b9d50c4", "filename": "gcc/tree-nested.c", "status": "modified", "additions": 36, "deletions": 10, "changes": 46, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/676b5525e8333005bdc1c596ed086f1da27a450f/gcc%2Ftree-nested.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/676b5525e8333005bdc1c596ed086f1da27a450f/gcc%2Ftree-nested.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-nested.c?ref=676b5525e8333005bdc1c596ed086f1da27a450f", "patch": "@@ -1419,12 +1419,22 @@ convert_nonlocal_omp_clauses (tree *pclauses, struct walk_stmt_info *wi)\n \t      if (OMP_CLAUSE_REDUCTION_DECL_PLACEHOLDER (clause))\n \t\tDECL_CONTEXT (OMP_CLAUSE_REDUCTION_DECL_PLACEHOLDER (clause))\n \t\t  = info->context;\n+\t      tree save_local_var_chain = info->new_local_var_chain;\n+\t      info->new_local_var_chain = NULL;\n+\t      gimple_seq *seq = &OMP_CLAUSE_REDUCTION_GIMPLE_INIT (clause);\n \t      walk_body (convert_nonlocal_reference_stmt,\n-\t\t\t convert_nonlocal_reference_op, info,\n-\t\t\t &OMP_CLAUSE_REDUCTION_GIMPLE_INIT (clause));\n+\t\t\t convert_nonlocal_reference_op, info, seq);\n+\t      if (info->new_local_var_chain)\n+\t\tdeclare_vars (info->new_local_var_chain,\n+\t\t\t      gimple_seq_first_stmt (*seq), false);\n+\t      info->new_local_var_chain = NULL;\n+\t      seq = &OMP_CLAUSE_REDUCTION_GIMPLE_MERGE (clause);\n \t      walk_body (convert_nonlocal_reference_stmt,\n-\t\t\t convert_nonlocal_reference_op, info,\n-\t\t\t &OMP_CLAUSE_REDUCTION_GIMPLE_MERGE (clause));\n+\t\t\t convert_nonlocal_reference_op, info, seq);\n+\t      if (info->new_local_var_chain)\n+\t\tdeclare_vars (info->new_local_var_chain,\n+\t\t\t      gimple_seq_first_stmt (*seq), false);\n+\t      info->new_local_var_chain = save_local_var_chain;\n \t      DECL_CONTEXT (OMP_CLAUSE_REDUCTION_PLACEHOLDER (clause))\n \t\t= old_context;\n \t      if (OMP_CLAUSE_REDUCTION_DECL_PLACEHOLDER (clause))\n@@ -1434,15 +1444,31 @@ convert_nonlocal_omp_clauses (tree *pclauses, struct walk_stmt_info *wi)\n \t  break;\n \n \tcase OMP_CLAUSE_LASTPRIVATE:\n-\t  walk_body (convert_nonlocal_reference_stmt,\n-\t\t     convert_nonlocal_reference_op, info,\n-\t\t     &OMP_CLAUSE_LASTPRIVATE_GIMPLE_SEQ (clause));\n+\t  {\n+\t    tree save_local_var_chain = info->new_local_var_chain;\n+\t    info->new_local_var_chain = NULL;\n+\t    gimple_seq *seq = &OMP_CLAUSE_LASTPRIVATE_GIMPLE_SEQ (clause);\n+\t    walk_body (convert_nonlocal_reference_stmt,\n+\t\t       convert_nonlocal_reference_op, info, seq);\n+\t    if (info->new_local_var_chain)\n+\t      declare_vars (info->new_local_var_chain,\n+\t\t\t    gimple_seq_first_stmt (*seq), false);\n+\t    info->new_local_var_chain = save_local_var_chain;\n+\t  }\n \t  break;\n \n \tcase OMP_CLAUSE_LINEAR:\n-\t  walk_body (convert_nonlocal_reference_stmt,\n-\t\t     convert_nonlocal_reference_op, info,\n-\t\t     &OMP_CLAUSE_LINEAR_GIMPLE_SEQ (clause));\n+\t  {\n+\t    tree save_local_var_chain = info->new_local_var_chain;\n+\t    info->new_local_var_chain = NULL;\n+\t    gimple_seq *seq = &OMP_CLAUSE_LINEAR_GIMPLE_SEQ (clause);\n+\t    walk_body (convert_nonlocal_reference_stmt,\n+\t\t       convert_nonlocal_reference_op, info, seq);\n+\t    if (info->new_local_var_chain)\n+\t      declare_vars (info->new_local_var_chain,\n+\t\t\t    gimple_seq_first_stmt (*seq), false);\n+\t    info->new_local_var_chain = save_local_var_chain;\n+\t  }\n \t  break;\n \n \tdefault:"}, {"sha": "5d6f10febed7dfaa00ee365bc8db0c48ab82b8cd", "filename": "libgomp/testsuite/libgomp.fortran/pr93553.f90", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/676b5525e8333005bdc1c596ed086f1da27a450f/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr93553.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/676b5525e8333005bdc1c596ed086f1da27a450f/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr93553.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr93553.f90?ref=676b5525e8333005bdc1c596ed086f1da27a450f", "patch": "@@ -0,0 +1,21 @@\n+program p\n+   implicit none\n+   integer :: x(8) = 0\n+   call sub(x)\n+end\n+subroutine sub(x)\n+   implicit none\n+   integer i\n+   integer :: x(8)\n+   integer :: c(8) = [(11*i, i=1,8)]\n+   call s\n+   if (any (x /= c)) stop 1\n+contains\n+   subroutine s\n+      integer :: i\n+      !$omp parallel do reduction(+:x)\n+      do i = 1, 8\n+         x(i) = c(i)\n+      end do\n+   end\n+end"}]}