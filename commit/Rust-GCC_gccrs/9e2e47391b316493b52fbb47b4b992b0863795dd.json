{"sha": "9e2e47391b316493b52fbb47b4b992b0863795dd", "node_id": "C_kwDOANBUbNoAKDllMmU0NzM5MWIzMTY0OTNiNTJmYmI0N2I0Yjk5MmIwODYzNzk1ZGQ", "commit": {"author": {"name": "Martin Jambor", "email": "mjambor@suse.cz", "date": "2021-11-27T00:00:56Z"}, "committer": {"name": "Martin Jambor", "email": "mjambor@suse.cz", "date": "2021-11-27T00:01:46Z"}, "message": "ipa: Fix CFG fix-up in IPA-CP transform phase (PR 103441)\n\nI forgot that IPA passes before ipa-inline must not return\nTODO_cleanup_cfg from their transformation function because ordinary\nCFG cleanup does not remove call graph edges associated with removed\ncall statements but must use\ndelete_unreachable_blocks_update_callgraph instead.  This patch fixes\nthat error.\n\ngcc/ChangeLog:\n\n2021-11-26  Martin Jambor  <mjambor@suse.cz>\n\n\tPR ipa/103441\n\t* ipa-prop.c (ipcp_transform_function): Call\n\tdelete_unreachable_blocks_update_callgraph instead of returning\n\tTODO_cleanup_cfg.", "tree": {"sha": "c7814635be4235c151fd499188df1bbe1e7ff28c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c7814635be4235c151fd499188df1bbe1e7ff28c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9e2e47391b316493b52fbb47b4b992b0863795dd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE5elVTFt/d09Vsoczv2PBvD+kNUAFAmGhdWoACgkQv2PBvD+k\nNUBDwRAAg1rIgV7LRNJ1yyOhhjzSBDbK8IR9IlYdxZAYqu3nM87ObV7u9ToTuA8Z\nudKIjpOjHxx2YC3/jpa6yhMSl9TsGFv9NTC2tn/qaWIjOBSzyJtX4k/jSeTCQ18E\nZsbFsInwncjMdSkMmULIaWJHcPEYs5Bvw7M/MAUyb/NJsUgMp/b3BBFjlaxA5VKC\n3AFalxxeikFdTyhZE62NK7x6gjqleYI6Kv1mMI5XZbqCxC/VMX9N7+1aUjT594K8\naIxaxmDhRnodUDLvPYEDrP/oS1NTn6FPLxgmZskjRda9b9IAduWhXrODXM49oWBM\nh4ithoYAKgHqBkZl8qjUywlHzPa6PxPsz8sjHQk/K/bkxamSTZ7JzmU2vlwMX4yR\n3jhlW0gn7LrMvoMQqYcceAKsjI6VIlkFG18BrzIQHYDSVxN7CVxXVS6QaZzII7VV\nVE7eOgYrISGt7yMlb2W7c6pFH95KenVFNVtmEBfshEZzQRoWZCsXzViiCOINnH65\nDj9p59Ze04yEIP1l2wW1n2UjyjF4nOUI/JnuR1L3Y4UalRV2rEoJLuYTx5tibK/U\nIhANY9wGaselW4lIm7PrLMfgscLiICx+7MOiPg2UDExFtOw7qCjc8i+hYSbIEuWb\n73ZYWWkJ+hSQws4q3nrZh+4cyfYx+uweYpG08g5pGJX7PxIUekA=\n=XWar\n-----END PGP SIGNATURE-----", "payload": "tree c7814635be4235c151fd499188df1bbe1e7ff28c\nparent 52b769437a4d1ca50f4ef5bdad65b12115ded845\nauthor Martin Jambor <mjambor@suse.cz> 1637971256 +0100\ncommitter Martin Jambor <mjambor@suse.cz> 1637971306 +0100\n\nipa: Fix CFG fix-up in IPA-CP transform phase (PR 103441)\n\nI forgot that IPA passes before ipa-inline must not return\nTODO_cleanup_cfg from their transformation function because ordinary\nCFG cleanup does not remove call graph edges associated with removed\ncall statements but must use\ndelete_unreachable_blocks_update_callgraph instead.  This patch fixes\nthat error.\n\ngcc/ChangeLog:\n\n2021-11-26  Martin Jambor  <mjambor@suse.cz>\n\n\tPR ipa/103441\n\t* ipa-prop.c (ipcp_transform_function): Call\n\tdelete_unreachable_blocks_update_callgraph instead of returning\n\tTODO_cleanup_cfg.\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9e2e47391b316493b52fbb47b4b992b0863795dd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9e2e47391b316493b52fbb47b4b992b0863795dd", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9e2e47391b316493b52fbb47b4b992b0863795dd/comments", "author": {"login": "jamborm", "id": 2180070, "node_id": "MDQ6VXNlcjIxODAwNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/2180070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamborm", "html_url": "https://github.com/jamborm", "followers_url": "https://api.github.com/users/jamborm/followers", "following_url": "https://api.github.com/users/jamborm/following{/other_user}", "gists_url": "https://api.github.com/users/jamborm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamborm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamborm/subscriptions", "organizations_url": "https://api.github.com/users/jamborm/orgs", "repos_url": "https://api.github.com/users/jamborm/repos", "events_url": "https://api.github.com/users/jamborm/events{/privacy}", "received_events_url": "https://api.github.com/users/jamborm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jamborm", "id": 2180070, "node_id": "MDQ6VXNlcjIxODAwNzA=", "avatar_url": "https://avatars.githubusercontent.com/u/2180070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jamborm", "html_url": "https://github.com/jamborm", "followers_url": "https://api.github.com/users/jamborm/followers", "following_url": "https://api.github.com/users/jamborm/following{/other_user}", "gists_url": "https://api.github.com/users/jamborm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jamborm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jamborm/subscriptions", "organizations_url": "https://api.github.com/users/jamborm/orgs", "repos_url": "https://api.github.com/users/jamborm/repos", "events_url": "https://api.github.com/users/jamborm/events{/privacy}", "received_events_url": "https://api.github.com/users/jamborm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52b769437a4d1ca50f4ef5bdad65b12115ded845", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/52b769437a4d1ca50f4ef5bdad65b12115ded845", "html_url": "https://github.com/Rust-GCC/gccrs/commit/52b769437a4d1ca50f4ef5bdad65b12115ded845"}], "stats": {"total": 18, "additions": 8, "deletions": 10}, "files": [{"sha": "bc5643206b9094215c3ec94b914f3aa538213602", "filename": "gcc/ipa-prop.c", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e2e47391b316493b52fbb47b4b992b0863795dd/gcc%2Fipa-prop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e2e47391b316493b52fbb47b4b992b0863795dd/gcc%2Fipa-prop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-prop.c?ref=9e2e47391b316493b52fbb47b4b992b0863795dd", "patch": "@@ -6001,7 +6001,6 @@ ipcp_transform_function (struct cgraph_node *node)\n   struct ipa_func_body_info fbi;\n   struct ipa_agg_replacement_value *aggval;\n   int param_count;\n-  bool something_changed = false;\n \n   gcc_checking_assert (cfun);\n   gcc_checking_assert (current_function_decl);\n@@ -6022,14 +6021,16 @@ ipcp_transform_function (struct cgraph_node *node)\n   ipa_populate_param_decls (node, *descriptors);\n   std::pair<bool, bool> rr\n     = adjust_agg_replacement_values (node, aggval, *descriptors);\n-  int retval = rr.second ? TODO_cleanup_cfg : 0;\n+  bool cfg_changed = rr.second;\n   if (!rr.first)\n     {\n       vec_free (descriptors);\n       if (dump_file)\n \tfprintf (dump_file, \"  All affected aggregate parameters were either \"\n \t\t \"removed or converted into scalars, phase done.\\n\");\n-      return retval;\n+      if (cfg_changed)\n+\tdelete_unreachable_blocks_update_callgraph (node, false);\n+      return 0;\n     }\n   if (dump_file)\n     ipa_dump_agg_replacement_values (dump_file, aggval);\n@@ -6041,11 +6042,12 @@ ipcp_transform_function (struct cgraph_node *node)\n   fbi.param_count = param_count;\n   fbi.aa_walk_budget = opt_for_fn (node->decl, param_ipa_max_aa_steps);\n \n+  bool modified_mem_access = false;\n   calculate_dominance_info (CDI_DOMINATORS);\n-  ipcp_modif_dom_walker walker (&fbi, descriptors, aggval, &something_changed);\n+  ipcp_modif_dom_walker walker (&fbi, descriptors, aggval, &modified_mem_access);\n   walker.walk (ENTRY_BLOCK_PTR_FOR_FN (cfun));\n   free_dominance_info (CDI_DOMINATORS);\n-  bool cfg_changed = walker.cleanup_eh ();\n+  cfg_changed |= walker.cleanup_eh ();\n \n   int i;\n   struct ipa_bb_info *bi;\n@@ -6059,14 +6061,10 @@ ipcp_transform_function (struct cgraph_node *node)\n   s->m_vr = NULL;\n \n   vec_free (descriptors);\n-\n-  if (!something_changed)\n-    return retval;\n-\n   if (cfg_changed)\n     delete_unreachable_blocks_update_callgraph (node, false);\n \n-  return retval | TODO_update_ssa_only_virtuals;\n+  return modified_mem_access ? TODO_update_ssa_only_virtuals : 0;\n }\n \n "}]}