{"sha": "2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmNkNDRmNWE0NDhhZDFlMTYwZWRhZTEyMGNjN2I5NDVjYTFhNWRiMw==", "commit": {"author": {"name": "Vincent Celier", "email": "celier@adacore.com", "date": "2007-08-14T08:43:34Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2007-08-14T08:43:34Z"}, "message": "clean.adb, [...] (Create_Sym_Links): New procedure.\n\n2007-08-14  Vincent Celier  <celier@adacore.com>\n\n\t* clean.adb, fmap.adb, sinput-p.adb, sinput-p.ads, gnatcmd.adb, \n\tgnatname.adb, makeutl.ads, makeutl.adb, makegpr.adb, mlib-tgt-vms.adb\n\tmlib-tgt-darwin.adb, mlib-tgt-lynxos.adb, mlib-prj.adb, mlib-tgt.adb, \n\tmlib-tgt.ads, mlib-tgt-irix.adb mlib-tgt-hpux.adb, mlib-tgt-linux.adb, \n\tmlib-tgt-solaris.adb, mlib-tgt-vms-alpha.adb, mlib-tgt-vms-ia64.adb, \n\tmlib-tgt-mingw.adb, mlib-tgt-vxworks.adb, mlib-tgt-aix.adb,\n\tmlib-tgt-tru64.adb, mlib.ads, mlib.adb (Create_Sym_Links): New\n\tprocedure.\n\t(Major_Id_Name): New function.\n\tmlib-tgt.ads/mlib.tgt.adb:\n\t(Library_Major_Minor_Id_Supported): New function, default returns True\n\tMost mlib-tgt-*.adb that support shared libraries and symbolic links:\n\t(Build_Dynamic_Library): Add support for major/minor ids for shared libs\n\tOther mlib-tgt-*.adb (aix, mingw, vms, vxworks, xi):\n\tImplementation of Library_Major_Minor_Id_Supported returns False\n\tclean.adb:\n\t(Clean_Library_Directory): If major/minor ids are supported, clean all\n\tlibrary files.\n\tMajor update of the Project Manager and of the project aware tools,\n\tincluding gprmake, so that the same sources in the GNAT repository\n\tcan be used by gprbuild.\n\nFrom-SVN: r127432", "tree": {"sha": "5875d0102588a0bdaf32f61cb26f856f87ff7ec6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5875d0102588a0bdaf32f61cb26f856f87ff7ec6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/comments", "author": {"login": "vcelier", "id": 8888056, "node_id": "MDQ6VXNlcjg4ODgwNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/8888056?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vcelier", "html_url": "https://github.com/vcelier", "followers_url": "https://api.github.com/users/vcelier/followers", "following_url": "https://api.github.com/users/vcelier/following{/other_user}", "gists_url": "https://api.github.com/users/vcelier/gists{/gist_id}", "starred_url": "https://api.github.com/users/vcelier/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vcelier/subscriptions", "organizations_url": "https://api.github.com/users/vcelier/orgs", "repos_url": "https://api.github.com/users/vcelier/repos", "events_url": "https://api.github.com/users/vcelier/events{/privacy}", "received_events_url": "https://api.github.com/users/vcelier/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c9b9ec14ece5acf23bf0817633914e28c43c0678", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c9b9ec14ece5acf23bf0817633914e28c43c0678", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c9b9ec14ece5acf23bf0817633914e28c43c0678"}], "stats": {"total": 1833, "additions": 1015, "deletions": 818}, "files": [{"sha": "d4692ba65c5926c7b875c776147365b0d9fc185a", "filename": "gcc/ada/clean.adb", "status": "modified", "additions": 66, "deletions": 37, "changes": 103, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fclean.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fclean.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fclean.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -168,15 +168,13 @@ package body Clean is\n    -----------------------------\n \n    procedure Add_Source_Dir (N : String);\n-   --  Call Add_Src_Search_Dir.\n-   --  Output one line when in verbose mode.\n+   --  Call Add_Src_Search_Dir and output one line when in verbose mode\n \n    procedure Add_Source_Directories is\n      new Prj.Env.For_All_Source_Dirs (Action => Add_Source_Dir);\n \n    procedure Add_Object_Dir (N : String);\n-   --  Call Add_Lib_Search_Dir.\n-   --  Output one line when in verbose mode.\n+   --  Call Add_Lib_Search_Dir and output one line when in verbose mode\n \n    procedure Add_Object_Directories is\n      new Prj.Env.For_All_Object_Dirs (Action => Add_Object_Dir);\n@@ -187,9 +185,9 @@ package body Clean is\n    function Assembly_File_Name (Source : File_Name_Type) return String;\n    --  Returns the assembly file name corresponding to Source\n \n-   procedure Clean_Archive (Project : Project_Id);\n-   --  Delete a global archive or a fake library project archive and the\n-   --  dependency file, if they exist.\n+   procedure Clean_Archive (Project : Project_Id; Global : Boolean);\n+   --  Delete a global archive or library project archive and the dependency\n+   --  file, if they exist.\n \n    procedure Clean_Executables;\n    --  Do the cleaning work when no project file is specified\n@@ -199,14 +197,13 @@ package body Clean is\n    --  a source of the project.\n \n    procedure Clean_Library_Directory (Project : Project_Id);\n-   --  Delete the library file in a library directory and any ALI file\n-   --  of a source of the project in a library ALI directory.\n+   --  Delete the library file in a library directory and any ALI file of a\n+   --  source of the project in a library ALI directory.\n \n    procedure Clean_Project (Project : Project_Id);\n-   --  Do the cleaning work when a project file is specified.\n-   --  This procedure calls itself recursively when there are several\n-   --  project files in the tree rooted at the main project file and switch -r\n-   --  has been specified.\n+   --  Do the cleaning work when a project file is specified. This procedure\n+   --  calls itself recursively when there are several project files in the\n+   --  tree rooted at the main project file and switch -r has been specified.\n \n    function Debug_File_Name (Source : File_Name_Type) return String;\n    --  Name of the expanded source file corresponding to Source\n@@ -252,8 +249,8 @@ package body Clean is\n    --  not itself extended. Returns No_Project if Project is No_Project.\n \n    procedure Usage;\n-   --  Display the usage.\n-   --  If called several times, the usage is displayed only the first time.\n+   --  Display the usage. If called several times, the usage is displayed only\n+   --  the first time.\n \n    --------------------\n    -- Add_Object_Dir --\n@@ -337,19 +334,16 @@ package body Clean is\n    -- Clean_Archive --\n    -------------------\n \n-   procedure Clean_Archive (Project : Project_Id) is\n-      Current_Dir      : constant Dir_Name_Str := Get_Current_Dir;\n-      Data             : constant Project_Data :=\n-                           Project_Tree.Projects.Table (Project);\n-      Lib_Prefix       : constant String :=\n-                           \"lib\" & Get_Name_String (Data.Display_Name);\n+   procedure Clean_Archive (Project : Project_Id; Global : Boolean) is\n+      Current_Dir : constant Dir_Name_Str := Get_Current_Dir;\n+\n+      Data : constant Project_Data := Project_Tree.Projects.Table (Project);\n \n-      Archive_Name : constant String :=\n-                       Lib_Prefix & '.' & Archive_Ext;\n+      Lib_Prefix : String_Access;\n+      Archive_Name : String_Access;\n       --  The name of the archive file for this project\n \n-      Archive_Dep_Name : constant String :=\n-                           Lib_Prefix & \".deps\";\n+      Archive_Dep_Name : String_Access;\n       --  The name of the archive dependency file for this project\n \n       Obj_Dir : constant String :=\n@@ -358,12 +352,29 @@ package body Clean is\n    begin\n       Change_Dir (Obj_Dir);\n \n-      if Is_Regular_File (Archive_Name) then\n-         Delete (Obj_Dir, Archive_Name);\n+      --  First, get the lib prefix, the archive file name and the archive\n+      --  dependency file name.\n+\n+      if Global then\n+         Lib_Prefix :=\n+           new String'(\"lib\" & Get_Name_String (Data.Display_Name));\n+      else\n+         Lib_Prefix :=\n+           new String'(\"lib\" & Get_Name_String (Data.Library_Name));\n       end if;\n \n-      if Is_Regular_File (Archive_Dep_Name) then\n-         Delete (Obj_Dir, Archive_Dep_Name);\n+      Archive_Name := new String'(Lib_Prefix.all & '.' & Archive_Ext);\n+      Archive_Dep_Name := new String'(Lib_Prefix.all & \".deps\");\n+\n+      --  Delete the archive file and the archive dependency file, if they\n+      --  exist.\n+\n+      if Is_Regular_File (Archive_Name.all) then\n+         Delete (Obj_Dir, Archive_Name.all);\n+      end if;\n+\n+      if Is_Regular_File (Archive_Dep_Name.all) then\n+         Delete (Obj_Dir, Archive_Dep_Name.all);\n       end if;\n \n       Change_Dir (Current_Dir);\n@@ -620,6 +631,8 @@ package body Clean is\n    -- Clean_Library_Directory --\n    -----------------------------\n \n+   Empty_String : aliased String := \"\";\n+\n    procedure Clean_Library_Directory (Project : Project_Id) is\n       Current : constant String := Get_Current_Dir;\n       Data    : constant Project_Data := Project_Tree.Projects.Table (Project);\n@@ -636,8 +649,19 @@ package body Clean is\n \n       Delete_File : Boolean;\n \n+      Minor : String_Access := Empty_String'Unchecked_Access;\n+      Major : String_Access := Empty_String'Unchecked_Access;\n+\n    begin\n       if Data.Library then\n+         if Data.Library_Kind /= Static\n+           and then MLib.Tgt.Library_Major_Minor_Id_Supported\n+           and then Data.Lib_Internal_Name /= No_Name\n+         then\n+            Minor := new String'(Get_Name_String (Data.Lib_Internal_Name));\n+            Major := new String'(MLib.Major_Id_Name (DLL_Name, Minor.all));\n+         end if;\n+\n          declare\n             Lib_Directory     : constant String :=\n                                   Get_Name_String (Data.Display_Library_Dir);\n@@ -663,7 +687,9 @@ package body Clean is\n                declare\n                   Filename : constant String := Name (1 .. Last);\n                begin\n-                  if Is_Regular_File (Filename) then\n+                  if Is_Regular_File (Filename)\n+                    or else Is_Symbolic_Link (Filename)\n+                  then\n                      Canonical_Case_File_Name (Name (1 .. Last));\n                      Delete_File := False;\n \n@@ -672,14 +698,16 @@ package body Clean is\n                        or else\n                          ((Data.Library_Kind = Dynamic or else\n                              Data.Library_Kind = Relocatable)\n-                          and then Name (1 .. Last) = DLL_Name)\n+                          and then\n+                            (Name (1 .. Last) = DLL_Name\n+                             or else Name (1 .. Last) = Minor.all\n+                             or else Name (1 .. Last) = Major.all))\n                      then\n                         if not Do_Nothing then\n                            Set_Writable (Filename);\n                         end if;\n \n                         Delete (Lib_Directory, Filename);\n-                        exit;\n                      end if;\n                   end if;\n                end;\n@@ -852,7 +880,7 @@ package body Clean is\n                --  Source_Dirs or Source_Files is specified as an empty list,\n                --  so always look for Ada units in extending projects.\n \n-               if Data.Languages (Ada_Language_Index)\n+               if Data.Langs (Ada_Language_Index)\n                  or else Data.Extends /= No_Project\n                then\n                   for Unit in Unit_Table.First ..\n@@ -1011,7 +1039,7 @@ package body Clean is\n                   end loop;\n \n                   if Global_Archive then\n-                     Clean_Archive (Project);\n+                     Clean_Archive (Project, Global => True);\n                   end if;\n                end if;\n \n@@ -1044,9 +1072,9 @@ package body Clean is\n                   --  the fake archive and the dependency file, if they exist.\n \n                   if Data.Library\n-                    and then not Data.Languages (Ada_Language_Index)\n+                    and then not Data.Langs (Ada_Language_Index)\n                   then\n-                     Clean_Archive (Project);\n+                     Clean_Archive (Project, Global => False);\n                   end if;\n                end if;\n             end;\n@@ -1072,7 +1100,7 @@ package body Clean is\n             then\n                Delete_Binder_Generated_Files\n                  (Get_Name_String (Data.Display_Object_Dir),\n-                  Data.Library_Name);\n+                  File_Name_Type (Data.Library_Name));\n             end if;\n          end if;\n \n@@ -1226,6 +1254,7 @@ package body Clean is\n       else\n          if Force_Deletions\n            or else Is_Writable_File (Full_Name (1 .. Last))\n+           or else Is_Symbolic_Link (Full_Name (1 .. Last))\n          then\n             Delete_File (Full_Name (1 .. Last), Success);\n          else"}, {"sha": "ea4a258426d72385dec6292a03aac12d8738a5c5", "filename": "gcc/ada/fmap.adb", "status": "modified", "additions": 28, "deletions": 25, "changes": 53, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Ffmap.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Ffmap.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Ffmap.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -133,15 +133,26 @@ package body Fmap is\n       File_Name : File_Name_Type;\n       Path_Name : File_Name_Type)\n    is\n+      Unit_Entry : constant Int := Unit_Hash_Table.Get (Unit_Name);\n+      File_Entry : constant Int := File_Hash_Table.Get (File_Name);\n    begin\n-      File_Mapping.Increment_Last;\n-      Unit_Hash_Table.Set (Unit_Name, File_Mapping.Last);\n-      File_Mapping.Table (File_Mapping.Last) :=\n-        (Uname => Unit_Name, Fname => File_Name);\n-      Path_Mapping.Increment_Last;\n-      File_Hash_Table.Set (File_Name, Path_Mapping.Last);\n-      Path_Mapping.Table (Path_Mapping.Last) :=\n-        (Uname => Unit_Name, Fname => Path_Name);\n+      if Unit_Entry = No_Entry or else\n+        File_Mapping.Table (Unit_Entry).Fname /= File_Name\n+      then\n+         File_Mapping.Increment_Last;\n+         Unit_Hash_Table.Set (Unit_Name, File_Mapping.Last);\n+         File_Mapping.Table (File_Mapping.Last) :=\n+           (Uname => Unit_Name, Fname => File_Name);\n+      end if;\n+\n+      if File_Entry = No_Entry or else\n+        Path_Mapping.Table (File_Entry).Fname /= Path_Name\n+      then\n+         Path_Mapping.Increment_Last;\n+         File_Hash_Table.Set (File_Name, Path_Mapping.Last);\n+         Path_Mapping.Table (Path_Mapping.Last) :=\n+           (Uname => Unit_Name, Fname => Path_Name);\n+      end if;\n    end Add_To_File_Map;\n \n    ----------\n@@ -352,18 +363,6 @@ package body Fmap is\n             Name_Buffer (1 .. Name_Len) := SP (First .. Last);\n             Pname := Find_File_Name;\n \n-            --  Check for duplicate entries\n-\n-            if Unit_Hash_Table.Get (Uname) /= No_Entry then\n-               Empty_Tables;\n-               return;\n-            end if;\n-\n-            if File_Hash_Table.Get (Fname) /= No_Entry then\n-               Empty_Tables;\n-               return;\n-            end if;\n-\n             --  Add the mappings for this unit name\n \n             Add_To_File_Map (Uname, Fname, Pname);\n@@ -442,6 +441,8 @@ package body Fmap is\n       File    : File_Descriptor;\n       N_Bytes : Integer;\n \n+      File_Entry : Int;\n+\n       Status : Boolean;\n       --  For the call to Close\n \n@@ -509,13 +510,15 @@ package body Fmap is\n             for Unit in Last_In_Table + 1 .. File_Mapping.Last loop\n                Put_Line (Name_Id (File_Mapping.Table (Unit).Uname));\n                Put_Line (Name_Id (File_Mapping.Table (Unit).Fname));\n-               Put_Line (Name_Id (Path_Mapping.Table (Unit).Fname));\n+               File_Entry :=\n+                 File_Hash_Table.Get (File_Mapping.Table (Unit).Fname);\n+               Put_Line (Name_Id (Path_Mapping.Table (File_Entry).Fname));\n             end loop;\n \n-            --  Before closing the file, write the buffer to the file.\n-            --  It is guaranteed that the Buffer is not empty, because\n-            --  Put_Line has been called at least 3 times, and after\n-            --  a call to Put_Line, the Buffer is not empty.\n+            --  Before closing the file, write the buffer to the file. It is\n+            --  guaranteed that the Buffer is not empty, because Put_Line has\n+            --  been called at least 3 times, and after a call to Put_Line, the\n+            --  Buffer is not empty.\n \n             N_Bytes := Write (File, Buffer (1)'Address, Buffer_Last);\n "}, {"sha": "a9c9b152795e102f52a6e240b2f68037b0d3b928", "filename": "gcc/ada/gnatcmd.adb", "status": "modified", "additions": 47, "deletions": 24, "changes": 71, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fgnatcmd.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fgnatcmd.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgnatcmd.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -66,15 +66,16 @@ procedure GNATCmd is\n    --  Prefix of binder generated file, changed to b__ for VMS\n \n    Old_Project_File_Used : Boolean := False;\n-   --  This flag indicates a switch -p (for gnatxref and gnatfind) for an old\n-   --  fashioned project file. -p cannot be used in conjonction with -P.\n+   --  This flag indicates a switch -p (for gnatxref and gnatfind) for\n+   --  an old fashioned project file. -p cannot be used in conjonction\n+   --  with -P.\n \n    Max_Files_On_The_Command_Line : constant := 30; --  Arbitrary\n \n    Temp_File_Name : String_Access := null;\n    --  The name of the temporary text file to put a list of source/object\n-   --  files to pass to a tool, when the number of files exceeds the value of\n-   --  Max_Files_On_The_Command_Line.\n+   --  files to pass to a tool, when there are more than\n+   --  Max_Files_On_The_Command_Line files.\n \n    ASIS_Main : String_Access := null;\n    --  Main for commands Check, Metric and Pretty, when -U is used\n@@ -220,7 +221,7 @@ procedure GNATCmd is\n    --  exec directory. This procedure is only used for GNAT LINK when a project\n    --  file is specified.\n \n-   function Configuration_Pragmas_File return Name_Id;\n+   function Configuration_Pragmas_File return Path_Name_Type;\n    --  Return an argument, if there is a configuration pragmas file to be\n    --  specified for Project, otherwise return No_Name. Used for gnatstub (GNAT\n    --  STUB), gnatpp (GNAT PRETTY), gnatelim (GNAT ELIM), and gnatmetric (GNAT\n@@ -398,12 +399,12 @@ procedure GNATCmd is\n                      --  There is a body, check if it is for this project\n \n                      if All_Projects or else\n-                        Unit_Data.File_Names (Body_Part).Project =  Project\n+                        Unit_Data.File_Names (Body_Part).Project = Project\n                      then\n                         Subunit := False;\n \n-                        if Unit_Data.File_Names (Specification).Name =\n-                          No_File\n+                        if\n+                          Unit_Data.File_Names (Specification).Name = No_File\n                         then\n                            --  We have a body with no spec: we need to check if\n                            --  this is a subunit, because gnatls will complain\n@@ -687,11 +688,11 @@ procedure GNATCmd is\n    -- Configuration_Pragmas_File --\n    --------------------------------\n \n-   function Configuration_Pragmas_File return Name_Id is\n+   function Configuration_Pragmas_File return Path_Name_Type is\n    begin\n       Prj.Env.Create_Config_Pragmas_File\n         (Project, Project, Project_Tree, Include_Config_Files => False);\n-      return Name_Id (Project_Tree.Projects.Table (Project).Config_File_Name);\n+      return Project_Tree.Projects.Table (Project).Config_File_Name;\n    end Configuration_Pragmas_File;\n \n    ------------------------------\n@@ -776,7 +777,7 @@ procedure GNATCmd is\n       Last : Natural;\n \n       Udata : Unit_Data;\n-      Path  : File_Name_Type;\n+      Path  : Path_Name_Type;\n \n    begin\n       if GN_Path = null then\n@@ -832,7 +833,7 @@ procedure GNATCmd is\n \n          while not End_Of_File (File) loop\n             Get_Line (File, Line, Last);\n-            Path := No_File;\n+            Path := No_Path;\n \n             for Unit in Unit_Table.First ..\n                         Unit_Table.Last (Project_Tree.Units)\n@@ -859,7 +860,7 @@ procedure GNATCmd is\n \n             Last_Switches.Increment_Last;\n \n-            if Path /= No_File then\n+            if Path /= No_Path then\n                Last_Switches.Table (Last_Switches.Last) :=\n                   new String'(Get_Name_String (Path));\n \n@@ -917,7 +918,7 @@ procedure GNATCmd is\n \n       --  Check if there are library project files\n \n-      if MLib.Tgt.Support_For_Libraries /= MLib.Tgt.None then\n+      if MLib.Tgt.Support_For_Libraries /= None then\n          Set_Libraries (Project, Project_Tree, There_Are_Libraries);\n       end if;\n \n@@ -1354,6 +1355,8 @@ begin\n \n    VMS_Conv.Initialize;\n \n+   Set_Mode (Ada_Only);\n+\n    --  Add the directory where the GNAT driver is invoked in front of the path,\n    --  if the GNAT driver is invoked with directory information. Do not do this\n    --  for VMS, where the notion of path does not really exist.\n@@ -2023,10 +2026,10 @@ begin\n             end loop;\n \n             declare\n-               CP_File : constant Name_Id := Configuration_Pragmas_File;\n+               CP_File : constant Path_Name_Type := Configuration_Pragmas_File;\n \n             begin\n-               if CP_File /= No_Name then\n+               if CP_File /= No_Path then\n                   if The_Command = Elim then\n                      First_Switches.Increment_Last;\n                      First_Switches.Table (First_Switches.Last)  :=\n@@ -2093,8 +2096,8 @@ begin\n                --  indicate to gnatstub the name of the body file with\n                --  a -o switch.\n \n-               if Data.Naming.Ada_Spec_Suffix /=\n-                 Prj.Default_Ada_Spec_Suffix\n+               if Body_Suffix_Id_Of (Project_Tree, \"ada\", Data.Naming) /=\n+                    Prj.Default_Ada_Spec_Suffix\n                then\n                   if File_Index /= 0 then\n                      declare\n@@ -2103,14 +2106,18 @@ begin\n                         Last : Natural := Spec'Last;\n \n                      begin\n-                        Get_Name_String (Data.Naming.Ada_Spec_Suffix);\n+                        Get_Name_String\n+                          (Spec_Suffix_Id_Of\n+                             (Project_Tree, \"ada\", Data.Naming));\n \n                         if Spec'Length > Name_Len\n                           and then Spec (Last - Name_Len + 1 .. Last) =\n                           Name_Buffer (1 .. Name_Len)\n                         then\n                            Last := Last - Name_Len;\n-                           Get_Name_String (Data.Naming.Ada_Body_Suffix);\n+                           Get_Name_String\n+                             (Body_Suffix_Id_Of\n+                                (Project_Tree, \"ada\", Data.Naming));\n                            Last_Switches.Increment_Last;\n                            Last_Switches.Table (Last_Switches.Last) :=\n                              new String'(\"-o\");\n@@ -2218,6 +2225,17 @@ begin\n          if ASIS_Main /= null then\n             Get_Closure;\n \n+            --  On VMS, set up again the env var for source dirs file. This is\n+            --  because the call to gnatmake has set this env var to another\n+            --  file that has now been deleted.\n+\n+            if Hostparm.OpenVMS then\n+               Setenv\n+                 (Project_Include_Path_File,\n+                  Prj.Env.Ada_Include_Path\n+                    (Project, Project_Tree, Recursive => True));\n+            end if;\n+\n          --  For gnat check, gnat pretty, gnat metric, gnat list, and gnat\n          --  stack, if no file has been put on the command line, call tool\n          --  with all the sources of the main project.\n@@ -2298,13 +2316,18 @@ begin\n \n exception\n    when Error_Exit =>\n-      Prj.Env.Delete_All_Path_Files (Project_Tree);\n-      Delete_Temp_Config_Files;\n+      if not Keep_Temporary_Files then\n+         Prj.Env.Delete_All_Path_Files (Project_Tree);\n+         Delete_Temp_Config_Files;\n+      end if;\n+\n       Set_Exit_Status (Failure);\n \n    when Normal_Exit =>\n-      Prj.Env.Delete_All_Path_Files (Project_Tree);\n-      Delete_Temp_Config_Files;\n+      if not Keep_Temporary_Files then\n+         Prj.Env.Delete_All_Path_Files (Project_Tree);\n+         Delete_Temp_Config_Files;\n+      end if;\n \n       --  Since GNATCmd is normally called from DCL (the VMS shell), it must\n       --  return an understandable VMS exit status. However the exit status"}, {"sha": "2e040fa5b1bc490c062f84ebe1e47a296b8fccdf", "filename": "gcc/ada/gnatname.adb", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fgnatname.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fgnatname.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgnatname.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 2001-2006, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2001-2007, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -299,6 +299,8 @@ procedure Gnatname is\n --  Start of processing for Gnatname\n \n begin\n+   Prj.Set_Mode (Prj.Ada_Only);\n+\n    --  Add the directory where gnatname is invoked in front of the\n    --  path, if gnatname is invoked with directory information.\n    --  Only do this if the platform is not VMS, where the notion of path"}, {"sha": "4925fa10c9d5808d3db97f6d5c3bac800693e897", "filename": "gcc/ada/makegpr.adb", "status": "modified", "additions": 26, "deletions": 16, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmakegpr.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmakegpr.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmakegpr.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -1404,12 +1404,12 @@ package body Makegpr is\n       Source    : Other_Source;\n \n       Archive_Name : constant String :=\n-                       \"lib\" & Get_Name_String (Data.Display_Name)\n+                       \"lib\" & Get_Name_String (Data.Library_Name)\n                        & '.' & Archive_Ext;\n       --  The name of the archive file for this project\n \n       Archive_Dep_Name : constant String :=\n-                           \"lib\" & Get_Name_String (Data.Display_Name)\n+                           \"lib\" & Get_Name_String (Data.Library_Name)\n                            & \".deps\";\n       --  The name of the archive dependency file for this project\n \n@@ -1425,6 +1425,12 @@ package body Makegpr is\n       Lib_Opts    : Argument_List_Access := No_Argument'Access;\n \n    begin\n+      --  Nothing to do if the project is externally built\n+\n+      if Data.Externally_Built then\n+         return;\n+      end if;\n+\n       Check_Archive_Builder;\n \n       --  If Unconditionally is False, check if the archive need to be built\n@@ -1619,7 +1625,7 @@ package body Makegpr is\n          --  If there are sources in Ada, then gnatmake will build the library,\n          --  so nothing to do.\n \n-         if not Data.Languages (Ada_Language_Index) then\n+         if not Data.Langs (Ada_Language_Index) then\n \n             --  Get all the object files of the project\n \n@@ -1637,7 +1643,6 @@ package body Makegpr is\n             if Data.Library_Kind = Static then\n                MLib.Build_Library\n                  (Ofiles      => Arguments (1 .. Last_Argument),\n-                  Afiles      => No_Argument,\n                   Output_File => Get_Name_String (Data.Library_Name),\n                   Output_Dir  => Get_Name_String (Data.Display_Library_Dir));\n \n@@ -1698,10 +1703,7 @@ package body Makegpr is\n \n                MLib.Tgt.Build_Dynamic_Library\n                  (Ofiles       => Arguments (1 .. Last_Argument),\n-                  Foreign      => Arguments (1 .. Last_Argument),\n-                  Afiles       => No_Argument,\n-                  Options      => No_Argument,\n-                  Options_2    => Lib_Opts.all,\n+                  Options      => Lib_Opts.all,\n                   Interfaces   => No_Argument,\n                   Lib_Filename => Get_Name_String (Data.Library_Name),\n                   Lib_Dir      => Get_Name_String (Data.Library_Dir),\n@@ -1817,6 +1819,7 @@ package body Makegpr is\n       Source_Name   : constant String := Get_Name_String (Source.File_Name);\n       Source_Path   : constant String := Get_Name_String (Source.Path_Name);\n       Object_Name   : constant String := Get_Name_String (Source.Object_Name);\n+      C_Object_Name : String := Object_Name;\n       Dep_Name      : constant String := Get_Name_String (Source.Dep_Name);\n       C_Source_Path : String := Source_Path;\n \n@@ -1832,6 +1835,7 @@ package body Makegpr is\n \n    begin\n       Canonical_Case_File_Name (C_Source_Path);\n+      Canonical_Case_File_Name (C_Object_Name);\n \n       --  Assume the worst, so that statement \"return;\" may be used if there\n       --  is any problem.\n@@ -1957,10 +1961,14 @@ package body Makegpr is\n          Start  := 1;\n          Finish := Index (Name_Buffer (1 .. Name_Len), \": \");\n \n+         if Finish /= 0 then\n+            Canonical_Case_File_Name (Name_Buffer (1 .. Finish - 1));\n+         end if;\n+\n          --  First line must start with name of object file, followed by colon\n \n          if Finish = 0 or else\n-            Name_Buffer (1 .. Finish - 1) /= Object_Name\n+            Name_Buffer (1 .. Finish - 1) /= C_Object_Name\n          then\n             if Verbose_Mode then\n                Write_Str  (\"      -> dependency file \");\n@@ -2155,7 +2163,7 @@ package body Makegpr is\n                      Project_Table.Last (Project_Tree.Projects)\n       loop\n          if\n-           Project_Tree.Projects.Table (Project).Languages\n+           Project_Tree.Projects.Table (Project).Langs\n                                            (C_Plus_Plus_Language_Index)\n          then\n             C_Plus_Plus_Is_Used := True;\n@@ -2430,7 +2438,7 @@ package body Makegpr is\n       Dummy        : Boolean := False;\n \n       Ada_Is_A_Language : constant Boolean :=\n-                            Data.Languages (Ada_Language_Index);\n+                            Data.Langs (Ada_Language_Index);\n \n    begin\n       Ada_Mains.Init;\n@@ -2814,7 +2822,7 @@ package body Makegpr is\n \n             if not Local_Errors\n               and then Data.Library\n-              and then not Data.Languages (Ada_Language_Index)\n+              and then not Data.Langs (Ada_Language_Index)\n               and then not Compile_Only\n             then\n                Build_Library (Project, Need_To_Rebuild_Archive);\n@@ -3349,6 +3357,8 @@ package body Makegpr is\n \n    procedure Initialize is\n    begin\n+      Set_Mode (Ada_Only);\n+\n       --  Do some necessary package initializations\n \n       Csets.Initialize;\n@@ -3795,7 +3805,7 @@ package body Makegpr is\n \n          --  Only Ada sources in the main project, and even maybe not\n \n-         if not Data.Languages (Ada_Language_Index) then\n+         if not Data.Langs (Ada_Language_Index) then\n \n             --  Fail if the main project has no source of any language\n \n@@ -3825,7 +3835,7 @@ package body Makegpr is\n          --  There are other language sources. First check if there are also\n          --  sources in Ada.\n \n-         if Data.Languages (Ada_Language_Index) then\n+         if Data.Langs (Ada_Language_Index) then\n \n             --  There is a mix of Ada and other language sources in the main\n             --  project. Any main that is not a source of the other languages\n@@ -3953,7 +3963,7 @@ package body Makegpr is\n                --  If C++ is one of the languages, add the --LINK switch to\n                --  the linking switches.\n \n-               if Data.Languages (C_Plus_Plus_Language_Index) then\n+               if Data.Langs (C_Plus_Plus_Language_Index) then\n                   Add_Argument (Dash_largs, Verbose_Mode);\n                   Add_C_Plus_Plus_Link_For_Gnatmake;\n                   Add_Argument (Dash_margs, Verbose_Mode);\n@@ -3969,7 +3979,7 @@ package body Makegpr is\n \n             --  First, get the linker to invoke\n \n-            if Data.Languages (C_Plus_Plus_Language_Index) then\n+            if Data.Langs (C_Plus_Plus_Language_Index) then\n                Get_Compiler (C_Plus_Plus_Language_Index);\n                Linker_Name := Compiler_Names (C_Plus_Plus_Language_Index);\n                Linker_Path := Compiler_Paths (C_Plus_Plus_Language_Index);"}, {"sha": "af1326cc6c5f8058b11b15051e883663a24507c7", "filename": "gcc/ada/makeutl.adb", "status": "modified", "additions": 92, "deletions": 2, "changes": 94, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmakeutl.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmakeutl.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmakeutl.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -24,9 +24,9 @@\n --                                                                          --\n ------------------------------------------------------------------------------\n \n-with Ada.Command_Line; use Ada.Command_Line;\n-\n+with Ada.Command_Line;  use Ada.Command_Line;\n with Osint;    use Osint;\n+with Output;   use Output;\n with Prj.Ext;\n with Prj.Util;\n with Snames;   use Snames;\n@@ -83,6 +83,46 @@ package body Makeutl is\n \n    procedure Add_Linker_Option (Option : String);\n \n+   ---------\n+   -- Add --\n+   ---------\n+\n+   procedure Add\n+     (Option : String_Access;\n+      To     : in out String_List_Access;\n+      Last   : in out Natural)\n+   is\n+   begin\n+      if Last = To'Last then\n+         declare\n+            New_Options : constant String_List_Access :=\n+                            new String_List (1 .. To'Last * 2);\n+         begin\n+            New_Options (To'Range) := To.all;\n+\n+            --  Set all elements of the original options to null to avoid\n+            --  deallocation of copies.\n+\n+            To.all := (others => null);\n+\n+            Free (To);\n+            To := New_Options;\n+         end;\n+      end if;\n+\n+      Last := Last + 1;\n+      To (Last) := Option;\n+   end Add;\n+\n+   procedure Add\n+     (Option : String;\n+      To     : in out String_List_Access;\n+      Last   : in out Natural)\n+   is\n+   begin\n+      Add (Option => new String'(Option), To => To, Last => Last);\n+   end Add;\n+\n    -----------------------\n    -- Add_Linker_Option --\n    -----------------------\n@@ -110,6 +150,31 @@ package body Makeutl is\n       end if;\n    end Add_Linker_Option;\n \n+   -----------------\n+   -- Create_Name --\n+   -----------------\n+\n+   function Create_Name (Name : String) return File_Name_Type is\n+   begin\n+      Name_Len := 0;\n+      Add_Str_To_Name_Buffer (Name);\n+      return Name_Find;\n+   end Create_Name;\n+\n+   function Create_Name (Name : String) return Name_Id is\n+   begin\n+      Name_Len := 0;\n+      Add_Str_To_Name_Buffer (Name);\n+      return Name_Find;\n+   end Create_Name;\n+\n+   function Create_Name (Name : String) return Path_Name_Type is\n+   begin\n+      Name_Len := 0;\n+      Add_Str_To_Name_Buffer (Name);\n+      return Name_Find;\n+   end Create_Name;\n+\n    ----------------------\n    -- Delete_All_Marks --\n    ----------------------\n@@ -190,6 +255,31 @@ package body Makeutl is\n       return Union_Id (Key.File) mod Max_Mask_Num;\n    end Hash;\n \n+   ------------\n+   -- Inform --\n+   ------------\n+\n+   procedure Inform (N : File_Name_Type; Msg : String) is\n+   begin\n+      Inform (Name_Id (N), Msg);\n+   end Inform;\n+\n+   procedure Inform (N : Name_Id := No_Name; Msg : String) is\n+   begin\n+      Osint.Write_Program_Name;\n+\n+      Write_Str (\": \");\n+\n+      if N /= No_Name then\n+         Write_Str (\"\"\"\");\n+         Write_Name (N);\n+         Write_Str (\"\"\" \");\n+      end if;\n+\n+      Write_Str (Msg);\n+      Write_Eol;\n+   end Inform;\n+\n    ----------------------------\n    -- Is_External_Assignment --\n    ----------------------------"}, {"sha": "29a389512e01ba0802e01c2c4c76c8c04a96d82f", "filename": "gcc/ada/makeutl.ads", "status": "modified", "additions": 31, "deletions": 5, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmakeutl.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmakeutl.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmakeutl.ads?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -38,17 +38,39 @@ package Makeutl is\n       S2 : String := \"\";\n       S3 : String := \"\");\n    Do_Fail : Fail_Proc := Osint.Fail'Access;\n-   --  Comment required ???\n-\n-   function Unit_Index_Of (ALI_File : File_Name_Type) return Int;\n-   --  Find the index of a unit in a source file. Return zero if the file\n-   --  is not a multi-unit source file.\n+   --  Failing procedure called from procedure Test_If_Relative_Path below.\n+   --  May be redirected.\n+\n+   Project_Tree : constant Project_Tree_Ref := new Project_Tree_Data;\n+   --  The project tree\n+\n+   Main_Config_Project : Project_Id;\n+   --  The project id of the main configuration project\n+\n+   procedure Add\n+     (Option : String_Access;\n+      To     : in out String_List_Access;\n+      Last   : in out Natural);\n+   procedure Add\n+     (Option : String;\n+      To     : in out String_List_Access;\n+      Last   : in out Natural);\n+   --  Add a string to a list of strings\n+\n+   function Create_Name (Name : String) return File_Name_Type;\n+   function Create_Name (Name : String) return Name_Id;\n+   function Create_Name (Name : String) return Path_Name_Type;\n+   --  Get the Name_Id of a name\n \n    function Executable_Prefix_Path return String;\n    --  Return the absolute path parent directory of the directory where the\n    --  current executable resides, if its directory is named \"bin\", otherwise\n    --  return an empty string.\n \n+   procedure Inform (N : Name_Id := No_Name; Msg : String);\n+   procedure Inform (N : File_Name_Type; Msg : String);\n+   --  Prints out the program name followed by a colon, N and S\n+\n    function Is_External_Assignment (Argv : String) return Boolean;\n    --  Verify that an external assignment switch is syntactically correct\n    --\n@@ -73,6 +95,10 @@ package Makeutl is\n    --  and to retrieve them when a project file is used, to verify that the\n    --  files exist and that they belong to a project file.\n \n+   function Unit_Index_Of (ALI_File : File_Name_Type) return Int;\n+   --  Find the index of a unit in a source file. Return zero if the file\n+   --  is not a multi-unit source file.\n+\n    package Mains is\n \n       --  Mains are stored in a table. An index is used to retrieve the mains"}, {"sha": "8aeb853e31fcbedc774f9cbbec66714bb109439b", "filename": "gcc/ada/mlib-prj.adb", "status": "modified", "additions": 197, "deletions": 150, "changes": 347, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-prj.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-prj.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-prj.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -2,7 +2,7 @@\n --                                                                          --\n --                         GNAT COMPILER COMPONENTS                         --\n --                                                                          --\n---                             M L I B . P R J                              --\n+--                            M L I B . P R J                               --\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n@@ -46,7 +46,6 @@ with Ada.Characters.Handling;\n \n with GNAT.Directory_Operations; use GNAT.Directory_Operations;\n with GNAT.HTable;\n-\n with Interfaces.C_Streams;      use Interfaces.C_Streams;\n with System;                    use System;\n with System.Case_Util;          use System.Case_Util;\n@@ -74,9 +73,6 @@ package body MLib.Prj is\n    G_Trasym_Ads : File_Name_Type := No_File;\n    --  Name_Id for \"g-trasym.ads\"\n \n-   No_Argument_List : aliased String_List := (1 .. 0 => null);\n-   No_Argument      : constant String_List_Access := No_Argument_List'Access;\n-\n    Arguments : String_List_Access := No_Argument;\n    --  Used to accumulate arguments for the invocation of gnatbind and of\n    --  the compiler. Also used to collect the interface ALI when copying\n@@ -118,18 +114,6 @@ package body MLib.Prj is\n       Hash       => Hash,\n       Equal      => \"=\");\n \n-   --  List of non-Ada object files\n-\n-   Foreign_Objects : Argument_List_Access;\n-\n-   package Foreigns is new Table.Table\n-     (Table_Name           => \"Mlib.Prj.Foreigns\",\n-      Table_Component_Type => String_Access,\n-      Table_Index_Type     => Natural,\n-      Table_Low_Bound      => 1,\n-      Table_Initial        => 20,\n-      Table_Increment      => 100);\n-\n    --  List of ALI files\n \n    Ali_Files : Argument_List_Access;\n@@ -240,7 +224,7 @@ package body MLib.Prj is\n \n    procedure Reset_Tables;\n    --  Make sure that all the above tables are empty\n-   --  (Objects, ALIs, Options, ...).\n+   --  (Objects, Ali_Files, Options).\n \n    function SALs_Use_Constructors return Boolean;\n    --  Indicate if Stand-Alone Libraries are automatically initialized using\n@@ -326,10 +310,6 @@ package body MLib.Prj is\n       --  Set to True for the first warning about a unit missing from the\n       --  interface set.\n \n-      Gtrasymobj_Needed : Boolean := False;\n-      --  On OpenVMS, set to True if library needs to be linked with\n-      --  g-trasym.obj.\n-\n       Data : Project_Data := In_Tree.Projects.Table (For_Project);\n \n       Libgnarl_Needed   : Yes_No_Unknown := Data.Libgnarl_Needed;\n@@ -338,8 +318,12 @@ package body MLib.Prj is\n       Libdecgnat_Needed : Boolean := False;\n       --  On OpenVMS, set to True if library needs to be linked with libdecgnat\n \n+      Gtrasymobj_Needed : Boolean := False;\n+      --  On OpenVMS, set to True if library needs to be linked with\n+      --  g-trasym.obj.\n+\n       Object_Directory_Path : constant String :=\n-                                Get_Name_String (Data.Display_Object_Dir);\n+                          Get_Name_String (Data.Display_Object_Dir);\n \n       Standalone   : constant Boolean := Data.Standalone_Library;\n \n@@ -362,6 +346,8 @@ package body MLib.Prj is\n \n       In_Main_Object_Directory : Boolean := True;\n \n+      There_Are_Foreign_Sources : Boolean;\n+\n       Rpath : String_Access := null;\n       --  Allocated only if Path Option is supported\n \n@@ -379,7 +365,8 @@ package body MLib.Prj is\n       --  Store the ALI file name of a source of the library (the first found)\n \n       procedure Add_ALI_For (Source : File_Name_Type);\n-      --  Add the name of the ALI file corresponding to Source to the arguments\n+      --  Add the name of the ALI file corresponding to Source to the\n+      --  Arguments.\n \n       procedure Add_Rpath (Path : String);\n       --  Add a path name to Rpath\n@@ -553,7 +540,7 @@ package body MLib.Prj is\n                          ALI.ALIs.Table (Id).Last_Sdep\n             loop\n                if ALI.Sdep.Table (Index).Sfile = S_Osinte_Ads then\n-                  Libgnarl_Needed      := Yes;\n+                  Libgnarl_Needed := Yes;\n \n                   if Main_Project then\n                      In_Tree.Projects.Table (For_Project).Libgnarl_Needed :=\n@@ -806,10 +793,8 @@ package body MLib.Prj is\n          Process_Project (For_Project);\n \n          --  Add the -L and -l switches and, if the Rpath option is supported,\n-         --  add the directory to the Rpath.\n-\n-         --  As the library projects are in the wrong order, process from the\n-         --  last to the first.\n+         --  add the directory to the Rpath. As the library projects are in the\n+         --  wrong order, process from the last to the first.\n \n          for Index in reverse 1 .. Library_Projs.Last loop\n             Current := Library_Projs.Table (Index);\n@@ -846,7 +831,7 @@ package body MLib.Prj is\n       end if;\n \n       --  If this is the first time Build_Library is called, get the Name_Id\n-      --  values of \"s-osinte.ads\", \"dec.ads\", and \"g-trasym.ads\".\n+      --  of \"s-osinte.ads\".\n \n       if S_Osinte_Ads = No_File then\n          Name_Len := 0;\n@@ -988,12 +973,13 @@ package body MLib.Prj is\n                         begin\n                            Src_Ind := Sinput.P.Load_Project_File\n                              (Get_Name_String\n-                                (Unit.File_Names (Body_Part).Path));\n+                                (Unit.File_Names\n+                                   (Body_Part).Path));\n \n                            --  Add the ALI file only if it is not a subunit\n \n-                           if\n-                             not Sinput.P.Source_File_Is_Subunit (Src_Ind)\n+                           if not\n+                             Sinput.P.Source_File_Is_Subunit (Src_Ind)\n                            then\n                               Add_ALI_For\n                                 (Unit.File_Names (Body_Part).Name);\n@@ -1075,8 +1061,6 @@ package body MLib.Prj is\n \n             Display (Gnatbind);\n \n-            --  Check the size of the arguments\n-\n             Size := 0;\n             for J in 1 .. Argument_Number loop\n                Size := Size + Arguments (J)'Length + 1;\n@@ -1240,8 +1224,8 @@ package body MLib.Prj is\n \n                   --  Read it\n \n-                  A := Scan_ALI\n-                         (First_ALI, T, Ignore_ED => False, Err => False);\n+                  A :=\n+                    Scan_ALI (First_ALI, T, Ignore_ED => False, Err => False);\n \n                   if A /= No_ALI_Id then\n                      for Index in\n@@ -1272,7 +1256,7 @@ package body MLib.Prj is\n             --  generated file.\n \n             Display (Gcc);\n-            GNAT.OS_Lib.Spawn\n+            Spawn\n               (Gcc_Path.all, Arguments (1 .. Argument_Number), Success);\n \n             if not Success then\n@@ -1290,6 +1274,7 @@ package body MLib.Prj is\n       --  Build the library only if Link is True\n \n       if Link then\n+\n          --  If attribute Library_GCC was specified, get the driver name\n \n          Library_GCC :=\n@@ -1307,13 +1292,13 @@ package body MLib.Prj is\n \n          if not Library_Options.Default then\n             declare\n-               Current : String_List_Id := Library_Options.Values;\n+               Current : String_List_Id;\n                Element : String_Element;\n \n             begin\n+               Current := Library_Options.Values;\n                while Current /= Nil_String loop\n-                  Element :=\n-                    In_Tree.String_Elements.Table (Current);\n+                  Element := In_Tree.String_Elements.Table (Current);\n                   Get_Name_String (Element.Value);\n \n                   if Name_Len /= 0 then\n@@ -1327,10 +1312,9 @@ package body MLib.Prj is\n             end;\n          end if;\n \n-         Lib_Dirpath :=\n+         Lib_Dirpath  :=\n            new String'(Get_Name_String (Data.Display_Library_Dir));\n-         Lib_Filename :=\n-           new String'(Get_Name_String (Data.Library_Name));\n+         Lib_Filename := new String'(Get_Name_String (Data.Library_Name));\n \n          case Data.Library_Kind is\n             when Static =>\n@@ -1350,20 +1334,21 @@ package body MLib.Prj is\n \n          --  Get the library version, if any\n \n-         if Data.Lib_Internal_Name /= No_File then\n+         if Data.Lib_Internal_Name /= No_Name then\n             Lib_Version :=\n               new String'(Get_Name_String (Data.Lib_Internal_Name));\n          end if;\n \n          --  Add the objects found in the object directory and the object\n          --  directories of the extended files, if any, except for generated\n          --  object files (b~.. or B__..) from extended projects.\n-\n          --  When there are one or more extended files, only add an object file\n          --  if no object file with the same name have already been added.\n \n          In_Main_Object_Directory := True;\n \n+         There_Are_Foreign_Sources := Data.Other_Sources_Present;\n+\n          loop\n             declare\n                Object_Dir_Path : constant String :=\n@@ -1404,47 +1389,120 @@ package body MLib.Prj is\n                         if In_Main_Object_Directory\n                           or else Last < 5\n                           or else C_Filename (1 .. B_Start'Length) /=\n-                            B_Start.all\n+                                    B_Start.all\n                         then\n                            Name_Len := Last;\n                            Name_Buffer (1 .. Name_Len) :=\n                              C_Filename (1 .. Last);\n                            Id := Name_Find;\n \n                            if not Objects_Htable.Get (Id) then\n-\n-                              --  Record this object file\n-\n-                              Objects_Htable.Set (Id, True);\n-                              Objects.Increment_Last;\n-                              Objects.Table (Objects.Last) :=\n-                                new String'(Object_Path);\n-\n                               declare\n                                  ALI_File : constant String :=\n+                                              Ext_To\n+                                                (Filename (1 .. Last), \"ali\");\n+                                 ALI_Path : constant String :=\n                                               Ext_To (Object_Path, \"ali\");\n+                                 Add_It   : Boolean :=\n+                                              There_Are_Foreign_Sources\n+                                              or else\n+                                                (Last > 5\n+                                                 and then\n+                                                 C_Filename\n+                                                   (1 .. B_Start'Length) =\n+                                                 B_Start.all);\n+                                 Fname    : File_Name_Type;\n+                                 Proj     : Project_Id;\n \n                               begin\n-                                 if Is_Regular_File (ALI_File) then\n+                                 if Is_Regular_File (ALI_Path) then\n+\n+                                    --  If there is an ALI file, check if the\n+                                    --  object file should be added to the\n+                                    --  library. If there are foreign sources\n+                                    --  we put all object files in the library.\n+\n+                                    if not Add_It then\n+                                       for Index in\n+                                         1 .. Unit_Table.Last (In_Tree.Units)\n+                                       loop\n+                                          if In_Tree.Units.Table\n+                                            (Index).File_Names\n+                                              (Body_Part).Name /= No_File\n+                                          then\n+                                             Proj :=\n+                                               In_Tree.Units.Table (Index).\n+                                                 File_Names\n+                                                   (Body_Part).Project;\n+                                             Fname :=\n+                                               In_Tree.Units.Table (Index).\n+                                                 File_Names (Body_Part).Name;\n+\n+                                          elsif\n+                                            In_Tree.Units.Table\n+                                              (Index).File_Names\n+                                                (Specification).Name /= No_File\n+                                          then\n+                                             Proj :=\n+                                               In_Tree.Units.Table\n+                                                 (Index).File_Names\n+                                                   (Specification).Project;\n+                                             Fname :=\n+                                               In_Tree.Units.Table\n+                                                 (Index).File_Names\n+                                                   (Specification).Name;\n+\n+                                          else\n+                                             Proj := No_Project;\n+                                          end if;\n+\n+                                          Add_It := Proj /= No_Project;\n+\n+                                          --  If the source is in the project\n+                                          --  or a project it extends, we may\n+                                          --  put it in the library.\n+\n+                                          if Add_It then\n+                                             Add_It := Check_Project (Proj);\n+                                          end if;\n+\n+                                          --  But we don't, if the ALI file\n+                                          --  does not correspond to the unit.\n+\n+                                          if Add_It then\n+                                             declare\n+                                                F : constant String :=\n+                                                      Ext_To\n+                                                        (Get_Name_String\n+                                                           (Fname), \"ali\");\n+                                             begin\n+                                                Add_It := F = ALI_File;\n+                                             end;\n+                                          end if;\n+\n+                                          exit when Add_It;\n+                                       end loop;\n+                                    end if;\n \n-                                    --  Record the ALI file\n+                                    if Add_It then\n+                                       Objects_Htable.Set (Id, True);\n+                                       Objects.Append\n+                                         (new String'(Object_Path));\n \n-                                    ALIs.Increment_Last;\n-                                    ALIs.Table (ALIs.Last) :=\n-                                      new String'(ALI_File);\n+                                       --  Record the ALI file\n \n-                                    --  Find out if for this ALI file, libgnarl\n-                                    --  or libdecgnat or g-trasym.obj (on\n-                                    --  OpenVMS) is necessary.\n+                                       ALIs.Append (new String'(ALI_Path));\n \n-                                    Check_Libs (ALI_File, True);\n+                                       --  Find out if for this ALI file,\n+                                       --  libgnarl or libdecgnat or\n+                                       --  g-trasym.obj (on OpenVMS) is\n+                                       --  necessary.\n \n-                                 else\n-                                    --  Object file is a foreign object file\n+                                       Check_Libs (ALI_Path, True);\n+                                    end if;\n \n-                                    Foreigns.Increment_Last;\n-                                    Foreigns.Table (Foreigns.Last) :=\n-                                      new String'(Object_Path);\n+                                 elsif There_Are_Foreign_Sources then\n+                                    Objects.Append (new String'(Object_Path));\n                                  end if;\n                               end;\n                            end if;\n@@ -1518,9 +1576,6 @@ package body MLib.Prj is\n             else\n                Opts.Table (Opts.Last) := new String'(Shared_Lib (\"gnarl\"));\n             end if;\n-\n-         else\n-            In_Tree.Projects.Table (For_Project).Libgnarl_Needed := No;\n          end if;\n \n          if Gtrasymobj_Needed then\n@@ -1568,18 +1623,14 @@ package body MLib.Prj is\n            new Argument_List'\n              (Argument_List (Objects.Table (1 .. Objects.Last)));\n \n-         Foreign_Objects :=\n-           new Argument_List'(Argument_List\n-                                (Foreigns.Table (1 .. Foreigns.Last)));\n-\n          Ali_Files :=\n            new Argument_List'(Argument_List (ALIs.Table (1 .. ALIs.Last)));\n \n          Options :=\n            new Argument_List'(Argument_List (Opts.Table (1 .. Opts.Last)));\n \n-         --  We fail if there are no object to put in the library (Ada or\n-         --  foreign objects).\n+         --  We fail if there are no object to put in the library\n+         --  (Ada or foreign objects).\n \n          if Object_Files'Length = 0 then\n             Com.Fail (\"no object files for library \"\"\" &\n@@ -1682,11 +1733,10 @@ package body MLib.Prj is\n             Data := In_Tree.Projects.Table (For_Project);\n \n             declare\n-               Iface : String_List_Id;\n+               Iface : String_List_Id := Data.Lib_Interface_ALIs;\n                ALI   : File_Name_Type;\n \n             begin\n-               Iface := Data.Lib_Interface_ALIs;\n                while Iface /= Nil_String loop\n                   ALI :=\n                     File_Name_Type\n@@ -1719,15 +1769,20 @@ package body MLib.Prj is\n \n          declare\n             Current_Dir  : constant String := Get_Current_Dir;\n-            DLL_Name     : aliased constant String :=\n-                             Lib_Filename.all & \".\" & DLL_Ext;\n+            Dir          : Dir_Type;\n+\n+            Name : String (1 .. 200);\n+            Last : Natural;\n+\n+            Disregard : Boolean;\n+\n+            DLL_Name : aliased constant String :=\n+                         Lib_Filename.all & \".\" & DLL_Ext;\n+\n             Archive_Name : aliased constant String :=\n                              Lib_Filename.all & \".\" & Archive_Ext;\n-            Dir          : Dir_Type;\n-            Name         : String (1 .. 200);\n-            Last         : Natural;\n-            Disregard    : Boolean;\n-            Delete       : Boolean := False;\n+\n+            Delete : Boolean := False;\n \n          begin\n             --  Clean the library directory: remove any file with the name of\n@@ -1810,7 +1865,8 @@ package body MLib.Prj is\n                               then\n                                  Get_Name_String\n                                    (Unit.File_Names (Specification).Name);\n-                                 Name_Len := Name_Len -\n+                                 Name_Len :=\n+                                   Name_Len -\n                                    File_Extension\n                                      (Name (1 .. Name_Len))'Length;\n \n@@ -1844,10 +1900,7 @@ package body MLib.Prj is\n             when Dynamic | Relocatable =>\n                Build_Dynamic_Library\n                  (Ofiles        => Object_Files.all,\n-                  Foreign       => Foreign_Objects.all,\n-                  Afiles        => Ali_Files.all,\n                   Options       => Options.all,\n-                  Options_2     => No_Argument_List,\n                   Interfaces    => Arguments (1 .. Argument_Number),\n                   Lib_Filename  => Lib_Filename.all,\n                   Lib_Dir       => Lib_Dirpath.all,\n@@ -1859,27 +1912,25 @@ package body MLib.Prj is\n             when Static =>\n                MLib.Build_Library\n                  (Object_Files.all,\n-                  Ali_Files.all,\n                   Lib_Filename.all,\n                   Lib_Dirpath.all);\n \n             when None =>\n                null;\n          end case;\n \n-         --  We need to copy the ALI files from the object directory to\n-         --  the library ALI directory, so that the linker find them there,\n-         --  and does not need to look in the object directory where it\n-         --  would also find the object files; and we don't want that:\n-         --  we want the linker to use the library.\n+         --  We need to copy the ALI files from the object directory to the\n+         --  library ALI directory, so that the linker find them there, and\n+         --  does not need to look in the object directory where it would also\n+         --  find the object files; and we don't want that: we want the linker\n+         --  to use the library.\n \n          --  Copy the ALI files and make the copies read-only. For interfaces,\n          --  mark the copies as interfaces.\n \n          Copy_ALI_Files\n            (Files      => Ali_Files.all,\n-            To         => In_Tree.Projects.Table\n-                            (For_Project).Display_Library_ALI_Dir,\n+            To         => In_Tree.Projects.Table (For_Project).Library_ALI_Dir,\n             Interfaces => Arguments (1 .. Argument_Number));\n \n          --  Copy interface sources if Library_Src_Dir specified\n@@ -1905,11 +1956,13 @@ package body MLib.Prj is\n             end;\n \n             declare\n-               Dir       : Dir_Type;\n-               Delete    : Boolean := False;\n-               Unit      : Unit_Data;\n-               Name      : String (1 .. 200);\n-               Last      : Natural;\n+               Dir    : Dir_Type;\n+               Delete : Boolean := False;\n+               Unit   : Unit_Data;\n+\n+               Name : String (1 .. 200);\n+               Last : Natural;\n+\n                Disregard : Boolean;\n \n             begin\n@@ -1919,50 +1972,45 @@ package body MLib.Prj is\n                   Read (Dir, Name, Last);\n                   exit when Last = 0;\n \n-                  declare\n-                     Filename : constant String := Name (1 .. Last);\n+                  if Is_Regular_File (Name (1 .. Last)) then\n+                     Canonical_Case_File_Name (Name (1 .. Last));\n+                     Delete := False;\n \n-                  begin\n-                     if Is_Regular_File (Filename) then\n-                        Canonical_Case_File_Name (Name (1 .. Last));\n-                        Delete := False;\n-\n-                        --  Compare with source file names of the project\n-\n-                        for Index in 1 .. Unit_Table.Last (In_Tree.Units) loop\n-                           Unit := In_Tree.Units.Table (Index);\n-\n-                           if Ultimate_Extension_Of\n-                             (Unit.File_Names (Body_Part).Project, In_Tree) =\n-                             For_Project\n-                             and then\n-                               Get_Name_String\n-                                 (Unit.File_Names (Body_Part).Name) =\n-                             Name (1 .. Last)\n-                           then\n-                              Delete := True;\n-                              exit;\n-                           end if;\n+                     --  Compare with source file names of the project\n \n-                           if Ultimate_Extension_Of\n-                             (Unit.File_Names\n-                                (Specification).Project, In_Tree) = For_Project\n-                             and then\n-                               Get_Name_String\n-                                 (Unit.File_Names (Specification).Name) =\n-                                                              Name (1 .. Last)\n-                           then\n-                              Delete := True;\n-                              exit;\n-                           end if;\n-                        end loop;\n-                     end if;\n+                     for Index in 1 .. Unit_Table.Last (In_Tree.Units) loop\n+                        Unit := In_Tree.Units.Table (Index);\n \n-                     if Delete then\n-                        Set_Writable (Filename);\n-                        Delete_File (Filename, Disregard);\n-                     end if;\n-                  end;\n+                        if Ultimate_Extension_Of\n+                            (Unit.File_Names (Body_Part).Project, In_Tree) =\n+                            For_Project\n+                          and then\n+                            Get_Name_String\n+                              (Unit.File_Names (Body_Part).Name) =\n+                            Name (1 .. Last)\n+                        then\n+                           Delete := True;\n+                           exit;\n+                        end if;\n+\n+                        if Ultimate_Extension_Of\n+                           (Unit.File_Names (Specification).Project, In_Tree) =\n+                           For_Project\n+                          and then\n+                           Get_Name_String\n+                             (Unit.File_Names (Specification).Name) =\n+                           Name (1 .. Last)\n+                        then\n+                           Delete := True;\n+                           exit;\n+                        end if;\n+                     end loop;\n+                  end if;\n+\n+                  if Delete then\n+                     Set_Writable (Name (1 .. Last));\n+                     Delete_File (Name (1 .. Last), Disregard);\n+                  end if;\n                end loop;\n \n                Close (Dir);\n@@ -2011,8 +2059,7 @@ package body MLib.Prj is\n    -------------------\n \n    procedure Check_Library\n-     (For_Project : Project_Id;\n-      In_Tree     : Project_Tree_Ref)\n+     (For_Project : Project_Id; In_Tree : Project_Tree_Ref)\n    is\n       Data    : constant Project_Data :=\n                   In_Tree.Projects.Table (For_Project);\n@@ -2026,7 +2073,7 @@ package body MLib.Prj is\n       if Data.Library then\n          declare\n             Lib_Name : constant File_Name_Type :=\n-                         Library_File_Name_For (For_Project, In_Tree);\n+              Library_File_Name_For (For_Project, In_Tree);\n          begin\n             Change_Dir (Get_Name_String (Data.Library_Dir));\n             Lib_TS := File_Stamp (Lib_Name);\n@@ -2171,9 +2218,10 @@ package body MLib.Prj is\n         (Extending : Project_Id;\n          Extended  : Project_Id) return Boolean\n       is\n-         Ext : Project_Id := Extending;\n+         Ext : Project_Id;\n \n       begin\n+         Ext := Extending;\n          while Ext /= No_Project loop\n             if Ext = Extended then\n                return True;\n@@ -2451,7 +2499,6 @@ package body MLib.Prj is\n    begin\n       Objects.Init;\n       Objects_Htable.Reset;\n-      Foreigns.Init;\n       ALIs.Init;\n       Opts.Init;\n       Processed_Projects.Reset;"}, {"sha": "55fa4d1109bb2130a22b0ce87cb8929e86835939", "filename": "gcc/ada/mlib-tgt-aix.adb", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-aix.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-aix.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-aix.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -42,10 +42,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -56,6 +53,8 @@ package body MLib.Tgt.Specific is\n \n    function DLL_Ext return String;\n \n+   function Library_Major_Minor_Id_Supported return Boolean;\n+\n    function Support_For_Libraries return Library_Support;\n \n    --  Local variables\n@@ -90,10 +89,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -102,8 +98,6 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Lib_Version);\n@@ -178,7 +172,7 @@ package body MLib.Tgt.Specific is\n          Objects     => Ofiles,\n          Options     => Options & Bexpall_Option,\n          Driver_Name => Driver_Name,\n-         Options_2   => Options_2 & Thread_Opts.all);\n+         Options_2   => Thread_Opts.all);\n    end Build_Dynamic_Library;\n \n    -------------\n@@ -190,6 +184,15 @@ package body MLib.Tgt.Specific is\n       return \"a\";\n    end DLL_Ext;\n \n+   --------------------------------------\n+   -- Library_Major_Minor_Id_Supported --\n+   --------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported return Boolean is\n+   begin\n+      return False;\n+   end Library_Major_Minor_Id_Supported;\n+\n    ---------------------------\n    -- Support_For_Libraries --\n    ---------------------------\n@@ -202,6 +205,8 @@ package body MLib.Tgt.Specific is\n begin\n    Build_Dynamic_Library_Ptr := Build_Dynamic_Library'Access;\n    DLL_Ext_Ptr := DLL_Ext'Access;\n+   Library_Major_Minor_Id_Supported_Ptr :=\n+                                Library_Major_Minor_Id_Supported'Access;\n    Support_For_Libraries_Ptr := Support_For_Libraries'Access;\n \n end MLib.Tgt.Specific;"}, {"sha": "aa71be07cbe23276a61e70af7a1febd6f60c52f8", "filename": "gcc/ada/mlib-tgt-darwin.adb", "status": "modified", "additions": 36, "deletions": 61, "changes": 97, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-darwin.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-darwin.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-darwin.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -33,8 +33,6 @@ with MLib.Utl;\n with Opt;      use Opt;\n with Output;   use Output;\n \n-with System;\n-\n package body MLib.Tgt.Specific is\n \n    --  Non default subprograms\n@@ -43,10 +41,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -70,8 +65,8 @@ package body MLib.Tgt.Specific is\n    Shared_Libgcc  : aliased String := \"-shared-libgcc\";\n \n    Shared_Options : constant Argument_List :=\n-                               (1 => Flat_Namespace'Access,\n-                                2 => Shared_Libgcc'Access);\n+                      (1 => Flat_Namespace'Access,\n+                       2 => Shared_Libgcc'Access);\n \n    -----------------------------\n    -- Archive_Indexer_Options --\n@@ -88,10 +83,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -100,15 +92,15 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Auto_Init);\n \n       Lib_File : constant String :=\n-                   Lib_Dir & Directory_Separator & \"lib\" &\n-                   Fil.Append_To (Lib_Filename, DLL_Ext);\n+                   \"lib\" & Fil.Append_To (Lib_Filename, DLL_Ext);\n+\n+      Lib_Path : constant String :=\n+                   Lib_Dir & Directory_Separator & Lib_File;\n \n       Symbolic_Link_Needed : Boolean := False;\n \n@@ -126,55 +118,38 @@ package body MLib.Tgt.Specific is\n             Objects     => Ofiles,\n             Options     => Options & Shared_Options,\n             Driver_Name => Driver_Name,\n-            Options_2   => Options_2);\n+            Options_2   => No_Argument_List);\n \n       else\n-\n-         if Is_Absolute_Path (Lib_Version) then\n-            Utl.Gcc\n-              (Output_File => Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => Options & Shared_Options,\n-               Driver_Name => Driver_Name,\n-               Options_2   => Options_2);\n-            Symbolic_Link_Needed := Lib_Version /= Lib_File;\n-\n-         else\n-            Utl.Gcc\n-              (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => Options & Shared_Options,\n-               Driver_Name => Driver_Name,\n-               Options_2   => Options_2);\n-            Symbolic_Link_Needed :=\n-              Lib_Dir & Directory_Separator & Lib_Version /= Lib_File;\n-         end if;\n-\n-         if Symbolic_Link_Needed then\n-            declare\n-               Success : Boolean;\n-               Oldpath : String (1 .. Lib_Version'Length + 1);\n-               Newpath : String (1 .. Lib_File'Length + 1);\n-\n-               Result : Integer;\n-               pragma Unreferenced (Result);\n-\n-               function Symlink\n-                 (Oldpath : System.Address;\n-                  Newpath : System.Address) return Integer;\n-               pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-            begin\n-               Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-               Oldpath (Oldpath'Last)            := ASCII.NUL;\n-               Newpath (1 .. Lib_File'Length)    := Lib_File;\n-               Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-               Delete_File (Lib_File, Success);\n-\n-               Result := Symlink (Oldpath'Address, Newpath'Address);\n-            end;\n-         end if;\n+         declare\n+            Maj_Version : constant String :=\n+                            Major_Id_Name (Lib_File, Lib_Version);\n+         begin\n+            if Is_Absolute_Path (Lib_Version) then\n+               Utl.Gcc\n+                 (Output_File => Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => Options & Shared_Options,\n+                  Driver_Name => Driver_Name,\n+                  Options_2   => No_Argument_List);\n+               Symbolic_Link_Needed := Lib_Version /= Lib_File;\n+\n+            else\n+               Utl.Gcc\n+                 (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => Options & Shared_Options,\n+                  Driver_Name => Driver_Name,\n+                  Options_2   => No_Argument_List);\n+               Symbolic_Link_Needed :=\n+                 Lib_Dir & Directory_Separator & Lib_Version /= Lib_File;\n+            end if;\n+\n+            if Symbolic_Link_Needed then\n+               Create_Sym_Links\n+                 (Lib_Path, Lib_Version, Lib_Dir, Maj_Version);\n+            end if;\n+         end;\n       end if;\n    end Build_Dynamic_Library;\n "}, {"sha": "8aac837d308832cb84ce6014323b9bfb686f5636", "filename": "gcc/ada/mlib-tgt-hpux.adb", "status": "modified", "additions": 43, "deletions": 61, "changes": 104, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-hpux.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-hpux.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-hpux.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -31,18 +31,14 @@ with MLib.Fil;\n with MLib.Utl;\n with Opt;\n with Output; use Output;\n-with System;\n \n package body MLib.Tgt.Specific is\n \n    --  Non default subprograms\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -61,10 +57,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -73,15 +66,15 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Auto_Init);\n \n       Lib_File : constant String :=\n-                   Lib_Dir & Directory_Separator & \"lib\" &\n-                   MLib.Fil.Append_To (Lib_Filename, DLL_Ext);\n+                   \"lib\" & Fil.Append_To (Lib_Filename, DLL_Ext);\n+\n+      Lib_Path : constant String :=\n+                   Lib_Dir & Directory_Separator & Lib_File;\n \n       Version_Arg          : String_Access;\n       Symbolic_Link_Needed : Boolean := False;\n@@ -96,65 +89,54 @@ package body MLib.Tgt.Specific is\n    begin\n       if Opt.Verbose_Mode then\n          Write_Str (\"building relocatable shared library \");\n-         Write_Line (Lib_File);\n+         Write_Line (Lib_Path);\n       end if;\n \n       if Lib_Version = \"\" then\n          MLib.Utl.Gcc\n-           (Output_File => Lib_File,\n+           (Output_File => Lib_Path,\n             Objects     => Ofiles,\n             Options     => Common_Options,\n-            Options_2   => Options_2,\n+            Options_2   => No_Argument_List,\n             Driver_Name => Driver_Name);\n \n       else\n-         Version_Arg := new String'(\"-Wl,+h,\" & Lib_Version);\n-\n-         if Is_Absolute_Path (Lib_Version) then\n-            MLib.Utl.Gcc\n-              (Output_File => Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => Common_Options & Version_Arg,\n-               Options_2   => Options_2,\n-               Driver_Name => Driver_Name);\n-            Symbolic_Link_Needed := Lib_Version /= Lib_File;\n-\n-         else\n-            MLib.Utl.Gcc\n-              (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => Common_Options & Version_Arg,\n-               Options_2   => Options_2,\n-               Driver_Name => Driver_Name);\n-            Symbolic_Link_Needed :=\n-              Lib_Dir & Directory_Separator & Lib_Version /= Lib_File;\n-         end if;\n-\n-         if Symbolic_Link_Needed then\n-            declare\n-               Success : Boolean;\n-               Oldpath : String (1 .. Lib_Version'Length + 1);\n-               Newpath : String (1 .. Lib_File'Length + 1);\n-\n-               Result : Integer;\n-               pragma Unreferenced (Result);\n-\n-               function Symlink\n-                 (Oldpath : System.Address;\n-                  Newpath : System.Address) return Integer;\n-               pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-            begin\n-               Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-               Oldpath (Oldpath'Last)            := ASCII.NUL;\n-               Newpath (1 .. Lib_File'Length)    := Lib_File;\n-               Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-               Delete_File (Lib_File, Success);\n-\n-               Result := Symlink (Oldpath'Address, Newpath'Address);\n-            end;\n-         end if;\n+         declare\n+            Maj_Version : constant String :=\n+                            Major_Id_Name (Lib_File, Lib_Version);\n+         begin\n+            if Maj_Version'Length /= 0 then\n+               Version_Arg := new String'(\"-Wl,+h,\" & Maj_Version);\n+\n+            else\n+               Version_Arg := new String'(\"-Wl,+h,\" & Lib_Version);\n+            end if;\n+\n+            if Is_Absolute_Path (Lib_Version) then\n+               MLib.Utl.Gcc\n+                 (Output_File => Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => Common_Options & Version_Arg,\n+                  Options_2   => No_Argument_List,\n+                  Driver_Name => Driver_Name);\n+               Symbolic_Link_Needed := Lib_Version /= Lib_Path;\n+\n+            else\n+               MLib.Utl.Gcc\n+                 (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => Common_Options & Version_Arg,\n+                  Options_2   => No_Argument_List,\n+                  Driver_Name => Driver_Name);\n+               Symbolic_Link_Needed :=\n+                 Lib_Dir & Directory_Separator & Lib_Version /= Lib_Path;\n+            end if;\n+\n+            if Symbolic_Link_Needed then\n+               Create_Sym_Links\n+                 (Lib_Path, Lib_Version, Lib_Dir, Maj_Version);\n+            end if;\n+         end;\n       end if;\n    end Build_Dynamic_Library;\n "}, {"sha": "fdab352f645ace3288ebd6ecebc09cf4fd080f7a", "filename": "gcc/ada/mlib-tgt-irix.adb", "status": "modified", "additions": 45, "deletions": 71, "changes": 116, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-irix.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-irix.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-irix.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -31,18 +31,14 @@ with MLib.Fil;\n with MLib.Utl;\n with Opt;\n with Output; use Output;\n-with System;\n \n package body MLib.Tgt.Specific is\n \n    --  Non default subprogram\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -59,10 +55,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -71,15 +64,15 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Auto_Init);\n \n       Lib_File : constant String :=\n-                   Lib_Dir & Directory_Separator & \"lib\" &\n-                   MLib.Fil.Append_To (Lib_Filename, DLL_Ext);\n+                   \"lib\" & MLib.Fil.Append_To (Lib_Filename, DLL_Ext);\n+\n+      Lib_Path : constant String :=\n+                   Lib_Dir & Directory_Separator & Lib_File;\n \n       Version_Arg          : String_Access;\n       Symbolic_Link_Needed : Boolean := False;\n@@ -89,15 +82,15 @@ package body MLib.Tgt.Specific is\n       --  After moving -lxxx to Options_2, N_Options up to index Options_Last\n       --  will contain the Options to pass to MLib.Utl.Gcc.\n \n-      Real_Options_2 : Argument_List (1 .. Options'Length + Options_2'Length);\n+      Real_Options_2 : Argument_List (1 .. Options'Length);\n       Real_Options_2_Last : Natural := 0;\n       --  Real_Options_2 up to index Real_Options_2_Last will contain the\n       --  Options_2 to pass to MLib.Utl.Gcc.\n \n    begin\n       if Opt.Verbose_Mode then\n          Write_Str (\"building relocatable shared library \");\n-         Write_Line (Lib_File);\n+         Write_Line (Lib_Path);\n       end if;\n \n       --  Move all -lxxx to Options_2\n@@ -125,72 +118,53 @@ package body MLib.Tgt.Specific is\n          end loop;\n       end;\n \n-      --  Add to Real_Options_2 the argument Options_2\n-\n-      Real_Options_2\n-        (Real_Options_2_Last + 1 .. Real_Options_2_Last + Options_2'Length) :=\n-        Options_2;\n-      Real_Options_2_Last := Real_Options_2_Last + Options_2'Length;\n-\n       if Lib_Version = \"\" then\n          MLib.Utl.Gcc\n-           (Output_File => Lib_File,\n+           (Output_File => Lib_Path,\n             Objects     => Ofiles,\n             Options     => N_Options (N_Options'First .. Options_Last),\n             Driver_Name => Driver_Name,\n             Options_2   => Real_Options_2 (1 .. Real_Options_2_Last));\n \n       else\n-         Version_Arg := new String'(\"-Wl,-soname,\" & Lib_Version);\n-\n-         if Is_Absolute_Path (Lib_Version) then\n-            MLib.Utl.Gcc\n-              (Output_File => Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => N_Options (N_Options'First .. Options_Last) &\n-                              Version_Arg,\n-               Driver_Name => Driver_Name,\n-               Options_2   => Real_Options_2 (1 .. Real_Options_2_Last));\n-            Symbolic_Link_Needed := Lib_Version /= Lib_File;\n-\n-         else\n-            MLib.Utl.Gcc\n-              (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => N_Options (N_Options'First .. Options_Last) &\n-                              Version_Arg,\n-               Driver_Name => Driver_Name,\n-               Options_2   => Real_Options_2 (1 .. Real_Options_2_Last));\n-            Symbolic_Link_Needed :=\n-              Lib_Dir & Directory_Separator & Lib_Version /= Lib_File;\n-         end if;\n-\n-         if Symbolic_Link_Needed then\n-            declare\n-               Success : Boolean;\n-               Oldpath : String (1 .. Lib_Version'Length + 1);\n-               Newpath : String (1 .. Lib_File'Length + 1);\n-\n-               Result : Integer;\n-               pragma Unreferenced (Result);\n-\n-               function Symlink\n-                 (Oldpath : System.Address;\n-                  Newpath : System.Address)\n-                  return    Integer;\n-               pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-            begin\n-               Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-               Oldpath (Oldpath'Last)            := ASCII.NUL;\n-               Newpath (1 .. Lib_File'Length)    := Lib_File;\n-               Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-               Delete_File (Lib_File, Success);\n-\n-               Result := Symlink (Oldpath'Address, Newpath'Address);\n-            end;\n-         end if;\n+         declare\n+            Maj_Version : constant String :=\n+                            Major_Id_Name (Lib_File, Lib_Version);\n+         begin\n+            if Maj_Version'Length /= 0 then\n+               Version_Arg := new String'(\"-Wl,-soname,\" & Maj_Version);\n+\n+            else\n+               Version_Arg := new String'(\"-Wl,-soname,\" & Lib_Version);\n+            end if;\n+\n+            if Is_Absolute_Path (Lib_Version) then\n+               MLib.Utl.Gcc\n+                 (Output_File => Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => N_Options (N_Options'First .. Options_Last) &\n+                  Version_Arg,\n+                  Driver_Name => Driver_Name,\n+                  Options_2   => Real_Options_2 (1 .. Real_Options_2_Last));\n+               Symbolic_Link_Needed := Lib_Version /= Lib_Path;\n+\n+            else\n+               MLib.Utl.Gcc\n+                 (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => N_Options (N_Options'First .. Options_Last) &\n+                  Version_Arg,\n+                  Driver_Name => Driver_Name,\n+                  Options_2   => Real_Options_2 (1 .. Real_Options_2_Last));\n+               Symbolic_Link_Needed :=\n+                 Lib_Dir & Directory_Separator & Lib_Version /= Lib_Path;\n+            end if;\n+\n+            if Symbolic_Link_Needed then\n+               Create_Sym_Links\n+                 (Lib_Path, Lib_Version, Lib_Dir, Maj_Version);\n+            end if;\n+         end;\n       end if;\n    end Build_Dynamic_Library;\n "}, {"sha": "001e1a4609ff73bb3068b317fe1c79bc809d459a", "filename": "gcc/ada/mlib-tgt-linux.adb", "status": "modified", "additions": 9, "deletions": 110, "changes": 119, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-linux.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-linux.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-linux.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -31,7 +31,6 @@ with MLib.Fil;\n with MLib.Utl;\n with Opt;\n with Output; use Output;\n-with System;\n \n package body MLib.Tgt.Specific is\n \n@@ -41,10 +40,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -61,10 +57,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -73,8 +66,6 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Auto_Init);\n@@ -101,56 +92,15 @@ package body MLib.Tgt.Specific is\n             Objects     => Ofiles,\n             Options     => Options,\n             Driver_Name => Driver_Name,\n-            Options_2   => Options_2);\n+            Options_2   => No_Argument_List);\n \n       else\n          declare\n-            Maj_Version : constant String := Lib_Version;\n-            Last_Maj    : Positive := Maj_Version'Last;\n-            Last        : Positive;\n-            Ok_Maj      : Boolean := False;\n+            Maj_Version : constant String :=\n+                            Major_Id_Name (Lib_File, Lib_Version);\n          begin\n-            while Last_Maj > Maj_Version'First loop\n-               if Maj_Version (Last_Maj) in '0' .. '9' then\n-                  Last_Maj := Last_Maj - 1;\n-\n-               else\n-                  Ok_Maj := Last_Maj /= Maj_Version'Last and then\n-                            Maj_Version (Last_Maj) = '.';\n-\n-                  if Ok_Maj then\n-                     Last_Maj := Last_Maj - 1;\n-                  end if;\n-\n-                  exit;\n-               end if;\n-            end loop;\n-\n-            if Ok_Maj then\n-               Last := Last_Maj;\n-\n-               while Last > Maj_Version'First loop\n-                  if Maj_Version (Last) in '0' .. '9' then\n-                     Last := Last - 1;\n-\n-                  else\n-                     Ok_Maj := Last /= Last_Maj and then\n-                               Maj_Version (Last) = '.';\n-\n-                     if Ok_Maj then\n-                        Last := Last - 1;\n-\n-                        Ok_Maj := Maj_Version (1 .. Last) = Lib_File;\n-                     end if;\n-\n-                     exit;\n-                  end if;\n-               end loop;\n-            end if;\n-\n-            if Ok_Maj then\n-               Version_Arg := new String'(\"-Wl,-soname,\" &\n-                                          Maj_Version (1 .. Last_Maj));\n+            if Maj_Version'Length /= 0 then\n+               Version_Arg := new String'(\"-Wl,-soname,\" & Maj_Version);\n \n             else\n                Version_Arg := new String'(\"-Wl,-soname,\" & Lib_Version);\n@@ -162,7 +112,7 @@ package body MLib.Tgt.Specific is\n                   Objects     => Ofiles,\n                   Options     => Options & Version_Arg,\n                   Driver_Name => Driver_Name,\n-                  Options_2   => Options_2);\n+                  Options_2   => No_Argument_List);\n                Symbolic_Link_Needed := Lib_Version /= Lib_Path;\n \n             else\n@@ -171,65 +121,14 @@ package body MLib.Tgt.Specific is\n                   Objects     => Ofiles,\n                   Options     => Options & Version_Arg,\n                   Driver_Name => Driver_Name,\n-                  Options_2   => Options_2);\n+                  Options_2   => No_Argument_List);\n                Symbolic_Link_Needed :=\n                  Lib_Dir & Directory_Separator & Lib_Version /= Lib_Path;\n             end if;\n \n             if Symbolic_Link_Needed then\n-               declare\n-                  Success : Boolean;\n-                  Oldpath : String (1 .. Lib_Version'Length + 1);\n-                  Newpath : String (1 .. Lib_Path'Length + 1);\n-\n-                  Result : Integer;\n-                  pragma Unreferenced (Result);\n-\n-                  function Symlink\n-                    (Oldpath : System.Address;\n-                     Newpath : System.Address) return Integer;\n-                  pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-               begin\n-                  Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-                  Oldpath (Oldpath'Last)            := ASCII.NUL;\n-                  Newpath (1 .. Lib_Path'Length)    := Lib_Path;\n-                  Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-                  Delete_File (Lib_Path, Success);\n-\n-                  Result := Symlink (Oldpath'Address, Newpath'Address);\n-               end;\n-\n-               if Ok_Maj then\n-                  declare\n-                     Success : Boolean;\n-                     Oldpath : String (1 .. Lib_Version'Length + 1);\n-                     Maj_Path : constant String :=\n-                                  Lib_Dir & Directory_Separator &\n-                                  Maj_Version (1 .. Last_Maj);\n-                     Newpath : String (1 .. Maj_Path'Length + 1);\n-\n-                     Result  : Integer;\n-                     pragma Unreferenced (Result);\n-\n-                     function Symlink\n-                       (Oldpath : System.Address;\n-                        Newpath : System.Address) return Integer;\n-                     pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-                  begin\n-                     Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-                     Oldpath (Oldpath'Last)            := ASCII.NUL;\n-                     Newpath (1 .. Maj_Path'Length)    := Maj_Path;\n-                     Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-                     Delete_File (Maj_Path, Success);\n-\n-                     Result := Symlink (Oldpath'Address, Newpath'Address);\n-                  end;\n-               end if;\n-\n+               Create_Sym_Links\n+                 (Lib_Path, Lib_Version, Lib_Dir, Maj_Version);\n             end if;\n          end;\n       end if;"}, {"sha": "999a320bf48a911b1ad72e7533687380d433ff70", "filename": "gcc/ada/mlib-tgt-lynxos.adb", "status": "modified", "additions": 13, "deletions": 9, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-lynxos.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-lynxos.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-lynxos.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -33,10 +33,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -51,6 +48,8 @@ package body MLib.Tgt.Specific is\n \n    function PIC_Option return String;\n \n+   function Library_Major_Minor_Id_Supported return Boolean;\n+\n    function Standalone_Library_Auto_Init_Is_Supported return Boolean;\n \n    function Support_For_Libraries return Library_Support;\n@@ -61,10 +60,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -74,10 +70,7 @@ package body MLib.Tgt.Specific is\n       Auto_Init    : Boolean := False)\n    is\n       pragma Unreferenced (Ofiles);\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Options);\n-      pragma Unreferenced (Options_2);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Lib_Filename);\n       pragma Unreferenced (Lib_Dir);\n@@ -108,6 +101,15 @@ package body MLib.Tgt.Specific is\n       return \"\";\n    end Dynamic_Option;\n \n+   --------------------------------------\n+   -- Library_Major_Minor_Id_Supported --\n+   --------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported return Boolean is\n+   begin\n+      return False;\n+   end Library_Major_Minor_Id_Supported;\n+\n    ----------------\n    -- PIC_Option --\n    ----------------\n@@ -139,6 +141,8 @@ begin\n    Build_Dynamic_Library_Ptr := Build_Dynamic_Library'Access;\n    DLL_Ext_Ptr := DLL_Ext'Access;\n    Dynamic_Option_Ptr := Dynamic_Option'Access;\n+   Library_Major_Minor_Id_Supported_Ptr :=\n+                                Library_Major_Minor_Id_Supported'Access;\n    PIC_Option_Ptr := PIC_Option'Access;\n    Standalone_Library_Auto_Init_Is_Supported_Ptr :=\n      Standalone_Library_Auto_Init_Is_Supported'Access;"}, {"sha": "56c607adaa734f53495624b819008b0db2e4f6ca", "filename": "gcc/ada/mlib-tgt-mingw.adb", "status": "modified", "additions": 20, "deletions": 15, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-mingw.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-mingw.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-mingw.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -43,10 +43,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -61,6 +58,8 @@ package body MLib.Tgt.Specific is\n \n    function Is_Archive_Ext (Ext : String) return Boolean;\n \n+   function Library_Major_Minor_Id_Supported return Boolean;\n+\n    function PIC_Option return String;\n \n    No_Argument_List : constant String_List := (1 .. 0 => null);\n@@ -72,10 +71,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -84,16 +80,14 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Lib_Version);\n       pragma Unreferenced (Auto_Init);\n \n       Lib_File : constant String :=\n                    Lib_Dir & Directory_Separator &\n-                   Files.Append_To (Lib_Filename, DLL_Ext);\n+                   DLL_Prefix & Files.Append_To (Lib_Filename, DLL_Ext);\n \n    --  Start of processing for Build_Dynamic_Library\n \n@@ -107,7 +101,7 @@ package body MLib.Tgt.Specific is\n         (Output_File => Lib_File,\n          Objects     => Ofiles,\n          Options     => No_Argument_List,\n-         Options_2   => Options & Options_2,\n+         Options_2   => Options,\n          Driver_Name => Driver_Name);\n    end Build_Dynamic_Library;\n \n@@ -126,7 +120,7 @@ package body MLib.Tgt.Specific is\n \n    function DLL_Prefix return String is\n    begin\n-      return \"\";\n+      return \"lib\";\n    end DLL_Prefix;\n \n    --------------------\n@@ -138,6 +132,15 @@ package body MLib.Tgt.Specific is\n       return Ext = \".a\" or else Ext = \".dll\";\n    end Is_Archive_Ext;\n \n+   --------------------------------------\n+   -- Library_Major_Minor_Id_Supported --\n+   --------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported return Boolean is\n+   begin\n+      return False;\n+   end Library_Major_Minor_Id_Supported;\n+\n    ----------------\n    -- PIC_Option --\n    ----------------\n@@ -149,8 +152,10 @@ package body MLib.Tgt.Specific is\n \n begin\n    Build_Dynamic_Library_Ptr := Build_Dynamic_Library'Access;\n-   DLL_Ext_Ptr := DLL_Ext'Access;\n-   DLL_Prefix_Ptr := DLL_Prefix'Access;\n-   Is_Archive_Ext_Ptr := Is_Archive_Ext'Access;\n-   PIC_Option_Ptr := PIC_Option'Access;\n+   DLL_Ext_Ptr               := DLL_Ext'Access;\n+   DLL_Prefix_Ptr            := DLL_Prefix'Access;\n+   Is_Archive_Ext_Ptr        := Is_Archive_Ext'Access;\n+   PIC_Option_Ptr            := PIC_Option'Access;\n+   Library_Major_Minor_Id_Supported_Ptr :=\n+                                Library_Major_Minor_Id_Supported'Access;\n end MLib.Tgt.Specific;"}, {"sha": "d0489b770f165c996129cf5593881fbb7ea59211", "filename": "gcc/ada/mlib-tgt-solaris.adb", "status": "modified", "additions": 43, "deletions": 62, "changes": 105, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-solaris.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-solaris.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-solaris.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -31,18 +31,14 @@ with MLib.Fil;\n with MLib.Utl;\n with Opt;\n with Output; use Output;\n-with System;\n \n package body MLib.Tgt.Specific is\n \n    --  Non default subprograms\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -59,10 +55,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -71,82 +64,70 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Auto_Init);\n \n       Lib_File : constant String :=\n-                   Lib_Dir & Directory_Separator & \"lib\" &\n-                   Fil.Append_To (Lib_Filename, DLL_Ext);\n+                   \"lib\" & Fil.Append_To (Lib_Filename, DLL_Ext);\n+\n+      Lib_Path : constant String :=\n+                   Lib_Dir & Directory_Separator & Lib_File;\n \n       Version_Arg          : String_Access;\n       Symbolic_Link_Needed : Boolean := False;\n \n    begin\n       if Opt.Verbose_Mode then\n          Write_Str (\"building relocatable shared library \");\n-         Write_Line (Lib_File);\n+         Write_Line (Lib_Path);\n       end if;\n \n       if Lib_Version = \"\" then\n          Utl.Gcc\n-           (Output_File => Lib_File,\n+           (Output_File => Lib_Path,\n             Objects     => Ofiles,\n             Options     => Options,\n-            Options_2   => Options_2,\n+            Options_2   => No_Argument_List,\n             Driver_Name => Driver_Name);\n \n       else\n-         Version_Arg := new String'(\"-Wl,-h,\" & Lib_Version);\n-\n-         if Is_Absolute_Path (Lib_Version) then\n-            Utl.Gcc\n-              (Output_File => Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => Options & Version_Arg,\n-               Options_2   => Options_2,\n-               Driver_Name => Driver_Name);\n-            Symbolic_Link_Needed := Lib_Version /= Lib_File;\n-\n-         else\n-            Utl.Gcc\n-              (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n-               Objects     => Ofiles,\n-               Options     => Options & Version_Arg,\n-               Options_2   => Options_2,\n-               Driver_Name => Driver_Name);\n-            Symbolic_Link_Needed :=\n-              Lib_Dir & Directory_Separator & Lib_Version /= Lib_File;\n-         end if;\n-\n-         if Symbolic_Link_Needed then\n-            declare\n-               Success : Boolean;\n-               Oldpath : String (1 .. Lib_Version'Length + 1);\n-               Newpath : String (1 .. Lib_File'Length + 1);\n-\n-               Result : Integer;\n-               pragma Unreferenced (Result);\n-\n-               function Symlink\n-                 (Oldpath : System.Address;\n-                  Newpath : System.Address)\n-                  return    Integer;\n-               pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-            begin\n-               Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-               Oldpath (Oldpath'Last)            := ASCII.NUL;\n-               Newpath (1 .. Lib_File'Length)    := Lib_File;\n-               Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-               Delete_File (Lib_File, Success);\n-\n-               Result := Symlink (Oldpath'Address, Newpath'Address);\n-            end;\n-         end if;\n+         declare\n+            Maj_Version : constant String :=\n+                            Major_Id_Name (Lib_File, Lib_Version);\n+         begin\n+            if Maj_Version'Length /= 0 then\n+               Version_Arg := new String'(\"-Wl,-h,\" & Maj_Version);\n+\n+            else\n+               Version_Arg := new String'(\"-Wl,-h,\" & Lib_Version);\n+            end if;\n+\n+            if Is_Absolute_Path (Lib_Version) then\n+               Utl.Gcc\n+                 (Output_File => Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => Options & Version_Arg,\n+                  Options_2   => No_Argument_List,\n+                  Driver_Name => Driver_Name);\n+               Symbolic_Link_Needed := Lib_Version /= Lib_Path;\n+\n+            else\n+               Utl.Gcc\n+                 (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     => Options & Version_Arg,\n+                  Options_2   => No_Argument_List,\n+                  Driver_Name => Driver_Name);\n+               Symbolic_Link_Needed :=\n+                 Lib_Dir & Directory_Separator & Lib_Version /= Lib_Path;\n+            end if;\n+\n+            if Symbolic_Link_Needed then\n+               Create_Sym_Links\n+                 (Lib_Path, Lib_Version, Lib_Dir, Maj_Version);\n+            end if;\n+         end;\n       end if;\n    end Build_Dynamic_Library;\n "}, {"sha": "4ee9b72071805fecef2862a32b08beefb4ef170b", "filename": "gcc/ada/mlib-tgt-tru64.adb", "status": "modified", "additions": 45, "deletions": 64, "changes": 109, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-tru64.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-tru64.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-tru64.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -31,7 +31,6 @@ with MLib.Fil;\n with MLib.Utl;\n with Opt;\n with Output; use Output;\n-with System;\n \n package body MLib.Tgt.Specific is\n \n@@ -41,10 +40,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -67,10 +63,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -79,87 +72,75 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Symbol_Data);\n       pragma Unreferenced (Auto_Init);\n       --  Initialization is done through the contructor mechanism\n \n       Lib_File : constant String :=\n-                   Lib_Dir & Directory_Separator & \"lib\" &\n-                   Fil.Append_To (Lib_Filename, DLL_Ext);\n+                   \"lib\" & Fil.Append_To (Lib_Filename, DLL_Ext);\n+\n+      Lib_Path : constant String :=\n+                   Lib_Dir & Directory_Separator & Lib_File;\n \n       Version_Arg          : String_Access;\n       Symbolic_Link_Needed : Boolean := False;\n \n    begin\n       if Opt.Verbose_Mode then\n          Write_Str (\"building relocatable shared library \");\n-         Write_Line (Lib_File);\n+         Write_Line (Lib_Path);\n       end if;\n \n       --  If specified, add automatic elaboration/finalization\n \n       if Lib_Version = \"\" then\n          Utl.Gcc\n-           (Output_File => Lib_File,\n+           (Output_File => Lib_Path,\n             Objects     => Ofiles,\n             Options     => Options & Expect_Unresolved'Access,\n-            Options_2   => Options_2,\n+            Options_2   => No_Argument_List,\n             Driver_Name => Driver_Name);\n \n       else\n-         Version_Arg := new String'(\"-Wl,-soname,\" & Lib_Version);\n-\n-         if Is_Absolute_Path (Lib_Version) then\n-            Utl.Gcc\n-              (Output_File => Lib_Version,\n-               Objects     => Ofiles,\n-               Options     =>\n-                 Options & Version_Arg & Expect_Unresolved'Access,\n-               Options_2   => Options_2,\n-               Driver_Name => Driver_Name);\n-            Symbolic_Link_Needed := Lib_Version /= Lib_File;\n-\n-         else\n-            Utl.Gcc\n-              (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n-               Objects     => Ofiles,\n-               Options     =>\n-                 Options & Version_Arg & Expect_Unresolved'Access,\n-               Options_2   => Options_2,\n-               Driver_Name => Driver_Name);\n-            Symbolic_Link_Needed :=\n-              Lib_Dir & Directory_Separator & Lib_Version /= Lib_File;\n-         end if;\n-\n-         if Symbolic_Link_Needed then\n-            declare\n-               Success : Boolean;\n-               Oldpath : String (1 .. Lib_Version'Length + 1);\n-               Newpath : String (1 .. Lib_File'Length + 1);\n-\n-               Result : Integer;\n-               pragma Unreferenced (Result);\n-\n-               function Symlink\n-                 (Oldpath : System.Address;\n-                  Newpath : System.Address)\n-                  return    Integer;\n-               pragma Import (C, Symlink, \"__gnat_symlink\");\n-\n-            begin\n-               Oldpath (1 .. Lib_Version'Length) := Lib_Version;\n-               Oldpath (Oldpath'Last)            := ASCII.NUL;\n-               Newpath (1 .. Lib_File'Length)    := Lib_File;\n-               Newpath (Newpath'Last)            := ASCII.NUL;\n-\n-               Delete_File (Lib_File, Success);\n-\n-               Result := Symlink (Oldpath'Address, Newpath'Address);\n-            end;\n-         end if;\n+         declare\n+            Maj_Version : constant String :=\n+                            Major_Id_Name (Lib_File, Lib_Version);\n+         begin\n+            if Maj_Version'Length /= 0 then\n+               Version_Arg := new String'(\"-Wl,-soname,\" & Maj_Version);\n+\n+            else\n+               Version_Arg := new String'(\"-Wl,-soname,\" & Lib_Version);\n+            end if;\n+\n+            if Is_Absolute_Path (Lib_Version) then\n+               Utl.Gcc\n+                 (Output_File => Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     =>\n+                    Options & Version_Arg & Expect_Unresolved'Access,\n+                  Options_2   => No_Argument_List,\n+                  Driver_Name => Driver_Name);\n+               Symbolic_Link_Needed := Lib_Version /= Lib_Path;\n+\n+            else\n+               Utl.Gcc\n+                 (Output_File => Lib_Dir & Directory_Separator & Lib_Version,\n+                  Objects     => Ofiles,\n+                  Options     =>\n+                    Options & Version_Arg & Expect_Unresolved'Access,\n+                  Options_2   => No_Argument_List,\n+                  Driver_Name => Driver_Name);\n+               Symbolic_Link_Needed :=\n+                 Lib_Dir & Directory_Separator & Lib_Version /= Lib_Path;\n+            end if;\n+\n+            if Symbolic_Link_Needed then\n+               Create_Sym_Links\n+                 (Lib_Path, Lib_Version, Lib_Dir, Maj_Version);\n+            end if;\n+         end;\n       end if;\n    end Build_Dynamic_Library;\n "}, {"sha": "b771c9e48e3c91d3d7a0de27beb10a40b69d1f27", "filename": "gcc/ada/mlib-tgt-vms-alpha.adb", "status": "modified", "additions": 5, "deletions": 13, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vms-alpha.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vms-alpha.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-vms-alpha.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -36,8 +36,8 @@ with MLib.Tgt.VMS;\n pragma Warnings (Off, MLib.Tgt.VMS);\n --  MLib.Tgt.VMS is with'ed only for elaboration purposes\n \n-with Opt;    use Opt;\n-with Output; use Output;\n+with Opt;      use Opt;\n+with Output;   use Output;\n \n with GNAT.Directory_Operations; use GNAT.Directory_Operations;\n \n@@ -51,10 +51,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -95,10 +92,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -107,8 +101,6 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n \n       Lib_File : constant String :=\n                    Lib_Dir & Directory_Separator & \"lib\" &\n@@ -171,7 +163,7 @@ package body MLib.Tgt.Specific is\n \n       function Option_File_Name return String is\n       begin\n-         if Symbol_Data.Symbol_File = No_Name then\n+         if Symbol_Data.Symbol_File = No_Path then\n             return \"symvec.opt\";\n          else\n             Get_Name_String (Symbol_Data.Symbol_File);\n@@ -386,7 +378,7 @@ package body MLib.Tgt.Specific is\n \n       --  Reference Symbol File\n \n-      if Symbol_Data.Reference /= No_Name then\n+      if Symbol_Data.Reference /= No_Path then\n          Last_Argument := Last_Argument + 1;\n          Arguments (Last_Argument) := new String'(\"-r\");\n          Last_Argument := Last_Argument + 1;\n@@ -477,7 +469,7 @@ package body MLib.Tgt.Specific is\n          Options     => VMS_Options,\n          Options_2   => Shared_Libgcc_Switch &\n                         Opts (Opts'First .. Last_Opt) &\n-                        Opts2 (Opts2'First .. Last_Opt2) & Options_2,\n+                        Opts2 (Opts2'First .. Last_Opt2),\n          Driver_Name => Driver_Name);\n \n       --  The auto-init object file need to be deleted, so that it will not"}, {"sha": "404b90587efa574529a76fffea7eca65f7e3f601", "filename": "gcc/ada/mlib-tgt-vms-ia64.adb", "status": "modified", "additions": 6, "deletions": 14, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vms-ia64.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vms-ia64.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-vms-ia64.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -36,8 +36,8 @@ with MLib.Tgt.VMS;\n pragma Warnings (Off, MLib.Tgt.VMS);\n --  MLib.Tgt.VMS is with'ed only for elaboration purposes\n \n-with Opt;    use Opt;\n-with Output; use Output;\n+with Opt;      use Opt;\n+with Output;   use Output;\n \n with GNAT.Directory_Operations; use GNAT.Directory_Operations;\n \n@@ -47,14 +47,11 @@ with System.CRTL;      use System.CRTL;\n \n package body MLib.Tgt.Specific is\n \n-   --  Non default subprogram. See comment in mlib-tgt.ads\n+   --  Non default subprogram. See comment in mlib-tgt.ads.\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -95,10 +92,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -107,8 +101,6 @@ package body MLib.Tgt.Specific is\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False)\n    is\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n \n       Lib_File : constant String :=\n                    Lib_Dir & Directory_Separator & \"lib\" &\n@@ -171,7 +163,7 @@ package body MLib.Tgt.Specific is\n \n       function Option_File_Name return String is\n       begin\n-         if Symbol_Data.Symbol_File = No_Name then\n+         if Symbol_Data.Symbol_File = No_Path then\n             return \"symvec.opt\";\n          else\n             Get_Name_String (Symbol_Data.Symbol_File);\n@@ -420,7 +412,7 @@ package body MLib.Tgt.Specific is\n \n       --  Reference Symbol File\n \n-      if Symbol_Data.Reference /= No_Name then\n+      if Symbol_Data.Reference /= No_Path then\n          Last_Argument := Last_Argument + 1;\n          Arguments (Last_Argument) := new String'(\"-r\");\n          Last_Argument := Last_Argument + 1;\n@@ -510,7 +502,7 @@ package body MLib.Tgt.Specific is\n          Options     => VMS_Options,\n          Options_2   => Shared_Libgcc_Switch &\n                         Opts (Opts'First .. Last_Opt) &\n-                        Opts2 (Opts2'First .. Last_Opt2) & Options_2,\n+                        Opts2 (Opts2'First .. Last_Opt2),\n          Driver_Name => Driver_Name);\n \n       --  The auto-init object file need to be deleted, so that it will not"}, {"sha": "4fb787c127597432ecd0895a8d4d30400b49f019", "filename": "gcc/ada/mlib-tgt-vms.adb", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vms.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vms.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-vms.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -44,6 +44,8 @@ package body MLib.Tgt.VMS is\n \n    function Object_Ext return String;\n \n+   function Library_Major_Minor_Id_Supported return Boolean;\n+\n    function PIC_Option return String;\n \n    -----------------\n@@ -110,6 +112,15 @@ package body MLib.Tgt.VMS is\n       end if;\n    end Libgnat;\n \n+   --------------------------------------\n+   -- Library_Major_Minor_Id_Supported --\n+   --------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported return Boolean is\n+   begin\n+      return False;\n+   end Library_Major_Minor_Id_Supported;\n+\n    ----------------\n    -- Object_Ext --\n    ----------------\n@@ -139,4 +150,7 @@ begin\n    Libgnat_Ptr                  := Libgnat'Access;\n    Object_Ext_Ptr               := Object_Ext'Access;\n    PIC_Option_Ptr               := PIC_Option'Access;\n+   Library_Major_Minor_Id_Supported_Ptr :=\n+                                   Library_Major_Minor_Id_Supported'Access;\n+\n end MLib.Tgt.VMS;"}, {"sha": "bad799e9d993b32e7edb276e4249b0e05f40f62e", "filename": "gcc/ada/mlib-tgt-vxworks.adb", "status": "modified", "additions": 14, "deletions": 11, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vxworks.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt-vxworks.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt-vxworks.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -28,7 +28,6 @@\n --  This is the VxWorks version of the body\n \n with Sdefault;\n-with Types;    use Types;\n \n package body MLib.Tgt.Specific is\n \n@@ -48,10 +47,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -64,6 +60,8 @@ package body MLib.Tgt.Specific is\n \n    function Dynamic_Option return String;\n \n+   function Library_Major_Minor_Id_Supported return Boolean;\n+\n    function PIC_Option return String;\n \n    function Standalone_Library_Auto_Init_Is_Supported return Boolean;\n@@ -94,10 +92,7 @@ package body MLib.Tgt.Specific is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n@@ -107,10 +102,7 @@ package body MLib.Tgt.Specific is\n       Auto_Init    : Boolean := False)\n    is\n       pragma Unreferenced (Ofiles);\n-      pragma Unreferenced (Foreign);\n-      pragma Unreferenced (Afiles);\n       pragma Unreferenced (Options);\n-      pragma Unreferenced (Options_2);\n       pragma Unreferenced (Interfaces);\n       pragma Unreferenced (Lib_Filename);\n       pragma Unreferenced (Lib_Dir);\n@@ -146,7 +138,7 @@ package body MLib.Tgt.Specific is\n    -----------------------------\n \n    function Get_Target_Suffix return String is\n-      Target_Name : constant String_Ptr := Sdefault.Target_Name;\n+      Target_Name : constant String := Sdefault.Target_Name.all;\n       Index       : Positive   := Target_Name'First;\n \n    begin\n@@ -175,6 +167,15 @@ package body MLib.Tgt.Specific is\n       end if;\n    end Get_Target_Suffix;\n \n+   --------------------------------------\n+   -- Library_Major_Minor_Id_Supported --\n+   --------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported return Boolean is\n+   begin\n+      return False;\n+   end Library_Major_Minor_Id_Supported;\n+\n    ----------------\n    -- PIC_Option --\n    ----------------\n@@ -209,6 +210,8 @@ begin\n    DLL_Ext_Ptr := DLL_Ext'Access;\n    Dynamic_Option_Ptr := Dynamic_Option'Access;\n    PIC_Option_Ptr := PIC_Option'Access;\n+   Library_Major_Minor_Id_Supported_Ptr :=\n+                                Library_Major_Minor_Id_Supported'Access;\n    Standalone_Library_Auto_Init_Is_Supported_Ptr :=\n      Standalone_Library_Auto_Init_Is_Supported'Access;\n    Support_For_Libraries_Ptr := Support_For_Libraries'Access;"}, {"sha": "f2cc87ef912da07e9257354d03602c55fa9c5f31", "filename": "gcc/ada/mlib-tgt.adb", "status": "modified", "additions": 24, "deletions": 11, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -151,25 +151,19 @@ package body MLib.Tgt is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n       Symbol_Data  : Symbol_Record;\n-      Driver_Name  : Name_Id  := No_Name;\n-      Lib_Version  : String   := \"\";\n-      Auto_Init    : Boolean  := False)\n+      Driver_Name  : Name_Id := No_Name;\n+      Lib_Version  : String  := \"\";\n+      Auto_Init    : Boolean := False)\n    is\n    begin\n       Build_Dynamic_Library_Ptr\n         (Ofiles,\n-         Foreign,\n-         Afiles,\n          Options,\n-         Options_2,\n          Interfaces,\n          Lib_Filename,\n          Lib_Dir,\n@@ -404,7 +398,9 @@ package body MLib.Tgt is\n                            (In_Tree.Projects.Table (Project).Library_Name);\n \n          begin\n-            if In_Tree.Projects.Table (Project).Library_Kind = Static then\n+            if In_Tree.Projects.Table (Project).Library_Kind =\n+                 Static\n+            then\n                Name_Len := 3;\n                Name_Buffer (1 .. Name_Len) := \"lib\";\n                Add_Str_To_Name_Buffer (Fil.Append_To (Lib_Name, Archive_Ext));\n@@ -419,6 +415,24 @@ package body MLib.Tgt is\n       end if;\n    end Library_File_Name_For_Default;\n \n+   --------------------------------------\n+   -- Library_Major_Minor_Id_Supported --\n+   --------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported return Boolean is\n+   begin\n+      return Library_Major_Minor_Id_Supported_Ptr.all;\n+   end Library_Major_Minor_Id_Supported;\n+\n+   ----------------------------------------------\n+   -- Library_Major_Minor_Id_Supported_Default --\n+   ----------------------------------------------\n+\n+   function Library_Major_Minor_Id_Supported_Default return Boolean is\n+   begin\n+      return True;\n+   end Library_Major_Minor_Id_Supported_Default;\n+\n    ----------------\n    -- Object_Ext --\n    ----------------\n@@ -490,5 +504,4 @@ package body MLib.Tgt is\n    begin\n       return Full;\n    end Support_For_Libraries_Default;\n-\n end MLib.Tgt;"}, {"sha": "24198e1fc1142bc0234dcbad5f552347178fe294", "filename": "gcc/ada/mlib-tgt.ads", "status": "modified", "additions": 23, "deletions": 36, "changes": 59, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib-tgt.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-tgt.ads?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -36,14 +36,6 @@ with Prj; use Prj;\n \n package MLib.Tgt is\n \n-   type Library_Support is (None, Static_Only, Full);\n-   --  Support for Library Project File.\n-   --  - None: Library Project Files are not supported at all\n-   --  - Static_Only: Library Project Files are only supported for static\n-   --    libraries.\n-   --  - Full: Library Project Files are supported for static and dynamic\n-   --    (shared) libraries.\n-\n    function Support_For_Libraries return Library_Support;\n    --  Indicates how building libraries by gnatmake is supported by the GNAT\n    --  implementation for the platform.\n@@ -113,29 +105,20 @@ package MLib.Tgt is\n \n    procedure Build_Dynamic_Library\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n       Symbol_Data  : Symbol_Record;\n-      Driver_Name  : Name_Id  := No_Name;\n-      Lib_Version  : String   := \"\";\n-      Auto_Init    : Boolean  := False);\n+      Driver_Name  : Name_Id := No_Name;\n+      Lib_Version  : String  := \"\";\n+      Auto_Init    : Boolean := False);\n    --  Build a dynamic/relocatable library\n    --\n    --  Ofiles is the list of all object files in the library\n    --\n-   --  Foreign is the list of non Ada object files (also included in Ofiles)\n-   --\n-   --  Afiles is the list of ALI files for the Ada object files\n-   --\n-   --  Options and Options_2 are lists of options to be passed to the tool\n-   --  (gcc or other) that effectively builds the dynamic library. Options\n-   --  are passed before the object files, Options_2 are passed after the\n-   --  object files.\n+   --  Options is a list of options to be passed to the tool\n+   --  (gcc or other) that effectively builds the dynamic library.\n    --\n    --  Interfaces is the list of ALI files for the interfaces of a SAL.\n    --  It is empty if the library is not a SAL.\n@@ -155,9 +138,9 @@ package MLib.Tgt is\n    --  Symbol_Data is used for some patforms, including VMS, to generate\n    --  the symbols to be exported by the library.\n    --\n-   --  Note: Depending on the OS, some of the parameters may not be taken\n-   --  into account. For example, on Linux, Foreign, Afiles Lib_Address and\n-   --  Relocatable are ignored.\n+   --  Note: Depending on the OS, some of the parameters may not be taken into\n+   --  account. For example, on Linux, Interfaces, Symbol_Data and Auto_Init\n+   --  are ignored.\n \n    function Library_Exists_For\n      (Project : Project_Id; In_Tree : Project_Tree_Ref) return Boolean;\n@@ -170,7 +153,16 @@ package MLib.Tgt is\n    --  Returns the file name of the library file of a library project.\n    --  This function can only be called for library projects.\n \n+   function Library_Major_Minor_Id_Supported return Boolean;\n+   --  Indicates if major and minor ids are supported for libraries.\n+   --  If they are supported, then a Library_Version such as libtoto.so.1.2\n+   --  will have a major id of 1 and a minor id of 2. Then litoto.so,\n+   --  libtoto.so.1 and libtoto.so.1.2 will be created, all three designating\n+   --  the same file.\n+\n private\n+   No_Argument_List : constant Argument_List := (1 .. 0 => null);\n+\n    --  Access to subprogram types for indirection\n \n    type String_Function is access function return String;\n@@ -179,27 +171,20 @@ private\n      return String_List_Access;\n    type Build_Dynamic_Library_Function is access procedure\n      (Ofiles       : Argument_List;\n-      Foreign      : Argument_List;\n-      Afiles       : Argument_List;\n       Options      : Argument_List;\n-      Options_2    : Argument_List;\n       Interfaces   : Argument_List;\n       Lib_Filename : String;\n       Lib_Dir      : String;\n       Symbol_Data  : Symbol_Record;\n       Driver_Name  : Name_Id := No_Name;\n       Lib_Version  : String  := \"\";\n       Auto_Init    : Boolean := False);\n-\n    type Library_Exists_For_Function is access function\n      (Project : Project_Id; In_Tree : Project_Tree_Ref) return Boolean;\n-\n    type Library_File_Name_For_Function is access function\n      (Project : Project_Id;\n       In_Tree : Project_Tree_Ref) return File_Name_Type;\n-\n    type Boolean_Function is access function return Boolean;\n-\n    type Library_Support_Function is access function return Library_Support;\n \n    function Archive_Builder_Default return String;\n@@ -210,10 +195,8 @@ private\n                                    Archive_Builder_Options_Default'Access;\n \n    function Archive_Builder_Append_Options_Default return String_List_Access;\n-\n-   Archive_Builder_Append_Options_Ptr :\n-     String_List_Access_Function :=\n-       Archive_Builder_Append_Options_Default'Access;\n+   Archive_Builder_Append_Options_Ptr : String_List_Access_Function :=\n+                                Archive_Builder_Append_Options_Default'Access;\n \n    function Archive_Ext_Default return String;\n    Archive_Ext_Ptr : String_Function := Archive_Ext_Default'Access;\n@@ -276,4 +259,8 @@ private\n    function Support_For_Libraries_Default return Library_Support;\n    Support_For_Libraries_Ptr : Library_Support_Function :=\n                                  Support_For_Libraries_Default'Access;\n+\n+   function Library_Major_Minor_Id_Supported_Default return Boolean;\n+   Library_Major_Minor_Id_Supported_Ptr : Boolean_Function :=\n+             Library_Major_Minor_Id_Supported_Default'Access;\n end MLib.Tgt;"}, {"sha": "3d261b71bd3148083a7f88eddf5a5deae308a0b4", "filename": "gcc/ada/mlib.adb", "status": "modified", "additions": 137, "deletions": 7, "changes": 144, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -26,6 +26,7 @@\n \n with Ada.Characters.Handling; use Ada.Characters.Handling;\n with Interfaces.C.Strings;\n+with System;\n \n with Hostparm;\n with Opt;\n@@ -45,12 +46,9 @@ package body MLib is\n \n    procedure Build_Library\n      (Ofiles      : Argument_List;\n-      Afiles      : Argument_List;\n       Output_File : String;\n       Output_Dir  : String)\n    is\n-      pragma Warnings (Off, Afiles);\n-\n    begin\n       if Opt.Verbose_Mode and not Opt.Quiet_Output then\n          Write_Line (\"building a library...\");\n@@ -123,6 +121,8 @@ package body MLib is\n          end if;\n       end Verbose_Copy;\n \n+   --  Start of processing for Copy_ALI_Files\n+\n    begin\n       if Interfaces'Length = 0 then\n \n@@ -152,6 +152,7 @@ package body MLib is\n \n             declare\n                File_Name : String := Base_Name (Files (Index).all);\n+\n             begin\n                Canonical_Case_File_Name (File_Name);\n \n@@ -214,9 +215,9 @@ package body MLib is\n                         end loop;\n \n                         --  We are done with the input file, so we close it\n+                        --  ignoring any bad status.\n \n                         Close (FD, Status);\n-                        --  We simply ignore any bad status\n \n                         P_Line_Found := False;\n \n@@ -274,11 +275,10 @@ package body MLib is\n                      end if;\n                   end;\n \n-               else\n-                  --  This is not an interface ALI\n+               --  This is not an interface ALI\n \n+               else\n                   Success := True;\n-\n                end if;\n             end;\n \n@@ -289,6 +289,76 @@ package body MLib is\n       end if;\n    end Copy_ALI_Files;\n \n+   ----------------------\n+   -- Create_Sym_Links --\n+   ----------------------\n+\n+   procedure Create_Sym_Links\n+     (Lib_Path    : String;\n+      Lib_Version : String;\n+      Lib_Dir     : String;\n+      Maj_Version : String)\n+   is\n+      function Symlink\n+        (Oldpath : System.Address;\n+         Newpath : System.Address) return Integer;\n+      pragma Import (C, Symlink, \"__gnat_symlink\");\n+\n+      Success      : Boolean;\n+      Version_Path : String_Access;\n+\n+      Result : Integer;\n+      pragma Unreferenced (Result);\n+\n+   begin\n+      if Is_Absolute_Path (Lib_Version) then\n+         Version_Path := new String (1 .. Lib_Version'Length + 1);\n+         Version_Path (1 .. Lib_Version'Length) := Lib_Version;\n+\n+      else\n+         Version_Path :=\n+           new String (1 .. Lib_Dir'Length + 1 + Lib_Version'Length + 1);\n+         Version_Path (1 .. Version_Path'Last - 1) :=\n+           Lib_Dir & Directory_Separator & Lib_Version;\n+      end if;\n+\n+      Version_Path (Version_Path'Last) := ASCII.NUL;\n+\n+      if Maj_Version'Length = 0 then\n+         declare\n+            Newpath : String (1 .. Lib_Path'Length + 1);\n+         begin\n+            Newpath (1 .. Lib_Path'Length) := Lib_Path;\n+            Newpath (Newpath'Last)         := ASCII.NUL;\n+            Delete_File (Lib_Path, Success);\n+            Result := Symlink (Version_Path (1)'Address, Newpath'Address);\n+         end;\n+\n+      else\n+         declare\n+            Newpath1 : String (1 .. Lib_Path'Length + 1);\n+            Maj_Path : constant String :=\n+                         Lib_Dir & Directory_Separator & Maj_Version;\n+            Newpath2 : String (1 .. Maj_Path'Length + 1);\n+\n+         begin\n+            Newpath1 (1 .. Lib_Path'Length) := Lib_Path;\n+            Newpath1 (Newpath1'Last)        := ASCII.NUL;\n+\n+            Newpath2 (1 .. Maj_Path'Length) := Maj_Path;\n+            Newpath2 (Newpath2'Last)        := ASCII.NUL;\n+\n+            Delete_File (Maj_Path, Success);\n+\n+            Result := Symlink (Version_Path (1)'Address, Newpath2'Address);\n+\n+            Delete_File (Lib_Path, Success);\n+\n+            Result := Symlink (Newpath2'Address, Newpath1'Address);\n+         end;\n+      end if;\n+   end Create_Sym_Links;\n+\n    --------------------------------\n    -- Linker_Library_Path_Option --\n    --------------------------------\n@@ -311,6 +381,66 @@ package body MLib is\n       end if;\n    end Linker_Library_Path_Option;\n \n+   -------------------\n+   -- Major_Id_Name --\n+   -------------------\n+\n+   function Major_Id_Name\n+     (Lib_Filename : String;\n+      Lib_Version  : String)\n+      return String\n+   is\n+      Maj_Version : constant String := Lib_Version;\n+      Last_Maj    : Positive;\n+      Last        : Positive;\n+      Ok_Maj      : Boolean := False;\n+\n+   begin\n+      Last_Maj := Maj_Version'Last;\n+      while Last_Maj > Maj_Version'First loop\n+         if Maj_Version (Last_Maj) in '0' .. '9' then\n+            Last_Maj := Last_Maj - 1;\n+\n+         else\n+            Ok_Maj := Last_Maj /= Maj_Version'Last and then\n+            Maj_Version (Last_Maj) = '.';\n+\n+            if Ok_Maj then\n+               Last_Maj := Last_Maj - 1;\n+            end if;\n+\n+            exit;\n+         end if;\n+      end loop;\n+\n+      if Ok_Maj then\n+         Last := Last_Maj;\n+         while Last > Maj_Version'First loop\n+            if Maj_Version (Last) in '0' .. '9' then\n+               Last := Last - 1;\n+\n+            else\n+               Ok_Maj := Last /= Last_Maj and then\n+               Maj_Version (Last) = '.';\n+\n+               if Ok_Maj then\n+                  Last := Last - 1;\n+                  Ok_Maj :=\n+                    Maj_Version (Maj_Version'First .. Last) = Lib_Filename;\n+               end if;\n+\n+               exit;\n+            end if;\n+         end loop;\n+      end if;\n+\n+      if Ok_Maj then\n+         return Maj_Version (Maj_Version'First .. Last_Maj);\n+      else\n+         return \"\";\n+      end if;\n+   end Major_Id_Name;\n+\n --  Package elaboration\n \n begin"}, {"sha": "dec1167e8540a151a4a6a6d40c4148157e22b0d4", "filename": "gcc/ada/mlib.ads", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fmlib.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib.ads?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -34,6 +34,9 @@ with GNAT.OS_Lib; use GNAT.OS_Lib;\n \n package MLib is\n \n+   No_Argument_List : aliased String_List := (1 .. 0 => null);\n+   No_Argument      : constant String_List_Access := No_Argument_List'Access;\n+\n    Max_Characters_In_Library_Name : constant := 20;\n    --  Maximum number of characters in a library name.\n    --  Used by Check_Library_Name below.\n@@ -54,7 +57,6 @@ package MLib is\n \n    procedure Build_Library\n      (Ofiles      : Argument_List;\n-      Afiles      : Argument_List;\n       Output_File : String;\n       Output_Dir  : String);\n    --  Build a static library from a set of object files\n@@ -66,11 +68,24 @@ package MLib is\n    --  Copy all ALI files Files to directory To.\n    --  Mark Interfaces ALI files as interfaces, if any.\n \n+   procedure Create_Sym_Links\n+     (Lib_Path    : String;\n+      Lib_Version : String;\n+      Lib_Dir     : String;\n+      Maj_Version : String);\n+\n    function Linker_Library_Path_Option return String_Access;\n    --  Linker option to specify to the linker the library directory path.\n    --  If non null, the library directory path is to be appended.\n    --  Should be deallocated by the caller, when no longer needed.\n \n+   function Major_Id_Name\n+     (Lib_Filename : String;\n+      Lib_Version  : String) return String;\n+   --  Returns the major id library file name, if it exists.\n+   --  For example, if Lib_Filename is \"libtoto.so\" and Lib_Version is\n+   --  \"libtoto.so.1.2\", then \"libtoto.so.1\" is returned.\n+\n private\n \n    Preserve : Attribute := Time_Stamps;"}, {"sha": "91acd0e001c7accaaf692c2502e38a0d3330df6f", "filename": "gcc/ada/sinput-p.adb", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fsinput-p.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fsinput-p.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsinput-p.adb?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 1992-2006, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2007, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -32,7 +32,8 @@ package body Sinput.P is\n    First : Boolean := True;\n    --  Flag used when Load_Project_File is called the first time,\n    --  to set Main_Source_File.\n-   --  The flag is reset to False at the first call to Load_Project_File\n+   --  The flag is reset to False at the first call to Load_Project_File.\n+   --  Calling Reset_First sets it back to True.\n \n    -----------------------\n    -- Load_Project_File --\n@@ -52,6 +53,15 @@ package body Sinput.P is\n       return X;\n    end Load_Project_File;\n \n+   -----------------\n+   -- Reset_First --\n+   -----------------\n+\n+   procedure Reset_First is\n+   begin\n+      First := True;\n+   end Reset_First;\n+\n    --------------------------------\n    -- Restore_Project_Scan_State --\n    --------------------------------"}, {"sha": "83cba80251c31f1cbe2f6920ec90157b77d28e21", "filename": "gcc/ada/sinput-p.ads", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fsinput-p.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2cd44f5a448ad1e160edae120cc7b945ca1a5db3/gcc%2Fada%2Fsinput-p.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsinput-p.ads?ref=2cd44f5a448ad1e160edae120cc7b945ca1a5db3", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 1992-2002, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2007, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -36,6 +36,11 @@ package Sinput.P is\n    --  Load into memory the source of a project source file.\n    --  Initialize the Scans state.\n \n+   procedure Reset_First;\n+   --  Indicate that the next project loaded should be considered as the first\n+   --  one, so that Sinput.Main_Source_File is set for this project file. This\n+   --  is to get the correct number of lines when error finalization is called.\n+\n    function Source_File_Is_Subunit (X : Source_File_Index) return Boolean;\n    --  This function determines if a source file represents a subunit. It\n    --  works by scanning for the first compilation unit token, and returning"}]}