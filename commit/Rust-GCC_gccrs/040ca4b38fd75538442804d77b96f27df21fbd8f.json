{"sha": "040ca4b38fd75538442804d77b96f27df21fbd8f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDQwY2E0YjM4ZmQ3NTUzODQ0MjgwNGQ3N2I5NmYyN2RmMjFmYmQ4Zg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2009-11-06T03:33:17Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2009-11-06T03:33:17Z"}, "message": "re PR c++/7046 (#pragma pack(1) context evaluated at point of instantiation rather than declaration)\n\n\tPR c++/7046\n\t* class.c (finish_struct): Store maximum_field_alignment in\n\tTYPE_PRECISION.\n\t* pt.c (instantiate_class_template): Set maximum_field_alignment.\n\nFrom-SVN: r153959", "tree": {"sha": "7ebc951476c81c98d39e8f49916832f1dc4ea217", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7ebc951476c81c98d39e8f49916832f1dc4ea217"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/040ca4b38fd75538442804d77b96f27df21fbd8f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/040ca4b38fd75538442804d77b96f27df21fbd8f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/040ca4b38fd75538442804d77b96f27df21fbd8f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/040ca4b38fd75538442804d77b96f27df21fbd8f/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "2395cd2e91cda97a8d0bad70134f12534d4d3562", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2395cd2e91cda97a8d0bad70134f12534d4d3562", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2395cd2e91cda97a8d0bad70134f12534d4d3562"}], "stats": {"total": 53, "additions": 53, "deletions": 0}, "files": [{"sha": "98cca71b56c09b151df5c0783ea7ae2371db7989", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=040ca4b38fd75538442804d77b96f27df21fbd8f", "patch": "@@ -1,5 +1,10 @@\n 2009-11-05  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/7046\n+\t* class.c (finish_struct): Store maximum_field_alignment in\n+\tTYPE_PRECISION.\n+\t* pt.c (instantiate_class_template): Set maximum_field_alignment.\n+\n \tPR c++/34870\n \t* name-lookup.c (arg_assoc_class): Call complete_type.\n \t* pt.c (instantiate_class_template): Call uses_template_parms"}, {"sha": "4020144e8156d040229443dcf89366df6a598373", "filename": "gcc/cp/class.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=040ca4b38fd75538442804d77b96f27df21fbd8f", "patch": "@@ -5516,6 +5516,9 @@ finish_struct (tree t, tree attributes)\n \tif (DECL_PURE_VIRTUAL_P (x))\n \t  VEC_safe_push (tree, gc, CLASSTYPE_PURE_VIRTUALS (t), x);\n       complete_vars (t);\n+\n+      /* Remember current #pragma pack value.  */\n+      TYPE_PRECISION (t) = maximum_field_alignment;\n     }\n   else\n     finish_struct_1 (t);"}, {"sha": "75180eabbe82d93d653e73c495b1d3c4f3dad208", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=040ca4b38fd75538442804d77b96f27df21fbd8f", "patch": "@@ -7352,6 +7352,7 @@ instantiate_class_template (tree type)\n   tree typedecl;\n   tree pbinfo;\n   tree base_list;\n+  unsigned int saved_maximum_field_alignment;\n \n   if (type == error_mark_node)\n     return error_mark_node;\n@@ -7412,6 +7413,9 @@ instantiate_class_template (tree type)\n   push_deferring_access_checks (dk_no_deferred);\n \n   push_to_top_level ();\n+  /* Use #pragma pack from the template context.  */\n+  saved_maximum_field_alignment = maximum_field_alignment;\n+  maximum_field_alignment = TYPE_PRECISION (pattern);\n \n   SET_CLASSTYPE_INTERFACE_UNKNOWN (type);\n \n@@ -7827,6 +7831,7 @@ instantiate_class_template (tree type)\n   perform_typedefs_access_check (pattern, args);\n   perform_deferred_access_checks ();\n   pop_nested_class ();\n+  maximum_field_alignment = saved_maximum_field_alignment;\n   pop_from_top_level ();\n   pop_deferring_access_checks ();\n   pop_tinst_level ();"}, {"sha": "6d1786aa17b299fe3ad59d9bd750af30d09d6eff", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=040ca4b38fd75538442804d77b96f27df21fbd8f", "patch": "@@ -1,5 +1,8 @@\n 2009-11-05  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/7046\n+\t* g++.dg/abi/pragma-pack1.C: New.\n+\n \tPR c++/34870\n \t* g++.dg/lookup/koenig7.C: New.\n "}, {"sha": "d90fc200cbf36765cc4b01b32b259752af77c9ca", "filename": "gcc/testsuite/g++.dg/abi/pragma-pack1.C", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fpragma-pack1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/040ca4b38fd75538442804d77b96f27df21fbd8f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fpragma-pack1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fpragma-pack1.C?ref=040ca4b38fd75538442804d77b96f27df21fbd8f", "patch": "@@ -0,0 +1,37 @@\n+// PR c++/7046\n+\n+extern \"C\" int printf (const char *, ...);\n+\n+#pragma pack(4)\n+\n+template <typename X >\n+struct T\n+{\n+    char      x1;   /* Usually 3 padding bytes are added after x1 member. */\n+    int       x2;\n+};\n+\n+template <class T>\n+int f()\n+{\n+  struct A { char i1; int i2; };\n+  return sizeof (A);\n+}\n+\n+#pragma pack(1)\n+template struct T<int>;   /* T<int> is instantiated here */\n+template int f<int>();\n+\n+#pragma pack(4)\n+template struct T<float>; /* T<float> is instantiated here */\n+template int f<double>();\n+\n+int main()\n+{\n+  printf(\"sizeof T<int>   = %d\\n\", sizeof(T<int>));\n+  printf(\"sizeof T<float> = %d\\n\", sizeof(T<float>));\n+  printf(\"f<int>()        = %d\\n\", f<int>());\n+  printf(\"f<float>()      = %d\\n\", f<float>());\n+  return (sizeof(T<int>) != sizeof(T<float>)\n+\t  || f<int>() != f<float>());\n+}"}]}