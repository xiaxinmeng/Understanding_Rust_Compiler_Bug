{"sha": "dcd59a994affdd191d7025269b18a1043f80a47f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGNkNTlhOTk0YWZmZGQxOTFkNzAyNTI2OWIxOGExMDQzZjgwYTQ3Zg==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2019-07-04T08:05:03Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-04T08:05:03Z"}, "message": "[Ada] Spurious dimensionality error on aggregate with \"others\" assoc.\n\nThis patch fixes a spurious dimensionality error on an array aggregate\nwith a single \"others' clause whose expression is a dimensioned entity,\nThe expansion of the aggregate may create copies of the expression, and\nthe dimensionality check must use the type of the expression to retrieve\nthe proper dimension information to check against the dimensions of the\narray component type.\n\n2019-07-04  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_dim.adb (Analyze_Dimension_Array_Aggregate): If the\n\tcomponent is an entity name, its dimensions are those of its\n\ttype.\n\ngcc/testsuite/\n\n\t* gnat.dg/dimensions2.adb, gnat.dg/dimensions2_phys.ads,\n\tgnat.dg/dimensions2_real_numbers.ads: New testcase.\n\nFrom-SVN: r273043", "tree": {"sha": "c4d4b85eb61b80dc45905445311c72dce2f31268", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c4d4b85eb61b80dc45905445311c72dce2f31268"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dcd59a994affdd191d7025269b18a1043f80a47f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dcd59a994affdd191d7025269b18a1043f80a47f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dcd59a994affdd191d7025269b18a1043f80a47f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dcd59a994affdd191d7025269b18a1043f80a47f/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "ee7904e91fcdafd4211f89e0244354467d78a3c2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ee7904e91fcdafd4211f89e0244354467d78a3c2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ee7904e91fcdafd4211f89e0244354467d78a3c2"}], "stats": {"total": 129, "additions": 126, "deletions": 3}, "files": [{"sha": "62f031cb5cfb4deb300ef99821dc69a4da48dba1", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=dcd59a994affdd191d7025269b18a1043f80a47f", "patch": "@@ -1,3 +1,9 @@\n+2019-07-04  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_dim.adb (Analyze_Dimension_Array_Aggregate): If the\n+\tcomponent is an entity name, its dimensions are those of its\n+\ttype.\n+\n 2019-07-03  Bob Duff  <duff@adacore.com>\n \n \t* doc/gnat_ugn/gnat_utility_programs.rst: Document new flags in"}, {"sha": "26c8008b573d4a3901396df397d97ce5a5cdf8a5", "filename": "gcc/ada/sem_dim.adb", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Fada%2Fsem_dim.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Fada%2Fsem_dim.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_dim.adb?ref=dcd59a994affdd191d7025269b18a1043f80a47f", "patch": "@@ -1233,8 +1233,9 @@ package body Sem_Dim is\n       Dims_Of_Comp_Typ : constant Dimension_Type := Dimensions_Of (Comp_Typ);\n       Exps             : constant List_Id        := Expressions (N);\n \n-      Comp : Node_Id;\n-      Expr : Node_Id;\n+      Comp         : Node_Id;\n+      Dims_Of_Expr : Dimension_Type;\n+      Expr         : Node_Id;\n \n       Error_Detected : Boolean := False;\n       --  This flag is used in order to indicate if an error has been detected\n@@ -1281,11 +1282,19 @@ package body Sem_Dim is\n          --  (may happen when an aggregate is converted into a positional\n          --  aggregate). We also must verify that this is a scalar component,\n          --  and not a subaggregate of a multidimensional aggregate.\n+         --  The expression may be an identifier that has been copied several\n+         --  times during expansion, its dimensions are those of its type.\n+\n+         if Is_Entity_Name (Expr) then\n+            Dims_Of_Expr := Dimensions_Of (Etype (Expr));\n+         else\n+            Dims_Of_Expr := Dimensions_Of (Expr);\n+         end if;\n \n          if Comes_From_Source (Original_Node (Expr))\n            and then Present (Etype (Expr))\n            and then Is_Numeric_Type (Etype (Expr))\n-           and then Dimensions_Of (Expr) /= Dims_Of_Comp_Typ\n+           and then Dims_Of_Expr /= Dims_Of_Comp_Typ\n            and then Sloc (Comp) /= Sloc (Prev (Comp))\n          then\n             --  Check if an error has already been encountered so far"}, {"sha": "714748238dae40dd37a9927460b5f7c4ded9b13a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=dcd59a994affdd191d7025269b18a1043f80a47f", "patch": "@@ -1,3 +1,8 @@\n+2019-07-04  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/dimensions2.adb, gnat.dg/dimensions2_phys.ads,\n+\tgnat.dg/dimensions2_real_numbers.ads: New testcase.\n+\n 2019-07-04  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR tree-optimization/91063"}, {"sha": "630a44fb152fc9e062acf457c539ba64c92e1bd2", "filename": "gcc/testsuite/gnat.dg/dimensions2.adb", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2.adb?ref=dcd59a994affdd191d7025269b18a1043f80a47f", "patch": "@@ -0,0 +1,20 @@\n+--  { dg-do compile }\n+\n+with Dimensions2_phys; use Dimensions2_phys;\n+\n+procedure Dimensions2 is\n+\n+   zero_flow : constant Volumetric_Flow := 0.0 * m**3 / h;\n+   type Node_Flow_Scenario_T is array (Positive range <>)\n+          of Volumetric_Flow with\n+            default_component_value => zero_flow;\n+   subtype Max_Node_Flow_Scenario_T\n+       is Node_Flow_Scenario_T (Natural (1) .. 48);\n+   flow_value_array : Max_Node_Flow_Scenario_T  := (1..48 => zero_flow);\n+   flow_value_array1 : Max_Node_Flow_Scenario_T\n+        := (Max_Node_Flow_Scenario_T'Range=> zero_flow);\n+   flow_value_array2 : Max_Node_Flow_Scenario_T  := (others => zero_flow);\n+\n+begin\n+    null;\n+end Dimensions2;"}, {"sha": "675352acce065143165df11131178424844cba2d", "filename": "gcc/testsuite/gnat.dg/dimensions2_phys.ads", "status": "added", "additions": 80, "deletions": 0, "changes": 80, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2_phys.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2_phys.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2_phys.ads?ref=dcd59a994affdd191d7025269b18a1043f80a47f", "patch": "@@ -0,0 +1,80 @@\n+with ada.numerics.generic_elementary_functions;\n+with Dimensions2_real_numbers;\n+\n+package Dimensions2_Phys is\n+\n+   type si_type is new Dimensions2_real_numbers.Real with\n+      dimension_system =>\n+      ((unit_name => meter, unit_symbol => 'm', dim_symbol => 'L'),\n+       (unit_name => kilogram, unit_symbol => \"kg\", dim_symbol => 'M'),\n+       (unit_name => second, unit_symbol => 's', dim_symbol => 'T'),\n+       (unit_name => ampere, unit_symbol => 'A', dim_symbol => 'I'),\n+       (unit_name => kelvin, unit_symbol => 'K', dim_symbol => \"Theta\"),\n+       (unit_name => mole, unit_symbol => \"mol\", dim_symbol => 'N'),\n+       (unit_name => euro, unit_symbol => \"EUR\", dim_symbol => 'E'));\n+\n+   subtype distance is Si_Type with\n+        dimension => (symbol => 'm', meter => 1, others => 0);\n+\n+   subtype mass is Si_Type with\n+        dimension => (symbol => \"kg\", kilogram => 1, others => 0);\n+\n+   subtype time is Si_Type with\n+        dimension => (symbol => 's', second => 1, others => 0);\n+\n+   subtype electric_current is Si_Type with\n+        dimension => (symbol => 'A', ampere => 1, others => 0);\n+\n+   subtype temperature is Si_Type with\n+        dimension => (symbol => 'K', kelvin => 1, others => 0);\n+\n+   subtype amount_of_substance is Si_Type with\n+        dimension => (symbol => \"mol\", mole => 1, others => 0);\n+\n+   pragma warnings (off, \"*assumed to be*\");\n+   subtype pressure_barg is Dimensions2_real_numbers.Real;\n+   m : constant Distance := 1.0;\n+   kg : constant Mass := 1.0;\n+   s : constant Time := 1.0;\n+   a : constant Electric_Current := 1.0;\n+   k : constant Temperature := 1.0;\n+   mol : constant Amount_Of_Substance := 1.0;\n+   min : constant Time := 1.0;\n+   h : constant Time := 60.0 * min;\n+\n+   subtype frequency is Si_Type with\n+        dimension => (symbol => \"Hz\", second => -1, others => 0);\n+\n+   subtype massflow is Si_Type with\n+     dimension => (symbol => \"kg/s\",\n+       kilogram => 1, second => -1, others => 0);\n+\n+   subtype molar_heat_capacity is Si_Type with\n+     dimension => (symbol => \"J/(K*mol)\", meter => 2, kilogram => 1,\n+       second => -2, kelvin => -1, mole => -1, others => 0);\n+\n+   subtype molar_flow is Si_Type with\n+      dimension => (symbol => \"mol/s\", second => -1, mole => 1, others => 0);\n+\n+   subtype pressure is Si_Type with\n+    dimension =>\n+     (symbol => \"Pa\", meter => -1, kilogram => 1, second => -2, others => 0);\n+\n+   subtype ratio is Si_Type range 0.0 .. 1.0;\n+\n+   subtype scalar is Si_Type;\n+\n+   subtype specific_heat_capacity is Si_Type with\n+     dimension => (symbol => \"J/(K*kg)\", meter => 2, second => -2,\n+       kelvin => -1, others => 0);\n+\n+   subtype speed is Si_Type with\n+     dimension => (symbol => \"m/s\", meter => 1, second => -1, others => 0);\n+\n+   subtype volume is Si_Type with\n+        dimension => (symbol => \"m^3\", meter => 3, others => 0);\n+\n+   subtype volumetric_flow is Si_Type with\n+     dimension => (symbol => \"m^3/s\", meter => 3, second => -1, others => 0);\n+\n+end Dimensions2_Phys;"}, {"sha": "e7cda0b216349fbe9487704aebe704677b189761", "filename": "gcc/testsuite/gnat.dg/dimensions2_real_numbers.ads", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2_real_numbers.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcd59a994affdd191d7025269b18a1043f80a47f/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2_real_numbers.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fdimensions2_real_numbers.ads?ref=dcd59a994affdd191d7025269b18a1043f80a47f", "patch": "@@ -0,0 +1,3 @@\n+package Dimensions2_Real_Numbers is\n+  type Real is new Long_Float;\n+end;"}]}