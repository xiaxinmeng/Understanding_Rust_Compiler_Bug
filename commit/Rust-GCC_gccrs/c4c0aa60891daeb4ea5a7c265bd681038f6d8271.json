{"sha": "c4c0aa60891daeb4ea5a7c265bd681038f6d8271", "node_id": "C_kwDOANBUbNoAKGM0YzBhYTYwODkxZGFlYjRlYTVhN2MyNjViZDY4MTAzOGY2ZDgyNzE", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-02-15T10:18:56Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-02-15T10:18:56Z"}, "message": "sanitizer: Use glibc _thread_db_sizeof_pthread symbol if present\n\nI've cherry-picked following fix from llvm-project.  Recent glibcs\nhave _thread_db_sizeof_pthread symbol variable which contains the\nsize of struct pthread, so that sanitizers don't need to guess that\nand risk that it will change again.\n\n2022-02-15  Jakub Jelinek  <jakub@redhat.com>\n\n\t* sanitizer_common/sanitizer_linux_libcdep.cpp: Cherry-pick\n\tllvm-project revision ef14b78d9a144ba81ba02083fe21eb286a88732b.", "tree": {"sha": "9b1c1346d4e113f35e571099a3c797b7a062626d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9b1c1346d4e113f35e571099a3c797b7a062626d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c4c0aa60891daeb4ea5a7c265bd681038f6d8271", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4c0aa60891daeb4ea5a7c265bd681038f6d8271", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c4c0aa60891daeb4ea5a7c265bd681038f6d8271", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c4c0aa60891daeb4ea5a7c265bd681038f6d8271/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a0d6e7ca9b9e338e82572db79c26168684a7441", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a0d6e7ca9b9e338e82572db79c26168684a7441", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6a0d6e7ca9b9e338e82572db79c26168684a7441"}], "stats": {"total": 21, "additions": 16, "deletions": 5}, "files": [{"sha": "0c260b6b516a906abc14be459f71e574fdd534ad", "filename": "libsanitizer/sanitizer_common/sanitizer_linux_libcdep.cpp", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c4c0aa60891daeb4ea5a7c265bd681038f6d8271/libsanitizer%2Fsanitizer_common%2Fsanitizer_linux_libcdep.cpp", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c4c0aa60891daeb4ea5a7c265bd681038f6d8271/libsanitizer%2Fsanitizer_common%2Fsanitizer_linux_libcdep.cpp", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libsanitizer%2Fsanitizer_common%2Fsanitizer_linux_libcdep.cpp?ref=c4c0aa60891daeb4ea5a7c265bd681038f6d8271", "patch": "@@ -220,10 +220,8 @@ void InitTlsSize() { }\n // sizeof(struct pthread) from glibc.\n static atomic_uintptr_t thread_descriptor_size;\n \n-uptr ThreadDescriptorSize() {\n-  uptr val = atomic_load_relaxed(&thread_descriptor_size);\n-  if (val)\n-    return val;\n+static uptr ThreadDescriptorSizeFallback() {\n+  uptr val = 0;\n #if defined(__x86_64__) || defined(__i386__) || defined(__arm__)\n   int major;\n   int minor;\n@@ -285,8 +283,21 @@ uptr ThreadDescriptorSize() {\n #elif defined(__powerpc64__)\n   val = 1776; // from glibc.ppc64le 2.20-8.fc21\n #endif\n+  return val;\n+}\n+\n+uptr ThreadDescriptorSize() {\n+  uptr val = atomic_load_relaxed(&thread_descriptor_size);\n   if (val)\n-    atomic_store_relaxed(&thread_descriptor_size, val);\n+    return val;\n+  // _thread_db_sizeof_pthread is a GLIBC_PRIVATE symbol that is exported in\n+  // glibc 2.34 and later.\n+  if (unsigned *psizeof = static_cast<unsigned *>(\n+          dlsym(RTLD_DEFAULT, \"_thread_db_sizeof_pthread\")))\n+    val = *psizeof;\n+  if (!val)\n+    val = ThreadDescriptorSizeFallback();\n+  atomic_store_relaxed(&thread_descriptor_size, val);\n   return val;\n }\n "}]}