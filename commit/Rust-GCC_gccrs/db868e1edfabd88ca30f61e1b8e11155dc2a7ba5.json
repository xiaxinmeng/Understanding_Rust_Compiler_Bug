{"sha": "db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGI4NjhlMWVkZmFiZDg4Y2EzMGY2MWUxYjhlMTExNTVkYzJhN2JhNQ==", "commit": {"author": {"name": "Olivier Hainque", "email": "hainque@adacore.com", "date": "2009-06-01T15:27:59Z"}, "committer": {"name": "Olivier Hainque", "email": "hainque@gcc.gnu.org", "date": "2009-06-01T15:27:59Z"}, "message": "utils.c (convert): When converting to the packable version of the type...\n\n\tada/\n\t* gcc-interface/utils.c (convert) <CONSTRUCTOR case>: When converting\n\tto the packable version of the type, clear TREE_STATIC/TREE_CONSTANT\n\ton the result if at least one of the input fields couldn't be output\n\tas a static constant any more.\n\n\ttestsuite/\n\t* gnat.dg/nested_float_packed.ads: New test.\n\n\nCo-Authored-By: Eric Botcazou <ebotcazou@adacore.com>\n\nFrom-SVN: r148049", "tree": {"sha": "ecb474a41df463273bc0efc8acb2f9b87af38038", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ecb474a41df463273bc0efc8acb2f9b87af38038"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/comments", "author": {"login": "hainque", "id": 18735142, "node_id": "MDQ6VXNlcjE4NzM1MTQy", "avatar_url": "https://avatars.githubusercontent.com/u/18735142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hainque", "html_url": "https://github.com/hainque", "followers_url": "https://api.github.com/users/hainque/followers", "following_url": "https://api.github.com/users/hainque/following{/other_user}", "gists_url": "https://api.github.com/users/hainque/gists{/gist_id}", "starred_url": "https://api.github.com/users/hainque/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hainque/subscriptions", "organizations_url": "https://api.github.com/users/hainque/orgs", "repos_url": "https://api.github.com/users/hainque/repos", "events_url": "https://api.github.com/users/hainque/events{/privacy}", "received_events_url": "https://api.github.com/users/hainque/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "62295314f0a1f3ddea8cf54a888c4b9b3a4bec68", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/62295314f0a1f3ddea8cf54a888c4b9b3a4bec68", "html_url": "https://github.com/Rust-GCC/gccrs/commit/62295314f0a1f3ddea8cf54a888c4b9b3a4bec68"}], "stats": {"total": 55, "additions": 55, "deletions": 0}, "files": [{"sha": "c3f7219fd6758e1424cb0ab6c6f4f1936c084dfe", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "patch": "@@ -1,3 +1,11 @@\n+2009-06-01  Olivier Hainque  <hainque@adacore.com>\n+            Eric Botcazou  <botcazou@adacore.com>\n+\t\n+\t* gcc-interface/utils.c (convert) <CONSTRUCTOR case>: When converting\n+\tto the packable version of the type, clear TREE_STATIC/TREE_CONSTANT\n+\ton the result if at least one of the input fields couldn't be output\n+\tas a static constant any more.\n+\n 2009-06-01  Olivier Hainque  <hainque@adacore.com>\n             Eric Botcazou  <botcazou@adacore.com>\n \t"}, {"sha": "f3755a016312f9aa93b8ada17945ec716265784d", "filename": "gcc/ada/gcc-interface/utils.c", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Fada%2Fgcc-interface%2Futils.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Fada%2Fgcc-interface%2Futils.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgcc-interface%2Futils.c?ref=db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "patch": "@@ -3979,6 +3979,10 @@ convert (tree type, tree expr)\n \t  unsigned HOST_WIDE_INT idx;\n \t  tree index, value;\n \n+\t  /* Whether we need to clear TREE_CONSTANT et al. on the output\n+\t     constructor when we convert in place.  */\n+\t  bool clear_constant = false;\n+\n \t  FOR_EACH_CONSTRUCTOR_ELT(e, idx, index, value)\n \t    {\n \t      constructor_elt *elt = VEC_quick_push (constructor_elt, v, NULL);\n@@ -3987,15 +3991,30 @@ convert (tree type, tree expr)\n \t\tbreak;\n \t      elt->index = field;\n \t      elt->value = convert (TREE_TYPE (field), value);\n+\n+\t      /* If packing has made this field a bitfield and the input\n+\t\t value couldn't be emitted statically any more, we need to\n+\t\t clear TREE_CONSTANT on our output.  */\n+\t      if (!clear_constant && TREE_CONSTANT (expr)\n+\t\t  && !CONSTRUCTOR_BITFIELD_P (efield)\n+\t\t  && CONSTRUCTOR_BITFIELD_P (field)\n+\t\t  && !initializer_constant_valid_for_bitfield_p (value))\n+\t\tclear_constant = true;\n+\n \t      efield = TREE_CHAIN (efield);\n \t      field = TREE_CHAIN (field);\n \t    }\n \n+\t  /* If we have been able to match and convert all the input fields\n+\t     to their output type, convert in place now.  We'll fallback to a\n+\t     view conversion downstream otherwise.  */\n \t  if (idx == len)\n \t    {\n \t      expr = copy_node (expr);\n \t      TREE_TYPE (expr) = type;\n \t      CONSTRUCTOR_ELTS (expr) = v;\n+\t      if (clear_constant)\n+\t\tTREE_CONSTANT (expr) = TREE_STATIC (expr) = false;\n \t      return expr;\n \t    }\n \t}"}, {"sha": "69613d1a36db11dc1dd9ca1b35a190023fb0f905", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "patch": "@@ -1,3 +1,7 @@\n+2009-06-01  Olivier Hainque  <hainque@adacore.com>\n+\n+\t* gnat.dg/nested_float_packed.ads: New test.\n+\n 2009-06-01  Olivier Hainque  <hainque@adacore.com>\n             Eric Botcazou  <botcazou@adacore.com>\n "}, {"sha": "ae7f52390684948a6a9429c8d0f82c03c88cb789", "filename": "gcc/testsuite/gnat.dg/nested_float_packed.ads", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Ftestsuite%2Fgnat.dg%2Fnested_float_packed.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/db868e1edfabd88ca30f61e1b8e11155dc2a7ba5/gcc%2Ftestsuite%2Fgnat.dg%2Fnested_float_packed.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fnested_float_packed.ads?ref=db868e1edfabd88ca30f61e1b8e11155dc2a7ba5", "patch": "@@ -0,0 +1,24 @@\n+-- { dg-do compile }\n+\n+package Nested_Float_Packed is\n+\n+   type Float_Type is record\n+      Value : Float;\n+      Valid : Boolean;\n+   end record;\n+\n+   type Data_Type is record\n+      Data : Float_Type;\n+   end record;\n+\n+   Default_Data : constant Data_Type :=\n+     (Data => (Value => 1.0, Valid => False));\n+\n+   type Range_Type is (RV1, RV2, RV3);\n+   for Range_Type use (1, 2, 3);\n+\n+   Data_Block : array (Range_Type)\n+     of Data_Type := (others => Default_Data);\n+end;\n+\n+"}]}