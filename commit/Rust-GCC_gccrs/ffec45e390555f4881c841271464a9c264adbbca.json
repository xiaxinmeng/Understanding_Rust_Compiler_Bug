{"sha": "ffec45e390555f4881c841271464a9c264adbbca", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmZlYzQ1ZTM5MDU1NWY0ODgxYzg0MTI3MTQ2NGE5YzI2NGFkYmJjYQ==", "commit": {"author": {"name": "Justin Squirek", "email": "squirek@adacore.com", "date": "2019-07-08T08:12:55Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-08T08:12:55Z"}, "message": "[Ada] Crash on Image and Value attributes\n\nThis patch fixes an issue whereby the creation of an enumeration within\npackage where Default_Scalar_Storage_Order is in effect may lead to a\ncrash when the attributes Image or Value are applied to objects of said\ntype or the type directly.\n\n2019-07-08  Justin Squirek  <squirek@adacore.com>\n\ngcc/ada/\n\n\t* exp_imgv.adb (Build_Enumeration_Image_Tables): Default SSO for\n\tthe building of image tables.\n\t(Expand_Image_Attribute): Minor cleanup.\n\ngcc/testsuite/\n\n\t* gnat.dg/sso16.adb: New testcase.\n\nFrom-SVN: r273199", "tree": {"sha": "d9a26463ee898d86646270a7aea40a0cc27f9692", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d9a26463ee898d86646270a7aea40a0cc27f9692"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ffec45e390555f4881c841271464a9c264adbbca", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ffec45e390555f4881c841271464a9c264adbbca", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ffec45e390555f4881c841271464a9c264adbbca", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ffec45e390555f4881c841271464a9c264adbbca/comments", "author": {"login": "AdaDoom3", "id": 3445599, "node_id": "MDQ6VXNlcjM0NDU1OTk=", "avatar_url": "https://avatars.githubusercontent.com/u/3445599?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AdaDoom3", "html_url": "https://github.com/AdaDoom3", "followers_url": "https://api.github.com/users/AdaDoom3/followers", "following_url": "https://api.github.com/users/AdaDoom3/following{/other_user}", "gists_url": "https://api.github.com/users/AdaDoom3/gists{/gist_id}", "starred_url": "https://api.github.com/users/AdaDoom3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AdaDoom3/subscriptions", "organizations_url": "https://api.github.com/users/AdaDoom3/orgs", "repos_url": "https://api.github.com/users/AdaDoom3/repos", "events_url": "https://api.github.com/users/AdaDoom3/events{/privacy}", "received_events_url": "https://api.github.com/users/AdaDoom3/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "0a90412010e4bd535df8c35d4bce95f321ebb6be", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0a90412010e4bd535df8c35d4bce95f321ebb6be", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0a90412010e4bd535df8c35d4bce95f321ebb6be"}], "stats": {"total": 103, "additions": 94, "deletions": 9}, "files": [{"sha": "528556acc8be0a95dbed9a5354e9c5e4d4c9b4e0", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=ffec45e390555f4881c841271464a9c264adbbca", "patch": "@@ -1,3 +1,9 @@\n+2019-07-08  Justin Squirek  <squirek@adacore.com>\n+\n+\t* exp_imgv.adb (Build_Enumeration_Image_Tables): Default SSO for\n+\tthe building of image tables.\n+\t(Expand_Image_Attribute): Minor cleanup.\n+\n 2019-07-08  Dmitriy Anisimkov  <anisimko@adacore.com>\n \n \t* libgnat/g-socket.ads, libgnat/g-socket.adb: Improve"}, {"sha": "a47de2fe3f1979b9e00838e10f9559f9893b3364", "filename": "gcc/ada/exp_imgv.adb", "status": "modified", "additions": 29, "deletions": 9, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Fada%2Fexp_imgv.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Fada%2Fexp_imgv.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_imgv.adb?ref=ffec45e390555f4881c841271464a9c264adbbca", "patch": "@@ -69,18 +69,23 @@ package body Exp_Imgv is\n    ------------------------------------\n \n    procedure Build_Enumeration_Image_Tables (E : Entity_Id; N : Node_Id) is\n-      Loc  : constant Source_Ptr := Sloc (E);\n-      Str  : String_Id;\n+      Loc : constant Source_Ptr := Sloc (E);\n+\n+      Eind : Entity_Id;\n+      Estr : Entity_Id;\n       Ind  : List_Id;\n+      Ityp : Node_Id;\n+      Len  : Nat;\n       Lit  : Entity_Id;\n       Nlit : Nat;\n-      Len  : Nat;\n-      Estr : Entity_Id;\n-      Eind : Entity_Id;\n-      Ityp : Node_Id;\n+      Str  : String_Id;\n+\n+      Saved_SSO : constant Character := Opt.Default_SSO;\n+      --  Used to save the current scalar storage order during the generation\n+      --  of the literal lookup table.\n \n    begin\n-      --  Nothing to do for other than a root enumeration type\n+      --  Nothing to do for types other than a root enumeration type\n \n       if E /= Root_Type (E) then\n          return;\n@@ -138,6 +143,15 @@ package body Exp_Imgv is\n       Set_Lit_Strings (E, Estr);\n       Set_Lit_Indexes (E, Eind);\n \n+      --  Temporarily set the current scalar storage order to the default\n+      --  during the generation of the literals table, since both the Image and\n+      --  Value attributes rely on runtime routines for interpreting table\n+      --  values.\n+\n+      Opt.Default_SSO := ' ';\n+\n+      --  Generate literal table\n+\n       Insert_Actions (N,\n         New_List (\n           Make_Object_Declaration (Loc,\n@@ -168,6 +182,10 @@ package body Exp_Imgv is\n               Make_Aggregate (Loc,\n                 Expressions => Ind))),\n         Suppress => All_Checks);\n+\n+      --  Reset the scalar storage order to the saved value\n+\n+      Opt.Default_SSO := Saved_SSO;\n    end Build_Enumeration_Image_Tables;\n \n    ----------------------------\n@@ -433,13 +451,13 @@ package body Exp_Imgv is\n \n       --  Local variables\n \n+      Enum_Case : Boolean;\n       Imid      : RE_Id;\n+      Proc_Ent  : Entity_Id;\n       Ptyp      : Entity_Id;\n       Rtyp      : Entity_Id;\n       Tent      : Entity_Id := Empty;\n       Ttyp      : Entity_Id;\n-      Proc_Ent  : Entity_Id;\n-      Enum_Case : Boolean;\n \n       Arg_List : List_Id;\n       --  List of arguments for run-time procedure call\n@@ -450,6 +468,8 @@ package body Exp_Imgv is\n       Snn : constant Entity_Id := Make_Temporary (Loc, 'S');\n       Pnn : constant Entity_Id := Make_Temporary (Loc, 'P');\n \n+   --  Start of processing for Expand_Image_Attribute\n+\n    begin\n       if Is_Object_Image (Pref) then\n          Rewrite_Object_Image (N, Pref, Name_Image, Standard_String);"}, {"sha": "744f782435523c30958d3754d515b90194e68081", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=ffec45e390555f4881c841271464a9c264adbbca", "patch": "@@ -1,3 +1,7 @@\n+2019-07-08  Justin Squirek  <squirek@adacore.com>\n+\n+\t* gnat.dg/sso16.adb: New testcase.\n+\n 2019-07-08  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/predicate8.adb, gnat.dg/predicate8_pkg.adb,"}, {"sha": "0480d916245361b6c51e40d94064748afc41f309", "filename": "gcc/testsuite/gnat.dg/sso16.adb", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Ftestsuite%2Fgnat.dg%2Fsso16.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ffec45e390555f4881c841271464a9c264adbbca/gcc%2Ftestsuite%2Fgnat.dg%2Fsso16.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fsso16.adb?ref=ffec45e390555f4881c841271464a9c264adbbca", "patch": "@@ -0,0 +1,55 @@\n+--  { dg-do run }\n+\n+with Ada.Text_IO; use Ada.Text_IO;\n+\n+procedure SSO16 is\n+\n+   pragma Default_Scalar_Storage_Order (High_Order_First);\n+\n+   type Enum_T is\n+     (Event_0,\n+      Event_1,\n+      Event_2,\n+      Event_3,\n+      Event_4,\n+      Event_5,\n+      Event_11,\n+      Event_12,\n+      Event_13,\n+      Event_14,\n+      Event_15,\n+      Event_21,\n+      Event_22,\n+      Event_23,\n+      Event_24,\n+      Event_25,\n+      Event_31,\n+      Event_32,\n+      Event_33,\n+      Event_34,\n+      Event_35,\n+      Event_41,\n+      Event_42,\n+      Event_43,\n+      Event_44,\n+      Event_45);\n+\n+   Var : Enum_T := Event_0;\n+\n+begin\n+   if Var'Image /= \"EVENT_0\" then\n+      raise Program_Error;\n+   end if;\n+\n+   if Enum_T'Value (\"Event_4\")'Image /= \"EVENT_4\" then\n+      raise Program_Error;\n+   end if;\n+\n+   if Enum_T'Val (20)'Image /= \"EVENT_35\" then\n+      raise Program_Error;\n+   end if;\n+\n+   if Enum_T'Pos (Enum_T'Value (\"Event_45\"))'Image /= \" 25\" then\n+      raise Program_Error;\n+   end if;\n+end;"}]}