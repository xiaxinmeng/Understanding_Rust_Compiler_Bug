{"sha": "7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6N2IyYWFmYzk1OWYxZWYyNGYxMTFlYjBkNTZiMzkzYmIyZDMxNWJiZg==", "commit": {"author": {"name": "Hristian Kirtchev", "email": "kirtchev@adacore.com", "date": "2011-12-20T13:41:00Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2011-12-20T13:41:00Z"}, "message": "sem_res.adb (Resolve_Allocator): Warning on allocation of tasks on a subpool and rewrite the allocator into a...\n\n2011-12-20  Hristian Kirtchev  <kirtchev@adacore.com>\n\n\t* sem_res.adb (Resolve_Allocator): Warning on allocation\n\tof tasks on a subpool and rewrite the allocator into a raise\n\tProgram_Error statement.\n\t* s-stposu.ads, s-stposu.adb: Code reformatting.\n\t(Create_Subpool): Remove formal parameter Storage_Size.\n\t(Default_Subpool_For_Pool): Add the default implementation of this\n\troutine.\n\t(Set_Pool_Of_Subpool): Rename formal parameter Pool to To. Update\n\tall the uses of the parameter.\n\nFrom-SVN: r182533", "tree": {"sha": "aec132f72b134bbe4292bee0e4444c3592293a72", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aec132f72b134bbe4292bee0e4444c3592293a72"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/comments", "author": {"login": "kirtchev-adacore", "id": 60669983, "node_id": "MDQ6VXNlcjYwNjY5OTgz", "avatar_url": "https://avatars.githubusercontent.com/u/60669983?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kirtchev-adacore", "html_url": "https://github.com/kirtchev-adacore", "followers_url": "https://api.github.com/users/kirtchev-adacore/followers", "following_url": "https://api.github.com/users/kirtchev-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/kirtchev-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/kirtchev-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kirtchev-adacore/subscriptions", "organizations_url": "https://api.github.com/users/kirtchev-adacore/orgs", "repos_url": "https://api.github.com/users/kirtchev-adacore/repos", "events_url": "https://api.github.com/users/kirtchev-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/kirtchev-adacore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "9a417f117e8124d6c164f08c4c2c409a291b1622", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9a417f117e8124d6c164f08c4c2c409a291b1622", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9a417f117e8124d6c164f08c4c2c409a291b1622"}], "stats": {"total": 101, "additions": 63, "deletions": 38}, "files": [{"sha": "74d730914a22f7550ba0d4ca971252911870aafa", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "patch": "@@ -1,3 +1,15 @@\n+2011-12-20  Hristian Kirtchev  <kirtchev@adacore.com>\n+\n+\t* sem_res.adb (Resolve_Allocator): Warning on allocation\n+\tof tasks on a subpool and rewrite the allocator into a raise\n+\tProgram_Error statement.\n+\t* s-stposu.ads, s-stposu.adb: Code reformatting.\n+\t(Create_Subpool): Remove formal parameter Storage_Size.\n+\t(Default_Subpool_For_Pool): Add the default implementation of this\n+\troutine.\n+\t(Set_Pool_Of_Subpool): Rename formal parameter Pool to To. Update\n+\tall the uses of the parameter.\n+\n 2011-12-20  Rainer Orth  <ro@CeBiTec.Uni-Bielefeld.DE>\n \n \t* gcc-interface/Makefile.in (%86 linux%):"}, {"sha": "53f65cb2f37a0cef86f5a8adec588b79ad9f159e", "filename": "gcc/ada/s-stposu.adb", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2Fs-stposu.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2Fs-stposu.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-stposu.adb?ref=7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "patch": "@@ -431,6 +431,19 @@ package body System.Storage_Pools.Subpools is\n       Deallocate (Pool, N_Addr, N_Size, Alignment);\n    end Deallocate_Any_Controlled;\n \n+   ------------------------------\n+   -- Default_Subpool_For_Pool --\n+   ------------------------------\n+\n+   function Default_Subpool_For_Pool\n+     (Pool : Root_Storage_Pool_With_Subpools) return not null Subpool_Handle\n+   is\n+   begin\n+      raise Program_Error;\n+\n+      return Pool.Subpools.Subpool;\n+   end Default_Subpool_For_Pool;\n+\n    ------------\n    -- Detach --\n    ------------\n@@ -607,7 +620,8 @@ package body System.Storage_Pools.Subpools is\n    ---------------------\n \n    function Pool_Of_Subpool (Subpool : not null Subpool_Handle)\n-     return access Root_Storage_Pool_With_Subpools'Class is\n+     return access Root_Storage_Pool_With_Subpools'Class\n+   is\n    begin\n       return Subpool.Owner;\n    end Pool_Of_Subpool;\n@@ -762,7 +776,7 @@ package body System.Storage_Pools.Subpools is\n \n    procedure Set_Pool_Of_Subpool\n      (Subpool : not null Subpool_Handle;\n-      Pool    : in out Root_Storage_Pool_With_Subpools'Class)\n+      To      : in out Root_Storage_Pool_With_Subpools'Class)\n    is\n       N_Ptr : SP_Node_Ptr;\n \n@@ -777,12 +791,12 @@ package body System.Storage_Pools.Subpools is\n       --  Prevent the creation of a new subpool while the owner is being\n       --  finalized. This is a serious error.\n \n-      if Pool.Finalization_Started then\n+      if To.Finalization_Started then\n          raise Program_Error\n            with \"subpool creation after finalization started\";\n       end if;\n \n-      Subpool.Owner := Pool'Unchecked_Access;\n+      Subpool.Owner := To'Unchecked_Access;\n \n       --  Create a subpool node and decorate it. Since this node is not\n       --  allocated on the owner's pool, it must be explicitly destroyed by\n@@ -792,7 +806,7 @@ package body System.Storage_Pools.Subpools is\n       N_Ptr.Subpool := Subpool;\n       Subpool.Node := N_Ptr;\n \n-      Attach (N_Ptr, Pool.Subpools'Unchecked_Access);\n+      Attach (N_Ptr, To.Subpools'Unchecked_Access);\n \n       --  Mark the subpool's master as being a heterogeneous collection of\n       --  controlled objects."}, {"sha": "d5819caa1275cd7504948203dee0d948383465c7", "filename": "gcc/ada/s-stposu.ads", "status": "modified", "additions": 20, "deletions": 24, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2Fs-stposu.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2Fs-stposu.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-stposu.ads?ref=7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "patch": "@@ -38,7 +38,7 @@ with System.Finalization_Masters;\n with System.Storage_Elements;\n \n package System.Storage_Pools.Subpools is\n-   pragma Preelaborate;\n+   pragma Preelaborate (Subpools);\n \n    type Root_Storage_Pool_With_Subpools is abstract\n      new Root_Storage_Pool with private;\n@@ -70,21 +70,16 @@ package System.Storage_Pools.Subpools is\n       Storage_Address          : out System.Address;\n       Size_In_Storage_Elements : System.Storage_Elements.Storage_Count;\n       Alignment                : System.Storage_Elements.Storage_Count;\n-      Subpool                  : not null Subpool_Handle)\n-   is abstract;\n+      Subpool                  : not null Subpool_Handle) is abstract;\n \n    --  ??? This precondition causes errors in simple tests, disabled for now\n \n---     with Pre'Class => Pool_Of_Subpool (Subpool) = Pool'Access;\n+--      with Pre'Class => Pool_Of_Subpool (Subpool) = Pool'Access;\n    --  This routine requires implementation. Allocate an object described by\n    --  Size_In_Storage_Elements and Alignment on a subpool.\n \n-   function Create_Subpool\n-     (Pool         : in out Root_Storage_Pool_With_Subpools;\n-      Storage_Size : Storage_Elements.Storage_Count :=\n-                     Storage_Elements.Storage_Count'Last)\n-   return not null Subpool_Handle\n-   is abstract;\n+   function Create_Subpool (Pool : in out Root_Storage_Pool_With_Subpools)\n+     return not null Subpool_Handle is abstract;\n    --  This routine requires implementation. Create a subpool within the given\n    --  pool_with_subpools.\n \n@@ -93,39 +88,40 @@ package System.Storage_Pools.Subpools is\n       Storage_Address          : System.Address;\n       Size_In_Storage_Elements : System.Storage_Elements.Storage_Count;\n       Alignment                : System.Storage_Elements.Storage_Count)\n-   is null;\n+      is null;\n \n    procedure Deallocate_Subpool\n      (Pool    : in out Root_Storage_Pool_With_Subpools;\n-      Subpool : in out Subpool_Handle)\n-   is abstract;\n+      Subpool : in out Subpool_Handle) is abstract;\n \n    --  ??? This precondition causes errors in simple tests, disabled for now\n \n---     with Pre'Class => Pool_Of_Subpool (Subpool) = Pool'Access;\n+--      with Pre'Class => Pool_Of_Subpool (Subpool) = Pool'Access;\n    --  This routine requires implementation. Reclaim the storage a particular\n    --  subpool occupies in a pool_with_subpools. This routine is called by\n    --  Ada.Unchecked_Deallocate_Subpool.\n \n    function Default_Subpool_For_Pool\n-     (Pool : Root_Storage_Pool_With_Subpools)\n-   return not null Subpool_Handle\n-   is abstract;\n-   --  This routine requires implementation. Returns a common subpool used for\n-   --  allocations without Subpool_Handle_name in the allocator.\n-\n-   function Pool_Of_Subpool\n-     (Subpool : not null Subpool_Handle)\n-   return access Root_Storage_Pool_With_Subpools'Class;\n+     (Pool : Root_Storage_Pool_With_Subpools) return not null Subpool_Handle;\n+   --  Return a common subpool which is used for object allocations without a\n+   --  Subpool_Handle_name in the allocator. The default implementation of this\n+   --  routine raises Program_Error.\n+\n+   function Pool_Of_Subpool (Subpool : not null Subpool_Handle)\n+     return access Root_Storage_Pool_With_Subpools'Class;\n    --  Return the owner of the subpool\n \n    procedure Set_Pool_Of_Subpool\n      (Subpool : not null Subpool_Handle;\n-      Pool    : in out Root_Storage_Pool_With_Subpools'Class);\n+      To      : in out Root_Storage_Pool_With_Subpools'Class);\n    --  Set the owner of the subpool. This is intended to be called from\n    --  Create_Subpool or similar subpool constructors. Raises Program_Error\n    --  if the subpool already belongs to a pool.\n \n+   overriding function Storage_Size (Pool : Root_Storage_Pool_With_Subpools)\n+     return System.Storage_Elements.Storage_Count is\n+       (System.Storage_Elements.Storage_Count'Last);\n+\n private\n    --  Model\n    --             Pool_With_Subpools     SP_Node    SP_Node    SP_Node"}, {"sha": "3a8d7d7357e4f472990ac690329b6cc74396a612", "filename": "gcc/ada/sem_res.adb", "status": "modified", "additions": 12, "deletions": 9, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2Fsem_res.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7b2aafc959f1ef24f111eb0d56b393bb2d315bbf/gcc%2Fada%2Fsem_res.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_res.adb?ref=7b2aafc959f1ef24f111eb0d56b393bb2d315bbf", "patch": "@@ -4469,23 +4469,26 @@ package body Sem_Res is\n         and then Ekind (Current_Scope) = E_Package\n         and then not In_Package_Body (Current_Scope)\n       then\n-         Error_Msg_N (\"cannot activate task before body seen?\", N);\n-         Error_Msg_N (\"\\Program_Error will be raised at run time?\", N);\n+         Error_Msg_N (\"?cannot activate task before body seen\", N);\n+         Error_Msg_N (\"\\?Program_Error will be raised at run time\", N);\n       end if;\n \n-      --  Ada 2012 (AI05-0111-3): Issue a warning whenever allocating a task\n-      --  or a type containing tasks on a subpool since the deallocation of\n-      --  the subpool may lead to undefined task behavior. Perform the check\n-      --  only when the allocator has not been converted into a Program_Error\n-      --  due to a previous error.\n+      --  Ada 2012 (AI05-0111-3): Detect an attempt to allocate a task or a\n+      --  type with a task component on a subpool. This action must raise\n+      --  Program_Error at runtime.\n \n       if Ada_Version >= Ada_2012\n         and then Nkind (N) = N_Allocator\n         and then Present (Subpool_Handle_Name (N))\n         and then Has_Task (Desig_T)\n       then\n-         Error_Msg_N (\"?allocation of task on subpool may lead to \" &\n-                      \"undefined behavior\", N);\n+         Error_Msg_N (\"?cannot allocate task on subpool\", N);\n+         Error_Msg_N (\"\\?Program_Error will be raised at run time\", N);\n+\n+         Rewrite (N,\n+           Make_Raise_Program_Error (Sloc (N),\n+             Reason => PE_Explicit_Raise));\n+         Set_Etype (N, Typ);\n       end if;\n    end Resolve_Allocator;\n "}]}