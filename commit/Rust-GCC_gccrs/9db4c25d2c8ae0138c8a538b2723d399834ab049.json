{"sha": "9db4c25d2c8ae0138c8a538b2723d399834ab049", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWRiNGMyNWQyYzhhZTAxMzhjOGE1MzhiMjcyM2QzOTk4MzRhYjA0OQ==", "commit": {"author": {"name": "Uros Bizjak", "email": "ubizjak@gmail.com", "date": "2016-08-19T18:14:03Z"}, "committer": {"name": "Uros Bizjak", "email": "uros@gcc.gnu.org", "date": "2016-08-19T18:14:03Z"}, "message": "re PR target/77270 (Flag -mprftchw is shared with 3dnow for -march=k8)\n\n\tPR target/77270\n\t* config/i386/i386.c (ix86_option_override_internal): Remove\n\tPTA_PRFCHW from entries that also have PTA_3DNOW flag.\n\tEnable SSE prefetch also for TARGET_PREFETCHWT1.\n\tDo not try to enable TARGET_PRFCHW ISA flag here.\n\t* config/i386/i386.md (prefetch): Enable also for TARGET_3DNOW.\n\tRewrite expander function body.\n\t(*prefetch_3dnow): Enable for TARGET_3DNOW and TARGET_PREFETCHWT1.\n\nFrom-SVN: r239626", "tree": {"sha": "22a6ea45a60e61fe64d7b1a7ec746616d6ed979e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/22a6ea45a60e61fe64d7b1a7ec746616d6ed979e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9db4c25d2c8ae0138c8a538b2723d399834ab049", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9db4c25d2c8ae0138c8a538b2723d399834ab049", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9db4c25d2c8ae0138c8a538b2723d399834ab049", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9db4c25d2c8ae0138c8a538b2723d399834ab049/comments", "author": {"login": "ubizjak", "id": 55479990, "node_id": "MDQ6VXNlcjU1NDc5OTkw", "avatar_url": "https://avatars.githubusercontent.com/u/55479990?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ubizjak", "html_url": "https://github.com/ubizjak", "followers_url": "https://api.github.com/users/ubizjak/followers", "following_url": "https://api.github.com/users/ubizjak/following{/other_user}", "gists_url": "https://api.github.com/users/ubizjak/gists{/gist_id}", "starred_url": "https://api.github.com/users/ubizjak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ubizjak/subscriptions", "organizations_url": "https://api.github.com/users/ubizjak/orgs", "repos_url": "https://api.github.com/users/ubizjak/repos", "events_url": "https://api.github.com/users/ubizjak/events{/privacy}", "received_events_url": "https://api.github.com/users/ubizjak/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c65699efcce48d68ef57ab3ce7fc5420fac5cbf9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c65699efcce48d68ef57ab3ce7fc5420fac5cbf9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c65699efcce48d68ef57ab3ce7fc5420fac5cbf9"}], "stats": {"total": 92, "additions": 58, "deletions": 34}, "files": [{"sha": "659330073c8e6c1ebea9045c9637e0545a5fe320", "filename": "gcc/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9db4c25d2c8ae0138c8a538b2723d399834ab049/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9db4c25d2c8ae0138c8a538b2723d399834ab049/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=9db4c25d2c8ae0138c8a538b2723d399834ab049", "patch": "@@ -1,3 +1,14 @@\n+2016-08-19  Uros Bizjak  <ubizjak@gmail.com>\n+\n+\tPR target/77270\n+\t* config/i386/i386.c (ix86_option_override_internal): Remove\n+\tPTA_PRFCHW from entries that also have PTA_3DNOW flag.\n+\tEnable SSE prefetch also for TARGET_PREFETCHWT1.\n+\tDo not try to enable TARGET_PRFCHW ISA flag here.\n+\t* config/i386/i386.md (prefetch): Enable also for TARGET_3DNOW.\n+\tRewrite expander function body.\n+\t(*prefetch_3dnow): Enable for TARGET_3DNOW and TARGET_PREFETCHWT1.\n+\n 2016-08-19  Joseph Myers  <joseph@codesourcery.com>\n \n \tPR c/32187"}, {"sha": "2639c8cbbb5103865ff9caa4a362034868b20c26", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 23, "deletions": 27, "changes": 50, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9db4c25d2c8ae0138c8a538b2723d399834ab049/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9db4c25d2c8ae0138c8a538b2723d399834ab049/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=9db4c25d2c8ae0138c8a538b2723d399834ab049", "patch": "@@ -4843,9 +4843,9 @@ ix86_option_override_internal (bool main_args_p,\n       {\"lakemont\", PROCESSOR_LAKEMONT, CPU_PENTIUM, PTA_NO_80387},\n       {\"pentium-mmx\", PROCESSOR_PENTIUM, CPU_PENTIUM, PTA_MMX},\n       {\"winchip-c6\", PROCESSOR_I486, CPU_NONE, PTA_MMX},\n-      {\"winchip2\", PROCESSOR_I486, CPU_NONE, PTA_MMX | PTA_3DNOW | PTA_PRFCHW},\n-      {\"c3\", PROCESSOR_I486, CPU_NONE, PTA_MMX | PTA_3DNOW | PTA_PRFCHW},\n-      {\"samuel-2\", PROCESSOR_I486, CPU_NONE, PTA_MMX | PTA_3DNOW | PTA_PRFCHW},\n+      {\"winchip2\", PROCESSOR_I486, CPU_NONE, PTA_MMX | PTA_3DNOW},\n+      {\"c3\", PROCESSOR_I486, CPU_NONE, PTA_MMX | PTA_3DNOW},\n+      {\"samuel-2\", PROCESSOR_I486, CPU_NONE, PTA_MMX | PTA_3DNOW},\n       {\"c3-2\", PROCESSOR_PENTIUMPRO, CPU_PENTIUMPRO,\n \tPTA_MMX | PTA_SSE | PTA_FXSR},\n       {\"nehemiah\", PROCESSOR_PENTIUMPRO, CPU_PENTIUMPRO,\n@@ -4896,20 +4896,20 @@ ix86_option_override_internal (bool main_args_p,\n       {\"knl\", PROCESSOR_KNL, CPU_SLM, PTA_KNL},\n       {\"intel\", PROCESSOR_INTEL, CPU_SLM, PTA_NEHALEM},\n       {\"geode\", PROCESSOR_GEODE, CPU_GEODE,\n-\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_PREFETCH_SSE | PTA_PRFCHW},\n+\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_PREFETCH_SSE},\n       {\"k6\", PROCESSOR_K6, CPU_K6, PTA_MMX},\n-      {\"k6-2\", PROCESSOR_K6, CPU_K6, PTA_MMX | PTA_3DNOW | PTA_PRFCHW},\n-      {\"k6-3\", PROCESSOR_K6, CPU_K6, PTA_MMX | PTA_3DNOW | PTA_PRFCHW},\n+      {\"k6-2\", PROCESSOR_K6, CPU_K6, PTA_MMX | PTA_3DNOW},\n+      {\"k6-3\", PROCESSOR_K6, CPU_K6, PTA_MMX | PTA_3DNOW},\n       {\"athlon\", PROCESSOR_ATHLON, CPU_ATHLON,\n-\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_PREFETCH_SSE | PTA_PRFCHW},\n+\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_PREFETCH_SSE},\n       {\"athlon-tbird\", PROCESSOR_ATHLON, CPU_ATHLON,\n-\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_PREFETCH_SSE | PTA_PRFCHW},\n+\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_PREFETCH_SSE},\n       {\"athlon-4\", PROCESSOR_ATHLON, CPU_ATHLON,\n-\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_PRFCHW | PTA_FXSR},\n+\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_FXSR},\n       {\"athlon-xp\", PROCESSOR_ATHLON, CPU_ATHLON,\n-\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_PRFCHW | PTA_FXSR},\n+\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_FXSR},\n       {\"athlon-mp\", PROCESSOR_ATHLON, CPU_ATHLON,\n-\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_PRFCHW | PTA_FXSR},\n+\tPTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_FXSR},\n       {\"x86-64\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_SSE | PTA_SSE2 | PTA_NO_SAHF | PTA_FXSR},\n       {\"eden-x2\", PROCESSOR_K8, CPU_K8,\n@@ -4937,31 +4937,31 @@ ix86_option_override_internal (bool main_args_p,\n         | PTA_SSSE3 | PTA_SSE4_1 | PTA_FXSR},\n       {\"k8\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_NO_SAHF | PTA_FXSR},\n       {\"k8-sse3\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_SSE3 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_SSE3 | PTA_NO_SAHF | PTA_FXSR},\n       {\"opteron\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_NO_SAHF | PTA_FXSR},\n       {\"opteron-sse3\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_SSE3 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_SSE3 | PTA_NO_SAHF | PTA_FXSR},\n       {\"athlon64\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_NO_SAHF | PTA_FXSR},\n       {\"athlon64-sse3\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_SSE3 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_SSE3 | PTA_NO_SAHF | PTA_FXSR},\n       {\"athlon-fx\", PROCESSOR_K8, CPU_K8,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE\n-\t| PTA_SSE2 | PTA_NO_SAHF | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE2 | PTA_NO_SAHF | PTA_FXSR},\n       {\"amdfam10\", PROCESSOR_AMDFAM10, CPU_AMDFAM10,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_SSE2\n-\t| PTA_SSE3 | PTA_SSE4A | PTA_CX16 | PTA_ABM | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE3 | PTA_SSE4A | PTA_CX16 | PTA_ABM | PTA_FXSR},\n       {\"barcelona\", PROCESSOR_AMDFAM10, CPU_AMDFAM10,\n \tPTA_64BIT | PTA_MMX | PTA_3DNOW | PTA_3DNOW_A | PTA_SSE | PTA_SSE2\n-\t| PTA_SSE3 | PTA_SSE4A | PTA_CX16 | PTA_ABM | PTA_PRFCHW | PTA_FXSR},\n+\t| PTA_SSE3 | PTA_SSE4A | PTA_CX16 | PTA_ABM | PTA_FXSR},\n       {\"bdver1\", PROCESSOR_BDVER1, CPU_BDVER1,\n \tPTA_64BIT | PTA_MMX | PTA_SSE | PTA_SSE2 | PTA_SSE3\n \t| PTA_SSE4A | PTA_CX16 | PTA_ABM | PTA_SSSE3 | PTA_SSE4_1\n@@ -5668,14 +5668,10 @@ ix86_option_override_internal (bool main_args_p,\n \n   /* Enable SSE prefetch.  */\n   if (TARGET_SSE_P (opts->x_ix86_isa_flags)\n-      || (TARGET_PRFCHW && !TARGET_3DNOW_P (opts->x_ix86_isa_flags)))\n-    x86_prefetch_sse = true;\n-\n-  /* Enable prefetch{,w} instructions for -m3dnow and -mprefetchwt1.  */\n-  if (TARGET_3DNOW_P (opts->x_ix86_isa_flags)\n+      || (TARGET_PRFCHW_P (opts->x_ix86_isa_flags)\n+\t  && !TARGET_3DNOW_P (opts->x_ix86_isa_flags))\n       || TARGET_PREFETCHWT1_P (opts->x_ix86_isa_flags))\n-    opts->x_ix86_isa_flags\n-      |= OPTION_MASK_ISA_PRFCHW & ~opts->x_ix86_isa_flags_explicit;\n+    x86_prefetch_sse = true;\n \n   /* Enable popcnt instruction for -msse4.2 or -mabm.  */\n   if (TARGET_SSE4_2_P (opts->x_ix86_isa_flags)"}, {"sha": "36ae87652f8a1493d6a1c8a3d72b7859da1eba6f", "filename": "gcc/config/i386/i386.md", "status": "modified", "additions": 24, "deletions": 7, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9db4c25d2c8ae0138c8a538b2723d399834ab049/gcc%2Fconfig%2Fi386%2Fi386.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9db4c25d2c8ae0138c8a538b2723d399834ab049/gcc%2Fconfig%2Fi386%2Fi386.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.md?ref=9db4c25d2c8ae0138c8a538b2723d399834ab049", "patch": "@@ -18626,7 +18626,7 @@\n   [(prefetch (match_operand 0 \"address_operand\")\n \t     (match_operand:SI 1 \"const_int_operand\")\n \t     (match_operand:SI 2 \"const_int_operand\"))]\n-  \"TARGET_PREFETCH_SSE || TARGET_PRFCHW || TARGET_PREFETCHWT1\"\n+  \"TARGET_3DNOW || TARGET_PREFETCH_SSE || TARGET_PRFCHW || TARGET_PREFETCHWT1\"\n {\n   bool write = INTVAL (operands[1]) != 0;\n   int locality = INTVAL (operands[2]);\n@@ -18637,12 +18637,29 @@\n      supported by SSE counterpart or the SSE prefetch is not available\n      (K6 machines).  Otherwise use SSE prefetch as it allows specifying\n      of locality.  */\n-  if (TARGET_PREFETCHWT1 && write && locality <= 2)\n-    operands[2] = const2_rtx;\n-  else if (TARGET_PRFCHW && (write || !TARGET_PREFETCH_SSE))\n-    operands[2] = GEN_INT (3);\n+\n+  if (write)\n+    {\n+      if (TARGET_PREFETCHWT1)\n+\toperands[2] = GEN_INT (MAX (locality, 2)); \n+      else if (TARGET_3DNOW || TARGET_PRFCHW)\n+\toperands[2] = GEN_INT (3);\n+      else\n+\t{\n+\t  gcc_assert (TARGET_PREFETCH_SSE);\n+\t  operands[1] = const0_rtx;\n+\t}\n+    }\n   else\n-    operands[1] = const0_rtx;\n+    {\n+      if (TARGET_PREFETCH_SSE)\n+\t;\n+      else\n+\t{\n+\t  gcc_assert (TARGET_3DNOW);\n+\t  operands[2] = GEN_INT (3);\n+\t}\n+    }\n })\n \n (define_insn \"*prefetch_sse\"\n@@ -18670,7 +18687,7 @@\n   [(prefetch (match_operand 0 \"address_operand\" \"p\")\n \t     (match_operand:SI 1 \"const_int_operand\" \"n\")\n \t     (const_int 3))]\n-  \"TARGET_PRFCHW\"\n+  \"TARGET_3DNOW || TARGET_PRFCHW || TARGET_PREFETCHWT1\"\n {\n   if (INTVAL (operands[1]) == 0)\n     return \"prefetch\\t%a0\";"}]}