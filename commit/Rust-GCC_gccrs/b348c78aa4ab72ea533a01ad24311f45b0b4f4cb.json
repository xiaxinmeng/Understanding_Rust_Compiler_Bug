{"sha": "b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjM0OGM3OGFhNGFiNzJlYTUzM2EwMWFkMjQzMTFmNDViMGI0ZjRjYg==", "commit": {"author": {"name": "Alexandre Oliva", "email": "oliva@adacore.com", "date": "2018-07-31T21:19:25Z"}, "committer": {"name": "Alexandre Oliva", "email": "aoliva@gcc.gnu.org", "date": "2018-07-31T21:19:25Z"}, "message": "Save discriminator info for LTO\n\nfor  gcc/ChangeLog\n\n\t* gimple-streamer-in.c (input_bb): Restore BB discriminator.\n\t* gimple-streamer-out.c (output_bb): Save it.\n\t* lto-streamer-in.c (input_struct_function_base): Restore\n\tinstance discriminator if available.  Create map on demand.\n\t* lto-streamer-out.c (output_struct_function_base): Save it if\n\tavailable.\n\t* final.c (decl_to_instance_map): Document LTO strategy.\n\nFrom-SVN: r263183", "tree": {"sha": "9077f5e87e913aebb0359956c2af7b904205d824", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9077f5e87e913aebb0359956c2af7b904205d824"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/comments", "author": null, "committer": null, "parents": [{"sha": "fa6fd7b7afece6e0cfe197c9419ea3346d3c60b2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fa6fd7b7afece6e0cfe197c9419ea3346d3c60b2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fa6fd7b7afece6e0cfe197c9419ea3346d3c60b2"}], "stats": {"total": 34, "additions": 33, "deletions": 1}, "files": [{"sha": "9b0ccfdaf317f3164354486cf94e4e585d869ba1", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "patch": "@@ -1,3 +1,13 @@\n+2018-07-31  Alexandre Oliva <oliva@adacore.com>\n+\n+\t* gimple-streamer-in.c (input_bb): Restore BB discriminator.\n+\t* gimple-streamer-out.c (output_bb): Save it.\n+\t* lto-streamer-in.c (input_struct_function_base): Restore\n+\tinstance discriminator if available.  Create map on demand.\n+\t* lto-streamer-out.c (output_struct_function_base): Save it if\n+\tavailable.\n+\t* final.c (decl_to_instance_map): Document LTO strategy.\n+\n 2018-07-31  Alexandre Oliva  <oliva@adacore.com>\n             Olivier Hainque  <hainque@adacore.com>\n "}, {"sha": "842e5e067db7419076c07a603283e42231a44353", "filename": "gcc/final.c", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Ffinal.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Ffinal.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffinal.c?ref=b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "patch": "@@ -3154,7 +3154,11 @@ final_scan_insn (rtx_insn *insn, FILE *file, int optimize_p,\n \f\n \n /* Map DECLs to instance discriminators.  This is allocated and\n-   defined in ada/gcc-interfaces/trans.c, when compiling with -gnateS.  */\n+   defined in ada/gcc-interfaces/trans.c, when compiling with -gnateS.\n+   Mappings from this table are saved and restored for LTO, so\n+   link-time compilation will have this map set, at least in\n+   partitions containing at least one DECL with an associated instance\n+   discriminator.  */\n \n decl_to_instance_map_t *decl_to_instance_map;\n "}, {"sha": "31ba4cc4e00eda0f893f739d42fd4ea9794962d0", "filename": "gcc/gimple-streamer-in.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Fgimple-streamer-in.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Fgimple-streamer-in.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-streamer-in.c?ref=b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "patch": "@@ -270,6 +270,7 @@ input_bb (struct lto_input_block *ib, enum LTO_tags tag,\n     bb->count\n       = bb->count.apply_scale (count_materialization_scale, REG_BR_PROB_BASE);\n   bb->flags = streamer_read_hwi (ib);\n+  bb->discriminator = streamer_read_hwi (ib);\n \n   /* LTO_bb1 has statements.  LTO_bb0 does not.  */\n   if (tag == LTO_bb0)"}, {"sha": "3a2368047cc6836fd1ac727d5e9ec604f911685a", "filename": "gcc/gimple-streamer-out.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Fgimple-streamer-out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Fgimple-streamer-out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-streamer-out.c?ref=b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "patch": "@@ -212,6 +212,7 @@ output_bb (struct output_block *ob, basic_block bb, struct function *fn)\n   streamer_write_uhwi (ob, bb->index);\n   bb->count.stream_out (ob);\n   streamer_write_hwi (ob, bb->flags);\n+  streamer_write_hwi (ob, bb->discriminator);\n \n   if (!gsi_end_p (bsi) || phi_nodes (bb))\n     {"}, {"sha": "4ddcc8f7ddd9c4e9754d5b88942da1c2fb7d7cfd", "filename": "gcc/lto-streamer-in.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Flto-streamer-in.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Flto-streamer-in.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-in.c?ref=b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "patch": "@@ -1013,6 +1013,14 @@ input_struct_function_base (struct function *fn, struct data_in *data_in,\n   /* Input the function start and end loci.  */\n   fn->function_start_locus = stream_input_location_now (&bp, data_in);\n   fn->function_end_locus = stream_input_location_now (&bp, data_in);\n+\n+  /* Restore the instance discriminators if present.  */\n+  int instance_number = bp_unpack_value (&bp, 1);\n+  if (instance_number)\n+    {\n+      instance_number = bp_unpack_value (&bp, sizeof (int) * CHAR_BIT);\n+      maybe_create_decl_to_instance_map ()->put (fn->decl, instance_number);\n+    }\n }\n \n "}, {"sha": "9e28d678342c1d4a48293b8becef816a227472ea", "filename": "gcc/lto-streamer-out.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Flto-streamer-out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b348c78aa4ab72ea533a01ad24311f45b0b4f4cb/gcc%2Flto-streamer-out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-out.c?ref=b348c78aa4ab72ea533a01ad24311f45b0b4f4cb", "patch": "@@ -2038,6 +2038,14 @@ output_struct_function_base (struct output_block *ob, struct function *fn)\n   stream_output_location (ob, &bp, fn->function_start_locus);\n   stream_output_location (ob, &bp, fn->function_end_locus);\n \n+  /* Save the instance discriminator if present.  */\n+  int *instance_number_p = NULL;\n+  if (decl_to_instance_map)\n+    instance_number_p = decl_to_instance_map->get (fn->decl);\n+  bp_pack_value (&bp, !!instance_number_p, 1);\n+  if (instance_number_p)\n+    bp_pack_value (&bp, *instance_number_p, sizeof (int) * CHAR_BIT);\n+\n   streamer_write_bitpack (&bp);\n }\n "}]}