{"sha": "47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDdlOGEyMmExNzlhNTNmNjgxYWI0ZTI0NzhmZmQ2MmQwMWZiNWY1Mg==", "commit": {"author": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2018-01-09T23:36:46Z"}, "committer": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2018-01-09T23:36:46Z"}, "message": "compiler: stack allocate defer thunk\n    \n    Defer statement may need to allocate a thunk. When it is not\n    inside a loop, this can be stack allocated, as it runs before\n    the function finishes.\n    \n    Reviewed-on: https://go-review.googlesource.com/85639\n\nFrom-SVN: r256410", "tree": {"sha": "f6c752ac4ba05b7c95ae68696c2207393df008d4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f6c752ac4ba05b7c95ae68696c2207393df008d4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "html_url": "https://github.com/Rust-GCC/gccrs/commit/47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/comments", "author": null, "committer": null, "parents": [{"sha": "311eca53bd28cad25686c9a6d967ceb211f214e1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/311eca53bd28cad25686c9a6d967ceb211f214e1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/311eca53bd28cad25686c9a6d967ceb211f214e1"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "80ccaf3b3b98fa8084e7e2938656447d6d953d02", "filename": "gcc/go/gofrontend/MERGE", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/gcc%2Fgo%2Fgofrontend%2FMERGE", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/gcc%2Fgo%2Fgofrontend%2FMERGE", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgo%2Fgofrontend%2FMERGE?ref=47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "patch": "@@ -1,4 +1,4 @@\n-d5774539b17112d9ce709a1fe722daf68eb8594f\n+7c5e4d67041e3529a055a923b2b9f5ef09aa72a3\n \n The first line of this file holds the git revision number of the last\n merge done from the gofrontend repository."}, {"sha": "65ccf9bd0db015b5d085564f89dd4dafbeef3655", "filename": "gcc/go/gofrontend/escape.cc", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/gcc%2Fgo%2Fgofrontend%2Fescape.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/gcc%2Fgo%2Fgofrontend%2Fescape.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgo%2Fgofrontend%2Fescape.cc?ref=47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "patch": "@@ -1420,7 +1420,14 @@ Escape_analysis_assign::statement(Block*, size_t*, Statement* s)\n \n     case Statement::STATEMENT_DEFER:\n       if (this->context_->loop_depth() == 1)\n-\tbreak;\n+        {\n+          // Defer statement may need to allocate a thunk. When it is\n+          // not inside a loop, this can be stack allocated, as it\n+          // runs before the function finishes.\n+          Node* n = Node::make_node(s);\n+          n->set_encoding(Node::ESCAPE_NONE);\n+          break;\n+        }\n       // fallthrough\n \n     case Statement::STATEMENT_GO:"}, {"sha": "1c079bb40c7dae0144211270a06d2db9d7fef520", "filename": "gcc/go/gofrontend/statements.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/gcc%2Fgo%2Fgofrontend%2Fstatements.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47e8a22a179a53f681ab4e2478ffd62d01fb5f52/gcc%2Fgo%2Fgofrontend%2Fstatements.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgo%2Fgofrontend%2Fstatements.cc?ref=47e8a22a179a53f681ab4e2478ffd62d01fb5f52", "patch": "@@ -2156,6 +2156,8 @@ Thunk_statement::simplify_statement(Gogo* gogo, Named_object* function,\n \n   // Allocate the initialized struct on the heap.\n   constructor = Expression::make_heap_expression(constructor, location);\n+  if ((Node::make_node(this)->encoding() & ESCAPE_MASK) == Node::ESCAPE_NONE)\n+    constructor->heap_expression()->set_allocate_on_stack();\n \n   // Throw an error if the function is nil.  This is so that for `go\n   // nil` we get a backtrace from the go statement, rather than a"}]}