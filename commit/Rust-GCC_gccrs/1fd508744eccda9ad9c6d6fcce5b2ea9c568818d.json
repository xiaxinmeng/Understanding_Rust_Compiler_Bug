{"sha": "1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "node_id": "C_kwDOANBUbNoAKDFmZDUwODc0NGVjY2RhOWFkOWM2ZDZmY2NlNWIyZWE5YzU2ODgxOGQ", "commit": {"author": {"name": "Paul-Antoine Arras", "email": "pa@codesourcery.com", "date": "2022-11-29T15:22:07Z"}, "committer": {"name": "Paul-Antoine Arras", "email": "pa@codesourcery.com", "date": "2022-11-30T09:51:42Z"}, "message": "amdgcn: Support AMD-specific 'isa' traits in OpenMP context selectors\n\nAdd support for gfx803 as an alias for fiji.\nAdd test cases for all supported 'isa' values.\n\ngcc/ChangeLog:\n\n\t* config/gcn/gcn.cc (gcn_omp_device_kind_arch_isa): Add gfx803.\n\t* config/gcn/t-omp-device: Add gfx803.\n\nlibgomp/ChangeLog:\n\n\t* testsuite/libgomp.c/declare-variant-4-fiji.c: New test.\n\t* testsuite/libgomp.c/declare-variant-4-gfx803.c: New test.\n\t* testsuite/libgomp.c/declare-variant-4-gfx900.c: New test.\n\t* testsuite/libgomp.c/declare-variant-4-gfx906.c: New test.\n\t* testsuite/libgomp.c/declare-variant-4-gfx908.c: New test.\n\t* testsuite/libgomp.c/declare-variant-4-gfx90a.c: New test.\n\t* testsuite/libgomp.c/declare-variant-4.h: New header file.", "tree": {"sha": "cc7b73cf63318f5c36fdeb11ca363563e8ecdd91", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cc7b73cf63318f5c36fdeb11ca363563e8ecdd91"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/comments", "author": null, "committer": null, "parents": [{"sha": "a1b5cdf381d6b02f5048d886a8377d0042bda3af", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a1b5cdf381d6b02f5048d886a8377d0042bda3af", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a1b5cdf381d6b02f5048d886a8377d0042bda3af"}], "stats": {"total": 110, "additions": 108, "deletions": 2}, "files": [{"sha": "39e93aeaeef14e24831a464bae548b0848ce2b0f", "filename": "gcc/config/gcn/gcn.cc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/gcc%2Fconfig%2Fgcn%2Fgcn.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/gcc%2Fconfig%2Fgcn%2Fgcn.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fgcn%2Fgcn.cc?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -2985,7 +2985,7 @@ gcn_omp_device_kind_arch_isa (enum omp_device_kind_arch_isa trait,\n     case omp_device_arch:\n       return strcmp (name, \"amdgcn\") == 0 || strcmp (name, \"gcn\") == 0;\n     case omp_device_isa:\n-      if (strcmp (name, \"fiji\") == 0)\n+      if (strcmp (name, \"fiji\") == 0 || strcmp (name, \"gfx803\") == 0)\n \treturn gcn_arch == PROCESSOR_FIJI;\n       if (strcmp (name, \"gfx900\") == 0)\n \treturn gcn_arch == PROCESSOR_VEGA10;"}, {"sha": "538624f7ec7d77a1c94e399f85287f282740a905", "filename": "gcc/config/gcn/t-omp-device", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/gcc%2Fconfig%2Fgcn%2Ft-omp-device", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/gcc%2Fconfig%2Fgcn%2Ft-omp-device", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fgcn%2Ft-omp-device?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -1,4 +1,4 @@\n omp-device-properties-gcn: $(srcdir)/config/gcn/gcn.cc\n \techo kind: gpu > $@\n \techo arch: amdgcn gcn >> $@\n-\techo isa: fiji gfx900 gfx906 gfx908 gfx90a >> $@\n+\techo isa: fiji gfx803 gfx900 gfx906 gfx908 gfx90a >> $@"}, {"sha": "ae2af1cc00c21a280d931de94d37f85d9c8a6122", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4-fiji.c", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-fiji.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-fiji.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-fiji.c?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,8 @@\n+/* { dg-do run { target { offload_target_amdgcn } } } */\n+/* { dg-skip-if \"fiji/gfx803 only\" { ! amdgcn-*-* } { \"*\" } { \"-foffload=-march=fiji\" } } */\n+/* { dg-additional-options \"-foffload=-fdump-tree-optimized\" } */\n+\n+#define USE_FIJI_FOR_GFX803\n+#include \"declare-variant-4.h\"\n+\n+/* { dg-final { scan-offload-tree-dump \"= gfx803 \\\\(\\\\);\" \"optimized\" } } */"}, {"sha": "e0437a04d65d9b56a65a1bc9325f6f72b54672cd", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4-gfx803.c", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx803.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx803.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx803.c?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,7 @@\n+/* { dg-do run { target { offload_target_amdgcn } } } */\n+/* { dg-skip-if \"fiji/gfx803 only\" { ! amdgcn-*-* } { \"*\" } { \"-foffload=-march=fiji\" } } */\n+/* { dg-additional-options \"-foffload=-fdump-tree-optimized\" } */\n+\n+#include \"declare-variant-4.h\"\n+\n+/* { dg-final { scan-offload-tree-dump \"= gfx803 \\\\(\\\\);\" \"optimized\" } } */"}, {"sha": "8de03725dec7d1477af540f74a39cf5bba21a169", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4-gfx900.c", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx900.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx900.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx900.c?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,7 @@\n+/* { dg-do run { target { offload_target_amdgcn } } } */\n+/* { dg-skip-if \"gfx900 only\" { ! amdgcn-*-* } { \"*\" } { \"-foffload=-march=gfx900\" } } */\n+/* { dg-additional-options \"-foffload=-fdump-tree-optimized\" } */\n+\n+#include \"declare-variant-4.h\"\n+\n+/* { dg-final { scan-offload-tree-dump \"= gfx900 \\\\(\\\\);\" \"optimized\" } } */"}, {"sha": "be6f193ed3ae0f77c0b191dc221ba81a39158032", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4-gfx906.c", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx906.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx906.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx906.c?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,7 @@\n+/* { dg-do run { target { offload_target_amdgcn } } } */\n+/* { dg-skip-if \"gfx906 only\" { ! amdgcn-*-* } { \"*\" } { \"-foffload=-march=gfx906\" } } */\n+/* { dg-additional-options \"-foffload=-fdump-tree-optimized\" } */\n+\n+#include \"declare-variant-4.h\"\n+\n+/* { dg-final { scan-offload-tree-dump \"= gfx906 \\\\(\\\\);\" \"optimized\" } } */"}, {"sha": "311fad9074d9c92457edd73fbb4a1aea1c4d98ee", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4-gfx908.c", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx908.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx908.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx908.c?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,7 @@\n+/* { dg-do run { target { offload_target_amdgcn } } } */\n+/* { dg-skip-if \"gfx908 only\" { ! amdgcn-*-* } { \"*\" } { \"-foffload=-march=gfx908\" } } */\n+/* { dg-additional-options \"-foffload=-fdump-tree-optimized\" } */\n+\n+#include \"declare-variant-4.h\"\n+\n+/* { dg-final { scan-offload-tree-dump \"= gfx908 \\\\(\\\\);\" \"optimized\" } } */"}, {"sha": "96cc14ca0a398c1dde3a5be585b634ab56732455", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4-gfx90a.c", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx90a.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx90a.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4-gfx90a.c?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,7 @@\n+/* { dg-do run { target { offload_target_amdgcn } } } */\n+/* { dg-skip-if \"gfx90a only\" { ! amdgcn-*-* } { \"*\" } { \"-foffload=-march=gfx90a\" } } */\n+/* { dg-additional-options \"-foffload=-fdump-tree-optimized\" } */\n+\n+#include \"declare-variant-4.h\"\n+\n+/* { dg-final { scan-offload-tree-dump \"= gfx90a \\\\(\\\\);\" \"optimized\" } } */"}, {"sha": "2d7c1ef1a5a98a82916b89c5761e8d369e83db84", "filename": "libgomp/testsuite/libgomp.c/declare-variant-4.h", "status": "added", "additions": 63, "deletions": 0, "changes": 63, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1fd508744eccda9ad9c6d6fcce5b2ea9c568818d/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fdeclare-variant-4.h?ref=1fd508744eccda9ad9c6d6fcce5b2ea9c568818d", "patch": "@@ -0,0 +1,63 @@\n+#pragma omp declare target\n+int\n+gfx803 (void)\n+{\n+  return 0x803;\n+}\n+\n+int\n+gfx900 (void)\n+{\n+  return 0x900;\n+}\n+\n+int\n+gfx906 (void)\n+{\n+  return 0x906;\n+}\n+\n+int\n+gfx908 (void)\n+{\n+  return 0x908;\n+}\n+\n+int\n+gfx90a (void)\n+{\n+  return 0x90a;\n+}\n+\n+#ifdef USE_FIJI_FOR_GFX803\n+#pragma omp declare variant(gfx803) match(device = {isa(\"fiji\")})\n+#else\n+#pragma omp declare variant(gfx803) match(device = {isa(\"gfx803\")})\n+#endif\n+#pragma omp declare variant(gfx900) match(device = {isa(\"gfx900\")})\n+#pragma omp declare variant(gfx906) match(device = {isa(\"gfx906\")})\n+#pragma omp declare variant(gfx908) match(device = {isa(\"gfx908\")})\n+#pragma omp declare variant(gfx90a) match(device = {isa(\"gfx90a\")})\n+int\n+f (void)\n+{\n+  return 0;\n+}\n+\n+#pragma omp end declare target\n+\n+int\n+main (void)\n+{\n+  int v = 0;\n+\n+#pragma omp target map(from : v)\n+  v = f ();\n+\n+  if (v == 0)\n+    __builtin_abort ();\n+\n+  __builtin_printf (\"AMDGCN accelerator: gfx%x\\n\", v);\n+\n+  return 0;\n+}"}]}