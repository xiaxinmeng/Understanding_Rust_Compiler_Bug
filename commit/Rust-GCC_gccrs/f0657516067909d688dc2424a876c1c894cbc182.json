{"sha": "f0657516067909d688dc2424a876c1c894cbc182", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjA2NTc1MTYwNjc5MDlkNjg4ZGMyNDI0YTg3NmMxYzg5NGNiYzE4Mg==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2019-12-29T09:28:34Z"}, "committer": {"name": "Richard Sandiford", "email": "rsandifo@gcc.gnu.org", "date": "2019-12-29T09:28:34Z"}, "message": "Unshare DR_STEP before gimplifying it\n\nIn this testcase we use an unmasked SVE loop with an Advanced SIMD\nepilogue (because we don't yet support fully-masked downward loops).\nThe main loop uses a gather load for the strided access while the\nepilogue loop builds the access from scalars instead.  In both cases\nwe gimplify expressions based on the DR_STEP and insert them in the\nloop preheader.\n\nThe problem was that the gather load code didn't copy the DR_STEP before\ngimplifying it, meaning that the epilogue loop tried to reuse a result\nfrom the (non-dominating) main loop preheader.\n\nIt looks at first glance like there could be other instances of this too,\nbut this patch just deals with the gather/scatter case.\n\n2019-12-29  Richard Sandiford  <richard.sandiford@arm.com>\n\ngcc/\n\t* tree-vect-stmts.c (vect_get_strided_load_store_ops): Copy\n\tDR_STEP before gimplifying it.\n\ngcc/testsuite/\n\t* gcc.dg/vect/vect-strided-epilogue-1.c: New test.\n\nFrom-SVN: r279753", "tree": {"sha": "1d475e6edb4ea3d64f91a2f0d8e0a152b4eeaf85", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1d475e6edb4ea3d64f91a2f0d8e0a152b4eeaf85"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f0657516067909d688dc2424a876c1c894cbc182", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f0657516067909d688dc2424a876c1c894cbc182", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f0657516067909d688dc2424a876c1c894cbc182", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f0657516067909d688dc2424a876c1c894cbc182/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "4bbd661e9937d46cc66182423f1946761a4f31c9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4bbd661e9937d46cc66182423f1946761a4f31c9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4bbd661e9937d46cc66182423f1946761a4f31c9"}], "stats": {"total": 21, "additions": 19, "deletions": 2}, "files": [{"sha": "1630efd1ac0a854ba6c5f95c6e46bd399f060a5a", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f0657516067909d688dc2424a876c1c894cbc182/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f0657516067909d688dc2424a876c1c894cbc182/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=f0657516067909d688dc2424a876c1c894cbc182", "patch": "@@ -1,3 +1,8 @@\n+2019-12-29  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\t* tree-vect-stmts.c (vect_get_strided_load_store_ops): Copy\n+\tDR_STEP before gimplifying it.\n+\n 2019-12-29  Richard Sandiford  <richard.sandiford@arm.com>\n \n \t* tree-vect-stmts.c (vectorizable_condition): For extract-last"}, {"sha": "d3079d30304459d1b2ff0dbede2db889d7a875b4", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f0657516067909d688dc2424a876c1c894cbc182/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f0657516067909d688dc2424a876c1c894cbc182/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=f0657516067909d688dc2424a876c1c894cbc182", "patch": "@@ -1,3 +1,7 @@\n+2019-12-29  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\t* gcc.dg/vect/vect-strided-epilogue-1.c: New test.\n+\n 2019-12-29  Richard Sandiford  <richard.sandiford@arm.com>\n \n \t* gcc.dg/vect/vect-cond-12.c: New test."}, {"sha": "e316706204f1d22301c24bb89365218e4deb21a3", "filename": "gcc/testsuite/gcc.dg/vect/vect-strided-epilogue-1.c", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f0657516067909d688dc2424a876c1c894cbc182/gcc%2Ftestsuite%2Fgcc.dg%2Fvect%2Fvect-strided-epilogue-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f0657516067909d688dc2424a876c1c894cbc182/gcc%2Ftestsuite%2Fgcc.dg%2Fvect%2Fvect-strided-epilogue-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fvect%2Fvect-strided-epilogue-1.c?ref=f0657516067909d688dc2424a876c1c894cbc182", "patch": "@@ -0,0 +1,8 @@\n+/* { dg-do compile } */\n+\n+void\n+f (int *x, short *y, int z)\n+{\n+  for (int i = 0; i < 0x82; ++i)\n+    x[-i] += x[z * i];\n+}"}, {"sha": "d4468083cd0b1288b06b4e22436a592f1516f502", "filename": "gcc/tree-vect-stmts.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f0657516067909d688dc2424a876c1c894cbc182/gcc%2Ftree-vect-stmts.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f0657516067909d688dc2424a876c1c894cbc182/gcc%2Ftree-vect-stmts.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-stmts.c?ref=f0657516067909d688dc2424a876c1c894cbc182", "patch": "@@ -2993,7 +2993,7 @@ vect_get_strided_load_store_ops (stmt_vec_info stmt_info,\n   gimple_seq stmts;\n \n   tree bump = size_binop (MULT_EXPR,\n-\t\t\t  fold_convert (sizetype, DR_STEP (dr)),\n+\t\t\t  fold_convert (sizetype, unshare_expr (DR_STEP (dr))),\n \t\t\t  size_int (TYPE_VECTOR_SUBPARTS (vectype)));\n   *dataref_bump = force_gimple_operand (bump, &stmts, true, NULL_TREE);\n   if (stmts)\n@@ -3005,7 +3005,7 @@ vect_get_strided_load_store_ops (stmt_vec_info stmt_info,\n   offset_type = TREE_TYPE (gs_info->offset_vectype);\n \n   /* Calculate X = DR_STEP / SCALE and convert it to the appropriate type.  */\n-  tree step = size_binop (EXACT_DIV_EXPR, DR_STEP (dr),\n+  tree step = size_binop (EXACT_DIV_EXPR, unshare_expr (DR_STEP (dr)),\n \t\t\t  ssize_int (gs_info->scale));\n   step = fold_convert (offset_type, step);\n   step = force_gimple_operand (step, &stmts, true, NULL_TREE);"}]}