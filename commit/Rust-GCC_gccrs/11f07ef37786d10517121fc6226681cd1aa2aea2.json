{"sha": "11f07ef37786d10517121fc6226681cd1aa2aea2", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTFmMDdlZjM3Nzg2ZDEwNTE3MTIxZmM2MjI2NjgxY2QxYWEyYWVhMg==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-12-18T09:07:28Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-12-18T09:07:28Z"}, "message": "c++: Fix PCH ICE with __builtin_source_location [PR98343]\n\nSeems the ggc_remove ppc_nx 3 operand member relies on the hash tables to\ncontain pointers in the first element, which is not the case for\nsource_location_table* hash table, which has location_t and unsigned as\nfirst two members and pointer somewhere else.\nI've tried to change:\n   static void\n   pch_nx (T &p, gt_pointer_operator op, void *cookie)\n   {\n-    op (&p, cookie);\n+    extern void gt_pch_nx (T *, gt_pointer_operator, void *);\n+    gt_pch_nx (&p, op, cookie);\n   }\nin hash-traits.h, but that failed miserably.\nSo, this patch instead overrides the two pch_nx overloads (only the second\none is needed, the former one is identical to the ggc_remove one) but I need\nto override both.\n\n2020-12-18  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR c++/98343\n\t* cp-gimplify.c (source_location_table_entry_hash::pch_nx): Override\n\tstatic member functions from ggc_remove.\n\n\t* g++.dg/pch/pr98343.C: New test.\n\t* g++.dg/pch/pr98343.Hs: New file.", "tree": {"sha": "cdf6ad4b261816eef3ac38f2f65ddc3011c7f429", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cdf6ad4b261816eef3ac38f2f65ddc3011c7f429"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/11f07ef37786d10517121fc6226681cd1aa2aea2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/11f07ef37786d10517121fc6226681cd1aa2aea2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/11f07ef37786d10517121fc6226681cd1aa2aea2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/11f07ef37786d10517121fc6226681cd1aa2aea2/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc00689332f023d959a8e9f01368f59b756a7017", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dc00689332f023d959a8e9f01368f59b756a7017", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dc00689332f023d959a8e9f01368f59b756a7017"}], "stats": {"total": 39, "additions": 39, "deletions": 0}, "files": [{"sha": "110d25ea1dba25822bfdb1bfb563ae44e8123eac", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11f07ef37786d10517121fc6226681cd1aa2aea2/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11f07ef37786d10517121fc6226681cd1aa2aea2/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=11f07ef37786d10517121fc6226681cd1aa2aea2", "patch": "@@ -2931,6 +2931,21 @@ struct source_location_table_entry_hash\n \t    && ref.uid == 0\n \t    && ref.var == NULL_TREE);\n   }\n+\n+  static void\n+  pch_nx (source_location_table_entry &p)\n+  {\n+    extern void gt_pch_nx (source_location_table_entry &);\n+    gt_pch_nx (p);\n+  }\n+\n+  static void\n+  pch_nx (source_location_table_entry &p, gt_pointer_operator op, void *cookie)\n+  {\n+    extern void gt_pch_nx (source_location_table_entry *, gt_pointer_operator,\n+\t\t\t   void *);\n+    gt_pch_nx (&p, op, cookie);\n+  }\n };\n \n static GTY(()) hash_table <source_location_table_entry_hash>"}, {"sha": "095a4f12d676bdfcce01345a7b579577de6fecce", "filename": "gcc/testsuite/g++.dg/pch/pr98343.C", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11f07ef37786d10517121fc6226681cd1aa2aea2/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpch%2Fpr98343.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11f07ef37786d10517121fc6226681cd1aa2aea2/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpch%2Fpr98343.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpch%2Fpr98343.C?ref=11f07ef37786d10517121fc6226681cd1aa2aea2", "patch": "@@ -0,0 +1,6 @@\n+// PR c++/98343\n+// { dg-options \"-std=c++2a\" }\n+\n+#include \"pr98343.H\"\n+\n+const void *ptr2 = __builtin_source_location ();"}, {"sha": "33c8542e365edcd0e42f5e2ee64edb962bbcb820", "filename": "gcc/testsuite/g++.dg/pch/pr98343.Hs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/11f07ef37786d10517121fc6226681cd1aa2aea2/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpch%2Fpr98343.Hs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/11f07ef37786d10517121fc6226681cd1aa2aea2/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpch%2Fpr98343.Hs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpch%2Fpr98343.Hs?ref=11f07ef37786d10517121fc6226681cd1aa2aea2", "patch": "@@ -0,0 +1,18 @@\n+// PR c++/98343\n+// { dg-options \"-std=c++2a\" }\n+\n+namespace std\n+{\n+  struct source_location\n+  {\n+    struct __impl\n+    {\n+      const char* _M_file_name;\n+      const char* _M_function_name;\n+      unsigned _M_line;\n+      unsigned _M_column;\n+    };\n+    const __impl* _M_impl;\n+  };\n+}\n+const void *ptr = __builtin_source_location ();"}]}