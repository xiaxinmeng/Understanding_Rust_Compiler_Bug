{"sha": "6db76e48c18bae5432634a83643542dacf2273e9", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmRiNzZlNDhjMThiYWU1NDMyNjM0YTgzNjQzNTQyZGFjZjIyNzNlOQ==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2019-05-20T13:49:53Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2019-05-20T13:49:53Z"}, "message": "[C++ PATCH] Commonixe using directive finishing\n\nhttps://gcc.gnu.org/ml/gcc-patches/2019-05/msg01251.html\n\tgcc/cp/\n\t* name-lookup.c (finish_namespace_using_directive)\n\t(finish_local_using_directive): Merge to ...\n\t(finish_using_directive): ... here.  Handle both contexts.\n\t* name-lookup.h (finish_namespace_using_directive)\n\t(finish_local_using_directive): Replace with ...\n\t(finish_using_directive): ... this.\n\t* parser.c (cp_parser_using_directive): Adjust.\n\t* pt.c (tsubst_expr): Likewise.\n\n\tlibcc1/\n\t* libcp1plugin.cc (plugin_add_using_namespace): Call renamed\n\tfinish_using_directive.\n\nFrom-SVN: r271420", "tree": {"sha": "6d3edd79956d8bce5509eb3ddbba1ccf9ba719f5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6d3edd79956d8bce5509eb3ddbba1ccf9ba719f5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6db76e48c18bae5432634a83643542dacf2273e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6db76e48c18bae5432634a83643542dacf2273e9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6db76e48c18bae5432634a83643542dacf2273e9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6db76e48c18bae5432634a83643542dacf2273e9/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "eb061601564dfe61d8a2fe8519a7b6057af2b17d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eb061601564dfe61d8a2fe8519a7b6057af2b17d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/eb061601564dfe61d8a2fe8519a7b6057af2b17d"}], "stats": {"total": 91, "additions": 42, "deletions": 49}, "files": [{"sha": "75236fb29687019f98d50c3f754aad8e0602fe20", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -1,5 +1,14 @@\n 2019-05-20  Nathan Sidwell  <nathan@acm.org>\n \n+\t* name-lookup.c (finish_namespace_using_directive)\n+\t(finish_local_using_directive): Merge to ...\n+\t(finish_using_directive): ... here.  Handle both contexts.\n+\t* name-lookup.h (finish_namespace_using_directive)\n+\t(finish_local_using_directive): Replace with ...\n+\t(finish_using_directive): ... this.\n+\t* parser.c (cp_parser_using_directive): Adjust.\n+\t* pt.c (tsubst_expr): Likewise.\n+\n \t* cp-tree.h (struct lang_decl_ns): Remove usings field.\n \t(DECL_NAMESPACE_USING): Delete.\n \t* name-lookup.c (name_lookup::search_usings): Use namespace's"}, {"sha": "f7952eebe0cb94731b3c8cae101729a89f825714", "filename": "gcc/cp/name-lookup.c", "status": "modified", "additions": 23, "deletions": 39, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fname-lookup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fname-lookup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.c?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -7234,54 +7234,38 @@ emit_debug_info_using_namespace (tree from, tree target, bool implicit)\n \t\t\t\t\timplicit);\n }\n \n-/* Process a namespace-scope using directive.  */\n+/* Process a using directive.  */\n \n void\n-finish_namespace_using_directive (tree target, tree attribs)\n+finish_using_directive (tree target, tree attribs)\n {\n-  gcc_checking_assert (namespace_bindings_p ());\n   if (target == error_mark_node)\n     return;\n \n-  add_using_namespace (current_binding_level->using_directives,\n-\t\t       ORIGINAL_NAMESPACE (target));\n-  emit_debug_info_using_namespace (current_namespace,\n-\t\t\t\t   ORIGINAL_NAMESPACE (target), false);\n-\n-  if (attribs == error_mark_node)\n-    return;\n-\n-  for (tree a = attribs; a; a = TREE_CHAIN (a))\n-    {\n-      tree name = get_attribute_name (a);\n-      if (is_attribute_p (\"strong\", name))\n-\t{\n-\t  warning (0, \"strong using directive no longer supported\");\n-\t  if (CP_DECL_CONTEXT (target) == current_namespace)\n-\t    inform (DECL_SOURCE_LOCATION (target),\n-\t\t    \"you may use an inline namespace instead\");\n-\t}\n-      else\n-\twarning (OPT_Wattributes, \"%qD attribute directive ignored\", name);\n-    }\n-}\n-\n-/* Process a function-scope using-directive.  */\n-\n-void\n-finish_local_using_directive (tree target, tree attribs)\n-{\n-  gcc_checking_assert (local_bindings_p ());\n-  if (target == error_mark_node)\n-    return;\n-\n-  if (attribs)\n-    warning (OPT_Wattributes, \"attributes ignored on local using directive\");\n-\n-  add_stmt (build_stmt (input_location, USING_STMT, target));\n+  if (current_binding_level->kind != sk_namespace)\n+    add_stmt (build_stmt (input_location, USING_STMT, target));\n+  else\n+    emit_debug_info_using_namespace (current_binding_level->this_entity,\n+\t\t\t\t     ORIGINAL_NAMESPACE (target), false);\n \n   add_using_namespace (current_binding_level->using_directives,\n \t\t       ORIGINAL_NAMESPACE (target));\n+\n+  if (attribs != error_mark_node)\n+    for (tree a = attribs; a; a = TREE_CHAIN (a))\n+      {\n+\ttree name = get_attribute_name (a);\n+\tif (current_binding_level->kind == sk_namespace\n+\t    && is_attribute_p (\"strong\", name))\n+\t  {\n+\t    warning (0, \"strong using directive no longer supported\");\n+\t    if (CP_DECL_CONTEXT (target) == current_namespace)\n+\t      inform (DECL_SOURCE_LOCATION (target),\n+\t\t      \"you may use an inline namespace instead\");\n+\t  }\n+\telse\n+\t  warning (OPT_Wattributes, \"%qD attribute directive ignored\", name);\n+      }\n }\n \n /* Pushes X into the global namespace.  */"}, {"sha": "aa6180f2d2a45706f2df18a9e0327fb8a00fdd72", "filename": "gcc/cp/name-lookup.h", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fname-lookup.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fname-lookup.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.h?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -1,4 +1,4 @@\n-/* Declarations for C++ name lookup routines.\n+/* Declarations for -*- C++ -*- name lookup routines.\n    Copyright (C) 2003-2019 Free Software Foundation, Inc.\n    Contributed by Gabriel Dos Reis <gdr@integrable-solutions.net>\n \n@@ -317,8 +317,7 @@ extern void cp_emit_debug_info_for_using (tree, tree);\n \n extern void finish_namespace_using_decl (tree, tree, tree);\n extern void finish_local_using_decl (tree, tree, tree);\n-extern void finish_namespace_using_directive (tree, tree);\n-extern void finish_local_using_directive (tree, tree);\n+extern void finish_using_directive (tree, tree);\n extern tree pushdecl (tree, bool is_friend = false);\n extern tree pushdecl_outermost_localscope (tree);\n extern tree pushdecl_top_level (tree, bool is_friend = false);"}, {"sha": "b2d6c33300d40f4195c7f21ce23550694296c25c", "filename": "gcc/cp/parser.c", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fparser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fparser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fparser.c?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -19737,10 +19737,7 @@ cp_parser_using_directive (cp_parser* parser)\n   attribs = cp_parser_attributes_opt (parser);\n \n   /* Update the symbol table.  */\n-  if (namespace_bindings_p ())\n-    finish_namespace_using_directive (namespace_decl, attribs);\n-  else\n-    finish_local_using_directive (namespace_decl, attribs);\n+  finish_using_directive (namespace_decl, attribs);\n \n   /* Look for the final `;'.  */\n   cp_parser_require (parser, CPP_SEMICOLON, RT_SEMICOLON);"}, {"sha": "97d8f08c94d912877000ecfe6e5538691f8f0de0", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -17043,8 +17043,7 @@ tsubst_expr (tree t, tree args, tsubst_flags_t complain, tree in_decl,\n       break;\n \n     case USING_STMT:\n-      finish_local_using_directive (USING_STMT_NAMESPACE (t),\n-\t\t\t\t    /*attribs=*/NULL_TREE);\n+      finish_using_directive (USING_STMT_NAMESPACE (t), /*attribs=*/NULL_TREE);\n       break;\n \n     case DECL_EXPR:"}, {"sha": "376e3622410fb4e72725d53d1264695c3606d603", "filename": "libcc1/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/libcc1%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/libcc1%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcc1%2FChangeLog?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -1,3 +1,8 @@\n+2019-05-20  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* libcp1plugin.cc (plugin_add_using_namespace): Call renamed\n+\tfinish_using_directive.\n+\n 2019-01-01  Jakub Jelinek  <jakub@redhat.com>\n \n \tUpdate copyright years."}, {"sha": "eed94662f85d07d00a13173418febebbf791fe0c", "filename": "libcc1/libcp1plugin.cc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6db76e48c18bae5432634a83643542dacf2273e9/libcc1%2Flibcp1plugin.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6db76e48c18bae5432634a83643542dacf2273e9/libcc1%2Flibcp1plugin.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcc1%2Flibcp1plugin.cc?ref=6db76e48c18bae5432634a83643542dacf2273e9", "patch": "@@ -941,7 +941,7 @@ plugin_add_using_namespace (cc1_plugin::connection *,\n \n   gcc_assert (TREE_CODE (used_ns) == NAMESPACE_DECL);\n \n-  finish_namespace_using_directive (used_ns, NULL_TREE);\n+  finish_using_directive (used_ns, NULL_TREE);\n \n   return 1;\n }"}]}