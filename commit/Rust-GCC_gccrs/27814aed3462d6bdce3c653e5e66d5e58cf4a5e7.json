{"sha": "27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Mjc4MTRhZWQzNDYyZDZiZGNlM2M2NTNlNWU2NmQ1ZTU4Y2Y0YTVlNw==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2019-03-14T13:05:34Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2019-03-14T13:05:34Z"}, "message": "re PR ipa/89684 (ICE in gsi_for_stmt, at gimple-iterator.c:613)\n\n\tPR ipa/89684\n\t* multiple_target.c (create_dispatcher_calls): Change\n\treferences_to_redirect from vector of ipa_ref * to vector of ipa_ref.\n\tIn the node->iterate_referring loop, push *ref rather than ref, call\n\tref->remove_reference () and always pass 0 to iterate_referring.\n\n\t* gcc.target/i386/pr89684.c: New test.\n\nFrom-SVN: r269681", "tree": {"sha": "04ae155d33fa76c4c587c95722b0d0581de16022", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/04ae155d33fa76c4c587c95722b0d0581de16022"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "87654f1813a0f582645f72d87f7fb8c78b92ee6a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/87654f1813a0f582645f72d87f7fb8c78b92ee6a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/87654f1813a0f582645f72d87f7fb8c78b92ee6a"}], "stats": {"total": 46, "additions": 41, "deletions": 5}, "files": [{"sha": "a4015751479c0d4d9b5c8206f60560d3913a22a6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "patch": "@@ -1,5 +1,11 @@\n 2019-03-14  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR ipa/89684\n+\t* multiple_target.c (create_dispatcher_calls): Change\n+\treferences_to_redirect from vector of ipa_ref * to vector of ipa_ref.\n+\tIn the node->iterate_referring loop, push *ref rather than ref, call\n+\tref->remove_reference () and always pass 0 to iterate_referring.\n+\n \tPR rtl-optimization/89679\n \t* expmed.c (expand_mult_const): Don't add a REG_EQUAL note if it\n \twould contain a paradoxical SUBREG."}, {"sha": "fd983cc4ad93858f179e860647119357e36a7757", "filename": "gcc/multiple_target.c", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2Fmultiple_target.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2Fmultiple_target.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fmultiple_target.c?ref=27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "patch": "@@ -103,10 +103,16 @@ create_dispatcher_calls (struct cgraph_node *node)\n     inode->resolve_alias (cgraph_node::get (resolver_decl));\n \n   auto_vec<cgraph_edge *> edges_to_redirect;\n-  auto_vec<ipa_ref *> references_to_redirect;\n+  /* We need to capture the references by value rather than just pointers to them\n+     and remove them right away, as removing them later would invalidate what\n+     some other reference pointers point to.  */\n+  auto_vec<ipa_ref> references_to_redirect;\n \n-  for (unsigned i = 0; node->iterate_referring (i, ref); i++)\n-    references_to_redirect.safe_push (ref);\n+  while (node->iterate_referring (0, ref))\n+    {\n+      references_to_redirect.safe_push (*ref);\n+      ref->remove_reference ();\n+    }\n \n   /* We need to remember NEXT_CALLER as it could be modified in the loop.  */\n   for (cgraph_edge *e = node->callers; e ; e = e->next_caller)\n@@ -146,13 +152,11 @@ create_dispatcher_calls (struct cgraph_node *node)\n \t\t}\n \n \t      symtab_node *source = ref->referring;\n-\t      ref->remove_reference ();\n \t      source->create_reference (inode, IPA_REF_ADDR);\n \t    }\n \t  else if (ref->use == IPA_REF_ALIAS)\n \t    {\n \t      symtab_node *source = ref->referring;\n-\t      ref->remove_reference ();\n \t      source->create_reference (inode, IPA_REF_ALIAS);\n \t      source->add_to_same_comdat_group (inode);\n \t    }"}, {"sha": "a9c52a90b138b4ff2c27b01a86713b90ec1560e9", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "patch": "@@ -1,5 +1,8 @@\n 2019-03-14  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR ipa/89684\n+\t* gcc.target/i386/pr89684.c: New test.\n+\n \tPR rtl-optimization/89679\n \t* gcc.dg/pr89679.c: New test.\n "}, {"sha": "85801bfc25f6bdc8cf28231e8371a10f500c508d", "filename": "gcc/testsuite/gcc.target/i386/pr89684.c", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr89684.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/27814aed3462d6bdce3c653e5e66d5e58cf4a5e7/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr89684.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr89684.c?ref=27814aed3462d6bdce3c653e5e66d5e58cf4a5e7", "patch": "@@ -0,0 +1,23 @@\n+/* PR ipa/89684 */\n+/* { dg-do compile } */\n+/* { dg-require-ifunc \"\" } */\n+\n+void bar (int, void (*) (void));\n+\n+__attribute__((target_clones (\"default\", \"avx\")))\n+void foo (void)\n+{\n+  bar (0, foo);\n+  bar (0, foo);\n+}\n+\n+__attribute__((target_clones (\"default\", \"avx\", \"avx2\")))\n+void baz (void)\n+{\n+  bar (0, foo);\n+  bar (0, foo);\n+  bar (0, foo);\n+  bar (0, foo);\n+  bar (0, foo);\n+  bar (0, foo);\n+}"}]}