{"sha": "a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "node_id": "C_kwDOANBUbNoAKGEyZWFjZGJkNGM0YTY5OGIzYjZmMjdlZjVlMWY4ZGQzZDgzNmIyZTU", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-29T14:04:09Z"}, "committer": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-29T14:16:31Z"}, "message": "[nvptx] Add __PTX_ISA_VERSION_{MAJOR,MINOR}__\n\nAdd preprocessor macros __PTX_ISA_VERSION_MAJOR__ and\n__PTX_ISA_VERSION_MINOR__.\n\nFor the default 6.0, we have:\n...\n $ echo | cc1 -E -dD - 2>&1 | grep PTX_ISA_VERSION\n #define __PTX_ISA_VERSION_MAJOR__ 6\n #define __PTX_ISA_VERSION_MINOR__ 0\n...\nand for 3.1, we have:\n...\n $ echo | cc1 -mptx=3.1 -E -dD - 2>&1 | grep PTX_ISA_VERSION\n #define __PTX_ISA_VERSION_MAJOR__ 3\n #define __PTX_ISA_VERSION_MINOR__ 1\n...\n\nThese can be used to express things like:\n...\n #if __PTX_ISA_VERSION_MAJOR__ >= 4 && __PTX_ISA_VERSION_MAJOR__ >= 1\n   /* Code using %dynamic_smem_size.  */\n #else\n   /* Fallback code.  */\n #endif\n...\n\nTested on nvptx.\n\ngcc/ChangeLog:\n\n2022-03-29  Tom de Vries  <tdevries@suse.de>\n\n\tPR target/104857\n\t* config/nvptx/nvptx-c.cc (nvptx_cpu_cpp_builtins): Emit\n\t__PTX_ISA_VERSION_MAJOR__ and __PTX_ISA_VERSION_MINOR__.\n\t* config/nvptx/nvptx.cc (ptx_version_to_number): New function.\n\t* config/nvptx/nvptx-protos.h (ptx_version_to_number): Declare.\n\ngcc/testsuite/ChangeLog:\n\n2022-03-29  Tom de Vries  <tdevries@suse.de>\n\n\tPR target/104857\n\t* gcc.target/nvptx/ptx31.c: New test.\n\t* gcc.target/nvptx/ptx60.c: New test.\n\t* gcc.target/nvptx/ptx63.c: New test.\n\t* gcc.target/nvptx/ptx70.c: New test.", "tree": {"sha": "b048248848706ee3d0368274b9744bae56ffcfa1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b048248848706ee3d0368274b9744bae56ffcfa1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1625e893cca658a8df3dea50189c932a7025e223", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1625e893cca658a8df3dea50189c932a7025e223", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1625e893cca658a8df3dea50189c932a7025e223"}], "stats": {"total": 72, "additions": 72, "deletions": 0}, "files": [{"sha": "f060a8ab1d411a4ed6397206a46c11c7a425386b", "filename": "gcc/config/nvptx/nvptx-c.cc", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Fconfig%2Fnvptx%2Fnvptx-c.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Fconfig%2Fnvptx%2Fnvptx-c.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx-c.cc?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -49,5 +49,14 @@ nvptx_cpu_cpp_builtins (void)\n #include \"nvptx-sm.def\"\n #undef NVPTX_SM\n   cpp_define (parse_in, ptx_sm);\n+\n+  {\n+    unsigned major\n+      = ptx_version_to_number ((ptx_version)ptx_version_option, true);\n+    unsigned minor\n+      = ptx_version_to_number ((ptx_version)ptx_version_option, false);\n+    cpp_define_formatted (parse_in, \"__PTX_ISA_VERSION_MAJOR__=%u\", major);\n+    cpp_define_formatted (parse_in, \"__PTX_ISA_VERSION_MINOR__=%u\", minor);\n+  }\n }\n "}, {"sha": "dfa08ec83190d202feab37c7b041dbad18229d0f", "filename": "gcc/config/nvptx/nvptx-protos.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Fconfig%2Fnvptx%2Fnvptx-protos.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Fconfig%2Fnvptx%2Fnvptx-protos.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx-protos.h?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -44,6 +44,7 @@ extern void nvptx_cpu_cpp_builtins (void);\n extern void nvptx_register_pragmas (void);\n extern unsigned int nvptx_data_alignment (const_tree, unsigned int);\n extern void nvptx_asm_output_def_from_decls (FILE *, tree, tree);\n+extern unsigned int ptx_version_to_number (enum ptx_version, bool);\n \n #ifdef RTX_CODE\n extern void nvptx_expand_oacc_fork (unsigned);"}, {"sha": "e4297e2d6c33645809576997cfe28aeffea5cd8a", "filename": "gcc/config/nvptx/nvptx.cc", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Fconfig%2Fnvptx%2Fnvptx.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Fconfig%2Fnvptx%2Fnvptx.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx.cc?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -272,6 +272,28 @@ ptx_version_to_string (enum ptx_version v)\n     }\n }\n \n+unsigned int\n+ptx_version_to_number (enum ptx_version v, bool major_p)\n+{\n+  switch (v)\n+    {\n+    case PTX_VERSION_3_0:\n+      return major_p ? 3 : 0;\n+    case PTX_VERSION_3_1:\n+      return major_p ? 3 : 1;\n+    case PTX_VERSION_4_2:\n+      return major_p ? 4 : 2;\n+    case PTX_VERSION_6_0:\n+      return major_p ? 6 : 0;\n+    case PTX_VERSION_6_3:\n+      return major_p ? 6 : 3;\n+    case PTX_VERSION_7_0:\n+      return major_p ? 7 : 0;\n+    default:\n+      gcc_unreachable ();\n+    }\n+}\n+\n static const char *\n sm_version_to_string (enum ptx_isa sm)\n {"}, {"sha": "46b5e1ba4054f0f4759459fe09a52156012a9c96", "filename": "gcc/testsuite/gcc.target/nvptx/ptx31.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx31.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx31.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx31.c?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-march=sm_30 -mptx=3.1\" } */\n+\n+#if __PTX_ISA_VERSION_MAJOR__ != 3\n+#error wrong value for __PTX_ISA_VERSION_MAJOR__\n+#endif\n+\n+#if __PTX_ISA_VERSION_MINOR__ != 1\n+#error wrong value for __PTX_ISA_VERSION_MINOR__\n+#endif"}, {"sha": "267a9c64f1e93fb7e3777fd69ffd00069bd34c06", "filename": "gcc/testsuite/gcc.target/nvptx/ptx60.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx60.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx60.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx60.c?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-march=sm_30 -mptx=6.0\" } */\n+\n+#if __PTX_ISA_VERSION_MAJOR__ != 6\n+#error wrong value for __PTX_ISA_VERSION_MAJOR__\n+#endif\n+\n+#if __PTX_ISA_VERSION_MINOR__ != 0\n+#error wrong value for __PTX_ISA_VERSION_MINOR__\n+#endif"}, {"sha": "13d02e132aea41eeb301681609d34f5b68c6fbe5", "filename": "gcc/testsuite/gcc.target/nvptx/ptx63.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx63.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx63.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx63.c?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-march=sm_30 -mptx=6.3\" } */\n+\n+#if __PTX_ISA_VERSION_MAJOR__ != 6\n+#error wrong value for __PTX_ISA_VERSION_MAJOR__\n+#endif\n+\n+#if __PTX_ISA_VERSION_MINOR__ != 3\n+#error wrong value for __PTX_ISA_VERSION_MINOR__\n+#endif"}, {"sha": "15df13604bd65dc34542240bb6752bf4f9428215", "filename": "gcc/testsuite/gcc.target/nvptx/ptx70.c", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx70.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx70.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fnvptx%2Fptx70.c?ref=a2eacdbd4c4a698b3b6f27ef5e1f8dd3d836b2e5", "patch": "@@ -0,0 +1,10 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-march=sm_30 -mptx=7.0\" } */\n+\n+#if __PTX_ISA_VERSION_MAJOR__ != 7\n+#error wrong value for __PTX_ISA_VERSION_MAJOR__\n+#endif\n+\n+#if __PTX_ISA_VERSION_MINOR__ != 0\n+#error wrong value for __PTX_ISA_VERSION_MINOR__\n+#endif"}]}