{"sha": "24dde337d8bf3f971dd7abc643bb7f1703eaf022", "node_id": "C_kwDOANBUbNoAKDI0ZGRlMzM3ZDhiZjNmOTcxZGQ3YWJjNjQzYmI3ZjE3MDNlYWYwMjI", "commit": {"author": {"name": "Steve Baird", "email": "baird@adacore.com", "date": "2022-11-16T17:28:22Z"}, "committer": {"name": "Marc Poulhi\u00e8s", "email": "poulhies@adacore.com", "date": "2022-11-21T10:10:33Z"}, "message": "ada: Internal compiler error for Sequential Partition_Elaboration_Policy\n\nIn some cases, compilation of a function with a limited class-wide result\ntype could fail with an internal error if a Sequential\nPartition_Elaboration_Policy is specified. To prevent this, we want specifying\na Sequential Partition_Elaboration_Policy to have the side effect of\nimposing a No_Task_Hierarchy restriction. But doing that in a straightforward\nway leads to problems with incorrectly accepting violations of H.6(6). So\na new restriction, No_Task_Hierarchy_Implicit, is introduced.\n\ngcc/ada/\n\n\t* libgnat/s-rident.ads: Define a new restriction,\n\tNo_Task_Hierarchy_Implicit. This is like the No_Task_Hierarchy\n\trestriction, but with the difference that setting this restriction\n\tdoes not mean the H.6(6) post-compilation check is satisified.\n\t* exp_ch6.adb (Add_Task_Actuals_To_Build_In_Place_Call): If it is\n\tknown that the function result cannot have tasks, then pass in a\n\tnull literal for the activation chain actual parameter. This\n\tavoids generating a reference to an entity that\n\tBuild_Activation_Chain_Entity may have chosen not to generate a\n\tdeclaration for.\n\t* gnatbind.adb (List_Applicable_Restrictions): Do not list the\n\tNo_Task_Hierarchy_Implicit restriction.\n\t* restrict.adb: Special treatment for the\n\tNo_Task_Hierarchy_Implicit restriction in functions\n\tGet_Restriction_Id and Restriction_Active. The former is needed to\n\tdisallow the (unlikely) case that a user tries to explicitly\n\treference the No_Task_Hierarchy_Implicit restriction.\n\t* sem_prag.adb (Analyze_Pragma): If a Sequential\n\tPartition_Elaboration_Policy is specified (and the\n\tNo_Task_Hierarchy restriction is not already enabled), then enable\n\tthe No_Task_Hierarchy_Implicit restriction.", "tree": {"sha": "62be5f94a1a918e04b349cba30be560951f2dbfb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/62be5f94a1a918e04b349cba30be560951f2dbfb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/24dde337d8bf3f971dd7abc643bb7f1703eaf022", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/24dde337d8bf3f971dd7abc643bb7f1703eaf022", "html_url": "https://github.com/Rust-GCC/gccrs/commit/24dde337d8bf3f971dd7abc643bb7f1703eaf022", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/24dde337d8bf3f971dd7abc643bb7f1703eaf022/comments", "author": {"login": "swbaird", "id": 50751052, "node_id": "MDQ6VXNlcjUwNzUxMDUy", "avatar_url": "https://avatars.githubusercontent.com/u/50751052?v=4", "gravatar_id": "", "url": "https://api.github.com/users/swbaird", "html_url": "https://github.com/swbaird", "followers_url": "https://api.github.com/users/swbaird/followers", "following_url": "https://api.github.com/users/swbaird/following{/other_user}", "gists_url": "https://api.github.com/users/swbaird/gists{/gist_id}", "starred_url": "https://api.github.com/users/swbaird/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/swbaird/subscriptions", "organizations_url": "https://api.github.com/users/swbaird/orgs", "repos_url": "https://api.github.com/users/swbaird/repos", "events_url": "https://api.github.com/users/swbaird/events{/privacy}", "received_events_url": "https://api.github.com/users/swbaird/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dkm", "id": 87603, "node_id": "MDQ6VXNlcjg3NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/87603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dkm", "html_url": "https://github.com/dkm", "followers_url": "https://api.github.com/users/dkm/followers", "following_url": "https://api.github.com/users/dkm/following{/other_user}", "gists_url": "https://api.github.com/users/dkm/gists{/gist_id}", "starred_url": "https://api.github.com/users/dkm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dkm/subscriptions", "organizations_url": "https://api.github.com/users/dkm/orgs", "repos_url": "https://api.github.com/users/dkm/repos", "events_url": "https://api.github.com/users/dkm/events{/privacy}", "received_events_url": "https://api.github.com/users/dkm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dee004a9681049a55269dfae1506f17229be83c9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dee004a9681049a55269dfae1506f17229be83c9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dee004a9681049a55269dfae1506f17229be83c9"}], "stats": {"total": 44, "additions": 39, "deletions": 5}, "files": [{"sha": "a5dee38c55f71abbc941cbd07c7fa5ac9954c8a7", "filename": "gcc/ada/exp_ch6.adb", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Fexp_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Fexp_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch6.adb?ref=24dde337d8bf3f971dd7abc643bb7f1703eaf022", "patch": "@@ -662,7 +662,10 @@ package body Exp_Ch6 is\n \n       --  Create the actual which is a pointer to the current activation chain\n \n-      if No (Chain) then\n+      if Restriction_Active (No_Task_Hierarchy) then\n+         Chain_Actual := Make_Null (Loc);\n+\n+      elsif No (Chain) then\n          Chain_Actual :=\n            Make_Attribute_Reference (Loc,\n              Prefix         => Make_Identifier (Loc, Name_uChain),"}, {"sha": "509b4d368a81520ab3add660f764ec332b413c8a", "filename": "gcc/ada/gnatbind.adb", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Fgnatbind.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Fgnatbind.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgnatbind.adb?ref=24dde337d8bf3f971dd7abc643bb7f1703eaf022", "patch": "@@ -215,6 +215,9 @@ procedure Gnatbind is\n          No_Specification_Of_Aspect      => False,\n          --  Requires a parameter value, not a count\n \n+         No_Task_Hierarchy_Implicit      => False,\n+         --  A compiler implementation artifact, not a documented restriction\n+\n          No_Use_Of_Attribute             => False,\n          --  Requires a parameter value, not a count\n "}, {"sha": "1c6f2e7156ebe81d8d3434234b335a0364ec153c", "filename": "gcc/ada/libgnat/s-rident.ads", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Flibgnat%2Fs-rident.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Flibgnat%2Fs-rident.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-rident.ads?ref=24dde337d8bf3f971dd7abc643bb7f1703eaf022", "patch": "@@ -107,7 +107,7 @@ package System.Rident is\n       No_Dispatching_Calls,                      -- GNAT\n       No_Dynamic_Accessibility_Checks,           -- GNAT\n       No_Dynamic_Attachment,                     -- Ada 2012 (RM E.7(10/3))\n-      No_Dynamic_CPU_Assignment,                 -- Ada 202x (RM D.7(10/3))\n+      No_Dynamic_CPU_Assignment,                 -- Ada 2022 (RM D.7(10/3))\n       No_Dynamic_Priorities,                     -- (RM D.9(9))\n       No_Enumeration_Maps,                       -- GNAT\n       No_Entry_Calls_In_Elaboration_Code,        -- GNAT\n@@ -152,8 +152,9 @@ package System.Rident is\n       No_Task_Attributes_Package,                -- GNAT\n       No_Task_At_Interrupt_Priority,             -- GNAT\n       No_Task_Hierarchy,                         -- (RM D.7(3), H.4(3))\n+      No_Task_Hierarchy_Implicit,                -- GNAT\n       No_Task_Termination,                       -- Ada 2005 (D.7(15.1/2))\n-      No_Tasks_Unassigned_To_CPU,                -- Ada 202x (D.7(10.10/4))\n+      No_Tasks_Unassigned_To_CPU,                -- Ada 2022 (D.7(10.10/4))\n       No_Tasking,                                -- GNAT\n       No_Terminate_Alternatives,                 -- (RM D.7(6))\n       No_Unchecked_Access,                       -- (RM H.4(18))"}, {"sha": "9965321c75e27c3776aaa0ce3fe9f672f54b53d4", "filename": "gcc/ada/restrict.adb", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Frestrict.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Frestrict.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Frestrict.adb?ref=24dde337d8bf3f971dd7abc643bb7f1703eaf022", "patch": "@@ -897,7 +897,10 @@ package body Restrict is\n          declare\n             S : constant String := Restriction_Id'Image (J);\n          begin\n-            if S = Name_Buffer (1 .. Name_Len) then\n+            if S = Name_Buffer (1 .. Name_Len)\n+              --  users cannot name the N_T_H_Implicit restriction\n+              and then J /= No_Task_Hierarchy_Implicit\n+            then\n                return J;\n             end if;\n          end;\n@@ -1104,7 +1107,12 @@ package body Restrict is\n \n    function Restriction_Active (R : All_Restrictions) return Boolean is\n    begin\n-      return Restrictions.Set (R) and then not Restriction_Warnings (R);\n+      if Restrictions.Set (R) and then not Restriction_Warnings (R) then\n+         return True;\n+      else\n+         return R = No_Task_Hierarchy\n+           and then Restriction_Active (No_Task_Hierarchy_Implicit);\n+      end if;\n    end Restriction_Active;\n \n    --------------------------------"}, {"sha": "f2c1a3f0e6eb8cca100433103908637500ceb53d", "filename": "gcc/ada/sem_prag.adb", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Fsem_prag.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/24dde337d8bf3f971dd7abc643bb7f1703eaf022/gcc%2Fada%2Fsem_prag.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_prag.adb?ref=24dde337d8bf3f971dd7abc643bb7f1703eaf022", "patch": "@@ -21097,6 +21097,25 @@ package body Sem_Prag is\n                if Partition_Elaboration_Policy_Sloc /= System_Location then\n                   Partition_Elaboration_Policy_Sloc := Loc;\n                end if;\n+\n+               if PEP_Val = Name_Sequential\n+                 and then not Restriction_Active (No_Task_Hierarchy)\n+               then\n+                  --  RM H.6(6) guarantees that No_Task_Hierarchy will be\n+                  --  set eventually, so take advantage of that knowledge now.\n+                  --  But we have to do this in a tricky way. If we simply\n+                  --  set the No_Task_Hierarchy restriction here, then the\n+                  --  assumption that the restriction will be set eventually\n+                  --  becomes a self-fulfilling prophecy; the binder can\n+                  --  then mistakenly conclude that the H.6(6) rule is\n+                  --  satisified in cases where the post-compilation check\n+                  --  should fail. So we invent a new restriction,\n+                  --  No_Task_Hierarchy_Implicit, which is treated specially\n+                  --  in the function Restriction_Active.\n+\n+                  Set_Restriction (No_Task_Hierarchy_Implicit, N);\n+                  pragma Assert (Restriction_Active (No_Task_Hierarchy));\n+               end if;\n             end if;\n          end PEP;\n "}]}