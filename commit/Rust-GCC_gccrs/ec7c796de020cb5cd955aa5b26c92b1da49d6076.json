{"sha": "ec7c796de020cb5cd955aa5b26c92b1da49d6076", "node_id": "C_kwDOANBUbNoAKGVjN2M3OTZkZTAyMGNiNWNkOTU1YWE1YjI2YzkyYjFkYTQ5ZDYwNzY", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2022-11-22T22:29:21Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2022-11-22T22:29:21Z"}, "message": "analyzer: only look for named functions in root ns [PR107788]\n\ngcc/analyzer/ChangeLog:\n\tPR analyzer/107788\n\t* known-function-manager.cc (known_function_manager::get_match):\n\tDon't look up fndecls by name when they're not in the root\n\tnamespace.\n\ngcc/testsuite/ChangeLog:\n\tPR analyzer/107788\n\t* g++.dg/analyzer/named-functions.C: New test.\n\nSigned-off-by: David Malcolm <dmalcolm@redhat.com>", "tree": {"sha": "6812248cc7f2b1902be630657dfea27b4a433db6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6812248cc7f2b1902be630657dfea27b4a433db6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ec7c796de020cb5cd955aa5b26c92b1da49d6076", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec7c796de020cb5cd955aa5b26c92b1da49d6076", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ec7c796de020cb5cd955aa5b26c92b1da49d6076", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec7c796de020cb5cd955aa5b26c92b1da49d6076/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64fb291c5839e1a82afb62743172b4eab1267399", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/64fb291c5839e1a82afb62743172b4eab1267399", "html_url": "https://github.com/Rust-GCC/gccrs/commit/64fb291c5839e1a82afb62743172b4eab1267399"}], "stats": {"total": 27, "additions": 24, "deletions": 3}, "files": [{"sha": "c1074bcb6e54a0d1e8fcb921233d3710e342f8f8", "filename": "gcc/analyzer/known-function-manager.cc", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec7c796de020cb5cd955aa5b26c92b1da49d6076/gcc%2Fanalyzer%2Fknown-function-manager.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec7c796de020cb5cd955aa5b26c92b1da49d6076/gcc%2Fanalyzer%2Fknown-function-manager.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fanalyzer%2Fknown-function-manager.cc?ref=ec7c796de020cb5cd955aa5b26c92b1da49d6076", "patch": "@@ -91,6 +91,7 @@ known_function_manager::add (enum internal_fn ifn,\n const known_function *\n known_function_manager::get_match (tree fndecl, const call_details &cd) const\n {\n+  /* Look for a matching built-in.  */\n   if (fndecl_built_in_p (fndecl, BUILT_IN_NORMAL))\n     {\n       if (const known_function *candidate\n@@ -99,10 +100,18 @@ known_function_manager::get_match (tree fndecl, const call_details &cd) const\n \t\t\t\t\t\t    fndecl))\n \t  return candidate;\n     }\n+\n+  /* Look for a match by name.  */\n+\n+  /* Reject fndecls that aren't in the root namespace.  */\n+  if (DECL_CONTEXT (fndecl)\n+      && TREE_CODE (DECL_CONTEXT (fndecl)) != TRANSLATION_UNIT_DECL)\n+    return NULL;\n   if (tree identifier = DECL_NAME (fndecl))\n-      if (const known_function *candidate = get_by_identifier (identifier))\n-\tif (candidate->matches_call_types_p (cd))\n-\t  return candidate;\n+    if (const known_function *candidate = get_by_identifier (identifier))\n+      if (candidate->matches_call_types_p (cd))\n+\treturn candidate;\n+\n   return NULL;\n }\n "}, {"sha": "661a9307b81e72d6f964ab05243cd27f7383631c", "filename": "gcc/testsuite/g++.dg/analyzer/named-functions.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec7c796de020cb5cd955aa5b26c92b1da49d6076/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fanalyzer%2Fnamed-functions.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec7c796de020cb5cd955aa5b26c92b1da49d6076/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fanalyzer%2Fnamed-functions.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fanalyzer%2Fnamed-functions.C?ref=ec7c796de020cb5cd955aa5b26c92b1da49d6076", "patch": "@@ -0,0 +1,12 @@\n+#define NULL ((void *)0)\n+\n+namespace my\n+{\n+  int socket (int, int, int);\n+};\n+\n+void test_my_socket ()\n+{\n+  /* This shouldn't match the known function \"::socket\".  */\n+  my::socket (0, 0, 0); /* { dg-bogus \"leak\" } */\n+}"}]}