{"sha": "bc61048a143b10d8efdc50195f2fc949d036ca92", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmM2MTA0OGExNDNiMTBkOGVmZGM1MDE5NWYyZmM5NDlkMDM2Y2E5Mg==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2017-02-11T17:29:45Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2017-02-11T17:29:45Z"}, "message": "PR c++/77790 - ICE with auto function in C++11 mode\n\n\t* decl.c (undeduced_auto_decl): Remove C++14 limitation.\n\t(require_deduced_type): Add complain parm, return bool.\n\t* cp-tree.h: Adjust.\n\t* decl2.c (mark_used): Use require_deduced_type.\n\nFrom-SVN: r245358", "tree": {"sha": "df0e62895260012d5366675ce6bccec695312750", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/df0e62895260012d5366675ce6bccec695312750"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bc61048a143b10d8efdc50195f2fc949d036ca92", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bc61048a143b10d8efdc50195f2fc949d036ca92", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bc61048a143b10d8efdc50195f2fc949d036ca92", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bc61048a143b10d8efdc50195f2fc949d036ca92/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "31deea5e716be71a07d8f1ec4670e9a074b32127", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/31deea5e716be71a07d8f1ec4670e9a074b32127", "html_url": "https://github.com/Rust-GCC/gccrs/commit/31deea5e716be71a07d8f1ec4670e9a074b32127"}], "stats": {"total": 55, "additions": 36, "deletions": 19}, "files": [{"sha": "553db8a126b56b9474a7237a51dc9c0f73d6cecf", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=bc61048a143b10d8efdc50195f2fc949d036ca92", "patch": "@@ -1,3 +1,11 @@\n+2017-02-11  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/77790 - ICE with auto function in C++11 mode\n+\t* decl.c (undeduced_auto_decl): Remove C++14 limitation.\n+\t(require_deduced_type): Add complain parm, return bool.\n+\t* cp-tree.h: Adjust.\n+\t* decl2.c (mark_used): Use require_deduced_type.\n+\n 2017-02-10  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/78908 - template ops and bitfields"}, {"sha": "0146332181c0a8be28379f9a312a119819bf37b0", "filename": "gcc/cp/cp-tree.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2Fcp-tree.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2Fcp-tree.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-tree.h?ref=bc61048a143b10d8efdc50195f2fc949d036ca92", "patch": "@@ -5909,7 +5909,7 @@ extern tree reshape_init                        (tree, tree, tsubst_flags_t);\n extern tree next_initializable_field (tree);\n extern tree fndecl_declared_return_type\t\t(tree);\n extern bool undeduced_auto_decl\t\t\t(tree);\n-extern void require_deduced_type\t\t(tree);\n+extern bool require_deduced_type\t\t(tree, tsubst_flags_t = tf_warning_or_error);\n \n extern tree finish_case_label\t\t\t(location_t, tree, tree);\n extern tree cxx_maybe_build_cleanup\t\t(tree, tsubst_flags_t);"}, {"sha": "2292a3a2ac97abe3e01c1a0595940dd6ad6ee6ed", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=bc61048a143b10d8efdc50195f2fc949d036ca92", "patch": "@@ -16138,24 +16138,29 @@ fndecl_declared_return_type (tree fn)\n   return TREE_TYPE (TREE_TYPE (fn));\n }\n \n-/* Returns true iff DECL was declared with an auto return type and it has\n+/* Returns true iff DECL was declared with an auto type and it has\n    not yet been deduced to a real type.  */\n \n bool\n undeduced_auto_decl (tree decl)\n {\n-  if (cxx_dialect < cxx14)\n+  if (cxx_dialect < cxx11)\n     return false;\n   return type_uses_auto (TREE_TYPE (decl));\n }\n \n /* Complain if DECL has an undeduced return type.  */\n \n-void\n-require_deduced_type (tree decl)\n+bool\n+require_deduced_type (tree decl, tsubst_flags_t complain)\n {\n   if (undeduced_auto_decl (decl))\n-    error (\"use of %qD before deduction of %<auto%>\", decl);\n+    {\n+      if (complain & tf_error)\n+\terror (\"use of %qD before deduction of %<auto%>\", decl);\n+      return false;\n+    }\n+  return true;\n }\n \n #include \"gt-cp-decl.h\""}, {"sha": "efc0b0e697451250d92c1ba8f101a57094059ad1", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 5, "deletions": 12, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=bc61048a143b10d8efdc50195f2fc949d036ca92", "patch": "@@ -5084,12 +5084,9 @@ mark_used (tree decl, tsubst_flags_t complain)\n       || DECL_LANG_SPECIFIC (decl) == NULL\n       || DECL_THUNK_P (decl))\n     {\n-      if (!processing_template_decl && type_uses_auto (TREE_TYPE (decl)))\n-\t{\n-\t  if (complain & tf_error)\n-\t    error (\"use of %qD before deduction of %<auto%>\", decl);\n-\t  return false;\n-\t}\n+      if (!processing_template_decl\n+\t  && !require_deduced_type (decl, complain))\n+\treturn false;\n       return true;\n     }\n \n@@ -5117,12 +5114,8 @@ mark_used (tree decl, tsubst_flags_t complain)\n       && uses_template_parms (DECL_TI_ARGS (decl)))\n     return true;\n \n-  if (undeduced_auto_decl (decl))\n-    {\n-      if (complain & tf_error)\n-\terror (\"use of %qD before deduction of %<auto%>\", decl);\n-      return false;\n-    }\n+  if (!require_deduced_type (decl, complain))\n+    return false;\n \n   /* If we don't need a value, then we don't need to synthesize DECL.  */\n   if (cp_unevaluated_operand || in_discarded_stmt)"}, {"sha": "a1065af0741183be454b180256256711bb38aa16", "filename": "gcc/testsuite/g++.dg/cpp0x/auto41.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fauto41.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fauto41.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fauto41.C?ref=bc61048a143b10d8efdc50195f2fc949d036ca92", "patch": "@@ -2,4 +2,4 @@\n // { dg-do compile { target c++11 } }\n \n auto foo();\t\t\t// { dg-error \"auto\" \"\" { target { ! c++14 } } }\n-auto fp = foo;\t\t\t// { dg-error \"auto\" \"\" { target c++14 } }\n+auto fp = foo;\t\t\t// { dg-error \"auto\" }"}, {"sha": "a40817442d712b203b1fdf5fe4360559ebb94a9c", "filename": "gcc/testsuite/g++.dg/cpp1y/auto-fn35.C", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fauto-fn35.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bc61048a143b10d8efdc50195f2fc949d036ca92/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fauto-fn35.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fauto-fn35.C?ref=bc61048a143b10d8efdc50195f2fc949d036ca92", "patch": "@@ -0,0 +1,11 @@\n+// PR c++/77790\n+// { dg-do compile { target c++11 } }\n+\n+template < typename S > struct A\n+{\n+  // { dg-error \"\" \"\" { target c++11_only } .+1 }\n+  template < typename T > static auto f () { return 0; } \n+  template < class U = decltype (f < S > ()) > int g () { return 0; }\n+};\n+\n+auto a = A < int > {}.g ();"}]}