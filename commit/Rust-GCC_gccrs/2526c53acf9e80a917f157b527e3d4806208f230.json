{"sha": "2526c53acf9e80a917f157b527e3d4806208f230", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjUyNmM1M2FjZjllODBhOTE3ZjE1N2I1MjdlM2Q0ODA2MjA4ZjIzMA==", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2018-01-05T21:43:56Z"}, "committer": {"name": "Jonathan Wakely", "email": "redi@gcc.gnu.org", "date": "2018-01-05T21:43:56Z"}, "message": "PR libstdc++/83279 Use non-null offset argument for sendfile\n\n\tPR libstdc++/83279\n\t* src/filesystem/std-ops.cc  (do_copy_file): Use non-null offset with\n\tsendfile.\n\nFrom-SVN: r256289", "tree": {"sha": "34def97c545652ba7a9a6b0cf667865c34efbb1d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/34def97c545652ba7a9a6b0cf667865c34efbb1d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2526c53acf9e80a917f157b527e3d4806208f230", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2526c53acf9e80a917f157b527e3d4806208f230", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2526c53acf9e80a917f157b527e3d4806208f230", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2526c53acf9e80a917f157b527e3d4806208f230/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f622221ab42c4ca550059add89ffda00ed2b3c03", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f622221ab42c4ca550059add89ffda00ed2b3c03", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f622221ab42c4ca550059add89ffda00ed2b3c03"}], "stats": {"total": 37, "additions": 19, "deletions": 18}, "files": [{"sha": "444c61550f84111d07b1104736f46823d172f1a0", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2526c53acf9e80a917f157b527e3d4806208f230/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2526c53acf9e80a917f157b527e3d4806208f230/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=2526c53acf9e80a917f157b527e3d4806208f230", "patch": "@@ -1,5 +1,9 @@\n 2018-01-05  Jonathan Wakely  <jwakely@redhat.com>\n \n+\tPR libstdc++/83279\n+\t* src/filesystem/std-ops.cc  (do_copy_file): Use non-null offset with\n+\tsendfile.\n+\n \tPR libstdc++/83626\n \t* src/filesystem/ops.cc (remove(const path&, error_code&)): Do not\n \treport an error for ENOENT."}, {"sha": "bed1ad1fe2714cd570f85fdfd6479007138e1b5d", "filename": "libstdc++-v3/src/filesystem/std-ops.cc", "status": "modified", "additions": 15, "deletions": 18, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2526c53acf9e80a917f157b527e3d4806208f230/libstdc%2B%2B-v3%2Fsrc%2Ffilesystem%2Fstd-ops.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2526c53acf9e80a917f157b527e3d4806208f230/libstdc%2B%2B-v3%2Fsrc%2Ffilesystem%2Fstd-ops.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Ffilesystem%2Fstd-ops.cc?ref=2526c53acf9e80a917f157b527e3d4806208f230", "patch": "@@ -382,10 +382,10 @@ fs::do_copy_file(const char* from, const char* to,\n       return false;\n     }\n \n-  ssize_t n = 0;\n   size_t count = from_st->st_size;\n #ifdef _GLIBCXX_USE_SENDFILE\n-  n = ::sendfile(out.fd, in.fd, nullptr, count);\n+  off_t offset = 0;\n+  ssize_t n = ::sendfile(out.fd, in.fd, &offset, count);\n   if (n < 0 && errno != ENOSYS && errno != EINVAL)\n     {\n       ec.assign(errno, std::generic_category());\n@@ -405,35 +405,32 @@ fs::do_copy_file(const char* from, const char* to,\n     count -= n;\n #endif // _GLIBCXX_USE_SENDFILE\n \n-  __gnu_cxx::stdio_filebuf<char> sbin(in.fd, std::ios::in);\n-  __gnu_cxx::stdio_filebuf<char> sbout(out.fd, std::ios::out);\n+  using std::ios;\n+  __gnu_cxx::stdio_filebuf<char> sbin(in.fd, ios::in|ios::binary);\n+  __gnu_cxx::stdio_filebuf<char> sbout(out.fd, ios::out|ios::binary);\n \n   if (sbin.is_open())\n     in.fd = -1;\n   if (sbout.is_open())\n     out.fd = -1;\n \n-  const std::streampos errpos(std::streamoff(-1));\n-\n-  if (n < 0)\n+#ifdef _GLIBCXX_USE_SENDFILE\n+  if (n != 0)\n     {\n-      auto p1 = sbin.pubseekoff(0, std::ios_base::beg, std::ios_base::in);\n-      auto p2 = sbout.pubseekoff(0, std::ios_base::beg, std::ios_base::out);\n+      if (n < 0)\n+\tn = 0;\n+\n+      const auto p1 = sbin.pubseekoff(n, ios::beg, ios::in);\n+      const auto p2 = sbout.pubseekoff(n, ios::beg, ios::out);\n+\n+      const std::streampos errpos(std::streamoff(-1));\n       if (p1 == errpos || p2 == errpos)\n \t{\n \t  ec = std::make_error_code(std::errc::io_error);\n \t  return false;\n \t}\n     }\n-  else if (n > 0)\n-    {\n-      auto p = sbout.pubseekoff(n, std::ios_base::beg, std::ios_base::out);\n-      if (p == errpos)\n-\t{\n-\t  ec = std::make_error_code(std::errc::io_error);\n-\t  return false;\n-\t}\n-    }\n+#endif\n \n   if (count && !(std::ostream(&sbout) << &sbin))\n     {"}]}