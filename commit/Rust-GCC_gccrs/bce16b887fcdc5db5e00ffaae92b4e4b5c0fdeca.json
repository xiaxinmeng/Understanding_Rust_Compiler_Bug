{"sha": "bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmNlMTZiODg3ZmNkYzVkYjVlMDBmZmFhZTkyYjRlNGI1YzBmZGVjYQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2014-09-18T16:43:28Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2014-09-18T16:43:28Z"}, "message": "re PR c++/63248 (Crash when OpenMP target's array section handling is used with templates)\n\n\tPR c++/63248\n\t* semantics.c (finish_omp_clauses): Don't call cp_omp_mappable_type\n\ton type of type dependent expressions, and don't call it if\n\thandle_omp_array_sections has kept TREE_LIST because something\n\twas type dependent.\n\t* pt.c (tsubst_expr) <case OMP_TARGET, case OMP_TARGET_DATA>:\n\tUse keep_next_level, begin_omp_structured_block and\n\tfinish_omp_structured_block instead of push_stmt_list and\n\tpop_stmt_list.\nlibgomp/\n\t* testsuite/libgomp.c++/pr63248.C: New test.\n\nFrom-SVN: r215359", "tree": {"sha": "29355c71634ce536e2f8aaf0e6ebc5adb9ec9423", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/29355c71634ce536e2f8aaf0e6ebc5adb9ec9423"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "74c101d5fd4ebf45d9127efd82e1325882e48a12", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/74c101d5fd4ebf45d9127efd82e1325882e48a12", "html_url": "https://github.com/Rust-GCC/gccrs/commit/74c101d5fd4ebf45d9127efd82e1325882e48a12"}], "stats": {"total": 102, "additions": 99, "deletions": 3}, "files": [{"sha": "e7e0a3c785b666e1688b3eb675761edfde255c34", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "patch": "@@ -1,3 +1,15 @@\n+2014-09-18  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c++/63248\n+\t* semantics.c (finish_omp_clauses): Don't call cp_omp_mappable_type\n+\ton type of type dependent expressions, and don't call it if\n+\thandle_omp_array_sections has kept TREE_LIST because something\n+\twas type dependent.\n+\t* pt.c (tsubst_expr) <case OMP_TARGET, case OMP_TARGET_DATA>:\n+\tUse keep_next_level, begin_omp_structured_block and\n+\tfinish_omp_structured_block instead of push_stmt_list and\n+\tpop_stmt_list.\n+\n 2014-09-18  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/62232"}, {"sha": "8a12713471b83b42d3cadd59369ae534a225761d", "filename": "gcc/cp/pt.c", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/gcc%2Fcp%2Fpt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/gcc%2Fcp%2Fpt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fpt.c?ref=bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "patch": "@@ -14089,8 +14089,6 @@ tsubst_expr (tree t, tree args, tsubst_flags_t complain, tree in_decl,\n     case OMP_SECTIONS:\n     case OMP_SINGLE:\n     case OMP_TEAMS:\n-    case OMP_TARGET_DATA:\n-    case OMP_TARGET:\n       tmp = tsubst_omp_clauses (OMP_CLAUSES (t), false,\n \t\t\t\targs, complain, in_decl);\n       stmt = push_stmt_list ();\n@@ -14103,6 +14101,22 @@ tsubst_expr (tree t, tree args, tsubst_flags_t complain, tree in_decl,\n       add_stmt (t);\n       break;\n \n+    case OMP_TARGET_DATA:\n+    case OMP_TARGET:\n+      tmp = tsubst_omp_clauses (OMP_CLAUSES (t), false,\n+\t\t\t\targs, complain, in_decl);\n+      keep_next_level (true);\n+      stmt = begin_omp_structured_block ();\n+\n+      RECUR (OMP_BODY (t));\n+      stmt = finish_omp_structured_block (stmt);\n+\n+      t = copy_node (t);\n+      OMP_BODY (t) = stmt;\n+      OMP_CLAUSES (t) = tmp;\n+      add_stmt (t);\n+      break;\n+\n     case OMP_TARGET_UPDATE:\n       tmp = tsubst_omp_clauses (OMP_TARGET_UPDATE_CLAUSES (t), false,\n \t\t\t\targs, complain, in_decl);"}, {"sha": "bcf161bd921cfd81e249219ef184f1526ee223a1", "filename": "gcc/cp/semantics.c", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/gcc%2Fcp%2Fsemantics.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/gcc%2Fcp%2Fsemantics.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsemantics.c?ref=bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "patch": "@@ -5668,7 +5668,9 @@ finish_omp_clauses (tree clauses)\n \t      else\n \t\t{\n \t\t  t = OMP_CLAUSE_DECL (c);\n-\t\t  if (!cp_omp_mappable_type (TREE_TYPE (t)))\n+\t\t  if (TREE_CODE (t) != TREE_LIST\n+\t\t      && !type_dependent_expression_p (t)\n+\t\t      && !cp_omp_mappable_type (TREE_TYPE (t)))\n \t\t    {\n \t\t      error_at (OMP_CLAUSE_LOCATION (c),\n \t\t\t\t\"array section does not have mappable type \"\n@@ -5708,6 +5710,7 @@ finish_omp_clauses (tree clauses)\n \t    remove = true;\n \t  else if (!(OMP_CLAUSE_CODE (c) == OMP_CLAUSE_MAP\n \t\t     && OMP_CLAUSE_MAP_KIND (c) == OMP_CLAUSE_MAP_POINTER)\n+\t\t   && !type_dependent_expression_p (t)\n \t\t   && !cp_omp_mappable_type ((TREE_CODE (TREE_TYPE (t))\n \t\t\t\t\t      == REFERENCE_TYPE)\n \t\t\t\t\t     ? TREE_TYPE (TREE_TYPE (t))"}, {"sha": "72caab9ac8b380d3c036eaa1828355565d7c50db", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "patch": "@@ -1,3 +1,8 @@\n+2014-09-18  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c++/63248\n+\t* testsuite/libgomp.c++/pr63248.C: New test.\n+\n 2014-08-04  Jakub Jelinek  <jakub@redhat.com>\n \n \t* task.c (GOMP_taskgroup_end): If taskgroup->num_children"}, {"sha": "48d3f0af797d85ced1baa7511bcf83f7557e0dfb", "filename": "libgomp/testsuite/libgomp.c++/pr63248.C", "status": "added", "additions": 62, "deletions": 0, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/libgomp%2Ftestsuite%2Flibgomp.c%2B%2B%2Fpr63248.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca/libgomp%2Ftestsuite%2Flibgomp.c%2B%2B%2Fpr63248.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2B%2B%2Fpr63248.C?ref=bce16b887fcdc5db5e00ffaae92b4e4b5c0fdeca", "patch": "@@ -0,0 +1,62 @@\n+// PR c++/63248\n+// { dg-do run }\n+\n+int *v;\n+\n+template <typename T>\n+T\n+foo (T A, T B)\n+{\n+  T a = 2;\n+  T b = 4;\n+\n+#pragma omp target map(v[a:b])\n+  v[a] = 1;\n+\n+#pragma omp target map(v[A:B])\n+  v[a] = 2;\n+\n+#pragma omp target map(A)\n+  A = 19;\n+  return A;\n+}\n+\n+template <int N>\n+int\n+bar (int A, int B)\n+{\n+#pragma omp target map(A)\n+  A = 8;\n+  if (A != 8)\n+    __builtin_abort ();\n+#pragma omp target map(A, B)\n+  {\n+    A = 1;\n+    B = 2;\n+  }\n+  return A + B;\n+}\n+\n+int\n+baz (int A, int B)\n+{\n+#pragma omp target map(A)\n+  A = 8;\n+  if (A != 8)\n+    __builtin_abort ();\n+#pragma omp target map(A, B)\n+  {\n+    A = 1;\n+    B = 2;\n+  }\n+  return A + B;\n+}\n+\n+int\n+main ()\n+{\n+  int a[10] = { 0 };\n+  v = a;\n+  if (foo (1, 5) != 19 || v[2] != 2 || bar<0> (5, 7) != 3 || baz (5, 7) != 3)\n+    __builtin_abort ();\n+}"}]}