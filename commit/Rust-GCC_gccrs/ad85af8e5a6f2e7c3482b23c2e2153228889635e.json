{"sha": "ad85af8e5a6f2e7c3482b23c2e2153228889635e", "node_id": "C_kwDOANBUbNoAKGFkODVhZjhlNWE2ZjJlN2MzNDgyYjIzYzJlMjE1MzIyODg4OTYzNWU", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2021-12-30T17:07:19Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-01-10T09:38:44Z"}, "message": "[Ada] Switch from __sync to __atomic builtins for atomic counters\n\ngcc/ada/\n\n\t* libgnat/s-atocou__builtin.adb (Decrement, Increment): Switch\n\tfrom __sync to __atomic builtins; use 'Address to be consistent\n\twith System.Atomic_Primitives.", "tree": {"sha": "daa9614aecc896106cf096ec58bb540208e4e0fc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/daa9614aecc896106cf096ec58bb540208e4e0fc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ad85af8e5a6f2e7c3482b23c2e2153228889635e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ad85af8e5a6f2e7c3482b23c2e2153228889635e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ad85af8e5a6f2e7c3482b23c2e2153228889635e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ad85af8e5a6f2e7c3482b23c2e2153228889635e/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "68adddccb139f87ff705fd744eb3771fc2c6497a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/68adddccb139f87ff705fd744eb3771fc2c6497a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/68adddccb139f87ff705fd744eb3771fc2c6497a"}], "stats": {"total": 42, "additions": 26, "deletions": 16}, "files": [{"sha": "e17268bfffd497a360be948a8582a716163ff1dc", "filename": "gcc/ada/libgnat/s-atocou__builtin.adb", "status": "modified", "additions": 26, "deletions": 16, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ad85af8e5a6f2e7c3482b23c2e2153228889635e/gcc%2Fada%2Flibgnat%2Fs-atocou__builtin.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ad85af8e5a6f2e7c3482b23c2e2153228889635e/gcc%2Fada%2Flibgnat%2Fs-atocou__builtin.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-atocou__builtin.adb?ref=ad85af8e5a6f2e7c3482b23c2e2153228889635e", "patch": "@@ -29,41 +29,47 @@\n --                                                                          --\n ------------------------------------------------------------------------------\n \n---  This package implements Atomic_Counter and Atomic_Unsigned operations\n---  for platforms where GCC supports __sync_add_and_fetch_4 and\n---  __sync_sub_and_fetch_4 builtins.\n+--  This package implements Atomic_Counter and Atomic_Unsigned operations for\n+--  platforms where GCC supports __atomic_add_fetch and __atomic_sub_fetch\n+--  builtins.\n+\n+with System.Atomic_Primitives; use System.Atomic_Primitives;\n \n package body System.Atomic_Counters is\n \n-   procedure Sync_Add_And_Fetch\n-     (Ptr   : access Atomic_Unsigned;\n-      Value : Atomic_Unsigned);\n-   pragma Import (Intrinsic, Sync_Add_And_Fetch, \"__sync_add_and_fetch_4\");\n+   function Atomic_Add_Fetch\n+     (Ptr   : System.Address;\n+      Val   : Atomic_Unsigned;\n+      Model : Mem_Model := Seq_Cst)\n+     return Atomic_Unsigned;\n+   pragma Import (Intrinsic, Atomic_Add_Fetch, \"__atomic_add_fetch\");\n \n-   function Sync_Sub_And_Fetch\n-     (Ptr   : access Atomic_Unsigned;\n-      Value : Atomic_Unsigned) return Atomic_Unsigned;\n-   pragma Import (Intrinsic, Sync_Sub_And_Fetch, \"__sync_sub_and_fetch_4\");\n+   function Atomic_Sub_Fetch\n+     (Ptr   : System.Address;\n+      Val   : Atomic_Unsigned;\n+      Model : Mem_Model := Seq_Cst)\n+     return Atomic_Unsigned;\n+   pragma Import (Intrinsic, Atomic_Sub_Fetch, \"__atomic_sub_fetch\");\n \n    ---------------\n    -- Decrement --\n    ---------------\n \n    procedure Decrement (Item : aliased in out Atomic_Unsigned) is\n    begin\n-      if Sync_Sub_And_Fetch (Item'Unchecked_Access, 1) = 0 then\n+      if Atomic_Sub_Fetch (Item'Address, 1) = 0 then\n          null;\n       end if;\n    end Decrement;\n \n    function Decrement (Item : aliased in out Atomic_Unsigned) return Boolean is\n    begin\n-      return Sync_Sub_And_Fetch (Item'Unchecked_Access, 1) = 0;\n+      return Atomic_Sub_Fetch (Item'Address, 1) = 0;\n    end Decrement;\n \n    function Decrement (Item : in out Atomic_Counter) return Boolean is\n    begin\n-      return Sync_Sub_And_Fetch (Item.Value'Unchecked_Access, 1) = 0;\n+      return Atomic_Sub_Fetch (Item.Value'Address, 1) = 0;\n    end Decrement;\n \n    ---------------\n@@ -72,12 +78,16 @@ package body System.Atomic_Counters is\n \n    procedure Increment (Item : aliased in out Atomic_Unsigned) is\n    begin\n-      Sync_Add_And_Fetch (Item'Unchecked_Access, 1);\n+      if Atomic_Add_Fetch (Item'Address, 1) = 0 then\n+         null;\n+      end if;\n    end Increment;\n \n    procedure Increment (Item : in out Atomic_Counter) is\n    begin\n-      Sync_Add_And_Fetch (Item.Value'Unchecked_Access, 1);\n+      if Atomic_Add_Fetch (Item.Value'Address, 1) = 0 then\n+         null;\n+      end if;\n    end Increment;\n \n    ----------------"}]}