{"sha": "b4993a629348279023b2c0159169ed62f10ac453", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjQ5OTNhNjI5MzQ4Mjc5MDIzYjJjMDE1OTE2OWVkNjJmMTBhYzQ1Mw==", "commit": {"author": {"name": "CohenArthur", "email": "arthur.cohen@epita.fr", "date": "2021-08-06T21:49:47Z"}, "committer": {"name": "CohenArthur", "email": "arthur.cohen@epita.fr", "date": "2021-08-12T14:55:14Z"}, "message": "module: Add basic filename discovery", "tree": {"sha": "a8be78ea928d605ce6ea8f29a896fcbb48f42af4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a8be78ea928d605ce6ea8f29a896fcbb48f42af4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b4993a629348279023b2c0159169ed62f10ac453", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b4993a629348279023b2c0159169ed62f10ac453", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b4993a629348279023b2c0159169ed62f10ac453", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b4993a629348279023b2c0159169ed62f10ac453/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "53756e1a01c7ac93e8467f577f50c491ca4b2525", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/53756e1a01c7ac93e8467f577f50c491ca4b2525", "html_url": "https://github.com/Rust-GCC/gccrs/commit/53756e1a01c7ac93e8467f577f50c491ca4b2525"}], "stats": {"total": 86, "additions": 86, "deletions": 0}, "files": [{"sha": "6033ce95acd8f0351e726aa6c782f04c8ee109ec", "filename": "gcc/rust/ast/rust-ast-full-test.cc", "status": "modified", "additions": 70, "deletions": 0, "changes": 70, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fast%2Frust-ast-full-test.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fast%2Frust-ast-full-test.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-ast-full-test.cc?ref=b4993a629348279023b2c0159169ed62f10ac453", "patch": "@@ -17,6 +17,9 @@ You should have received a copy of the GNU General Public License\n along with GCC; see the file COPYING3.  If not see\n <http://www.gnu.org/licenses/>.  */\n \n+// FIXME: This does not work on Windows\n+#include <unistd.h>\n+\n #include \"rust-ast-full.h\"\n #include \"rust-diagnostics.h\"\n #include \"rust-ast-visitor.h\"\n@@ -4050,6 +4053,73 @@ Module::add_crate_name (std::vector<std::string> &names) const\n     item->add_crate_name (names);\n }\n \n+static bool\n+file_exists (const std::string path)\n+{\n+  // Simply check if the file exists\n+  // FIXME: This does not work on Windows\n+  return access (path.c_str (), F_OK) != -1;\n+}\n+\n+// FIXME: This function should also check if the module has a `path` outer\n+// attribute and fetch the path from here in that case, i.e:\n+// ```\n+// #[path=\"<dir>/<subdir>/<file>.rs\"]\n+// mod <mod_name>;\n+// ```\n+std::string\n+Module::get_filename ()\n+{\n+  rust_assert (kind == Module::ModuleKind::UNLOADED);\n+\n+  // This corresponds to the path of the file 'including' the module. So the\n+  // file that contains the 'mod <file>;' directive\n+  std::string including_fname (outer_filename);\n+\n+  std::string expected_file_path = module_name + \".rs\";\n+  std::string expected_dir_path = \"mod.rs\";\n+\n+  auto dir_slash_pos = including_fname.rfind (file_separator);\n+  std::string current_directory_name;\n+\n+  // If we haven't found a file_separator, then we have to look for files in the\n+  // current directory ('.')\n+  if (dir_slash_pos == std::string::npos)\n+    current_directory_name = std::string (\".\") + file_separator;\n+  else\n+    current_directory_name\n+      = including_fname.substr (0, dir_slash_pos) + file_separator;\n+\n+  // FIXME: We also have to search for\n+  // <directory>/<including_fname>/<module_name>.rs In rustc, this is done via\n+  // the concept of `DirOwnernship`, which is based on whether or not the\n+  // current file is titled `mod.rs`.\n+\n+  // First, we search for <directory>/<module_name>.rs\n+  bool file_mod_found\n+    = file_exists (current_directory_name + expected_file_path);\n+\n+  // Then, search for <directory>/<module_name>/mod.rs\n+  current_directory_name += module_name + file_separator;\n+  bool dir_mod_found = file_exists (current_directory_name + expected_dir_path);\n+\n+  bool multiple_candidates_found = file_mod_found && dir_mod_found;\n+  bool no_candidates_found = !file_mod_found && !dir_mod_found;\n+\n+  if (multiple_candidates_found)\n+    rust_error_at (locus,\n+\t\t   \"two candidates found for module %s: %s.rs and %s%smod.rs\",\n+\t\t   module_name.c_str (), module_name.c_str (),\n+\t\t   module_name.c_str (), file_separator);\n+\n+  if (no_candidates_found)\n+    rust_error_at (locus, \"no candidate found for module %s\",\n+\t\t   module_name.c_str ());\n+\n+  return file_mod_found ? expected_file_path\n+\t\t\t: current_directory_name + expected_dir_path;\n+}\n+\n void\n Attribute::parse_attr_to_meta_item ()\n {"}, {"sha": "dac76f5ce7a919ecbbd951e198a64ab26cb21c80", "filename": "gcc/rust/ast/rust-item.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fast%2Frust-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fast%2Frust-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-item.h?ref=b4993a629348279023b2c0159169ed62f10ac453", "patch": "@@ -1053,6 +1053,9 @@ class Module : public VisItem\n     return *this;\n   }\n \n+  // Search for the filename associated with an external module\n+  std::string get_filename ();\n+\n   void accept_vis (ASTVisitor &vis) override;\n \n   /* Override that runs the function recursively on all items contained within"}, {"sha": "4998dc8441fabcd4dcfe13ed8c40d4ec37dcc7b1", "filename": "gcc/rust/expand/rust-macro-expand.cc", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fexpand%2Frust-macro-expand.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fexpand%2Frust-macro-expand.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fexpand%2Frust-macro-expand.cc?ref=b4993a629348279023b2c0159169ed62f10ac453", "patch": "@@ -2036,6 +2036,10 @@ class AttrVisitor : public AST::ASTVisitor\n \t    return;\n \t  }\n       }\n+    else\n+      {\n+\tstd::string mod_file = module.get_filename ();\n+      }\n \n     // strip items if required\n     expand_pointer_allow_strip (module.get_items ());"}, {"sha": "731e0b3682f112eeaa19a65d892c7d75181dbac8", "filename": "gcc/rust/parse/rust-parse-impl.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fparse%2Frust-parse-impl.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Fparse%2Frust-parse-impl.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fparse%2Frust-parse-impl.h?ref=b4993a629348279023b2c0159169ed62f10ac453", "patch": "@@ -2101,6 +2101,7 @@ Parser<ManagedTokenSource>::parse_module (AST::Visibility vis,\n     case SEMICOLON:\n       lexer.skip_token ();\n \n+      // Construct an external module\n       return std::unique_ptr<AST::Module> (\n \tnew AST::Module (std::move (name), std::move (vis),\n \t\t\t std::move (outer_attrs), locus,"}, {"sha": "40bca63e67bbe6c2f9e6721a88cdff22289bb058", "filename": "gcc/rust/rust-system.h", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Frust-system.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b4993a629348279023b2c0159169ed62f10ac453/gcc%2Frust%2Frust-system.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Frust-system.h?ref=b4993a629348279023b2c0159169ed62f10ac453", "patch": "@@ -59,6 +59,14 @@\n #include \"diagnostic-core.h\" /* For error_at and friends.  */\n #include \"intl.h\"\t     /* For _().  */\n \n+// File separator to use based on whether or not the OS we're working with is\n+// DOS-based\n+#if defined(HAVE_DOS_BASED_FILE_SYSTEM)\n+constexpr static const char *file_separator = \"\\\\\";\n+#else\n+constexpr static const char *file_separator = \"/\";\n+#endif /* HAVE_DOS_BASED_FILE_SYSTEM */\n+\n // When using gcc, rust_assert is just gcc_assert.\n #define rust_assert(EXPR) gcc_assert (EXPR)\n "}]}