{"sha": "a5a9400a846244d040caa6d1531434eee8fc8ec7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTVhOTQwMGE4NDYyNDRkMDQwY2FhNmQxNTMxNDM0ZWVlOGZjOGVjNw==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-03-24T08:34:58Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-03-24T08:34:58Z"}, "message": "if-conv: Fix -fcompare-debug bugs in ifcvt_local_dce [PR94283]\n\nThe following testcase shows -fcompare-debug bugs in ifcvt_local_dce,\nwhere the decisions what statements are needed is based also on debug stmt\noperands, which is wrong.\nSo, this patch makes sure to never add debug stmt to the worklist, or never\nadd an assign to worklist just because it is used in a debug stmt in another\nbb.\n\n2020-03-24  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR debug/94283\n\t* tree-if-conv.c (ifcvt_local_dce): For gimple debug stmts, just set\n\tGF_PLF_2, but don't add them to worklist.  Don't add an assigment to\n\tworklist or set GF_PLF_2 just because it is used in a debug stmt in\n\tanother bb.  Formatting improvements.\n\n\t* gcc.target/i386/pr94283.c: New test.", "tree": {"sha": "ca4119bfe02afa21051bd69a493ae5bc50c63571", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ca4119bfe02afa21051bd69a493ae5bc50c63571"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a5a9400a846244d040caa6d1531434eee8fc8ec7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a5a9400a846244d040caa6d1531434eee8fc8ec7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a5a9400a846244d040caa6d1531434eee8fc8ec7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a5a9400a846244d040caa6d1531434eee8fc8ec7/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "047811579f09048ed538674fd5251b35e5a92025", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/047811579f09048ed538674fd5251b35e5a92025", "html_url": "https://github.com/Rust-GCC/gccrs/commit/047811579f09048ed538674fd5251b35e5a92025"}], "stats": {"total": 28, "additions": 22, "deletions": 6}, "files": [{"sha": "51cb52dbb10f6827041b7b5a0953e615c83943e4", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a5a9400a846244d040caa6d1531434eee8fc8ec7", "patch": "@@ -1,5 +1,11 @@\n 2020-03-24  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR debug/94283\n+\t* tree-if-conv.c (ifcvt_local_dce): For gimple debug stmts, just set\n+\tGF_PLF_2, but don't add them to worklist.  Don't add an assigment to\n+\tworklist or set GF_PLF_2 just because it is used in a debug stmt in\n+\tanother bb.  Formatting improvements.\n+\n \tPR debug/94277\n \t* cgraphunit.c (check_global_declaration): For DECL_EXTERNAL and\n \tnon-TREE_PUBLIC non-DECL_ARTIFICIAL FUNCTION_DECLs, set TREE_PUBLIC"}, {"sha": "e050d159d5c8eb8dfc85cb0b79938f73ffa3f8dd", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a5a9400a846244d040caa6d1531434eee8fc8ec7", "patch": "@@ -1,5 +1,8 @@\n 2020-03-24  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR debug/94283\n+\t* gcc.target/i386/pr94283.c: New test.\n+\n \tPR debug/94277\n \t* gcc.dg/pr94277.c: New test.\n "}, {"sha": "4982f7d01d7708dbb93cc04fcf4d70e2a4b9745c", "filename": "gcc/testsuite/gcc.target/i386/pr94283.c", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr94283.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr94283.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr94283.c?ref=a5a9400a846244d040caa6d1531434eee8fc8ec7", "patch": "@@ -0,0 +1,5 @@\n+/* PR debug/94283 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O3 -fcompare-debug -mavx2\" } */\n+\n+#include \"../../gcc.dg/fold-bopcond-1.c\""}, {"sha": "dd11d805c77f2fed4f2522ca3a0d045e2a59327c", "filename": "gcc/tree-if-conv.c", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2Ftree-if-conv.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a5a9400a846244d040caa6d1531434eee8fc8ec7/gcc%2Ftree-if-conv.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-if-conv.c?ref=a5a9400a846244d040caa6d1531434eee8fc8ec7", "patch": "@@ -2917,9 +2917,12 @@ ifcvt_local_dce (class loop *loop)\n   for (gsi = gsi_start_bb (bb); !gsi_end_p (gsi); gsi_next (&gsi))\n     {\n       stmt = gsi_stmt (gsi);\n-      if (gimple_store_p (stmt)\n-\t  || gimple_assign_load_p (stmt)\n-\t  || is_gimple_debug (stmt))\n+      if (is_gimple_debug (stmt))\n+\t{\n+\t  gimple_set_plf (stmt, GF_PLF_2, true);\n+\t  continue;\n+\t}\n+      if (gimple_store_p (stmt) || gimple_assign_load_p (stmt))\n \t{\n \t  gimple_set_plf (stmt, GF_PLF_2, true);\n \t  worklist.safe_push (stmt);\n@@ -2940,7 +2943,7 @@ ifcvt_local_dce (class loop *loop)\n \t  FOR_EACH_IMM_USE_FAST (use_p, imm_iter, lhs)\n \t    {\n \t      stmt1 = USE_STMT (use_p);\n-\t      if (gimple_bb (stmt1) != bb)\n+\t      if (!is_gimple_debug (stmt1) && gimple_bb (stmt1) != bb)\n \t\t{\n \t\t  gimple_set_plf (stmt, GF_PLF_2, true);\n \t\t  worklist.safe_push (stmt);\n@@ -2963,8 +2966,7 @@ ifcvt_local_dce (class loop *loop)\n \t  if (TREE_CODE (use) != SSA_NAME)\n \t    continue;\n \t  stmt1 = SSA_NAME_DEF_STMT (use);\n-\t  if (gimple_bb (stmt1) != bb\n-\t      || gimple_plf (stmt1, GF_PLF_2))\n+\t  if (gimple_bb (stmt1) != bb || gimple_plf (stmt1, GF_PLF_2))\n \t    continue;\n \t  gimple_set_plf (stmt1, GF_PLF_2, true);\n \t  worklist.safe_push (stmt1);"}]}