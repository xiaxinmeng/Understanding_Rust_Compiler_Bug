{"sha": "17fd72cef4060b14c2cf363726261f820fdcab10", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTdmZDcyY2VmNDA2MGIxNGMyY2YzNjM3MjYyNjFmODIwZmRjYWIxMA==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2016-04-21T08:21:47Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2016-04-21T08:21:47Z"}, "message": "sem_ch6.adb (Analyze_Subprogram_Body_Helper): If the body is created for SPARK_To_C...\n\n2016-04-21  Ed Schonberg  <schonberg@adacore.com>\n\n\t* sem_ch6.adb (Analyze_Subprogram_Body_Helper): If the body is\n\tcreated for SPARK_To_C, the entity must remain invisible so it\n\tdoes not overload subsequent references to the original function.\n\t* exp_ch6.adb (Build_Procedure_Body_Form, Replace_Returns):\n\tHandle Extended_Return_Statements by replacing it with a block\n\twith assignments and a simple return statement.\n\t* exp_util.adb (Build_Procedure_Form): Make procedure entity\n\tinvisible after analyzing declaration, to prevent improper\n\toverloading.\n\nFrom-SVN: r235306", "tree": {"sha": "6d78cfbf4eddbde7ffc65d7c92d2e4e1c9f74bc3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6d78cfbf4eddbde7ffc65d7c92d2e4e1c9f74bc3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/17fd72cef4060b14c2cf363726261f820fdcab10", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/17fd72cef4060b14c2cf363726261f820fdcab10", "html_url": "https://github.com/Rust-GCC/gccrs/commit/17fd72cef4060b14c2cf363726261f820fdcab10", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/17fd72cef4060b14c2cf363726261f820fdcab10/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "aeb98f1dcd25905b55c0b30c3189e9ddae55b7d2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aeb98f1dcd25905b55c0b30c3189e9ddae55b7d2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aeb98f1dcd25905b55c0b30c3189e9ddae55b7d2"}], "stats": {"total": 65, "additions": 61, "deletions": 4}, "files": [{"sha": "1383b3a959fc8692fbd33aee72905de4d1444941", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=17fd72cef4060b14c2cf363726261f820fdcab10", "patch": "@@ -1,3 +1,15 @@\n+2016-04-21  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_ch6.adb (Analyze_Subprogram_Body_Helper): If the body is\n+\tcreated for SPARK_To_C, the entity must remain invisible so it\n+\tdoes not overload subsequent references to the original function.\n+\t* exp_ch6.adb (Build_Procedure_Body_Form, Replace_Returns):\n+\tHandle Extended_Return_Statements by replacing it with a block\n+\twith assignments and a simple return statement.\n+\t* exp_util.adb (Build_Procedure_Form): Make procedure entity\n+\tinvisible after analyzing declaration, to prevent improper\n+\toverloading.\n+\n 2016-04-21  Javier Miranda  <miranda@adacore.com>\n \n \t* sem_ch6.adb (Build_Subprogram_Declaration): Propagate the"}, {"sha": "4dcd4e9d8a62fa45acf47efab397d6d03cd7698a", "filename": "gcc/ada/exp_ch6.adb", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2Fexp_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2Fexp_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch6.adb?ref=17fd72cef4060b14c2cf363726261f820fdcab10", "patch": "@@ -692,6 +692,38 @@ package body Exp_Ch6 is\n                   end loop;\n                end;\n \n+            elsif Nkind (Stmt) = N_Extended_Return_Statement then\n+               declare\n+                  Ret_Obj : constant Entity_Id :=\n+                              Defining_Entity\n+                                (First (Return_Object_Declarations (Stmt)));\n+                  Assign  : constant Node_Id :=\n+                              Make_Assignment_Statement (Sloc (Stmt),\n+                                Name       =>\n+                                  New_Occurrence_Of (Param_Id, Loc),\n+                                Expression =>\n+                                  New_Occurrence_Of (Ret_Obj, Sloc (Stmt)));\n+                  Stmts   : constant List_Id :=\n+                              Statements (Handled_Statement_Sequence (Stmt));\n+\n+               begin\n+                  Set_Assignment_OK (Name (Assign));\n+\n+                  Rewrite (Stmt,\n+                    Make_Block_Statement (Sloc (Stmt),\n+                      Declarations               =>\n+                        Return_Object_Declarations (Stmt),\n+                      Handled_Statement_Sequence =>\n+                        Make_Handled_Sequence_Of_Statements (Loc,\n+                          Statements =>\n+                            Statements (Handled_Statement_Sequence (Stmt)))));\n+\n+                  Replace_Returns (Param_Id, Stmts);\n+\n+                  Append_To (Stmts, Assign);\n+                  Append_To (Stmts, Make_Simple_Return_Statement (Loc));\n+               end;\n+\n             elsif Nkind (Stmt) = N_If_Statement then\n                Replace_Returns (Param_Id, Then_Statements (Stmt));\n                Replace_Returns (Param_Id, Else_Statements (Stmt));"}, {"sha": "13773faa915e8c22829914019fdcb7ee0c658673", "filename": "gcc/ada/exp_util.adb", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2Fexp_util.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2Fexp_util.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_util.adb?ref=17fd72cef4060b14c2cf363726261f820fdcab10", "patch": "@@ -929,6 +929,7 @@ package body Exp_Util is\n \n       Func_Formal  : Entity_Id;\n       Proc_Formals : List_Id;\n+      Proc_Decl    : Node_Id;\n \n    begin\n       --  No action needed if this transformation was already done\n@@ -969,13 +970,20 @@ package body Exp_Util is\n       --  function declaration. The processing in Build_Procedure_Body_Form\n       --  relies on this order.\n \n-      Insert_After_And_Analyze (Unit_Declaration_Node (Subp),\n+      Proc_Decl :=\n         Make_Subprogram_Declaration (Loc,\n           Specification =>\n             Make_Procedure_Specification (Loc,\n               Defining_Unit_Name       =>\n                 Make_Defining_Identifier (Loc, Chars (Subp)),\n-              Parameter_Specifications => Proc_Formals)));\n+              Parameter_Specifications => Proc_Formals));\n+\n+      Insert_After_And_Analyze (Unit_Declaration_Node (Subp), Proc_Decl);\n+\n+      --  Entity of procedure must remain invisible so that it does not\n+      --  overload subsequent references to the original function.\n+\n+      Set_Is_Immediately_Visible (Defining_Entity (Proc_Decl), False);\n \n       --  Mark the function as having a procedure form\n "}, {"sha": "fe1c898bd1837ce22dfb4fa16d9c06b7efed52c2", "filename": "gcc/ada/sem_ch6.adb", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2Fsem_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/17fd72cef4060b14c2cf363726261f820fdcab10/gcc%2Fada%2Fsem_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch6.adb?ref=17fd72cef4060b14c2cf363726261f820fdcab10", "patch": "@@ -4138,9 +4138,14 @@ package body Sem_Ch6 is\n       --  that carries the return value.\n \n       if Present (Cloned_Body_For_C) then\n-         Rewrite (N,\n-           Build_Procedure_Body_Form (Spec_Id, Cloned_Body_For_C));\n+         Rewrite (N, Build_Procedure_Body_Form (Spec_Id, Cloned_Body_For_C));\n          Analyze (N);\n+\n+         --  The entity for the created procedure must remain invisible, so it\n+         --  does not participate in resolution of subsequent references to the\n+         --  function.\n+\n+         Set_Is_Immediately_Visible (Corresponding_Spec (N), False);\n       end if;\n \n       Ghost_Mode := Save_Ghost_Mode;"}]}