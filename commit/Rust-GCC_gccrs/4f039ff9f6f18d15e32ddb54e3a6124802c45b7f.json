{"sha": "4f039ff9f6f18d15e32ddb54e3a6124802c45b7f", "node_id": "C_kwDOANBUbNoAKDRmMDM5ZmY5ZjZmMThkMTVlMzJkZGI1NGUzYTYxMjQ4MDJjNDViN2Y", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-08-17T10:30:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-17T10:30:28Z"}, "message": "Merge #1474\n\n1474: unsafe: Allow calls to safe intrinsics r=CohenArthur a=CohenArthur\n\nFixes #1461 \n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>", "tree": {"sha": "d406102dcbe1fc7954bd2ab8ca230e347a2d7e2e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d406102dcbe1fc7954bd2ab8ca230e347a2d7e2e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi/MNECRBK7hj4Ov3rIwAAkfcIADBzwrJZIsCMsrLuvjzGLiGL\nOLG8DaxS+MNxbDD/bgkJRRzL8yTV+/jWWM5HHEvYDNoQJPELHWLRYuYskfztpumd\n0+vXFUeqIrBmC01xIDOOkFHIxy1z0dGO6olOL4ZYo8X79uWtkODnOeRN9yT2L4dP\ntuSBJ1RHIlM9PH5UjP6u/f3Jlu+PwOGw50jcjtRzYqYzHcU+Xpj6QuTRFgBicImu\n50sFdEeMkmlxpj5QL3CYvAH+m366FTWSEQ4QHxtO8AGxvQUQx72Hz8xLYQBOmiKT\n7HBc6ImpLvKSyvxwnlN+2VLawQ2YN8GfdKMHK/+CFsqyYTY1sTCAnO0nHkc6iXs=\n=dbT1\n-----END PGP SIGNATURE-----\n", "payload": "tree d406102dcbe1fc7954bd2ab8ca230e347a2d7e2e\nparent 4665766d3cc9854d1609b71f673e96e0a340805c\nparent 3b8642ed962481d9556a7baf6e6cae40355eb6e6\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1660732228 +0000\ncommitter GitHub <noreply@github.com> 1660732228 +0000\n\nMerge #1474\n\n1474: unsafe: Allow calls to safe intrinsics r=CohenArthur a=CohenArthur\n\nFixes #1461 \n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4665766d3cc9854d1609b71f673e96e0a340805c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4665766d3cc9854d1609b71f673e96e0a340805c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4665766d3cc9854d1609b71f673e96e0a340805c"}, {"sha": "3b8642ed962481d9556a7baf6e6cae40355eb6e6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b8642ed962481d9556a7baf6e6cae40355eb6e6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3b8642ed962481d9556a7baf6e6cae40355eb6e6"}], "stats": {"total": 69, "additions": 66, "deletions": 3}, "files": [{"sha": "e3f325395628092b2381b16c4a1e5fb3823ef6c2", "filename": "gcc/rust/checks/errors/rust-unsafe-checker.cc", "status": "modified", "additions": 54, "deletions": 3, "changes": 57, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fchecks%2Ferrors%2Frust-unsafe-checker.cc?ref=4f039ff9f6f18d15e32ddb54e3a6124802c45b7f", "patch": "@@ -90,6 +90,50 @@ check_unsafe_call (HIR::Function *fn, Location locus, const std::string &kind)\n \t\t   kind.c_str ());\n }\n \n+static bool\n+is_safe_intrinsic (const std::string &fn_name)\n+{\n+  static const std::unordered_set<std::string> safe_intrinsics = {\n+    \"abort\",\n+    \"size_of\",\n+    \"min_align_of\",\n+    \"needs_drop\",\n+    \"caller_location\",\n+    \"add_with_overflow\",\n+    \"sub_with_overflow\",\n+    \"mul_with_overflow\",\n+    \"wrapping_add\",\n+    \"wrapping_sub\",\n+    \"wrapping_mul\",\n+    \"saturating_add\",\n+    \"saturating_sub\",\n+    \"rotate_left\",\n+    \"rotate_right\",\n+    \"ctpop\",\n+    \"ctlz\",\n+    \"cttz\",\n+    \"bswap\",\n+    \"bitreverse\",\n+    \"discriminant_value\",\n+    \"type_id\",\n+    \"likely\",\n+    \"unlikely\",\n+    \"ptr_guaranteed_eq\",\n+    \"ptr_guaranteed_ne\",\n+    \"minnumf32\",\n+    \"minnumf64\",\n+    \"maxnumf32\",\n+    \"rustc_peek\",\n+    \"maxnumf64\",\n+    \"type_name\",\n+    \"forget\",\n+    \"black_box\",\n+    \"variant_count\",\n+  };\n+\n+  return safe_intrinsics.find (fn_name) != safe_intrinsics.end ();\n+}\n+\n static void\n check_extern_call (HIR::ExternalItem *maybe_fn, HIR::ExternBlock *parent_block,\n \t\t   Location locus)\n@@ -103,9 +147,16 @@ check_extern_call (HIR::ExternalItem *maybe_fn, HIR::ExternBlock *parent_block,\n   // hand, any function defined in a block with a specific ABI (even `extern\n   // \"Rust\"` blocks) is unsafe to call\n \n-  if (maybe_fn->get_extern_kind () == ExternalItem::ExternKind::Function)\n-    rust_error_at (locus,\n-\t\t   \"call to extern function requires unsafe function or block\");\n+  if (maybe_fn->get_extern_kind () != ExternalItem::ExternKind::Function)\n+    return;\n+\n+  // Some intrinsics are safe to call\n+  if (parent_block->get_abi () == Rust::ABI::INTRINSIC\n+      && is_safe_intrinsic (maybe_fn->get_item_name ()))\n+    return;\n+\n+  rust_error_at (locus,\n+\t\t \"call to extern function requires unsafe function or block\");\n }\n \n void"}, {"sha": "6b6be06b908dbfd95534116b8fa5c8c02a2446aa", "filename": "gcc/testsuite/rust/compile/unsafe10.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f/gcc%2Ftestsuite%2Frust%2Fcompile%2Funsafe10.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f039ff9f6f18d15e32ddb54e3a6124802c45b7f/gcc%2Ftestsuite%2Frust%2Fcompile%2Funsafe10.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Funsafe10.rs?ref=4f039ff9f6f18d15e32ddb54e3a6124802c45b7f", "patch": "@@ -0,0 +1,12 @@\n+extern \"rust-intrinsic\" {\n+    pub fn rotate_left<T>(l: T, r: T) -> T;\n+}\n+\n+fn main() -> i32 {\n+    let a = 15;\n+    let b = 15;\n+\n+    let _ = rotate_left(a, b);\n+\n+    0\n+}"}]}