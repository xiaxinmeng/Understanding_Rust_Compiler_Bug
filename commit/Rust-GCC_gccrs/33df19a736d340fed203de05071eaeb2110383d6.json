{"sha": "33df19a736d340fed203de05071eaeb2110383d6", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzNkZjE5YTczNmQzNDBmZWQyMDNkZTA1MDcxZWFlYjIxMTAzODNkNg==", "commit": {"author": {"name": "Edward Smith-Rowland", "email": "3dw4rd@verizon.net", "date": "2015-08-26T21:27:09Z"}, "committer": {"name": "Jonathan Wakely", "email": "redi@gcc.gnu.org", "date": "2015-08-26T21:27:09Z"}, "message": "Ensure std::generate_canonical doesn't return 1.\n\n2015-08-26  Edward Smith-Rowland  <3dw4rd@verizon.net>\n\t    Jonathan Wakely  <jwakely@redhat.com>\n\n\tPR libstdc++/64351\n\tPR libstdc++/63176\n\t* include/bits/random.tcc (generate_canonical): Loop until we get a\n\tresult less than one.\n\t* testsuite/26_numerics/random/uniform_real_distribution/operators/\n\t64351.cc: New.\n\nCo-Authored-By: Jonathan Wakely <jwakely@redhat.com>\n\nFrom-SVN: r227233", "tree": {"sha": "8eec2beadb20e9fa0350b2eb2acefcab3927bbf5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8eec2beadb20e9fa0350b2eb2acefcab3927bbf5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/33df19a736d340fed203de05071eaeb2110383d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/33df19a736d340fed203de05071eaeb2110383d6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/33df19a736d340fed203de05071eaeb2110383d6", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/33df19a736d340fed203de05071eaeb2110383d6/comments", "author": {"login": "emsr", "id": 1936479, "node_id": "MDQ6VXNlcjE5MzY0Nzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1936479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emsr", "html_url": "https://github.com/emsr", "followers_url": "https://api.github.com/users/emsr/followers", "following_url": "https://api.github.com/users/emsr/following{/other_user}", "gists_url": "https://api.github.com/users/emsr/gists{/gist_id}", "starred_url": "https://api.github.com/users/emsr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emsr/subscriptions", "organizations_url": "https://api.github.com/users/emsr/orgs", "repos_url": "https://api.github.com/users/emsr/repos", "events_url": "https://api.github.com/users/emsr/events{/privacy}", "received_events_url": "https://api.github.com/users/emsr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6bc41b268ea0e16e001f73a9760a9c847c6aa87c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6bc41b268ea0e16e001f73a9760a9c847c6aa87c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6bc41b268ea0e16e001f73a9760a9c847c6aa87c"}], "stats": {"total": 88, "additions": 81, "deletions": 7}, "files": [{"sha": "106b23a641d8b426086b0b5710666fcd7681e744", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/33df19a736d340fed203de05071eaeb2110383d6/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/33df19a736d340fed203de05071eaeb2110383d6/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=33df19a736d340fed203de05071eaeb2110383d6", "patch": "@@ -1,3 +1,13 @@\n+2015-08-26  Edward Smith-Rowland  <3dw4rd@verizon.net>\n+\t    Jonathan Wakely  <jwakely@redhat.com>\n+\n+\tPR libstdc++/64351\n+\tPR libstdc++/63176\n+\t* include/bits/random.tcc (generate_canonical): Loop until we get a\n+\tresult less than one.\n+\t* testsuite/26_numerics/random/uniform_real_distribution/operators/\n+\t64351.cc: New.\n+\n 2015-08-26  Jonathan Wakely  <jwakely@redhat.com>\n \n \t* include/bits/shared_ptr.h (__enable_shared_from_this_helper): Use"}, {"sha": "a6d966b28d78f4838cb13ab8ca2015d2490ade7f", "filename": "libstdc++-v3/include/bits/random.tcc", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/33df19a736d340fed203de05071eaeb2110383d6/libstdc%2B%2B-v3%2Finclude%2Fbits%2Frandom.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/33df19a736d340fed203de05071eaeb2110383d6/libstdc%2B%2B-v3%2Finclude%2Fbits%2Frandom.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Frandom.tcc?ref=33df19a736d340fed203de05071eaeb2110383d6", "patch": "@@ -3472,15 +3472,22 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n       const long double __r = static_cast<long double>(__urng.max())\n \t\t\t    - static_cast<long double>(__urng.min()) + 1.0L;\n       const size_t __log2r = std::log(__r) / std::log(2.0L);\n-      size_t __k = std::max<size_t>(1UL, (__b + __log2r - 1UL) / __log2r);\n-      _RealType __sum = _RealType(0);\n-      _RealType __tmp = _RealType(1);\n-      for (; __k != 0; --__k)\n+      const size_t __m = std::max<size_t>(1UL,\n+\t\t\t\t\t  (__b + __log2r - 1UL) / __log2r);\n+      _RealType __ret;\n+      do\n \t{\n-\t  __sum += _RealType(__urng() - __urng.min()) * __tmp;\n-\t  __tmp *= __r;\n+\t  _RealType __sum = _RealType(0);\n+\t  _RealType __tmp = _RealType(1);\n+\t  for (size_t __k = __m; __k != 0; --__k)\n+\t    {\n+\t      __sum += _RealType(__urng() - __urng.min()) * __tmp;\n+\t      __tmp *= __r;\n+\t    }\n+\t  __ret = __sum / __tmp;\n \t}\n-      return __sum / __tmp;\n+      while (__builtin_expect(__ret >= _RealType(1), 0));\n+      return __ret;\n     }\n \n _GLIBCXX_END_NAMESPACE_VERSION"}, {"sha": "3de441234b581add5643246a4a71b279db8edc58", "filename": "libstdc++-v3/testsuite/26_numerics/random/uniform_real_distribution/operators/64351.cc", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/33df19a736d340fed203de05071eaeb2110383d6/libstdc%2B%2B-v3%2Ftestsuite%2F26_numerics%2Frandom%2Funiform_real_distribution%2Foperators%2F64351.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/33df19a736d340fed203de05071eaeb2110383d6/libstdc%2B%2B-v3%2Ftestsuite%2F26_numerics%2Frandom%2Funiform_real_distribution%2Foperators%2F64351.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F26_numerics%2Frandom%2Funiform_real_distribution%2Foperators%2F64351.cc?ref=33df19a736d340fed203de05071eaeb2110383d6", "patch": "@@ -0,0 +1,57 @@\n+// Copyright (C) 2015 Free Software Foundation, Inc.\n+//\n+// This file is part of the GNU ISO C++ Library.  This library is free\n+// software; you can redistribute it and/or modify it under the\n+// terms of the GNU General Public License as published by the\n+// Free Software Foundation; either version 3, or (at your option)\n+// any later version.\n+\n+// This library is distributed in the hope that it will be useful,\n+// but WITHOUT ANY WARRANTY; without even the implied warranty of\n+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+// GNU General Public License for more details.\n+\n+// You should have received a copy of the GNU General Public License along\n+// with this library; see the file COPYING3.  If not see\n+// <http://www.gnu.org/licenses/>.\n+\n+// { dg-options \"-std=gnu++11\" }\n+// { dg-do run { target { ! simulator } } }\n+\n+#include <random>\n+#include <testsuite_hooks.h>\n+\n+// libstdc++/64351\n+void\n+test01()\n+{\n+  std::mt19937 rng(8890);\n+  std::uniform_real_distribution<float> dist;\n+\n+  rng.discard(30e6);\n+  for (long i = 0; i < 10e6; ++i)\n+    {\n+      auto n = dist(rng);\n+      VERIFY( n != 1.f );\n+    }\n+}\n+\n+// libstdc++/63176\n+void\n+test02()\n+{\n+  std::mt19937 rng(8890);\n+  std::seed_seq sequence{0, 1, 2, 3, 4, 5, 6, 7, 8, 9};\n+  rng.seed(sequence);\n+  rng.discard(12 * 629143 + 6);\n+  float n =\n+    std::generate_canonical<float, std::numeric_limits<float>::digits>(rng);\n+  VERIFY( n != 1.f );\n+}\n+\n+int\n+main()\n+{\n+  test01();\n+  test02();\n+}"}]}