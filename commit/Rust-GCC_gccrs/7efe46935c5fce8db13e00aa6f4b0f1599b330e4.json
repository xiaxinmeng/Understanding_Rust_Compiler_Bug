{"sha": "7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "node_id": "C_kwDOANBUbNoAKDdlZmU0NjkzNWM1ZmNlOGRiMTNlMDBhYTZmNGIwZjE1OTliMzMwZTQ", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-02-25T10:47:12Z"}, "committer": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2022-03-01T07:58:35Z"}, "message": "[nvptx] Add nvptx-sm.def\n\nAdd a file gcc/config/nvptx/nvptx-sm.def that lists all sm_xx versions used in\nthe port, like so:\n...\nNVPTX_SM(30, NVPTX_SM_SEP)\nNVPTX_SM(35, NVPTX_SM_SEP)\nNVPTX_SM(53, NVPTX_SM_SEP)\nNVPTX_SM(70, NVPTX_SM_SEP)\nNVPTX_SM(75, NVPTX_SM_SEP)\nNVPTX_SM(80,)\n...\nand use it in various places using a pattern:\n...\n  #define NVPTX_SM(XX, SEP) { ... }\n  #include \"nvptx-sm.def\"\n  #undef NVPTX_SM\n...\n\nTested on nvptx.\n\ngcc/ChangeLog:\n\n2022-02-25  Tom de Vries  <tdevries@suse.de>\n\n\t* config/nvptx/nvptx-sm.def: New file.\n\t* config/nvptx/nvptx-c.cc (nvptx_cpu_cpp_builtins): Use nvptx-sm.def.\n\t* config/nvptx/nvptx-opts.h (enum ptx_isa): Same.\n\t* config/nvptx/nvptx.cc (sm_version_to_string)\n\t(nvptx_omp_device_kind_arch_isa): Same.", "tree": {"sha": "997568c00309dd608f3437d66a4effd30f4ba5f5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/997568c00309dd608f3437d66a4effd30f4ba5f5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4706670cd3b06bb024da0683776bf86c79d55940", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4706670cd3b06bb024da0683776bf86c79d55940", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4706670cd3b06bb024da0683776bf86c79d55940"}], "stats": {"total": 99, "additions": 57, "deletions": 42}, "files": [{"sha": "02f756250646e7ea4ca3d5e1f53d4cc106bd779c", "filename": "gcc/config/nvptx/nvptx-c.cc", "status": "modified", "additions": 10, "deletions": 12, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx-c.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx-c.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx-c.cc?ref=7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "patch": "@@ -39,17 +39,15 @@ nvptx_cpu_cpp_builtins (void)\n     cpp_define (parse_in, \"__nvptx_softstack__\");\n   if (TARGET_UNIFORM_SIMT)\n     cpp_define (parse_in,\"__nvptx_unisimt__\");\n-  if (TARGET_SM80)\n-    cpp_define (parse_in, \"__PTX_SM__=800\");\n-  else if (TARGET_SM75)\n-    cpp_define (parse_in, \"__PTX_SM__=750\");\n-  else if (TARGET_SM70)\n-    cpp_define (parse_in, \"__PTX_SM__=700\");\n-  else if (TARGET_SM53)\n-    cpp_define (parse_in, \"__PTX_SM__=530\");\n-  else if (TARGET_SM35)\n-    cpp_define (parse_in, \"__PTX_SM__=350\");\n-  else\n-    cpp_define (parse_in,\"__PTX_SM__=300\");\n+\n+  const char *ptx_sm = NULL;\n+#define NVPTX_SM(XX, SEP) \\\n+  {\t\t\t\t\t\t\\\n+    if (TARGET_SM ## XX)\t\t\t\\\n+      ptx_sm = \"__PTX_SM__=\" #XX \"0\"; \\\n+  }\n+#include \"nvptx-sm.def\"\n+#undef NVPTX_SM\n+  cpp_define (parse_in, ptx_sm);\n }\n "}, {"sha": "86b433caae8db9548e7e4db2a65cec97a36a0387", "filename": "gcc/config/nvptx/nvptx-opts.h", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx-opts.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx-opts.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx-opts.h?ref=7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "patch": "@@ -22,12 +22,11 @@\n \n enum ptx_isa\n {\n-  PTX_ISA_SM30,\n-  PTX_ISA_SM35,\n-  PTX_ISA_SM53,\n-  PTX_ISA_SM70,\n-  PTX_ISA_SM75,\n-  PTX_ISA_SM80\n+#define NVPTX_SM(XX, SEP) PTX_ISA_SM ## XX SEP\n+#define NVPTX_SM_SEP ,\n+#include \"nvptx-sm.def\"\n+#undef NVPTX_SM_SEP\n+#undef NVPTX_SM\n };\n \n enum ptx_version"}, {"sha": "c552eb0c88bd0dfaa86a72f73591f294e1210502", "filename": "gcc/config/nvptx/nvptx-sm.def", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx-sm.def", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx-sm.def", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx-sm.def?ref=7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "patch": "@@ -0,0 +1,30 @@\n+/* Copyright (C) 2022 Free Software Foundation, Inc.\n+\n+   This file is part of GCC.\n+\n+   GCC is free software; you can redistribute it and/or modify it\n+   under the terms of the GNU General Public License as published\n+   by the Free Software Foundation; either version 3, or (at your\n+   option) any later version.\n+\n+   GCC is distributed in the hope that it will be useful, but WITHOUT\n+   ANY WARRANTY; without even the implied warranty of MERCHANTABILITY\n+   or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public\n+   License for more details.\n+\n+   You should have received a copy of the GNU General Public License\n+   along with GCC; see the file COPYING3.  If not see\n+   <http://www.gnu.org/licenses/>.  */\n+\n+#ifndef NVPTX_SM_SEP\n+#define NVPTX_SM_SEP\n+#endif\n+\n+NVPTX_SM (30, NVPTX_SM_SEP)\n+NVPTX_SM (35, NVPTX_SM_SEP)\n+NVPTX_SM (53, NVPTX_SM_SEP)\n+NVPTX_SM (70, NVPTX_SM_SEP)\n+NVPTX_SM (75, NVPTX_SM_SEP)\n+NVPTX_SM (80,)\n+\n+#undef NVPTX_SM_SEP"}, {"sha": "f3179efa8d6cab32d1670155aa7aa22ea0b4ecde", "filename": "gcc/config/nvptx/nvptx.cc", "status": "modified", "additions": 12, "deletions": 24, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7efe46935c5fce8db13e00aa6f4b0f1599b330e4/gcc%2Fconfig%2Fnvptx%2Fnvptx.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx.cc?ref=7efe46935c5fce8db13e00aa6f4b0f1599b330e4", "patch": "@@ -276,18 +276,11 @@ sm_version_to_string (enum ptx_isa sm)\n {\n   switch (sm)\n     {\n-    case PTX_ISA_SM30:\n-      return \"30\";\n-    case PTX_ISA_SM35:\n-      return \"35\";\n-    case PTX_ISA_SM53:\n-      return \"53\";\n-    case PTX_ISA_SM70:\n-      return \"70\";\n-    case PTX_ISA_SM75:\n-      return \"75\";\n-    case PTX_ISA_SM80:\n-      return \"80\";\n+#define NVPTX_SM(XX, SEP)\t\t\t\\\n+      case PTX_ISA_SM ## XX:\t\t\t\\\n+\treturn #XX;\n+#include \"nvptx-sm.def\"\n+#undef NVPTX_SM\n     default:\n       gcc_unreachable ();\n     }\n@@ -6177,18 +6170,13 @@ nvptx_omp_device_kind_arch_isa (enum omp_device_kind_arch_isa trait,\n     case omp_device_arch:\n       return strcmp (name, \"nvptx\") == 0;\n     case omp_device_isa:\n-      if (strcmp (name, \"sm_30\") == 0)\n-\treturn !TARGET_SM35;\n-      if (strcmp (name, \"sm_35\") == 0)\n-\treturn TARGET_SM35 && !TARGET_SM53;\n-      if (strcmp (name, \"sm_53\") == 0)\n-\treturn TARGET_SM53 && !TARGET_SM70;\n-      if (strcmp (name, \"sm_70\") == 0)\n-\treturn TARGET_SM70 && !TARGET_SM75;\n-      if (strcmp (name, \"sm_75\") == 0)\n-\treturn TARGET_SM75 && !TARGET_SM80;\n-      if (strcmp (name, \"sm_80\") == 0)\n-\treturn TARGET_SM80;\n+#define NVPTX_SM(XX, SEP)\t\t\t\t\\\n+      {\t\t\t\t\t\t\t\\\n+\tif (strcmp (name, \"sm_\" #XX) == 0)\t\t\\\n+\t  return ptx_isa_option == PTX_ISA_SM ## XX;\t\\\n+      }\n+#include \"nvptx-sm.def\"\n+#undef NVPTX_SM\n       return 0;\n     default:\n       gcc_unreachable ();"}]}