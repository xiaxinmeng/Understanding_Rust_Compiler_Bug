{"sha": "ab19cc6c933c661438858b5c3ba4d8e0a618603e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWIxOWNjNmM5MzNjNjYxNDM4ODU4YjVjM2JhNGQ4ZTBhNjE4NjAzZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2014-03-06T12:07:07Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2014-03-06T12:07:07Z"}, "message": "re PR target/58595 (internal compiler error: in gen_movsi when compiling on arm some files of lttng-tools with -fPIE)\n\n\tPR target/58595\n\t* config/arm/arm.c (arm_tls_symbol_p): Remove.\n\t(arm_legitimize_address): Call legitimize_tls_address for any\n\tarm_tls_referenced_p expression, handle constant addend.  Call it\n\tbefore testing for !TARGET_ARM.\n\t(thumb_legitimize_address): Don't handle arm_tls_symbol_p here.\n\n\t* gcc.dg/tls/pr58595.c: New test.\n\nCo-Authored-By: Meador Inge <meadori@codesourcery.com>\n\nFrom-SVN: r208380", "tree": {"sha": "a9fad524fd1b0f1862504c48d34ae983d9c70e75", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a9fad524fd1b0f1862504c48d34ae983d9c70e75"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ab19cc6c933c661438858b5c3ba4d8e0a618603e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ab19cc6c933c661438858b5c3ba4d8e0a618603e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ab19cc6c933c661438858b5c3ba4d8e0a618603e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ab19cc6c933c661438858b5c3ba4d8e0a618603e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "a74158c7f261a02fb5d0b7c7f7dc16be298d0772", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a74158c7f261a02fb5d0b7c7f7dc16be298d0772", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a74158c7f261a02fb5d0b7c7f7dc16be298d0772"}], "stats": {"total": 90, "additions": 69, "deletions": 21}, "files": [{"sha": "287103a7fbb3e4732ad1e4cbf5131e8dd2675782", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=ab19cc6c933c661438858b5c3ba4d8e0a618603e", "patch": "@@ -1,3 +1,13 @@\n+2014-03-06  Jakub Jelinek  <jakub@redhat.com>\n+\t    Meador Inge  <meadori@codesourcery.com>\n+\n+\tPR target/58595\n+\t* config/arm/arm.c (arm_tls_symbol_p): Remove.\n+\t(arm_legitimize_address): Call legitimize_tls_address for any\n+\tarm_tls_referenced_p expression, handle constant addend.  Call it\n+\tbefore testing for !TARGET_ARM.\n+\t(thumb_legitimize_address): Don't handle arm_tls_symbol_p here.\n+\n 2014-03-06  Richard Biener  <rguenther@suse.de>\n \n \tPR middle-end/60445"}, {"sha": "af5666bfb1246029cb4d614cfdcde644cef3e2b6", "filename": "gcc/config/arm/arm.c", "status": "modified", "additions": 26, "deletions": 21, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2Fconfig%2Farm%2Farm.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2Fconfig%2Farm%2Farm.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Farm%2Farm.c?ref=ab19cc6c933c661438858b5c3ba4d8e0a618603e", "patch": "@@ -235,7 +235,6 @@ static tree arm_gimplify_va_arg_expr (tree, tree, gimple_seq *, gimple_seq *);\n static void arm_option_override (void);\n static unsigned HOST_WIDE_INT arm_shift_truncation_mask (enum machine_mode);\n static bool arm_cannot_copy_insn_p (rtx);\n-static bool arm_tls_symbol_p (rtx x);\n static int arm_issue_rate (void);\n static void arm_output_dwarf_dtprel (FILE *, int, rtx) ATTRIBUTE_UNUSED;\n static bool arm_output_addr_const_extra (FILE *, rtx);\n@@ -7336,6 +7335,32 @@ legitimize_tls_address (rtx x, rtx reg)\n rtx\n arm_legitimize_address (rtx x, rtx orig_x, enum machine_mode mode)\n {\n+  if (arm_tls_referenced_p (x))\n+    {\n+      rtx addend = NULL;\n+\n+      if (GET_CODE (x) == CONST && GET_CODE (XEXP (x, 0)) == PLUS)\n+\t{\n+\t  addend = XEXP (XEXP (x, 0), 1);\n+\t  x = XEXP (XEXP (x, 0), 0);\n+\t}\n+\n+      if (GET_CODE (x) != SYMBOL_REF)\n+\treturn x;\n+\n+      gcc_assert (SYMBOL_REF_TLS_MODEL (x) != 0);\n+\n+      x = legitimize_tls_address (x, NULL_RTX);\n+\n+      if (addend)\n+\t{\n+\t  x = gen_rtx_PLUS (SImode, x, addend);\n+\t  orig_x = x;\n+\t}\n+      else\n+\treturn x;\n+    }\n+\n   if (!TARGET_ARM)\n     {\n       /* TODO: legitimize_address for Thumb2.  */\n@@ -7344,9 +7369,6 @@ arm_legitimize_address (rtx x, rtx orig_x, enum machine_mode mode)\n       return thumb_legitimize_address (x, orig_x, mode);\n     }\n \n-  if (arm_tls_symbol_p (x))\n-    return legitimize_tls_address (x, NULL_RTX);\n-\n   if (GET_CODE (x) == PLUS)\n     {\n       rtx xop0 = XEXP (x, 0);\n@@ -7459,9 +7481,6 @@ arm_legitimize_address (rtx x, rtx orig_x, enum machine_mode mode)\n rtx\n thumb_legitimize_address (rtx x, rtx orig_x, enum machine_mode mode)\n {\n-  if (arm_tls_symbol_p (x))\n-    return legitimize_tls_address (x, NULL_RTX);\n-\n   if (GET_CODE (x) == PLUS\n       && CONST_INT_P (XEXP (x, 1))\n       && (INTVAL (XEXP (x, 1)) >= 32 * GET_MODE_SIZE (mode)\n@@ -7756,20 +7775,6 @@ thumb_legitimize_reload_address (rtx *x_p,\n \n /* Test for various thread-local symbols.  */\n \n-/* Return TRUE if X is a thread-local symbol.  */\n-\n-static bool\n-arm_tls_symbol_p (rtx x)\n-{\n-  if (! TARGET_HAVE_TLS)\n-    return false;\n-\n-  if (GET_CODE (x) != SYMBOL_REF)\n-    return false;\n-\n-  return SYMBOL_REF_TLS_MODEL (x) != 0;\n-}\n-\n /* Helper for arm_tls_referenced_p.  */\n \n static int"}, {"sha": "d9e6105d70d3ec2ba99b6b666bb5052c7d77e55b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=ab19cc6c933c661438858b5c3ba4d8e0a618603e", "patch": "@@ -1,3 +1,8 @@\n+2014-03-06  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR target/58595\n+\t* gcc.dg/tls/pr58595.c: New test.\n+\n 2014-03-06  Richard Biener  <rguenther@suse.de>\n \n \tPR middle-end/60445"}, {"sha": "d830e76d4a5d5c064cfae338d2d27dd8805d3c8b", "filename": "gcc/testsuite/gcc.dg/tls/pr58595.c", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2Ftestsuite%2Fgcc.dg%2Ftls%2Fpr58595.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ab19cc6c933c661438858b5c3ba4d8e0a618603e/gcc%2Ftestsuite%2Fgcc.dg%2Ftls%2Fpr58595.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftls%2Fpr58595.c?ref=ab19cc6c933c661438858b5c3ba4d8e0a618603e", "patch": "@@ -0,0 +1,28 @@\n+/* PR target/58595 */\n+/* { dg-do run } */\n+/* { dg-options \"-O2\" } */\n+/* { dg-additional-options \"-fpic\" { target fpic } } */\n+/* { dg-require-effective-target tls } */\n+/* { dg-require-effective-target sync_int_long } */\n+\n+struct S { unsigned long a, b; };\n+__thread struct S s;\n+void bar (unsigned long *);\n+\n+__attribute__((noinline)) void\n+foo (void)\n+{\n+  int i;\n+  for (i = 0; i < 10; i++)\n+    __sync_fetch_and_add (&s.b, 1L);\n+}\n+\n+int\n+main ()\n+{\n+  s.b = 12;\n+  foo ();\n+  if (s.b != 22)\n+    __builtin_abort ();\n+  return 0;\n+}"}]}