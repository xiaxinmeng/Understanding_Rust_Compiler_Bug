{"sha": "302319e08c092b95b31c2aaa7763cc0e54ae0813", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzAyMzE5ZTA4YzA5MmI5NWIzMWMyYWFhNzc2M2NjMGU1NGFlMDgxMw==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2018-11-14T11:40:59Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-11-14T11:40:59Z"}, "message": "[Ada] Unnesting transformations for blocks in package bodies\n\nThe declarations in the package body may have created blocks with nested\nsubprograms. Such a block must be transformed into a procedure followed\nby a call to it, so that unnesting can handle uplevel references within\nthese nested subprograms (typically generated subprograms to handle\nfinalization actions).\n\n2018-11-14  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch7.adb (Check_Unnesting_In_Declarations): New procedure\n\tto transform blocks that appear in the declarative part of a\n\tpackage body into subprograms if they contain generated\n\tsubprograms (such as finalization routines). Needed to generate\n\tthe proper upward references in unnesting mode.\n\nFrom-SVN: r266117", "tree": {"sha": "6484576740debd61818cdd2adb184f0b3196b69e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6484576740debd61818cdd2adb184f0b3196b69e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/302319e08c092b95b31c2aaa7763cc0e54ae0813", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/302319e08c092b95b31c2aaa7763cc0e54ae0813", "html_url": "https://github.com/Rust-GCC/gccrs/commit/302319e08c092b95b31c2aaa7763cc0e54ae0813", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/302319e08c092b95b31c2aaa7763cc0e54ae0813/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c1514eb060c72193a17b22467428d5e0d0b76ffb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c1514eb060c72193a17b22467428d5e0d0b76ffb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c1514eb060c72193a17b22467428d5e0d0b76ffb"}], "stats": {"total": 83, "additions": 83, "deletions": 0}, "files": [{"sha": "a0df31f6cce88298419a048b6e0e9a2d872a814e", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/302319e08c092b95b31c2aaa7763cc0e54ae0813/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/302319e08c092b95b31c2aaa7763cc0e54ae0813/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=302319e08c092b95b31c2aaa7763cc0e54ae0813", "patch": "@@ -1,3 +1,11 @@\n+2018-11-14  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* exp_ch7.adb (Check_Unnesting_In_Declarations): New procedure\n+\tto transform blocks that appear in the declarative part of a\n+\tpackage body into subprograms if they contain generated\n+\tsubprograms (such as finalization routines). Needed to generate\n+\tthe proper upward references in unnesting mode.\n+\n 2018-11-14  Ed Schonberg  <schonberg@adacore.com>\n \n \t* freeze.adb (Freeze_Fixed_Point_Type): If the given low bound"}, {"sha": "c579e627cb358c01fb04747611fe40ebe574e386", "filename": "gcc/ada/exp_ch7.adb", "status": "modified", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/302319e08c092b95b31c2aaa7763cc0e54ae0813/gcc%2Fada%2Fexp_ch7.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/302319e08c092b95b31c2aaa7763cc0e54ae0813/gcc%2Fada%2Fexp_ch7.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch7.adb?ref=302319e08c092b95b31c2aaa7763cc0e54ae0813", "patch": "@@ -360,6 +360,13 @@ package body Exp_Ch7 is\n    --  a call to this subprogram. This is only done if blocks are present\n    --  in the statement list of the body.\n \n+   procedure Check_Unnesting_In_Declarations (N : Node_Id);\n+   --  Similarly, the declarations in the package body may have created\n+   --  blocks with nested subprograms. Such a block must be transformed\n+   --  into a procedure followed by a call to it, so that unnesting can\n+   --  handle uplevel references within these nested subprograms (typically\n+   --  generated subprograms to handle finalization actions).\n+\n    procedure Check_Visibly_Controlled\n      (Prim : Final_Primitives;\n       Typ  : Entity_Id;\n@@ -4164,6 +4171,73 @@ package body Exp_Ch7 is\n       end if;\n    end Check_Unnesting_Elaboration_Code;\n \n+   -------------------------------------\n+   -- Check_Unnesting_In_Declarations --\n+   -------------------------------------\n+\n+   procedure Check_Unnesting_In_Declarations (N : Node_Id) is\n+      Decl       : Node_Id;\n+      Inner_Decl : Node_Id;\n+      Loc        : Source_Ptr;\n+      Local_Body : Node_Id;\n+      Local_Call : Node_Id;\n+\n+      Ent        : Entity_Id;\n+      Local_Proc : Entity_Id;\n+\n+   begin\n+      Local_Call := Empty;\n+      if Unnest_Subprogram_Mode\n+        and then Present (Declarations (N))\n+        and then Is_Compilation_Unit (Current_Scope)\n+      then\n+         Decl := First (Declarations (N));\n+         while Present (Decl) loop\n+            if Nkind (Decl) = N_Block_Statement then\n+               Ent := First_Entity (Entity (Identifier (Decl)));\n+               Inner_Decl := First (Declarations (Decl));\n+\n+               while Present (Inner_Decl) loop\n+\n+                  if Nkind (Inner_Decl) = N_Subprogram_Body then\n+                     Loc := Sloc (Decl);\n+                     Local_Proc :=\n+                       Make_Defining_Identifier (Loc,\n+                         Chars => New_Internal_Name ('P'));\n+\n+                     Local_Body :=\n+                       Make_Subprogram_Body (Loc,\n+                         Specification              =>\n+                           Make_Procedure_Specification (Loc,\n+                             Defining_Unit_Name => Local_Proc),\n+                             Declarations       => Declarations (Decl),\n+                         Handled_Statement_Sequence =>\n+                           Handled_Statement_Sequence (Decl));\n+                     Rewrite (Decl, Local_Body);\n+                     Analyze (Decl);\n+                     Set_Has_Nested_Subprogram (Local_Proc);\n+\n+                     Local_Call :=\n+                       Make_Procedure_Call_Statement (Loc,\n+                         Name => New_Occurrence_Of (Local_Proc, Loc));\n+                     Insert_After (Decl, Local_Call);\n+                     Analyze (Local_Call);\n+\n+                     while Present (Ent) loop\n+                        Set_Scope (Ent, Local_Proc);\n+                        Next_Entity (Ent);\n+                     end loop;\n+                  end if;\n+\n+                  Next (Inner_Decl);\n+               end loop;\n+            end if;\n+\n+            Next (Decl);\n+         end loop;\n+      end if;\n+   end Check_Unnesting_In_Declarations;\n+\n    ------------------------------\n    -- Check_Visibly_Controlled --\n    ------------------------------\n@@ -4893,6 +4967,7 @@ package body Exp_Ch7 is\n \n          Expand_Pragma_Initial_Condition (Spec_Id, N);\n          Check_Unnesting_Elaboration_Code (N);\n+         Check_Unnesting_In_Declarations (N);\n \n          Pop_Scope;\n       end if;"}]}