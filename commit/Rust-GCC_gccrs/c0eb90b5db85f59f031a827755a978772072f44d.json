{"sha": "c0eb90b5db85f59f031a827755a978772072f44d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzBlYjkwYjVkYjg1ZjU5ZjAzMWE4Mjc3NTVhOTc4NzcyMDcyZjQ0ZA==", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2019-03-25T12:18:38Z"}, "committer": {"name": "Richard Biener", "email": "rguenth@gcc.gnu.org", "date": "2019-03-25T12:18:38Z"}, "message": "re PR middle-end/89779 (internal compiler error: tree check: expected class \u2018type\u2019, have \u2018exceptional\u2019 (error_mark) in tree_nop_conversion_p, at tree.c:12798)\n\n2019-03-25  Richard Biener  <rguenther@suse.de>\n\n\tPR tree-optimization/89779\n\t* tree-ssa-loop-ivopts.c (remove_unused_ivs): Return\n\tto remove IV defs, delay actual removal.\n\t(tree_ssa_iv_optimize_loop): Likewise.  Avoid SCEV reset.\n\t(tree_ssa_iv_optimize): Remove eliminated IV defs at the\n\tvery end, properly also reset loop control IV information.\n\nFrom-SVN: r269914", "tree": {"sha": "61b057d5f4ad0f2c138811add99361726b86a67b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/61b057d5f4ad0f2c138811add99361726b86a67b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c0eb90b5db85f59f031a827755a978772072f44d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c0eb90b5db85f59f031a827755a978772072f44d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c0eb90b5db85f59f031a827755a978772072f44d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c0eb90b5db85f59f031a827755a978772072f44d/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "ecef0d345848dedec252f86f6d528c0536b30e69", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ecef0d345848dedec252f86f6d528c0536b30e69", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ecef0d345848dedec252f86f6d528c0536b30e69"}], "stats": {"total": 39, "additions": 25, "deletions": 14}, "files": [{"sha": "0a93882d6daf7a4927899b18c270e94cb78b2f95", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c0eb90b5db85f59f031a827755a978772072f44d/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c0eb90b5db85f59f031a827755a978772072f44d/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c0eb90b5db85f59f031a827755a978772072f44d", "patch": "@@ -1,3 +1,12 @@\n+2019-03-25  Richard Biener  <rguenther@suse.de>\n+\n+\tPR tree-optimization/89779\n+\t* tree-ssa-loop-ivopts.c (remove_unused_ivs): Return\n+\tto remove IV defs, delay actual removal.\n+\t(tree_ssa_iv_optimize_loop): Likewise.  Avoid SCEV reset.\n+\t(tree_ssa_iv_optimize): Remove eliminated IV defs at the\n+\tvery end, properly also reset loop control IV information.\n+\n 2019-03-25  Richard Biener  <rguenther@suse.de>\n \n \tPR tree-optimization/89802"}, {"sha": "a2b6b2b2312497333ea1c5c3999c0734b627cd4c", "filename": "gcc/tree-ssa-loop-ivopts.c", "status": "modified", "additions": 16, "deletions": 14, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c0eb90b5db85f59f031a827755a978772072f44d/gcc%2Ftree-ssa-loop-ivopts.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c0eb90b5db85f59f031a827755a978772072f44d/gcc%2Ftree-ssa-loop-ivopts.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-loop-ivopts.c?ref=c0eb90b5db85f59f031a827755a978772072f44d", "patch": "@@ -7258,11 +7258,10 @@ rewrite_groups (struct ivopts_data *data)\n /* Removes the ivs that are not used after rewriting.  */\n \n static void\n-remove_unused_ivs (struct ivopts_data *data)\n+remove_unused_ivs (struct ivopts_data *data, bitmap toremove)\n {\n   unsigned j;\n   bitmap_iterator bi;\n-  bitmap toremove = BITMAP_ALLOC (NULL);\n \n   /* Figure out an order in which to release SSA DEFs so that we don't\n      release something that we'd have to propagate into a debug stmt\n@@ -7384,10 +7383,6 @@ remove_unused_ivs (struct ivopts_data *data)\n \t    }\n \t}\n     }\n-\n-  release_defs_bitset (toremove);\n-\n-  BITMAP_FREE (toremove);\n }\n \n /* Frees memory occupied by struct tree_niter_desc in *VALUE. Callback\n@@ -7530,7 +7525,8 @@ loop_body_includes_call (basic_block *body, unsigned num_nodes)\n /* Optimizes the LOOP.  Returns true if anything changed.  */\n \n static bool\n-tree_ssa_iv_optimize_loop (struct ivopts_data *data, struct loop *loop)\n+tree_ssa_iv_optimize_loop (struct ivopts_data *data, struct loop *loop,\n+\t\t\t   bitmap toremove)\n {\n   bool changed = false;\n   struct iv_ca *iv_ca;\n@@ -7600,12 +7596,7 @@ tree_ssa_iv_optimize_loop (struct ivopts_data *data, struct loop *loop)\n   rewrite_groups (data);\n \n   /* Remove the ivs that are unused after rewriting.  */\n-  remove_unused_ivs (data);\n-\n-  /* We have changed the structure of induction variables; it might happen\n-     that definitions in the scev database refer to some of them that were\n-     eliminated.  */\n-  scev_reset ();\n+  remove_unused_ivs (data, toremove);\n \n finish:\n   free_loop_data (data);\n@@ -7620,6 +7611,7 @@ tree_ssa_iv_optimize (void)\n {\n   struct loop *loop;\n   struct ivopts_data data;\n+  auto_bitmap toremove;\n \n   tree_ssa_iv_optimize_init (&data);\n \n@@ -7629,9 +7621,19 @@ tree_ssa_iv_optimize (void)\n       if (dump_file && (dump_flags & TDF_DETAILS))\n \tflow_loop_dump (loop, dump_file, NULL, 1);\n \n-      tree_ssa_iv_optimize_loop (&data, loop);\n+      tree_ssa_iv_optimize_loop (&data, loop, toremove);\n     }\n \n+  /* Remove eliminated IV defs.  */\n+  release_defs_bitset (toremove);\n+\n+  /* We have changed the structure of induction variables; it might happen\n+     that definitions in the scev database refer to some of them that were\n+     eliminated.  */\n+  scev_reset_htab ();\n+  /* Likewise niter and control-IV information.  */\n+  free_numbers_of_iterations_estimates (cfun);\n+\n   tree_ssa_iv_optimize_finalize (&data);\n }\n "}]}