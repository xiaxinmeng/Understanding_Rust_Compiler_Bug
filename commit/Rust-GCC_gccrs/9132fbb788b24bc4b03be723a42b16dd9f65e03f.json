{"sha": "9132fbb788b24bc4b03be723a42b16dd9f65e03f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTEzMmZiYjc4OGIyNGJjNGIwM2JlNzIzYTQyYjE2ZGQ5ZjY1ZTAzZg==", "commit": {"author": {"name": "Per Bothner", "email": "pbothner@apple.com", "date": "2004-01-20T05:17:48Z"}, "committer": {"name": "Per Bothner", "email": "bothner@gcc.gnu.org", "date": "2004-01-20T05:17:48Z"}, "message": "Implement a cache for linemap_lookup.\n\n\t* line-map.h (struct_line_maps):  Add cache field.\n\t* line-map.c (linemap_init):  Zero cache field.\n\t(linemap_add):  Set cache field to offset of newly allocated map.\n\t(linemap_lookup):  Use and set cache field.\n\nFrom-SVN: r76197", "tree": {"sha": "9967002839c45b654992b25498aebabbe003b616", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9967002839c45b654992b25498aebabbe003b616"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9132fbb788b24bc4b03be723a42b16dd9f65e03f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9132fbb788b24bc4b03be723a42b16dd9f65e03f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9132fbb788b24bc4b03be723a42b16dd9f65e03f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9132fbb788b24bc4b03be723a42b16dd9f65e03f/comments", "author": null, "committer": null, "parents": [{"sha": "26d107dba89128b74d968900bbb669b47879ba18", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/26d107dba89128b74d968900bbb669b47879ba18", "html_url": "https://github.com/Rust-GCC/gccrs/commit/26d107dba89128b74d968900bbb669b47879ba18"}], "stats": {"total": 40, "additions": 33, "deletions": 7}, "files": [{"sha": "c2ae7ab4380767d812f2b2378d1a9cba36959f6e", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9132fbb788b24bc4b03be723a42b16dd9f65e03f/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9132fbb788b24bc4b03be723a42b16dd9f65e03f/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=9132fbb788b24bc4b03be723a42b16dd9f65e03f", "patch": "@@ -1,3 +1,11 @@\n+2003-01-20  Per Bothner  <pbothner@apple.com>\n+\n+\tImplement a cache for linemap_lookup.\n+\t* line-map.h (struct_line_maps):  Add cache field.\n+\t* line-map.c (linemap_init):  Zero cache field.\n+\t(linemap_add):  Set cache field to offset of newly allocated map.\n+\t(linemap_lookup):  Use and set cache field.\n+\n 2004-01-20  Kaz Kojima  <kkojima@gcc.gnu.org>\n \n \tPR optimization/13567"}, {"sha": "48e122bddb096822d1c5f1b3498bc2d313524af4", "filename": "gcc/line-map.c", "status": "modified", "additions": 23, "deletions": 7, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9132fbb788b24bc4b03be723a42b16dd9f65e03f/gcc%2Fline-map.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9132fbb788b24bc4b03be723a42b16dd9f65e03f/gcc%2Fline-map.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fline-map.c?ref=9132fbb788b24bc4b03be723a42b16dd9f65e03f", "patch": "@@ -32,12 +32,13 @@ static void trace_include (const struct line_maps *, const struct line_map *);\n void\n linemap_init (struct line_maps *set)\n {\n-  set->maps = 0;\n+  set->maps = NULL;\n   set->allocated = 0;\n   set->used = 0;\n   set->last_listed = -1;\n   set->trace_includes = false;\n   set->depth = 0;\n+  set->cache = 0;\n }\n \n /* Free a line map set.  */\n@@ -89,7 +90,7 @@ linemap_add (struct line_maps *set, enum lc_reason reason,\n       set->maps = xrealloc (set->maps, set->allocated * sizeof (struct line_map));\n     }\n \n-  map = &set->maps[set->used++];\n+  map = &set->maps[set->used];\n \n   if (to_file && *to_file == '\\0')\n     to_file = \"<stdin>\";\n@@ -108,7 +109,6 @@ linemap_add (struct line_maps *set, enum lc_reason reason,\n \t  if (to_file == NULL)\n \t    {\n \t      set->depth--;\n-\t      set->used--;\n \t      return NULL;\n \t    }\n \t  error = true;\n@@ -141,6 +141,7 @@ linemap_add (struct line_maps *set, enum lc_reason reason,\n   map->from_line = from_line;\n   map->to_file = to_file;\n   map->to_line = to_line;\n+  set->cache = set->used++;\n \n   if (reason == LC_ENTER)\n     {\n@@ -168,10 +169,24 @@ linemap_add (struct line_maps *set, enum lc_reason reason,\n const struct line_map *\n linemap_lookup (struct line_maps *set, source_location line)\n {\n-  unsigned int md, mn = 0, mx = set->used;\n-\n-  if (mx == 0)\n-    abort ();\n+  unsigned int md, mn, mx;\n+  const struct line_map *cached;\n+\n+  mn = set->cache;\n+  mx = set->used;\n+  \n+  cached = &set->maps[mn];\n+  /* We should get a segfault if no line_maps have been added yet. */\n+  if (line >= cached->from_line)\n+    {\n+      if (mn + 1 == mx || line < cached[1].from_line)\n+\treturn cached;\n+    }\n+  else\n+    {\n+      mx = mn;\n+      mn = 0;\n+    }\n \n   while (mx - mn > 1)\n     {\n@@ -182,6 +197,7 @@ linemap_lookup (struct line_maps *set, source_location line)\n \tmn = md;\n     }\n \n+  set->cache = mn;\n   return &set->maps[mn];\n }\n "}, {"sha": "ae1fbdbd4dffe81784154a7c045573589886a67a", "filename": "gcc/line-map.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9132fbb788b24bc4b03be723a42b16dd9f65e03f/gcc%2Fline-map.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9132fbb788b24bc4b03be723a42b16dd9f65e03f/gcc%2Fline-map.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fline-map.h?ref=9132fbb788b24bc4b03be723a42b16dd9f65e03f", "patch": "@@ -61,6 +61,8 @@ struct line_maps\n   unsigned int allocated;\n   unsigned int used;\n \n+  unsigned int cache;\n+\n   /* The most recently listed include stack, if any, starts with\n      LAST_LISTED as the topmost including file.  -1 indicates nothing\n      has been listed yet.  */"}]}