{"sha": "890043314a7f405081990ea9d0cb577dd44f883f", "node_id": "C_kwDOANBUbNoAKDg5MDA0MzMxNGE3ZjQwNTA4MTk5MGVhOWQwY2I1NzdkZDQ0Zjg4M2Y", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2023-03-17T19:27:10Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2023-03-17T21:31:36Z"}, "message": "c++: throw and private destructor [PR109172]\n\nSince we aren't going through the normal call machinery, we need to check\nthe dtor access specifically.\n\n\tPR c++/109172\n\ngcc/cp/ChangeLog:\n\n\t* except.cc (build_throw): Check dtor access.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/eh/dtor4.C: New test.", "tree": {"sha": "45a0f31590b7a4c253bdbe4a5501a85368965265", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/45a0f31590b7a4c253bdbe4a5501a85368965265"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/890043314a7f405081990ea9d0cb577dd44f883f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/890043314a7f405081990ea9d0cb577dd44f883f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/890043314a7f405081990ea9d0cb577dd44f883f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/890043314a7f405081990ea9d0cb577dd44f883f/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c48be8298c27143c1a684c0cb9689c88d16f4b49", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c48be8298c27143c1a684c0cb9689c88d16f4b49", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c48be8298c27143c1a684c0cb9689c88d16f4b49"}], "stats": {"total": 25, "additions": 23, "deletions": 2}, "files": [{"sha": "91a5e0498601de3e884dd76a119971d530bf3b41", "filename": "gcc/cp/except.cc", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/890043314a7f405081990ea9d0cb577dd44f883f/gcc%2Fcp%2Fexcept.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/890043314a7f405081990ea9d0cb577dd44f883f/gcc%2Fcp%2Fexcept.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fexcept.cc?ref=890043314a7f405081990ea9d0cb577dd44f883f", "patch": "@@ -639,6 +639,8 @@ build_throw (location_t loc, tree exp)\n       tree object, ptr;\n       tree allocate_expr;\n \n+      tsubst_flags_t complain = tf_warning_or_error;\n+\n       /* The CLEANUP_TYPE is the internal type of a destructor.  */\n       if (!cleanup_type)\n \t{\n@@ -759,11 +761,15 @@ build_throw (location_t loc, tree exp)\n       cleanup = NULL_TREE;\n       if (type_build_dtor_call (TREE_TYPE (object)))\n \t{\n-\t  tree dtor_fn = lookup_fnfields (TYPE_BINFO (TREE_TYPE (object)),\n+\t  tree binfo = TYPE_BINFO (TREE_TYPE (object));\n+\t  tree dtor_fn = lookup_fnfields (binfo,\n \t\t\t\t\t  complete_dtor_identifier, 0,\n \t\t\t\t\t  tf_warning_or_error);\n \t  dtor_fn = BASELINK_FUNCTIONS (dtor_fn);\n-\t  mark_used (dtor_fn);\n+\t  if (!mark_used (dtor_fn)\n+\t      || !perform_or_defer_access_check (binfo, dtor_fn,\n+\t\t\t\t\t\t dtor_fn, complain))\n+\t    return error_mark_node;\n \t  if (TYPE_HAS_NONTRIVIAL_DESTRUCTOR (TREE_TYPE (object)))\n \t    {\n \t      cxx_mark_addressable (dtor_fn);"}, {"sha": "6c0e804fe8a6608d270ee22708e405572d193b20", "filename": "gcc/testsuite/g++.dg/eh/dtor4.C", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/890043314a7f405081990ea9d0cb577dd44f883f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Feh%2Fdtor4.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/890043314a7f405081990ea9d0cb577dd44f883f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Feh%2Fdtor4.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Feh%2Fdtor4.C?ref=890043314a7f405081990ea9d0cb577dd44f883f", "patch": "@@ -0,0 +1,15 @@\n+// PR c++/109172\n+\n+class Demo\n+{\n+  ~Demo();\n+};\n+\n+int main()\n+{\n+  try\n+    {\n+      throw *new Demo;\t\t// { dg-error private }\n+    }\n+  catch(const Demo& e) { }\n+}"}]}