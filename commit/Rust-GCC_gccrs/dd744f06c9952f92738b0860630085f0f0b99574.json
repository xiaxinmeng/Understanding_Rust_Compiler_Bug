{"sha": "dd744f06c9952f92738b0860630085f0f0b99574", "node_id": "C_kwDOANBUbNoAKGRkNzQ0ZjA2Yzk5NTJmOTI3MzhiMDg2MDYzMDA4NWYwZjBiOTk1NzQ", "commit": {"author": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-11-01T14:04:25Z"}, "committer": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-11-16T13:41:39Z"}, "message": "i386: correct x87&SSE division modeling in znver.md\n\nCorrect modeling of division instructions in the SIMD/FP domain for\nAMD Zen architectures and avoid combinatorial explosion of automaton\ntables by modeling the separate floating-point division unit and\ncorrecting reservations to reflect reciprocal throughput of the\ncorresponding instructions, similar to earlier commit\n5cee5f94000 (\"i386: correct integer division modeling in znver.md\").\n\nDivision is partially pipelined and some instructions have fractional\nthroughput (e.g. Zen 3 can issue divss and divsd each 3.5 and 4.5\ncycles on average, respectively). Considering these CPUs implement\nout-of-order execution, the model doesn't need to be exact to the last\ncycle, so simplify it by using 4/5 cycles for SF/DF modes, and not\nmodeling the fact that FP3 pipe is occupied for one cycle.\n\nTop znver table sizes in insn-automata.o:\n\nBefore:\n\n428108 r znver1_fp_min_issue_delay\n856216 r znver1_fp_transitions\n\nAfter:\n\n30056 r znver1_fp_min_issue_delay\n120224 r znver1_fp_transitions\n\ngcc/ChangeLog:\n\n\tPR target/87832\n\t* config/i386/znver.md (znver1_fdiv): New automaton.\n\t(znver1-fdiv): New unit.\n\t(znver1_fp_op_div): Correct unit and cycles in the reservation.\n\t(znver1_fp_op_div_load): Ditto.\n\t(znver1_fp_op_idiv_load): Ditto.\n\t(znver2_fp_op_idiv_load): Ditto.\n\t(znver1_ssediv_ss_ps): Ditto.\n\t(znver1_ssediv_ss_ps_load): Ditto.\n\t(znver1_ssediv_sd_pd): Ditto.\n\t(znver1_ssediv_sd_pd_load): Ditto.\n\t(znver1_ssediv_avx256_ps): Ditto.\n\t(znver1_ssediv_avx256_ps_load): Ditto.\n\t(znver1_ssediv_avx256_pd): Ditto.\n\t(znver1_ssediv_avx256_pd_load): Ditto.", "tree": {"sha": "3e4e2f196315dbaf04732f001ce101d9f64c1203", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3e4e2f196315dbaf04732f001ce101d9f64c1203"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dd744f06c9952f92738b0860630085f0f0b99574", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dd744f06c9952f92738b0860630085f0f0b99574", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dd744f06c9952f92738b0860630085f0f0b99574", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dd744f06c9952f92738b0860630085f0f0b99574/comments", "author": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c54805d03ac1bcc3d8547ffb5e6c4e1f301a7a2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3c54805d03ac1bcc3d8547ffb5e6c4e1f301a7a2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3c54805d03ac1bcc3d8547ffb5e6c4e1f301a7a2"}], "stats": {"total": 27, "additions": 14, "deletions": 13}, "files": [{"sha": "c52f8b532ecbaea6db318a642d4b64ab3d8c5d4d", "filename": "gcc/config/i386/znver.md", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dd744f06c9952f92738b0860630085f0f0b99574/gcc%2Fconfig%2Fi386%2Fznver.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dd744f06c9952f92738b0860630085f0f0b99574/gcc%2Fconfig%2Fi386%2Fznver.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fznver.md?ref=dd744f06c9952f92738b0860630085f0f0b99574", "patch": "@@ -24,7 +24,7 @@\n ;; AMD znver1, znver2 and znver3 Scheduling\n ;; Modeling automatons for zen decoders, integer execution pipes,\n ;; SIMD/FP domain, AGU pipes, and dividers.\n-(define_automaton \"znver1, znver1_ieu, znver1_fp, znver1_agu, znver1_idiv\")\n+(define_automaton \"znver1, znver1_ieu, znver1_fp, znver1_agu, znver1_idiv, znver1_fdiv\")\n \n ;; Decoders unit has 4 decoders and all of them can decode fast path\n ;; and vector type instructions.\n@@ -95,6 +95,7 @@\n \n ;; Dividers\n (define_cpu_unit \"znver1-idiv\" \"znver1_idiv\")\n+(define_cpu_unit \"znver1-fdiv\" \"znver1_fdiv\")\n \n ;; Call instruction\n (define_insn_reservation \"znver1_call\" 1\n@@ -591,27 +592,27 @@\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2,znver3\")\n \t\t\t      (and (eq_attr \"type\" \"fdiv\")\n \t\t\t\t   (eq_attr \"memory\" \"none\")))\n-\t\t\t \"znver1-direct,znver1-fp3*15\")\n+\t\t\t \"znver1-direct,znver1-fdiv*6\")\n \n (define_insn_reservation \"znver1_fp_op_div_load\" 22\n \t\t\t (and (eq_attr \"cpu\" \"znver1,znver2,znver3\")\n \t\t\t      (and (eq_attr \"type\" \"fdiv\")\n \t\t\t\t   (eq_attr \"memory\" \"load\")))\n-\t\t\t \"znver1-direct,znver1-load,znver1-fp3*15\")\n+\t\t\t \"znver1-direct,znver1-load,znver1-fdiv*6\")\n \n (define_insn_reservation \"znver1_fp_op_idiv_load\" 27\n \t\t\t (and (eq_attr \"cpu\" \"znver1\")\n \t\t\t      (and (eq_attr \"type\" \"fdiv\")\n \t\t\t\t   (and (eq_attr \"fp_int_src\" \"true\")\n \t\t\t\t\t(eq_attr \"memory\" \"load\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-fp3*19\")\n+\t\t\t \"znver1-double,znver1-load,znver1-fdiv*6\")\n \n (define_insn_reservation \"znver2_fp_op_idiv_load\" 26\n \t\t\t (and (eq_attr \"cpu\" \"znver2,znver3\")\n \t\t\t      (and (eq_attr \"type\" \"fdiv\")\n \t\t\t\t   (and (eq_attr \"fp_int_src\" \"true\")\n \t\t\t\t\t(eq_attr \"memory\" \"load\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-fp3*19\")\n+\t\t\t \"znver1-double,znver1-load,znver1-fdiv*6\")\n \n \n ;; MMX, SSE, SSEn.n, AVX, AVX2 instructions\n@@ -1088,7 +1089,7 @@\n \t\t\t\t\t      (eq_attr \"mode\" \"V8SF,V4SF,SF\")))\n \t\t\t      (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t   (eq_attr \"memory\" \"none\")))\n-\t\t\t \"znver1-direct,znver1-fp3*10\")\n+\t\t\t \"znver1-direct,znver1-fdiv*4\")\n \n (define_insn_reservation \"znver1_ssediv_ss_ps_load\" 17\n \t\t\t (and (ior (and (eq_attr \"cpu\" \"znver1\")\n@@ -1099,7 +1100,7 @@\n \t\t\t\t\t      (eq_attr \"mode\" \"V8SF,V4SF,SF\")))\n \t\t\t      (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t   (eq_attr \"memory\" \"load\")))\n-\t\t\t \"znver1-direct,znver1-load,znver1-fp3*10\")\n+\t\t\t \"znver1-direct,znver1-load,znver1-fdiv*4\")\n \n (define_insn_reservation \"znver1_ssediv_sd_pd\" 13\n \t\t\t (and (ior (and (eq_attr \"cpu\" \"znver1\")\n@@ -1110,7 +1111,7 @@\n \t\t\t\t\t      (eq_attr \"mode\" \"V4DF,V2DF,DF\")))\n \t\t\t      (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t   (eq_attr \"memory\" \"none\")))\n-\t\t\t \"znver1-direct,znver1-fp3*13\")\n+\t\t\t \"znver1-direct,znver1-fdiv*5\")\n \n (define_insn_reservation \"znver1_ssediv_sd_pd_load\" 20\n \t\t\t (and (ior (and (eq_attr \"cpu\" \"znver1\")\n@@ -1121,35 +1122,35 @@\n \t\t\t\t\t      (eq_attr \"mode\" \"V4DF,V2DF,DF\")))\n \t\t\t      (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t   (eq_attr \"memory\" \"load\")))\n-\t\t\t \"znver1-direct,znver1-load,znver1-fp3*13\")\n+\t\t\t \"znver1-direct,znver1-load,znver1-fdiv*5\")\n \n (define_insn_reservation \"znver1_ssediv_avx256_ps\" 12\n \t\t\t (and (eq_attr \"cpu\" \"znver1\")\n \t\t\t      (and (eq_attr \"mode\" \"V8SF\")\n \t\t\t\t   (and (eq_attr \"memory\" \"none\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"znver1-double,znver1-fp3*12\")\n+\t\t\t \"znver1-double,znver1-fdiv*8\")\n \n (define_insn_reservation \"znver1_ssediv_avx256_ps_load\" 19\n \t\t\t (and (eq_attr \"cpu\" \"znver1\")\n \t\t\t      (and (eq_attr \"mode\" \"V8SF\")\n \t\t\t\t   (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t\t(eq_attr \"memory\" \"load\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-fp3*12\")\n+\t\t\t \"znver1-double,znver1-load,znver1-fdiv*8\")\n \n (define_insn_reservation \"znver1_ssediv_avx256_pd\" 15\n \t\t\t (and (eq_attr \"cpu\" \"znver1\")\n \t\t\t      (and (eq_attr \"mode\" \"V4DF\")\n \t\t\t\t   (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t\t(eq_attr \"memory\" \"none\"))))\n-\t\t\t \"znver1-double,znver1-fp3*15\")\n+\t\t\t \"znver1-double,znver1-fdiv*10\")\n \n (define_insn_reservation \"znver1_ssediv_avx256_pd_load\" 22 \n \t\t\t (and (eq_attr \"cpu\" \"znver1\")\n \t\t\t      (and (eq_attr \"mode\" \"V4DF\")\n \t\t\t\t   (and (eq_attr \"type\" \"ssediv\")\n \t\t\t\t\t(eq_attr \"memory\" \"load\"))))\n-\t\t\t \"znver1-double,znver1-load,znver1-fp3*15\")\n+\t\t\t \"znver1-double,znver1-load,znver1-fdiv*10\")\n ;; SSE MUL\n (define_insn_reservation \"znver1_ssemul_ss_ps\" 3\n \t\t\t (and (ior (and (eq_attr \"cpu\" \"znver1\")"}]}