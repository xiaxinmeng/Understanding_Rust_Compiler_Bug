{"sha": "2813bb6b356e37af272d5ce279d0fdddc794e34f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MjgxM2JiNmIzNTZlMzdhZjI3MmQ1Y2UyNzlkMGZkZGRjNzk0ZTM0Zg==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2005-03-29T16:21:32Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2005-03-29T16:21:32Z"}, "message": "sem_ch6.adb (Set_Formal_Mode): If the subtype has a non_null indicator, indicate that the formal can never be null.\n\n2005-03-29  Ed Schonberg  <schonberg@adacore.com>\n\n\t* sem_ch6.adb (Set_Formal_Mode): If the subtype has a non_null\n\tindicator, indicate that the formal can never be null.\n\t(Process_Formals): If a formal has a non_null indicator, insert the\n\tresulting subtype immediately before the enclosing subprogram decl,\n\tand not at the beginning of the corresponding declarative part, to\n\tprevent access before elaboration (Ada2005).\n\nFrom-SVN: r97185", "tree": {"sha": "d54b5ee5ac14be2f30051dc60ff8454a94566bcf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d54b5ee5ac14be2f30051dc60ff8454a94566bcf"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2813bb6b356e37af272d5ce279d0fdddc794e34f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2813bb6b356e37af272d5ce279d0fdddc794e34f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2813bb6b356e37af272d5ce279d0fdddc794e34f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2813bb6b356e37af272d5ce279d0fdddc794e34f/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "981234802e8314987fc1e9c6b9594462bb5aa0f4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/981234802e8314987fc1e9c6b9594462bb5aa0f4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/981234802e8314987fc1e9c6b9594462bb5aa0f4"}], "stats": {"total": 24, "additions": 17, "deletions": 7}, "files": [{"sha": "024a6cb1c24519a663df292aa42d410b95a76fe7", "filename": "gcc/ada/sem_ch6.adb", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2813bb6b356e37af272d5ce279d0fdddc794e34f/gcc%2Fada%2Fsem_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2813bb6b356e37af272d5ce279d0fdddc794e34f/gcc%2Fada%2Fsem_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch6.adb?ref=2813bb6b356e37af272d5ce279d0fdddc794e34f", "patch": "@@ -5089,8 +5089,8 @@ package body Sem_Ch6 is\n \n             --  Ada 2005 (AI-231): Create and decorate an internal subtype\n             --  declaration corresponding to the null-excluding type of the\n-            --  formal in the enclosing scope. In addition, replace the\n-            --  parameter type of the formal to this internal subtype.\n+            --  formal in the enclosing scope. Finally, replace the\n+            --  parameter type of the formal with the internal subtype.\n \n             if Null_Exclusion_Present (Param_Spec) then\n                declare\n@@ -5105,7 +5105,7 @@ package body Sem_Ch6 is\n \n                   Ptype : constant Node_Id := Parameter_Type (Param_Spec);\n                   Decl  : Node_Id;\n-                  P     : Node_Id := Parent (Parent (Related_Nod));\n+                  P     : Node_Id := Parent (Related_Nod);\n \n                begin\n                   Set_Is_Internal (Anon);\n@@ -5127,12 +5127,13 @@ package body Sem_Ch6 is\n                   Mark_Rewrite_Insertion (Decl);\n \n                   --  Insert the new declaration in the nearest enclosing scope\n+                  --  in front of the subprogram or entry declaration.\n \n-                  while not Has_Declarations (P) loop\n+                  while not Is_List_Member (P) loop\n                      P := Parent (P);\n                   end loop;\n \n-                  Prepend (Decl, Declarations (P));\n+                  Insert_Before (P, Decl);\n \n                   Rewrite (Ptype, New_Occurrence_Of (Anon, Loc));\n                   Mark_Rewrite_Insertion (Ptype);\n@@ -5456,15 +5457,24 @@ package body Sem_Ch6 is\n \n       if Nkind (Parameter_Type (Spec)) = N_Access_Definition then\n \n-         --  Ada 2005 (AI-231): This behaviour has been modified in Ada 2005.\n-         --  It is only forced if the null_exclusion appears.\n+         --  Ada 2005 (AI-231): In Ada95, access parameters are always non-\n+         --  null; In Ada 2005, only if then null_exclusion is explicit.\n \n          if Ada_Version < Ada_05\n            or else Null_Exclusion_Present (Spec)\n+           or else Can_Never_Be_Null (Etype (Formal_Id))\n          then\n             Set_Is_Known_Non_Null (Formal_Id);\n             Set_Can_Never_Be_Null (Formal_Id);\n          end if;\n+\n+      elsif Is_Access_Type (Etype (Formal_Id))\n+        and then Can_Never_Be_Null (Etype (Formal_Id))\n+      then\n+         --  Ada 2005: The access subtype may be declared with null-exclusion\n+\n+         Set_Is_Known_Non_Null (Formal_Id);\n+         Set_Can_Never_Be_Null (Formal_Id);\n       end if;\n \n       Set_Mechanism (Formal_Id, Default_Mechanism);"}]}