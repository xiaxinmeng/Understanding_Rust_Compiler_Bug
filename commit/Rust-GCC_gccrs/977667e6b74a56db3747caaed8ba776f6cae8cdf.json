{"sha": "977667e6b74a56db3747caaed8ba776f6cae8cdf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTc3NjY3ZTZiNzRhNTZkYjM3NDdjYWFlZDhiYTc3NmY2Y2FlOGNkZg==", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2018-07-26T08:50:21Z"}, "committer": {"name": "Martin Liska", "email": "marxin@gcc.gnu.org", "date": "2018-07-26T08:50:21Z"}, "message": "gcov: Fix wrong usage of NAN in statistics (PR gcov-profile/86536).\n\n2018-07-26  Martin Liska  <mliska@suse.cz>\n\n        PR gcov-profile/86536\n\t* gcov.c (format_gcov): Use printf format %.*f directly\n        and do not handle special values.\n2018-07-26  Martin Liska  <mliska@suse.cz>\n\n        PR gcov-profile/86536\n\t* gcc.misc-tests/gcov-pr86536.c: New test.\n\nFrom-SVN: r262991", "tree": {"sha": "f468ca975fd865c0d7797df158bad531b2c05eed", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f468ca975fd865c0d7797df158bad531b2c05eed"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/977667e6b74a56db3747caaed8ba776f6cae8cdf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/977667e6b74a56db3747caaed8ba776f6cae8cdf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/977667e6b74a56db3747caaed8ba776f6cae8cdf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/977667e6b74a56db3747caaed8ba776f6cae8cdf/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6dd580109f5297ae467d3c32204530a735925ba9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6dd580109f5297ae467d3c32204530a735925ba9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6dd580109f5297ae467d3c32204530a735925ba9"}], "stats": {"total": 82, "additions": 46, "deletions": 36}, "files": [{"sha": "7a66a6329f7bed8c965d08b55610114c50e04440", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=977667e6b74a56db3747caaed8ba776f6cae8cdf", "patch": "@@ -1,3 +1,9 @@\n+2018-07-26  Martin Liska  <mliska@suse.cz>\n+\n+        PR gcov-profile/86536\n+\t* gcov.c (format_gcov): Use printf format %.*f directly\n+        and do not handle special values.\n+\n 2018-07-25  Claudiu Zissulescu  <claziss@synopsys.com>\n \n \t* common/config/arc/arc-common.c (arc_option_optimization_table):"}, {"sha": "78a3e0e19e9a771bbe0d9c4a3ca6328a8837e4a4", "filename": "gcc/gcov.c", "status": "modified", "additions": 10, "deletions": 36, "changes": 46, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2Fgcov.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2Fgcov.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgcov.c?ref=977667e6b74a56db3747caaed8ba776f6cae8cdf", "patch": "@@ -2203,50 +2203,24 @@ format_count (gcov_type count)\n }\n \n /* Format a GCOV_TYPE integer as either a percent ratio, or absolute\n-   count.  If dp >= 0, format TOP/BOTTOM * 100 to DP decimal places.\n-   If DP is zero, no decimal point is printed. Only print 100% when\n-   TOP==BOTTOM and only print 0% when TOP=0.  If dp < 0, then simply\n+   count.  If DECIMAL_PLACES >= 0, format TOP/BOTTOM * 100 to DECIMAL_PLACES.\n+   If DECIMAL_PLACES is zero, no decimal point is printed. Only print 100% when\n+   TOP==BOTTOM and only print 0% when TOP=0.  If DECIMAL_PLACES < 0, then simply\n    format TOP.  Return pointer to a static string.  */\n \n static char const *\n-format_gcov (gcov_type top, gcov_type bottom, int dp)\n+format_gcov (gcov_type top, gcov_type bottom, int decimal_places)\n {\n   static char buffer[20];\n \n-  /* Handle invalid values that would result in a misleading value.  */\n-  if (bottom != 0 && top > bottom && dp >= 0)\n+  if (decimal_places >= 0)\n     {\n-      sprintf (buffer, \"NAN %%\");\n-      return buffer;\n-    }\n+      float ratio = bottom ? 100.0f * top / bottom: 0;\n \n-  if (dp >= 0)\n-    {\n-      float ratio = bottom ? (float)top / bottom : 0;\n-      int ix;\n-      unsigned limit = 100;\n-      unsigned percent;\n-\n-      for (ix = dp; ix--; )\n-\tlimit *= 10;\n-\n-      percent = (unsigned) (ratio * limit + (float)0.5);\n-      if (percent <= 0 && top)\n-\tpercent = 1;\n-      else if (percent >= limit && top != bottom)\n-\tpercent = limit - 1;\n-      ix = sprintf (buffer, \"%.*u%%\", dp + 1, percent);\n-      if (dp)\n-\t{\n-\t  dp++;\n-\t  do\n-\t    {\n-\t      buffer[ix+1] = buffer[ix];\n-\t      ix--;\n-\t    }\n-\t  while (dp--);\n-\t  buffer[ix + 1] = '.';\n-\t}\n+      /* Round up to 1% if there's a small non-zero value.  */\n+      if (ratio > 0.0f && ratio < 0.5f && decimal_places == 0)\n+\tratio = 1.0f;\n+      sprintf (buffer, \"%.*f%%\", decimal_places, ratio);\n     }\n   else\n     return format_count (top);"}, {"sha": "7642560f276d3fc274ab36411bd43d49c99d8220", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=977667e6b74a56db3747caaed8ba776f6cae8cdf", "patch": "@@ -1,3 +1,8 @@\n+2018-07-26  Martin Liska  <mliska@suse.cz>\n+\n+        PR gcov-profile/86536\n+\t* gcc.misc-tests/gcov-pr86536.c: New test.\n+\n 2018-07-25  Martin Sebor  <msebor@redhat.com>\n \n \t* gcc.c-torture/execute/builtins/strnlen.c: Remove DejaGnu directives"}, {"sha": "4817773599955cf2f6b97b8182f802628d85759f", "filename": "gcc/testsuite/gcc.misc-tests/gcov-pr86536.c", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr86536.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/977667e6b74a56db3747caaed8ba776f6cae8cdf/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr86536.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr86536.c?ref=977667e6b74a56db3747caaed8ba776f6cae8cdf", "patch": "@@ -0,0 +1,25 @@\n+// PR gcov-profile/86536\n+// { dg-options \"-fprofile-arcs -ftest-coverage\" }\n+// { dg-do run { target native } }\n+// { dg-require-fork \"\" }\n+\n+#include <stdlib.h>\n+#include <unistd.h>\n+#include <sys/types.h>\n+#include <sys/wait.h>\n+\n+int\n+main (void)\n+{\n+\n+  int j = 22;\t\t  /* count(1) */\n+\n+\t\t\t  /* returns(200) */\n+  fork ();\t\t  /* count(1)  */\n+\t\t\t  /* returns(end) */\n+\n+  int i = 7;\t\t  /* count(2) */\n+  return 0;\t\t  /* count(2) */\n+}\n+\n+// { dg-final { run-gcov branches calls { -b gcov-pr86536.c } } }"}]}