{"sha": "a4384badd778dd4d5947f4a9aadf1c34050d6049", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTQzODRiYWRkNzc4ZGQ0ZDU5NDdmNGE5YWFkZjFjMzQwNTBkNjA0OQ==", "commit": {"author": {"name": "Janne Blomqvist", "email": "jb@gcc.gnu.org", "date": "2009-12-04T16:28:44Z"}, "committer": {"name": "Janne Blomqvist", "email": "jb@gcc.gnu.org", "date": "2009-12-04T16:28:44Z"}, "message": "PR libfortran/40812 Large file support for MinGW\n\nFrom-SVN: r154984", "tree": {"sha": "a435ab3b0975b61493223bb3a25af26b5f2a3e5b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a435ab3b0975b61493223bb3a25af26b5f2a3e5b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a4384badd778dd4d5947f4a9aadf1c34050d6049", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a4384badd778dd4d5947f4a9aadf1c34050d6049", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a4384badd778dd4d5947f4a9aadf1c34050d6049", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a4384badd778dd4d5947f4a9aadf1c34050d6049/comments", "author": null, "committer": null, "parents": [{"sha": "0c5526222ccc8870c9ea1d8fd43efb4ea7e674fa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0c5526222ccc8870c9ea1d8fd43efb4ea7e674fa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0c5526222ccc8870c9ea1d8fd43efb4ea7e674fa"}], "stats": {"total": 105, "additions": 83, "deletions": 22}, "files": [{"sha": "280ac230a7dd5e4dcebe5a9533bc79bde980cf3c", "filename": "libgfortran/ChangeLog", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2FChangeLog?ref=a4384badd778dd4d5947f4a9aadf1c34050d6049", "patch": "@@ -1,3 +1,26 @@\n+2009-12-04  Janne Blomqvist  <jb@gcc.gnu.org>\n+\n+\tPR libfortran/40812\n+\t* libgfortran.h: typedef gfc_offset differently for MinGW.\n+\t* io/unix.h (struct stream): Change function pointers to use\n+\tgfc_offset instead of off_t.\n+\t(sseek): Change prototype to use gfc_offset instead of off_t.\n+\t(stell): Likewise.\n+\t(struncate): Likewise.\n+\t* io/unix.c: Redefine lseek() for mingw.\n+\t(raw_seek): Use gfc_offset instead of off_t.\n+\t(raw_tell): Likewise.\n+\t(buf_seek): Likewise.\n+\t(buf_tell): Likewise.\n+\t(buf_truncate): Likewise.\n+\t(mem_seek): Likewise.\n+\t(mem_tell): Likewise.\n+\t(mem_truncate): Likewise.\n+\t(fd_to_stream): Likewise.\n+\t(file_length): Likewise.\n+\t(raw_truncate): Use gfc_offset instead of off_t, add large file\n+\tcapable implementation for MinGW.\n+\n 2009-11-30  Janus Weil  <janus@gcc.gnu.org>\n \n \t* gfortran.map: Add _gfortran_is_extension_of."}, {"sha": "07aa4d95972a1f91cfd77f226722f15eeb7c02e3", "filename": "libgfortran/io/unix.c", "status": "modified", "additions": 48, "deletions": 15, "changes": 63, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2Fio%2Funix.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2Fio%2Funix.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fio%2Funix.c?ref=a4384badd778dd4d5947f4a9aadf1c34050d6049", "patch": "@@ -47,6 +47,8 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n #define WIN32_LEAN_AND_MEAN\n #include <windows.h>\n \n+#define lseek _lseeki64\n+\n static uint64_t\n id_from_handle (HANDLE hFile)\n {\n@@ -274,22 +276,53 @@ raw_write (unix_stream * s, const void * buf, ssize_t nbyte)\n   return nbyte - bytes_left;\n }\n \n-static off_t\n-raw_seek (unix_stream * s, off_t offset, int whence)\n+static gfc_offset\n+raw_seek (unix_stream * s, gfc_offset offset, int whence)\n {\n   return lseek (s->fd, offset, whence);\n }\n \n-static off_t\n+static gfc_offset\n raw_tell (unix_stream * s)\n {\n   return lseek (s->fd, 0, SEEK_CUR);\n }\n \n static int\n-raw_truncate (unix_stream * s, off_t length)\n+raw_truncate (unix_stream * s, gfc_offset length)\n {\n-#ifdef HAVE_FTRUNCATE\n+#ifdef __MINGW32__\n+  HANDLE h;\n+  gfc_offset cur;\n+\n+  if (isatty (s->fd))\n+    {\n+      errno = EBADF;\n+      return -1;\n+    }\n+  h = _get_osfhandle (s->fd);\n+  if (h == INVALID_HANDLE_VALUE)\n+    {\n+      errno = EBADF;\n+      return -1;\n+    }\n+  cur = lseek (s->fd, 0, SEEK_CUR);\n+  if (cur == -1)\n+    return -1;\n+  if (lseek (s->fd, length, SEEK_SET) == -1)\n+    goto error;\n+  if (!SetEndOfFile (h))\n+    {\n+      errno = EBADF;\n+      goto error;\n+    }\n+  if (lseek (s->fd, cur, SEEK_SET) == -1)\n+    return -1;\n+  return 0;\n+ error:\n+  lseek (s->fd, cur, SEEK_SET);\n+  return -1;\n+#elif defined HAVE_FTRUNCATE\n   return ftruncate (s->fd, length);\n #elif defined HAVE_CHSIZE\n   return chsize (s->fd, length);\n@@ -470,8 +503,8 @@ buf_write (unix_stream * s, const void * buf, ssize_t nbyte)\n   return nbyte;\n }\n \n-static off_t\n-buf_seek (unix_stream * s, off_t offset, int whence)\n+static gfc_offset\n+buf_seek (unix_stream * s, gfc_offset offset, int whence)\n {\n   switch (whence)\n     {\n@@ -495,14 +528,14 @@ buf_seek (unix_stream * s, off_t offset, int whence)\n   return offset;\n }\n \n-static off_t\n+static gfc_offset\n buf_tell (unix_stream * s)\n {\n   return s->logical_offset;\n }\n \n static int\n-buf_truncate (unix_stream * s, off_t length)\n+buf_truncate (unix_stream * s, gfc_offset length)\n {\n   int r;\n \n@@ -631,8 +664,8 @@ mem_write (stream * s, const void * buf, ssize_t nbytes)\n }\n \n \n-static off_t\n-mem_seek (stream * strm, off_t offset, int whence)\n+static gfc_offset\n+mem_seek (stream * strm, gfc_offset offset, int whence)\n {\n   unix_stream * s = (unix_stream *) strm;\n   switch (whence)\n@@ -668,7 +701,7 @@ mem_seek (stream * strm, off_t offset, int whence)\n }\n \n \n-static off_t\n+static gfc_offset\n mem_tell (stream * s)\n {\n   return ((unix_stream *)s)->logical_offset;\n@@ -677,7 +710,7 @@ mem_tell (stream * s)\n \n static int\n mem_truncate (unix_stream * s __attribute__ ((unused)), \n-\t      off_t length __attribute__ ((unused)))\n+\t      gfc_offset length __attribute__ ((unused)))\n {\n   return 0;\n }\n@@ -764,7 +797,7 @@ fd_to_stream (int fd, int prot)\n \n   fstat (fd, &statbuf);\n \n-  if (lseek (fd, 0, SEEK_CUR) == (off_t) -1)\n+  if (lseek (fd, 0, SEEK_CUR) == (gfc_offset) -1)\n     s->file_length = -1;\n   else\n     s->file_length = S_ISREG (statbuf.st_mode) ? statbuf.st_size : -1;\n@@ -1602,7 +1635,7 @@ inquire_readwrite (const char *string, int len)\n gfc_offset\n file_length (stream * s)\n {\n-  off_t curr, end;\n+  gfc_offset curr, end;\n   if (!is_seekable (s))\n     return -1;\n   curr = stell (s);"}, {"sha": "e691982e505d96778757f60568c3ce2e3bd40dd3", "filename": "libgfortran/io/unix.h", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2Fio%2Funix.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2Fio%2Funix.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fio%2Funix.h?ref=a4384badd778dd4d5947f4a9aadf1c34050d6049", "patch": "@@ -33,10 +33,10 @@ struct stream\n {\n   ssize_t (*read) (struct stream *, void *, ssize_t);\n   ssize_t (*write) (struct stream *, const void *, ssize_t);\n-  off_t (*seek) (struct stream *, off_t, int);\n-  off_t (*tell) (struct stream *);\n+  gfc_offset (*seek) (struct stream *, gfc_offset, int);\n+  gfc_offset (*tell) (struct stream *);\n   /* Avoid keyword truncate due to AIX namespace collision.  */\n-  int (*trunc) (struct stream *, off_t);\n+  int (*trunc) (struct stream *, gfc_offset);\n   int (*flush) (struct stream *);\n   int (*close) (struct stream *);\n };\n@@ -54,20 +54,20 @@ swrite (stream * s, const void * buf, ssize_t nbyte)\n   return s->write (s, buf, nbyte);\n }\n \n-static inline off_t\n-sseek (stream * s, off_t offset, int whence)\n+static inline gfc_offset\n+sseek (stream * s, gfc_offset offset, int whence)\n {\n   return s->seek (s, offset, whence);\n }\n \n-static inline off_t\n+static inline gfc_offset\n stell (stream * s)\n {\n   return s->tell (s);\n }\n \n static inline int\n-struncate (stream * s, off_t length)\n+struncate (stream * s, gfc_offset length)\n {\n   return s->trunc (s, length);\n }"}, {"sha": "dd63fa4e61697f051afbd7909fd68eeb7127631c", "filename": "libgfortran/libgfortran.h", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2Flibgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a4384badd778dd4d5947f4a9aadf1c34050d6049/libgfortran%2Flibgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Flibgfortran.h?ref=a4384badd778dd4d5947f4a9aadf1c34050d6049", "patch": "@@ -56,7 +56,12 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n #if HAVE_SYS_TYPES_H\n #include <sys/types.h>\n #endif\n+\n+#ifdef __MINGW32__\n+typedef off64_t gfc_offset;\n+#else\n typedef off_t gfc_offset;\n+#endif\n \n #ifndef NULL\n #define NULL (void *) 0"}]}