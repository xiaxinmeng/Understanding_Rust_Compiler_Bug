{"sha": "a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YThjODBkMDNkNGUwZmFiOWNmNGVkYjdiZDVhY2I3ZWRhZmQyNDM4Yw==", "commit": {"author": {"name": "Prathamesh Kulkarni", "email": "prathamesh.kulkarni@linaro.org", "date": "2018-05-15T06:07:48Z"}, "committer": {"name": "Prathamesh Kulkarni", "email": "prathamesh3492@gcc.gnu.org", "date": "2018-05-15T06:07:48Z"}, "message": "re PR tree-optimization/83648 (missing -Wsuggest-attribute=malloc on a trivial malloc-like function)\n\n2018-05-15  Prathamesh Kulkarni  <prathamesh.kulkarni@linaro.org>\n\n\tPR tree-optimization/83648\n\t* ipa-pure-const.c (malloc_candidate_p): Allow function with NULL\n\treturn value as malloc candidate.\n\ntestsuite/\n\t* gcc.dg/tree-ssa/pr83648.c: New test.\n\t* gcc.dg/tree-ssa/pr83648-2.c: Likewise.\n\nFrom-SVN: r260250", "tree": {"sha": "4cc4883b6dd1ef245b4bef9ff5fef8cf94775da0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4cc4883b6dd1ef245b4bef9ff5fef8cf94775da0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/comments", "author": null, "committer": null, "parents": [{"sha": "0fac5f2a7f15974deabf6432f4f510d0f4bcc6bc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0fac5f2a7f15974deabf6432f4f510d0f4bcc6bc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0fac5f2a7f15974deabf6432f4f510d0f4bcc6bc"}], "stats": {"total": 62, "additions": 56, "deletions": 6}, "files": [{"sha": "17f2cfd3ec18012da7e795c5ed81a80aa869643b", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "patch": "@@ -1,3 +1,9 @@\n+2018-05-15  Prathamesh Kulkarni  <prathamesh.kulkarni@linaro.org>\n+\n+\tPR tree-optimization/83648\n+\t* ipa-pure-const.c (malloc_candidate_p): Allow function with NULL\n+\treturn value as malloc candidate.\n+\n 2018-05-15  Prathamesh Kulkarni  <prathamesh.kulkarni@linaro.org>\n \n \tPR ipa/85734"}, {"sha": "567b615fb60e457c831336ffd7f0be905292922f", "filename": "gcc/ipa-pure-const.c", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Fipa-pure-const.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Fipa-pure-const.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-pure-const.c?ref=a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "patch": "@@ -919,11 +919,13 @@ malloc_candidate_p (function *fun, bool ipa)\n #define DUMP_AND_RETURN(reason)  \\\n {  \\\n   if (dump_file && (dump_flags & TDF_DETAILS))  \\\n-    fprintf (dump_file, \"%s\", (reason));  \\\n+    fprintf (dump_file, \"\\n%s is not a malloc candidate, reason: %s\\n\", \\\n+\t     (node->name()), (reason));  \\\n   return false;  \\\n }\n \n-  if (EDGE_COUNT (exit_block->preds) == 0)\n+  if (EDGE_COUNT (exit_block->preds) == 0\n+      || !flag_delete_null_pointer_checks)\n     return false;\n \n   FOR_EACH_EDGE (e, ei, exit_block->preds)\n@@ -938,6 +940,9 @@ malloc_candidate_p (function *fun, bool ipa)\n       if (!retval)\n \tDUMP_AND_RETURN(\"No return value.\")\n \n+      if (integer_zerop (retval))\n+\tcontinue;\n+\n       if (TREE_CODE (retval) != SSA_NAME\n \t  || TREE_CODE (TREE_TYPE (retval)) != POINTER_TYPE)\n \tDUMP_AND_RETURN(\"Return value is not SSA_NAME or not a pointer type.\")\n@@ -970,11 +975,14 @@ malloc_candidate_p (function *fun, bool ipa)\n \tfor (unsigned i = 0; i < gimple_phi_num_args (phi); ++i)\n \t  {\n \t    tree arg = gimple_phi_arg_def (phi, i);\n+\t    if (integer_zerop (arg))\n+\t      continue;\n+\n \t    if (TREE_CODE (arg) != SSA_NAME)\n-\t      DUMP_AND_RETURN(\"phi arg is not SSA_NAME.\")\n-\t    if (!(arg == null_pointer_node || check_retval_uses (arg, phi)))\n-\t      DUMP_AND_RETURN(\"phi arg has uses outside phi\"\n-\t\t\t      \" and comparisons against 0.\")\n+\t      DUMP_AND_RETURN (\"phi arg is not SSA_NAME.\");\n+\t    if (!check_retval_uses (arg, phi))\n+\t      DUMP_AND_RETURN (\"phi arg has uses outside phi\"\n+\t\t\t       \" and comparisons against 0.\")\n \n \t    gimple *arg_def = SSA_NAME_DEF_STMT (arg);\n \t    gcall *call_stmt = dyn_cast<gcall *> (arg_def);"}, {"sha": "90839ae94284cf9cd16b82f1f7f6378fb0b589f1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "patch": "@@ -1,3 +1,9 @@\n+2018-05-15  Prathamesh Kulkarni  <prathamesh.kulkarni@linaro.org>\n+\n+\tPR tree-optimization/83648\n+\t* gcc.dg/tree-ssa/pr83648.c: New test.\n+\t* gcc.dg/tree-ssa/pr83648-2.c: Likewise.\n+\n 2018-05-14  Prathamesh Kulkarni  <prathamesh.kulkarni@linaro.org>\n \n \tPR ipa/85734"}, {"sha": "ffa7e462abe6ca3001235100e4886cd13a9129c0", "filename": "gcc/testsuite/gcc.dg/tree-ssa/pr83648-2.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr83648-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr83648-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr83648-2.c?ref=a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "patch": "@@ -0,0 +1,15 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fno-delete-null-pointer-checks -fdump-tree-local-pure-const-details\" } */\n+\n+void *g(unsigned n)\n+{\n+  return n ? __builtin_malloc (n) : 0;\n+}\n+\n+void *h()\n+{\n+  return 0;\n+}\n+\n+/* { dg-final { scan-tree-dump-not \"Function found to be malloc: g\" \"local-pure-const1\" } } */\n+/* { dg-final { scan-tree-dump-not \"Function found to be malloc: h\" \"local-pure-const1\" } } */"}, {"sha": "febfd7d9319661884eb5887f74b34fcb2a83fbb7", "filename": "gcc/testsuite/gcc.dg/tree-ssa/pr83648.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr83648.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr83648.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fpr83648.c?ref=a8c80d03d4e0fab9cf4edb7bd5acb7edafd2438c", "patch": "@@ -0,0 +1,15 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-local-pure-const-details\" } */\n+\n+void *g(unsigned n)\n+{\n+  return n ? __builtin_malloc (n) : 0;\n+}\n+\n+void *h()\n+{\n+  return 0;\n+}\n+\n+/* { dg-final { scan-tree-dump \"Function found to be malloc: g\" \"local-pure-const1\" } } */\n+/* { dg-final { scan-tree-dump \"Function found to be malloc: h\" \"local-pure-const1\" } } */"}]}