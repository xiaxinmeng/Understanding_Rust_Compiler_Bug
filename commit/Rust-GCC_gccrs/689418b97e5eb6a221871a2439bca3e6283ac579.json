{"sha": "689418b97e5eb6a221871a2439bca3e6283ac579", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Njg5NDE4Yjk3ZTVlYjZhMjIxODcxYTI0MzliY2EzZTYyODNhYzU3OQ==", "commit": {"author": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-03-31T18:38:38Z"}, "committer": {"name": "Tobias Burnus", "email": "tobias@codesourcery.com", "date": "2020-03-31T18:38:38Z"}, "message": "libgomp \u2013 fix handling of 'target enter data'\n\n\t* target.c (GOMP_target_enter_exit_data): Handle PSET/MAP_POINTER.\n\t* testsuite/libgomp.fortran/target-enter-data-1.f90: New.", "tree": {"sha": "8d4189f370ad62a895722d42beafed401d6472e7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8d4189f370ad62a895722d42beafed401d6472e7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/689418b97e5eb6a221871a2439bca3e6283ac579", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/689418b97e5eb6a221871a2439bca3e6283ac579", "html_url": "https://github.com/Rust-GCC/gccrs/commit/689418b97e5eb6a221871a2439bca3e6283ac579", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/689418b97e5eb6a221871a2439bca3e6283ac579/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "331c438d5a67204bc143d1b0febd51740b2ea32c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/331c438d5a67204bc143d1b0febd51740b2ea32c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/331c438d5a67204bc143d1b0febd51740b2ea32c"}], "stats": {"total": 54, "additions": 53, "deletions": 1}, "files": [{"sha": "6c437930b02f2205c71da53c3dd7061e99faaa0e", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689418b97e5eb6a221871a2439bca3e6283ac579/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689418b97e5eb6a221871a2439bca3e6283ac579/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=689418b97e5eb6a221871a2439bca3e6283ac579", "patch": "@@ -1,3 +1,8 @@\n+2020-03-31  Tobias Burnus  <tobias@codesourcery.com>\n+\n+\t* target.c (GOMP_target_enter_exit_data): Handle PSET/MAP_POINTER.\n+\t* testsuite/libgomp.fortran/target-enter-data-1.f90: New.\n+\n 2020-03-24  Tobias Burnus  <tobias@codesourcery.com>\n \n \tPR libgomp/81689"}, {"sha": "36425477dcb091f076d7a2fec11147b43d6d9919", "filename": "libgomp/target.c", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689418b97e5eb6a221871a2439bca3e6283ac579/libgomp%2Ftarget.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689418b97e5eb6a221871a2439bca3e6283ac579/libgomp%2Ftarget.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftarget.c?ref=689418b97e5eb6a221871a2439bca3e6283ac579", "patch": "@@ -2480,7 +2480,9 @@ GOMP_target_enter_exit_data (int device, size_t mapnum, void **hostaddrs,\n \t}\n     }\n \n-  size_t i;\n+  /* The variables are mapped separately such that they can be released\n+     independently.  */\n+  size_t i, j;\n   if ((flags & GOMP_TARGET_FLAG_EXIT_DATA) == 0)\n     for (i = 0; i < mapnum; i++)\n       if ((kinds[i] & 0xff) == GOMP_MAP_STRUCT)\n@@ -2489,6 +2491,15 @@ GOMP_target_enter_exit_data (int device, size_t mapnum, void **hostaddrs,\n \t\t\t &kinds[i], true, GOMP_MAP_VARS_ENTER_DATA);\n \t  i += sizes[i];\n \t}\n+      else if ((kinds[i] & 0xff) == GOMP_MAP_TO_PSET)\n+\t{\n+\t  for (j = i + 1; j < mapnum; j++)\n+\t    if (!GOMP_MAP_POINTER_P (get_kind (true, kinds, j) & 0xff))\n+\t      break;\n+\t  gomp_map_vars (devicep, j-i, &hostaddrs[i], NULL, &sizes[i],\n+\t\t\t &kinds[i], true, GOMP_MAP_VARS_ENTER_DATA);\n+\t  i += j - i - 1;\n+\t}\n       else\n \tgomp_map_vars (devicep, 1, &hostaddrs[i], NULL, &sizes[i], &kinds[i],\n \t\t       true, GOMP_MAP_VARS_ENTER_DATA);"}, {"sha": "91dedebf0a0b959372e957226d016dcd1da78ed5", "filename": "libgomp/testsuite/libgomp.fortran/target-enter-data-1.f90", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/689418b97e5eb6a221871a2439bca3e6283ac579/libgomp%2Ftestsuite%2Flibgomp.fortran%2Ftarget-enter-data-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/689418b97e5eb6a221871a2439bca3e6283ac579/libgomp%2Ftestsuite%2Flibgomp.fortran%2Ftarget-enter-data-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Ftarget-enter-data-1.f90?ref=689418b97e5eb6a221871a2439bca3e6283ac579", "patch": "@@ -0,0 +1,36 @@\n+program main\n+  implicit none\n+  integer, allocatable, dimension(:) :: AA, BB, CC, DD\n+  integer :: i, N = 20\n+\n+  allocate(BB(N))\n+  AA = [(i, i=1,N)]\n+\n+  !$omp target enter data map(alloc: BB)\n+  !$omp target enter data map(to: AA)\n+\n+  !$omp target\n+    BB = 3 * AA\n+  !$omp end target\n+\n+  !$omp target exit data map(delete: AA)\n+  !$omp target exit data map(from: BB)\n+\n+  if (any (BB /= [(3*i, i=1,N)])) stop 1\n+  if (any (AA /= [(i, i=1,N)])) stop 2\n+\n+\n+  CC = 31 * BB\n+  DD = [(-i, i=1,N)]\n+\n+  !$omp target enter data map(to: CC) map(alloc: DD)\n+\n+  !$omp target\n+    DD = 5 * CC\n+  !$omp end target\n+\n+  !$omp target exit data map(delete: CC) map(from: DD)\n+\n+  if (any (CC /= [(31*3*i, i=1,N)])) stop 3\n+  if (any (DD /= [(31*3*5*i, i=1,N)])) stop 4\n+end"}]}