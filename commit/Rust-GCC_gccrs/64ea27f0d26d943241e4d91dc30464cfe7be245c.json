{"sha": "64ea27f0d26d943241e4d91dc30464cfe7be245c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjRlYTI3ZjBkMjZkOTQzMjQxZTRkOTFkYzMwNDY0Y2ZlN2JlMjQ1Yw==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2017-11-28T21:45:56Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2017-11-28T21:45:56Z"}, "message": "Handle very long lines when printing fix-it hints\n\nWhen fixing PR c/82050 I noticed a bug in how we print fix-it hints\nfor very long lines: we weren't taking into account the x-offset for\nthe line when printing the fix-it hint.\n\nThis could lead to output where instead of printing:\n\nfoo.c:14:3944: error: etc\n  = foo.field\n        ^~~~~\n        replacement\n\nwhere the lines have been offset to start printing at about column 3900,\nthe \"replacement\" line was erroneously *not* offset, and was thus\nprefixed by thousands of spaces, leading to large whitespace gaps in\nthe output, and the replacement failing to line up with the source to be\nreplaced.\n\nFixed thusly.\n\ngcc/ChangeLog:\n\t* diagnostic-show-locus.c (layout::print_trailing_fixits): Handle\n\tm_x_offset.\n\t(layout::move_to_column): Likewise.\n\ngcc/testsuite/ChangeLog:\n\t* gcc.dg/plugin/diagnostic-test-show-locus-bw.c\n\t(test_very_wide_line): Update expected output to include a\n\tfix-it hint.\n\t* gcc.dg/plugin/diagnostic-test-show-locus-color.c\n\t(test_very_wide_line): Likewise.\n\t* gcc.dg/plugin/diagnostic_plugin_test_show_locus.c\n\t(test_show_locus): Add a fix-it hint to \"test_very_wide_line\".\n\nFrom-SVN: r255219", "tree": {"sha": "ddb1c2a17409e23bb079ed3fde000da92cfa6021", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ddb1c2a17409e23bb079ed3fde000da92cfa6021"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/64ea27f0d26d943241e4d91dc30464cfe7be245c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/64ea27f0d26d943241e4d91dc30464cfe7be245c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/64ea27f0d26d943241e4d91dc30464cfe7be245c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/64ea27f0d26d943241e4d91dc30464cfe7be245c/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1a2e970832f6076e76adc06b42c106bdb568a86c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1a2e970832f6076e76adc06b42c106bdb568a86c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1a2e970832f6076e76adc06b42c106bdb568a86c"}], "stats": {"total": 31, "additions": 26, "deletions": 5}, "files": [{"sha": "bfc721c48506c169fc182ca945aa34e5dd9d19d2", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=64ea27f0d26d943241e4d91dc30464cfe7be245c", "patch": "@@ -1,3 +1,9 @@\n+2017-11-28  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* diagnostic-show-locus.c (layout::print_trailing_fixits): Handle\n+\tm_x_offset.\n+\t(layout::move_to_column): Likewise.\n+\n 2017-11-28  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR sanitizer/81275"}, {"sha": "387c24555fc756f044abea40389fad42f8397d0f", "filename": "gcc/diagnostic-show-locus.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Fdiagnostic-show-locus.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Fdiagnostic-show-locus.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdiagnostic-show-locus.c?ref=64ea27f0d26d943241e4d91dc30464cfe7be245c", "patch": "@@ -1691,7 +1691,7 @@ layout::print_trailing_fixits (int row)\n   /* Now print the corrections.  */\n   unsigned i;\n   correction *c;\n-  int column = 0;\n+  int column = m_x_offset;\n \n   FOR_EACH_VEC_ELT (corrections.m_corrections, i, c)\n     {\n@@ -1845,7 +1845,7 @@ layout::move_to_column (int *column, int dest_column)\n   if (*column > dest_column)\n     {\n       print_newline ();\n-      *column = 0;\n+      *column = m_x_offset;\n     }\n \n   while (*column < dest_column)"}, {"sha": "efee461a10729cf5cd9acdfc8f6cde3cf87c0306", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=64ea27f0d26d943241e4d91dc30464cfe7be245c", "patch": "@@ -1,3 +1,13 @@\n+2017-11-28  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* gcc.dg/plugin/diagnostic-test-show-locus-bw.c\n+\t(test_very_wide_line): Update expected output to include a\n+\tfix-it hint.\n+\t* gcc.dg/plugin/diagnostic-test-show-locus-color.c\n+\t(test_very_wide_line): Likewise.\n+\t* gcc.dg/plugin/diagnostic_plugin_test_show_locus.c\n+\t(test_show_locus): Add a fix-it hint to \"test_very_wide_line\".\n+\n 2017-11-28  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR sanitizer/81275"}, {"sha": "513c0af772fa2c143d2c052c3b584516eb2f9caf", "filename": "gcc/testsuite/gcc.dg/plugin/diagnostic-test-show-locus-bw.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic-test-show-locus-bw.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic-test-show-locus-bw.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic-test-show-locus-bw.c?ref=64ea27f0d26d943241e4d91dc30464cfe7be245c", "patch": "@@ -122,6 +122,7 @@ void test_very_wide_line (void)\n  6789012345678901234567890123456789012345678901234567890123456789012345\n                                               float f = foo * bar;\n                                                         ~~~~^~~~~\n+                                                        bar * foo\n    { dg-end-multiline-output \"\" } */\n #endif\n }"}, {"sha": "4cc406d76dedd5b1dfcf5a810cbb0d6d30d1e248", "filename": "gcc/testsuite/gcc.dg/plugin/diagnostic-test-show-locus-color.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic-test-show-locus-color.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic-test-show-locus-color.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic-test-show-locus-color.c?ref=64ea27f0d26d943241e4d91dc30464cfe7be245c", "patch": "@@ -122,6 +122,7 @@ void test_very_wide_line (void)\n  6789012345678901234567890123456789012345678901234567890123456789012345\n                                               float f = \u001b[01;35m\u001b[Kfoo * bar\u001b[m\u001b[K;\n                                                         \u001b[01;35m\u001b[K~~~~^~~~~\u001b[m\u001b[K\n+                                                        \u001b[32m\u001b[Kbar * foo\u001b[m\u001b[K\n    { dg-end-multiline-output \"\" } */\n #endif\n }"}, {"sha": "3908b922b26b8c722b0b865364c8b9a05d814651", "filename": "gcc/testsuite/gcc.dg/plugin/diagnostic_plugin_test_show_locus.c", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_plugin_test_show_locus.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64ea27f0d26d943241e4d91dc30464cfe7be245c/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_plugin_test_show_locus.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_plugin_test_show_locus.c?ref=64ea27f0d26d943241e4d91dc30464cfe7be245c", "patch": "@@ -235,9 +235,12 @@ test_show_locus (function *fun)\n     {\n       const int line = fnstart_line + 2;\n       global_dc->show_ruler_p = true;\n-      warning_at (make_location (get_loc (line, 94), get_loc (line, 90),\n-\t\t\t\t get_loc (line, 98)),\n-\t\t  0, \"test\");\n+      rich_location richloc (line_table,\n+\t\t\t     make_location (get_loc (line, 94),\n+\t\t\t\t\t    get_loc (line, 90),\n+\t\t\t\t\t    get_loc (line, 98)));\n+      richloc.add_fixit_replace (\"bar * foo\");\n+      warning_at (&richloc, 0, \"test\");\n       global_dc->show_ruler_p = false;\n     }\n "}]}