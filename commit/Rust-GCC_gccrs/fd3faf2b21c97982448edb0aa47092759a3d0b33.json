{"sha": "fd3faf2b21c97982448edb0aa47092759a3d0b33", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZmQzZmFmMmIyMWM5Nzk4MjQ0OGVkYjBhYTQ3MDkyNzU5YTNkMGIzMw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2011-09-05T04:33:40Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2011-09-05T04:33:40Z"}, "message": "class.c (trivial_default_constructor_is_constexpr): Rename from synthesized_default_constructor_is_constexpr.\n\n\t* class.c (trivial_default_constructor_is_constexpr): Rename from\n\tsynthesized_default_constructor_is_constexpr.\n\t(type_has_constexpr_default_constructor): Adjust.\n\t(add_implicitly_declared_members): Call it instead.\n\t(explain_non_literal_class): Explain about non-constexpr default ctor.\n\t* cp-tree.h: Adjust.\n\t* method.c (synthesized_method_walk): Adjust.\n\t* semantics.c (explain_invalid_constexpr_fn): Handle defaulted\n\tfunctions, too.\n\nFrom-SVN: r178519", "tree": {"sha": "fa70f6e70fb4efbf0e60105886e9e43c79520291", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fa70f6e70fb4efbf0e60105886e9e43c79520291"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fd3faf2b21c97982448edb0aa47092759a3d0b33", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd3faf2b21c97982448edb0aa47092759a3d0b33", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fd3faf2b21c97982448edb0aa47092759a3d0b33", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd3faf2b21c97982448edb0aa47092759a3d0b33/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "aee8801251cc3fd10dc12e4fc48a0d0bc5f37019", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aee8801251cc3fd10dc12e4fc48a0d0bc5f37019", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aee8801251cc3fd10dc12e4fc48a0d0bc5f37019"}], "stats": {"total": 62, "additions": 49, "deletions": 13}, "files": [{"sha": "d61f5f782b702e2370bdeac7fa07b169e2bb13df", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -1,5 +1,15 @@\n 2011-09-04  Jason Merrill  <jason@redhat.com>\n \n+\t* class.c (trivial_default_constructor_is_constexpr): Rename from\n+\tsynthesized_default_constructor_is_constexpr.\n+\t(type_has_constexpr_default_constructor): Adjust.\n+\t(add_implicitly_declared_members): Call it instead.\n+\t(explain_non_literal_class): Explain about non-constexpr default ctor.\n+\t* cp-tree.h: Adjust.\n+\t* method.c (synthesized_method_walk): Adjust.\n+\t* semantics.c (explain_invalid_constexpr_fn): Handle defaulted\n+\tfunctions, too.\n+\n \tPR c++/50248\n \tCore 1358\n \t* init.c (perform_member_init): Don't diagnose missing inits here."}, {"sha": "a4a7468bad1cb74edaaf264c25549ac597d63503", "filename": "gcc/cp/class.c", "status": "modified", "additions": 20, "deletions": 9, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -2726,7 +2726,8 @@ add_implicitly_declared_members (tree t,\n       CLASSTYPE_LAZY_DEFAULT_CTOR (t) = 1;\n       if (cxx_dialect >= cxx0x)\n \tTYPE_HAS_CONSTEXPR_CTOR (t)\n-\t  = synthesized_default_constructor_is_constexpr (t);\n+\t  /* This might force the declaration.  */\n+\t  = type_has_constexpr_default_constructor (t);\n     }\n \n   /* [class.ctor]\n@@ -4355,15 +4356,15 @@ type_has_user_provided_default_constructor (tree t)\n   return false;\n }\n \n-/* Returns true iff for class T, a synthesized default constructor\n+/* Returns true iff for class T, a trivial synthesized default constructor\n    would be constexpr.  */\n \n bool\n-synthesized_default_constructor_is_constexpr (tree t)\n+trivial_default_constructor_is_constexpr (tree t)\n {\n-  /* A defaulted default constructor is constexpr\n+  /* A defaulted trivial default constructor is constexpr\n      if there is nothing to initialize.  */\n-  /* FIXME adjust for non-static data member initializers.  */\n+  gcc_assert (!TYPE_HAS_COMPLEX_DFLT (t));\n   return is_really_empty_class (t);\n }\n \n@@ -4381,7 +4382,12 @@ type_has_constexpr_default_constructor (tree t)\n       return false;\n     }\n   if (CLASSTYPE_LAZY_DEFAULT_CTOR (t))\n-    return synthesized_default_constructor_is_constexpr (t);\n+    {\n+      if (!TYPE_HAS_COMPLEX_DFLT (t))\n+\treturn trivial_default_constructor_is_constexpr (t);\n+      /* Non-trivial, we need to check subobject constructors.  */\n+      lazily_declare_fn (sfk_constructor, t);\n+    }\n   fns = locate_ctor (t);\n   return (fns && DECL_DECLARED_CONSTEXPR_P (fns));\n }\n@@ -4608,9 +4614,14 @@ explain_non_literal_class (tree t)\n   else if (CLASSTYPE_NON_AGGREGATE (t)\n \t   && !TYPE_HAS_TRIVIAL_DFLT (t)\n \t   && !TYPE_HAS_CONSTEXPR_CTOR (t))\n-    inform (0, \"  %q+T is not an aggregate, does not have a trivial \"\n-\t    \"default constructor, and has no constexpr constructor that \"\n-\t    \"is not a copy or move constructor\", t);\n+    {\n+      inform (0, \"  %q+T is not an aggregate, does not have a trivial \"\n+\t      \"default constructor, and has no constexpr constructor that \"\n+\t      \"is not a copy or move constructor\", t);\n+      if (TYPE_HAS_DEFAULT_CONSTRUCTOR (t)\n+\t  && !type_has_user_provided_default_constructor (t))\n+\texplain_invalid_constexpr_fn (locate_ctor (t));\n+    }\n   else\n     {\n       tree binfo, base_binfo, field; int i;"}, {"sha": "cf6c056e4e554b699607d2a8fd58edc6a1ca75dd", "filename": "gcc/cp/cp-tree.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fcp-tree.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fcp-tree.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-tree.h?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -4823,7 +4823,7 @@ extern tree in_class_defaulted_default_constructor (tree);\n extern bool user_provided_p\t\t\t(tree);\n extern bool type_has_user_provided_constructor  (tree);\n extern bool type_has_user_provided_default_constructor (tree);\n-extern bool synthesized_default_constructor_is_constexpr (tree);\n+extern bool trivial_default_constructor_is_constexpr (tree);\n extern bool type_has_constexpr_default_constructor (tree);\n extern bool type_has_virtual_destructor\t\t(tree);\n extern bool type_has_move_constructor\t\t(tree);"}, {"sha": "5b24f8f02858fa771b7a31f4a995bd65333624d2", "filename": "gcc/cp/method.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fmethod.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fmethod.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fmethod.c?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -1187,7 +1187,7 @@ synthesized_method_walk (tree ctype, special_function_kind sfk, bool const_p,\n       && (!copy_arg_p || cxx_dialect < cxx0x))\n     {\n       if (constexpr_p && sfk == sfk_constructor)\n-\t*constexpr_p = synthesized_default_constructor_is_constexpr (ctype);\n+\t*constexpr_p = trivial_default_constructor_is_constexpr (ctype);\n       return;\n     }\n "}, {"sha": "bdc4cf29e34458b2555755c578b305ed2a4e9420", "filename": "gcc/cp/semantics.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fsemantics.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Fcp%2Fsemantics.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsemantics.c?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -5881,8 +5881,9 @@ explain_invalid_constexpr_fn (tree fun)\n   static struct pointer_set_t *diagnosed;\n   tree body;\n   location_t save_loc;\n-  /* Only diagnose instantiations of constexpr templates.  */\n-  if (!is_instantiation_of_constexpr (fun))\n+  /* Only diagnose defaulted functions or instantiations.  */\n+  if (!DECL_DEFAULTED_FN (fun)\n+      && !is_instantiation_of_constexpr (fun))\n     return;\n   if (diagnosed == NULL)\n     diagnosed = pointer_set_create ();"}, {"sha": "2f149c4d42cb0dba2df2d258eab9059fa76e579c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -1,5 +1,7 @@\n 2011-09-04  Jason Merrill  <jason@redhat.com>\n \n+\t* g++.dg/cpp0x/constexpr-default-ctor.C: New.\n+\n \tPR c++/50248\n \tCore 1358\n \t* g++.dg/cpp0x/constexpr-template1.C: New."}, {"sha": "d3868b599ac5a61db28703169904aecd6ae1dd01", "filename": "gcc/testsuite/g++.dg/cpp0x/constexpr-default-ctor.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-default-ctor.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fd3faf2b21c97982448edb0aa47092759a3d0b33/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-default-ctor.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-default-ctor.C?ref=fd3faf2b21c97982448edb0aa47092759a3d0b33", "patch": "@@ -0,0 +1,12 @@\n+// { dg-options -std=c++0x }\n+\n+struct A {\n+  int i;\n+  constexpr A():i(42) { };\n+};\n+struct B: A { };\n+constexpr int f(B b) { return b.i; }\n+\n+struct C { C(); };\t       // { dg-message \"calls non-constexpr\" }\n+struct D: C { };\t       // { dg-message \"no constexpr constructor\" }\n+constexpr int g(D d) { return 42; } // { dg-error \"invalid type\" }"}]}