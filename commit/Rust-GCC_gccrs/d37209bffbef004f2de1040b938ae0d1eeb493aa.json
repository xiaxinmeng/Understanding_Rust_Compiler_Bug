{"sha": "d37209bffbef004f2de1040b938ae0d1eeb493aa", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDM3MjA5YmZmYmVmMDA0ZjJkZTEwNDBiOTM4YWUwZDFlZWI0OTNhYQ==", "commit": {"author": {"name": "Gary Dismukes", "email": "dismukes@adacore.com", "date": "2005-06-16T08:42:04Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2005-06-16T08:42:04Z"}, "message": "layout.adb (Discrimify): Remove resetting of Vtype to the underlying type which turns out to be an...\n\n2005-06-14  Gary Dismukes  <dismukes@adacore.com>\n\n\t* layout.adb (Discrimify): Remove resetting of Vtype to the underlying\n\ttype which turns out to be an incomplete and incorrect fix.\n\t(Layout_Array_Type): Use Underlying_Type when checking whether the scope\n\tof the type is declared in a record (for determination of insertion\n\ttype).\n\t(SO_Ref_From_Expr): Test whether Vtype denotes a partial or full view of\n\ta private type and ensure that the primary entity is used for the type\n\tof the newly created function's V formal by taking the Etype of the\n\tview.\n\nFrom-SVN: r101044", "tree": {"sha": "458b4c68b0da5ede00eaa37fd4ee5736a5c61615", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/458b4c68b0da5ede00eaa37fd4ee5736a5c61615"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d37209bffbef004f2de1040b938ae0d1eeb493aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d37209bffbef004f2de1040b938ae0d1eeb493aa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d37209bffbef004f2de1040b938ae0d1eeb493aa", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d37209bffbef004f2de1040b938ae0d1eeb493aa/comments", "author": {"login": "dismukes", "id": 50880541, "node_id": "MDQ6VXNlcjUwODgwNTQx", "avatar_url": "https://avatars.githubusercontent.com/u/50880541?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dismukes", "html_url": "https://github.com/dismukes", "followers_url": "https://api.github.com/users/dismukes/followers", "following_url": "https://api.github.com/users/dismukes/following{/other_user}", "gists_url": "https://api.github.com/users/dismukes/gists{/gist_id}", "starred_url": "https://api.github.com/users/dismukes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dismukes/subscriptions", "organizations_url": "https://api.github.com/users/dismukes/orgs", "repos_url": "https://api.github.com/users/dismukes/repos", "events_url": "https://api.github.com/users/dismukes/events{/privacy}", "received_events_url": "https://api.github.com/users/dismukes/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "564383da33e0a312edb3fc57ce5eddef8b5ab119", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/564383da33e0a312edb3fc57ce5eddef8b5ab119", "html_url": "https://github.com/Rust-GCC/gccrs/commit/564383da33e0a312edb3fc57ce5eddef8b5ab119"}], "stats": {"total": 31, "additions": 21, "deletions": 10}, "files": [{"sha": "1f4cd9ba21a4953343639abae1da5c4b2f30a0c6", "filename": "gcc/ada/layout.adb", "status": "modified", "additions": 21, "deletions": 10, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d37209bffbef004f2de1040b938ae0d1eeb493aa/gcc%2Fada%2Flayout.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d37209bffbef004f2de1040b938ae0d1eeb493aa/gcc%2Fada%2Flayout.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flayout.adb?ref=d37209bffbef004f2de1040b938ae0d1eeb493aa", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 2001-2004 Free Software Foundation, Inc.          --\n+--          Copyright (C) 2001-2005 Free Software Foundation, Inc.          --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -993,12 +993,6 @@ package body Layout is\n                Decl := Parent (Parent (Entity (N)));\n                Size := (Discrim, Size.Nod);\n                Vtyp := Defining_Identifier (Decl);\n-\n-               --  Ensure that we get a private type's full type\n-\n-               if Present (Underlying_Type (Vtyp)) then\n-                  Vtyp := Underlying_Type (Vtyp);\n-               end if;\n             end if;\n \n             Typ := Etype (N);\n@@ -1029,8 +1023,8 @@ package body Layout is\n \n       --  Calculate proper type for insertions\n \n-      if Is_Record_Type (Scope (E)) then\n-         Insert_Typ := Scope (E);\n+      if Is_Record_Type (Underlying_Type (Scope (E))) then\n+         Insert_Typ := Underlying_Type (Scope (E));\n       else\n          Insert_Typ := E;\n       end if;\n@@ -2951,6 +2945,8 @@ package body Layout is\n \n       Decl : Node_Id;\n \n+      Vtype_Primary_View : Entity_Id;\n+\n       function Check_Node_V_Ref (N : Node_Id) return Traverse_Result;\n       --  Function used to check one node for reference to V\n \n@@ -2992,6 +2988,21 @@ package body Layout is\n       if Has_V_Ref (Expr) = Abandon then\n \n          pragma Assert (Present (Vtype));\n+\n+         --  Check whether Vtype is a view of a private type and ensure that\n+         --  we use the primary view of the type (which is denoted by its\n+         --  Etype, whether it's the type's partial or full view entity).\n+         --  This is needed to make sure that we use the same (primary) view\n+         --  of the type for all V formals, whether the current view of the\n+         --  type is the partial or full view, so that types will always\n+         --  match on calls from one size function to another.\n+\n+         if  Has_Private_Declaration (Vtype) then\n+            Vtype_Primary_View := Etype (Vtype);\n+         else\n+            Vtype_Primary_View := Vtype;\n+         end if;\n+\n          Set_Is_Discrim_SO_Function (K);\n \n          Decl :=\n@@ -3005,7 +3016,7 @@ package body Layout is\n                        Defining_Identifier =>\n                          Make_Defining_Identifier (Loc, Chars => Vname),\n                        Parameter_Type      =>\n-                         New_Occurrence_Of (Vtype, Loc))),\n+                         New_Occurrence_Of (Vtype_Primary_View, Loc))),\n                    Subtype_Mark =>\n                      New_Occurrence_Of (Standard_Unsigned, Loc)),\n "}]}