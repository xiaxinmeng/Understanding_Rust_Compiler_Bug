{"sha": "47484baae5aa2c74f1b65547f4436baa040b2728", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDc0ODRiYWFlNWFhMmM3NGYxYjY1NTQ3ZjQ0MzZiYWEwNDBiMjcyOA==", "commit": {"author": {"name": "Bob Duff", "email": "duff@adacore.com", "date": "2020-06-11T18:05:55Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-07-16T09:18:17Z"}, "message": "[Ada] Ada2020: AI12-0117 Restriction No_Tasks_Unassigned_To_CPU\n\ngcc/ada/\n\n\t* gnatbind.adb (Gnatbind): For No_Tasks_Unassigned_To_CPU, check\n\tthat CPU has been set on the main subprogram.\n\t(Restriction_Could_Be_Set): Don't print\n\tNo_Tasks_Unassigned_To_CPU if it would violate the\n\tabove-mentioned rule. Up to now, all restrictions were checked\n\tby the compiler, with the binder just checking for consistency.\n\tBut the compiler can't know which subprogram is the main, so\n\tit's impossible to check this one at compile time.\n\t* restrict.ads, restrict.adb: Misc refactoring. Change Warning\n\tto Warn, for consistency, since most already use Warn.\n\t(Set_Restriction): New convenience routine.\n\t* sem_ch13.adb (Attribute_CPU): Check\n\tNo_Tasks_Unassigned_To_CPU.\n\t* sem_prag.adb (Pragma_CPU): Check No_Tasks_Unassigned_To_CPU.\n\tMisc refactoring.\n\t* tbuild.ads, tbuild.adb (Sel_Comp): New functions for building\n\tselected components.", "tree": {"sha": "b58e36ef11a0db4684f4d64519090c6655c9d472", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b58e36ef11a0db4684f4d64519090c6655c9d472"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/47484baae5aa2c74f1b65547f4436baa040b2728", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47484baae5aa2c74f1b65547f4436baa040b2728", "html_url": "https://github.com/Rust-GCC/gccrs/commit/47484baae5aa2c74f1b65547f4436baa040b2728", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47484baae5aa2c74f1b65547f4436baa040b2728/comments", "author": {"login": "bobduff", "id": 29099567, "node_id": "MDQ6VXNlcjI5MDk5NTY3", "avatar_url": "https://avatars.githubusercontent.com/u/29099567?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bobduff", "html_url": "https://github.com/bobduff", "followers_url": "https://api.github.com/users/bobduff/followers", "following_url": "https://api.github.com/users/bobduff/following{/other_user}", "gists_url": "https://api.github.com/users/bobduff/gists{/gist_id}", "starred_url": "https://api.github.com/users/bobduff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bobduff/subscriptions", "organizations_url": "https://api.github.com/users/bobduff/orgs", "repos_url": "https://api.github.com/users/bobduff/repos", "events_url": "https://api.github.com/users/bobduff/events{/privacy}", "received_events_url": "https://api.github.com/users/bobduff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "22157c64fc3ac5301d58f6497731f73959d5c29b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/22157c64fc3ac5301d58f6497731f73959d5c29b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/22157c64fc3ac5301d58f6497731f73959d5c29b"}], "stats": {"total": 315, "additions": 176, "deletions": 139}, "files": [{"sha": "be087af63ea866e84bdfe009725841d1c34f171b", "filename": "gcc/ada/gnatbind.adb", "status": "modified", "additions": 30, "deletions": 9, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Fgnatbind.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Fgnatbind.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgnatbind.adb?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -238,20 +238,28 @@ procedure Gnatbind is\n       ------------------------------\n \n       function Restriction_Could_Be_Set (R : Restriction_Id) return Boolean is\n-         CR : Restrictions_Info renames Cumulative_Restrictions;\n-\n+         CR     : Restrictions_Info renames Cumulative_Restrictions;\n+         Result : Boolean;\n       begin\n          case R is\n \n             --  Boolean restriction\n \n             when All_Boolean_Restrictions =>\n \n-               --  The condition for listing a boolean restriction as an\n-               --  additional restriction that could be set is that it is\n-               --  not violated by any unit, and not already set.\n+               --  Print it if not violated by any unit, and not already set...\n+\n+               Result := not CR.Violated (R) and then not CR.Set (R);\n+\n+               --  ...except that for No_Tasks_Unassigned_To_CPU, we don't want\n+               --  to print it if it would violate the restriction post\n+               --  compilation.\n \n-               return CR.Violated (R) = False and then CR.Set (R) = False;\n+               if R = No_Tasks_Unassigned_To_CPU\n+                 and then ALIs.Table (ALIs.First).Main_CPU = No_Main_CPU\n+               then\n+                  Result := False;\n+               end if;\n \n             --  Parameter restriction\n \n@@ -261,25 +269,27 @@ procedure Gnatbind is\n                --  unknown, the restriction can definitely not be listed.\n \n                if CR.Violated (R) and then CR.Unknown (R) then\n-                  return False;\n+                  Result := False;\n \n                --  We can list the restriction if it is not set\n \n                elsif not CR.Set (R) then\n-                  return True;\n+                  Result := True;\n \n                --  We can list the restriction if is set to a greater value\n                --  than the maximum value known for the violation.\n \n                else\n-                  return CR.Value (R) > CR.Count (R);\n+                  Result := CR.Value (R) > CR.Count (R);\n                end if;\n \n             --  No other values for R possible\n \n             when others =>\n                raise Program_Error;\n          end case;\n+\n+         return Result;\n       end Restriction_Could_Be_Set;\n \n    --  Start of processing for List_Applicable_Restrictions\n@@ -881,6 +891,17 @@ begin\n       --  mode where we want to be more flexible.\n \n       if not CodePeer_Mode then\n+         --  AI12-0117-1, \"Restriction No_Tasks_Unassigned_To_CPU\":\n+         --  If the restriction No_Tasks_Unassigned_To_CPU applies, then\n+         --  check that the main subprogram has a CPU assigned.\n+\n+         if Cumulative_Restrictions.Set (No_Tasks_Unassigned_To_CPU)\n+           and then ALIs.Table (ALIs.First).Main_CPU = No_Main_CPU\n+         then\n+            Error_Msg (\"No_Tasks_Unassigned_To_CPU restriction requires CPU\" &\n+                         \" aspect to be specified for main procedure\");\n+         end if;\n+\n          Check_Duplicated_Subunits;\n          Check_Versions;\n          Check_Consistency;"}, {"sha": "5ba2931cfd9190eb99e48ced12bad5ff30c89f93", "filename": "gcc/ada/restrict.adb", "status": "modified", "additions": 35, "deletions": 16, "changes": 51, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Frestrict.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Frestrict.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Frestrict.adb?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -1354,8 +1354,6 @@ package body Restrict is\n    -- Set_Restriction --\n    ---------------------\n \n-   --  Case of Boolean restriction\n-\n    procedure Set_Restriction\n      (R : All_Boolean_Restrictions;\n       N : Node_Id)\n@@ -1395,8 +1393,6 @@ package body Restrict is\n       end if;\n    end Set_Restriction;\n \n-   --  Case of parameter restriction\n-\n    procedure Set_Restriction\n      (R : All_Parameter_Restrictions;\n       N : Node_Id;\n@@ -1446,6 +1442,29 @@ package body Restrict is\n       Restriction_Profile_Name (R) := No_Profile;\n    end Set_Restriction;\n \n+   procedure Set_Restriction\n+     (R    : All_Restrictions;\n+      N    : Node_Id;\n+      Warn : Boolean;\n+      V    : Integer := Integer'First)\n+   is\n+      Set : Boolean := True;\n+   begin\n+      if Warn and then Restriction_Active (R) then\n+         Set := False;\n+      end if;\n+\n+      if Set then\n+         if R in All_Boolean_Restrictions then\n+            Set_Restriction (R, N);\n+         else\n+            Set_Restriction (R, N, V);\n+         end if;\n+\n+         Restriction_Warnings (R) := Warn;\n+      end if;\n+   end Set_Restriction;\n+\n    -----------------------------------\n    -- Set_Restriction_No_Dependence --\n    -----------------------------------\n@@ -1485,7 +1504,7 @@ package body Restrict is\n \n    procedure Set_Restriction_No_Use_Of_Entity\n      (Entity  : Node_Id;\n-      Warning : Boolean;\n+      Warn    : Boolean;\n       Profile : Profile_Name := No_Profile)\n    is\n       Nam : Node_Id;\n@@ -1501,7 +1520,7 @@ package body Restrict is\n \n             --  Error has precedence over warning\n \n-            if not Warning then\n+            if not Warn then\n                No_Use_Of_Entity.Table (J).Warn := False;\n             end if;\n \n@@ -1511,7 +1530,7 @@ package body Restrict is\n \n       --  Entry is not currently in table\n \n-      No_Use_Of_Entity.Append ((Entity, Warning, Profile));\n+      No_Use_Of_Entity.Append ((Entity, Warn, Profile));\n \n       --  Now we need to find the direct name and set Boolean2 flag\n \n@@ -1532,15 +1551,15 @@ package body Restrict is\n    ------------------------------------------------\n \n    procedure Set_Restriction_No_Specification_Of_Aspect\n-     (N       : Node_Id;\n-      Warning : Boolean)\n+     (N    : Node_Id;\n+      Warn : Boolean)\n    is\n       A_Id : constant Aspect_Id_Exclude_No_Aspect := Get_Aspect_Id (Chars (N));\n \n    begin\n       No_Specification_Of_Aspect_Set := True;\n       No_Specification_Of_Aspects (A_Id) := Sloc (N);\n-      No_Specification_Of_Aspect_Warning (A_Id) := Warning;\n+      No_Specification_Of_Aspect_Warning (A_Id) := Warn;\n    end Set_Restriction_No_Specification_Of_Aspect;\n \n    procedure Set_Restriction_No_Specification_Of_Aspect (A_Id : Aspect_Id) is\n@@ -1555,15 +1574,15 @@ package body Restrict is\n    -----------------------------------------\n \n    procedure Set_Restriction_No_Use_Of_Attribute\n-     (N       : Node_Id;\n-      Warning : Boolean)\n+     (N    : Node_Id;\n+      Warn : Boolean)\n    is\n       A_Id : constant Attribute_Id := Get_Attribute_Id (Chars (N));\n \n    begin\n       No_Use_Of_Attribute_Set := True;\n       No_Use_Of_Attribute (A_Id) := Sloc (N);\n-      No_Use_Of_Attribute_Warning (A_Id) := Warning;\n+      No_Use_Of_Attribute_Warning (A_Id) := Warn;\n    end Set_Restriction_No_Use_Of_Attribute;\n \n    procedure Set_Restriction_No_Use_Of_Attribute (A_Id : Attribute_Id) is\n@@ -1578,15 +1597,15 @@ package body Restrict is\n    --------------------------------------\n \n    procedure Set_Restriction_No_Use_Of_Pragma\n-     (N       : Node_Id;\n-      Warning : Boolean)\n+     (N    : Node_Id;\n+      Warn : Boolean)\n    is\n       A_Id : constant Pragma_Id := Get_Pragma_Id (Chars (N));\n \n    begin\n       No_Use_Of_Pragma_Set := True;\n       No_Use_Of_Pragma (A_Id) := Sloc (N);\n-      No_Use_Of_Pragma_Warning (A_Id) := Warning;\n+      No_Use_Of_Pragma_Warning (A_Id) := Warn;\n    end Set_Restriction_No_Use_Of_Pragma;\n \n    procedure Set_Restriction_No_Use_Of_Pragma (A_Id : Pragma_Id) is"}, {"sha": "7a84d3741c6aa70f8d3238ef01d8a59145b7a66c", "filename": "gcc/ada/restrict.ads", "status": "modified", "additions": 21, "deletions": 7, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Frestrict.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Frestrict.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Frestrict.ads?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -452,6 +452,20 @@ package Restrict is\n    --  Similar to the above, except that this is used for the case of a\n    --  parameter restriction, and the corresponding value V is given.\n \n+   procedure Set_Restriction\n+     (R    : All_Restrictions;\n+      N    : Node_Id;\n+      Warn : Boolean;\n+      V    : Integer := Integer'First);\n+   --  Same as above two, except also takes care of setting the\n+   --  Restriction_Warnings flag. V is ignored for Boolean\n+   --  restrictions.\n+   --\n+   --  If this is the first time we've seen this restriction, the warning flag\n+   --  is set to Warn. If this is a second or subsequent time, Warn = False\n+   --  wins; that is, errors always trump warnings. In that case, the warning\n+   --  flag can be set to False, but never to True.\n+\n    procedure Set_Restriction_No_Dependence\n      (Unit    : Node_Id;\n       Warn    : Boolean;\n@@ -463,8 +477,8 @@ package Restrict is\n    --  No_Dependence restriction comes from a Profile pragma.\n \n    procedure Set_Restriction_No_Specification_Of_Aspect\n-     (N       : Node_Id;\n-      Warning : Boolean);\n+     (N    : Node_Id;\n+      Warn : Boolean);\n    --  N is the node id for an identifier from a pragma Restrictions for the\n    --  No_Specification_Of_Aspect pragma. An error message will be issued if\n    --  the identifier is not a valid aspect name. Warning is set True for the\n@@ -475,8 +489,8 @@ package Restrict is\n    --  Version used by Get_Target_Parameters (via Tbuild)\n \n    procedure Set_Restriction_No_Use_Of_Attribute\n-     (N       : Node_Id;\n-      Warning : Boolean);\n+     (N    : Node_Id;\n+      Warn : Boolean);\n    --  N is the node id for the identifier in a pragma Restrictions for\n    --  No_Use_Of_Attribute. Caller has verified that this is a valid attribute\n    --  designator.\n@@ -486,7 +500,7 @@ package Restrict is\n \n    procedure Set_Restriction_No_Use_Of_Entity\n      (Entity  : Node_Id;\n-      Warning : Boolean;\n+      Warn    : Boolean;\n       Profile : Profile_Name := No_Profile);\n    --  Sets given No_Use_Of_Entity restriction in table if not there already.\n    --  Warn is True if from Restriction_Warnings, or for Restrictions if the\n@@ -497,8 +511,8 @@ package Restrict is\n    --  the entity (to optimize table searches).\n \n    procedure Set_Restriction_No_Use_Of_Pragma\n-     (N       : Node_Id;\n-      Warning : Boolean);\n+     (N    : Node_Id;\n+      Warn : Boolean);\n    --  N is the node id for the identifier in a pragma Restrictions for\n    --  No_Use_Of_Pragma. Caller has verified that this is a valid pragma id.\n "}, {"sha": "5ed468e59fdce52f9624debd85a73e9a2d320d47", "filename": "gcc/ada/sem_ch13.adb", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Fsem_ch13.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Fsem_ch13.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch13.adb?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -6464,7 +6464,24 @@ package body Sem_Ch13 is\n                Preanalyze_Spec_Expression (Expr, RTE (RE_CPU_Range));\n                Pop_Type (U_Ent);\n \n-               if not Is_OK_Static_Expression (Expr) then\n+               --  AI12-0117-1, \"Restriction No_Tasks_Unassigned_To_CPU\":\n+               --  If the expression is static, and its value is\n+               --  System.Multiprocessors.Not_A_Specific_CPU (i.e. zero) then\n+               --  that's a violation of No_Tasks_Unassigned_To_CPU. It might\n+               --  seem better to refer to Not_A_Specific_CPU here, but that\n+               --  involves a lot of horsing around with Rtsfind, and this\n+               --  value is not going to change, so it's better to hardwire\n+               --  Uint_0.\n+               --\n+               --  AI12-0055-1, \"All properties of a usage profile are defined\n+               --  by pragmas\": If the expression is nonstatic, that's a\n+               --  violation of No_Dynamic_CPU_Assignment.\n+\n+               if Is_OK_Static_Expression (Expr) then\n+                  if Expr_Value (Expr) = Uint_0 then\n+                     Check_Restriction (No_Tasks_Unassigned_To_CPU, Expr);\n+                  end if;\n+               else\n                   Check_Restriction (No_Dynamic_CPU_Assignment, Expr);\n                end if;\n             end if;"}, {"sha": "eb8f2a0494fceb36cd12812446eea3e8b139cada", "filename": "gcc/ada/sem_prag.adb", "status": "modified", "additions": 50, "deletions": 106, "changes": 156, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Fsem_prag.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Fsem_prag.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_prag.adb?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -10542,23 +10542,28 @@ package body Sem_Prag is\n                   Set_Global_No_Tasking;\n                end if;\n \n-               --  If this is a warning, then set the warning unless we already\n-               --  have a real restriction active (we never want a warning to\n-               --  override a real restriction).\n-\n-               if Warn then\n-                  if not Restriction_Active (R_Id) then\n-                     Set_Restriction (R_Id, N);\n-                     Restriction_Warnings (R_Id) := True;\n-                  end if;\n+               Set_Restriction (R_Id, N, Warn);\n \n-               --  If real restriction case, then set it and make sure that the\n-               --  restriction warning flag is off, since a real restriction\n-               --  always overrides a warning.\n+               if R_Id = No_Dynamic_CPU_Assignment\n+                 or else R_Id = No_Tasks_Unassigned_To_CPU\n+               then\n+                  --  These imply No_Dependence =>\n+                  --     \"System.Multiprocessors.Dispatching_Domains\".\n+                  --  This is not strictly what the AI says, but it eliminates\n+                  --  the need for run-time checks, which are undesirable in\n+                  --  this context.\n \n-               else\n-                  Set_Restriction (R_Id, N);\n-                  Restriction_Warnings (R_Id) := False;\n+                  Set_Restriction_No_Dependence\n+                    (Sel_Comp\n+                       (Sel_Comp (\"system\", \"multiprocessors\", Loc),\n+                        \"dispatching_domains\"),\n+                     Warn);\n+               end if;\n+\n+               if R_Id = No_Tasks_Unassigned_To_CPU then\n+                  --  Likewise, imply No_Dynamic_CPU_Assignment\n+\n+                  Set_Restriction (No_Dynamic_CPU_Assignment, N, Warn);\n                end if;\n \n                --  Check for obsolescent restrictions in Ada 2005 mode\n@@ -10702,26 +10707,7 @@ package body Sem_Prag is\n                     (\"pragma ignored, value too large??\", Arg);\n                end if;\n \n-               --  Warning case. If the real restriction is active, then we\n-               --  ignore the request, since warning never overrides a real\n-               --  restriction. Otherwise we set the proper warning. Note that\n-               --  this circuit sets the warning again if it is already set,\n-               --  which is what we want, since the constant may have changed.\n-\n-               if Warn then\n-                  if not Restriction_Active (R_Id) then\n-                     Set_Restriction\n-                       (R_Id, N, Integer (UI_To_Int (Val)));\n-                     Restriction_Warnings (R_Id) := True;\n-                  end if;\n-\n-               --  Real restriction case, set restriction and make sure warning\n-               --  flag is off since real restriction always overrides warning.\n-\n-               else\n-                  Set_Restriction (R_Id, N, Integer (UI_To_Int (Val)));\n-                  Restriction_Warnings (R_Id) := False;\n-               end if;\n+               Set_Restriction (R_Id, N, Warn, Integer (UI_To_Int (Val)));\n             end if;\n \n             Next (Arg);\n@@ -11313,13 +11299,6 @@ package body Sem_Prag is\n             Error_Msg_String (1 .. Name_Len) := Name_Buffer (1 .. Name_Len);\n          end Set_Error_Msg_To_Profile_Name;\n \n-         --  Local variables\n-\n-         Nod     : Node_Id;\n-         Pref    : Node_Id;\n-         Pref_Id : Node_Id;\n-         Sel_Id  : Node_Id;\n-\n          Profile_Dispatching_Policy : Character;\n \n       --  Start of processing for Set_Ravenscar_Profile\n@@ -11391,72 +11370,41 @@ package body Sem_Prag is\n          --    No_Dependence => Ada.Calendar\n          --    No_Dependence => Ada.Task_Attributes\n          --  are already set by previous call to Set_Profile_Restrictions.\n+         --  Really???\n \n          --  Set the following restrictions which were added to Ada 2005:\n          --    No_Dependence => Ada.Execution_Time.Group_Budget\n          --    No_Dependence => Ada.Execution_Time.Timers\n \n          if Ada_Version >= Ada_2005 then\n-            Pref_Id := Make_Identifier (Loc, Name_Find (\"ada\"));\n-            Sel_Id  := Make_Identifier (Loc, Name_Find (\"execution_time\"));\n-\n-            Pref :=\n-              Make_Selected_Component\n-                (Sloc          => Loc,\n-                 Prefix        => Pref_Id,\n-                 Selector_Name => Sel_Id);\n-\n-            Sel_Id := Make_Identifier (Loc, Name_Find (\"group_budgets\"));\n-\n-            Nod :=\n-              Make_Selected_Component\n-                (Sloc          => Loc,\n-                 Prefix        => Pref,\n-                 Selector_Name => Sel_Id);\n-\n-            Set_Restriction_No_Dependence\n-              (Unit    => Nod,\n-               Warn    => Treat_Restrictions_As_Warnings,\n-               Profile => Ravenscar);\n-\n-            Sel_Id := Make_Identifier (Loc, Name_Find (\"timers\"));\n-\n-            Nod :=\n-              Make_Selected_Component\n-                (Sloc          => Loc,\n-                 Prefix        => Pref,\n-                 Selector_Name => Sel_Id);\n-\n-            Set_Restriction_No_Dependence\n-              (Unit    => Nod,\n-               Warn    => Treat_Restrictions_As_Warnings,\n-               Profile => Ravenscar);\n+            declare\n+               Execution_Time : constant Node_Id :=\n+                 Sel_Comp (\"ada\", \"execution_time\", Loc);\n+               Group_Budgets : constant Node_Id :=\n+                 Sel_Comp (Execution_Time, \"group_budgets\");\n+               Timers : constant Node_Id :=\n+                 Sel_Comp (Execution_Time, \"timers\");\n+            begin\n+               Set_Restriction_No_Dependence\n+                 (Unit    => Group_Budgets,\n+                  Warn    => Treat_Restrictions_As_Warnings,\n+                  Profile => Ravenscar);\n+               Set_Restriction_No_Dependence\n+                 (Unit    => Timers,\n+                  Warn    => Treat_Restrictions_As_Warnings,\n+                  Profile => Ravenscar);\n+            end;\n          end if;\n \n          --  Set the following restriction which was added to Ada 2012 (see\n          --  AI05-0171):\n          --    No_Dependence => System.Multiprocessors.Dispatching_Domains\n \n          if Ada_Version >= Ada_2012 then\n-            Pref_Id := Make_Identifier (Loc, Name_Find (\"system\"));\n-            Sel_Id  := Make_Identifier (Loc, Name_Find (\"multiprocessors\"));\n-\n-            Pref :=\n-              Make_Selected_Component\n-                (Sloc          => Loc,\n-                 Prefix        => Pref_Id,\n-                 Selector_Name => Sel_Id);\n-\n-            Sel_Id := Make_Identifier (Loc, Name_Find (\"dispatching_domains\"));\n-\n-            Nod :=\n-              Make_Selected_Component\n-                (Sloc          => Loc,\n-                 Prefix        => Pref,\n-                 Selector_Name => Sel_Id);\n-\n             Set_Restriction_No_Dependence\n-              (Unit    => Nod,\n+              (Sel_Comp\n+                 (Sel_Comp (\"system\", \"multiprocessors\", Loc),\n+                  \"dispatching_domains\"),\n                Warn    => Treat_Restrictions_As_Warnings,\n                Profile => Ravenscar);\n \n@@ -11468,18 +11416,8 @@ package body Sem_Prag is\n             --  in Ada2012 (AI05-0174).\n \n             if Profile /= Jorvik then\n-               Pref_Id := Make_Identifier (Loc, Name_Find (\"ada\"));\n-               Sel_Id  := Make_Identifier (Loc, Name_Find\n-                                                  (\"synchronous_barriers\"));\n-\n-               Nod :=\n-                 Make_Selected_Component\n-                   (Sloc          => Loc,\n-                    Prefix        => Pref_Id,\n-                    Selector_Name => Sel_Id);\n-\n                Set_Restriction_No_Dependence\n-                 (Unit    => Nod,\n+                 (Sel_Comp (\"ada\", \"synchronous_barriers\", Loc),\n                   Warn    => Treat_Restrictions_As_Warnings,\n                   Profile => Ravenscar);\n             end if;\n@@ -14916,7 +14854,13 @@ package body Sem_Prag is\n \n                Preanalyze_Spec_Expression (Arg, RTE (RE_CPU_Range));\n \n-               if not Is_OK_Static_Expression (Arg) then\n+               --  See comment in Sem_Ch13 about the following restrictions\n+\n+               if Is_OK_Static_Expression (Arg) then\n+                  if Expr_Value (Arg) = Uint_0 then\n+                     Check_Restriction (No_Tasks_Unassigned_To_CPU, N);\n+                  end if;\n+               else\n                   Check_Restriction (No_Dynamic_CPU_Assignment, N);\n                end if;\n "}, {"sha": "4feb3a23edb0169d91df66e368bb1339dd015baf", "filename": "gcc/ada/tbuild.adb", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Ftbuild.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Ftbuild.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Ftbuild.adb?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -797,6 +797,23 @@ package body Tbuild is\n       return Result;\n    end OK_Convert_To;\n \n+   --------------\n+   -- Sel_Comp --\n+   --------------\n+\n+   function Sel_Comp (Pre : Node_Id; Sel : String) return Node_Id is\n+   begin\n+      return Make_Selected_Component\n+        (Sloc          => Sloc (Pre),\n+         Prefix        => Pre,\n+         Selector_Name => Make_Identifier (Sloc (Pre), Name_Find (Sel)));\n+   end Sel_Comp;\n+\n+   function Sel_Comp (Pre, Sel : String; Loc : Source_Ptr) return Node_Id is\n+   begin\n+      return Sel_Comp (Make_Identifier (Loc, Name_Find (Pre)), Sel);\n+   end Sel_Comp;\n+\n    -------------\n    -- Set_NOD --\n    -------------"}, {"sha": "70bf653bd733959160812139833d86784e3fdc93", "filename": "gcc/ada/tbuild.ads", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Ftbuild.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47484baae5aa2c74f1b65547f4436baa040b2728/gcc%2Fada%2Ftbuild.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Ftbuild.ads?ref=47484baae5aa2c74f1b65547f4436baa040b2728", "patch": "@@ -335,6 +335,11 @@ package Tbuild is\n    --  fixed-point small is called typ_SMALL where typ is the name of the\n    --  fixed-point type (as passed in Related_Id), and Suffix is \"SMALL\".\n \n+   function Sel_Comp (Pre, Sel : String; Loc : Source_Ptr) return Node_Id;\n+   function Sel_Comp (Pre : Node_Id; Sel : String) return Node_Id;\n+   --  Create a selected component of the form Pre.Sel; that is, Pre is the\n+   --  prefix, and Sel is the selector name.\n+\n    function OK_Convert_To (Typ : Entity_Id; Expr : Node_Id) return Node_Id;\n    --  Like Convert_To, except that a conversion node is always generated, and\n    --  the Conversion_OK flag is set on this conversion node."}]}