{"sha": "c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzI2ZGZmZmY1YzU3M2FhN2YzOTM1ZGRkYzgzMDBhMmM4ZmQ2NjBhMQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2011-08-19T13:25:22Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2011-08-19T13:25:22Z"}, "message": "re PR fortran/49792 (OpenMP workshare: Wrong result with array assignment)\n\n\tPR fortran/49792\n\t* trans-expr.c (gfc_trans_assignment_1): Set OMPWS_SCALARIZER_WS\n\tbit in ompws_flags only if loop.temp_ss is NULL, and clear it if\n\tlhs needs reallocation.\n\t* trans-openmp.c (gfc_trans_omp_workshare): Don't return early if\n\tcode is NULL, emit a barrier if workshare emitted no code at all\n\tand NOWAIT clause isn't present.\n\n\t* testsuite/libgomp.fortran/pr49792-1.f90: New test.\n\t* testsuite/libgomp.fortran/pr49792-2.f90: New test.\n\nFrom-SVN: r177898", "tree": {"sha": "963ec6d00bf1bf89a14122150aae777bf1f6a55a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/963ec6d00bf1bf89a14122150aae777bf1f6a55a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "df698a8707413cc5ebaa2f5ad0007e011eae8418", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/df698a8707413cc5ebaa2f5ad0007e011eae8418", "html_url": "https://github.com/Rust-GCC/gccrs/commit/df698a8707413cc5ebaa2f5ad0007e011eae8418"}], "stats": {"total": 71, "additions": 64, "deletions": 7}, "files": [{"sha": "6b55546fc513493a8eee81cb4a73e387fb88b28c", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "patch": "@@ -1,3 +1,13 @@\n+2011-08-19  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/49792\n+\t* trans-expr.c (gfc_trans_assignment_1): Set OMPWS_SCALARIZER_WS\n+\tbit in ompws_flags only if loop.temp_ss is NULL, and clear it if\n+\tlhs needs reallocation.\n+\t* trans-openmp.c (gfc_trans_omp_workshare): Don't return early if\n+\tcode is NULL, emit a barrier if workshare emitted no code at all\n+\tand NOWAIT clause isn't present.\n+\n 2011-08-19  Mikael Morin  <mikael.morin@sfr.fr>\n \n \tPR fortran/50071"}, {"sha": "39ad0b6e9e1112b25561fa1e415f11b0dad3a98c", "filename": "gcc/fortran/trans-expr.c", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/gcc%2Ffortran%2Ftrans-expr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/gcc%2Ffortran%2Ftrans-expr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-expr.c?ref=c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "patch": "@@ -6137,10 +6137,6 @@ gfc_trans_assignment_1 (gfc_expr * expr1, gfc_expr * expr2, bool init_flag,\n   rss = NULL;\n   if (lss != gfc_ss_terminator)\n     {\n-      /* Allow the scalarizer to workshare array assignments.  */\n-      if (ompws_flags & OMPWS_WORKSHARE_FLAG)\n-\tompws_flags |= OMPWS_SCALARIZER_WS;\n-\n       /* The assignment needs scalarization.  */\n       lss_section = lss;\n \n@@ -6196,6 +6192,10 @@ gfc_trans_assignment_1 (gfc_expr * expr1, gfc_expr * expr2, bool init_flag,\n \t  gfc_mark_ss_chain_used (loop.temp_ss, 3);\n \t}\n \n+      /* Allow the scalarizer to workshare array assignments.  */\n+      if ((ompws_flags & OMPWS_WORKSHARE_FLAG) && loop.temp_ss == NULL)\n+\tompws_flags |= OMPWS_SCALARIZER_WS;\n+\n       /* Start the scalarized loop body.  */\n       gfc_start_scalarized_body (&loop, &body);\n     }\n@@ -6304,6 +6304,7 @@ gfc_trans_assignment_1 (gfc_expr * expr1, gfc_expr * expr2, bool init_flag,\n \t    && !gfc_expr_attr (expr1).codimension\n \t    && !gfc_is_coindexed (expr1))\n \t{\n+\t  ompws_flags &= ~OMPWS_SCALARIZER_WS;\n \t  tmp = gfc_alloc_allocatable_for_assignment (&loop, expr1, expr2);\n \t  if (tmp != NULL_TREE)\n \t    gfc_add_expr_to_block (&loop.code[expr1->rank - 1], tmp);"}, {"sha": "cfe8612dfc904fbf01beec0f51f502d4969a3085", "filename": "gcc/fortran/trans-openmp.c", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/gcc%2Ffortran%2Ftrans-openmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/gcc%2Ffortran%2Ftrans-openmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-openmp.c?ref=c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "patch": "@@ -1764,9 +1764,6 @@ gfc_trans_omp_workshare (gfc_code *code, gfc_omp_clauses *clauses)\n \n   pushlevel (0);\n \n-  if (!code)\n-    return build_empty_stmt (input_location);\n-\n   gfc_start_block (&block);\n   pblock = &block;\n \n@@ -1903,6 +1900,9 @@ gfc_trans_omp_workshare (gfc_code *code, gfc_omp_clauses *clauses)\n   else\n     poplevel (0, 0, 0);\n \n+  if (IS_EMPTY_STMT (stmt) && !clauses->nowait)\n+    stmt = gfc_trans_omp_barrier ();\n+\n   ompws_flags = 0;\n   return stmt;\n }"}, {"sha": "c5ebeb0b555ef5c54361a9d96a08db5ce7c799fb", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "patch": "@@ -1,3 +1,9 @@\n+2011-08-19  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/49792\n+\t* testsuite/libgomp.fortran/pr49792-1.f90: New test.\n+\t* testsuite/libgomp.fortran/pr49792-2.f90: New test.\n+\n 2011-08-08  Rainer Orth  <ro@CeBiTec.Uni-Bielefeld.DE>\n \n \t* config/posix95/lock.c, posix95/omp-lock.h: Remove."}, {"sha": "cf2bb66fc894b3dcbeea5a4979cea2c8d1346a4e", "filename": "libgomp/testsuite/libgomp.fortran/pr49792-1.f90", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr49792-1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr49792-1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr49792-1.f90?ref=c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "patch": "@@ -0,0 +1,18 @@\n+! PR fortran/49792\n+! { dg-do run }\n+\n+subroutine reverse(n, a)\n+  integer :: n\n+  real(kind=8) :: a(n)\n+!$omp parallel workshare\n+  a(:) = a(n:1:-1)\n+!$omp end parallel workshare\n+end subroutine reverse\n+\n+program pr49792\n+  real(kind=8) :: a(16) = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]\n+  real(kind=8) :: b(16)\n+  b(:) = a(16:1:-1)\n+  call reverse (16,a)\n+  if (any (a.ne.b)) call abort\n+end program pr49792"}, {"sha": "2101028a9c283f54b673feed83c6e4ab86bfebb2", "filename": "libgomp/testsuite/libgomp.fortran/pr49792-2.f90", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr49792-2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c26dffff5c573aa7f3935dddc8300a2c8fd660a1/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr49792-2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr49792-2.f90?ref=c26dffff5c573aa7f3935dddc8300a2c8fd660a1", "patch": "@@ -0,0 +1,22 @@\n+! PR fortran/49792\n+! { dg-do run }\n+! { dg-options \"-std=f2003 -fall-intrinsics\" }\n+\n+subroutine reverse(n, a)\n+  integer :: n\n+  real(kind=8) :: a(n)\n+!$omp parallel workshare\n+  a(:) = a(n:1:-1)\n+!$omp end parallel workshare\n+end subroutine reverse\n+\n+program pr49792\n+  integer :: b(16)\n+  integer, allocatable :: a(:)\n+  b = 1\n+!$omp parallel workshare\n+  a = b\n+!$omp end parallel workshare\n+  if (size(a).ne.size(b)) call abort()\n+  if (any (a.ne.b)) call abort()\n+end program pr49792"}]}