{"sha": "b393e5ede4064d6c2da289ed0b66b8e80e033c54", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjM5M2U1ZWRlNDA2NGQ2YzJkYTI4OWVkMGI2NmI4ZTgwZTAzM2M1NA==", "commit": {"author": {"name": "Iain Sandoe", "email": "iain@sandoe.co.uk", "date": "2019-10-07T20:21:50Z"}, "committer": {"name": "Iain Sandoe", "email": "iains@gcc.gnu.org", "date": "2019-10-07T20:21:50Z"}, "message": "[Darwin, machopic 1/n] Consider visibility in indirections.\n\nFor weak, hidden vars the indirection should just be as normal, that\nis that the indirections for such symbols should appear in the non-lazy\nsymbol pointers table, not in the .data section.\n\ngcc/ChangeLog:\n\n2019-10-07  Iain Sandoe  <iain@sandoe.co.uk>\n\n\t* config/darwin.c (machopic_output_indirection): Don't put\n\thidden symbol indirections into the .data section, use the\n\tnon-lazy symbol pointers section as normal.\n\t(darwin_encode_section_info): Record if a symbol is hidden.\n\t* config/darwin.h (MACHO_SYMBOL_FLAG_HIDDEN_VIS): New.\n\t(MACHO_SYMBOL_HIDDEN_VIS_P): New.\n\nFrom-SVN: r276675", "tree": {"sha": "7326f49dbe32842f47e93a6bb38ca358a6293717", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7326f49dbe32842f47e93a6bb38ca358a6293717"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b393e5ede4064d6c2da289ed0b66b8e80e033c54", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b393e5ede4064d6c2da289ed0b66b8e80e033c54", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b393e5ede4064d6c2da289ed0b66b8e80e033c54", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b393e5ede4064d6c2da289ed0b66b8e80e033c54/comments", "author": {"login": "iains", "id": 4039407, "node_id": "MDQ6VXNlcjQwMzk0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/4039407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iains", "html_url": "https://github.com/iains", "followers_url": "https://api.github.com/users/iains/followers", "following_url": "https://api.github.com/users/iains/following{/other_user}", "gists_url": "https://api.github.com/users/iains/gists{/gist_id}", "starred_url": "https://api.github.com/users/iains/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iains/subscriptions", "organizations_url": "https://api.github.com/users/iains/orgs", "repos_url": "https://api.github.com/users/iains/repos", "events_url": "https://api.github.com/users/iains/events{/privacy}", "received_events_url": "https://api.github.com/users/iains/received_events", "type": "User", "site_admin": false}, "committer": {"login": "iains", "id": 4039407, "node_id": "MDQ6VXNlcjQwMzk0MDc=", "avatar_url": "https://avatars.githubusercontent.com/u/4039407?v=4", "gravatar_id": "", "url": "https://api.github.com/users/iains", "html_url": "https://github.com/iains", "followers_url": "https://api.github.com/users/iains/followers", "following_url": "https://api.github.com/users/iains/following{/other_user}", "gists_url": "https://api.github.com/users/iains/gists{/gist_id}", "starred_url": "https://api.github.com/users/iains/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/iains/subscriptions", "organizations_url": "https://api.github.com/users/iains/orgs", "repos_url": "https://api.github.com/users/iains/repos", "events_url": "https://api.github.com/users/iains/events{/privacy}", "received_events_url": "https://api.github.com/users/iains/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2161a445d1c129bf2faa031bd862fa4fe3a4121b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2161a445d1c129bf2faa031bd862fa4fe3a4121b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2161a445d1c129bf2faa031bd862fa4fe3a4121b"}], "stats": {"total": 22, "additions": 22, "deletions": 0}, "files": [{"sha": "af5ac090810a07b8698f6fc27741b16ab2b52b50", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b393e5ede4064d6c2da289ed0b66b8e80e033c54/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b393e5ede4064d6c2da289ed0b66b8e80e033c54/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=b393e5ede4064d6c2da289ed0b66b8e80e033c54", "patch": "@@ -1,3 +1,12 @@\n+2019-10-07  Iain Sandoe  <iain@sandoe.co.uk>\n+\n+\t* config/darwin.c (machopic_output_indirection): Don't put\n+\thidden symbol indirections into the .data section, use the\n+\tnon-lazy symbol pointers section as normal.\n+\t(darwin_encode_section_info): Record if a symbol is hidden.\n+\t* config/darwin.h (MACHO_SYMBOL_FLAG_HIDDEN_VIS): New.\n+\t(MACHO_SYMBOL_HIDDEN_VIS_P): New.\n+\n 2019-10-07  Iain Sandoe  <iain@sandoe.co.uk>\n \n \t* config/darwin.c (machopic_symbol_defined_p): Use symbol flag"}, {"sha": "869e850c5753a642b108def4053ebe93cbe35c80", "filename": "gcc/config/darwin.c", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b393e5ede4064d6c2da289ed0b66b8e80e033c54/gcc%2Fconfig%2Fdarwin.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b393e5ede4064d6c2da289ed0b66b8e80e033c54/gcc%2Fconfig%2Fdarwin.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.c?ref=b393e5ede4064d6c2da289ed0b66b8e80e033c54", "patch": "@@ -1120,6 +1120,7 @@ machopic_output_indirection (machopic_indirection **slot, FILE *asm_out_file)\n       machopic_output_stub (asm_out_file, sym, stub);\n     }\n   else if (! indirect_data (symbol)\n+\t   && ! MACHO_SYMBOL_HIDDEN_VIS_P (symbol)\n \t   && (machopic_symbol_defined_p (symbol)\n \t       || SYMBOL_REF_LOCAL_P (symbol)))\n     {\n@@ -1237,6 +1238,12 @@ darwin_encode_section_info (tree decl, rtx rtl, int first)\n   if (VAR_P (decl))\n     SYMBOL_REF_FLAGS (sym_ref) |= MACHO_SYMBOL_FLAG_VARIABLE;\n \n+  /* For Darwin, if we have specified visibility and it's not the default\n+     that's counted 'hidden'.  */\n+  if (DECL_VISIBILITY_SPECIFIED (decl)\n+      && DECL_VISIBILITY (decl) != VISIBILITY_DEFAULT)\n+     SYMBOL_REF_FLAGS (sym_ref) |= MACHO_SYMBOL_FLAG_HIDDEN_VIS;\n+\n   if (!DECL_EXTERNAL (decl)\n       && (!TREE_PUBLIC (decl) || !DECL_WEAK (decl))\n       && ! lookup_attribute (\"weakref\", DECL_ATTRIBUTES (decl))"}, {"sha": "87e1eb63b1c9531f2ab98f9c6244e1c39925c4f3", "filename": "gcc/config/darwin.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b393e5ede4064d6c2da289ed0b66b8e80e033c54/gcc%2Fconfig%2Fdarwin.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b393e5ede4064d6c2da289ed0b66b8e80e033c54/gcc%2Fconfig%2Fdarwin.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fdarwin.h?ref=b393e5ede4064d6c2da289ed0b66b8e80e033c54", "patch": "@@ -828,6 +828,12 @@ extern GTY(()) section * darwin_sections[NUM_DARWIN_SECTIONS];\n #define MACHO_SYMBOL_DEFINED_P(RTX) \\\n   ((SYMBOL_REF_FLAGS (RTX) & MACHO_SYMBOL_FLAG_DEFINED) != 0)\n \n+/* Set on a symbol that has specified non-default visibility.  */\n+\n+#define MACHO_SYMBOL_FLAG_HIDDEN_VIS ((SYMBOL_FLAG_SUBT_DEP) << 3)\n+#define MACHO_SYMBOL_HIDDEN_VIS_P(RTX) \\\n+  ((SYMBOL_REF_FLAGS (RTX) & MACHO_SYMBOL_FLAG_HIDDEN_VIS) != 0)\n+\n /* Set on a symbol to indicate when fix-and-continue style code\n    generation is being used and the symbol refers to a static symbol\n    that should be rebound from new instances of a translation unit to"}]}