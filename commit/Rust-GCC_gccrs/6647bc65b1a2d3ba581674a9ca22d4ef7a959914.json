{"sha": "6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjY0N2JjNjViMWEyZDNiYTU4MTY3NGE5Y2EyMmQ0ZWY3YTk1OTkxNA==", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-27T14:39:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-27T14:39:54Z"}, "message": "Merge #394\n\n394: Partial substitions of generic data types r=philberty a=philberty\n\nHandle the case where we have a generic type:\r\n\r\n```rust\r\nstruct Foo<A,B>(A,B);\r\n\r\nimpl<T> Foo<i32, T> { ... }\r\n```\r\n\r\nIn this case the impl block only defines 1 type parameter but the generic datatype has two type parameters.\r\n\r\nFixes #386 \n\nCo-authored-by: Philip Herron <philip.herron@embecosm.com>", "tree": {"sha": "73d105263d6fbf23eea1ea94a97af950eaf9bb03", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/73d105263d6fbf23eea1ea94a97af950eaf9bb03"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgiCI6CRBK7hj4Ov3rIwAAcnIIAC1E4FT15C0dnKxXMOkKLGzr\n1jSaQ+yaENMwWqWXnhLORSCCXMGVBR/4va3uqaP83bqw4E78O0d6nygpkpHA/dVy\nNpnyYjzRI4tILo/rMB8lY07qDlFDPugZPbYUqIQ8qludcI6rp1oGVjSoMmCY9AUS\nNciTptY4ZzY2qxrL0EUazb7E/kOgwBmVTLBeQyHyWpkSru046LH0u08c+knep1bu\nHVsUNWyOC+CX0LTwC2HU0RvbtU4+lyH5M+ExEI+cSU7+DKUYbIF08s8sH+VIW6d0\nR+DlNQxFLOg7qX4r0XM71M/XJJ6b7RkawiYNEl6w/4hH8YRYsP1mua3I12W0yUQ=\n=fS3R\n-----END PGP SIGNATURE-----\n", "payload": "tree 73d105263d6fbf23eea1ea94a97af950eaf9bb03\nparent a24a14371b16c316a815a9440b1d960cd3f885dd\nparent 3df65d5b4ec06c7ac1ec39d8d1a1c268b024531c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1619534394 +0000\ncommitter GitHub <noreply@github.com> 1619534394 +0000\n\nMerge #394\n\n394: Partial substitions of generic data types r=philberty a=philberty\n\nHandle the case where we have a generic type:\r\n\r\n```rust\r\nstruct Foo<A,B>(A,B);\r\n\r\nimpl<T> Foo<i32, T> { ... }\r\n```\r\n\r\nIn this case the impl block only defines 1 type parameter but the generic datatype has two type parameters.\r\n\r\nFixes #386 \n\nCo-authored-by: Philip Herron <philip.herron@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a24a14371b16c316a815a9440b1d960cd3f885dd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a24a14371b16c316a815a9440b1d960cd3f885dd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a24a14371b16c316a815a9440b1d960cd3f885dd"}, {"sha": "3df65d5b4ec06c7ac1ec39d8d1a1c268b024531c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3df65d5b4ec06c7ac1ec39d8d1a1c268b024531c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3df65d5b4ec06c7ac1ec39d8d1a1c268b024531c"}], "stats": {"total": 96, "additions": 82, "deletions": 14}, "files": [{"sha": "5dafd64f04e3ebad2defd3aed167264bc2a4d5cc", "filename": "gcc/rust/typecheck/rust-hir-type-check-expr.h", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-expr.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-expr.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-expr.h?ref=6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "patch": "@@ -811,8 +811,15 @@ class TypeCheckExpr : public TypeCheckBase\n     else if (expr.get_num_segments () == 1)\n       {\n \tLocation locus = expr.get_segments ().back ().get_locus ();\n-\tif (tyseg->needs_generic_substitutions ())\n-\t  tyseg = SubstMapper::InferSubst (tyseg, locus);\n+\n+\tbool is_big_self\n+\t  = expr.get_segments ().front ().get_segment ().as_string ().compare (\n+\t      \"Self\")\n+\t    == 0;\n+\tif (!is_big_self && tyseg->needs_generic_substitutions ())\n+\t  {\n+\t    tyseg = SubstMapper::InferSubst (tyseg, locus);\n+\t  }\n \n \tinfered = tyseg;\n \treturn;"}, {"sha": "d022019d5b8e32303cc300dcff6b2b094bd29576", "filename": "gcc/rust/typecheck/rust-substitution-mapper.h", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-substitution-mapper.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-substitution-mapper.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-substitution-mapper.h?ref=6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "patch": "@@ -133,6 +133,8 @@ class SubstMapperInternal : public TyTy::TyVisitor\n   {\n     TyTy::SubstitutionArgumentMappings adjusted\n       = type.adjust_mappings_for_this (mappings);\n+    if (adjusted.is_error ())\n+      return;\n \n     TyTy::BaseType *concrete = type.handle_substitions (adjusted);\n     if (concrete != nullptr)\n@@ -143,6 +145,8 @@ class SubstMapperInternal : public TyTy::TyVisitor\n   {\n     TyTy::SubstitutionArgumentMappings adjusted\n       = type.adjust_mappings_for_this (mappings);\n+    if (adjusted.is_error ())\n+      return;\n \n     TyTy::BaseType *concrete = type.handle_substitions (adjusted);\n     if (concrete != nullptr)"}, {"sha": "8cc9089d5a880f74afc630b8b8234abaac1be73e", "filename": "gcc/rust/typecheck/rust-tyty.cc", "status": "modified", "additions": 23, "deletions": 12, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.cc?ref=6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "patch": "@@ -242,15 +242,6 @@ SubstitutionArgumentMappings\n SubstitutionRef::adjust_mappings_for_this (\n   SubstitutionArgumentMappings &mappings)\n {\n-  if (substitutions.size () > mappings.size ())\n-    {\n-      rust_error_at (mappings.get_locus (),\n-\t\t     \"not enough type arguments: subs %s vs mappings %s\",\n-\t\t     subst_as_string ().c_str (),\n-\t\t     mappings.as_string ().c_str ());\n-      return SubstitutionArgumentMappings::error ();\n-    }\n-\n   Analysis::Mappings *mappings_table = Analysis::Mappings::get ();\n \n   std::vector<SubstitutionArg> resolved_mappings;\n@@ -259,13 +250,33 @@ SubstitutionRef::adjust_mappings_for_this (\n       auto &subst = substitutions.at (i);\n \n       SubstitutionArg arg = SubstitutionArg::error ();\n-      bool ok = mappings.get_argument_at (0, &arg);\n+      if (mappings.size () == substitutions.size ())\n+\t{\n+\t  mappings.get_argument_at (i, &arg);\n+\t}\n+      else\n+\t{\n+\t  if (subst.needs_substitution ())\n+\t    {\n+\t      // get from passed in mappings\n+\t      mappings.get_argument_for_symbol (subst.get_param_ty (), &arg);\n+\t    }\n+\t  else\n+\t    {\n+\t      // we should already have this somewhere\n+\t      used_arguments.get_argument_for_symbol (subst.get_param_ty (),\n+\t\t\t\t\t\t      &arg);\n+\t    }\n+\t}\n+\n+      bool ok = !arg.is_error ();\n       if (!ok)\n \t{\n \t  rust_error_at (mappings_table->lookup_location (\n \t\t\t   subst.get_param_ty ()->get_ref ()),\n-\t\t\t \"failed to find parameter type: %s\",\n-\t\t\t subst.get_param_ty ()->as_string ().c_str ());\n+\t\t\t \"failed to find parameter type: %s vs mappings [%s]\",\n+\t\t\t subst.get_param_ty ()->as_string ().c_str (),\n+\t\t\t mappings.as_string ().c_str ());\n \t  return SubstitutionArgumentMappings::error ();\n \t}\n "}, {"sha": "f3ff60968aabdfb19a573848484c150c7eeeb711", "filename": "gcc/rust/typecheck/rust-tyty.h", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Frust%2Ftypecheck%2Frust-tyty.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-tyty.h?ref=6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "patch": "@@ -408,6 +408,15 @@ class SubstitutionParamMapping\n \n   void override_context ();\n \n+  bool needs_substitution () const\n+  {\n+    auto p = get_param_ty ();\n+    if (!p->can_resolve ())\n+      return true;\n+\n+    return p->resolve ()->get_kind () == TypeKind::PARAM;\n+  }\n+\n private:\n   std::unique_ptr<HIR::GenericParam> &generic;\n   ParamType *param;\n@@ -437,6 +446,8 @@ class SubstitutionArg\n \n   static SubstitutionArg error () { return SubstitutionArg (nullptr, nullptr); }\n \n+  bool is_error () const { return param == nullptr || argument == nullptr; }\n+\n   bool is_conrete () const\n   {\n     return argument != nullptr && argument->get_kind () != TyTy::TypeKind::ERROR\n@@ -600,6 +611,17 @@ class SubstitutionRef\n     return used_arguments;\n   }\n \n+  size_t num_required_substitutions () const\n+  {\n+    size_t n = 0;\n+    for (auto &p : substitutions)\n+      {\n+\tif (p.needs_substitution ())\n+\t  n++;\n+      }\n+    return n;\n+  }\n+\n   // We are trying to subst <i32, f32> into Struct Foo<X,Y> {}\n   // in the case of Foo<i32,f32>{...}\n   //"}, {"sha": "9a5b4cb48dc8e19b4c4434b5ac76505d16492f2c", "filename": "gcc/testsuite/rust.test/compile/generics19.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fgenerics19.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fgenerics19.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fgenerics19.rs?ref=6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "patch": "@@ -0,0 +1,12 @@\n+struct Foo<X, Y>(X, Y);\n+\n+impl<T> Foo<u32, T> {\n+    fn new(a: T) -> Self {\n+        Self(123, a)\n+    }\n+}\n+\n+fn main() {\n+    let a;\n+    a = Foo::new(false);\n+}"}, {"sha": "8fe1cffdf7dadd8b3628e8a6e53308ae92dacd35", "filename": "gcc/testsuite/rust.test/compile/generics20.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fgenerics20.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6647bc65b1a2d3ba581674a9ca22d4ef7a959914/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fgenerics20.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust.test%2Fcompile%2Fgenerics20.rs?ref=6647bc65b1a2d3ba581674a9ca22d4ef7a959914", "patch": "@@ -0,0 +1,12 @@\n+struct Foo<A, B>(A, B);\n+\n+impl<T> Foo<T, T> {\n+    fn new(a: T, b: T) -> Self {\n+        Self(a, b)\n+    }\n+}\n+\n+fn main() {\n+    let a;\n+    a = Foo::new(123, 456);\n+}"}]}