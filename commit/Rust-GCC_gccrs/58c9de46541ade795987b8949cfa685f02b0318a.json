{"sha": "58c9de46541ade795987b8949cfa685f02b0318a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NThjOWRlNDY1NDFhZGU3OTU5ODdiODk0OWNmYTY4NWYwMmIwMzE4YQ==", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2020-11-05T17:19:07Z"}, "committer": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2020-11-05T17:19:07Z"}, "message": "Add fnspecs for C++ new and delete operators\n\ngcc/ChangeLog:\n\n\t* gimple.c (gimple_call_fnspec): Handle C++ new and delete.\n\t* gimple.h (gimple_call_from_new_or_delete): Constify parameter.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/ipa/devirt-24.C: Update template.", "tree": {"sha": "611f10a41c0cdb8c0d952d3f4e210334748e4837", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/611f10a41c0cdb8c0d952d3f4e210334748e4837"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/58c9de46541ade795987b8949cfa685f02b0318a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/58c9de46541ade795987b8949cfa685f02b0318a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/58c9de46541ade795987b8949cfa685f02b0318a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/58c9de46541ade795987b8949cfa685f02b0318a/comments", "author": null, "committer": null, "parents": [{"sha": "9f87fcf3034d0e774c4dee380f9113d1453e0e72", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9f87fcf3034d0e774c4dee380f9113d1453e0e72", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9f87fcf3034d0e774c4dee380f9113d1453e0e72"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "1afed88e1f1311456894c341f562798c62378af3", "filename": "gcc/gimple.c", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/58c9de46541ade795987b8949cfa685f02b0318a/gcc%2Fgimple.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/58c9de46541ade795987b8949cfa685f02b0318a/gcc%2Fgimple.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple.c?ref=58c9de46541ade795987b8949cfa685f02b0318a", "patch": "@@ -1510,6 +1510,19 @@ gimple_call_fnspec (const gcall *stmt)\n     }\n   if (gimple_call_builtin_p (stmt, BUILT_IN_NORMAL))\n     return builtin_fnspec (gimple_call_fndecl (stmt));\n+  tree fndecl = gimple_call_fndecl (stmt);\n+  /* If the call is to a replaceable operator delete and results\n+     from a delete expression as opposed to a direct call to\n+     such operator, then we can treat it as free.  */\n+  if (fndecl\n+      && DECL_IS_OPERATOR_DELETE_P (fndecl)\n+      && gimple_call_from_new_or_delete (stmt))\n+    return \".co \";\n+  /* Similarly operator new can be treated as malloc.  */\n+  if (fndecl\n+      && DECL_IS_OPERATOR_NEW_P (fndecl)\n+      && gimple_call_from_new_or_delete (stmt))\n+    return \"mC\";\n   return \"\";\n }\n "}, {"sha": "62b5a8a6124f5d2e288547f33514e03c1386dd3b", "filename": "gcc/gimple.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/58c9de46541ade795987b8949cfa685f02b0318a/gcc%2Fgimple.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/58c9de46541ade795987b8949cfa685f02b0318a/gcc%2Fgimple.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple.h?ref=58c9de46541ade795987b8949cfa685f02b0318a", "patch": "@@ -3405,7 +3405,7 @@ gimple_call_set_from_new_or_delete (gcall *s, bool from_new_or_delete_p)\n    from a new or delete expression.  */\n \n static inline bool\n-gimple_call_from_new_or_delete (gcall *s)\n+gimple_call_from_new_or_delete (const gcall *s)\n {\n   return (s->subcode & GF_CALL_FROM_NEW_OR_DELETE) != 0;\n }"}, {"sha": "7b5b806dd05fdf113532197e1654fd14a6c9468b", "filename": "gcc/testsuite/g++.dg/ipa/devirt-24.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/58c9de46541ade795987b8949cfa685f02b0318a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fdevirt-24.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/58c9de46541ade795987b8949cfa685f02b0318a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fdevirt-24.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fipa%2Fdevirt-24.C?ref=58c9de46541ade795987b8949cfa685f02b0318a", "patch": "@@ -37,4 +37,4 @@ C *b = new (C);\n   }\n }\n /* { dg-final { scan-ipa-dump-times \"Discovered a virtual call to a known target\" 1 \"inline\" { xfail *-*-* } } } */\n-/* { dg-final { scan-ipa-dump-times \"Aggregate passed by reference\" 1 \"cp\"  } } */\n+/* { dg-final { scan-ipa-dump-times \"Aggregate passed by reference\" 2 \"cp\"  } } */"}]}