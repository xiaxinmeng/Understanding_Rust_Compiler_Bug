{"sha": "f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjY4ZDMzNDQzZWM2N2QwYjBjMmEyOGYwNGYzYzkwYjI4ZDIyYjVkNA==", "commit": {"author": {"name": "Justin Squirek", "email": "squirek@adacore.com", "date": "2017-01-06T11:07:56Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2017-01-06T11:07:56Z"}, "message": "exp_attr.adb (Expand_N_Attribute_Reference): Add entry for expansion of Finalization_Size attribute.\n\n2017-01-06  Justin Squirek  <squirek@adacore.com>\n\n\t* exp_attr.adb (Expand_N_Attribute_Reference): Add entry for\n\texpansion of Finalization_Size attribute.\n\t* sem_attr.adb (Analyze_Attribute): Add entry to check the\n\tsemantics of Finalization_Size.\n\t(Eval_Attribute): Add null entry for Finalization_Size.\n\t* sem_attr.ads: Add Finalization_Size to the implementation\n\tdependent attribute list.\n\t* snames.ads-tmpl: Add name entry for Finalization_Size attribute.\n\nFrom-SVN: r244134", "tree": {"sha": "90299bd1f90cfe92f0698b7d86b10f0ec7979c0d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/90299bd1f90cfe92f0698b7d86b10f0ec7979c0d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/comments", "author": {"login": "AdaDoom3", "id": 3445599, "node_id": "MDQ6VXNlcjM0NDU1OTk=", "avatar_url": "https://avatars.githubusercontent.com/u/3445599?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AdaDoom3", "html_url": "https://github.com/AdaDoom3", "followers_url": "https://api.github.com/users/AdaDoom3/followers", "following_url": "https://api.github.com/users/AdaDoom3/following{/other_user}", "gists_url": "https://api.github.com/users/AdaDoom3/gists{/gist_id}", "starred_url": "https://api.github.com/users/AdaDoom3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AdaDoom3/subscriptions", "organizations_url": "https://api.github.com/users/AdaDoom3/orgs", "repos_url": "https://api.github.com/users/AdaDoom3/repos", "events_url": "https://api.github.com/users/AdaDoom3/events{/privacy}", "received_events_url": "https://api.github.com/users/AdaDoom3/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "e11b776b63c214d3e0792fa49ca2153df64d11d9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e11b776b63c214d3e0792fa49ca2153df64d11d9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e11b776b63c214d3e0792fa49ca2153df64d11d9"}], "stats": {"total": 153, "additions": 152, "deletions": 1}, "files": [{"sha": "25f1dfcdbaa4cb4084ff5dd84e579e4ea4a77b87", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "patch": "@@ -1,3 +1,14 @@\n+2017-01-06  Justin Squirek  <squirek@adacore.com>\n+\n+\t* exp_attr.adb (Expand_N_Attribute_Reference): Add entry for\n+\texpansion of Finalization_Size attribute.\n+\t* sem_attr.adb (Analyze_Attribute): Add entry to check the\n+\tsemantics of Finalization_Size.\n+\t(Eval_Attribute): Add null entry for Finalization_Size.\n+\t* sem_attr.ads: Add Finalization_Size to the implementation\n+\tdependent attribute list.\n+\t* snames.ads-tmpl: Add name entry for Finalization_Size attribute.\n+\n 2017-01-06  Ed Schonberg  <schonberg@adacore.com>\n \n \t* sem_ch5.adb (Analyze_Loop_Statement): If the loop includes an"}, {"sha": "ddc48613e5b3ed8ef5c54eab401bf36cd9c72076", "filename": "gcc/ada/exp_attr.adb", "status": "modified", "additions": 111, "deletions": 0, "changes": 111, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fexp_attr.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fexp_attr.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_attr.adb?ref=f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "patch": "@@ -3136,6 +3136,117 @@ package body Exp_Attr is\n          Analyze_And_Resolve (N, Standard_String);\n       end External_Tag;\n \n+      -----------------------\n+      -- Finalization_Size --\n+      -----------------------\n+\n+      when Attribute_Finalization_Size => Finalization_Size : declare\n+\n+         function Calculate_Header_Size return Node_Id;\n+         --  Generate a runtime call to calculate the size of the hidden\n+         --  header along with any added padding which would precede a\n+         --  heap-allocated object of the prefix type.\n+\n+         ---------------------------\n+         -- Calculate_Header_Size --\n+         ---------------------------\n+\n+         function Calculate_Header_Size return Node_Id is\n+         begin\n+            --  Generate:\n+            --    Universal_Integer\n+            --      (Header_Size_With_Padding (N'Alignment))\n+\n+            return\n+              Convert_To (Universal_Integer,\n+                Make_Function_Call (Loc,\n+                  Name                   =>\n+                    New_Occurrence_Of\n+                      (RTE (RE_Header_Size_With_Padding), Loc),\n+                  Parameter_Associations => New_List (\n+                    Make_Attribute_Reference (Loc,\n+                      Prefix         =>\n+                        New_Copy_Tree (Pref),\n+                      Attribute_Name => Name_Alignment))));\n+         end Calculate_Header_Size;\n+\n+      --  Local variables\n+\n+         Size : constant Entity_Id := Make_Temporary (Loc, 'S');\n+\n+      --  Start of Finalization_Size\n+\n+      begin\n+         --  An object of a class-wide type requires a runtime check to\n+         --  determine whether it is actually controlled or not. Depending on\n+         --  the outcome of this check, the Finalization_Size of the object\n+         --  may be zero or some positive value.\n+         --\n+         --  In this scenario, Obj'Finalization_Size is expanded into\n+         --\n+         --   Size : Integer := 0;\n+         --\n+         --   if Needs_Finalization (Pref'Tag) then\n+         --      Size :=\n+         --        Universal_Integer\n+         --          (Header_Size_With_Padding (Pref'Alignment));\n+         --  end if;\n+         --\n+         --  and the attribute reference is replaced with a reference to Size.\n+\n+         if Is_Class_Wide_Type (Ptyp) then\n+            Insert_Actions (N, New_List (\n+\n+              --  Generate:\n+              --    Size : Integer := 0;\n+\n+              Make_Object_Declaration (Loc,\n+                Defining_Identifier => Size,\n+                Object_Definition   =>\n+                  New_Occurrence_Of (Standard_Integer, Loc),\n+                Expression          => Make_Integer_Literal (Loc, 0)),\n+\n+              --  Generate:\n+              --    if Needs_Finalization (Pref'Tag) then\n+              --       Size := Universal_Integer\n+              --                 (Header_Size_With_Padding (Pref'Alignment));\n+              --    end if;\n+\n+              Make_If_Statement (Loc,\n+                Condition              =>\n+                  Make_Function_Call (Loc,\n+                    Name                   =>\n+                      New_Occurrence_Of\n+                        (RTE (RE_Needs_Finalization), Loc),\n+                    Parameter_Associations => New_List (\n+                      Make_Attribute_Reference (Loc,\n+                        Attribute_Name => Name_Tag,\n+                        Prefix         =>\n+                          New_Copy_Tree (Pref)))),\n+                Then_Statements        => New_List (\n+                   Make_Assignment_Statement (Loc,\n+                     Name       => New_Occurrence_Of (Size, Loc),\n+                     Expression => Calculate_Header_Size)))));\n+\n+            Rewrite (N, New_Occurrence_Of (Size, Loc));\n+\n+         --  The the prefix is known to be controlled at compile time.\n+         --  Calculate its Finalization_Size by calling runtime routine\n+         --  Header_Size_With_Padding.\n+\n+         elsif Needs_Finalization (Ptyp) then\n+            Rewrite (N, Calculate_Header_Size);\n+\n+         --  The prefix is not a controlled object, its Finalization_Size\n+         --  is zero.\n+\n+         else\n+            Rewrite (N, Make_Integer_Literal (Loc, 0));\n+         end if;\n+\n+         Analyze (N);\n+      end Finalization_Size;\n+\n       -----------\n       -- First --\n       -----------"}, {"sha": "db2f23d18c4a2bb7af33aac74289f24890d3caa9", "filename": "gcc/ada/sem_attr.adb", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fsem_attr.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fsem_attr.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_attr.adb?ref=f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "patch": "@@ -3833,6 +3833,16 @@ package body Sem_Attr is\n          Check_Standard_Prefix;\n          Rewrite (N, New_Occurrence_Of (Boolean_Literals (Fast_Math), Loc));\n \n+      -----------------------\n+      -- Finalization_Size --\n+      -----------------------\n+\n+      when Attribute_Finalization_Size =>\n+         Check_E0;\n+         Analyze_And_Resolve (P);\n+         Check_Object_Reference (P);\n+         Set_Etype (N, Universal_Integer);\n+\n       -----------\n       -- First --\n       -----------\n@@ -8398,6 +8408,13 @@ package body Sem_Attr is\n          Fold_Uint (N,\n            Eval_Fat.Exponent (P_Base_Type, Expr_Value_R (E1)), Static);\n \n+      -----------------------\n+      -- Finalization_Size --\n+      -----------------------\n+\n+      when Attribute_Finalization_Size =>\n+         null;\n+\n       -----------\n       -- First --\n       -----------"}, {"sha": "2c480f5c9af1996e3224a873d7a54141ec245879", "filename": "gcc/ada/sem_attr.ads", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fsem_attr.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fsem_attr.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_attr.ads?ref=f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 1992-2015, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2016, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -242,6 +242,16 @@ package Sem_Attr is\n       --  enumeration value. Constraint_Error is raised if no value of the\n       --  enumeration type corresponds to the given integer value.\n \n+      -----------------------\n+      -- Finalization_Size --\n+      -----------------------\n+\n+      Attribute_Finalization_Size => True,\n+      --  For every object, Finalization_Size will return the size of the\n+      --  internal header required for finalization (including padding). If\n+      --  the type is not controlled or contains no controlled components\n+      --  then the result is always zero.\n+\n       -----------------\n       -- Fixed_Value --\n       -----------------"}, {"sha": "d33b97a34fdb12f972ba3662416475d5b54a668e", "filename": "gcc/ada/snames.ads-tmpl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fsnames.ads-tmpl", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4/gcc%2Fada%2Fsnames.ads-tmpl", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsnames.ads-tmpl?ref=f68d33443ec67d0b0c2a28f04f3c90b28d22b5d4", "patch": "@@ -885,6 +885,7 @@ package Snames is\n    Name_Exponent                       : constant Name_Id := N + $;\n    Name_External_Tag                   : constant Name_Id := N + $;\n    Name_Fast_Math                      : constant Name_Id := N + $; -- GNAT\n+   Name_Finalization_Size              : constant Name_Id := N + $; -- GNAT\n    Name_First                          : constant Name_Id := N + $;\n    Name_First_Bit                      : constant Name_Id := N + $;\n    Name_First_Valid                    : constant Name_Id := N + $; -- Ada 12\n@@ -1524,6 +1525,7 @@ package Snames is\n       Attribute_Exponent,\n       Attribute_External_Tag,\n       Attribute_Fast_Math,\n+      Attribute_Finalization_Size,\n       Attribute_First,\n       Attribute_First_Bit,\n       Attribute_First_Valid,"}]}