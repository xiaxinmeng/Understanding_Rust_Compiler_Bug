{"sha": "32633ec815b4d741a9a4b1b75de235844f6d691c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzI2MzNlYzgxNWI0ZDc0MWE5YTRiMWI3NWRlMjM1ODQ0ZjZkNjkxYw==", "commit": {"author": {"name": "Feng Xue", "email": "fxue@os.amperecomputing.com", "date": "2020-01-24T15:09:28Z"}, "committer": {"name": "Feng Xue", "email": "fxue@os.amperecomputing.com", "date": "2020-06-01T06:10:04Z"}, "message": "Fix missed IPA-CP on by-ref argument directly passed through (PR 93429)\n\n2020-06-01  Feng Xue  <fxue@os.amperecomputing.com>\n\ngcc/\n\tPR ipa/93429\n\t* ipa-cp.c (propagate_aggs_across_jump_function): Check aggregate\n\tlattice for simple pass-through by-ref argument.\n\ngcc/testsuite/\n\tPR ipa/93429\n\t* gcc.dg/ipa/ipcp-agg-8.c: Change dump string.\n\t* gcc.dg/ipa/ipcp-agg-13.c: New test.", "tree": {"sha": "a4bef1e46c28cb3795065c55562f3534a956682b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a4bef1e46c28cb3795065c55562f3534a956682b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/32633ec815b4d741a9a4b1b75de235844f6d691c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32633ec815b4d741a9a4b1b75de235844f6d691c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/32633ec815b4d741a9a4b1b75de235844f6d691c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32633ec815b4d741a9a4b1b75de235844f6d691c/comments", "author": {"login": "feng-xue-ampere", "id": 95893536, "node_id": "U_kgDOBbc4IA", "avatar_url": "https://avatars.githubusercontent.com/u/95893536?v=4", "gravatar_id": "", "url": "https://api.github.com/users/feng-xue-ampere", "html_url": "https://github.com/feng-xue-ampere", "followers_url": "https://api.github.com/users/feng-xue-ampere/followers", "following_url": "https://api.github.com/users/feng-xue-ampere/following{/other_user}", "gists_url": "https://api.github.com/users/feng-xue-ampere/gists{/gist_id}", "starred_url": "https://api.github.com/users/feng-xue-ampere/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/feng-xue-ampere/subscriptions", "organizations_url": "https://api.github.com/users/feng-xue-ampere/orgs", "repos_url": "https://api.github.com/users/feng-xue-ampere/repos", "events_url": "https://api.github.com/users/feng-xue-ampere/events{/privacy}", "received_events_url": "https://api.github.com/users/feng-xue-ampere/received_events", "type": "User", "site_admin": false}, "committer": {"login": "feng-xue-ampere", "id": 95893536, "node_id": "U_kgDOBbc4IA", "avatar_url": "https://avatars.githubusercontent.com/u/95893536?v=4", "gravatar_id": "", "url": "https://api.github.com/users/feng-xue-ampere", "html_url": "https://github.com/feng-xue-ampere", "followers_url": "https://api.github.com/users/feng-xue-ampere/followers", "following_url": "https://api.github.com/users/feng-xue-ampere/following{/other_user}", "gists_url": "https://api.github.com/users/feng-xue-ampere/gists{/gist_id}", "starred_url": "https://api.github.com/users/feng-xue-ampere/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/feng-xue-ampere/subscriptions", "organizations_url": "https://api.github.com/users/feng-xue-ampere/orgs", "repos_url": "https://api.github.com/users/feng-xue-ampere/repos", "events_url": "https://api.github.com/users/feng-xue-ampere/events{/privacy}", "received_events_url": "https://api.github.com/users/feng-xue-ampere/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7340ed74abf5f44b069210a9eb1283a2e515b15", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e7340ed74abf5f44b069210a9eb1283a2e515b15", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e7340ed74abf5f44b069210a9eb1283a2e515b15"}], "stats": {"total": 73, "additions": 57, "deletions": 16}, "files": [{"sha": "b0c8f40526002a7efebfa813ec181f144bb532e4", "filename": "gcc/ipa-cp.c", "status": "modified", "additions": 9, "deletions": 14, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32633ec815b4d741a9a4b1b75de235844f6d691c/gcc%2Fipa-cp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32633ec815b4d741a9a4b1b75de235844f6d691c/gcc%2Fipa-cp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-cp.c?ref=32633ec815b4d741a9a4b1b75de235844f6d691c", "patch": "@@ -2735,9 +2735,8 @@ propagate_aggs_across_jump_function (struct cgraph_edge *cs,\n \t  gcc_assert (!jfunc->agg.items);\n \t  ret |= merge_aggregate_lattices (cs, dest_plats, src_plats,\n \t\t\t\t\t   src_idx, 0);\n+\t  return ret;\n \t}\n-      else\n-\tret |= set_agg_lats_contain_variable (dest_plats);\n     }\n   else if (jfunc->type == IPA_JF_ANCESTOR\n \t   && ipa_get_jf_ancestor_agg_preserved (jfunc))\n@@ -2759,8 +2758,10 @@ propagate_aggs_across_jump_function (struct cgraph_edge *cs,\n \tret |= set_agg_lats_to_bottom (dest_plats);\n       else\n \tret |= set_agg_lats_contain_variable (dest_plats);\n+      return ret;\n     }\n-  else if (jfunc->agg.items)\n+\n+  if (jfunc->agg.items)\n     {\n       bool pre_existing = dest_plats->aggs != NULL;\n       struct ipcp_agg_lattice **aglat = &dest_plats->aggs;\n@@ -4988,11 +4989,7 @@ intersect_aggregates_with_edge (struct cgraph_edge *cs, int index,\n \t      else\n \t\tintersect_with_agg_replacements (cs->caller, src_idx,\n \t\t\t\t\t\t &inter, 0);\n-\t    }\n-\t  else\n-\t    {\n-\t      inter.release ();\n-\t      return vNULL;\n+\t      return inter;\n \t    }\n \t}\n       else\n@@ -5008,11 +5005,7 @@ intersect_aggregates_with_edge (struct cgraph_edge *cs, int index,\n \t\tinter = copy_plats_to_inter (src_plats, 0);\n \t      else\n \t\tintersect_with_plats (src_plats, &inter, 0);\n-\t    }\n-\t  else\n-\t    {\n-\t      inter.release ();\n-\t      return vNULL;\n+\t      return inter;\n \t    }\n \t}\n     }\n@@ -5043,8 +5036,10 @@ intersect_aggregates_with_edge (struct cgraph_edge *cs, int index,\n \t  else\n \t    intersect_with_plats (src_plats, &inter, delta);\n \t}\n+      return inter;\n     }\n-  else if (jfunc->agg.items)\n+\n+  if (jfunc->agg.items)\n     {\n       class ipa_node_params *caller_info = IPA_NODE_REF (cs->caller);\n       struct ipa_agg_value *item;"}, {"sha": "47e9e530aa919e372e4c69fc3dc702e6e5385f41", "filename": "gcc/testsuite/gcc.dg/ipa/ipcp-agg-13.c", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32633ec815b4d741a9a4b1b75de235844f6d691c/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipcp-agg-13.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32633ec815b4d741a9a4b1b75de235844f6d691c/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipcp-agg-13.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipcp-agg-13.c?ref=32633ec815b4d741a9a4b1b75de235844f6d691c", "patch": "@@ -0,0 +1,45 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O3 -fno-ipa-sra -fdump-ipa-cp --param ipa-cp-eval-threshold=1\" } */\n+\n+int data;\n+int fn();\n+\n+int __attribute__((noinline)) f1 (int *p)\n+{\n+  data = *p;\n+  fn ();\n+  return 0;\n+} \n+\n+int __attribute__((noinline)) f2 (int *p)\n+{\n+  *p = *p + 1;\n+  f1 (p);\n+  return 1;\n+}\n+\n+int __attribute__((noinline)) f3 (int a, int *p)\n+{\n+  *p = a - 2;\n+  f1 (p);\n+  return 1;\n+}\n+\n+int f4 ()\n+{\n+  int i;\n+\n+  for (i = 0; i < 100; i++)\n+    {\n+       int v = 2;\n+\n+       f2 (&v);\n+       f3 (6, &v);\n+    }\n+\n+  return 0;\n+}\n+\n+/* { dg-final { scan-ipa-dump \"Aggregate replacements: 0\\\\\\[0]=2\" \"cp\" } } */ \n+/* { dg-final { scan-ipa-dump \"Aggregate replacements: 0\\\\\\[0]=3\" \"cp\" } } */ \n+/* { dg-final { scan-ipa-dump \"Aggregate replacements: 0\\\\\\[0]=4\" \"cp\" } } */ "}, {"sha": "2d9c82f7310b0fd398d9c350690f7c7f8a3b7799", "filename": "gcc/testsuite/gcc.dg/ipa/ipcp-agg-8.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32633ec815b4d741a9a4b1b75de235844f6d691c/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipcp-agg-8.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32633ec815b4d741a9a4b1b75de235844f6d691c/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipcp-agg-8.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipcp-agg-8.c?ref=32633ec815b4d741a9a4b1b75de235844f6d691c", "patch": "@@ -1,5 +1,5 @@\n /* { dg-do compile } */\n-/* { dg-options \"-O3 -fno-ipa-sra -fdump-tree-optimized-slim\"  } */\n+/* { dg-options \"-O3 -fno-ipa-sra -fdump-ipa-cp\"  } */\n /* { dg-add-options bind_pic_locally } */\n \n struct S\n@@ -48,4 +48,5 @@ entry (int c)\n       foo (4, i, &s);\n     }\n }\n-/* { dg-final { scan-tree-dump \"->b;\" \"optimized\" } } */\n+/* { dg-final { scan-ipa-dump \"Aggregate replacements: 1\\\\\\[32]=64, 1\\\\\\[64]=32\" \"cp\" } } */\n+/* { dg-final { scan-ipa-dump \"Aggregate replacements: 1\\\\\\[32]=0\" \"cp\" } } */"}]}