{"sha": "778c15d3ca1d0ee026de67d56ad763a4a8ad302a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Nzc4YzE1ZDNjYTFkMGVlMDI2ZGU2N2Q1NmFkNzYzYTRhOGFkMzAyYQ==", "commit": {"author": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2020-08-12T07:31:25Z"}, "committer": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2020-08-12T07:31:25Z"}, "message": "x86_64: Use peephole2 to eliminate redundant moves.\n\nThe recent fix for mul_widen_cost revealed an interesting\nquirk of ira/reload register allocation on x86_64.  As shown in\nhttps://gcc.gnu.org/pipermail/gcc-patches/2020-August/551648.html\nfor gcc.target/i386/pr71321.c we generate the following code that\nperforms unnecessary register shuffling.\n\n        movl    $-51, %edx\n        movl    %edx, %eax\n        mulb    %dil\n\nVarious discussions in bugzilla seem to point to reload preferring\nnot to load constants directly into CLASS_LIKELY_SPILLED_P registers.\nWhatever the cause, one solution (workaround), that doesn't involve\nrewriting a register allocator, is to use peephole2 to spot this\nwierdness and eliminate it.  With this peephole2 the above three\ninstructions (from pr71321.c) are replaced with:\n\n        movl    $-51, %eax\n        mulb    %dil\n\n2020-08-12  Roger Sayle  <roger@nextmovesoftware.com>\n\t    Uro\u0161 Bizjak  <ubizjak@gmail.com>\n\ngcc/ChangeLog\n\t* config/i386/i386.md (peephole2): Reduce unnecessary\n\tregister shuffling produced by register allocation.", "tree": {"sha": "11c7e4a6020e9f73b7f57da90698a9ac0804fe8a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/11c7e4a6020e9f73b7f57da90698a9ac0804fe8a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/778c15d3ca1d0ee026de67d56ad763a4a8ad302a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/778c15d3ca1d0ee026de67d56ad763a4a8ad302a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/778c15d3ca1d0ee026de67d56ad763a4a8ad302a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/778c15d3ca1d0ee026de67d56ad763a4a8ad302a/comments", "author": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "82c4b78dbef6f03838e3040688c934360a09513f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82c4b78dbef6f03838e3040688c934360a09513f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/82c4b78dbef6f03838e3040688c934360a09513f"}], "stats": {"total": 10, "additions": 10, "deletions": 0}, "files": [{"sha": "f3799ac3e6f91db3c1ff8776761616fca06d05a7", "filename": "gcc/config/i386/i386.md", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/778c15d3ca1d0ee026de67d56ad763a4a8ad302a/gcc%2Fconfig%2Fi386%2Fi386.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/778c15d3ca1d0ee026de67d56ad763a4a8ad302a/gcc%2Fconfig%2Fi386%2Fi386.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.md?ref=778c15d3ca1d0ee026de67d56ad763a4a8ad302a", "patch": "@@ -18946,6 +18946,16 @@\n   operands[2] = gen_rtx_REG (GET_MODE (operands[0]), FLAGS_REG);\n   ix86_expand_clear (operands[1]);\n })\n+\n+;; Reload dislikes loading constants directly into class_likely_spilled\n+;; hard registers.  Try to tidy things up here.\n+(define_peephole2\n+  [(set (match_operand:SWI 0 \"general_reg_operand\")\n+\t(match_operand:SWI 1 \"x86_64_general_operand\"))\n+   (set (match_operand:SWI 2 \"general_reg_operand\")\n+\t(match_dup 0))]\n+  \"peep2_reg_dead_p (2, operands[0])\"\n+  [(set (match_dup 2) (match_dup 1))])\n \f\n ;; Misc patterns (?)\n "}]}