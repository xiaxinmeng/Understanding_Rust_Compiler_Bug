{"sha": "075116992690d6f29530a0a7f08cf2f7d5652a93", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDc1MTE2OTkyNjkwZDZmMjk1MzBhMGE3ZjA4Y2YyZjdkNTY1MmE5Mw==", "commit": {"author": {"name": "Gary Dismukes", "email": "dismukes@adacore.com", "date": "2020-01-08T22:36:43Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-06-03T10:01:36Z"}, "message": "[Ada] Unnesting problems with expansion of Loop_Entry attribute\n\n2020-06-03  Gary Dismukes  <dismukes@adacore.com>\n\ngcc/ada/\n\n\t* exp_attr.adb (Expand_Loop_Entry_Attribute): Revise loop that\n\tresets the scopes of entities associated with Loop_Id to the\n\tscope of the new function, so the resetting is not restricted to\n\titypes, but excludes loop parameters and the function entity\n\titself. However, this fix is believed to be incomplete and a ???\n\tcomment is added to indicate that.", "tree": {"sha": "515fd8861fb5e68b21dad1773ddef0489dd39155", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/515fd8861fb5e68b21dad1773ddef0489dd39155"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/075116992690d6f29530a0a7f08cf2f7d5652a93", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/075116992690d6f29530a0a7f08cf2f7d5652a93", "html_url": "https://github.com/Rust-GCC/gccrs/commit/075116992690d6f29530a0a7f08cf2f7d5652a93", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/075116992690d6f29530a0a7f08cf2f7d5652a93/comments", "author": {"login": "dismukes", "id": 50880541, "node_id": "MDQ6VXNlcjUwODgwNTQx", "avatar_url": "https://avatars.githubusercontent.com/u/50880541?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dismukes", "html_url": "https://github.com/dismukes", "followers_url": "https://api.github.com/users/dismukes/followers", "following_url": "https://api.github.com/users/dismukes/following{/other_user}", "gists_url": "https://api.github.com/users/dismukes/gists{/gist_id}", "starred_url": "https://api.github.com/users/dismukes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dismukes/subscriptions", "organizations_url": "https://api.github.com/users/dismukes/orgs", "repos_url": "https://api.github.com/users/dismukes/repos", "events_url": "https://api.github.com/users/dismukes/events{/privacy}", "received_events_url": "https://api.github.com/users/dismukes/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0000998e65ce6109d351200bf8e896762932ec2e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0000998e65ce6109d351200bf8e896762932ec2e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0000998e65ce6109d351200bf8e896762932ec2e"}], "stats": {"total": 36, "additions": 25, "deletions": 11}, "files": [{"sha": "939183c56359e02a4999c06261104f6f9da5a213", "filename": "gcc/ada/exp_attr.adb", "status": "modified", "additions": 25, "deletions": 11, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/075116992690d6f29530a0a7f08cf2f7d5652a93/gcc%2Fada%2Fexp_attr.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/075116992690d6f29530a0a7f08cf2f7d5652a93/gcc%2Fada%2Fexp_attr.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_attr.adb?ref=075116992690d6f29530a0a7f08cf2f7d5652a93", "patch": "@@ -1434,22 +1434,36 @@ package body Exp_Attr is\n                Insert_Action (Loop_Stmt, Func_Decl);\n                Pop_Scope;\n \n-               --  The analysis of the condition may have generated itypes\n-               --  that are now used within the function: Adjust their\n-               --  scopes accordingly so that their use appears in their\n-               --  scope of definition.\n+               --  The analysis of the condition may have generated entities\n+               --  (such as itypes) that are now used within the function.\n+               --  Adjust their scopes accordingly so that their use appears\n+               --  in their scope of definition.\n \n                declare\n-                  Ityp : Entity_Id;\n+                  Ent : Entity_Id;\n \n                begin\n-                  Ityp := First_Entity (Loop_Id);\n-\n-                  while Present (Ityp) loop\n-                     if Is_Itype (Ityp) then\n-                        Set_Scope (Ityp, Func_Id);\n+                  Ent := First_Entity (Loop_Id);\n+\n+                  while Present (Ent) loop\n+                     --  Various entities that now occur within the function\n+                     --  need to have their scope reset, but not all entities\n+                     --  associated with Loop_Id are now inside the function.\n+                     --  The function entity itself and loop parameters can\n+                     --  be outside the function, and there may be others.\n+                     --  It's not clear how the determination of what entity\n+                     --  scopes need to be adjusted can be made accurately.\n+                     --  Perhaps it will be necessary to traverse the function\n+                     --  body to find the exact entities whose scopes need to\n+                     --  be reset to the function's Entity_Id. ???\n+\n+                     if Ekind (Ent) /= E_Loop_Parameter\n+                       and then Ent /= Func_Id\n+                     then\n+                        Set_Scope (Ent, Func_Id);\n                      end if;\n-                     Next_Entity (Ityp);\n+\n+                     Next_Entity (Ent);\n                   end loop;\n                end;\n "}]}