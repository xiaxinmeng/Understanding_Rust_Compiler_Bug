{"sha": "52ebc2be0990d6d3a46bb716164f9cef6f661021", "node_id": "C_kwDOANBUbNoAKDUyZWJjMmJlMDk5MGQ2ZDNhNDZiYjcxNjE2NGY5Y2VmNmY2NjEwMjE", "commit": {"author": {"name": "Pavel I. Kryukov", "email": "pavel.kryukov@phystech.edu", "date": "2022-01-06T12:32:36Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-01-06T14:56:48Z"}, "message": "libstdc++: Add self-merge check to std::forward_list::merge [PR103853]\n\nThis implements the proposed resolution of LWG 3088, so that x.merge(x)\nis a no-op, consistent with std::list::merge.\n\nSigned-off-by: Pavel I. Kryukov <pavel.kryukov@phystech.edu>\n\nCo-authored-by: Jonathan Wakely <jwakely@redhat.com>\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/103853\n\t* include/bits/forward_list.tcc (forward_list::merge): Check for\n\tself-merge.\n\t* testsuite/23_containers/forward_list/operations/merge.cc: New test.", "tree": {"sha": "e812995455581c40d4b8e57887a3756cfc1e81f0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e812995455581c40d4b8e57887a3756cfc1e81f0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/52ebc2be0990d6d3a46bb716164f9cef6f661021", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/52ebc2be0990d6d3a46bb716164f9cef6f661021", "html_url": "https://github.com/Rust-GCC/gccrs/commit/52ebc2be0990d6d3a46bb716164f9cef6f661021", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/52ebc2be0990d6d3a46bb716164f9cef6f661021/comments", "author": {"login": "pavelkryukov", "id": 11466405, "node_id": "MDQ6VXNlcjExNDY2NDA1", "avatar_url": "https://avatars.githubusercontent.com/u/11466405?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pavelkryukov", "html_url": "https://github.com/pavelkryukov", "followers_url": "https://api.github.com/users/pavelkryukov/followers", "following_url": "https://api.github.com/users/pavelkryukov/following{/other_user}", "gists_url": "https://api.github.com/users/pavelkryukov/gists{/gist_id}", "starred_url": "https://api.github.com/users/pavelkryukov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pavelkryukov/subscriptions", "organizations_url": "https://api.github.com/users/pavelkryukov/orgs", "repos_url": "https://api.github.com/users/pavelkryukov/repos", "events_url": "https://api.github.com/users/pavelkryukov/events{/privacy}", "received_events_url": "https://api.github.com/users/pavelkryukov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec12ddd1e7f7d6b48a593df865e7846039e7d62e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec12ddd1e7f7d6b48a593df865e7846039e7d62e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ec12ddd1e7f7d6b48a593df865e7846039e7d62e"}], "stats": {"total": 53, "additions": 53, "deletions": 0}, "files": [{"sha": "b0a65457404c2743df779386b5fcca71e43811a3", "filename": "libstdc++-v3/include/bits/forward_list.tcc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/52ebc2be0990d6d3a46bb716164f9cef6f661021/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fforward_list.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/52ebc2be0990d6d3a46bb716164f9cef6f661021/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fforward_list.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fforward_list.tcc?ref=52ebc2be0990d6d3a46bb716164f9cef6f661021", "patch": "@@ -367,6 +367,11 @@ _GLIBCXX_BEGIN_NAMESPACE_CONTAINER\n       forward_list<_Tp, _Alloc>::\n       merge(forward_list&& __list, _Comp __comp)\n       {\n+\t// _GLIBCXX_RESOLVE_LIB_DEFECTS\n+\t// 3088. forward_list::merge behavior unclear when passed *this\n+\tif (std::__addressof(__list) == this)\n+\t  return;\n+\n \t_Node_base* __node = &this->_M_impl._M_head;\n \twhile (__node->_M_next && __list._M_impl._M_head._M_next)\n \t  {"}, {"sha": "0f6f520c33b232c2e97302b9a0e48d7aba6227d3", "filename": "libstdc++-v3/testsuite/23_containers/forward_list/operations/merge.cc", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/52ebc2be0990d6d3a46bb716164f9cef6f661021/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fforward_list%2Foperations%2Fmerge.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/52ebc2be0990d6d3a46bb716164f9cef6f661021/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fforward_list%2Foperations%2Fmerge.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F23_containers%2Fforward_list%2Foperations%2Fmerge.cc?ref=52ebc2be0990d6d3a46bb716164f9cef6f661021", "patch": "@@ -0,0 +1,48 @@\n+// { dg-do run { target c++11 } }\n+// C++11 23.3.4.6 Operations [forwardlist.ops]\n+\n+#include <forward_list>\n+#include <testsuite_hooks.h>\n+\n+void\n+test_stable()\n+{\n+  std::forward_list<double> a{1.5, 2.0, 3.5, 4.1};\n+  std::forward_list<double> b{1.0, 2.5, 3.0, 4.3, 4.2, 5.0};\n+\n+  a.merge(b, std::less<int>{});\n+\n+  // result is sorted with respect to std::less<int>, so 1.0 and 1.5 are\n+  // equivalent, and stability guarantee means the element from a comes first.\n+  const std::forward_list<double> r { 1.5, 1.0,\n+\t\t\t\t      2.0, 2.5,\n+\t\t\t\t      3.5, 3.0,\n+\t\t\t\t      4.1, 4.3, 4.2,\n+\t\t\t\t      5.0};\n+\n+  VERIFY(a == r);\n+}\n+\n+void\n+test_lwg3088()\n+{\n+  // LWG 3088: forward_list::merge behavior unclear when passed *this\n+  // PR libstdc++/103853\n+  std::forward_list<int> c1{ 1, 2, 3 };\n+  const std::forward_list<int> c2 = c1;\n+  c1.merge(c1);\n+  VERIFY( c1 == c2 );\n+  c1.merge(c1, std::less<long>{});\n+  VERIFY( c1 == c2 );\n+  c1.merge(std::move(c1));\n+  VERIFY( c1 == c2 );\n+  c1.merge(std::move(c1), std::less<long>{});\n+  VERIFY( c1 == c2 );\n+}\n+\n+int\n+main()\n+{\n+  test_stable();\n+  test_lwg3088();\n+}"}]}