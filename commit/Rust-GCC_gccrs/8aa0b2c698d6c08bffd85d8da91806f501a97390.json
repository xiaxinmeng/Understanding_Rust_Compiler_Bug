{"sha": "8aa0b2c698d6c08bffd85d8da91806f501a97390", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OGFhMGIyYzY5OGQ2YzA4YmZmZDg1ZDhkYTkxODA2ZjUwMWE5NzM5MA==", "commit": {"author": {"name": "Vincent Celier", "email": "celier@adacore.com", "date": "2006-02-15T09:42:01Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2006-02-15T09:42:01Z"}, "message": "mlib-prj.adb (Index): New function\n\n2006-02-13  Vincent Celier  <celier@adacore.com>\n\n\t* mlib-prj.adb (Index): New function\n\t(Build_Library): When building a shared library, add to the run path\n\tthe directory of the shared version of libgcc.\n\t(Build_Library): Output shared decgnat library.\n\t(Process_Binder_File): Test for shared decgnat library.\n\nFrom-SVN: r111079", "tree": {"sha": "fa3e9dd6bf6aa7a21cc2b0136d8eaf9ebdd1aae7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fa3e9dd6bf6aa7a21cc2b0136d8eaf9ebdd1aae7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8aa0b2c698d6c08bffd85d8da91806f501a97390", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8aa0b2c698d6c08bffd85d8da91806f501a97390", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8aa0b2c698d6c08bffd85d8da91806f501a97390", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8aa0b2c698d6c08bffd85d8da91806f501a97390/comments", "author": {"login": "vcelier", "id": 8888056, "node_id": "MDQ6VXNlcjg4ODgwNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/8888056?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vcelier", "html_url": "https://github.com/vcelier", "followers_url": "https://api.github.com/users/vcelier/followers", "following_url": "https://api.github.com/users/vcelier/following{/other_user}", "gists_url": "https://api.github.com/users/vcelier/gists{/gist_id}", "starred_url": "https://api.github.com/users/vcelier/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vcelier/subscriptions", "organizations_url": "https://api.github.com/users/vcelier/orgs", "repos_url": "https://api.github.com/users/vcelier/repos", "events_url": "https://api.github.com/users/vcelier/events{/privacy}", "received_events_url": "https://api.github.com/users/vcelier/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f2c573b11296a52ff9a020d0143f26a224ec7767", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f2c573b11296a52ff9a020d0143f26a224ec7767", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f2c573b11296a52ff9a020d0143f26a224ec7767"}], "stats": {"total": 60, "additions": 57, "deletions": 3}, "files": [{"sha": "89100728621923bcd47c9bae430d2955f2bf5e12", "filename": "gcc/ada/mlib-prj.adb", "status": "modified", "additions": 57, "deletions": 3, "changes": 60, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8aa0b2c698d6c08bffd85d8da91806f501a97390/gcc%2Fada%2Fmlib-prj.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8aa0b2c698d6c08bffd85d8da91806f501a97390/gcc%2Fada%2Fmlib-prj.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmlib-prj.adb?ref=8aa0b2c698d6c08bffd85d8da91806f501a97390", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---                     Copyright (C) 2001-2005, AdaCore                     --\n+--                     Copyright (C) 2001-2006, AdaCore                     --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -229,6 +229,9 @@ package body MLib.Prj is\n    --  Display invocation of gnatbind and of the compiler with the arguments\n    --  in Arguments, except when Quiet_Output is True.\n \n+   function Index (S, Pattern : String) return Natural;\n+   --  Return the last occurrence of Pattern in S, or 0 if none\n+\n    procedure Process_Binder_File (Name : String);\n    --  For Stand-Alone libraries, get the Linker Options in the binder\n    --  generated file.\n@@ -1282,7 +1285,31 @@ package body MLib.Prj is\n          --  Rpath.\n \n          if Path_Option /= null then\n-            Add_Rpath (Lib_Directory);\n+            declare\n+               Libdir    : constant String := Lib_Directory;\n+               GCC_Index : Natural := 0;\n+\n+            begin\n+               Add_Rpath (Libdir);\n+\n+               --  For shared libraries, add to the Path Option the directory\n+               --  of the shared version of libgcc.\n+\n+               if The_Build_Mode /= Static then\n+                  GCC_Index := Index (Libdir, \"/lib/\");\n+\n+                  if GCC_Index = 0 then\n+                     GCC_Index :=\n+                       Index\n+                         (Libdir,\n+                          Directory_Separator & \"lib\" & Directory_Separator);\n+                  end if;\n+\n+                  if GCC_Index /= 0 then\n+                     Add_Rpath (Libdir (Libdir'First .. GCC_Index + 3));\n+                  end if;\n+               end if;\n+            end;\n          end if;\n \n          if Libgnarl_Needed then\n@@ -1303,10 +1330,17 @@ package body MLib.Prj is\n \n          if Libdecgnat_Needed then\n             Opts.Increment_Last;\n+\n             Opts.Table (Opts.Last) :=\n               new String'(\"-L\" & Lib_Directory & \"/../declib\");\n+\n             Opts.Increment_Last;\n-            Opts.Table (Opts.Last) := new String'(\"-ldecgnat\");\n+\n+            if The_Build_Mode = Static then\n+               Opts.Table (Opts.Last) := new String'(\"-ldecgnat\");\n+            else\n+               Opts.Table (Opts.Last) := new String'(Shared_Lib (\"decgnat\"));\n+            end if;\n          end if;\n \n          Opts.Increment_Last;\n@@ -2021,6 +2055,23 @@ package body MLib.Prj is\n       end if;\n    end Display;\n \n+   -----------\n+   -- Index --\n+   -----------\n+\n+   function Index (S, Pattern : String) return Natural is\n+      Len : constant Natural := Pattern'Length;\n+\n+   begin\n+      for J in reverse S'First .. S'Last - Len + 1 loop\n+         if Pattern = S (J .. J + Len - 1) then\n+            return J;\n+         end if;\n+      end loop;\n+\n+      return 0;\n+   end Index;\n+\n    -------------------------\n    -- Process_Binder_File --\n    -------------------------\n@@ -2128,6 +2179,9 @@ package body MLib.Prj is\n                Next_Line (1 .. Nlast) /= \"-ldecgnat\" and then\n                Next_Line (1 .. Nlast) /= \"-lgnarl\" and then\n                Next_Line (1 .. Nlast) /= \"-lgnat\" and then\n+               Next_Line\n+                 (1 .. Natural'Min (Nlast, 10 + Library_Version'Length)) /=\n+                   Shared_Lib (\"decgnat\") and then\n                Next_Line\n                  (1 .. Natural'Min (Nlast, 8 + Library_Version'Length)) /=\n                    Shared_Lib (\"gnarl\") and then"}]}