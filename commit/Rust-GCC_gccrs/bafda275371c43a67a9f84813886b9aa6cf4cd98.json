{"sha": "bafda275371c43a67a9f84813886b9aa6cf4cd98", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YmFmZGEyNzUzNzFjNDNhNjdhOWY4NDgxMzg4NmI5YWE2Y2Y0Y2Q5OA==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-07-26T13:38:15Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-07-30T10:51:35Z"}, "message": "d: Drop any field or parameter types that got cached before conversion failed.\n\nThis ensures there are no dangling references to AST members that have\nbeen freed, either explcitly or by the garbage collector.\n\ngcc/d/ChangeLog:\n\n\t* d-builtins.cc (build_frontend_type): Restore builtin_converted_decls\n\tlength on conversion failure.", "tree": {"sha": "80a4f4748b26278a66e731cb98697f572fc558ef", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/80a4f4748b26278a66e731cb98697f572fc558ef"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bafda275371c43a67a9f84813886b9aa6cf4cd98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bafda275371c43a67a9f84813886b9aa6cf4cd98", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bafda275371c43a67a9f84813886b9aa6cf4cd98", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bafda275371c43a67a9f84813886b9aa6cf4cd98/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "55303957de85fd4d0d529e7eeb1b67e29e4f98c5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/55303957de85fd4d0d529e7eeb1b67e29e4f98c5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/55303957de85fd4d0d529e7eeb1b67e29e4f98c5"}], "stats": {"total": 9, "additions": 8, "deletions": 1}, "files": [{"sha": "9db46c0c5ca6dbaea501ef38c2bab0b4072601a2", "filename": "gcc/d/d-builtins.cc", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bafda275371c43a67a9f84813886b9aa6cf4cd98/gcc%2Fd%2Fd-builtins.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bafda275371c43a67a9f84813886b9aa6cf4cd98/gcc%2Fd%2Fd-builtins.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-builtins.cc?ref=bafda275371c43a67a9f84813886b9aa6cf4cd98", "patch": "@@ -80,7 +80,8 @@ build_frontend_type (tree type)\n     mod |= MODshared;\n \n   /* If we've seen the type before, re-use the converted decl.  */\n-  for (size_t i = 0; i < builtin_converted_decls.length (); ++i)\n+  unsigned saved_builtin_decls_length = builtin_converted_decls.length ();\n+  for (size_t i = 0; i < saved_builtin_decls_length; ++i)\n     {\n       tree t = builtin_converted_decls[i].ctype;\n       if (TYPE_MAIN_VARIANT (t) == TYPE_MAIN_VARIANT (type))\n@@ -249,6 +250,9 @@ build_frontend_type (tree type)\n \t  Type *ftype = build_frontend_type (TREE_TYPE (field));\n \t  if (!ftype)\n \t    {\n+\t      /* Drop any field types that got cached before the conversion\n+\t\t of this record type failed.  */\n+\t      builtin_converted_decls.truncate (saved_builtin_decls_length);\n \t      delete sdecl->members;\n \t      return NULL;\n \t    }\n@@ -307,6 +311,9 @@ build_frontend_type (tree type)\n \t      Type *targ = build_frontend_type (argtype);\n \t      if (!targ)\n \t\t{\n+\t\t  /* Drop any parameter types that got cached before the\n+\t\t     conversion of this function type failed.  */\n+\t\t  builtin_converted_decls.truncate (saved_builtin_decls_length);\n \t\t  delete args;\n \t\t  return NULL;\n \t\t}"}]}