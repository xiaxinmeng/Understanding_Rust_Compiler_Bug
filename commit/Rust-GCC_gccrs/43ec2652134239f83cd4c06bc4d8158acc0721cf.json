{"sha": "43ec2652134239f83cd4c06bc4d8158acc0721cf", "node_id": "C_kwDOANBUbNoAKDQzZWMyNjUyMTM0MjM5ZjgzY2Q0YzA2YmM0ZDgxNThhY2MwNzIxY2Y", "commit": {"author": {"name": "David Faust", "email": "david.faust@oracle.com", "date": "2021-12-14T20:41:30Z"}, "committer": {"name": "David Faust", "email": "david.faust@oracle.com", "date": "2022-01-18T21:20:49Z"}, "message": "bpf: write CO-RE relocation record size only once\n\nThe CO-RE relocation record size should be written only once in the\n.BTF.ext section, not once for each section with relocations.\n\ngcc/ChangeLog:\n\n\t* config/bpf/coreout.cc (output_btfext_header): Account for\n\t4-byte record size in core_relo_len.\n\t(output_btfext_core_sections): Only write record size once.\n\t* config/bpf/coreout.h (btf_ext_section_header): Delete unused\n\tmember.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.target/bpf/core-section-1.c: Adjust expected record size\n\toccurrences.", "tree": {"sha": "4abae0ea73485d9c1a66c157d25ba02822e8b95d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4abae0ea73485d9c1a66c157d25ba02822e8b95d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/43ec2652134239f83cd4c06bc4d8158acc0721cf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/43ec2652134239f83cd4c06bc4d8158acc0721cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/43ec2652134239f83cd4c06bc4d8158acc0721cf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/43ec2652134239f83cd4c06bc4d8158acc0721cf/comments", "author": {"login": "dafaust", "id": 4460334, "node_id": "MDQ6VXNlcjQ0NjAzMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4460334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dafaust", "html_url": "https://github.com/dafaust", "followers_url": "https://api.github.com/users/dafaust/followers", "following_url": "https://api.github.com/users/dafaust/following{/other_user}", "gists_url": "https://api.github.com/users/dafaust/gists{/gist_id}", "starred_url": "https://api.github.com/users/dafaust/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dafaust/subscriptions", "organizations_url": "https://api.github.com/users/dafaust/orgs", "repos_url": "https://api.github.com/users/dafaust/repos", "events_url": "https://api.github.com/users/dafaust/events{/privacy}", "received_events_url": "https://api.github.com/users/dafaust/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dafaust", "id": 4460334, "node_id": "MDQ6VXNlcjQ0NjAzMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4460334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dafaust", "html_url": "https://github.com/dafaust", "followers_url": "https://api.github.com/users/dafaust/followers", "following_url": "https://api.github.com/users/dafaust/following{/other_user}", "gists_url": "https://api.github.com/users/dafaust/gists{/gist_id}", "starred_url": "https://api.github.com/users/dafaust/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dafaust/subscriptions", "organizations_url": "https://api.github.com/users/dafaust/orgs", "repos_url": "https://api.github.com/users/dafaust/repos", "events_url": "https://api.github.com/users/dafaust/events{/privacy}", "received_events_url": "https://api.github.com/users/dafaust/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2aefe248aa4160205c44808166393a42031d2dea", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2aefe248aa4160205c44808166393a42031d2dea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2aefe248aa4160205c44808166393a42031d2dea"}], "stats": {"total": 17, "additions": 10, "deletions": 7}, "files": [{"sha": "4ec12ecd305a1b7f5a22ba975535e6382308491e", "filename": "gcc/config/bpf/coreout.cc", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/43ec2652134239f83cd4c06bc4d8158acc0721cf/gcc%2Fconfig%2Fbpf%2Fcoreout.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/43ec2652134239f83cd4c06bc4d8158acc0721cf/gcc%2Fconfig%2Fbpf%2Fcoreout.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fbpf%2Fcoreout.cc?ref=43ec2652134239f83cd4c06bc4d8158acc0721cf", "patch": "@@ -259,7 +259,7 @@ output_btfext_header (void)\n   uint32_t core_relo_off = 0, core_relo_len = 0;\n \n   /* Header core_relo_len is the sum total length in bytes of all CO-RE\n-     relocation sections.  */\n+     relocation sections, plus the 4 byte record size.  */\n   size_t i;\n   bpf_core_section_ref sec;\n   core_relo_len += vec_safe_length (bpf_core_sections)\n@@ -269,6 +269,9 @@ output_btfext_header (void)\n     core_relo_len +=\n       vec_safe_length (sec->relocs) * sizeof (struct btf_ext_reloc);\n \n+  if (core_relo_len)\n+    core_relo_len += sizeof (uint32_t);\n+\n   dw2_asm_output_data (4, func_info_off, \"func_info_offset\");\n   dw2_asm_output_data (4, func_info_len, \"func_info_len\");\n \n@@ -310,12 +313,13 @@ output_btfext_core_sections (void)\n {\n   size_t i;\n   bpf_core_section_ref sec;\n+\n+  /* BTF Ext section info. */\n+  dw2_asm_output_data (4, sizeof (struct btf_ext_reloc),\n+\t\t       \"btfext_core_info_rec_size\");\n+\n   FOR_EACH_VEC_ELT (*bpf_core_sections, i, sec)\n     {\n-      /* BTF Ext section info. */\n-      dw2_asm_output_data (4, sizeof (struct btf_ext_reloc),\n-\t\t\t   \"btfext_secinfo_rec_size\");\n-\n       /* Section name offset, refers to the offset of a string with the name of\n \t the section to which these CORE relocations refer, e.g. '.text'.\n \t The string is buffered in the BTF strings table.  */"}, {"sha": "3c7bdfd8c2f4d3543c9633eb22d0da69bf6ad600", "filename": "gcc/config/bpf/coreout.h", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/43ec2652134239f83cd4c06bc4d8158acc0721cf/gcc%2Fconfig%2Fbpf%2Fcoreout.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/43ec2652134239f83cd4c06bc4d8158acc0721cf/gcc%2Fconfig%2Fbpf%2Fcoreout.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fbpf%2Fcoreout.h?ref=43ec2652134239f83cd4c06bc4d8158acc0721cf", "patch": "@@ -33,7 +33,6 @@ extern \"C\"\n \n struct btf_ext_section_header\n {\n-  uint32_t kind;\n   uint32_t sec_name_off;\n   uint32_t num_records;\n };"}, {"sha": "4f16b087c1a2a9ffa080ab7daea5545633b31257", "filename": "gcc/testsuite/gcc.target/bpf/core-section-1.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/43ec2652134239f83cd4c06bc4d8158acc0721cf/gcc%2Ftestsuite%2Fgcc.target%2Fbpf%2Fcore-section-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/43ec2652134239f83cd4c06bc4d8158acc0721cf/gcc%2Ftestsuite%2Fgcc.target%2Fbpf%2Fcore-section-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fbpf%2Fcore-section-1.c?ref=43ec2652134239f83cd4c06bc4d8158acc0721cf", "patch": "@@ -35,4 +35,4 @@ int bar_func (struct T *t)\n /* { dg-final { scan-assembler-times \"ascii \\\"foo_sec.0\\\"\\[\\t \\]+\\[^\\n\\]*btf_aux_string\" 1 } } */\n /* { dg-final { scan-assembler-times \"ascii \\\"bar_sec.0\\\"\\[\\t \\]+\\[^\\n\\]*btf_aux_string\" 1 } } */\n /* { dg-final { scan-assembler-times \"bpfcr_type\" 2 } } */\n-/* { dg-final { scan-assembler-times \"btfext_secinfo_rec_size\" 2 } } */\n+/* { dg-final { scan-assembler-times \"btfext_core_info_rec_size\" 1 } } */"}]}