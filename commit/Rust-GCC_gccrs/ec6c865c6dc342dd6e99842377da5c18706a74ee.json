{"sha": "ec6c865c6dc342dd6e99842377da5c18706a74ee", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZWM2Yzg2NWM2ZGMzNDJkZDZlOTk4NDIzNzdkYTVjMTg3MDZhNzRlZQ==", "commit": {"author": {"name": "Tom de Vries", "email": "tdevries@suse.de", "date": "2018-12-17T21:26:39Z"}, "committer": {"name": "Tom de Vries", "email": "vries@gcc.gnu.org", "date": "2018-12-17T21:26:39Z"}, "message": "[nvptx] Rewrite nvptx_goacc_validate_dims to use predicate vars\n\nThe function nvptx_goacc_validate_dims has arguments decl and fn_level which\ntogether describe different situations.\n\nIntroduce a predicate var for each situation, and use them, allowing to\nunderstand what the function does in each situation without having to know the\nway the situations are encoded in the args.\n\nBuild and reg-tested on x86_64 with nvptx accelerator.\n\n2018-12-17  Tom de Vries  <tdevries@suse.de>\n\n\t* config/nvptx/nvptx.c (nvptx_goacc_validate_dims): Rewrite using\n\tpredicate vars.\n\nFrom-SVN: r267212", "tree": {"sha": "983e41c328af15f8c6280942d254b9a94f4c8ead", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/983e41c328af15f8c6280942d254b9a94f4c8ead"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ec6c865c6dc342dd6e99842377da5c18706a74ee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec6c865c6dc342dd6e99842377da5c18706a74ee", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ec6c865c6dc342dd6e99842377da5c18706a74ee", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec6c865c6dc342dd6e99842377da5c18706a74ee/comments", "author": {"login": "vries", "id": 4057235, "node_id": "MDQ6VXNlcjQwNTcyMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vries", "html_url": "https://github.com/vries", "followers_url": "https://api.github.com/users/vries/followers", "following_url": "https://api.github.com/users/vries/following{/other_user}", "gists_url": "https://api.github.com/users/vries/gists{/gist_id}", "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vries/subscriptions", "organizations_url": "https://api.github.com/users/vries/orgs", "repos_url": "https://api.github.com/users/vries/repos", "events_url": "https://api.github.com/users/vries/events{/privacy}", "received_events_url": "https://api.github.com/users/vries/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c764b12ccaaa84226682b9c19a448d51501ca56b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c764b12ccaaa84226682b9c19a448d51501ca56b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c764b12ccaaa84226682b9c19a448d51501ca56b"}], "stats": {"total": 37, "additions": 34, "deletions": 3}, "files": [{"sha": "7281f42d6fd9ce58f951f5695e8ca10b40f24ef2", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec6c865c6dc342dd6e99842377da5c18706a74ee/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec6c865c6dc342dd6e99842377da5c18706a74ee/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=ec6c865c6dc342dd6e99842377da5c18706a74ee", "patch": "@@ -1,3 +1,8 @@\n+2018-12-17  Tom de Vries  <tdevries@suse.de>\n+\n+\t* config/nvptx/nvptx.c (nvptx_goacc_validate_dims): Rewrite using\n+\tpredicate vars.\n+\n 2018-12-17  Steve Ellcey  <sellcey@cavium.com>\n \n \t* config/aarch64/aarch64-protos.h (aarch64_use_simple_return_insn_p):"}, {"sha": "746d8bfb1004217d418c081780ad7183be179102", "filename": "gcc/config/nvptx/nvptx.c", "status": "modified", "additions": 29, "deletions": 3, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec6c865c6dc342dd6e99842377da5c18706a74ee/gcc%2Fconfig%2Fnvptx%2Fnvptx.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec6c865c6dc342dd6e99842377da5c18706a74ee/gcc%2Fconfig%2Fnvptx%2Fnvptx.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fnvptx%2Fnvptx.c?ref=ec6c865c6dc342dd6e99842377da5c18706a74ee", "patch": "@@ -5187,13 +5187,39 @@ static bool\n nvptx_goacc_validate_dims (tree decl, int dims[], int fn_level)\n {\n   bool changed = false;\n+  bool oacc_default_dims_p = false;\n+  bool oacc_min_dims_p = false;\n+  bool offload_region_p = false;\n+  bool routine_p = false;\n+  bool routine_seq_p = false;\n+\n+  if (decl == NULL_TREE)\n+    {\n+      if (fn_level == -1)\n+\toacc_default_dims_p = true;\n+      else if (fn_level == -2)\n+\toacc_min_dims_p = true;\n+      else\n+\tgcc_unreachable ();\n+    }\n+  else if (fn_level == -1)\n+    offload_region_p = true;\n+  else if (0 <= fn_level && fn_level <= GOMP_DIM_MAX)\n+    {\n+      routine_p = true;\n+      routine_seq_p = fn_level == GOMP_DIM_MAX;\n+    }\n+  else\n+    gcc_unreachable ();\n \n   /* The vector size must be 32, unless this is a SEQ routine.  */\n-  if (fn_level <= GOMP_DIM_VECTOR && fn_level >= -1\n+  if ((offload_region_p || oacc_default_dims_p\n+       || (routine_p && !routine_seq_p))\n       && dims[GOMP_DIM_VECTOR] >= 0\n       && dims[GOMP_DIM_VECTOR] != PTX_VECTOR_LENGTH)\n     {\n-      if (fn_level < 0 && dims[GOMP_DIM_VECTOR] >= 0)\n+      if ((offload_region_p || oacc_default_dims_p)\n+\t  && dims[GOMP_DIM_VECTOR] >= 0)\n \twarning_at (decl ? DECL_SOURCE_LOCATION (decl) : UNKNOWN_LOCATION, 0,\n \t\t    dims[GOMP_DIM_VECTOR]\n \t\t    ? G_(\"using vector_length (%d), ignoring %d\")\n@@ -5213,7 +5239,7 @@ nvptx_goacc_validate_dims (tree decl, int dims[], int fn_level)\n       changed = true;\n     }\n \n-  if (!decl)\n+  if (oacc_default_dims_p || oacc_min_dims_p)\n     {\n       dims[GOMP_DIM_VECTOR] = PTX_VECTOR_LENGTH;\n       if (dims[GOMP_DIM_WORKER] < 0)"}]}