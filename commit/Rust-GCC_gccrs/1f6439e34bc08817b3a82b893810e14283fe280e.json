{"sha": "1f6439e34bc08817b3a82b893810e14283fe280e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWY2NDM5ZTM0YmMwODgxN2IzYTgyYjg5MzgxMGUxNDI4M2ZlMjgwZQ==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2011-08-02T14:46:28Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2011-08-02T14:46:28Z"}, "message": "[multiple changes]\n\n2011-08-02  Javier Miranda  <miranda@adacore.com>\n\n\t* exp_ch6.adb (Expand_N_Subprogram_Body): Enable generation of TSDs in\n\tthe JVM target.\n\t* exp_ch7.adb (Expand_N_Package_Body): Enable generation of TSDs in\n\tthe JVM target.\n\t* exp_disp.adb (Build_VM_TSDs): No action needed if the runtime has no\n\tTSD support.\n\n2011-08-02  Vincent Celier  <celier@adacore.com>\n\n\t* prj-nmsc.adb (File_Found): New components Excl_File and Excl_Line\n\t(No_Space_Img): New function\n\t(Find_Excluded_Sources): When reading from a file, record the file name\n\tand the line number for each excluded source.\n\t(Mark_Excluded_Sources): When reporting an error, if the excluded\n\tsources were read from a file, include file name and line number in\n\tthe error message.\n\n2011-08-02  Ed Schonberg  <schonberg@adacore.com>\n\n\t* sem_res.adb (Resolve_Call): implement rule in RM 12.5.1 (23.3/2).\n\nFrom-SVN: r177167", "tree": {"sha": "b03a52623c2c60777a03c69a4a170e54e79a9a34", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b03a52623c2c60777a03c69a4a170e54e79a9a34"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1f6439e34bc08817b3a82b893810e14283fe280e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1f6439e34bc08817b3a82b893810e14283fe280e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1f6439e34bc08817b3a82b893810e14283fe280e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1f6439e34bc08817b3a82b893810e14283fe280e/comments", "author": null, "committer": null, "parents": [{"sha": "c01ecafca3a2effd729b30df2aebfa8cef261ff6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c01ecafca3a2effd729b30df2aebfa8cef261ff6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c01ecafca3a2effd729b30df2aebfa8cef261ff6"}], "stats": {"total": 159, "additions": 130, "deletions": 29}, "files": [{"sha": "93d8439ac16b7716e5660c9d6b7bfcb08adaeda9", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=1f6439e34bc08817b3a82b893810e14283fe280e", "patch": "@@ -1,3 +1,26 @@\n+2011-08-02  Javier Miranda  <miranda@adacore.com>\n+\n+\t* exp_ch6.adb (Expand_N_Subprogram_Body): Enable generation of TSDs in\n+\tthe JVM target.\n+\t* exp_ch7.adb (Expand_N_Package_Body): Enable generation of TSDs in\n+\tthe JVM target.\n+\t* exp_disp.adb (Build_VM_TSDs): No action needed if the runtime has no\n+\tTSD support.\n+\n+2011-08-02  Vincent Celier  <celier@adacore.com>\n+\n+\t* prj-nmsc.adb (File_Found): New components Excl_File and Excl_Line\n+\t(No_Space_Img): New function\n+\t(Find_Excluded_Sources): When reading from a file, record the file name\n+\tand the line number for each excluded source.\n+\t(Mark_Excluded_Sources): When reporting an error, if the excluded\n+\tsources were read from a file, include file name and line number in\n+\tthe error message.\n+\n+2011-08-02  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_res.adb (Resolve_Call): implement rule in RM 12.5.1 (23.3/2).\n+\n 2011-08-02  Robert Dewar  <dewar@adacore.com>\n \n \t* exp_ch7.adb exp_ch6.adb, exp_disp.adb: Minor reformatting"}, {"sha": "b9af60ead86eaeaa58a44d8bee899107372f1637", "filename": "gcc/ada/exp_ch6.adb", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fexp_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fexp_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch6.adb?ref=1f6439e34bc08817b3a82b893810e14283fe280e", "patch": "@@ -5125,11 +5125,8 @@ package body Exp_Ch6 is\n       --  VM targets, we now generate the Type Specific Data record of all the\n       --  enclosing tagged type declarations.\n \n-      --  Temporarily restrict this support to the .NET compiler???\n-\n       if not Tagged_Type_Expansion\n         and then Unit (Cunit (Main_Unit)) = N\n-        and then VM_Target = CLI_Target\n       then\n          Build_VM_TSDs (N);\n       end if;"}, {"sha": "d2c7725dec143e85f5aab3d68e3ae969c72eeb60", "filename": "gcc/ada/exp_ch7.adb", "status": "modified", "additions": 2, "deletions": 9, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fexp_ch7.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fexp_ch7.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch7.adb?ref=1f6439e34bc08817b3a82b893810e14283fe280e", "patch": "@@ -1559,11 +1559,7 @@ package body Exp_Ch7 is\n             --  In VM targets there is no need to build dispatch tables but\n             --  we must generate the corresponding Type Specific Data record.\n \n-            --  Temporarily restrict this support to the .NET compiler???\n-\n-            elsif Unit (Cunit (Main_Unit)) = N\n-              and then VM_Target = CLI_Target\n-            then\n+            elsif Unit (Cunit (Main_Unit)) = N then\n                Build_VM_TSDs (N);\n             end if;\n          end if;\n@@ -1672,11 +1668,8 @@ package body Exp_Ch7 is\n          --  In VM targets there is no need to build dispatch tables, but we\n          --  must generate the corresponding Type Specific Data record.\n \n-         --  Temporarily restrict this support to the .NET compiler???\n+         elsif Unit (Cunit (Main_Unit)) = N then\n \n-         elsif Unit (Cunit (Main_Unit)) = N\n-           and then VM_Target = CLI_Target\n-         then\n             --  Enter the scope of the package because the new declarations are\n             --  appended at the end of the package and must be analyzed in that\n             --  context."}, {"sha": "9eff2347e80a87e0bebb7af7c1939ae7470cceb4", "filename": "gcc/ada/exp_disp.adb", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fexp_disp.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fexp_disp.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_disp.adb?ref=1f6439e34bc08817b3a82b893810e14283fe280e", "patch": "@@ -569,7 +569,10 @@ package body Exp_Disp is\n    --  Start of processing for Build_VM_TSDs\n \n    begin\n-      if not Expander_Active or else No_Run_Time_Mode then\n+      if not Expander_Active\n+        or else No_Run_Time_Mode\n+        or else not RTE_Available (RE_Type_Specific_Data)\n+      then\n          return;\n       end if;\n "}, {"sha": "1baba1a6e37f6a200577a3091a2f69dcca35558b", "filename": "gcc/ada/prj-nmsc.adb", "status": "modified", "additions": 62, "deletions": 15, "changes": 77, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fprj-nmsc.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fprj-nmsc.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fprj-nmsc.adb?ref=1f6439e34bc08817b3a82b893810e14283fe280e", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 2000-2010, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2000-2011, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -106,12 +106,15 @@ package body Prj.Nmsc is\n    --  exceptions specified in the project files.\n \n    type File_Found is record\n-      File     : File_Name_Type  := No_File;\n-      Found    : Boolean         := False;\n-      Location : Source_Ptr      := No_Location;\n+      File      : File_Name_Type := No_File;\n+      Excl_File : File_Name_Type := No_File;\n+      Excl_Line : Natural        := 0;\n+      Found     : Boolean        := False;\n+      Location  : Source_Ptr     := No_Location;\n    end record;\n \n-   No_File_Found : constant File_Found := (No_File, False, No_Location);\n+   No_File_Found : constant File_Found :=\n+     (No_File, No_File, 0, False, No_Location);\n \n    package Excluded_Sources_Htable is new GNAT.Dynamic_HTables.Simple_HTable\n      (Header_Num => Header_Num,\n@@ -522,6 +525,9 @@ package body Prj.Nmsc is\n       Project  : Project_Id);\n    --  Emits either an error or warning message (or nothing), depending on Kind\n \n+   function No_Space_Img (N : Natural) return String;\n+   --  Image of a Natural without the initial space\n+\n    ----------------------\n    -- Error_Or_Warning --\n    ----------------------\n@@ -5507,6 +5513,16 @@ package body Prj.Nmsc is\n       end if;\n    end Get_Sources_From_File;\n \n+   ------------------\n+   -- No_Space_Img --\n+   ------------------\n+\n+   function No_Space_Img (N : Natural) return String is\n+      Image : constant String := N'Img;\n+   begin\n+      return Image (2 .. Image'Last);\n+   end No_Space_Img;\n+\n    -----------------------\n    -- Compute_Unit_Name --\n    -----------------------\n@@ -6045,18 +6061,23 @@ package body Prj.Nmsc is\n             end if;\n \n             Excluded_Sources_Htable.Set\n-              (Project.Excluded, Name, (Name, False, Location));\n+              (Project.Excluded, Name,\n+               (Name, No_File, 0, False, Location));\n             Current := Element.Next;\n          end loop;\n \n       elsif not Excluded_Source_List_File.Default then\n          Location := Excluded_Source_List_File.Location;\n \n          declare\n+            Source_File_Name : constant File_Name_Type :=\n+                                 File_Name_Type\n+                                    (Excluded_Source_List_File.Value);\n+            Source_File_Line : Natural := 0;\n+\n             Source_File_Path_Name : constant String :=\n                                       Path_Name_Of\n-                                        (File_Name_Type\n-                                           (Excluded_Source_List_File.Value),\n+                                        (Source_File_Name,\n                                          Project.Project.Directory.Name);\n \n          begin\n@@ -6082,6 +6103,7 @@ package body Prj.Nmsc is\n \n                   while not Prj.Util.End_Of_File (File) loop\n                      Prj.Util.Get_Line (File, Line, Last);\n+                     Source_File_Line := Source_File_Line + 1;\n \n                      --  Non empty, non comment line should contain a file name\n \n@@ -6110,7 +6132,10 @@ package body Prj.Nmsc is\n                         end loop;\n \n                         Excluded_Sources_Htable.Set\n-                          (Project.Excluded, Name, (Name, False, Location));\n+                          (Project.Excluded,\n+                           Name,\n+                           (Name, Source_File_Name, Source_File_Line,\n+                            False, Location));\n                      end if;\n                   end loop;\n \n@@ -7579,14 +7604,36 @@ package body Prj.Nmsc is\n                Err_Vars.Error_Msg_File_1 := Excluded.File;\n \n                if Src = No_Source then\n-                  Error_Msg\n+                  if Excluded.Excl_File = No_File then\n+                     Error_Msg\n+                       (Data.Flags,\n+                        \"unknown file {\", Excluded.Location, Project.Project);\n+\n+                  else\n+                     Error_Msg\n                     (Data.Flags,\n-                     \"unknown file {\", Excluded.Location, Project.Project);\n+                     \"in \" &\n+                     Get_Name_String (Excluded.Excl_File) & \":\" &\n+                     No_Space_Img (Excluded.Excl_Line) &\n+                     \": unknown file {\", Excluded.Location, Project.Project);\n+                  end if;\n+\n                else\n-                  Error_Msg\n-                    (Data.Flags,\n-                     \"cannot remove a source from an imported project: {\",\n-                     Excluded.Location, Project.Project);\n+                  if Excluded.Excl_File = No_File then\n+                     Error_Msg\n+                       (Data.Flags,\n+                        \"cannot remove a source from an imported project: {\",\n+                        Excluded.Location, Project.Project);\n+\n+                  else\n+                     Error_Msg\n+                       (Data.Flags,\n+                        \"in \" &\n+                        Get_Name_String (Excluded.Excl_File) & \":\" &\n+                          No_Space_Img (Excluded.Excl_Line) &\n+                        \": cannot remove a source from an imported project: {\",\n+                        Excluded.Location, Project.Project);\n+                  end if;\n                end if;\n             end if;\n "}, {"sha": "f8e19a1b0e52e10d19bbe88c39ebef9ca8670e34", "filename": "gcc/ada/sem_res.adb", "status": "modified", "additions": 39, "deletions": 1, "changes": 40, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fsem_res.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f6439e34bc08817b3a82b893810e14283fe280e/gcc%2Fada%2Fsem_res.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_res.adb?ref=1f6439e34bc08817b3a82b893810e14283fe280e", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 1992-2010, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2011, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -5751,6 +5751,44 @@ package body Sem_Res is\n --         Check_Formal_Restriction (\"function not inherited\", N);\n --      end if;\n \n+      --  Implement rule in 12.5.1 (23.3/2) : in an instance, if the actual\n+      --  is class-wide and the call dispatches on result in a context that\n+      --  does not provide a tag, the call raises Program_Error.\n+\n+      if Nkind (N) = N_Function_Call\n+        and then In_Instance\n+        and then Is_Generic_Actual_Type (Typ)\n+        and then Is_Class_Wide_Type (Typ)\n+        and then Has_Controlling_Result (Nam)\n+        and then Nkind (Parent (N)) = N_Object_Declaration\n+      then\n+\n+         --  verify that none of the formals are controlling.\n+\n+         declare\n+            Call_OK :  Boolean := False;\n+            F       : Entity_Id;\n+\n+         begin\n+            F := First_Formal (Nam);\n+            while Present (F) loop\n+               if Is_Controlling_Formal (F) then\n+                  Call_OK := True;\n+                  exit;\n+               end if;\n+               Next_Formal (F);\n+            end loop;\n+\n+            if not Call_OK then\n+               Error_Msg_N (\"!? cannot determine tag of result\", N);\n+               Error_Msg_N (\"!? Program_Error will be raised\", N);\n+               Insert_Action (N,\n+                 Make_Raise_Program_Error (Sloc (N),\n+                    Reason => PE_Explicit_Raise));\n+            end if;\n+         end;\n+      end if;\n+\n       --  All done, evaluate call and deal with elaboration issues\n \n       Eval_Call (N);"}]}