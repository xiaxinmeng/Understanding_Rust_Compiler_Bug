{"sha": "c9c5e18883125c90b3cbdb61b651719253a0ff90", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzljNWUxODg4MzEyNWM5MGIzY2JkYjYxYjY1MTcxOTI1M2EwZmY5MA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2019-04-10T07:27:20Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2019-04-10T07:27:20Z"}, "message": "re PR c++/90010 (valgrind error with snprintf and -Wall)\n\n\tPR c++/90010\n\t* gimple-ssa-sprintf.c (target_to_host): Fix handling of targstr\n\twith strlen in between hostsz-3 and hostsz-1 inclusive when no\n\ttranslation is needed, and when translation is needed, only append\n\t... if the string length is hostsz or more bytes long.  Avoid using\n\tstrncpy or strcat.\n\n\t* gcc.dg/pr90010.c: New test.\n\nFrom-SVN: r270246", "tree": {"sha": "00926960cbc7944e903ff64d68d4c2c050f5b285", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/00926960cbc7944e903ff64d68d4c2c050f5b285"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c9c5e18883125c90b3cbdb61b651719253a0ff90", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c9c5e18883125c90b3cbdb61b651719253a0ff90", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c9c5e18883125c90b3cbdb61b651719253a0ff90", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c9c5e18883125c90b3cbdb61b651719253a0ff90/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7e1ab2dc3f5e9d59ecff8275fc107b126248048a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e1ab2dc3f5e9d59ecff8275fc107b126248048a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7e1ab2dc3f5e9d59ecff8275fc107b126248048a"}], "stats": {"total": 57, "additions": 51, "deletions": 6}, "files": [{"sha": "84d1205551c5513cda91846959d48a1b7c1d6d38", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c9c5e18883125c90b3cbdb61b651719253a0ff90", "patch": "@@ -1,3 +1,12 @@\n+2019-04-10  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c++/90010\n+\t* gimple-ssa-sprintf.c (target_to_host): Fix handling of targstr\n+\twith strlen in between hostsz-3 and hostsz-1 inclusive when no\n+\ttranslation is needed, and when translation is needed, only append\n+\t... if the string length is hostsz or more bytes long.  Avoid using\n+\tstrncpy or strcat.\n+\n 2019-04-09  Matthew Malcomson  <matthew.malcomson@arm.com>\n \n \tPR target/90024"}, {"sha": "b6527bfc8d53a90d601db541becfa5bfe05c620e", "filename": "gcc/gimple-ssa-sprintf.c", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2Fgimple-ssa-sprintf.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2Fgimple-ssa-sprintf.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-ssa-sprintf.c?ref=c9c5e18883125c90b3cbdb61b651719253a0ff90", "patch": "@@ -383,9 +383,14 @@ target_to_host (char *hostr, size_t hostsz, const char *targstr)\n      overlong strings just like the translated strings are.  */\n   if (target_to_host_charmap['\\0'] == 1)\n     {\n-      strncpy (hostr, targstr, hostsz - 4);\n-      if (strlen (targstr) >= hostsz)\n-\tstrcpy (hostr + hostsz - 4, \"...\");\n+      size_t len = strlen (targstr);\n+      if (len >= hostsz)\n+\t{\n+\t  memcpy (hostr, targstr, hostsz - 4);\n+\t  strcpy (hostr + hostsz - 4, \"...\");\n+\t}\n+      else\n+\tmemcpy (hostr, targstr, len + 1);\n       return hostr;\n     }\n \n@@ -399,10 +404,9 @@ target_to_host (char *hostr, size_t hostsz, const char *targstr)\n       if (!*targstr)\n \tbreak;\n \n-      if (size_t (ph - hostr) == hostsz - 4)\n+      if (size_t (ph - hostr) == hostsz)\n \t{\n-\t  *ph = '\\0';\n-\t  strcat (ph, \"...\");\n+\t  strcpy (ph - 4, \"...\");\n \t  break;\n \t}\n     }"}, {"sha": "2f6bda81385c7aedca0001d9b378ec5283a4c391", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c9c5e18883125c90b3cbdb61b651719253a0ff90", "patch": "@@ -1,3 +1,8 @@\n+2019-04-10  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c++/90010\n+\t* gcc.dg/pr90010.c: New test.\n+\n 2019-04-09  Uro\u0161 Bizjak  <ubizjak@gmail.com>\n \n \t* gcc.target/i386/ifcvt-onecmpl-abs-1.c"}, {"sha": "5cd5dd2deec9bd217334fcf9755cf776f6a710a3", "filename": "gcc/testsuite/gcc.dg/pr90010.c", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2Ftestsuite%2Fgcc.dg%2Fpr90010.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c9c5e18883125c90b3cbdb61b651719253a0ff90/gcc%2Ftestsuite%2Fgcc.dg%2Fpr90010.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr90010.c?ref=c9c5e18883125c90b3cbdb61b651719253a0ff90", "patch": "@@ -0,0 +1,27 @@\n+/* PR c++/90010 */\n+/* { dg-do compile } */\n+/* { dg-options \"-Wall\" } */\n+\n+char b[4096] = \"abc\";\n+void bar (char *);\n+\n+void\n+foo ()\n+{\n+  char d[4096];\n+  __builtin_snprintf (d, sizeof d, \"%sfoobarbazquxquuxquuzthudfred\", b);\t/* { dg-warning \"'foobarbazquxquuxquuzthudfred' directive output may be truncated writing 28 bytes into a region of size between 1 and 4096\" } */\n+  /* { dg-message \"'__builtin_snprintf' output between 29 and 4124 bytes into a destination of size 4096\" \"\" { target *-*-* } .-1 } */\n+  bar (d);\n+  __builtin_snprintf (d, sizeof d, \"%sfoobarbazquxquuxquuzcorgefred\", b);\t/* { dg-warning \"'foobarbazquxquuxquuzcorgefred' directive output may be truncated writing 29 bytes into a region of size between 1 and 4096\" } */\n+  /* { dg-message \"'__builtin_snprintf' output between 30 and 4125 bytes into a destination of size 4096\" \"\" { target *-*-* } .-1 } */\n+  bar (d);\n+  __builtin_snprintf (d, sizeof d, \"%sfoobarbazquxquuxquuzcorgewaldo\", b);\t/* { dg-warning \"'foobarbazquxquuxquuzcorgewaldo' directive output may be truncated writing 30 bytes into a region of size between 1 and 4096\" } */\n+  /* { dg-message \"'__builtin_snprintf' output between 31 and 4126 bytes into a destination of size 4096\" \"\" { target *-*-* } .-1 } */\n+  bar (d);\n+  __builtin_snprintf (d, sizeof d, \"%sfoobarbazquxquuxquuzcorgegarply\", b);\t/* { dg-warning \"'foobarbazquxquuxquuzcorgegarply' directive output may be truncated writing 31 bytes into a region of size between 1 and 4096\" } */\n+  /* { dg-message \"'__builtin_snprintf' output between 32 and 4127 bytes into a destination of size 4096\" \"\" { target *-*-* } .-1 } */\n+  bar (d);\n+  __builtin_snprintf (d, sizeof d, \"%sfoobarfredquxquuxquuzcorgegarply\", b);\t/* { dg-warning \"'foobarfredquxquuxquuzcorgega\\.\\.\\.' directive output may be truncated writing 32 bytes into a region of size between 1 and 4096\" } */\n+  /* { dg-message \"'__builtin_snprintf' output between 33 and 4128 bytes into a destination of size 4096\" \"\" { target *-*-* } .-1 } */\n+  bar (d);\n+}"}]}