{"sha": "56cfb59670621ffe7761eb200814dcc27d99cf63", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTZjZmI1OTY3MDYyMWZmZTc3NjFlYjIwMDgxNGRjYzI3ZDk5Y2Y2Mw==", "commit": {"author": {"name": "Patrick Palka", "email": "ppalka@gcc.gnu.org", "date": "2016-04-08T20:17:10Z"}, "committer": {"name": "Patrick Palka", "email": "ppalka@gcc.gnu.org", "date": "2016-04-08T20:17:10Z"}, "message": "Fix PR c++/70590 (error: location references block not in block tree)\n\ngcc/cp/ChangeLog:\n\n\tPR c++/70590\n\tPR c++/70452\n\t* constexpr.c (cxx_eval_outermost_expression): Call unshare_expr\n\ton the result if it's not a CONSTRUCTOR.\n\ngcc/testsuite/ChangeLog:\n\n\tPR c++/70590\n\tPR c++/70452\n\t* g++.dg/pr70590.C: New test.\n\t* g++.dg/pr70590-2.C: New test.\n\nFrom-SVN: r234837", "tree": {"sha": "e8e14a196ca10d04739f53b754414a46277ad80e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e8e14a196ca10d04739f53b754414a46277ad80e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/56cfb59670621ffe7761eb200814dcc27d99cf63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/56cfb59670621ffe7761eb200814dcc27d99cf63", "html_url": "https://github.com/Rust-GCC/gccrs/commit/56cfb59670621ffe7761eb200814dcc27d99cf63", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/56cfb59670621ffe7761eb200814dcc27d99cf63/comments", "author": null, "committer": null, "parents": [{"sha": "abc0647a4d9f9a7acf0fdf39e9abc2fe39c5948d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/abc0647a4d9f9a7acf0fdf39e9abc2fe39c5948d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/abc0647a4d9f9a7acf0fdf39e9abc2fe39c5948d"}], "stats": {"total": 69, "additions": 69, "deletions": 0}, "files": [{"sha": "1a690a9bc5bd79c25880cda9ddc7252fa98ac69a", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=56cfb59670621ffe7761eb200814dcc27d99cf63", "patch": "@@ -1,3 +1,10 @@\n+2016-04-08  Patrick Palka  <ppalka@gcc.gnu.org>\n+\n+\tPR c++/70590\n+\tPR c++/70452\n+\t* constexpr.c (cxx_eval_outermost_expression): Call unshare_expr\n+\ton the result if it's not a CONSTRUCTOR.\n+\n 2016-04-07  Patrick Palka  <ppalka@gcc.gnu.org>\n \n \tPR c++/70452"}, {"sha": "e6e2cf6ca5f05053ea8c5f33a2831de1712e4619", "filename": "gcc/cp/constexpr.c", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Fcp%2Fconstexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Fcp%2Fconstexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fconstexpr.c?ref=56cfb59670621ffe7761eb200814dcc27d99cf63", "patch": "@@ -4164,6 +4164,12 @@ cxx_eval_outermost_constant_expr (tree t, bool allow_non_constant,\n   if (!non_constant_p && overflow_p)\n     non_constant_p = true;\n \n+  /* Unshare the result unless it's a CONSTRUCTOR in which case it's already\n+     unshared.  */\n+  bool should_unshare = true;\n+  if (r == t || TREE_CODE (r) == CONSTRUCTOR)\n+    should_unshare = false;\n+\n   if (non_constant_p && !allow_non_constant)\n     return error_mark_node;\n   else if (non_constant_p && TREE_CONSTANT (r))\n@@ -4180,6 +4186,9 @@ cxx_eval_outermost_constant_expr (tree t, bool allow_non_constant,\n   else if (non_constant_p || r == t)\n     return t;\n \n+  if (should_unshare)\n+    r = unshare_expr (r);\n+\n   if (TREE_CODE (r) == CONSTRUCTOR && CLASS_TYPE_P (TREE_TYPE (r)))\n     {\n       if (TREE_CODE (t) == TARGET_EXPR"}, {"sha": "72f93e09803abe612e9de2c5ae7627b27d35d428", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=56cfb59670621ffe7761eb200814dcc27d99cf63", "patch": "@@ -1,3 +1,10 @@\n+2016-04-08  Patrick Palka  <ppalka@gcc.gnu.org>\n+\n+\tPR c++/70590\n+\tPR c++/70452\n+\t* g++.dg/pr70590.C: New test.\n+\t* g++.dg/pr70590-2.C: New test.\n+\n 2016-04-08  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR middle-end/70593"}, {"sha": "409c86eccd127e11546967659546bba061fc4d10", "filename": "gcc/testsuite/g++.dg/pr70590-2.C", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr70590-2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr70590-2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr70590-2.C?ref=56cfb59670621ffe7761eb200814dcc27d99cf63", "patch": "@@ -0,0 +1,21 @@\n+// PR c++/70590\n+// { dg-do compile { target c++11 } }\n+// { dg-options \"-O2\" }\n+\n+int a;\n+\n+constexpr int *foo = &a;\n+\n+void blah (int *);\n+\n+int\n+bar ()\n+{\n+  blah (foo);\n+}\n+\n+int\n+baz ()\n+{\n+  blah (foo);\n+}"}, {"sha": "488620065ee4f75cbee402d54aee741020df4ebe", "filename": "gcc/testsuite/g++.dg/pr70590.C", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr70590.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/56cfb59670621ffe7761eb200814dcc27d99cf63/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr70590.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fpr70590.C?ref=56cfb59670621ffe7761eb200814dcc27d99cf63", "patch": "@@ -0,0 +1,25 @@\n+// PR c++/70590\n+// { dg-do compile { target c++11 } }\n+// { dg-options \"-O2\" }\n+\n+int a;\n+\n+constexpr int *\n+foo ()\n+{\n+  return &a;\n+}\n+\n+void blah (int *);\n+\n+int\n+bar ()\n+{\n+  blah (foo ());\n+}\n+\n+int\n+baz ()\n+{\n+  blah (foo ());\n+}"}]}