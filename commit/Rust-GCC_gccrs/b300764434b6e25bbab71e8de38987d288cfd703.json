{"sha": "b300764434b6e25bbab71e8de38987d288cfd703", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjMwMDc2NDQzNGI2ZTI1YmJhYjcxZThkZTM4OTg3ZDI4OGNmZDcwMw==", "commit": {"author": {"name": "Paolo Bonzini", "email": "bonzini@gnu.org", "date": "2015-12-12T08:29:27Z"}, "committer": {"name": "Paolo Bonzini", "email": "bonzini@gcc.gnu.org", "date": "2015-12-12T08:29:27Z"}, "message": "re PR sanitizer/68418 (ubsan complains about left shifts even with -fwrapv)\n\ngcc:\n\tPR sanitizer/68418\n\t* c-family/c-ubsan.c (ubsan_instrument_shift): Disable\n\tsanitization of left shifts for wrapping signed types as well.\n\ngcc/testsuite:\n\tPR sanitizer/68418\n\t* gcc.dg/ubsan/c99-wrapv-shift-1.c,\n\tgcc.dg/ubsan/c99-wrapv-shift-2.c: New testcases.\n\nFrom-SVN: r231582", "tree": {"sha": "c6d37a44fa512582906ef96d63d3924eaf03937f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c6d37a44fa512582906ef96d63d3924eaf03937f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b300764434b6e25bbab71e8de38987d288cfd703", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b300764434b6e25bbab71e8de38987d288cfd703", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b300764434b6e25bbab71e8de38987d288cfd703", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b300764434b6e25bbab71e8de38987d288cfd703/comments", "author": {"login": "bonzini", "id": 42082, "node_id": "MDQ6VXNlcjQyMDgy", "avatar_url": "https://avatars.githubusercontent.com/u/42082?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bonzini", "html_url": "https://github.com/bonzini", "followers_url": "https://api.github.com/users/bonzini/followers", "following_url": "https://api.github.com/users/bonzini/following{/other_user}", "gists_url": "https://api.github.com/users/bonzini/gists{/gist_id}", "starred_url": "https://api.github.com/users/bonzini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bonzini/subscriptions", "organizations_url": "https://api.github.com/users/bonzini/orgs", "repos_url": "https://api.github.com/users/bonzini/repos", "events_url": "https://api.github.com/users/bonzini/events{/privacy}", "received_events_url": "https://api.github.com/users/bonzini/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "aa31006f5d68298d48dee002d57c7af1ac1ec438", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aa31006f5d68298d48dee002d57c7af1ac1ec438", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aa31006f5d68298d48dee002d57c7af1ac1ec438"}], "stats": {"total": 45, "additions": 39, "deletions": 6}, "files": [{"sha": "6d03e1e74f63fca94d9e009ffb61cdd2080a19ef", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=b300764434b6e25bbab71e8de38987d288cfd703", "patch": "@@ -1,3 +1,9 @@\n+2015-12-12  Paolo Bonzini  <bonzini@gnu.org>\n+\n+\tPR sanitizer/68418\n+\t* c-family/c-ubsan.c (ubsan_instrument_shift): Disable\n+\tsanitization of left shifts for wrapping signed types as well.\n+\n 2015-12-11  Eric Botcazou  <ebotcazou@adacore.com>\n \n \tPR middle-end/68215"}, {"sha": "c09a56f04bad279e94c284235cc63ea0b13207cf", "filename": "gcc/c-family/c-ubsan.c", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Fc-family%2Fc-ubsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Fc-family%2Fc-ubsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-ubsan.c?ref=b300764434b6e25bbab71e8de38987d288cfd703", "patch": "@@ -124,12 +124,17 @@ ubsan_instrument_shift (location_t loc, enum tree_code code,\n   t = fold_convert_loc (loc, op1_utype, op1);\n   t = fold_build2 (GT_EXPR, boolean_type_node, t, uprecm1);\n \n+  /* If this is not a signed operation, don't perform overflow checks.\n+     Also punt on bit-fields.  */\n+  if (!INTEGRAL_TYPE_P (type0)\n+      || TYPE_OVERFLOW_WRAPS (type0)\n+      || GET_MODE_BITSIZE (TYPE_MODE (type0)) != TYPE_PRECISION (type0))\n+    ;\n+\n   /* For signed x << y, in C99/C11, the following:\n      (unsigned) x >> (uprecm1 - y)\n      if non-zero, is undefined.  */\n-  if (code == LSHIFT_EXPR\n-      && !TYPE_UNSIGNED (type0)\n-      && flag_isoc99)\n+  else if (code == LSHIFT_EXPR && flag_isoc99 && cxx_dialect < cxx11)\n     {\n       tree x = fold_build2 (MINUS_EXPR, op1_utype, uprecm1,\n \t\t\t    fold_convert (op1_utype, unshare_expr (op1)));\n@@ -142,9 +147,7 @@ ubsan_instrument_shift (location_t loc, enum tree_code code,\n   /* For signed x << y, in C++11 and later, the following:\n      x < 0 || ((unsigned) x >> (uprecm1 - y))\n      if > 1, is undefined.  */\n-  if (code == LSHIFT_EXPR\n-      && !TYPE_UNSIGNED (type0)\n-      && (cxx_dialect >= cxx11))\n+  else if (code == LSHIFT_EXPR && cxx_dialect >= cxx11)\n     {\n       tree x = fold_build2 (MINUS_EXPR, op1_utype, uprecm1,\n \t\t\t    fold_convert (op1_utype, unshare_expr (op1)));"}, {"sha": "240bd5ddd5b17787f961494ad5800394c0440711", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b300764434b6e25bbab71e8de38987d288cfd703", "patch": "@@ -1,3 +1,9 @@\n+2015-12-12  Paolo Bonzini  <bonzini@gnu.org>\n+\n+\tPR sanitizer/68418\n+\t* gcc.dg/ubsan/c99-wrapv-shift-1.c,\n+\tgcc.dg/ubsan/c99-wrapv-shift-2.c: New testcases.\n+\n 2015-12-11  Jeff Law  <law@redhat.com>\n \n \tPR tree-optimization/68844"}, {"sha": "51910da2c80369b50110e006528278b1905423a4", "filename": "gcc/testsuite/gcc.dg/ubsan/c99-wrapv-shift-1.c", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Ftestsuite%2Fgcc.dg%2Fubsan%2Fc99-wrapv-shift-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Ftestsuite%2Fgcc.dg%2Fubsan%2Fc99-wrapv-shift-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fubsan%2Fc99-wrapv-shift-1.c?ref=b300764434b6e25bbab71e8de38987d288cfd703", "patch": "@@ -0,0 +1,9 @@\n+/* { dg-do run } */\n+/* { dg-options \"-fsanitize=shift -fwrapv -w -std=c99\" } */\n+\n+int\n+main (void)\n+{\n+  int a = -42;\n+  a << 1;\n+}"}, {"sha": "93087d1e817bcd09aa4b205a146559f9ac49b0c8", "filename": "gcc/testsuite/gcc.dg/ubsan/c99-wrapv-shift-2.c", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Ftestsuite%2Fgcc.dg%2Fubsan%2Fc99-wrapv-shift-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b300764434b6e25bbab71e8de38987d288cfd703/gcc%2Ftestsuite%2Fgcc.dg%2Fubsan%2Fc99-wrapv-shift-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fubsan%2Fc99-wrapv-shift-2.c?ref=b300764434b6e25bbab71e8de38987d288cfd703", "patch": "@@ -0,0 +1,9 @@\n+/* { dg-do run } */\n+/* { dg-options \"-fsanitize=shift -fwrapv -w -std=c99\" } */\n+\n+int\n+main (void)\n+{\n+  int a = 1;\n+  a <<= 31;\n+}"}]}