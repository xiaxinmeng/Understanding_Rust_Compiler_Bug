{"sha": "853ce8eea4ff97850a987167e603387b3d0f1401", "node_id": "C_kwDOANBUbNoAKDg1M2NlOGVlYTRmZjk3ODUwYTk4NzE2N2U2MDMzODdiM2QwZjE0MDE", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2022-10-05T10:21:03Z"}, "committer": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2022-10-05T11:48:57Z"}, "message": "Fix bogus -Wstringop-overflow warning in Ada\n\nIt comes from a discrepancy between get_offset_range, which uses a signed\ntype, and handle_array_ref, which uses an unsigned one, to do computations.\n\ngcc/\n\tPR tree-optimization/106698\n\t* pointer-query.cc (handle_array_ref): Fix handling of low bound.\n\ngcc/testsuite/\n\t* gnat.dg/lto26.adb: New test.\n\t* gnat.dg/lto26_pkg1.ads, gnat.dg/lto26_pkg1.adb: New helper.\n\t* gnat.dg/lto26_pkg2.ads, gnat.dg/lto26_pkg2.adb: Likewise.", "tree": {"sha": "e3491bc0be8ba478000800fc3038f91b25a72baf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e3491bc0be8ba478000800fc3038f91b25a72baf"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/853ce8eea4ff97850a987167e603387b3d0f1401", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/853ce8eea4ff97850a987167e603387b3d0f1401", "html_url": "https://github.com/Rust-GCC/gccrs/commit/853ce8eea4ff97850a987167e603387b3d0f1401", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/853ce8eea4ff97850a987167e603387b3d0f1401/comments", "author": null, "committer": null, "parents": [{"sha": "bcc27369910b818047bca466fbcef6a3034dfc7f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bcc27369910b818047bca466fbcef6a3034dfc7f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bcc27369910b818047bca466fbcef6a3034dfc7f"}], "stats": {"total": 78, "additions": 71, "deletions": 7}, "files": [{"sha": "0f0100233c1ef58a089d3dfa7170230f7dc7df7f", "filename": "gcc/pointer-query.cc", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Fpointer-query.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Fpointer-query.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fpointer-query.cc?ref=853ce8eea4ff97850a987167e603387b3d0f1401", "patch": "@@ -1796,14 +1796,19 @@ handle_array_ref (tree aref, gimple *stmt, bool addr, int ostype,\n       orng[0] = -orng[1] - 1;\n     }\n \n-  /* Convert the array index range determined above to a byte\n-     offset.  */\n+  /* Convert the array index range determined above to a byte offset.  */\n   tree lowbnd = array_ref_low_bound (aref);\n-  if (!integer_zerop (lowbnd) && tree_fits_uhwi_p (lowbnd))\n-    {\n-      /* Adjust the index by the low bound of the array domain\n-\t (normally zero but 1 in Fortran).  */\n-      unsigned HOST_WIDE_INT lb = tree_to_uhwi (lowbnd);\n+  if (TREE_CODE (lowbnd) == INTEGER_CST && !integer_zerop (lowbnd))\n+    {\n+      /* Adjust the index by the low bound of the array domain (0 in C/C++,\n+\t 1 in Fortran and anything in Ada) by applying the same processing\n+\t as in get_offset_range.  */\n+      const wide_int wlb = wi::to_wide (lowbnd);\n+      signop sgn = SIGNED;\n+      if (TYPE_UNSIGNED (TREE_TYPE (lowbnd))\n+\t  && wlb.get_precision () < TYPE_PRECISION (sizetype))\n+\tsgn = UNSIGNED;\n+      const offset_int lb = offset_int::from (wlb, sgn);\n       orng[0] -= lb;\n       orng[1] -= lb;\n     }"}, {"sha": "a27348b2e7fabfc99bc161fc54cfb5a48e69dda6", "filename": "gcc/testsuite/gnat.dg/lto26.adb", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flto26.adb?ref=853ce8eea4ff97850a987167e603387b3d0f1401", "patch": "@@ -0,0 +1,13 @@\n+-- { dg-do run }\n+-- { dg-options \"-O2 -flto\" { target lto } }\n+\n+with Ada.Streams; use Ada.Streams;\n+with Lto26_Pkg1; use Lto26_Pkg1;\n+\n+procedure Lto26 is\n+  R : Rec;\n+begin\n+  for I in 1 .. 10 loop\n+    Set (R, (7, 0, 84, Stream_Element (I), 0, 0, 0), 1);\n+  end loop;\n+end;"}, {"sha": "c68b134ffaa4ad3ada9b7b76282c0a5827d154cf", "filename": "gcc/testsuite/gnat.dg/lto26_pkg1.adb", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg1.adb?ref=853ce8eea4ff97850a987167e603387b3d0f1401", "patch": "@@ -0,0 +1,11 @@\n+with Lto26_Pkg2; use Lto26_Pkg2;\n+\n+package body Lto26_Pkg1 is\n+\n+  procedure Set (R : Rec; A : Stream_Element_Array; C :Unsigned_8) is\n+    procedure My_Build is new Build;\n+  begin\n+     My_Build (A, C);\n+  end;\n+\n+end Lto26_Pkg1;"}, {"sha": "527974750b02ddd24ef6ecf9e95ed22fd3b5ccb1", "filename": "gcc/testsuite/gnat.dg/lto26_pkg1.ads", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg1.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg1.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg1.ads?ref=853ce8eea4ff97850a987167e603387b3d0f1401", "patch": "@@ -0,0 +1,11 @@\n+with Ada.Finalization;\n+with Ada.Streams;  use Ada.Streams;\n+with Interfaces; use Interfaces;\n+\n+package Lto26_Pkg1 is\n+\n+  type Rec is new Ada.Finalization.Limited_Controlled with null record;\n+\n+  procedure Set (R : Rec; A : Stream_Element_Array; C :Unsigned_8);\n+\n+end Lto26_Pkg1;"}, {"sha": "9f897334d25a3055656447ca33332d406fb6cf50", "filename": "gcc/testsuite/gnat.dg/lto26_pkg2.adb", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg2.adb?ref=853ce8eea4ff97850a987167e603387b3d0f1401", "patch": "@@ -0,0 +1,15 @@\n+package body Lto26_Pkg2 is\n+\n+  procedure Build (A : Stream_Element_Array; C : Unsigned_8) is\n+    Start  : Stream_Element_Offset := A'First;\n+    Next   : Stream_Element_Offset;\n+    Length : Unsigned_8;\n+  begin\n+    for I in 1 .. C loop\n+      Length := Unsigned_8 (A (A'First));\n+      Next   := Start + Stream_Element_Offset (Length);\n+      Start  := Next;\n+    end loop;\n+  end;\n+\n+end Lto26_Pkg2;"}, {"sha": "68741bb8d8b71d534eed2b7bdcf38d0a52bb6cc4", "filename": "gcc/testsuite/gnat.dg/lto26_pkg2.ads", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg2.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/853ce8eea4ff97850a987167e603387b3d0f1401/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg2.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flto26_pkg2.ads?ref=853ce8eea4ff97850a987167e603387b3d0f1401", "patch": "@@ -0,0 +1,9 @@\n+with Ada.Streams; use Ada.Streams;\n+with Interfaces; use Interfaces;\n+\n+package Lto26_Pkg2 is\n+\n+  generic\n+  procedure Build (A : Stream_Element_Array; C : Unsigned_8);\n+\n+end Lto26_Pkg2;"}]}