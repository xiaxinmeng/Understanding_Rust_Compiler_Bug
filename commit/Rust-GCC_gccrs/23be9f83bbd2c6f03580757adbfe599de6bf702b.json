{"sha": "23be9f83bbd2c6f03580757adbfe599de6bf702b", "node_id": "C_kwDOANBUbNoAKDIzYmU5ZjgzYmJkMmM2ZjAzNTgwNzU3YWRiZmU1OTlkZTZiZjcwMmI", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2022-01-21T16:16:49Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2022-01-21T17:06:18Z"}, "message": "c++: [[no_unique_address]] and virtual base [PR104139]\n\nFixing a thinko in my patch for 103681: when computing the size of a virtual\nbase, it would help to use its binfo instead of the one for the derived\nclass.\n\n\tPR c++/104139\n\tPR c++/103681\n\ngcc/cp/ChangeLog:\n\n\t* class.cc (end_of_class): Use base_binfo.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/abi/no_unique_address2.C: Adjust to detect this on x86-64.", "tree": {"sha": "93937d4a30606234ded38f014574e638855c8354", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/93937d4a30606234ded38f014574e638855c8354"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/23be9f83bbd2c6f03580757adbfe599de6bf702b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/23be9f83bbd2c6f03580757adbfe599de6bf702b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/23be9f83bbd2c6f03580757adbfe599de6bf702b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/23be9f83bbd2c6f03580757adbfe599de6bf702b/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45cae5b6392496028f35c5948f7fae0af81d135b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/45cae5b6392496028f35c5948f7fae0af81d135b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/45cae5b6392496028f35c5948f7fae0af81d135b"}], "stats": {"total": 31, "additions": 29, "deletions": 2}, "files": [{"sha": "5db3722ae46c48a9f4b9adc767daa684ab9a2cb0", "filename": "gcc/cp/class.cc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/23be9f83bbd2c6f03580757adbfe599de6bf702b/gcc%2Fcp%2Fclass.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/23be9f83bbd2c6f03580757adbfe599de6bf702b/gcc%2Fcp%2Fclass.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.cc?ref=23be9f83bbd2c6f03580757adbfe599de6bf702b", "patch": "@@ -6414,8 +6414,8 @@ end_of_class (tree t, eoc_mode mode)\n       {\n \tif (mode == eoc_nv_or_dsize)\n \t  /* For dsize, don't count trailing empty bases.  */\n-\t  offset = size_binop (PLUS_EXPR, BINFO_OFFSET (binfo),\n-\t\t\t       CLASSTYPE_SIZE_UNIT (BINFO_TYPE (binfo)));\n+\t  offset = size_binop (PLUS_EXPR, BINFO_OFFSET (base_binfo),\n+\t\t\t       CLASSTYPE_SIZE_UNIT (BINFO_TYPE (base_binfo)));\n \telse\n \t  offset = end_of_base (base_binfo);\n \tif (tree_int_cst_lt (result, offset))"}, {"sha": "3bb3f76ac920041545d2be794af0f63dfcb8c955", "filename": "gcc/testsuite/g++.dg/abi/no_unique_address2.C", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/23be9f83bbd2c6f03580757adbfe599de6bf702b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fno_unique_address2.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/23be9f83bbd2c6f03580757adbfe599de6bf702b/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fno_unique_address2.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fabi%2Fno_unique_address2.C?ref=23be9f83bbd2c6f03580757adbfe599de6bf702b", "patch": "@@ -41,3 +41,30 @@ struct B4\n #define SA(X) static_assert ((X), #X)\n SA (sizeof (B2) == sizeof (B1));\n SA (sizeof (B3) == sizeof (B4));\n+\n+namespace N2\n+{\n+  // C as big as _vptr to test PR c++/104139\n+  struct C\n+  {\n+    long c;\n+  };\n+\n+  struct D: virtual C\n+  {\n+    virtual void f();\n+  };\n+\n+  struct B3: D\n+  {\n+    char c2;\n+  };\n+\n+  struct B4\n+  {\n+    D d [[no_unique_address]];\n+    char c2;\n+  };\n+\n+  SA (sizeof (B3) == sizeof (B4));\n+}"}]}