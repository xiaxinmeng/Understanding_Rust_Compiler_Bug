{"sha": "68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjhlZDJiYTBhN2Q2MDI3NWFjMDQ0YTRjYjUwYjMzZWIzM2ZiYjgxMw==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-03-22T18:45:48Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-03-22T18:45:48Z"}, "message": "re PR c++/80129 (wrong code with ternary struct assignment to const)\n\n\tPR c++/80129\n\t* gimplify.c (gimplify_modify_expr_rhs) <case COND_EXPR>: Clear\n\tTREE_READONLY on result if writing it more than once.\n\n\t* g++.dg/torture/pr80129.C: New test.\n\nFrom-SVN: r246401", "tree": {"sha": "1e4f17b8856d8dc6d804ba411cf9c40568e61ca9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1e4f17b8856d8dc6d804ba411cf9c40568e61ca9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "html_url": "https://github.com/Rust-GCC/gccrs/commit/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "0e2468e0ca0ad2e7adc0098f6a4061be7475fdc1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0e2468e0ca0ad2e7adc0098f6a4061be7475fdc1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0e2468e0ca0ad2e7adc0098f6a4061be7475fdc1"}], "stats": {"total": 29, "additions": 29, "deletions": 0}, "files": [{"sha": "5259dce80a509b98afa9c695b96a614798897e46", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "patch": "@@ -1,5 +1,9 @@\n 2017-03-22  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/80129\n+\t* gimplify.c (gimplify_modify_expr_rhs) <case COND_EXPR>: Clear\n+\tTREE_READONLY on result if writing it more than once.\n+\n \tPR sanitizer/80110\n \t* doc/invoke.texi (-fsanitize=thread): Document that with\n \t-fnon-call-exceptions atomics are not able to throw"}, {"sha": "f90ae94bc6960b25e0018bc2bb68a3a5a06adfcb", "filename": "gcc/gimplify.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2Fgimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2Fgimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimplify.c?ref=68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "patch": "@@ -5098,6 +5098,14 @@ gimplify_modify_expr_rhs (tree *expr_p, tree *from_p, tree *to_p,\n \t      if (ret != GS_ERROR)\n \t\tret = GS_OK;\n \n+\t      /* If we are going to write RESULT more than once, clear\n+\t\t TREE_READONLY flag, otherwise we might incorrectly promote\n+\t\t the variable to static const and initialize it at compile\n+\t\t time in one of the branches.  */\n+\t      if (VAR_P (result)\n+\t\t  && TREE_TYPE (TREE_OPERAND (cond, 1)) != void_type_node\n+\t\t  && TREE_TYPE (TREE_OPERAND (cond, 2)) != void_type_node)\n+\t\tTREE_READONLY (result) = 0;\n \t      if (TREE_TYPE (TREE_OPERAND (cond, 1)) != void_type_node)\n \t\tTREE_OPERAND (cond, 1)\n \t\t  = build2 (code, void_type_node, result,"}, {"sha": "add3a14eca52c728239546fef1fab4583f294b30", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "patch": "@@ -1,5 +1,8 @@\n 2017-03-22  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR c++/80129\n+\t* g++.dg/torture/pr80129.C: New test.\n+\n \tPR sanitizer/80110\n \t* g++.dg/tsan/pr80110.C: New test.\n "}, {"sha": "134293cd08554a27bc700584849ba7681b1f964e", "filename": "gcc/testsuite/g++.dg/torture/pr80129.C", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fpr80129.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/68ed2ba0a7d60275ac044a4cb50b33eb33fbb813/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fpr80129.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Ftorture%2Fpr80129.C?ref=68ed2ba0a7d60275ac044a4cb50b33eb33fbb813", "patch": "@@ -0,0 +1,14 @@\n+// PR c++/80129\n+// { dg-do run }\n+// { dg-options \"-std=c++11\" }\n+\n+struct A { bool a; int b; };\n+\n+int\n+main ()\n+{\n+  bool c = false;\n+  const A x = c ? A {true, 1} : A {false, 0};\n+  if (x.a)\n+    __builtin_abort ();\n+}"}]}