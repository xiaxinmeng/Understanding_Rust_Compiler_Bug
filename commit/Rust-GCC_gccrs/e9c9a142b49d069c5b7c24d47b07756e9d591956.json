{"sha": "e9c9a142b49d069c5b7c24d47b07756e9d591956", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTljOWExNDJiNDlkMDY5YzViN2MyNGQ0N2IwNzc1NmU5ZDU5MTk1Ng==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2019-10-01T21:58:17Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2019-10-01T21:58:17Z"}, "message": "Support prefixes in diagnostic_show_locus\n\nPreviously, diagnostic_show_locus saved and restored the pretty_printer's\nprefix, clearing it for the duration of the call.\n\nI have a patch kit in development that can benefit from applying a prefix\nto the output of d_s_l, so this patch adds support to d_s_l for printing\nsuch prefixes.\n\nIt moves the save and restore of the pp's prefix from d_s_l to all of its\ncallers, and updates diagnostic-show-locus.c to properly handle prefixes.\n\ngcc/c-family/ChangeLog:\n\t* c-opts.c (c_diagnostic_finalizer): Temporarily clear prefix when\n\tcalling diagnostic_show_locus, rather than destroying it afterwards.\n\ngcc/ChangeLog:\n\t* diagnostic-show-locus.c (layout::print_gap_in_line_numbering):\n\tCall pp_emit_prefix.\n\t(layout::print_source_line): Likewise.\n\t(layout::start_annotation_line): Likewise.\n\t(diagnostic_show_locus): Remove call to temporarily clear the\n\tprefix.\n\t(selftest::test_one_liner_fixit_remove): Add test coverage for the\n\tinteraction of pp_set_prefix with rulers and fix-it hints.\n\t* diagnostic.c (default_diagnostic_finalizer): Temporarily clear\n\tprefix when calling diagnostic_show_locus, rather than destroying\n\tit afterwards.\n\t(print_parseable_fixits): Temporarily clear prefix.\n\t* pretty-print.c (pp_format): Save and restore line_length, rather\n\tthan assuming it is zero.\n\t(pp_output_formatted_text): Remove assertion that line_length is\n\tzero.\n\ngcc/fortran/ChangeLog:\n\t* error.c (gfc_diagnostic_starter): Clear the prefix before\n\tcalling diagnostic_show_locus.\n\ngcc/testsuite/ChangeLog:\n\t* gcc.dg/plugin/diagnostic_group_plugin.c (test_begin_group_cb):\n\tClear the prefix before emitting the \"END GROUP\" line.\n\t* gcc.dg/plugin/diagnostic_plugin_test_show_locus.c\n\t(custom_diagnostic_finalizer): Temporarily clear prefix when\n\tcalling diagnostic_show_locus, rather than destroying it\n\tafterwards.\n\nFrom-SVN: r276433", "tree": {"sha": "1733bd2afdb942dcf5381fec2e6e5d79071d9db8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1733bd2afdb942dcf5381fec2e6e5d79071d9db8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e9c9a142b49d069c5b7c24d47b07756e9d591956", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e9c9a142b49d069c5b7c24d47b07756e9d591956", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e9c9a142b49d069c5b7c24d47b07756e9d591956", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e9c9a142b49d069c5b7c24d47b07756e9d591956/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "a16bc2f317ddfeb45a6b293aec4d89afe0e79a72", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a16bc2f317ddfeb45a6b293aec4d89afe0e79a72", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a16bc2f317ddfeb45a6b293aec4d89afe0e79a72"}], "stats": {"total": 158, "additions": 139, "deletions": 19}, "files": [{"sha": "b3a42ae4ef2008606f1f7c77aa1fe193a6ada75a", "filename": "gcc/ChangeLog", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1,3 +1,22 @@\n+2019-10-01  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* diagnostic-show-locus.c (layout::print_gap_in_line_numbering):\n+\tCall pp_emit_prefix.\n+\t(layout::print_source_line): Likewise.\n+\t(layout::start_annotation_line): Likewise.\n+\t(diagnostic_show_locus): Remove call to temporarily clear the\n+\tprefix.\n+\t(selftest::test_one_liner_fixit_remove): Add test coverage for the\n+\tinteraction of pp_set_prefix with rulers and fix-it hints.\n+\t* diagnostic.c (default_diagnostic_finalizer): Temporarily clear\n+\tprefix when calling diagnostic_show_locus, rather than destroying\n+\tit afterwards.\n+\t(print_parseable_fixits): Temporarily clear prefix.\n+\t* pretty-print.c (pp_format): Save and restore line_length, rather\n+\tthan assuming it is zero.\n+\t(pp_output_formatted_text): Remove assertion that line_length is\n+\tzero.\n+\n 2019-10-01  Jan Hubicka  <hubicka@ucw.cz>\n \n \t* tree-ssa-alias.c (nonoverlapping_component_refs_since_match_p):"}, {"sha": "0eade3cf8d8baa5f2bbe5bc030735c9df69c0d14", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1,3 +1,8 @@\n+2019-10-01  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* c-opts.c (c_diagnostic_finalizer): Temporarily clear prefix when\n+\tcalling diagnostic_show_locus, rather than destroying it afterwards.\n+\n 2019-10-01  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/91925"}, {"sha": "949d96a78396e6577b9af27f89d07dc6e488ab63", "filename": "gcc/c-family/c-opts.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fc-family%2Fc-opts.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fc-family%2Fc-opts.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-opts.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -168,11 +168,13 @@ c_diagnostic_finalizer (diagnostic_context *context,\n \t\t\tdiagnostic_info *diagnostic,\n \t\t\tdiagnostic_t)\n {\n+  char *saved_prefix = pp_take_prefix (context->printer);\n+  pp_set_prefix (context->printer, NULL);\n   diagnostic_show_locus (context, diagnostic->richloc, diagnostic->kind);\n   /* By default print macro expansion contexts in the diagnostic\n      finalizer -- for tokens resulting from macro expansion.  */\n   virt_loc_aware_diagnostic_finalizer (context, diagnostic);\n-  pp_destroy_prefix (context->printer);\n+  pp_set_prefix (context->printer, saved_prefix);\n   pp_flush (context->printer);\n }\n "}, {"sha": "cb920f6b9d0d177659d15cffff2c43fbdce31897", "filename": "gcc/diagnostic-show-locus.c", "status": "modified", "additions": 83, "deletions": 13, "changes": 96, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fdiagnostic-show-locus.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fdiagnostic-show-locus.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdiagnostic-show-locus.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1039,6 +1039,8 @@ layout::print_gap_in_line_numbering ()\n {\n   gcc_assert (m_show_line_numbers_p);\n \n+  pp_emit_prefix (m_pp);\n+\n   for (int i = 0; i < m_linenum_width + 1; i++)\n     pp_character (m_pp, '.');\n \n@@ -1266,6 +1268,8 @@ layout::print_source_line (linenum_type row, const char *line, int line_width,\n \t\t\t\t\t\t\t   line_width);\n   line += m_x_offset;\n \n+  pp_emit_prefix (m_pp);\n+\n   if (m_show_line_numbers_p)\n     {\n       int width = num_digits (row);\n@@ -1346,6 +1350,7 @@ layout::should_print_annotation_line_p (linenum_type row) const\n void\n layout::start_annotation_line (char margin_char) const\n {\n+  pp_emit_prefix (m_pp);\n   if (m_show_line_numbers_p)\n     {\n       /* Print the margin.  If MARGIN_CHAR != ' ', then print up to 3\n@@ -2297,9 +2302,6 @@ diagnostic_show_locus (diagnostic_context * context,\n \n   context->last_location = loc;\n \n-  char *saved_prefix = pp_take_prefix (context->printer);\n-  pp_set_prefix (context->printer, NULL);\n-\n   layout layout (context, richloc, diagnostic_kind);\n   for (int line_span_idx = 0; line_span_idx < layout.get_num_line_spans ();\n        line_span_idx++)\n@@ -2329,8 +2331,6 @@ diagnostic_show_locus (diagnostic_context * context,\n \t   row <= last_line; row++)\n \tlayout.print_line (row);\n     }\n-\n-  pp_set_prefix (context->printer, saved_prefix);\n }\n \n #if CHECKING_P\n@@ -2463,23 +2463,93 @@ test_one_liner_fixit_insert_after ()\n \t\tpp_formatted_text (dc.printer));\n }\n \n-/* Removal fix-it hint: removal of the \".field\". */\n+/* Removal fix-it hint: removal of the \".field\".\n+   Also verify the interaction of pp_set_prefix with rulers and\n+   fix-it hints.  */\n \n static void\n test_one_liner_fixit_remove ()\n {\n-  test_diagnostic_context dc;\n   location_t start = linemap_position_for_column (line_table, 10);\n   location_t finish = linemap_position_for_column (line_table, 15);\n   location_t dot = make_location (start, start, finish);\n   rich_location richloc (line_table, dot);\n   richloc.add_fixit_remove ();\n-  diagnostic_show_locus (&dc, &richloc, DK_ERROR);\n-  ASSERT_STREQ (\"\\n\"\n-\t\t\" foo = bar.field;\\n\"\n-\t\t\"          ^~~~~~\\n\"\n-\t\t\"          ------\\n\",\n-\t\tpp_formatted_text (dc.printer));\n+\n+  /* Normal.  */\n+  {\n+    test_diagnostic_context dc;\n+    diagnostic_show_locus (&dc, &richloc, DK_ERROR);\n+    ASSERT_STREQ (\"\\n\"\n+\t\t  \" foo = bar.field;\\n\"\n+\t\t  \"          ^~~~~~\\n\"\n+\t\t  \"          ------\\n\",\n+\t\t  pp_formatted_text (dc.printer));\n+  }\n+\n+  /* Test of adding a prefix.  */\n+  {\n+    test_diagnostic_context dc;\n+    pp_prefixing_rule (dc.printer) = DIAGNOSTICS_SHOW_PREFIX_EVERY_LINE;\n+    pp_set_prefix (dc.printer, xstrdup (\"TEST PREFIX:\"));\n+    diagnostic_show_locus (&dc, &richloc, DK_ERROR);\n+    ASSERT_STREQ (\"\\n\"\n+\t\t  \"TEST PREFIX: foo = bar.field;\\n\"\n+\t\t  \"TEST PREFIX:          ^~~~~~\\n\"\n+\t\t  \"TEST PREFIX:          ------\\n\",\n+\t\t  pp_formatted_text (dc.printer));\n+  }\n+\n+  /* Normal, with ruler.  */\n+  {\n+    test_diagnostic_context dc;\n+    dc.show_ruler_p = true;\n+    dc.caret_max_width = 104;\n+    diagnostic_show_locus (&dc, &richloc, DK_ERROR);\n+    ASSERT_STREQ (\"\\n\"\n+\t\t  \"          0         0         0         0         0         0         0         0         0         1    \\n\"\n+\t\t  \"          1         2         3         4         5         6         7         8         9         0    \\n\"\n+\t\t  \" 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234\\n\"\n+\t\t  \" foo = bar.field;\\n\"\n+\t\t  \"          ^~~~~~\\n\"\n+\t\t  \"          ------\\n\",\n+\t\t  pp_formatted_text (dc.printer));\n+  }\n+\n+  /* Test of adding a prefix, with ruler.  */\n+  {\n+    test_diagnostic_context dc;\n+    dc.show_ruler_p = true;\n+    dc.caret_max_width = 50;\n+    pp_prefixing_rule (dc.printer) = DIAGNOSTICS_SHOW_PREFIX_EVERY_LINE;\n+    pp_set_prefix (dc.printer, xstrdup (\"TEST PREFIX:\"));\n+    diagnostic_show_locus (&dc, &richloc, DK_ERROR);\n+    ASSERT_STREQ (\"\\n\"\n+\t\t  \"TEST PREFIX:          1         2         3         4         5\\n\"\n+\t\t  \"TEST PREFIX: 12345678901234567890123456789012345678901234567890\\n\"\n+\t\t  \"TEST PREFIX: foo = bar.field;\\n\"\n+\t\t  \"TEST PREFIX:          ^~~~~~\\n\"\n+\t\t  \"TEST PREFIX:          ------\\n\",\n+\t\t  pp_formatted_text (dc.printer));\n+  }\n+\n+  /* Test of adding a prefix, with ruler and line numbers.  */\n+  {\n+    test_diagnostic_context dc;\n+    dc.show_ruler_p = true;\n+    dc.caret_max_width = 50;\n+    dc.show_line_numbers_p = true;\n+    pp_prefixing_rule (dc.printer) = DIAGNOSTICS_SHOW_PREFIX_EVERY_LINE;\n+    pp_set_prefix (dc.printer, xstrdup (\"TEST PREFIX:\"));\n+    diagnostic_show_locus (&dc, &richloc, DK_ERROR);\n+    ASSERT_STREQ (\"\\n\"\n+\t\t  \"TEST PREFIX:      |          1         2         3         4         5\\n\"\n+\t\t  \"TEST PREFIX:      | 12345678901234567890123456789012345678901234567890\\n\"\n+\t\t  \"TEST PREFIX:    1 | foo = bar.field;\\n\"\n+\t\t  \"TEST PREFIX:      |          ^~~~~~\\n\"\n+\t\t  \"TEST PREFIX:      |          ------\\n\",\n+\t\t  pp_formatted_text (dc.printer));\n+  }\n }\n \n /* Replace fix-it hint: replacing \"field\" with \"m_field\". */"}, {"sha": "1b3306cd73e6dbd7e053934926dfde6ddb168bfe", "filename": "gcc/diagnostic.c", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fdiagnostic.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fdiagnostic.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdiagnostic.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -663,8 +663,10 @@ default_diagnostic_finalizer (diagnostic_context *context,\n \t\t\t      diagnostic_info *diagnostic,\n \t\t\t      diagnostic_t)\n {\n+  char *saved_prefix = pp_take_prefix (context->printer);\n+  pp_set_prefix (context->printer, NULL);\n   diagnostic_show_locus (context, diagnostic->richloc, diagnostic->kind);\n-  pp_destroy_prefix (context->printer);\n+  pp_set_prefix (context->printer, saved_prefix);\n   pp_flush (context->printer);\n }\n \n@@ -811,6 +813,9 @@ print_parseable_fixits (pretty_printer *pp, rich_location *richloc)\n   gcc_assert (pp);\n   gcc_assert (richloc);\n \n+  char *saved_prefix = pp_take_prefix (pp);\n+  pp_set_prefix (pp, NULL);\n+\n   for (unsigned i = 0; i < richloc->get_num_fixit_hints (); i++)\n     {\n       const fixit_hint *hint = richloc->get_fixit_hint (i);\n@@ -827,6 +832,8 @@ print_parseable_fixits (pretty_printer *pp, rich_location *richloc)\n       print_escaped_string (pp, hint->get_string ());\n       pp_newline (pp);\n     }\n+\n+  pp_set_prefix (pp, saved_prefix);\n }\n \n /* Update the diag_class of DIAGNOSTIC based on its location"}, {"sha": "63ee15bfc7013d98b28ea467bea154ae8778564c", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1,3 +1,8 @@\n+2019-10-01  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* error.c (gfc_diagnostic_starter): Clear the prefix before\n+\tcalling diagnostic_show_locus.\n+\n 2019-09-29  Steven G. Kargl  <kargl@gcc.gnu.org>\n \n \tPR fortran/91641"}, {"sha": "a7c27f0c3fe28910cfa22ad42ad90bba26c93ba4", "filename": "gcc/fortran/error.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ffortran%2Ferror.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ffortran%2Ferror.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ferror.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1137,6 +1137,7 @@ gfc_diagnostic_starter (diagnostic_context *context,\n       free (locus_prefix);\n       /* Fortran uses an empty line between locus and caret line.  */\n       pp_newline (context->printer);\n+      pp_set_prefix (context->printer, NULL);\n       diagnostic_show_locus (context, diagnostic->richloc, diagnostic->kind);\n       /* If the caret line was shown, the prefix does not contain the\n \t locus.  */"}, {"sha": "2b6c58532b3def24d6b755ce70afa9a5e99576bb", "filename": "gcc/pretty-print.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fpretty-print.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Fpretty-print.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fpretty-print.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1192,6 +1192,7 @@ pp_format (pretty_printer *pp, text_info *text)\n   /* Set output to the argument obstack, and switch line-wrapping and\n      prefixing off.  */\n   buffer->obstack = &buffer->chunk_obstack;\n+  const int old_line_length = buffer->line_length;\n   old_wrapping_mode = pp_set_verbatim_wrapping (pp);\n \n   /* Second phase.  Replace each formatter with the formatted text it\n@@ -1412,7 +1413,7 @@ pp_format (pretty_printer *pp, text_info *text)\n \n   /* Revert to normal obstack and wrapping mode.  */\n   buffer->obstack = &buffer->formatted_obstack;\n-  buffer->line_length = 0;\n+  buffer->line_length = old_line_length;\n   pp_wrapping_mode (pp) = old_wrapping_mode;\n   pp_clear_state (pp);\n }\n@@ -1427,7 +1428,6 @@ pp_output_formatted_text (pretty_printer *pp)\n   const char **args = chunk_array->args;\n \n   gcc_assert (buffer->obstack == &buffer->formatted_obstack);\n-  gcc_assert (buffer->line_length == 0);\n \n   /* This is a third phase, first 2 phases done in pp_format_args.\n      Now we actually print it.  */"}, {"sha": "5949f0a215fd1c3b04ae808b08aba51c98edfd92", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -1,3 +1,12 @@\n+2019-10-01  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* gcc.dg/plugin/diagnostic_group_plugin.c (test_begin_group_cb):\n+\tClear the prefix before emitting the \"END GROUP\" line.\n+\t* gcc.dg/plugin/diagnostic_plugin_test_show_locus.c\n+\t(custom_diagnostic_finalizer): Temporarily clear prefix when\n+\tcalling diagnostic_show_locus, rather than destroying it\n+\tafterwards.\n+\n 2019-10-01  Jan Hubicka  <hubicka@ucw.cz>\n \n \t* gcc.dg/tree-ssa/alias-access-path-10.c: New testcase."}, {"sha": "67ca701adfab765a7d0e2d7ac0476acd4ccf43c7", "filename": "gcc/testsuite/gcc.dg/plugin/diagnostic_group_plugin.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_group_plugin.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_group_plugin.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_group_plugin.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -197,6 +197,7 @@ test_begin_group_cb (diagnostic_context * context)\n static void\n test_end_group_cb (diagnostic_context * context)\n {\n+  pp_set_prefix (context->printer, NULL);\n   pp_string (context->printer,\n \t     \"---------------------------------- END GROUP -------------------------------\");\n   pp_newline_and_flush (context->printer);"}, {"sha": "3f62edd408e2f91b7369e81e7776001c36253ae6", "filename": "gcc/testsuite/gcc.dg/plugin/diagnostic_plugin_test_show_locus.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_plugin_test_show_locus.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9c9a142b49d069c5b7c24d47b07756e9d591956/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_plugin_test_show_locus.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fplugin%2Fdiagnostic_plugin_test_show_locus.c?ref=e9c9a142b49d069c5b7c24d47b07756e9d591956", "patch": "@@ -135,10 +135,11 @@ custom_diagnostic_finalizer (diagnostic_context *context,\n   bool old_show_color = pp_show_color (context->printer);\n   if (force_show_locus_color)\n     pp_show_color (context->printer) = true;\n+  char *saved_prefix = pp_take_prefix (context->printer);\n+  pp_set_prefix (context->printer, NULL);\n   diagnostic_show_locus (context, diagnostic->richloc, diagnostic->kind);\n   pp_show_color (context->printer) = old_show_color;\n-\n-  pp_destroy_prefix (context->printer);\n+  pp_set_prefix (context->printer, saved_prefix);\n   pp_flush (context->printer);\n }\n "}]}