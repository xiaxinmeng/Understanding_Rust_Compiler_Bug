{"sha": "af031b081fcd26f9fcb3e4a561f5a3d98158e163", "node_id": "C_kwDOANBUbNoAKGFmMDMxYjA4MWZjZDI2ZjlmY2IzZTRhNTYxZjVhM2Q5ODE1OGUxNjM", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-05-05T12:16:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-05T12:16:22Z"}, "message": "Merge #1202\n\n1202: Resolve module visibility properly r=CohenArthur a=CohenArthur\n\nCloses #1159 \n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>", "tree": {"sha": "49ebe0980c3753cdba5edb8daa344ac11804820f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/49ebe0980c3753cdba5edb8daa344ac11804820f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/af031b081fcd26f9fcb3e4a561f5a3d98158e163", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJic8AWCRBK7hj4Ov3rIwAAoDwIAFVKygeZueZQLfSotIdbCaTU\nqolHQDVgrIBoC0oJ0D44r9QCmJdYV8zRJ2nVKYrE2kJOlg82L+MCTecDxmIAFf+C\ncU5B+vdXzo4nMDCyla2EJs2YO/OMfYraQMt8/YN4C+tEHukjMlDsp2fcWVO7IAdM\nvVreLmVwEFJqYDNGyokhsC8eXF15jqddxPwhZFF7iXszNAlLcLQZwYkr0jaMwNHc\nO9oN3QjxSFwB2GcuX1/TWA5pAL/t9cCFdSoUWaqt/KDXQGwDzQEEG1gceLamZIJ5\nzcynZ6BroXcIfWCMn9qTfJMBz+hGwopp/o3mQ1bD1FzLUwOfE5QcudXgLV+xRew=\n=03U9\n-----END PGP SIGNATURE-----\n", "payload": "tree 49ebe0980c3753cdba5edb8daa344ac11804820f\nparent 285aabdd3b2d8ee7c158eee34241ba52a31b19d3\nparent 88c20f5e1d59b691b8e8cfbd550206a39bf9727b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1651752982 +0000\ncommitter GitHub <noreply@github.com> 1651752982 +0000\n\nMerge #1202\n\n1202: Resolve module visibility properly r=CohenArthur a=CohenArthur\n\nCloses #1159 \n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/af031b081fcd26f9fcb3e4a561f5a3d98158e163", "html_url": "https://github.com/Rust-GCC/gccrs/commit/af031b081fcd26f9fcb3e4a561f5a3d98158e163", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/af031b081fcd26f9fcb3e4a561f5a3d98158e163/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "285aabdd3b2d8ee7c158eee34241ba52a31b19d3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/285aabdd3b2d8ee7c158eee34241ba52a31b19d3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/285aabdd3b2d8ee7c158eee34241ba52a31b19d3"}, {"sha": "88c20f5e1d59b691b8e8cfbd550206a39bf9727b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/88c20f5e1d59b691b8e8cfbd550206a39bf9727b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/88c20f5e1d59b691b8e8cfbd550206a39bf9727b"}], "stats": {"total": 276, "additions": 230, "deletions": 46}, "files": [{"sha": "2aec8a95a5af4e9df6d07fafa9e8e9867b6c6933", "filename": "gcc/rust/Make-lang.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2FMake-lang.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2FMake-lang.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2FMake-lang.in?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -85,6 +85,7 @@ GRS_OBJS = \\\n     rust/rust-ast-lower.o \\\n     rust/rust-ast-lower-base.o \\\n     rust/rust-ast-lower-pattern.o \\\n+    rust/rust-ast-lower-item.o \\\n     rust/rust-name-resolver.o \\\n     rust/rust-ast-resolve.o \\\n     rust/rust-ast-resolve-base.o \\"}, {"sha": "0d59d7f6f94cc1ef4e4547f5cff75ae8b904b7fb", "filename": "gcc/rust/hir/rust-ast-lower-item.cc", "status": "added", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Frust-ast-lower-item.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Frust-ast-lower-item.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-item.cc?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -0,0 +1,74 @@\n+// Copyright (C) 2020-2022 Free Software Foundation, Inc.\n+\n+// This file is part of GCC.\n+\n+// GCC is free software; you can redistribute it and/or modify it under\n+// the terms of the GNU General Public License as published by the Free\n+// Software Foundation; either version 3, or (at your option) any later\n+// version.\n+\n+// GCC is distributed in the hope that it will be useful, but WITHOUT ANY\n+// WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+// for more details.\n+\n+// You should have received a copy of the GNU General Public License\n+// along with GCC; see the file COPYING3.  If not see\n+// <http://www.gnu.org/licenses/>.\n+\n+#include \"rust-ast-lower-item.h\"\n+\n+namespace Rust {\n+namespace HIR {\n+\n+HIR::SimplePath\n+ASTLoweringSimplePath::translate (const AST::SimplePath &path)\n+{\n+  ASTLoweringSimplePath resolver;\n+\n+  return resolver.lower (path);\n+}\n+\n+HIR::SimplePathSegment\n+ASTLoweringSimplePath::lower (const AST::SimplePathSegment &segment)\n+{\n+  auto crate_num = mappings->get_current_crate ();\n+  auto node_id = segment.get_node_id ();\n+\n+  auto mapping = Analysis::NodeMapping (crate_num, node_id,\n+\t\t\t\t\tmappings->get_next_hir_id (crate_num),\n+\t\t\t\t\tUNKNOWN_LOCAL_DEFID);\n+\n+  auto hir_seg = HIR::SimplePathSegment (mapping);\n+\n+  mappings->insert_node_to_hir (crate_num, node_id, mapping.get_hirid ());\n+  mappings->insert_simple_path_segment (crate_num, node_id, &segment);\n+\n+  return hir_seg;\n+}\n+\n+HIR::SimplePath\n+ASTLoweringSimplePath::lower (const AST::SimplePath &path)\n+{\n+  auto segments = std::vector<HIR::SimplePathSegment> ();\n+  for (auto &segment : path.get_segments ())\n+    segments.emplace_back (lower (segment));\n+\n+  auto crate_num = mappings->get_current_crate ();\n+  auto node_id = path.get_node_id ();\n+\n+  auto mapping = Analysis::NodeMapping (crate_num, node_id,\n+\t\t\t\t\tmappings->get_next_hir_id (crate_num),\n+\t\t\t\t\tUNKNOWN_LOCAL_DEFID);\n+\n+  auto lowered\n+    = HIR::SimplePath (std::move (segments), mapping, path.get_locus ());\n+\n+  mappings->insert_node_to_hir (crate_num, node_id, mapping.get_hirid ());\n+  mappings->insert_simple_path (crate_num, node_id, &path);\n+\n+  return lowered;\n+}\n+\n+} // namespace HIR\n+} // namespace Rust"}, {"sha": "6da50fe42628cd2793d8622105dba55743018611", "filename": "gcc/rust/hir/rust-ast-lower-item.h", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower-item.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -826,6 +826,15 @@ class ASTLoweringItem : public ASTLoweringBase\n   HIR::Item *translated;\n };\n \n+class ASTLoweringSimplePath : public ASTLoweringBase\n+{\n+public:\n+  static HIR::SimplePath translate (const AST::SimplePath &path);\n+\n+  HIR::SimplePathSegment lower (const AST::SimplePathSegment &segment);\n+  HIR::SimplePath lower (const AST::SimplePath &path);\n+};\n+\n } // namespace HIR\n } // namespace Rust\n "}, {"sha": "d861207ebe8da76e162473c2c0c8d55bb035a37f", "filename": "gcc/rust/hir/rust-ast-lower.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Frust-ast-lower.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Frust-ast-lower.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-ast-lower.cc?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -46,7 +46,8 @@ translate_visibility (const AST::Visibility &vis)\n     case AST::Visibility::PUB_CRATE:\n     case AST::Visibility::PUB_SUPER:\n     case AST::Visibility::PUB_IN_PATH:\n-      return Visibility (Visibility::VisType::PUBLIC, vis.get_path ());\n+      return Visibility (Visibility::VisType::RESTRICTED,\n+\t\t\t ASTLoweringSimplePath::translate (vis.get_path ()));\n       break;\n     }\n "}, {"sha": "8ef11945b13f865be2ab5cade0ff5f4d15628b84", "filename": "gcc/rust/hir/tree/rust-hir-full-test.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-full-test.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-full-test.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-full-test.cc?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -123,7 +123,8 @@ Visibility::as_string () const\n     case PRIVATE:\n       return std::string (\"private\");\n     case PUBLIC:\n-      return std::string (\"pub(in \") + path.as_string () + std::string (\")\");\n+      return std::string (\"pub(in \") + path.get_mappings ().as_string ()\n+\t     + std::string (\")\");\n     default:\n       gcc_unreachable ();\n     }"}, {"sha": "109a5c238f23034b5b4ea20d79cd08a908be4c8d", "filename": "gcc/rust/hir/tree/rust-hir-item.h", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-item.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -557,19 +557,19 @@ struct Visibility\n   {\n     PRIVATE,\n     PUBLIC,\n+    RESTRICTED,\n     ERROR,\n   };\n \n private:\n   VisType vis_type;\n-  AST::SimplePath path;\n+  HIR::SimplePath path;\n \n   // should this store location info?\n \n public:\n-  // Creates a Visibility - TODO make constructor protected or private?\n   Visibility (VisType vis_type,\n-\t      AST::SimplePath path = AST::SimplePath::create_empty ())\n+\t      HIR::SimplePath path = HIR::SimplePath::create_empty ())\n     : vis_type (vis_type), path (std::move (path))\n   {}\n \n@@ -579,14 +579,23 @@ struct Visibility\n   // Does the current visibility refer to a simple `pub <item>` entirely public\n   bool is_public () const { return vis_type == PUBLIC; }\n \n+  // Is the current visibility public restricted to a certain path\n+  bool is_restricted () const { return vis_type == RESTRICTED; }\n+\n   // Creates an error visibility.\n   static Visibility create_error ()\n   {\n-    return Visibility (ERROR, AST::SimplePath::create_empty ());\n+    return Visibility (ERROR, HIR::SimplePath::create_empty ());\n   }\n \n   VisType get_vis_type () const { return vis_type; }\n \n+  const HIR::SimplePath &get_path () const\n+  {\n+    rust_assert (!is_error ());\n+    return path;\n+  }\n+\n   std::string as_string () const;\n };\n "}, {"sha": "b18bf1dde22a07ffe436a3b8f5f930ea507057c9", "filename": "gcc/rust/hir/tree/rust-hir-path.h", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-path.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-path.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-path.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -946,6 +946,39 @@ class QualifiedPathInType : public TypeNoBounds\n \n   Location get_locus () { return locus; }\n };\n+\n+class SimplePathSegment\n+{\n+  Analysis::NodeMapping mappings;\n+\n+public:\n+  SimplePathSegment (Analysis::NodeMapping mappings) : mappings (mappings) {}\n+\n+  const Analysis::NodeMapping &get_mappings () const { return mappings; }\n+};\n+\n+class SimplePath\n+{\n+  std::vector<SimplePathSegment> segments;\n+  Analysis::NodeMapping mappings;\n+  Location locus;\n+\n+public:\n+  SimplePath (std::vector<SimplePathSegment> segments,\n+\t      Analysis::NodeMapping mappings, Location locus)\n+    : segments (std::move (segments)), mappings (mappings), locus (locus)\n+  {}\n+\n+  static HIR::SimplePath create_empty ()\n+  {\n+    return HIR::SimplePath ({}, Analysis::NodeMapping::get_error (),\n+\t\t\t    Location ());\n+  }\n+\n+  const Analysis::NodeMapping &get_mappings () const { return mappings; }\n+  const Location &get_locus () const { return locus; }\n+};\n+\n } // namespace HIR\n } // namespace Rust\n "}, {"sha": "e76bdd8b524de099e766463148c9ca2164d4ddce", "filename": "gcc/rust/parse/rust-parse-impl.h", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fparse%2Frust-parse-impl.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fparse%2Frust-parse-impl.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fparse%2Frust-parse-impl.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -5402,7 +5402,7 @@ Parser<ManagedTokenSource>::parse_inherent_impl_item ()\n     case FN_TOK:\n       // function or method\n       return parse_inherent_impl_function_or_method (\n-\tAST::Visibility::create_error (), std::move (outer_attrs));\n+\tAST::Visibility::create_private (), std::move (outer_attrs));\n     case CONST:\n       /* lookahead to resolve production - could be function/method or const\n        * item */\n@@ -5412,13 +5412,13 @@ Parser<ManagedTokenSource>::parse_inherent_impl_item ()\n \t{\n \tcase IDENTIFIER:\n \tcase UNDERSCORE:\n-\t  return parse_const_item (AST::Visibility::create_error (),\n+\t  return parse_const_item (AST::Visibility::create_private (),\n \t\t\t\t   std::move (outer_attrs));\n \tcase UNSAFE:\n \tcase EXTERN_TOK:\n \tcase FN_TOK:\n \t  return parse_inherent_impl_function_or_method (\n-\t    AST::Visibility::create_error (), std::move (outer_attrs));\n+\t    AST::Visibility::create_private (), std::move (outer_attrs));\n \tdefault:\n \t  add_error (Error (t->get_locus (),\n \t\t\t    \"unexpected token %qs in some sort of const item \"\n@@ -5572,7 +5572,7 @@ Parser<ManagedTokenSource>::parse_trait_impl_item ()\n       // these seem to be SimplePath tokens, so this is a macro invocation semi\n       return parse_macro_invocation_semi (std::move (outer_attrs));\n     case TYPE:\n-      return parse_type_alias (AST::Visibility::create_error (),\n+      return parse_type_alias (AST::Visibility::create_private (),\n \t\t\t       std::move (outer_attrs));\n       case PUB: {\n \t// visibility, so not a macro invocation semi - must be constant,\n@@ -5631,7 +5631,7 @@ Parser<ManagedTokenSource>::parse_trait_impl_item ()\n     case FN_TOK:\n       // function or method\n       return parse_trait_impl_function_or_method (\n-\tAST::Visibility::create_error (), std::move (outer_attrs));\n+\tAST::Visibility::create_private (), std::move (outer_attrs));\n     case CONST:\n       // lookahead to resolve production - could be function/method or const\n       // item\n@@ -5641,13 +5641,13 @@ Parser<ManagedTokenSource>::parse_trait_impl_item ()\n \t{\n \tcase IDENTIFIER:\n \tcase UNDERSCORE:\n-\t  return parse_const_item (AST::Visibility::create_error (),\n+\t  return parse_const_item (AST::Visibility::create_private (),\n \t\t\t\t   std::move (outer_attrs));\n \tcase UNSAFE:\n \tcase EXTERN_TOK:\n \tcase FN_TOK:\n \t  return parse_trait_impl_function_or_method (\n-\t    AST::Visibility::create_error (), std::move (outer_attrs));\n+\t    AST::Visibility::create_private (), std::move (outer_attrs));\n \tdefault:\n \t  add_error (Error (\n \t    t->get_locus (),"}, {"sha": "ed90c7c38d3b536895129c79e629e5903d47e8f2", "filename": "gcc/rust/privacy/rust-privacy-check.cc", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-privacy-check.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-privacy-check.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fprivacy%2Frust-privacy-check.cc?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -20,6 +20,7 @@\n #include \"rust-reachability.h\"\n #include \"rust-hir-type-check.h\"\n #include \"rust-hir-map.h\"\n+#include \"rust-name-resolver.h\"\n #include \"rust-visibility-resolver.h\"\n \n extern bool\n@@ -32,9 +33,10 @@ Resolver::resolve (HIR::Crate &crate)\n {\n   PrivacyContext ctx;\n   auto mappings = Analysis::Mappings::get ();\n+  auto resolver = Rust::Resolver::Resolver::get ();\n \n-  auto resolver = VisibilityResolver (*mappings);\n-  resolver.go (crate);\n+  auto visibility_resolver = VisibilityResolver (*mappings, *resolver);\n+  visibility_resolver.go (crate);\n \n   auto ty_ctx = ::Rust::Resolver::TypeCheckContext::get ();\n   auto visitor = ReachabilityVisitor (ctx, *ty_ctx);"}, {"sha": "a47992f778c34a823a5b906fa3732138fbe1e333", "filename": "gcc/rust/privacy/rust-privacy-common.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-privacy-common.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-privacy-common.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fprivacy%2Frust-privacy-common.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -51,6 +51,7 @@ class ModuleVisibility\n   Type get_kind () const { return kind; }\n \n   const DefId &get_module_id () const { return module_id; }\n+  DefId &get_module_id () { return module_id; }\n \n private:\n   ModuleVisibility (Type kind, DefId module_id)"}, {"sha": "d2e75c257cbe53c15edfd1153e914609bd5dd228", "filename": "gcc/rust/privacy/rust-visibility-resolver.cc", "status": "modified", "additions": 57, "deletions": 13, "changes": 70, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.cc?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -24,8 +24,9 @@\n namespace Rust {\n namespace Privacy {\n \n-VisibilityResolver::VisibilityResolver (Analysis::Mappings &mappings)\n-  : mappings (mappings)\n+VisibilityResolver::VisibilityResolver (Analysis::Mappings &mappings,\n+\t\t\t\t\tResolver::Resolver &resolver)\n+  : mappings (mappings), resolver (resolver)\n {}\n \n void\n@@ -45,16 +46,56 @@ VisibilityResolver::go (HIR::Crate &crate)\n     }\n }\n \n-// FIXME: At this point in the pipeline, we should not be dealing with\n-// `AST::SimplePath`s anymore! We need to be dealing with their \"resolved\n-// counterpart\", so probably a NodeId/HirId/DefId.\n+bool\n+VisibilityResolver::resolve_module_path (const HIR::SimplePath &restriction,\n+\t\t\t\t\t DefId &id)\n+{\n+  // We need, from the restriction, to figure out the actual Module it\n+  // belongs to.\n+\n+  NodeId ast_node_id = restriction.get_mappings ().get_nodeid ();\n+\n+  auto invalid_path\n+    = Error (restriction.get_locus (),\n+\t     \"cannot use non-module path as privacy restrictor\");\n+\n+  NodeId ref_node_id = UNKNOWN_NODEID;\n+  if (!resolver.lookup_resolved_name (ast_node_id, &ref_node_id))\n+    {\n+      invalid_path.emit_error ();\n+      return false;\n+    }\n+  // FIXME: Add a hint here if we can find the path in another scope, such as\n+  // a type or something else\n+  // TODO: For the hint, can we point to the original item's definition if\n+  // present?\n+\n+  Resolver::Definition def;\n+  rust_assert (resolver.lookup_definition (ref_node_id, &def));\n+\n+  // FIXME: Is that what we want?\n+  ref_node_id = def.parent;\n \n-// static bool\n-// resolve_module_path (std::vector<HIR::Module> &module_stack,\n-// \t\t     const AST::SimplePath &restriction, DefId &id)\n-// {\n-//   return false;\n-// }\n+  HirId ref;\n+  rust_assert (\n+    mappings.lookup_node_to_hir (restriction.get_mappings ().get_crate_num (),\n+\t\t\t\t ref_node_id, &ref));\n+\n+  auto module\n+    = mappings.lookup_module (restriction.get_mappings ().get_crate_num (),\n+\t\t\t      ref);\n+\n+  if (!module)\n+    {\n+      invalid_path.emit_error ();\n+      return false;\n+    }\n+\n+  // Fill in the resolved `DefId`\n+  id = module->get_mappings ().get_defid ();\n+\n+  return true;\n+}\n \n bool\n VisibilityResolver::resolve_visibility (const HIR::Visibility &visibility,\n@@ -66,11 +107,14 @@ VisibilityResolver::resolve_visibility (const HIR::Visibility &visibility,\n       to_resolve = ModuleVisibility::create_restricted (peek_module ());\n       return true;\n     case HIR::Visibility::PUBLIC:\n-      // FIXME: We need to handle the restricted path here\n-      // FIXME: We also need to handle 2015 vs 2018 edition conflicts\n       to_resolve = ModuleVisibility::create_public ();\n       return true;\n+    case HIR::Visibility::RESTRICTED:\n+      to_resolve = ModuleVisibility::create_public ();\n+      return resolve_module_path (visibility.get_path (),\n+\t\t\t\t  to_resolve.get_module_id ());\n     default:\n+      gcc_unreachable ();\n       return false;\n     }\n }"}, {"sha": "89e6e2bdc8a13cd9a770f629ba1b6c11bb9a0a4f", "filename": "gcc/rust/privacy/rust-visibility-resolver.h", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fprivacy%2Frust-visibility-resolver.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -24,6 +24,7 @@\n #include \"rust-hir-stmt.h\"\n #include \"rust-hir-item.h\"\n #include \"rust-hir-map.h\"\n+#include \"rust-name-resolver.h\"\n #include \"rust-hir-visitor.h\"\n \n namespace Rust {\n@@ -32,13 +33,20 @@ namespace Privacy {\n class VisibilityResolver : public HIR::HIRVisItemVisitor\n {\n public:\n-  VisibilityResolver (Analysis::Mappings &mappings);\n+  VisibilityResolver (Analysis::Mappings &mappings,\n+\t\t      Rust::Resolver::Resolver &resolver);\n \n   /**\n    * Perform visibility resolving on an entire crate\n    */\n   void go (HIR::Crate &crate);\n \n+  /**\n+   * Resolve a path to the module it refers\n+   */\n+  bool resolve_module_path (const HIR::SimplePath &restriction,\n+\t\t\t    DefId &to_resolve);\n+\n   /**\n    * Resolve the visibility of an item to its ModuleVisibility. This function\n    * emits errors if necessary. The contents of the to_resolve parameter will be\n@@ -84,11 +92,11 @@ class VisibilityResolver : public HIR::HIRVisItemVisitor\n   virtual void visit (HIR::ExternBlock &block);\n \n private:\n-  /* Mappings to insert visibilities into */\n-  Analysis::Mappings &mappings;\n-\n   /* Stack of modules visited by this visitor */\n   std::vector<DefId> module_stack;\n+\n+  Analysis::Mappings &mappings;\n+  Rust::Resolver::Resolver &resolver;\n };\n \n } // namespace Privacy"}, {"sha": "66d3e415471d407fd5d8095c480e985da9acf335", "filename": "gcc/rust/util/rust-hir-map.cc", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Futil%2Frust-hir-map.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Futil%2Frust-hir-map.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Futil%2Frust-hir-map.cc?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -428,7 +428,7 @@ Mappings::lookup_hir_path_expr_seg (CrateNum crateNum, HirId id)\n \n void\n Mappings::insert_simple_path_segment (CrateNum crateNum, HirId id,\n-\t\t\t\t      AST::SimplePathSegment *path)\n+\t\t\t\t      const AST::SimplePathSegment *path)\n {\n   rust_assert (lookup_simple_path_segment (crateNum, id) == nullptr);\n \n@@ -437,7 +437,7 @@ Mappings::insert_simple_path_segment (CrateNum crateNum, HirId id,\n   insert_location (crateNum, id, path->get_locus ());\n }\n \n-AST::SimplePathSegment *\n+const AST::SimplePathSegment *\n Mappings::lookup_simple_path_segment (CrateNum crateNum, HirId id)\n {\n   auto it = astSimplePathSegmentMappings.find (crateNum);\n@@ -453,7 +453,7 @@ Mappings::lookup_simple_path_segment (CrateNum crateNum, HirId id)\n \n void\n Mappings::insert_simple_path (CrateNum crateNum, HirId id,\n-\t\t\t      AST::SimplePath *path)\n+\t\t\t      const AST::SimplePath *path)\n {\n   rust_assert (lookup_simple_path (crateNum, id) == nullptr);\n \n@@ -462,7 +462,7 @@ Mappings::insert_simple_path (CrateNum crateNum, HirId id,\n   insert_location (crateNum, id, path->get_locus ());\n }\n \n-AST::SimplePath *\n+const AST::SimplePath *\n Mappings::lookup_simple_path (CrateNum crateNum, HirId id)\n {\n   auto it = astSimplePathMappings.find (crateNum);"}, {"sha": "0bb870b491069e3af0d5f6510ee98f05bf2a96d2", "filename": "gcc/rust/util/rust-hir-map.h", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Futil%2Frust-hir-map.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Frust%2Futil%2Frust-hir-map.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Futil%2Frust-hir-map.h?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -161,12 +161,13 @@ class Mappings\n   HIR::PathExprSegment *lookup_hir_path_expr_seg (CrateNum crateNum, HirId id);\n \n   void insert_simple_path_segment (CrateNum crateNum, HirId id,\n-\t\t\t\t   AST::SimplePathSegment *path);\n-  AST::SimplePathSegment *lookup_simple_path_segment (CrateNum crateNum,\n-\t\t\t\t\t\t      HirId id);\n+\t\t\t\t   const AST::SimplePathSegment *path);\n+  const AST::SimplePathSegment *lookup_simple_path_segment (CrateNum crateNum,\n+\t\t\t\t\t\t\t    HirId id);\n \n-  void insert_simple_path (CrateNum crateNum, HirId id, AST::SimplePath *path);\n-  AST::SimplePath *lookup_simple_path (CrateNum crateNum, HirId id);\n+  void insert_simple_path (CrateNum crateNum, HirId id,\n+\t\t\t   const AST::SimplePath *path);\n+  const AST::SimplePath *lookup_simple_path (CrateNum crateNum, HirId id);\n \n   void insert_hir_generic_param (CrateNum crateNum, HirId id,\n \t\t\t\t HIR::GenericParam *expr);\n@@ -351,8 +352,9 @@ class Mappings\n   std::map<CrateNum, std::map<HirId, HIR::TraitItem *>> hirTraitItemMappings;\n   std::map<CrateNum, std::map<HirId, HIR::ExternalItem *>>\n     hirExternItemMappings;\n-  std::map<CrateNum, std::map<HirId, AST::SimplePath *>> astSimplePathMappings;\n-  std::map<CrateNum, std::map<HirId, AST::SimplePathSegment *>>\n+  std::map<CrateNum, std::map<HirId, const AST::SimplePath *>>\n+    astSimplePathMappings;\n+  std::map<CrateNum, std::map<HirId, const AST::SimplePathSegment *>>\n     astSimplePathSegmentMappings;\n   std::map<CrateNum, std::map<HirId, HIR::PathExprSegment *>>\n     hirPathSegMappings;"}, {"sha": "9bda9682403238c7d5ed528d95c806badd81a68f", "filename": "gcc/testsuite/rust/compile/pub_restricted_1.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Ftestsuite%2Frust%2Fcompile%2Fpub_restricted_1.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/af031b081fcd26f9fcb3e4a561f5a3d98158e163/gcc%2Ftestsuite%2Frust%2Fcompile%2Fpub_restricted_1.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fpub_restricted_1.rs?ref=af031b081fcd26f9fcb3e4a561f5a3d98158e163", "patch": "@@ -1,12 +1,11 @@\n pub mod foo {\n     pub mod bar {\n         pub fn baz() {}\n+\n+        pub(in foo::bar) struct A0;\n     }\n }\n \n-// this is invalid Rust: We just want to make sure the paths get resolved properly\n-pub(in foo::bar::baz) struct A0;\n-\n pub(in foo::fah::baz) struct A1; // { dg-error \"cannot find simple path segment .fah.\" }\n pub(in fro::bulator::saindoux) struct A2; // { dg-error \"cannot find simple path segment .fro.\" }\n pub(in foo::bar::saindoux) struct A3; // { dg-error \"cannot find simple path segment .saindoux.\" }"}]}