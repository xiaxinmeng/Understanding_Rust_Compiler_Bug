{"sha": "5463cee277038df4688b61144db498ae7d24e631", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTQ2M2NlZTI3NzAzOGRmNDY4OGI2MTE0NGRiNDk4YWU3ZDI0ZTYzMQ==", "commit": {"author": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2021-03-24T03:04:58Z"}, "committer": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2021-03-30T13:29:18Z"}, "message": "x86: Define __rdtsc and __rdtscp as macros\n\nDefine __rdtsc and __rdtscp as macros for callers with general-regs-only\ntarget attribute to avoid inline failure with always_inline attribute.\n\ngcc/\n\n\tPR target/99744\n\t* config/i386/ia32intrin.h (__rdtsc): Defined as macro.\n\t(__rdtscp): Likewise.\n\ngcc/testsuite/\n\n\tPR target/99744\n\t* gcc.target/i386/pr99744-1.c: New test.", "tree": {"sha": "bdd6bfcfe27bb983c196de3fe704124689aa1f03", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/bdd6bfcfe27bb983c196de3fe704124689aa1f03"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5463cee277038df4688b61144db498ae7d24e631", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5463cee277038df4688b61144db498ae7d24e631", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5463cee277038df4688b61144db498ae7d24e631", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5463cee277038df4688b61144db498ae7d24e631/comments", "author": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c68e2abe294a48385224cd7617eca0720144b5c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9c68e2abe294a48385224cd7617eca0720144b5c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9c68e2abe294a48385224cd7617eca0720144b5c"}], "stats": {"total": 39, "additions": 27, "deletions": 12}, "files": [{"sha": "591394076cc89446e29e8b94f2d44d565caf7fd8", "filename": "gcc/config/i386/ia32intrin.h", "status": "modified", "additions": 2, "deletions": 12, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5463cee277038df4688b61144db498ae7d24e631/gcc%2Fconfig%2Fi386%2Fia32intrin.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5463cee277038df4688b61144db498ae7d24e631/gcc%2Fconfig%2Fi386%2Fia32intrin.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fia32intrin.h?ref=5463cee277038df4688b61144db498ae7d24e631", "patch": "@@ -107,22 +107,12 @@ __rdpmc (int __S)\n #endif /* __iamcu__ */\n \n /* rdtsc */\n-extern __inline unsigned long long\n-__attribute__((__gnu_inline__, __always_inline__, __artificial__))\n-__rdtsc (void)\n-{\n-  return __builtin_ia32_rdtsc ();\n-}\n+#define __rdtsc()\t\t__builtin_ia32_rdtsc ()\n \n #ifndef __iamcu__\n \n /* rdtscp */\n-extern __inline unsigned long long\n-__attribute__((__gnu_inline__, __always_inline__, __artificial__))\n-__rdtscp (unsigned int *__A)\n-{\n-  return __builtin_ia32_rdtscp (__A);\n-}\n+#define __rdtscp(a)\t\t__builtin_ia32_rdtscp (a)\n \n #endif /* __iamcu__ */\n "}, {"sha": "a5a905c732a9ee5ba388a9916785ea1c5faebfe3", "filename": "gcc/testsuite/gcc.target/i386/pr99744-1.c", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5463cee277038df4688b61144db498ae7d24e631/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr99744-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5463cee277038df4688b61144db498ae7d24e631/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr99744-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr99744-1.c?ref=5463cee277038df4688b61144db498ae7d24e631", "patch": "@@ -0,0 +1,25 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O0\" } */\n+\n+#include <x86intrin.h>\n+\n+extern unsigned long long int curr_deadline;\n+extern void bar (void);\n+\n+__attribute__ ((target(\"general-regs-only\")))\n+void\n+foo1 (void)\n+{\n+  if (__rdtsc () < curr_deadline)\n+    return; \n+  bar ();\n+}\n+\n+__attribute__ ((target(\"general-regs-only\")))\n+void\n+foo2 (unsigned int *p)\n+{\n+  if (__rdtscp (p) < curr_deadline)\n+    return; \n+  bar ();\n+}"}]}