{"sha": "a8f9b4c54cc350625accbb2c6b4005acb42d4c2e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YThmOWI0YzU0Y2MzNTA2MjVhY2NiYjJjNmI0MDA1YWNiNDJkNGMyZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-09-10T18:55:46Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-09-10T18:55:46Z"}, "message": "lto: Fix up lto BLOCK tree streaming\n\nWhen I've tried to backport recent LTO changes of mine, I've ran into\nFAIL: g++.dg/ubsan/align-3.C   -O2 -flto -fno-use-linker-plugin -flto-partition=none  output pattern test\nFAIL: g++.dg/ubsan/align-3.C   -O2 -flto -fuse-linker-plugin -fno-fat-lto-objects  output pattern test\nregressions that don't for some reason show up on the trunk.\n\nI've tracked it down to input_location_and_block being called recursively,\nfirst on some UBSAN_NULL ifn call's location which needs to stream a BLOCK\nthat hasn't been streamed yet, which in turn needs to stream some locations\nfor the decls in the BLOCK.\n\nLooking at that align-3.C testcase on the trunk, I also see the recursive\nlto_output_location_1 calls as well.  First on block:\n$18 = <block 0x7fffea738480>\nwhich is in the block tree from what I can see just fine (see the end of\nmail).\n\nNow, output_function has code that should stream the BLOCK tree leafs:\n  /* Output DECL_INITIAL for the function, which contains the tree of\n     lexical scopes.  */\n  stream_write_tree (ob, DECL_INITIAL (function), true);\n  /* As we do not recurse into BLOCK_SUBBLOCKS but only BLOCK_SUPERCONTEXT\n     collect block tree leafs and stream those.  */\n  auto_vec<tree> block_tree_leafs;\n  if (DECL_INITIAL (function))\n    collect_block_tree_leafs (DECL_INITIAL (function), block_tree_leafs);\n  streamer_write_uhwi (ob, block_tree_leafs.length ());\n  for (unsigned i = 0; i < block_tree_leafs.length (); ++i)\n    stream_write_tree (ob, block_tree_leafs[i], true);\n\nstatic void\ncollect_block_tree_leafs (tree root, vec<tree> &leafs)\n{\n  for (root = BLOCK_SUBBLOCKS (root); root; root = BLOCK_CHAIN (root))\n    if (! BLOCK_SUBBLOCKS (root))\n      leafs.safe_push (root);\n    else\n      collect_block_tree_leafs (BLOCK_SUBBLOCKS (root), leafs);\n}\n\nbut the problem is that it is broken, it doesn't cover all block leafs,\nbut only leafs with an odd depth from DECL_INITIAL (and only some of those).\n\nThe following patch fixes that, but I guess we are going to stream at that\npoint significantly more blocks than before (though I guess most of the time\nwe'd stream them later on when streaming the gimple_locations that refer to\nthem).\n\n2020-09-10  Jakub Jelinek  <jakub@redhat.com>\n\n\t* lto-streamer-out.c (collect_block_tree_leafs): Recurse on\n\troot rather than BLOCK_SUBBLOCKS (root).", "tree": {"sha": "aeb1f58c4a5e0c404dff92e04f33f87417b23ccd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aeb1f58c4a5e0c404dff92e04f33f87417b23ccd"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a8f9b4c54cc350625accbb2c6b4005acb42d4c2e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8f9b4c54cc350625accbb2c6b4005acb42d4c2e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a8f9b4c54cc350625accbb2c6b4005acb42d4c2e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8f9b4c54cc350625accbb2c6b4005acb42d4c2e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d5589d11e61fa78b0c0e845728412b1cc6043d8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1d5589d11e61fa78b0c0e845728412b1cc6043d8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1d5589d11e61fa78b0c0e845728412b1cc6043d8"}], "stats": {"total": 2, "additions": 1, "deletions": 1}, "files": [{"sha": "7882c89388dc49e40f14d52eaf94e211367b6946", "filename": "gcc/lto-streamer-out.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a8f9b4c54cc350625accbb2c6b4005acb42d4c2e/gcc%2Flto-streamer-out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a8f9b4c54cc350625accbb2c6b4005acb42d4c2e/gcc%2Flto-streamer-out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-out.c?ref=a8f9b4c54cc350625accbb2c6b4005acb42d4c2e", "patch": "@@ -2294,7 +2294,7 @@ collect_block_tree_leafs (tree root, vec<tree> &leafs)\n     if (! BLOCK_SUBBLOCKS (root))\n       leafs.safe_push (root);\n     else\n-      collect_block_tree_leafs (BLOCK_SUBBLOCKS (root), leafs);\n+      collect_block_tree_leafs (root, leafs);\n }\n \n /* This performs function body modifications that are needed for streaming"}]}