{"sha": "aa3987819a5ab392bcb125efe84008e75f99bbfc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWEzOTg3ODE5YTVhYjM5MmJjYjEyNWVmZTg0MDA4ZTc1Zjk5YmJmYw==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2015-12-17T21:29:30Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2015-12-17T21:29:30Z"}, "message": "ipa-icf.c (sem_item_optimizer::merge): Don't pick 'main' as the source function.\n\n\tgcc/\n\t* ipa-icf.c (sem_item_optimizer::merge): Don't pick 'main' as the\n\tsource function.\n\n\tgcc/testsuite/\n\t* gcc.dg/ipa/ipa-icf-merge-1.c: New.\n\nFrom-SVN: r231787", "tree": {"sha": "0d91f65213de20171768f41f75671dd6d5107467", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0d91f65213de20171768f41f75671dd6d5107467"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/aa3987819a5ab392bcb125efe84008e75f99bbfc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aa3987819a5ab392bcb125efe84008e75f99bbfc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aa3987819a5ab392bcb125efe84008e75f99bbfc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aa3987819a5ab392bcb125efe84008e75f99bbfc/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "94c40e19af4ca5fe57c990df7f7abec48f5aa3af", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94c40e19af4ca5fe57c990df7f7abec48f5aa3af", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94c40e19af4ca5fe57c990df7f7abec48f5aa3af"}], "stats": {"total": 48, "additions": 45, "deletions": 3}, "files": [{"sha": "a1f71bdfa865413714d8688c404859dfb809a546", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=aa3987819a5ab392bcb125efe84008e75f99bbfc", "patch": "@@ -1,3 +1,8 @@\n+2015-12-17  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* ipa-icf.c (sem_item_optimizer::merge): Don't pick 'main' as the\n+\tsource function.\n+\n 2015-12-17  Sebastian Pop  <s.pop@samsung.com>\n \n \t* Makefile.in: Replace ISL with isl."}, {"sha": "4538677c860169e2ec9a73e63d340475acadd65f", "filename": "gcc/ipa-icf.c", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2Fipa-icf.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2Fipa-icf.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-icf.c?ref=aa3987819a5ab392bcb125efe84008e75f99bbfc", "patch": "@@ -3398,14 +3398,20 @@ sem_item_optimizer::merge_classes (unsigned int prev_class_count)\n \tif (c->members.length () == 1)\n \t  continue;\n \n-\tgcc_assert (c->members.length ());\n-\n \tsem_item *source = c->members[0];\n \n-\tfor (unsigned int j = 1; j < c->members.length (); j++)\n+\tif (MAIN_NAME_P (DECL_NAME (source->decl)))\n+\t  /* If merge via wrappers, picking main as the target can be\n+\t     problematic.  */\n+\t  source = c->members[1];\n+\n+\tfor (unsigned int j = 0; j < c->members.length (); j++)\n \t  {\n \t    sem_item *alias = c->members[j];\n \n+\t    if (alias == source)\n+\t      continue;\n+\n \t    if (dump_file)\n \t      {\n \t\tfprintf (dump_file, \"Semantic equality hit:%s->%s\\n\","}, {"sha": "d5ae29900974d00a8464851130cbe3991081ee3d", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=aa3987819a5ab392bcb125efe84008e75f99bbfc", "patch": "@@ -1,3 +1,7 @@\n+2015-12-17  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* gcc.dg/ipa/ipa-icf-merge-1.c: New.\n+\t\n 2015-12-17  David Malcolm  <dmalcolm@redhat.com>\n \n \t* gcc.dg/diagnostic-range-bad-return.c: New test case."}, {"sha": "06958a4d69dc6834e243d2a4c050aa2dfaf76235", "filename": "gcc/testsuite/gcc.dg/ipa/ipa-icf-merge-1.c", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipa-icf-merge-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aa3987819a5ab392bcb125efe84008e75f99bbfc/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipa-icf-merge-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fipa-icf-merge-1.c?ref=aa3987819a5ab392bcb125efe84008e75f99bbfc", "patch": "@@ -0,0 +1,27 @@\n+/* { dg-do compile } */\n+/* { dg-additional-options \"-O2 -fdump-ipa-icf\" } */\n+\n+/* Picking 'main' as a candiate target for equivalent functios is not a\n+   good idea.  */\n+\n+int baz (int);\n+\n+int foo ()\n+{\n+  return baz (baz (0));\n+}\n+\n+\n+int main ()\n+{\n+  return baz (baz (0));\n+}\n+\n+/* Notice the two functions are the same.  */\n+/* { dg-final { scan-ipa-dump \"Semantic equality hit:foo->main\" \"icf\" } } */\n+\n+/* Make sure we don't tail call main.  */\n+/* { dg-final { scan-ipa-dump-not \"= main \\\\(\\\\);\" \"icf\" } } */\n+\n+/* Make sure we tail call foo.  */\n+/* { dg-final { scan-ipa-dump \"= foo \\\\(\\\\);\" \"icf\" } } */"}]}