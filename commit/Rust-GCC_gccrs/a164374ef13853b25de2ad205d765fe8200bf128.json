{"sha": "a164374ef13853b25de2ad205d765fe8200bf128", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTE2NDM3NGVmMTM4NTNiMjVkZTJhZDIwNWQ3NjVmZTgyMDBiZjEyOA==", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2019-04-12T12:54:00Z"}, "committer": {"name": "Martin Liska", "email": "marxin@gcc.gnu.org", "date": "2019-04-12T12:54:00Z"}, "message": "Handle multiple 'default' in target attribute (PR middle-end/89970).\n\n2019-04-12  Martin Liska  <mliska@suse.cz>\n\n\tPR middle-end/89970\n\t* multiple_target.c (create_dispatcher_calls): Wrap ifunc\n\tin error message.\n\t(separate_attrs): Handle multiple 'default's.\n\t(expand_target_clones): Rework error handling code.\n2019-04-12  Martin Liska  <mliska@suse.cz>\n\n\tPR middle-end/89970\n\t* gcc.target/i386/mvc15.c: New test.\n\t* gcc.target/i386/mvc3.c: Quote target in error pattern.\n\t* gcc.target/i386/mvc4.c: Remove duplicit 'default'.\n\nFrom-SVN: r270314", "tree": {"sha": "afe7b2db0d2c7bdc4b779ccf3ef8dcf974baf746", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/afe7b2db0d2c7bdc4b779ccf3ef8dcf974baf746"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a164374ef13853b25de2ad205d765fe8200bf128", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a164374ef13853b25de2ad205d765fe8200bf128", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a164374ef13853b25de2ad205d765fe8200bf128", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a164374ef13853b25de2ad205d765fe8200bf128/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "34f02c07fb1a9d966fb7af5a8c28c213e84d89c5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/34f02c07fb1a9d966fb7af5a8c28c213e84d89c5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/34f02c07fb1a9d966fb7af5a8c28c213e84d89c5"}], "stats": {"total": 67, "additions": 52, "deletions": 15}, "files": [{"sha": "b56071d239934341e831538d4e139ffa75b842b6", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=a164374ef13853b25de2ad205d765fe8200bf128", "patch": "@@ -1,3 +1,11 @@\n+2019-04-12  Martin Liska  <mliska@suse.cz>\n+\n+\tPR middle-end/89970\n+\t* multiple_target.c (create_dispatcher_calls): Wrap ifunc\n+\tin error message.\n+\t(separate_attrs): Handle multiple 'default's.\n+\t(expand_target_clones): Rework error handling code.\n+\n 2019-04-12  Kelvin Nilsen  <kelvin@gcc.gnu.org>\n \n \tPR target/87532"}, {"sha": "0a87241b25191ae910289fc5fb3d296ae554ff19", "filename": "gcc/multiple_target.c", "status": "modified", "additions": 24, "deletions": 13, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Fmultiple_target.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Fmultiple_target.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fmultiple_target.c?ref=a164374ef13853b25de2ad205d765fe8200bf128", "patch": "@@ -73,7 +73,7 @@ create_dispatcher_calls (struct cgraph_node *node)\n   if (!targetm.has_ifunc_p ())\n     {\n       error_at (DECL_SOURCE_LOCATION (node->decl),\n-\t\t\"the call requires ifunc, which is not\"\n+\t\t\"the call requires %<ifunc%>, which is not\"\n \t\t\" supported by this target\");\n       return;\n     }\n@@ -235,8 +235,10 @@ get_attr_str (tree arglist, char *attr_str)\n }\n \n /* Return number of attributes separated by comma and put them into ARGS.\n-   If there is no DEFAULT attribute return -1.  If there is an empty\n-   string in attribute return -2.  */\n+   If there is no DEFAULT attribute return -1.\n+   If there is an empty string in attribute return -2.\n+   If there are multiple DEFAULT attributes return -3.\n+   */\n \n static int\n separate_attrs (char *attr_str, char **attrs, int attrnum)\n@@ -256,6 +258,8 @@ separate_attrs (char *attr_str, char **attrs, int attrnum)\n     }\n   if (default_count == 0)\n     return -1;\n+  else if (default_count > 1)\n+    return -3;\n   else if (i + default_count < attrnum)\n     return -2;\n \n@@ -347,8 +351,7 @@ expand_target_clones (struct cgraph_node *node, bool definition)\n   if (attr_len == -1)\n     {\n       warning_at (DECL_SOURCE_LOCATION (node->decl),\n-\t\t  0,\n-\t\t  \"single %<target_clones%> attribute is ignored\");\n+\t\t  0, \"single %<target_clones%> attribute is ignored\");\n       return false;\n     }\n \n@@ -374,18 +377,26 @@ expand_target_clones (struct cgraph_node *node, bool definition)\n   char **attrs = XNEWVEC (char *, attrnum);\n \n   attrnum = separate_attrs (attr_str, attrs, attrnum);\n-  if (attrnum == -1)\n+  switch (attrnum)\n     {\n+    case -1:\n       error_at (DECL_SOURCE_LOCATION (node->decl),\n-\t\t\"default target was not set\");\n-      XDELETEVEC (attrs);\n-      XDELETEVEC (attr_str);\n-      return false;\n-    }\n-  else if (attrnum == -2)\n-    {\n+\t\t\"%<default%> target was not set\");\n+      break;\n+    case -2:\n       error_at (DECL_SOURCE_LOCATION (node->decl),\n \t\t\"an empty string cannot be in %<target_clones%> attribute\");\n+      break;\n+    case -3:\n+      error_at (DECL_SOURCE_LOCATION (node->decl),\n+\t\t\"multiple %<default%> targets were set\");\n+      break;\n+    default:\n+      break;\n+    }\n+\n+  if (attrnum < 0)\n+    {\n       XDELETEVEC (attrs);\n       XDELETEVEC (attr_str);\n       return false;"}, {"sha": "6d518447e86674648475fc91af0c1414790702a8", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a164374ef13853b25de2ad205d765fe8200bf128", "patch": "@@ -1,3 +1,10 @@\n+2019-04-12  Martin Liska  <mliska@suse.cz>\n+\n+\tPR middle-end/89970\n+\t* gcc.target/i386/mvc15.c: New test.\n+\t* gcc.target/i386/mvc3.c: Quote target in error pattern.\n+\t* gcc.target/i386/mvc4.c: Remove duplicit 'default'.\n+\n 2019-04-12  Kelvin Nilsen  <kelvin@gcc.gnu.org>\n \n \tPR target/87532"}, {"sha": "955aa1e9fe8ca818a41f896faa0012e8207d4f73", "filename": "gcc/testsuite/gcc.target/i386/mvc15.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc15.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc15.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc15.c?ref=a164374ef13853b25de2ad205d765fe8200bf128", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-require-ifunc \"\" } */\n+\n+__attribute__((target_clones(\"default\", \"default\")))\n+int foo (); /* { dg-error \"multiple 'default' targets were set\" } */\n+\n+int\n+bar ()\n+{\n+  return foo();\n+}"}, {"sha": "f14fc02694c435d99b827a9e22dd8a4734294026", "filename": "gcc/testsuite/gcc.target/i386/mvc3.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc3.c?ref=a164374ef13853b25de2ad205d765fe8200bf128", "patch": "@@ -2,7 +2,7 @@\n /* { dg-require-ifunc \"\" } */\n \n __attribute__((target_clones(\"avx\",\"arch=slm\",\"arch=core-avx2\")))\n-int foo (); /* { dg-error \"default target was not set\" } */\n+int foo (); /* { dg-error \"'default' target was not set\" } */\n \n int\n bar ()"}, {"sha": "1b9b0b4f174de5f84831a6afd0f1679dde9ab72a", "filename": "gcc/testsuite/gcc.target/i386/mvc4.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc4.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a164374ef13853b25de2ad205d765fe8200bf128/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc4.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fmvc4.c?ref=a164374ef13853b25de2ad205d765fe8200bf128", "patch": "@@ -1,7 +1,7 @@\n /* { dg-do run } */\n /* { dg-require-ifunc \"\" } */\n \n-__attribute__((target_clones(\"default\",\"avx\",\"default\")))\n+__attribute__((target_clones(\"default\",\"avx\")))\n int\n foo ()\n {"}]}