{"sha": "565ab7efbdc68cca5a2a81d872015f33359048b4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTY1YWI3ZWZiZGM2OGNjYTVhMmE4MWQ4NzIwMTVmMzMzNTkwNDhiNA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-03-24T08:36:32Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2020-03-24T08:36:32Z"}, "message": "loop-manip: Avoid -fcompare-debug issues in create_iv [PR94285]\n\nThe following testcase FAILs with -fcompare-debug.  The problem is that\ncreate_iv behaves differently when inserting after into an empty bb (in that\ncase sets location to goto_locus), or when inserting before gsi_end_p (i.e.\nat the end of bb; in that case it will not set location, otherwise it will\nset it to the location of next stmt).\nThis isn't -fcompare-debug friendly, because if inserting after and the\nbb contains only debug stmts, then the location will not be set with -g\nand will be with -g0, or when inserting before, the location might either\nbe set from the following debug stmt rather than some non-debug stmt after\nthat, or might not be set with -g0 if it is to be inserted at the end of bb,\nwhile with -g would be set to location of debug stmt.\n\n2020-03-24  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR debug/94285\n\t* tree-ssa-loop-manip.c (create_iv): If after, set stmt location to\n\te->goto_locus even if gsi_bb (*incr_pos) contains only debug stmts.\n\tIf not after and at *incr_pos is a debug stmt, set stmt location to\n\tlocation of next non-debug stmt after it if any.\n\n\t* gfortran.dg/pr94285.f90: New test.", "tree": {"sha": "3c7e293b8b9e7ef24e590d2a79d11bc41dd03680", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3c7e293b8b9e7ef24e590d2a79d11bc41dd03680"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/565ab7efbdc68cca5a2a81d872015f33359048b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/565ab7efbdc68cca5a2a81d872015f33359048b4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/565ab7efbdc68cca5a2a81d872015f33359048b4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/565ab7efbdc68cca5a2a81d872015f33359048b4/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a5a9400a846244d040caa6d1531434eee8fc8ec7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a5a9400a846244d040caa6d1531434eee8fc8ec7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a5a9400a846244d040caa6d1531434eee8fc8ec7"}], "stats": {"total": 26, "additions": 23, "deletions": 3}, "files": [{"sha": "976f87cd4086adfee91448f2d4a5ba146a4553e3", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=565ab7efbdc68cca5a2a81d872015f33359048b4", "patch": "@@ -1,5 +1,11 @@\n 2020-03-24  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR debug/94285\n+\t* tree-ssa-loop-manip.c (create_iv): If after, set stmt location to\n+\te->goto_locus even if gsi_bb (*incr_pos) contains only debug stmts.\n+\tIf not after and at *incr_pos is a debug stmt, set stmt location to\n+\tlocation of next non-debug stmt after it if any.\n+\n \tPR debug/94283\n \t* tree-if-conv.c (ifcvt_local_dce): For gimple debug stmts, just set\n \tGF_PLF_2, but don't add them to worklist.  Don't add an assigment to"}, {"sha": "de25dfb4f86802b048a1ead793fbf35bf6071be0", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=565ab7efbdc68cca5a2a81d872015f33359048b4", "patch": "@@ -1,5 +1,8 @@\n 2020-03-24  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR debug/94285\n+\t* gfortran.dg/pr94285.f90: New test.\n+\n \tPR debug/94283\n \t* gcc.target/i386/pr94283.c: New test.\n "}, {"sha": "8ee7f7f90218e5d8fc88a8a7913e7e509122b1c8", "filename": "gcc/testsuite/gfortran.dg/pr94285.f90", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr94285.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr94285.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr94285.f90?ref=565ab7efbdc68cca5a2a81d872015f33359048b4", "patch": "@@ -0,0 +1,5 @@\n+! PR debug/94285\n+! { dg-do compile }\n+! { dg-options \"-Os -fno-tree-dominator-opts -fno-tree-vrp -fcompare-debug\" }\n+\n+include 'array_constructor_40.f90'"}, {"sha": "a2717a411a32184f5a609d8aff3b7e83711a7f3e", "filename": "gcc/tree-ssa-loop-manip.c", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2Ftree-ssa-loop-manip.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/565ab7efbdc68cca5a2a81d872015f33359048b4/gcc%2Ftree-ssa-loop-manip.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-loop-manip.c?ref=565ab7efbdc68cca5a2a81d872015f33359048b4", "patch": "@@ -129,7 +129,10 @@ create_iv (tree base, tree step, tree var, class loop *loop,\n      immediately after a statement whose location is known.  */\n   if (after)\n     {\n-      if (gsi_end_p (*incr_pos))\n+      if (gsi_end_p (*incr_pos)\n+\t  || (is_gimple_debug (gsi_stmt (*incr_pos))\n+\t      && gsi_bb (*incr_pos)\n+\t      && gsi_end_p (gsi_last_nondebug_bb (gsi_bb (*incr_pos)))))\n \t{\n \t  edge e = single_succ_edge (gsi_bb (*incr_pos));\n \t  gimple_set_location (stmt, e->goto_locus);\n@@ -138,8 +141,11 @@ create_iv (tree base, tree step, tree var, class loop *loop,\n     }\n   else\n     {\n-      if (!gsi_end_p (*incr_pos))\n-\tgimple_set_location (stmt, gimple_location (gsi_stmt (*incr_pos)));\n+      gimple_stmt_iterator gsi = *incr_pos;\n+      if (!gsi_end_p (gsi) && is_gimple_debug (gsi_stmt (gsi)))\n+\tgsi_next_nondebug (&gsi);\n+      if (!gsi_end_p (gsi))\n+\tgimple_set_location (stmt, gimple_location (gsi_stmt (gsi)));\n       gsi_insert_before (incr_pos, stmt, GSI_NEW_STMT);\n     }\n "}]}