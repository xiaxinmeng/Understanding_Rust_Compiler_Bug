{"sha": "ebce0e9bd8d714a8607ae24331a3d842b0d11859", "node_id": "C_kwDOANBUbNoAKGViY2UwZTliZDhkNzE0YTg2MDdhZTI0MzMxYTNkODQyYjBkMTE4NTk", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2022-05-17T07:45:02Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2022-05-17T08:45:45Z"}, "message": "tree-optimization/105618 - restore load sinking\n\nThe PR97330 fix caused some missed sinking of loads out of loops\nthe following patch re-instantiates.\n\n2022-05-17  Richard Biener  <rguenther@suse.de>\n\n\tPR tree-optimization/105618\n\t* tree-ssa-sink.cc (statement_sink_location): For virtual\n\tPHI uses ignore those defining the used virtual operand.\n\n\t* gcc.dg/tree-ssa/ssa-sink-19.c: New testcase.", "tree": {"sha": "6717967b3c1211de56e2ea4c7fdf6e4c3faf84e2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6717967b3c1211de56e2ea4c7fdf6e4c3faf84e2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ebce0e9bd8d714a8607ae24331a3d842b0d11859", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ebce0e9bd8d714a8607ae24331a3d842b0d11859", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ebce0e9bd8d714a8607ae24331a3d842b0d11859", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ebce0e9bd8d714a8607ae24331a3d842b0d11859/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "33400df641d834ca3fd3f2c964ed92759f128ffa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/33400df641d834ca3fd3f2c964ed92759f128ffa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/33400df641d834ca3fd3f2c964ed92759f128ffa"}], "stats": {"total": 24, "additions": 24, "deletions": 0}, "files": [{"sha": "e98d13fe85bbbfc9b2ff45f23d775f1e8f5265f1", "filename": "gcc/testsuite/gcc.dg/tree-ssa/ssa-sink-19.c", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ebce0e9bd8d714a8607ae24331a3d842b0d11859/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fssa-sink-19.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ebce0e9bd8d714a8607ae24331a3d842b0d11859/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fssa-sink-19.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fssa-sink-19.c?ref=ebce0e9bd8d714a8607ae24331a3d842b0d11859", "patch": "@@ -0,0 +1,21 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-sink1-details -fdump-tree-cddce2-details\" } */\n+\n+static int b=4;\n+int c;\n+\n+int\n+main()\n+{\n+  int e[5] = {1,1,1,1,1};\n+  for (; b >= 0; b--) {\n+    c = e[b];\n+  }\n+  return 0;\n+}\n+\n+/* We should sink e[b] out of the loop which is possible after\n+   applying store motion to c and b.  */\n+/* { dg-final { scan-tree-dump \"Sinking # VUSE\" \"sink1\" } } */\n+/* And remove the loop after final value replacement.  */\n+/* { dg-final { scan-tree-dump \"fix_loop_structure: removing loop\" \"cddce2\" } } */"}, {"sha": "8ce4403ddc8ff84190c34c45647e4ccd666d2efc", "filename": "gcc/tree-ssa-sink.cc", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ebce0e9bd8d714a8607ae24331a3d842b0d11859/gcc%2Ftree-ssa-sink.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ebce0e9bd8d714a8607ae24331a3d842b0d11859/gcc%2Ftree-ssa-sink.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-sink.cc?ref=ebce0e9bd8d714a8607ae24331a3d842b0d11859", "patch": "@@ -390,6 +390,9 @@ statement_sink_location (gimple *stmt, basic_block frombb,\n \t\t with the use.  */\n \t      if (gimple_code (use_stmt) == GIMPLE_PHI)\n \t\t{\n+\t\t  /* If the PHI defines the virtual operand, ignore it.  */\n+\t\t  if (gimple_phi_result (use_stmt) == gimple_vuse (stmt))\n+\t\t    continue;\n \t\t  /* In case the PHI node post-dominates the current insert\n \t\t     location we can disregard it.  But make sure it is not\n \t\t     dominating it as well as can happen in a CFG cycle.  */"}]}