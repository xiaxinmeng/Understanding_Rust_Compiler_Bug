{"sha": "323eb6e3cf61d6810d9aabfcf315047550373e00", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzIzZWI2ZTNjZjYxZDY4MTBkOWFhYmZjZjMxNTA0NzU1MDM3M2UwMA==", "commit": {"author": {"name": "Tom de Vries", "email": "tom@codesourcery.com", "date": "2015-05-18T15:44:55Z"}, "committer": {"name": "Tom de Vries", "email": "vries@gcc.gnu.org", "date": "2015-05-18T15:44:55Z"}, "message": "check_GNU_style.sh: Don't do 80 char check line by line\n\n2015-05-18  Tom de Vries  <tom@codesourcery.com>\n\n\t* check_GNU_style.sh: Add temp files tmp2 and tmp3.\n\t(cat_with_prefix): New function, using global variable prefix.\n\t(col): Make prefix a global variable. Rewrite to process file at a time\n\trather than line at a time.  Print part longer than 80 chars in red.\n\nFrom-SVN: r223297", "tree": {"sha": "2ee9b0fbc2774fed19753c843bbf94c7bb5bcaf9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2ee9b0fbc2774fed19753c843bbf94c7bb5bcaf9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/323eb6e3cf61d6810d9aabfcf315047550373e00", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/323eb6e3cf61d6810d9aabfcf315047550373e00", "html_url": "https://github.com/Rust-GCC/gccrs/commit/323eb6e3cf61d6810d9aabfcf315047550373e00", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/323eb6e3cf61d6810d9aabfcf315047550373e00/comments", "author": null, "committer": null, "parents": [{"sha": "0454e698401a3ec49700e59855e44493ab9fdbdb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0454e698401a3ec49700e59855e44493ab9fdbdb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0454e698401a3ec49700e59855e44493ab9fdbdb"}], "stats": {"total": 77, "additions": 59, "deletions": 18}, "files": [{"sha": "77d766faa8a8d88770551c742f45a9c9ef6d1f70", "filename": "contrib/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/323eb6e3cf61d6810d9aabfcf315047550373e00/contrib%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/323eb6e3cf61d6810d9aabfcf315047550373e00/contrib%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2FChangeLog?ref=323eb6e3cf61d6810d9aabfcf315047550373e00", "patch": "@@ -1,3 +1,10 @@\n+2015-05-18  Tom de Vries  <tom@codesourcery.com>\n+\n+\t* check_GNU_style.sh: Add temp files tmp2 and tmp3.\n+\t(cat_with_prefix): New function, using global variable prefix.\n+\t(col): Make prefix a global variable. Rewrite to process file at a time\n+\trather than line at a time.  Print part longer than 80 chars in red.\n+\n 2015-05-18  Tom de Vries  <tom@codesourcery.com>\n \n \t* check_GNU_style.sh (g, ag, vg): Don't cat empty file."}, {"sha": "033a2c91b601ce851e3795783ab1407df4d6ad4a", "filename": "contrib/check_GNU_style.sh", "status": "modified", "additions": 52, "deletions": 18, "changes": 70, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/323eb6e3cf61d6810d9aabfcf315047550373e00/contrib%2Fcheck_GNU_style.sh", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/323eb6e3cf61d6810d9aabfcf315047550373e00/contrib%2Fcheck_GNU_style.sh", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fcheck_GNU_style.sh?ref=323eb6e3cf61d6810d9aabfcf315047550373e00", "patch": "@@ -65,10 +65,12 @@ fi\n \n inp=check_GNU_style.inp\n tmp=check_GNU_style.tmp\n+tmp2=check_GNU_style.2.tmp\n+tmp3=check_GNU_style.3.tmp\n \n # Remove $tmp on exit and various signals.\n-trap \"rm -f $inp $tmp $stdin_tmp\" 0\n-trap \"rm -f $inp $tmp $stdin_tmp; exit 1\" 1 2 3 5 9 13 15\n+trap \"rm -f $inp $tmp $tmp2 $tmp3 $stdin_tmp\" 0\n+trap \"rm -f $inp $tmp $tmp2 $tmp3 $stdin_tmp; exit 1\" 1 2 3 5 9 13 15\n \n if [ $nfiles -eq 1 ]; then\n     # There's no need for the file prefix if we're dealing only with one file.\n@@ -80,6 +82,17 @@ grep $format '^+' $files \\\n     | grep -v ':+++' \\\n     > $inp\n \n+cat_with_prefix ()\n+{\n+    local f=\"$1\"\n+\n+    if [ \"$prefix\" = \"\" ]; then\n+\tcat \"$f\"\n+    else\n+\tawk \"{printf \"%s%s\\n\", $prefix, \\$0}\" $f\n+    fi\n+}\n+\n # Grep\n g (){\n     local msg=\"$1\"\n@@ -134,10 +147,11 @@ vg (){\n \n col (){\n     local msg=\"$1\"\n+\n     local first=true\n     local f\n     for f in $files; do\n-\tlocal prefix=\"\"\n+\tprefix=\"\"\n \tif [ $nfiles -ne 1 ]; then\n \t    prefix=\"$f:\"\n \tfi\n@@ -148,22 +162,42 @@ col (){\n \t    | grep -v ':+++' \\\n \t    > $tmp\n \n-\tcat $tmp | while IFS= read -r line; do\n-\t    local longline\n-\t    # Filter out the line number prefix and the patch line modifier '+'\n-\t    # to obtain the bare line, before we use expand.\n-\t    longline=$(echo \"$line\" \\\n-\t\t| sed 's/^[0-9]*:+//' \\\n-\t\t| expand \\\n-\t\t| awk '{ if (length($0) > 80) print $0}')\n-\t    if [ \"$longline\" != \"\" ]; then\n-\t\tif $first; then\n-\t\t    printf \"\\n$msg\\n\"\n-\t\t    first=false\n-\t\tfi\n-\t\techo \"$prefix$line\"\n+\t# Keep only line number prefix and patch modifier '+'.\n+\tcat \"$tmp\" \\\n+\t    | sed 's/\\(^[0-9][0-9]*:+\\).*/\\1/' \\\n+\t    > \"$tmp2\"\n+\n+\t# Remove line number prefix and patch modifier '+'.\n+\t# Expand tabs to spaces according to tab positions.\n+\t# Keep long lines, make short lines empty.  Print the part past 80 chars\n+\t# in red.\n+\tcat \"$tmp\" \\\n+\t    | sed 's/^[0-9]*:+//' \\\n+\t    | expand \\\n+\t    | awk '{ \\\n+\t\t     if (length($0) > 80) \\\n+\t\t       printf \"%s\\033[1;31m%s\\033[0m\\n\", \\\n+\t\t\t      substr($0,1,80), \\\n+\t\t\t      substr($0,81); \\\n+\t\t     else \\\n+\t\t       print \"\" \\\n+\t\t   }' \\\n+\t    > \"$tmp3\"\n+\n+\t# Combine prefix back with long lines.\n+\t# Filter out empty lines.\n+\tlocal found=false\n+\tpaste -d '' \"$tmp2\" \"$tmp3\" \\\n+\t    | grep -v '^[0-9][0-9]*:+$' \\\n+\t    > \"$tmp\" && found=true\n+\n+\tif $found; then\n+\t    if $first; then\n+\t\tprintf \"\\n$msg\\n\"\n+\t\tfirst=false\n \t    fi\n-\tdone\n+\t    cat_with_prefix \"$tmp\"\n+\tfi\n     done\n }\n "}]}