{"sha": "c5ecf679d5d226fdf3c8b0dd5be89c5790247304", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzVlY2Y2NzlkNWQyMjZmZGYzYzhiMGRkNWJlODljNTc5MDI0NzMwNA==", "commit": {"author": {"name": "Gary Dismukes", "email": "dismukes@adacore.com", "date": "2008-05-26T15:15:14Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2008-05-26T15:15:14Z"}, "message": "exp_ch3.adb (Build_Array_Init_Proc): Only set Init_Proc to a dummy init proc entity when...\n\n2008-05-26  Gary Dismukes  <dismukes@adacore.com>\n\n\t* exp_ch3.adb (Build_Array_Init_Proc): Only set Init_Proc to a dummy\n\tinit proc entity when there is actual default initialization associated\n\twith the component type, to avoid spurious errors on objects of scalar\n\tarray types that are marked Is_Public when No_Default_Initialization\n\tapplies.\n\nFrom-SVN: r135938", "tree": {"sha": "46c60dccfdc124935bda6f8c97975730af00f90d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/46c60dccfdc124935bda6f8c97975730af00f90d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c5ecf679d5d226fdf3c8b0dd5be89c5790247304", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c5ecf679d5d226fdf3c8b0dd5be89c5790247304", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c5ecf679d5d226fdf3c8b0dd5be89c5790247304", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c5ecf679d5d226fdf3c8b0dd5be89c5790247304/comments", "author": {"login": "dismukes", "id": 50880541, "node_id": "MDQ6VXNlcjUwODgwNTQx", "avatar_url": "https://avatars.githubusercontent.com/u/50880541?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dismukes", "html_url": "https://github.com/dismukes", "followers_url": "https://api.github.com/users/dismukes/followers", "following_url": "https://api.github.com/users/dismukes/following{/other_user}", "gists_url": "https://api.github.com/users/dismukes/gists{/gist_id}", "starred_url": "https://api.github.com/users/dismukes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dismukes/subscriptions", "organizations_url": "https://api.github.com/users/dismukes/orgs", "repos_url": "https://api.github.com/users/dismukes/repos", "events_url": "https://api.github.com/users/dismukes/events{/privacy}", "received_events_url": "https://api.github.com/users/dismukes/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c986420eb0a0d4a31192dc483dee3ced6edf513b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c986420eb0a0d4a31192dc483dee3ced6edf513b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c986420eb0a0d4a31192dc483dee3ced6edf513b"}], "stats": {"total": 36, "additions": 23, "deletions": 13}, "files": [{"sha": "8324763e92a6d9af40f7f9b4e903d4b7176de90d", "filename": "gcc/ada/exp_ch3.adb", "status": "modified", "additions": 23, "deletions": 13, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c5ecf679d5d226fdf3c8b0dd5be89c5790247304/gcc%2Fada%2Fexp_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c5ecf679d5d226fdf3c8b0dd5be89c5790247304/gcc%2Fada%2Fexp_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch3.adb?ref=c5ecf679d5d226fdf3c8b0dd5be89c5790247304", "patch": "@@ -533,11 +533,12 @@ package body Exp_Ch3 is\n    ---------------------------\n \n    procedure Build_Array_Init_Proc (A_Type : Entity_Id; Nod : Node_Id) is\n-      Loc        : constant Source_Ptr := Sloc (Nod);\n-      Comp_Type  : constant Entity_Id  := Component_Type (A_Type);\n-      Index_List : List_Id;\n-      Proc_Id    : Entity_Id;\n-      Body_Stmts : List_Id;\n+      Loc              : constant Source_Ptr := Sloc (Nod);\n+      Comp_Type        : constant Entity_Id  := Component_Type (A_Type);\n+      Index_List       : List_Id;\n+      Proc_Id          : Entity_Id;\n+      Body_Stmts       : List_Id;\n+      Has_Default_Init : Boolean;\n \n       function Init_Component return List_Id;\n       --  Create one statement to initialize one array component, designated\n@@ -671,14 +672,16 @@ package body Exp_Ch3 is\n       --  the issue arises) in a special manner anyway which does not need an\n       --  init_proc.\n \n-      if Has_Non_Null_Base_Init_Proc (Comp_Type)\n-        or else Needs_Simple_Initialization (Comp_Type)\n-        or else Has_Task (Comp_Type)\n+      Has_Default_Init := Has_Non_Null_Base_Init_Proc (Comp_Type)\n+                            or else Needs_Simple_Initialization (Comp_Type)\n+                            or else Has_Task (Comp_Type);\n+\n+      if Has_Default_Init\n         or else (not Restriction_Active (No_Initialize_Scalars)\n-                   and then Is_Public (A_Type)\n-                   and then Root_Type (A_Type) /= Standard_String\n-                   and then Root_Type (A_Type) /= Standard_Wide_String\n-                   and then Root_Type (A_Type) /= Standard_Wide_Wide_String)\n+                  and then Is_Public (A_Type)\n+                  and then Root_Type (A_Type) /= Standard_String\n+                  and then Root_Type (A_Type) /= Standard_Wide_String\n+                  and then Root_Type (A_Type) /= Standard_Wide_Wide_String)\n       then\n          Proc_Id :=\n            Make_Defining_Identifier (Loc,\n@@ -688,9 +691,16 @@ package body Exp_Ch3 is\n          --  want to build an init_proc, but we need to mark that an init_proc\n          --  would be needed if this restriction was not active (so that we can\n          --  detect attempts to call it), so set a dummy init_proc in place.\n+         --  This is only done though when actual default initialization is\n+         --  needed, so we exclude the setting in the Is_Public case, such\n+         --  as for arrays of scalars, since otherwise such objects would be\n+         --  wrongly flagged as violating the restriction.\n \n          if Restriction_Active (No_Default_Initialization) then\n-            Set_Init_Proc (A_Type, Proc_Id);\n+            if Has_Default_Init then\n+               Set_Init_Proc (A_Type, Proc_Id);\n+            end if;\n+\n             return;\n          end if;\n "}]}