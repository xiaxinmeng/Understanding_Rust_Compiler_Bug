{"sha": "7506ab1de576b07067bf3c0acb74f9d80ece7a86", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzUwNmFiMWRlNTc2YjA3MDY3YmYzYzBhY2I3NGY5ZDgwZWNlN2E4Ng==", "commit": {"author": {"name": "Ville Voutilainen", "email": "ville.voutilainen@gmail.com", "date": "2011-05-10T17:58:30Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2011-05-10T17:58:30Z"}, "message": "Fixes for override/final.\n\n\t* class.c (check_for_override): Diagnose final on a nonvirtual\n\tmember function, diagnose override for a virtual with no matching\n\toverride. Don't fiddle around with DECL_VINDEX.\n\nFrom-SVN: r173626", "tree": {"sha": "710ca438091dba750c52619a7fc01f06e2c6aa0f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/710ca438091dba750c52619a7fc01f06e2c6aa0f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7506ab1de576b07067bf3c0acb74f9d80ece7a86", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7506ab1de576b07067bf3c0acb74f9d80ece7a86", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7506ab1de576b07067bf3c0acb74f9d80ece7a86", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7506ab1de576b07067bf3c0acb74f9d80ece7a86/comments", "author": {"login": "villevoutilainen", "id": 963599, "node_id": "MDQ6VXNlcjk2MzU5OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/963599?v=4", "gravatar_id": "", "url": "https://api.github.com/users/villevoutilainen", "html_url": "https://github.com/villevoutilainen", "followers_url": "https://api.github.com/users/villevoutilainen/followers", "following_url": "https://api.github.com/users/villevoutilainen/following{/other_user}", "gists_url": "https://api.github.com/users/villevoutilainen/gists{/gist_id}", "starred_url": "https://api.github.com/users/villevoutilainen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/villevoutilainen/subscriptions", "organizations_url": "https://api.github.com/users/villevoutilainen/orgs", "repos_url": "https://api.github.com/users/villevoutilainen/repos", "events_url": "https://api.github.com/users/villevoutilainen/events{/privacy}", "received_events_url": "https://api.github.com/users/villevoutilainen/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d26e59864b3ea46ad8d4671a3c55f86cf5f2fa94", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d26e59864b3ea46ad8d4671a3c55f86cf5f2fa94", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d26e59864b3ea46ad8d4671a3c55f86cf5f2fa94"}], "stats": {"total": 55, "additions": 45, "deletions": 10}, "files": [{"sha": "aa2d2f51c3629c0ca6bb983dd82e22ecae8064dd", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=7506ab1de576b07067bf3c0acb74f9d80ece7a86", "patch": "@@ -1,3 +1,10 @@\n+2011-05-10  Ville Voutilainen  <ville.voutilainen@gmail.com>\n+\n+\tFixes for override/final.\n+\t* class.c (check_for_override): Diagnose final on a nonvirtual\n+\tmember function, diagnose override for a virtual with no matching\n+\toverride. Don't fiddle around with DECL_VINDEX.\n+\n 2011-05-10  Nathan Froyd  <froydnj@codesourcery.com>\n \n         * cp-tree.def (EXPR_PACK_EXPANSION): Add an operand."}, {"sha": "198eca654315246f2cc3be624b63a044a02e049e", "filename": "gcc/cp/class.c", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Fcp%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Fcp%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fclass.c?ref=7506ab1de576b07067bf3c0acb74f9d80ece7a86", "patch": "@@ -2453,6 +2453,7 @@ get_basefndecls (tree name, tree t)\n void\n check_for_override (tree decl, tree ctype)\n {\n+  bool overrides_found = false;\n   if (TREE_CODE (decl) == TEMPLATE_DECL)\n     /* In [temp.mem] we have:\n \n@@ -2467,7 +2468,10 @@ check_for_override (tree decl, tree ctype)\n     /* Set DECL_VINDEX to a value that is neither an INTEGER_CST nor\n        the error_mark_node so that we know it is an overriding\n        function.  */\n-    DECL_VINDEX (decl) = decl;\n+    {\n+      DECL_VINDEX (decl) = decl;\n+      overrides_found = true;\n+    }\n \n   if (DECL_VIRTUAL_P (decl))\n     {\n@@ -2477,11 +2481,10 @@ check_for_override (tree decl, tree ctype)\n       if (DECL_DESTRUCTOR_P (decl))\n \tTYPE_HAS_NONTRIVIAL_DESTRUCTOR (ctype) = true;\n     }\n-  else if (DECL_OVERRIDE_P (decl))\n-    {\n-      DECL_VINDEX (decl) = error_mark_node;\n-      error (\"%q+#D marked override, but does not override\", decl);\n-    }\n+  else if (DECL_FINAL_P (decl))\n+    error (\"%q+#D marked final, but is not virtual\", decl);\n+  if (DECL_OVERRIDE_P (decl) && !overrides_found)\n+    error (\"%q+#D marked override, but does not override\", decl);\n }\n \n /* Warn about hidden virtual functions that are not overridden in t."}, {"sha": "e133d9d7da001247365963c8f59926729a873766", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=7506ab1de576b07067bf3c0acb74f9d80ece7a86", "patch": "@@ -1,3 +1,7 @@\n+2011-05-10  Ville Voutilainen  <ville.voutilainen@gmail.com>\n+\n+\t* g++.dg/inherit/virtual9.C: Extend.\n+\n 2011-05-10  Michael Meissner  <meissner@linux.vnet.ibm.com>\n \n \tPR target/48857"}, {"sha": "83e04790873f770bb0946af5db1f11681d195d77", "filename": "gcc/testsuite/g++.dg/inherit/virtual9.C", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Finherit%2Fvirtual9.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7506ab1de576b07067bf3c0acb74f9d80ece7a86/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Finherit%2Fvirtual9.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Finherit%2Fvirtual9.C?ref=7506ab1de576b07067bf3c0acb74f9d80ece7a86", "patch": "@@ -3,6 +3,7 @@ struct B\n {\n   virtual void f() final {}\n   virtual void g() {}\n+  virtual void x() const {}\n };\n \n struct B2\n@@ -20,7 +21,12 @@ template <class T> struct D2 : T\n   void h() override {} // { dg-error \"marked override, but does not override\" }\n };\n \n-struct D3 : D\n+template <class T> struct D3 : T\n+{\n+  void h() override {}\n+};\n+\n+struct D4 : D\n {\n   void g() {} // { dg-error \"virtual function\" }\n };\n@@ -30,10 +36,25 @@ struct B3\n   virtual void f() final final {} // { dg-error \"duplicate virt-specifier\" }\n };\n \n-void g() override {} // { dg-error \"virt-specifiers\" }\n+struct B4\n+{\n+  void f() final {} // { dg-error \"marked final, but is not virtual\" }\n+};\n+\n+struct D5 : B\n+{\n+  void ff() override {} // { dg-error \"marked override, but does not override\" }\n+  virtual void fff() override {} // { dg-error \"marked override, but does not override\" }\n+  virtual void x() override {} // { dg-error \"marked override, but does not override\" }\n+  void g() override;\n+};\n+\n+void D5::g() override {} // { dg-error \"not allowed outside a class definition\" }\n+void g() override {} // { dg-error \"not allowed outside a class definition\" }\n \n int main()\n {\n-  D2<B> d2;\n-  D2<B2> d3;\n+  D2<B> d;\n+  D2<B2> d2;\n+  D3<B2> d3;\n }"}]}