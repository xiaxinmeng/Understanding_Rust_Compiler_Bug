{"sha": "504424f33771be0405454e7845219d5df1bb88bb", "node_id": "C_kwDOANBUbNoAKDUwNDQyNGYzMzc3MWJlMDQwNTQ1NGU3ODQ1MjE5ZDVkZjFiYjg4YmI", "commit": {"author": {"name": "Jos\u00e9 Rui Faustino de Sousa", "email": "jrfsousa@gmail.com", "date": "2022-09-02T19:35:22Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2022-09-03T18:32:37Z"}, "message": "Fortran: Fix ICE with automatic reallocation [PR100245]\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/100245\n\t* trans-expr.cc (trans_class_assignment): Add if clause to handle\n\tderived type in the LHS.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/100245\n\t* gfortran.dg/PR100245.f90: New test.", "tree": {"sha": "3a62158659305463f37321dc142c0f93742b9f5c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3a62158659305463f37321dc142c0f93742b9f5c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/504424f33771be0405454e7845219d5df1bb88bb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/504424f33771be0405454e7845219d5df1bb88bb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/504424f33771be0405454e7845219d5df1bb88bb", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/504424f33771be0405454e7845219d5df1bb88bb/comments", "author": {"login": "jrfsousa", "id": 56982651, "node_id": "MDQ6VXNlcjU2OTgyNjUx", "avatar_url": "https://avatars.githubusercontent.com/u/56982651?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jrfsousa", "html_url": "https://github.com/jrfsousa", "followers_url": "https://api.github.com/users/jrfsousa/followers", "following_url": "https://api.github.com/users/jrfsousa/following{/other_user}", "gists_url": "https://api.github.com/users/jrfsousa/gists{/gist_id}", "starred_url": "https://api.github.com/users/jrfsousa/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jrfsousa/subscriptions", "organizations_url": "https://api.github.com/users/jrfsousa/orgs", "repos_url": "https://api.github.com/users/jrfsousa/repos", "events_url": "https://api.github.com/users/jrfsousa/events{/privacy}", "received_events_url": "https://api.github.com/users/jrfsousa/received_events", "type": "User", "site_admin": false}, "committer": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dae8b9e2bbb6017bf90d68c7b720c500125c8295", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dae8b9e2bbb6017bf90d68c7b720c500125c8295", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dae8b9e2bbb6017bf90d68c7b720c500125c8295"}], "stats": {"total": 31, "additions": 31, "deletions": 0}, "files": [{"sha": "13c3e7df45f520d68afd945fce39aa131f7f8176", "filename": "gcc/fortran/trans-expr.cc", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/504424f33771be0405454e7845219d5df1bb88bb/gcc%2Ffortran%2Ftrans-expr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/504424f33771be0405454e7845219d5df1bb88bb/gcc%2Ffortran%2Ftrans-expr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-expr.cc?ref=504424f33771be0405454e7845219d5df1bb88bb", "patch": "@@ -11436,6 +11436,9 @@ trans_class_assignment (stmtblock_t *block, gfc_expr *lhs, gfc_expr *rhs,\n       class_han = GFC_CLASS_TYPE_P (TREE_TYPE (lse->expr))\n \t  ? gfc_class_data_get (lse->expr) : lse->expr;\n \n+      if (!POINTER_TYPE_P (TREE_TYPE (class_han)))\n+\tclass_han = gfc_build_addr_expr (NULL_TREE, class_han);\n+\n       /* Allocate block.  */\n       gfc_init_block (&alloc);\n       gfc_allocate_using_malloc (&alloc, class_han, size, NULL_TREE);"}, {"sha": "07c1f7b3a1ce011df977e900a8f571109b46afc5", "filename": "gcc/testsuite/gfortran.dg/PR100245.f90", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/504424f33771be0405454e7845219d5df1bb88bb/gcc%2Ftestsuite%2Fgfortran.dg%2FPR100245.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/504424f33771be0405454e7845219d5df1bb88bb/gcc%2Ftestsuite%2Fgfortran.dg%2FPR100245.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2FPR100245.f90?ref=504424f33771be0405454e7845219d5df1bb88bb", "patch": "@@ -0,0 +1,28 @@\n+! { dg-do run }\n+!\n+! Test the fix for PR100245\n+!\n+\n+program main_p\n+\n+  implicit none\n+\n+  type :: foo_t\n+    integer :: a\n+  end type foo_t\n+\n+  integer, parameter :: a = 42\n+\n+  class(foo_t), allocatable :: val\n+  class(foo_t), allocatable :: rs1\n+  type(foo_t),  allocatable :: rs2\n+\n+  allocate(val, source=foo_t(42))\n+  if (val%a/=a) stop 1\n+  rs1 = val\n+  if (rs1%a/=a) stop 2\n+  rs2 = val\n+  if (rs2%a/=a) stop 3\n+  deallocate(val, rs1, rs2)\n+\n+end program main_p"}]}