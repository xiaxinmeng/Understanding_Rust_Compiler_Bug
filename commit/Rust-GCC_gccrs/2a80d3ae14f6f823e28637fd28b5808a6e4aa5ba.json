{"sha": "2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmE4MGQzYWUxNGY2ZjgyM2UyODYzN2ZkMjhiNTgwOGE2ZTRhYTViYQ==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2018-03-21T13:09:09Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2018-03-21T13:09:09Z"}, "message": "C++: show private field accessor hints for const accesses (PR c++/84892)\n\ngcc/cp/ChangeLog:\n\tPR c++/84892\n\t* search.c (field_accessor_p): Use class_of_this_parm rather than\n\ttype_of_this_parm, to check that \"this\" is a \"const T *\", rather\n\tthan a \"T *const\".\n\ngcc/testsuite/ChangeLog:\n\tPR c++/84892\n\t* g++.dg/other/accessor-fixits-1.C\n\t(test_access_const_t1_color): New.\n\t(test_deref_const_t1_color): New.\n\t* g++.dg/other/accessor-fixits-5.C: New testcase.\n\nFrom-SVN: r258716", "tree": {"sha": "86d55601cfd0c25ca63798a94855f2a8ef645709", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/86d55601cfd0c25ca63798a94855f2a8ef645709"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "8bb406a2916060d123a97974072ceb74ac9c92cc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8bb406a2916060d123a97974072ceb74ac9c92cc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8bb406a2916060d123a97974072ceb74ac9c92cc"}], "stats": {"total": 96, "additions": 94, "deletions": 2}, "files": [{"sha": "74bc9867c1d91c716c9010e2c82567fd1610d5cd", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "patch": "@@ -1,3 +1,10 @@\n+2018-03-21  David Malcolm  <dmalcolm@redhat.com>\n+\n+\tPR c++/84892\n+\t* search.c (field_accessor_p): Use class_of_this_parm rather than\n+\ttype_of_this_parm, to check that \"this\" is a \"const T *\", rather\n+\tthan a \"T *const\".\n+\n 2018-03-21  Nathan Sidwell  <nathan@acm.org>\n \n \t* class.c (finish_struct_anon_r): Refactor, deprecate anything"}, {"sha": "ddcff69ae6f7fefbcf1ff0a183cb4736ab20cb7e", "filename": "gcc/cp/search.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Fcp%2Fsearch.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Fcp%2Fsearch.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsearch.c?ref=2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "patch": "@@ -1747,8 +1747,8 @@ field_accessor_p (tree fn, tree field_decl, bool const_p)\n      that the \"this\" parameter is const.  */\n   if (const_p)\n     {\n-      tree this_type = type_of_this_parm (fntype);\n-      if (!TYPE_READONLY (this_type))\n+      tree this_class = class_of_this_parm (fntype);\n+      if (!TYPE_READONLY (this_class))\n \treturn false;\n     }\n "}, {"sha": "5d62630a9fd32a7df6a97e907bca5c15e9f77c1a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "patch": "@@ -1,3 +1,11 @@\n+2018-03-21  David Malcolm  <dmalcolm@redhat.com>\n+\n+\tPR c++/84892\n+\t* g++.dg/other/accessor-fixits-1.C\n+\t(test_access_const_t1_color): New.\n+\t(test_deref_const_t1_color): New.\n+\t* g++.dg/other/accessor-fixits-5.C: New testcase.\n+\n 2018-03-21  Tom de Vries  <tom@codesourcery.com>\n \n \tPR tree-optimization/83126"}, {"sha": "fd46a522486c275780beb602e1c5033f2c2f941b", "filename": "gcc/testsuite/g++.dg/other/accessor-fixits-1.C", "status": "modified", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Faccessor-fixits-1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Faccessor-fixits-1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Faccessor-fixits-1.C?ref=2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "patch": "@@ -35,6 +35,28 @@ int test_access_t1_color (t1 &ref)\n      { dg-end-multiline-output \"\" } */\n }\n \n+int test_access_const_t1_color (const t1 &ref)\n+{\n+  return ref.m_color; // { dg-error \".int t1::m_color. is private within this context\" }\n+  /* { dg-begin-multiline-output \"\" }\n+   return ref.m_color;\n+              ^~~~~~~\n+     { dg-end-multiline-output \"\" } */\n+\n+\n+  /* { dg-begin-multiline-output \"\" }\n+   int m_color;\n+       ^~~~~~~\n+     { dg-end-multiline-output \"\" } */\n+\n+  // { dg-message \"field .int t1::m_color. can be accessed via .int t1::get_color\\\\(\\\\) const.\" \"\" { target *-*-* } .-12 }\n+  /* { dg-begin-multiline-output \"\" }\n+   return ref.m_color;\n+              ^~~~~~~\n+              get_color()\n+     { dg-end-multiline-output \"\" } */\n+}\n+\n int test_access_t1_shape (t1 &ref)\n {\n   return ref.m_shape; // { dg-error \".int t1::m_shape. is protected within this context\" }\n@@ -79,6 +101,28 @@ int test_deref_t1_color (t1 *ptr)\n      { dg-end-multiline-output \"\" } */\n }\n \n+int test_deref_const_t1_color (const t1 *ptr)\n+{\n+  return ptr->m_color; // { dg-error \".int t1::m_color. is private within this context\" }\n+  /* { dg-begin-multiline-output \"\" }\n+   return ptr->m_color;\n+               ^~~~~~~\n+     { dg-end-multiline-output \"\" } */\n+\n+\n+  /* { dg-begin-multiline-output \"\" }\n+   int m_color;\n+       ^~~~~~~\n+     { dg-end-multiline-output \"\" } */\n+\n+  // { dg-message \"field .int t1::m_color. can be accessed via .int t1::get_color\\\\(\\\\) const.\" \"\" { target *-*-* } .-12 }\n+  /* { dg-begin-multiline-output \"\" }\n+   return ptr->m_color;\n+               ^~~~~~~\n+               get_color()\n+     { dg-end-multiline-output \"\" } */\n+}\n+\n int test_deref_t1_shape (t1 *ptr)\n {\n   return ptr->m_shape; // { dg-error \".int t1::m_shape. is protected within this context\" }"}, {"sha": "cf72d784330c01759a8e7eca43ef834e9f55959d", "filename": "gcc/testsuite/g++.dg/other/accessor-fixits-5.C", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Faccessor-fixits-5.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Faccessor-fixits-5.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Faccessor-fixits-5.C?ref=2a80d3ae14f6f823e28637fd28b5808a6e4aa5ba", "patch": "@@ -0,0 +1,33 @@\n+// PR c++/84892\n+// { dg-options \"-fdiagnostics-show-caret\" }\n+\n+class S {\n+private:\n+  bool field;\n+\n+public:\n+  bool get_field() const {\n+    return field;\n+  }\n+};\n+\n+bool thingy(const S & s) {\n+  return s.field; // { dg-error \"'bool S::field' is private within this context\" }\n+  /* { dg-begin-multiline-output \"\" }\n+   return s.field;\n+            ^~~~~\n+     { dg-end-multiline-output \"\" } */\n+\n+  // { dg-message \"declared private here\" \"\" { target *-*-* } 6 }\n+  /* { dg-begin-multiline-output \"\" }\n+   bool field;\n+        ^~~~~\n+     { dg-end-multiline-output \"\" } */\n+ \n+  // { dg-message \"field 'bool S::field' can be accessed via 'bool S::get_field\\\\(\\\\) const'\" \"\" { target *-*-* } .-12 }\n+  /* { dg-begin-multiline-output \"\" }\n+   return s.field;\n+            ^~~~~\n+            get_field()\n+     { dg-end-multiline-output \"\" } */\n+}"}]}