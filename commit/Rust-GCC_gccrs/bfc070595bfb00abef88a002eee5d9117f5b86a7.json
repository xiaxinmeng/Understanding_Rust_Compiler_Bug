{"sha": "bfc070595bfb00abef88a002eee5d9117f5b86a7", "node_id": "C_kwDOANBUbNoAKGJmYzA3MDU5NWJmYjAwYWJlZjg4YTAwMmVlZTVkOTExN2Y1Yjg2YTc", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-02-01T09:38:46Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-02-01T09:38:46Z"}, "message": "c++, openmp: Handle some OMP_*/OACC_* constructs during constant expression evaluation [PR108607]\n\nWhile potential_constant_expression_1 handled most of OMP_* codes (by saying that\nthey aren't potential constant expressions), OMP_SCOPE was missing in that list.\nI've also added OMP_SCAN, though that is less important (similarly to OMP_SECTION\nit ought to appear solely inside of OMP_{FOR,SIMD} resp. OMP_SECTIONS).\nAs the testcase shows, it isn't enough, potential_constant_expression_1\ncan catch only some cases, as soon as one uses switch or ifs where at least\none of the possible paths could be constant expression, we can run into the\nsame codes during cxx_eval_constant_expression, so this patch handles those\nthere as well.\n\n2023-02-01  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR c++/108607\n\t* constexpr.cc (cxx_eval_constant_expression): Handle OMP_*\n\tand OACC_* constructs as non-constant.\n\t(potential_constant_expression_1): Handle OMP_SCAN and OMP_SCOPE.\n\n\t* g++.dg/gomp/pr108607.C: New test.", "tree": {"sha": "1ba714205e9730b198b4466741e3ba89750f0506", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/1ba714205e9730b198b4466741e3ba89750f0506"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bfc070595bfb00abef88a002eee5d9117f5b86a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bfc070595bfb00abef88a002eee5d9117f5b86a7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bfc070595bfb00abef88a002eee5d9117f5b86a7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bfc070595bfb00abef88a002eee5d9117f5b86a7/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8091199cdf4d0aa9c28e4526548ddc25d02898ca", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8091199cdf4d0aa9c28e4526548ddc25d02898ca", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8091199cdf4d0aa9c28e4526548ddc25d02898ca"}], "stats": {"total": 94, "additions": 94, "deletions": 0}, "files": [{"sha": "5b31f9c27d19040fbf73e4486fb9874699573325", "filename": "gcc/cp/constexpr.cc", "status": "modified", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfc070595bfb00abef88a002eee5d9117f5b86a7/gcc%2Fcp%2Fconstexpr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfc070595bfb00abef88a002eee5d9117f5b86a7/gcc%2Fcp%2Fconstexpr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fconstexpr.cc?ref=bfc070595bfb00abef88a002eee5d9117f5b86a7", "patch": "@@ -8001,6 +8001,51 @@ cxx_eval_constant_expression (const constexpr_ctx *ctx, tree t,\n       r = cxx_eval_bit_cast (ctx, t, non_constant_p, overflow_p);\n       break;\n \n+    case OMP_PARALLEL:\n+    case OMP_TASK:\n+    case OMP_FOR:\n+    case OMP_SIMD:\n+    case OMP_DISTRIBUTE:\n+    case OMP_TASKLOOP:\n+    case OMP_LOOP:\n+    case OMP_TEAMS:\n+    case OMP_TARGET_DATA:\n+    case OMP_TARGET:\n+    case OMP_SECTIONS:\n+    case OMP_ORDERED:\n+    case OMP_CRITICAL:\n+    case OMP_SINGLE:\n+    case OMP_SCAN:\n+    case OMP_SCOPE:\n+    case OMP_SECTION:\n+    case OMP_MASTER:\n+    case OMP_MASKED:\n+    case OMP_TASKGROUP:\n+    case OMP_TARGET_UPDATE:\n+    case OMP_TARGET_ENTER_DATA:\n+    case OMP_TARGET_EXIT_DATA:\n+    case OMP_ATOMIC:\n+    case OMP_ATOMIC_READ:\n+    case OMP_ATOMIC_CAPTURE_OLD:\n+    case OMP_ATOMIC_CAPTURE_NEW:\n+    case OMP_DEPOBJ:\n+    case OACC_PARALLEL:\n+    case OACC_KERNELS:\n+    case OACC_SERIAL:\n+    case OACC_DATA:\n+    case OACC_HOST_DATA:\n+    case OACC_LOOP:\n+    case OACC_CACHE:\n+    case OACC_DECLARE:\n+    case OACC_ENTER_DATA:\n+    case OACC_EXIT_DATA:\n+    case OACC_UPDATE:\n+      if (!ctx->quiet)\n+\terror_at (EXPR_LOCATION (t),\n+\t\t  \"statement is not a constant expression\");\n+      *non_constant_p = true;\n+      break;\n+\n     default:\n       if (STATEMENT_CODE_P (TREE_CODE (t)))\n \t{\n@@ -9471,6 +9516,8 @@ potential_constant_expression_1 (tree t, bool want_rval, bool strict, bool now,\n     case OMP_ORDERED:\n     case OMP_CRITICAL:\n     case OMP_SINGLE:\n+    case OMP_SCAN:\n+    case OMP_SCOPE:\n     case OMP_SECTION:\n     case OMP_MASTER:\n     case OMP_MASKED:"}, {"sha": "9e5137b63deb6c371c496b1d011c70f122a930c6", "filename": "gcc/testsuite/g++.dg/gomp/pr108607.C", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bfc070595bfb00abef88a002eee5d9117f5b86a7/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr108607.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bfc070595bfb00abef88a002eee5d9117f5b86a7/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr108607.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr108607.C?ref=bfc070595bfb00abef88a002eee5d9117f5b86a7", "patch": "@@ -0,0 +1,47 @@\n+// PR c++/108607\n+// { dg-do compile { target c++14 } }\n+// { dg-options \"-fopenmp\" }\n+\n+constexpr int\n+bar (int x)\n+{\n+  return x;\n+}\n+\n+constexpr int\n+foo (int x)\t\t\t// { dg-message \"declared here\" \"\" { target c++20_down } }\n+{\t\t\t\t// { dg-message \"is not usable as a 'constexpr' function because\" \"\" { target c++23 } .-1 }\n+  #pragma omp scope\t\t// { dg-warning \"is not a constant expression\" \"\" { target c++20_down } }\n+  x = bar (x);\t\t\t// { dg-error \"is not a constant expression\" \"\" { target c++23 } .-1 }\n+  return x;\n+}\n+\n+constexpr int\n+baz (int x)\n+{\n+  switch (x)\n+    {\n+    case 42:\n+      return 0;\n+    case 2:\n+      #pragma omp scope\t\t// { dg-error \"statement is not a constant expression\" }\n+      x = bar (x);\n+      return x;\n+    case 3:\n+      #pragma omp parallel\t// { dg-error \"statement is not a constant expression\" }\n+      x = bar (x);\n+      return x;\n+    case 4:\n+      #pragma omp task\t\t// { dg-error \"statement is not a constant expression\" }\n+      x = bar (x);\n+      return x;\n+    default:\n+      return -1;\n+    }\n+}\n+\n+constexpr int a = foo (1);\t// { dg-error \"called in a constant expression\" }\n+constexpr int b = baz (42);\n+constexpr int c = baz (2);\n+constexpr int d = baz (3);\n+constexpr int e = baz (4);"}]}