{"sha": "635c1074bec1f91d4c210b1b66cf910220fa13a5", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjM1YzEwNzRiZWMxZjkxZDRjMjEwYjFiNjZjZjkxMDIyMGZhMTNhNQ==", "commit": {"author": {"name": "Kugan Vivekanandarajah", "email": "kuganv@linaro.org", "date": "2016-07-24T12:47:29Z"}, "committer": {"name": "Kugan Vivekanandarajah", "email": "kugan@gcc.gnu.org", "date": "2016-07-24T12:47:29Z"}, "message": "re PR tree-optimization/66726 (missed optimization, factor conversion out of COND_EXPR)\n\ngcc/ChangeLog:\n\n2016-07-24  Kugan Vivekanandarajah  <kuganv@linaro.org>\n\n\tPR middle-end/66726\n\t* tree-ssa-reassoc.c (optimize_vec_cond_expr): Handle tcc_compare stmt\n\twhose result is used in PHI.\n\t(final_range_test_p): Likewise.\n\t(maybe_optimize_range_tests): Likewise.\n\nFrom-SVN: r238695", "tree": {"sha": "6a2f970bb4d5229eeae2bfcb2163c6451a29da23", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6a2f970bb4d5229eeae2bfcb2163c6451a29da23"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/635c1074bec1f91d4c210b1b66cf910220fa13a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/635c1074bec1f91d4c210b1b66cf910220fa13a5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/635c1074bec1f91d4c210b1b66cf910220fa13a5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/635c1074bec1f91d4c210b1b66cf910220fa13a5/comments", "author": null, "committer": null, "parents": [{"sha": "bd84e5607ef5c01b9fc5f3cbd004aed807a084f2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bd84e5607ef5c01b9fc5f3cbd004aed807a084f2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bd84e5607ef5c01b9fc5f3cbd004aed807a084f2"}], "stats": {"total": 106, "additions": 88, "deletions": 18}, "files": [{"sha": "f812d1626291c44f8b1a1b1c930ebc5a8c008d30", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/635c1074bec1f91d4c210b1b66cf910220fa13a5/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/635c1074bec1f91d4c210b1b66cf910220fa13a5/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=635c1074bec1f91d4c210b1b66cf910220fa13a5", "patch": "@@ -1,3 +1,11 @@\n+2016-07-24  Kugan Vivekanandarajah  <kuganv@linaro.org>\n+\n+\tPR middle-end/66726\n+\t* tree-ssa-reassoc.c (optimize_vec_cond_expr): Handle tcc_compare stmt\n+\twhose result is used in PHI.\n+\t(final_range_test_p): Likewise.\n+\t(maybe_optimize_range_tests): Likewise.\n+\n 2016-07-22  Michael Meissner  <meissner@linux.vnet.ibm.com>\n \n \t* config/rs6000/rs6000-c.c (altivec_resolve_overloaded_builtin):"}, {"sha": "ece2d0880448a324a0a41d00c2e72b5468ece1bb", "filename": "gcc/tree-ssa-reassoc.c", "status": "modified", "additions": 80, "deletions": 18, "changes": 98, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/635c1074bec1f91d4c210b1b66cf910220fa13a5/gcc%2Ftree-ssa-reassoc.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/635c1074bec1f91d4c210b1b66cf910220fa13a5/gcc%2Ftree-ssa-reassoc.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-ssa-reassoc.c?ref=635c1074bec1f91d4c210b1b66cf910220fa13a5", "patch": "@@ -3027,18 +3027,33 @@ optimize_vec_cond_expr (tree_code opcode, vec<operand_entry *> *ops)\n    # _345 = PHI <_123(N), 1(...), 1(...)>\n    where _234 has bool type, _123 has single use and\n    bb N has a single successor M.  This is commonly used in\n+   the last block of a range test.\n+\n+   Also Return true if STMT is tcc_compare like:\n+   <bb N>:\n+   ...\n+   _234 = a_2(D) == 2;\n+\n+   <bb M>:\n+   # _345 = PHI <_234(N), 1(...), 1(...)>\n+   _346 = (int) _345;\n+   where _234 has booltype, single use and\n+   bb N has a single successor M.  This is commonly used in\n    the last block of a range test.  */\n \n static bool\n final_range_test_p (gimple *stmt)\n {\n-  basic_block bb, rhs_bb;\n+  basic_block bb, rhs_bb, lhs_bb;\n   edge e;\n   tree lhs, rhs;\n   use_operand_p use_p;\n   gimple *use_stmt;\n \n-  if (!gimple_assign_cast_p (stmt))\n+  if (!gimple_assign_cast_p (stmt)\n+      && (!is_gimple_assign (stmt)\n+\t  || (TREE_CODE_CLASS (gimple_assign_rhs_code (stmt))\n+\t      != tcc_comparison)))\n     return false;\n   bb = gimple_bb (stmt);\n   if (!single_succ_p (bb))\n@@ -3049,11 +3064,16 @@ final_range_test_p (gimple *stmt)\n \n   lhs = gimple_assign_lhs (stmt);\n   rhs = gimple_assign_rhs1 (stmt);\n-  if (!INTEGRAL_TYPE_P (TREE_TYPE (lhs))\n-      || TREE_CODE (rhs) != SSA_NAME\n-      || TREE_CODE (TREE_TYPE (rhs)) != BOOLEAN_TYPE)\n+  if (gimple_assign_cast_p (stmt)\n+      && (!INTEGRAL_TYPE_P (TREE_TYPE (lhs))\n+\t  || TREE_CODE (rhs) != SSA_NAME\n+\t  || TREE_CODE (TREE_TYPE (rhs)) != BOOLEAN_TYPE))\n     return false;\n \n+  if (!gimple_assign_cast_p (stmt)\n+      && (TREE_CODE (TREE_TYPE (lhs)) != BOOLEAN_TYPE))\n+      return false;\n+\n   /* Test whether lhs is consumed only by a PHI in the only successor bb.  */\n   if (!single_imm_use (lhs, &use_p, &use_stmt))\n     return false;\n@@ -3063,10 +3083,20 @@ final_range_test_p (gimple *stmt)\n     return false;\n \n   /* And that the rhs is defined in the same loop.  */\n-  rhs_bb = gimple_bb (SSA_NAME_DEF_STMT (rhs));\n-  if (rhs_bb == NULL\n-      || !flow_bb_inside_loop_p (loop_containing_stmt (stmt), rhs_bb))\n-    return false;\n+  if (gimple_assign_cast_p (stmt))\n+    {\n+      if (TREE_CODE (rhs) != SSA_NAME\n+\t  || !(rhs_bb = gimple_bb (SSA_NAME_DEF_STMT (rhs)))\n+\t  || !flow_bb_inside_loop_p (loop_containing_stmt (stmt), rhs_bb))\n+\treturn false;\n+    }\n+  else\n+    {\n+      if (TREE_CODE (lhs) != SSA_NAME\n+\t  || !(lhs_bb = gimple_bb (SSA_NAME_DEF_STMT (lhs)))\n+\t  || !flow_bb_inside_loop_p (loop_containing_stmt (stmt), lhs_bb))\n+\treturn false;\n+    }\n \n   return true;\n }\n@@ -3460,6 +3490,8 @@ maybe_optimize_range_tests (gimple *stmt)\n \n \t  /* stmt is\n \t     _123 = (int) _234;\n+\t     OR\n+\t     _234 = a_2(D) == 2;\n \n \t     followed by:\n \t     <bb M>:\n@@ -3489,6 +3521,8 @@ maybe_optimize_range_tests (gimple *stmt)\n \t     of the bitwise or resp. and, recursively.  */\n \t  if (!get_ops (rhs, code, &ops,\n \t\t\tloop_containing_stmt (stmt))\n+\t      && (TREE_CODE_CLASS (gimple_assign_rhs_code (stmt))\n+\t\t  != tcc_comparison)\n \t      && has_single_use (rhs))\n \t    {\n \t      /* Otherwise, push the _234 range test itself.  */\n@@ -3501,10 +3535,29 @@ maybe_optimize_range_tests (gimple *stmt)\n \t      oe->stmt_to_insert = NULL;\n \t      ops.safe_push (oe);\n \t      bb_ent.last_idx++;\n+\t      bb_ent.op = rhs;\n+\t    }\n+\t  else if (is_gimple_assign (stmt)\n+\t\t   && (TREE_CODE_CLASS (gimple_assign_rhs_code (stmt))\n+\t\t       == tcc_comparison)\n+\t\t   &&!get_ops (lhs, code, &ops,\n+\t\t\t       loop_containing_stmt (stmt))\n+\t\t   && has_single_use (lhs))\n+\t    {\n+\t      operand_entry *oe = operand_entry_pool.allocate ();\n+\t      oe->op = lhs;\n+\t      oe->rank = code;\n+\t      oe->id = 0;\n+\t      oe->count = 1;\n+\t      ops.safe_push (oe);\n+\t      bb_ent.last_idx++;\n+\t      bb_ent.op = lhs;\n \t    }\n \t  else\n-\t    bb_ent.last_idx = ops.length ();\n-\t  bb_ent.op = rhs;\n+\t    {\n+\t      bb_ent.last_idx = ops.length ();\n+\t      bb_ent.op = rhs;\n+\t    }\n \t  bbinfo.safe_push (bb_ent);\n \t  continue;\n \t}\n@@ -3586,7 +3639,7 @@ maybe_optimize_range_tests (gimple *stmt)\n \t\t{\n \t\t  imm_use_iterator iter;\n \t\t  use_operand_p use_p;\n-\t\t  gimple *use_stmt, *cast_stmt = NULL;\n+\t\t  gimple *use_stmt, *cast_or_tcc_cmp_stmt = NULL;\n \n \t\t  FOR_EACH_IMM_USE_STMT (use_stmt, iter, bbinfo[idx].op)\n \t\t    if (is_gimple_debug (use_stmt))\n@@ -3595,17 +3648,25 @@ maybe_optimize_range_tests (gimple *stmt)\n \t\t\t     || gimple_code (use_stmt) == GIMPLE_PHI)\n \t\t      FOR_EACH_IMM_USE_ON_STMT (use_p, iter)\n \t\t\tSET_USE (use_p, new_op);\n+\t\t    else if ((is_gimple_assign (use_stmt)\n+\t\t\t      && (TREE_CODE_CLASS\n+\t\t\t\t  (gimple_assign_rhs_code (use_stmt))\n+\t\t\t\t  == tcc_comparison)))\n+\t\t      cast_or_tcc_cmp_stmt = use_stmt;\n \t\t    else if (gimple_assign_cast_p (use_stmt))\n-\t\t      cast_stmt = use_stmt;\n+\t\t      cast_or_tcc_cmp_stmt = use_stmt;\n \t\t    else\n \t\t      gcc_unreachable ();\n-\t\t  if (cast_stmt)\n+\n+\t\t  if (cast_or_tcc_cmp_stmt)\n \t\t    {\n \t\t      gcc_assert (bb == last_bb);\n-\t\t      tree lhs = gimple_assign_lhs (cast_stmt);\n+\t\t      tree lhs = gimple_assign_lhs (cast_or_tcc_cmp_stmt);\n \t\t      tree new_lhs = make_ssa_name (TREE_TYPE (lhs));\n \t\t      enum tree_code rhs_code\n-\t\t\t= gimple_assign_rhs_code (cast_stmt);\n+\t\t\t= gimple_assign_cast_p (cast_or_tcc_cmp_stmt)\n+\t\t\t? gimple_assign_rhs_code (cast_or_tcc_cmp_stmt)\n+\t\t\t: CONVERT_EXPR;\n \t\t      gassign *g;\n \t\t      if (is_gimple_min_invariant (new_op))\n \t\t\t{\n@@ -3614,8 +3675,9 @@ maybe_optimize_range_tests (gimple *stmt)\n \t\t\t}\n \t\t      else\n \t\t\tg = gimple_build_assign (new_lhs, rhs_code, new_op);\n-\t\t      gimple_stmt_iterator gsi = gsi_for_stmt (cast_stmt);\n-\t\t      gimple_set_uid (g, gimple_uid (cast_stmt));\n+\t\t      gimple_stmt_iterator gsi\n+\t\t\t= gsi_for_stmt (cast_or_tcc_cmp_stmt);\n+\t\t      gimple_set_uid (g, gimple_uid (cast_or_tcc_cmp_stmt));\n \t\t      gimple_set_visited (g, true);\n \t\t      gsi_insert_before (&gsi, g, GSI_SAME_STMT);\n \t\t      FOR_EACH_IMM_USE_STMT (use_stmt, iter, lhs)"}]}