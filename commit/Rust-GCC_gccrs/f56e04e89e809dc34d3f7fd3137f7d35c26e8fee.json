{"sha": "f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjU2ZTA0ZTg5ZTgwOWRjMzRkM2Y3ZmQzMTM3ZjdkMzVjMjZlOGZlZQ==", "commit": {"author": {"name": "Javier Miranda", "email": "miranda@adacore.com", "date": "2019-07-08T08:13:11Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-08T08:13:11Z"}, "message": "[Ada] Code reorganization\n\nThis patch performs a code reorganization of the implementation of\npragma Compile_Time_Error. No functional change.\n\nNo test required.\n\n2019-07-08  Javier Miranda  <miranda@adacore.com>\n\ngcc/ada/\n\n\t* gnat1drv.adb (Post_Compilation_Validation_Checks:\n\tValidate_Compile_Time_Warning_Errors is now located in sem_prag\n\t(instead of sem_ch13).\n\t* sem_ch13.ads (Validate_Compile_Time_Warning_Error,\n\tValidate_Compile_Time_Warning_Errors): Move to sem_prag.\n\t* sem_ch13.adb\n\t(Compile_Time_Warnings_Errors): Move to sem_prag.\n\t(Initialize): Remove initialization of table\n\tCompile_Time_Warning_Errors.\n\t(Validate_Compile_Time_Warning_Error,\n\tValidate_Compile_Time_Warning_Errors): Move to sem_prag.\n\t* sem_prag.ads (Validate_Compile_Time_Warning_Errors): New\n\tprocedure.\n\t* sem_prag.adb (Initialize): Initialize table\n\tCompile_Time_Warning_Errors.\n\nFrom-SVN: r273202", "tree": {"sha": "c76f6934ec9fc904beccb41ffa83f2e96ad461c4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c76f6934ec9fc904beccb41ffa83f2e96ad461c4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/comments", "author": {"login": "miranda-adacore", "id": 54413934, "node_id": "MDQ6VXNlcjU0NDEzOTM0", "avatar_url": "https://avatars.githubusercontent.com/u/54413934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miranda-adacore", "html_url": "https://github.com/miranda-adacore", "followers_url": "https://api.github.com/users/miranda-adacore/followers", "following_url": "https://api.github.com/users/miranda-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/miranda-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/miranda-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miranda-adacore/subscriptions", "organizations_url": "https://api.github.com/users/miranda-adacore/orgs", "repos_url": "https://api.github.com/users/miranda-adacore/repos", "events_url": "https://api.github.com/users/miranda-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/miranda-adacore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5291985c00302036cc6d5932fdffb9acab3043cf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5291985c00302036cc6d5932fdffb9acab3043cf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5291985c00302036cc6d5932fdffb9acab3043cf"}], "stats": {"total": 267, "additions": 143, "deletions": 124}, "files": [{"sha": "bec33068f53b554076caadd8ca2814fa960e4aeb", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "patch": "@@ -1,3 +1,21 @@\n+2019-07-08  Javier Miranda  <miranda@adacore.com>\n+\n+\t* gnat1drv.adb (Post_Compilation_Validation_Checks:\n+\tValidate_Compile_Time_Warning_Errors is now located in sem_prag\n+\t(instead of sem_ch13).\n+\t* sem_ch13.ads (Validate_Compile_Time_Warning_Error,\n+\tValidate_Compile_Time_Warning_Errors): Move to sem_prag.\n+\t* sem_ch13.adb\n+\t(Compile_Time_Warnings_Errors): Move to sem_prag.\n+\t(Initialize): Remove initialization of table\n+\tCompile_Time_Warning_Errors.\n+\t(Validate_Compile_Time_Warning_Error,\n+\tValidate_Compile_Time_Warning_Errors): Move to sem_prag.\n+\t* sem_prag.ads (Validate_Compile_Time_Warning_Errors): New\n+\tprocedure.\n+\t* sem_prag.adb (Initialize): Initialize table\n+\tCompile_Time_Warning_Errors.\n+\n 2019-07-08  Ed Schonberg  <schonberg@adacore.com>\n \n \t* sem_ch13.adb (Analyze_Aspect_Specifications): For a"}, {"sha": "572ce3d4bbb5d42025a0be8f14c63115c44540ee", "filename": "gcc/ada/gnat1drv.adb", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fgnat1drv.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fgnat1drv.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgnat1drv.adb?ref=f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "patch": "@@ -61,6 +61,7 @@ with Sem_Ch12;\n with Sem_Ch13;\n with Sem_Elim;\n with Sem_Eval;\n+with Sem_Prag;\n with Sem_SPARK; use Sem_SPARK;\n with Sem_Type;\n with Set_Targ;\n@@ -990,7 +991,7 @@ procedure Gnat1drv is\n       Atree.Unlock;\n       Nlists.Unlock;\n       Sem.Unlock;\n-      Sem_Ch13.Validate_Compile_Time_Warning_Errors;\n+      Sem_Prag.Validate_Compile_Time_Warning_Errors;\n       Sem.Lock;\n       Nlists.Lock;\n       Atree.Lock;"}, {"sha": "76639cd301fc5a3608ef701392e130bc59d79845", "filename": "gcc/ada/sem_ch13.adb", "status": "modified", "additions": 0, "deletions": 110, "changes": 110, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_ch13.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_ch13.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch13.adb?ref=f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "patch": "@@ -30,7 +30,6 @@ with Debug;    use Debug;\n with Einfo;    use Einfo;\n with Elists;   use Elists;\n with Errout;   use Errout;\n-with Expander; use Expander;\n with Exp_Disp; use Exp_Disp;\n with Exp_Tss;  use Exp_Tss;\n with Exp_Util; use Exp_Util;\n@@ -247,41 +246,6 @@ package body Sem_Ch13 is\n    --  Remove visibility to the discriminants of type entity E and pop the\n    --  scope stack if E has discriminants and is not a subtype.\n \n-   ---------------------------------------------------\n-   -- Table for Validate_Compile_Time_Warning_Error --\n-   ---------------------------------------------------\n-\n-   --  The following table collects pragmas Compile_Time_Error and Compile_\n-   --  Time_Warning for validation. Entries are made by calls to subprogram\n-   --  Validate_Compile_Time_Warning_Error, and the call to the procedure\n-   --  Validate_Compile_Time_Warning_Errors does the actual error checking\n-   --  and posting of warning and error messages. The reason for this delayed\n-   --  processing is to take advantage of back-annotations of attributes size\n-   --  and alignment values performed by the back end.\n-\n-   --  Note: the reason we store a Source_Ptr value instead of a Node_Id is\n-   --  that by the time Validate_Unchecked_Conversions is called, Sprint will\n-   --  already have modified all Sloc values if the -gnatD option is set.\n-\n-   type CTWE_Entry is record\n-      Eloc  : Source_Ptr;\n-      --  Source location used in warnings and error messages\n-\n-      Prag  : Node_Id;\n-      --  Pragma Compile_Time_Error or Compile_Time_Warning\n-\n-      Scope : Node_Id;\n-      --  The scope which encloses the pragma\n-   end record;\n-\n-   package Compile_Time_Warnings_Errors is new Table.Table (\n-     Table_Component_Type => CTWE_Entry,\n-     Table_Index_Type     => Int,\n-     Table_Low_Bound      => 1,\n-     Table_Initial        => 50,\n-     Table_Increment      => 200,\n-     Table_Name           => \"Compile_Time_Warnings_Errors\");\n-\n    ----------------------------------------------\n    -- Table for Validate_Unchecked_Conversions --\n    ----------------------------------------------\n@@ -11830,7 +11794,6 @@ package body Sem_Ch13 is\n    procedure Initialize is\n    begin\n       Address_Clause_Checks.Init;\n-      Compile_Time_Warnings_Errors.Init;\n       Unchecked_Conversions.Init;\n \n       --  ??? Might be needed in the future for some non GCC back-ends\n@@ -13937,79 +13900,6 @@ package body Sem_Ch13 is\n       end loop;\n    end Validate_Address_Clauses;\n \n-   -----------------------------------------\n-   -- Validate_Compile_Time_Warning_Error --\n-   -----------------------------------------\n-\n-   procedure Validate_Compile_Time_Warning_Error (N : Node_Id) is\n-   begin\n-      Compile_Time_Warnings_Errors.Append\n-        (New_Val => CTWE_Entry'(Eloc  => Sloc (N),\n-                                Scope => Current_Scope,\n-                                Prag  => N));\n-   end Validate_Compile_Time_Warning_Error;\n-\n-   ------------------------------------------\n-   -- Validate_Compile_Time_Warning_Errors --\n-   ------------------------------------------\n-\n-   procedure Validate_Compile_Time_Warning_Errors is\n-      procedure Set_Scope (S : Entity_Id);\n-      --  Install all enclosing scopes of S along with S itself\n-\n-      procedure Unset_Scope (S : Entity_Id);\n-      --  Uninstall all enclosing scopes of S along with S itself\n-\n-      ---------------\n-      -- Set_Scope --\n-      ---------------\n-\n-      procedure Set_Scope (S : Entity_Id) is\n-      begin\n-         if S /= Standard_Standard then\n-            Set_Scope (Scope (S));\n-         end if;\n-\n-         Push_Scope (S);\n-      end Set_Scope;\n-\n-      -----------------\n-      -- Unset_Scope --\n-      -----------------\n-\n-      procedure Unset_Scope (S : Entity_Id) is\n-      begin\n-         if S /= Standard_Standard then\n-            Unset_Scope (Scope (S));\n-         end if;\n-\n-         Pop_Scope;\n-      end Unset_Scope;\n-\n-   --  Start of processing for Validate_Compile_Time_Warning_Errors\n-\n-   begin\n-      Expander_Mode_Save_And_Set (False);\n-      In_Compile_Time_Warning_Or_Error := True;\n-\n-      for N in Compile_Time_Warnings_Errors.First ..\n-               Compile_Time_Warnings_Errors.Last\n-      loop\n-         declare\n-            T : CTWE_Entry renames Compile_Time_Warnings_Errors.Table (N);\n-\n-         begin\n-            Set_Scope (T.Scope);\n-            Reset_Analyzed_Flags (T.Prag);\n-            Process_Compile_Time_Warning_Or_Error (T.Prag, T.Eloc);\n-            Unset_Scope (T.Scope);\n-         end;\n-      end loop;\n-\n-      In_Compile_Time_Warning_Or_Error := False;\n-      Expander_Mode_Restore;\n-   end Validate_Compile_Time_Warning_Errors;\n-\n    ---------------------------\n    -- Validate_Independence --\n    ---------------------------"}, {"sha": "eb95e2bf06c04e5b5a8bf18acd3577d6fe0ddb54", "filename": "gcc/ada/sem_ch13.ads", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_ch13.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_ch13.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch13.ads?ref=f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "patch": "@@ -189,18 +189,6 @@ package Sem_Ch13 is\n    --  change. A False result is possible only for array, enumeration or\n    --  record types.\n \n-   procedure Validate_Compile_Time_Warning_Error (N : Node_Id);\n-   --  N is a pragma Compile_Time_Error or Compile_Warning_Error whose boolean\n-   --  expression is not known at compile time. This procedure makes an entry\n-   --  in a table. The actual checking is performed by Validate_Compile_Time_\n-   --  Warning_Errors, which is invoked after calling the back end.\n-\n-   procedure Validate_Compile_Time_Warning_Errors;\n-   --  This routine is called after calling the back end to validate pragmas\n-   --  Compile_Time_Error and Compile_Time_Warning for size and alignment\n-   --  appropriateness. The reason it is called that late is to take advantage\n-   --  of any back-annotation of size and alignment performed by the back end.\n-\n    procedure Validate_Unchecked_Conversion\n      (N        : Node_Id;\n       Act_Unit : Entity_Id);"}, {"sha": "7f202215b18dff872562fde5ed477e221a0c93ec", "filename": "gcc/ada/sem_prag.adb", "status": "modified", "additions": 117, "deletions": 1, "changes": 118, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_prag.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_prag.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_prag.adb?ref=f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "patch": "@@ -41,6 +41,7 @@ with Elists;    use Elists;\n with Errout;    use Errout;\n with Exp_Dist;  use Exp_Dist;\n with Exp_Util;  use Exp_Util;\n+with Expander;  use Expander;\n with Freeze;    use Freeze;\n with Ghost;     use Ghost;\n with Gnatvsn;   use Gnatvsn;\n@@ -298,6 +299,12 @@ package body Sem_Prag is\n    --  pragma. Entity name for unit and its parents is taken from item in\n    --  previous with_clause that mentions the unit.\n \n+   procedure Validate_Compile_Time_Warning_Error (N : Node_Id);\n+   --  N is a pragma Compile_Time_Error or Compile_Warning_Error whose boolean\n+   --  expression is not known at compile time. This procedure makes an entry\n+   --  in a table. The actual checking is performed by Validate_Compile_Time_\n+   --  Warning_Errors, which is invoked after calling the back end.\n+\n    Dummy : Integer := 0;\n    pragma Volatile (Dummy);\n    --  Dummy volatile integer used in bodies of ip/rv to prevent optimization\n@@ -316,6 +323,41 @@ package body Sem_Prag is\n    --  pragma in the source program, a breakpoint on rv catches this place in\n    --  the source, allowing convenient stepping to the point of interest.\n \n+   ---------------------------------------------------\n+   -- Table for Validate_Compile_Time_Warning_Error --\n+   ---------------------------------------------------\n+\n+   --  The following table collects pragmas Compile_Time_Error and Compile_\n+   --  Time_Warning for validation. Entries are made by calls to subprogram\n+   --  Validate_Compile_Time_Warning_Error, and the call to the procedure\n+   --  Validate_Compile_Time_Warning_Errors does the actual error checking\n+   --  and posting of warning and error messages. The reason for this delayed\n+   --  processing is to take advantage of back-annotations of attributes size\n+   --  and alignment values performed by the back end.\n+\n+   --  Note: the reason we store a Source_Ptr value instead of a Node_Id is\n+   --  that by the time Validate_Unchecked_Conversions is called, Sprint will\n+   --  already have modified all Sloc values if the -gnatD option is set.\n+\n+   type CTWE_Entry is record\n+      Eloc  : Source_Ptr;\n+      --  Source location used in warnings and error messages\n+\n+      Prag  : Node_Id;\n+      --  Pragma Compile_Time_Error or Compile_Time_Warning\n+\n+      Scope : Node_Id;\n+      --  The scope which encloses the pragma\n+   end record;\n+\n+   package Compile_Time_Warnings_Errors is new Table.Table (\n+     Table_Component_Type => CTWE_Entry,\n+     Table_Index_Type     => Int,\n+     Table_Low_Bound      => 1,\n+     Table_Initial        => 50,\n+     Table_Increment      => 200,\n+     Table_Name           => \"Compile_Time_Warnings_Errors\");\n+\n    -------------------------------\n    -- Adjust_External_Name_Case --\n    -------------------------------\n@@ -7605,7 +7647,7 @@ package body Sem_Prag is\n             Check_Expression (Arg1x);\n \n             if Validation_Needed then\n-               Sem_Ch13.Validate_Compile_Time_Warning_Error (N);\n+               Validate_Compile_Time_Warning_Error (N);\n             end if;\n          end if;\n       end Process_Compile_Time_Warning_Or_Error;\n@@ -30724,6 +30766,7 @@ package body Sem_Prag is\n    procedure Initialize is\n    begin\n       Externals.Init;\n+      Compile_Time_Warnings_Errors.Init;\n    end Initialize;\n \n    --------\n@@ -32066,4 +32109,77 @@ package body Sem_Prag is\n       return Empty;\n    end Test_Case_Arg;\n \n+   -----------------------------------------\n+   -- Validate_Compile_Time_Warning_Error --\n+   -----------------------------------------\n+\n+   procedure Validate_Compile_Time_Warning_Error (N : Node_Id) is\n+   begin\n+      Compile_Time_Warnings_Errors.Append\n+        (New_Val => CTWE_Entry'(Eloc  => Sloc (N),\n+                                Scope => Current_Scope,\n+                                Prag  => N));\n+   end Validate_Compile_Time_Warning_Error;\n+\n+   ------------------------------------------\n+   -- Validate_Compile_Time_Warning_Errors --\n+   ------------------------------------------\n+\n+   procedure Validate_Compile_Time_Warning_Errors is\n+      procedure Set_Scope (S : Entity_Id);\n+      --  Install all enclosing scopes of S along with S itself\n+\n+      procedure Unset_Scope (S : Entity_Id);\n+      --  Uninstall all enclosing scopes of S along with S itself\n+\n+      ---------------\n+      -- Set_Scope --\n+      ---------------\n+\n+      procedure Set_Scope (S : Entity_Id) is\n+      begin\n+         if S /= Standard_Standard then\n+            Set_Scope (Scope (S));\n+         end if;\n+\n+         Push_Scope (S);\n+      end Set_Scope;\n+\n+      -----------------\n+      -- Unset_Scope --\n+      -----------------\n+\n+      procedure Unset_Scope (S : Entity_Id) is\n+      begin\n+         if S /= Standard_Standard then\n+            Unset_Scope (Scope (S));\n+         end if;\n+\n+         Pop_Scope;\n+      end Unset_Scope;\n+\n+   --  Start of processing for Validate_Compile_Time_Warning_Errors\n+\n+   begin\n+      Expander_Mode_Save_And_Set (False);\n+      In_Compile_Time_Warning_Or_Error := True;\n+\n+      for N in Compile_Time_Warnings_Errors.First ..\n+               Compile_Time_Warnings_Errors.Last\n+      loop\n+         declare\n+            T : CTWE_Entry renames Compile_Time_Warnings_Errors.Table (N);\n+\n+         begin\n+            Set_Scope (T.Scope);\n+            Reset_Analyzed_Flags (T.Prag);\n+            Process_Compile_Time_Warning_Or_Error (T.Prag, T.Eloc);\n+            Unset_Scope (T.Scope);\n+         end;\n+      end loop;\n+\n+      In_Compile_Time_Warning_Or_Error := False;\n+      Expander_Mode_Restore;\n+   end Validate_Compile_Time_Warning_Errors;\n+\n end Sem_Prag;"}, {"sha": "25353b70b23d819b8bb0820d1ba176be8904038e", "filename": "gcc/ada/sem_prag.ads", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_prag.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f56e04e89e809dc34d3f7fd3137f7d35c26e8fee/gcc%2Fada%2Fsem_prag.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_prag.ads?ref=f56e04e89e809dc34d3f7fd3137f7d35c26e8fee", "patch": "@@ -555,4 +555,10 @@ package Sem_Prag is\n    --\n    --    Empty if there is no such argument\n \n+   procedure Validate_Compile_Time_Warning_Errors;\n+   --  This routine is called after calling the back end to validate pragmas\n+   --  Compile_Time_Error and Compile_Time_Warning for size and alignment\n+   --  appropriateness. The reason it is called that late is to take advantage\n+   --  of any back-annotation of size and alignment performed by the back end.\n+\n end Sem_Prag;"}]}