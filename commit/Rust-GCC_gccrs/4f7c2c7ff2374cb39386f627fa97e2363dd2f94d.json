{"sha": "4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NGY3YzJjN2ZmMjM3NGNiMzkzODZmNjI3ZmE5N2UyMzYzZGQyZjk0ZA==", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2017-07-06T12:42:46Z"}, "committer": {"name": "Jonathan Wakely", "email": "redi@gcc.gnu.org", "date": "2017-07-06T12:42:46Z"}, "message": "Fix memory leaks in libstdc++ ABI tests\n\n\t* testsuite/abi/pr42230.cc: Free memory.\n\t* testsuite/util/testsuite_abi.cc (demangle): Return std::string\n\tinstead of pointer that might need freeing.\n\t* testsuite/util/testsuite_abi.h (demangle): Likewise.\n\t* testsuite/util/testsuite_hooks.cc (verify_demangle): Free memory.\n\nFrom-SVN: r250020", "tree": {"sha": "ed20d6711dcaa1ff2713b42a3424fcc860cd8f67", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ed20d6711dcaa1ff2713b42a3424fcc860cd8f67"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "318c48e30402eadaeee86dee9486733678c5fef4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/318c48e30402eadaeee86dee9486733678c5fef4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/318c48e30402eadaeee86dee9486733678c5fef4"}], "stats": {"total": 32, "additions": 24, "deletions": 8}, "files": [{"sha": "be9813a08b199ff2b36f0ec21edf466210e7f124", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "patch": "@@ -1,5 +1,11 @@\n 2017-07-06  Jonathan Wakely  <jwakely@redhat.com>\n \n+\t* testsuite/abi/pr42230.cc: Free memory.\n+\t* testsuite/util/testsuite_abi.cc (demangle): Return std::string\n+\tinstead of pointer that might need freeing.\n+\t* testsuite/util/testsuite_abi.h (demangle): Likewise.\n+\t* testsuite/util/testsuite_hooks.cc (verify_demangle): Free memory.\n+\n \t* include/bits/uses_allocator.h (__use_alloc(const _Alloc&&)): Add\n \tdeleted overload to prevent dangling references to rvalues.\n \t* include/experimental/memory_resource"}, {"sha": "3b5a1f6c2421db82714e69f947595bfd83b8db04", "filename": "libstdc++-v3/testsuite/abi/pr42230.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Fabi%2Fpr42230.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Fabi%2Fpr42230.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fabi%2Fpr42230.cc?ref=4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "patch": "@@ -12,5 +12,6 @@ int main()\n   char* ret = abi::__cxa_demangle(\"e\", 0, &length, &cc);\n \n   assert( (cc < 0 && !ret) || (ret && length) );\n+  std::free(ret);\n   return 0;\n }"}, {"sha": "d18429a55b2d633f5c05338e71c1e869e6cc1400", "filename": "libstdc++-v3/testsuite/util/testsuite_abi.cc", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_abi.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_abi.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_abi.cc?ref=4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "patch": "@@ -590,21 +590,26 @@ create_symbols(const char* file)\n }\n \n \n-const char*\n+std::string\n demangle(const std::string& mangled)\n {\n-  const char* name;\n+  std::string name;\n   if (mangled[0] != '_' || mangled[1] != 'Z')\n     {\n       // This is not a mangled symbol, thus has \"C\" linkage.\n-      name = mangled.c_str();\n+      name = mangled;\n     }\n   else\n     {\n       // Use __cxa_demangle to demangle.\n       int status = 0;\n-      name = abi::__cxa_demangle(mangled.c_str(), 0, 0, &status);\n-      if (!name)\n+      char* ptr = abi::__cxa_demangle(mangled.c_str(), 0, 0, &status);\n+      if (ptr)\n+\t{\n+\t  name = ptr;\n+\t  free(ptr);\n+\t}\n+      else\n \t{\n \t  switch (status)\n \t    {"}, {"sha": "77c5656177f9d709fe653ec8de6658da7cdb2195", "filename": "libstdc++-v3/testsuite/util/testsuite_abi.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_abi.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_abi.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_abi.h?ref=4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "patch": "@@ -94,5 +94,5 @@ compare_symbols(const char* baseline_file, const char* test_file, bool verb);\n symbols\n create_symbols(const char* file);\n \n-const char*\n+std::string\n demangle(const std::string& mangled);"}, {"sha": "74e755dfe287eee6a72bd7652e6842ecb817cffc", "filename": "libstdc++-v3/testsuite/util/testsuite_hooks.cc", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_hooks.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4f7c2c7ff2374cb39386f627fa97e2363dd2f94d/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_hooks.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Futil%2Ftestsuite_hooks.cc?ref=4f7c2c7ff2374cb39386f627fa97e2363dd2f94d", "patch": "@@ -131,8 +131,11 @@ namespace __gnu_test\n   verify_demangle(const char* mangled, const char* wanted)\n   {\n     int status = 0;\n-    const char* s = abi::__cxa_demangle(mangled, 0, 0, &status);\n-    if (!s)\n+    const char* s = 0;\n+    char* demangled = abi::__cxa_demangle(mangled, 0, 0, &status);\n+    if (demangled)\n+      s = demangled;\n+    else\n       {\n \tswitch (status)\n \t  {\n@@ -156,6 +159,7 @@ namespace __gnu_test\n     std::string w(wanted);\n     if (w != s)\n       std::__throw_runtime_error(s);\n+    free(demangled);\n   }\n \n   void"}]}