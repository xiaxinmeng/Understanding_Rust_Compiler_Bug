{"sha": "3e12b42be93c14a599df9c96e58ba66cd864bf77", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2UxMmI0MmJlOTNjMTRhNTk5ZGY5Yzk2ZTU4YmE2NmNkODY0YmY3Nw==", "commit": {"author": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2018-02-06T15:30:06Z"}, "committer": {"name": "Ian Lance Taylor", "email": "ian@gcc.gnu.org", "date": "2018-02-06T15:30:06Z"}, "message": "compiler: avoid negative zero in float constants\n    \n    Check for negative numbers with very small magnitudes that will round\n    to negative zero, and force them to positive zero instead.\n    \n    This implements the spec clarification in https://golang.org/cl/14727.\n    The test is in https://golang.org/cl/91895.\n    \n    Fixes golang/go#12621\n    \n    Reviewed-on: https://go-review.googlesource.com/92175\n\nFrom-SVN: r257415", "tree": {"sha": "4d375844ea14bdf771954d9e232206931c69405e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4d375844ea14bdf771954d9e232206931c69405e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3e12b42be93c14a599df9c96e58ba66cd864bf77", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3e12b42be93c14a599df9c96e58ba66cd864bf77", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3e12b42be93c14a599df9c96e58ba66cd864bf77", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3e12b42be93c14a599df9c96e58ba66cd864bf77/comments", "author": null, "committer": null, "parents": [{"sha": "3ca8e91f0e4452f618dbdc82090ecf47d1bd984c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3ca8e91f0e4452f618dbdc82090ecf47d1bd984c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3ca8e91f0e4452f618dbdc82090ecf47d1bd984c"}], "stats": {"total": 67, "additions": 64, "deletions": 3}, "files": [{"sha": "8c49b2b12da37b23d2934adce35ef1ccf315267b", "filename": "gcc/go/gofrontend/MERGE", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3e12b42be93c14a599df9c96e58ba66cd864bf77/gcc%2Fgo%2Fgofrontend%2FMERGE", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3e12b42be93c14a599df9c96e58ba66cd864bf77/gcc%2Fgo%2Fgofrontend%2FMERGE", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgo%2Fgofrontend%2FMERGE?ref=3e12b42be93c14a599df9c96e58ba66cd864bf77", "patch": "@@ -1,4 +1,4 @@\n-1927b40e59e7c2067ecb03384b331d1be3cb5eea\n+02f11a2d5cf0db2c2675c13d92bb69529f2175dd\n \n The first line of this file holds the git revision number of the last\n merge done from the gofrontend repository."}, {"sha": "f50de0a500448e4d95d2d22013193179cb010521", "filename": "gcc/go/gofrontend/expressions.cc", "status": "modified", "additions": 60, "deletions": 2, "changes": 62, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3e12b42be93c14a599df9c96e58ba66cd864bf77/gcc%2Fgo%2Fgofrontend%2Fexpressions.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3e12b42be93c14a599df9c96e58ba66cd864bf77/gcc%2Fgo%2Fgofrontend%2Fexpressions.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgo%2Fgofrontend%2Fexpressions.cc?ref=3e12b42be93c14a599df9c96e58ba66cd864bf77", "patch": "@@ -16158,10 +16158,16 @@ Numeric_constant::set_float(Type* type, const mpfr_t val)\n   this->clear();\n   this->classification_ = NC_FLOAT;\n   this->type_ = type;\n+\n   // Numeric constants do not have negative zero values, so remove\n   // them here.  They also don't have infinity or NaN values, but we\n   // should never see them here.\n-  if (mpfr_zero_p(val))\n+  int bits = 0;\n+  if (type != NULL\n+      && type->float_type() != NULL\n+      && !type->float_type()->is_abstract())\n+    bits = type->float_type()->bits();\n+  if (Numeric_constant::is_float_neg_zero(val, bits))\n     mpfr_init_set_ui(this->u_.float_val, 0, GMP_RNDN);\n   else\n     mpfr_init_set(this->u_.float_val, val, GMP_RNDN);\n@@ -16175,8 +16181,60 @@ Numeric_constant::set_complex(Type* type, const mpc_t val)\n   this->clear();\n   this->classification_ = NC_COMPLEX;\n   this->type_ = type;\n+\n+  // Avoid negative zero as in set_float.\n+  int bits = 0;\n+  if (type != NULL\n+      && type->complex_type() != NULL\n+      && !type->complex_type()->is_abstract())\n+    bits = type->complex_type()->bits() / 2;\n+\n+  mpfr_t real;\n+  mpfr_init_set(real, mpc_realref(val), GMP_RNDN);\n+  if (Numeric_constant::is_float_neg_zero(real, bits))\n+    mpfr_set_ui(real, 0, GMP_RNDN);\n+\n+  mpfr_t imag;\n+  mpfr_init_set(imag, mpc_imagref(val), GMP_RNDN);\n+  if (Numeric_constant::is_float_neg_zero(imag, bits))\n+    mpfr_set_ui(imag, 0, GMP_RNDN);\n+\n   mpc_init2(this->u_.complex_val, mpc_precision);\n-  mpc_set(this->u_.complex_val, val, MPC_RNDNN);\n+  mpc_set_fr_fr(this->u_.complex_val, real, imag, MPC_RNDNN);\n+\n+  mpfr_clear(real);\n+  mpfr_clear(imag);\n+}\n+\n+// Return whether VAL, at a precision of BITS, is a negative zero.\n+// BITS may be zero in which case it is ignored.\n+\n+bool\n+Numeric_constant::is_float_neg_zero(const mpfr_t val, int bits)\n+{\n+  if (!mpfr_signbit(val))\n+    return false;\n+  if (mpfr_zero_p(val))\n+    return true;\n+  mp_exp_t min_exp;\n+  switch (bits)\n+    {\n+    case 0:\n+      return false;\n+    case 32:\n+      // In a denormalized float32 the exponent is -126, and there are\n+      // 24 bits of which at least the last must be 1, so the smallest\n+      // representable non-zero exponent is -126 - (24 - 1) == -149.\n+      min_exp = -149;\n+      break;\n+    case 64:\n+      // Minimum exponent is -1022, there are 53 bits.\n+      min_exp = -1074;\n+      break;\n+    default:\n+      go_unreachable();\n+    }\n+  return mpfr_get_exp(val) < min_exp;\n }\n \n // Get an int value."}, {"sha": "a58c79c7b1512c7f99e47bbe3cb6831b18227159", "filename": "gcc/go/gofrontend/expressions.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3e12b42be93c14a599df9c96e58ba66cd864bf77/gcc%2Fgo%2Fgofrontend%2Fexpressions.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3e12b42be93c14a599df9c96e58ba66cd864bf77/gcc%2Fgo%2Fgofrontend%2Fexpressions.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgo%2Fgofrontend%2Fexpressions.h?ref=3e12b42be93c14a599df9c96e58ba66cd864bf77", "patch": "@@ -4220,6 +4220,9 @@ class Numeric_constant\n   bool\n   check_complex_type(Complex_type*, bool, Location);\n \n+  static bool\n+  is_float_neg_zero(const mpfr_t, int bits);\n+\n   // The kinds of constants.\n   enum Classification\n   {"}]}