{"sha": "d665f8dde6f4d6c68635cbef972ef7ce085a359b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDY2NWY4ZGRlNmY0ZDZjNjg2MzVjYmVmOTcyZWY3Y2UwODVhMzU5Yg==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2014-02-04T23:26:36Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2014-02-04T23:26:36Z"}, "message": "ipa.c (function_and_variable_visibility): Decompose DECL_ONE_ONLY groups when we know they are controlled by LTO.\n\n\t* ipa.c (function_and_variable_visibility): Decompose DECL_ONE_ONLY\n\tgroups when we know they are controlled by LTO.\n\t* varasm.c (default_binds_local_p_1): If object is in other partition,\n\tit will be resolved locally.\n\n\t* lto-partition.c (get_symbol_class): Only unforced DECL_ONE_ONLY \n\tneeds duplicating, not generic COMDAT.\n\nFrom-SVN: r207489", "tree": {"sha": "bbf5ad857d73a9614797d6f9dbe1e05f2d043715", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/bbf5ad857d73a9614797d6f9dbe1e05f2d043715"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d665f8dde6f4d6c68635cbef972ef7ce085a359b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d665f8dde6f4d6c68635cbef972ef7ce085a359b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d665f8dde6f4d6c68635cbef972ef7ce085a359b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d665f8dde6f4d6c68635cbef972ef7ce085a359b/comments", "author": null, "committer": null, "parents": [{"sha": "6a071860bfd406eaad6b5c8ad68b1632ed1c9de6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a071860bfd406eaad6b5c8ad68b1632ed1c9de6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6a071860bfd406eaad6b5c8ad68b1632ed1c9de6"}], "stats": {"total": 54, "additions": 49, "deletions": 5}, "files": [{"sha": "8d2e39444cce956b9bd07e02873ead6f34b6ef08", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=d665f8dde6f4d6c68635cbef972ef7ce085a359b", "patch": "@@ -1,3 +1,10 @@\n+2014-02-04  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* ipa.c (function_and_variable_visibility): Decompose DECL_ONE_ONLY\n+\tgroups when we know they are controlled by LTO.\n+\t* varasm.c (default_binds_local_p_1): If object is in other partition,\n+\tit will be resolved locally.\n+\n 2014-02-04  Bernd Edlinger  <bernd.edlinger@hotmail.de>\n \n \t* gcc/config/host-linux.c (linux_gt_pch_use_address): Don't"}, {"sha": "be75cba2dfa36a6d942f0f2ef109c397390ba0b8", "filename": "gcc/ipa.c", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Fipa.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Fipa.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa.c?ref=d665f8dde6f4d6c68635cbef972ef7ce085a359b", "patch": "@@ -1002,6 +1002,36 @@ function_and_variable_visibility (bool whole_program)\n \t  if (DECL_EXTERNAL (decl_node->decl))\n \t    DECL_EXTERNAL (node->decl) = 1;\n \t}\n+\n+      /* If whole comdat group is used only within LTO code, we can dissolve it,\n+\t we handle the unification ourselves.\n+\t We keep COMDAT and weak so visibility out of DSO does not change.\n+\t Later we may bring the symbols static if they are not exported.  */\n+      if (DECL_ONE_ONLY (node->decl)\n+\t  && (node->resolution == LDPR_PREVAILING_DEF_IRONLY\n+\t      || node->resolution == LDPR_PREVAILING_DEF_IRONLY_EXP))\n+\t{\n+\t  symtab_node *next = node;\n+\n+\t  if (node->same_comdat_group)\n+\t    for (next = node->same_comdat_group;\n+\t\t next != node;\n+\t\t next = next->same_comdat_group)\n+\t      if (next->externally_visible\n+\t\t  && (next->resolution != LDPR_PREVAILING_DEF_IRONLY\n+\t\t      && next->resolution != LDPR_PREVAILING_DEF_IRONLY_EXP))\n+\t\tbreak;\n+\t  if (node == next)\n+\t    {\n+\t      if (node->same_comdat_group)\n+\t        for (next = node->same_comdat_group;\n+\t\t     next != node;\n+\t\t     next = next->same_comdat_group)\n+\t\t  DECL_COMDAT_GROUP (next->decl) = NULL;\n+\t      DECL_COMDAT_GROUP (node->decl) = NULL;\n+\t      symtab_dissolve_same_comdat_group_list (node);\n+\t    }\n+\t}\n     }\n   FOR_EACH_DEFINED_FUNCTION (node)\n     {"}, {"sha": "0f9e6882b5fb6a03f9829824c53414de5044be59", "filename": "gcc/lto/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Flto%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Flto%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2FChangeLog?ref=d665f8dde6f4d6c68635cbef972ef7ce085a359b", "patch": "@@ -1,3 +1,8 @@\n+2014-02-04  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* lto-partition.c (get_symbol_class): Only unforced DECL_ONE_ONLY \n+\tneeds duplicating, not generic COMDAT.\n+\n 2014-02-04  Richard Biener  <rguenther@suse.de>\n \n \tPR lto/59723"}, {"sha": "da76b10511f0660717144e12ec5e4d18069ef56a", "filename": "gcc/lto/lto-partition.c", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Flto%2Flto-partition.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Flto%2Flto-partition.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto-partition.c?ref=d665f8dde6f4d6c68635cbef972ef7ce085a359b", "patch": "@@ -94,10 +94,12 @@ get_symbol_class (symtab_node *node)\n   else if (!cgraph (node)->definition)\n     return SYMBOL_EXTERNAL;\n \n-  /* Comdats are duplicated to every use unless they are keyed.\n-     Those do not need duplication.  */\n-  if (DECL_COMDAT (node->decl)\n+  /* Linker discardable symbols are duplicated to every use unless they are\n+     keyed.\n+     Keyed symbols or those.  */\n+  if (DECL_ONE_ONLY (node->decl)\n       && !node->force_output\n+      && !node->forced_by_abi\n       && !symtab_used_from_object_file_p (node))\n     return SYMBOL_DUPLICATE;\n "}, {"sha": "295c27d9d8dc59d940125b63ac9edcf0f21ca65f", "filename": "gcc/varasm.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Fvarasm.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d665f8dde6f4d6c68635cbef972ef7ce085a359b/gcc%2Fvarasm.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvarasm.c?ref=d665f8dde6f4d6c68635cbef972ef7ce085a359b", "patch": "@@ -6739,7 +6739,7 @@ default_binds_local_p_1 (const_tree exp, int shlib)\n       && (TREE_STATIC (exp) || DECL_EXTERNAL (exp)))\n     {\n       varpool_node *vnode = varpool_get_node (exp);\n-      if (vnode && resolution_local_p (vnode->resolution))\n+      if (vnode && (resolution_local_p (vnode->resolution) || vnode->in_other_partition))\n \tresolved_locally = true;\n       if (vnode\n \t  && resolution_to_local_definition_p (vnode->resolution))\n@@ -6749,7 +6749,7 @@ default_binds_local_p_1 (const_tree exp, int shlib)\n     {\n       struct cgraph_node *node = cgraph_get_node (exp);\n       if (node\n-\t  && resolution_local_p (node->resolution))\n+\t  && (resolution_local_p (node->resolution) || node->in_other_partition))\n \tresolved_locally = true;\n       if (node\n \t  && resolution_to_local_definition_p (node->resolution))"}]}