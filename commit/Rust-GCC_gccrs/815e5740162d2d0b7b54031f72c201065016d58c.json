{"sha": "815e5740162d2d0b7b54031f72c201065016d58c", "node_id": "C_kwDOANBUbNoAKDgxNWU1NzQwMTYyZDJkMGI3YjU0MDMxZjcyYzIwMTA2NTAxNmQ1OGM", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-01-27T19:11:20Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-01-27T19:11:20Z"}, "message": "libstdc++: Fix up FAIL in 17_intro/names.cc on glibc < 2.19 [PR108568]\n\nOn gcc112 which has glibc 2.17 I've noticed\nFAIL: 17_intro/names.cc (test for excess errors)\nFAIL: experimental/names.cc (test for excess errors)\nThese are because glibc < 2.19 used __unused as field member of various structs,\nincluding mcontext_t in sys/ucontext.h on ppc64le.\nThis was changed in glibc with\nhttps://gcc.gnu.org/pipermail/libc-alpha/2013-November/045766.html\nnames.cc even has\n #ifdef __GLIBC_PREREQ\n #if ! __GLIBC_PREREQ(2, 19)\n // Glibc defines this prior to 2.19\n #undef __unused\n #endif\n #endif\nfor it, but it doesn't work.  The reason is that __GLIBC_PREREQ is defined in\n<features.h> but nothing included that header before this spot (it is included later\nfrom bits/stdc++.h).\n\nThe following patch on Linux/Hurd conditionally includes features.h to get\nthe needed macros before deciding if __unused should be undefined or not.\nIf needed, I could use __GLIBC_PREREQ then but would need to check if it is\ndefined and between 1996 and 1999 it wasn't.\n\n2023-01-27  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR libstdc++/108568\n\t* testsuite/17_intro/names.cc (__unused): For linux or GNU hurd\n\tinclude features.h if present and then check __GLIBC__ and\n\t__GLIBC_MINOR__ macros for glibc prior to 2.19, instead of testing\n\t__GLIBC_PREREQ which isn't defined yet.", "tree": {"sha": "9fd5fede24dd75495cd17316983bcb555bb95175", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9fd5fede24dd75495cd17316983bcb555bb95175"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/815e5740162d2d0b7b54031f72c201065016d58c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/815e5740162d2d0b7b54031f72c201065016d58c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/815e5740162d2d0b7b54031f72c201065016d58c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/815e5740162d2d0b7b54031f72c201065016d58c/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0fd52972c600c432d9df74dad427243b916317a0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0fd52972c600c432d9df74dad427243b916317a0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0fd52972c600c432d9df74dad427243b916317a0"}], "stats": {"total": 7, "additions": 5, "deletions": 2}, "files": [{"sha": "d3e0db9bab6b92991524cc6c6e6e54c2bb79b10d", "filename": "libstdc++-v3/testsuite/17_intro/names.cc", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/815e5740162d2d0b7b54031f72c201065016d58c/libstdc%2B%2B-v3%2Ftestsuite%2F17_intro%2Fnames.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/815e5740162d2d0b7b54031f72c201065016d58c/libstdc%2B%2B-v3%2Ftestsuite%2F17_intro%2Fnames.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F17_intro%2Fnames.cc?ref=815e5740162d2d0b7b54031f72c201065016d58c", "patch": "@@ -252,12 +252,15 @@\n #undef y\n #endif\n \n-#ifdef __GLIBC_PREREQ\n-#if ! __GLIBC_PREREQ(2, 19)\n+#if defined (__linux__) || defined (__gnu_hurd__)\n+#if __has_include(<features.h>)\n+#include <features.h>\n+#if __GLIBC__ == 2 && __GLIBC_MINOR__ < 19\n // Glibc defines this prior to 2.19\n #undef __unused\n #endif\n #endif\n+#endif\n \n #if __has_include(<newlib.h>)\n // newlib's <sys/cdefs.h> defines these as macros."}]}