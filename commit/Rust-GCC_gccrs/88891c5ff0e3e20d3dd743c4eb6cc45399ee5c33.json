{"sha": "88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODg4OTFjNWZmMGUzZTIwZDNkZDc0M2M0ZWI2Y2M0NTM5OWVlNWMzMw==", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2020-06-25T09:20:52Z"}, "committer": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2020-06-25T09:27:12Z"}, "message": "gcov-tool: fix merge operation for summary\n\nlibgcc/ChangeLog:\n\n\t* libgcov-driver.c (merge_summary): Remove function as its name\n\tis misleading and doing something different.\n\t(dump_one_gcov): Add ATTRIBUTE_UNUSED for 2 args. Take read summary\n\tin gcov-tool.\n\t* libgcov-util.c (curr_object_summary): Remove.\n\t(read_gcda_file): Remove unused curr_object_summary.\n\t(gcov_merge): Merge summaries.\n\t* libgcov.h: Add summary argument for gcov_info struct.", "tree": {"sha": "b90351f275fb454261cfb91a278cfead392e4e48", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b90351f275fb454261cfb91a278cfead392e4e48"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCAAdFiEE6I4wzqqylQBfXaRhTcGC3A+nN4UFAl70bfAACgkQTcGC3A+n\nN4UTGwf/SpjAke1HiLJj1pm537PkicB4iQmInwHADDI25HOuizMWTa/GL25DKFD2\nOpcwbDilaO6zVPSpWUaBg7AynNbd7WMB9FiUiYMLeHjJGL57m0HbVrwUh1hTXo+X\niYpZsoUVnPqzXeOcW3pyscmJvFRjAvLAKak8XJuRZbwq8LBDJvl1BSELGyz2mjZf\nOeBLvVzJI05htQOypXcHnI08r+mGzgLfrEN13wT5nj+pvFMDsOnrPnYG97qZnfJO\nxfJcrEbgNbXZb+rT5dPuuoWEjL1arz5553CokR0R9UZiLcFoLCBXvbc6syqfOB9/\neLBp0rubOfiNosqGFth/w49/hT6kDg==\n=wQ/p\n-----END PGP SIGNATURE-----", "payload": "tree b90351f275fb454261cfb91a278cfead392e4e48\nparent a8d8caca0cbfde0317ca96bfea75a7f047152dad\nauthor Martin Liska <mliska@suse.cz> 1593076852 +0200\ncommitter Martin Liska <mliska@suse.cz> 1593077232 +0200\n\ngcov-tool: fix merge operation for summary\n\nlibgcc/ChangeLog:\n\n\t* libgcov-driver.c (merge_summary): Remove function as its name\n\tis misleading and doing something different.\n\t(dump_one_gcov): Add ATTRIBUTE_UNUSED for 2 args. Take read summary\n\tin gcov-tool.\n\t* libgcov-util.c (curr_object_summary): Remove.\n\t(read_gcda_file): Remove unused curr_object_summary.\n\t(gcov_merge): Merge summaries.\n\t* libgcov.h: Add summary argument for gcov_info struct.\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "html_url": "https://github.com/Rust-GCC/gccrs/commit/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a8d8caca0cbfde0317ca96bfea75a7f047152dad", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a8d8caca0cbfde0317ca96bfea75a7f047152dad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a8d8caca0cbfde0317ca96bfea75a7f047152dad"}], "stats": {"total": 38, "additions": 18, "deletions": 20}, "files": [{"sha": "871b87b867bcece08a962d2eaca1d62b0a18fdc0", "filename": "libgcc/libgcov-driver.c", "status": "modified", "additions": 11, "deletions": 15, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/libgcc%2Flibgcov-driver.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/libgcc%2Flibgcov-driver.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Flibgcov-driver.c?ref=88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "patch": "@@ -442,19 +442,6 @@ write_one_data (const struct gcov_info *gi_ptr,\n   gcov_write_unsigned (0);\n }\n \n-/* Helper function for merging summary.  */\n-\n-static void\n-merge_summary (int run_counted, struct gcov_summary *summary,\n-\t      gcov_type run_max)\n-{\n-  if (!run_counted)\n-    {\n-      summary->runs++;\n-      summary->sum_max += run_max;\n-    }\n-}\n-\n /* Dump the coverage counts for one gcov_info object. We merge with existing\n    counts when possible, to avoid growing the .da files ad infinitum. We use\n    this program's checksum to make sure we only accumulate whole program\n@@ -464,7 +451,8 @@ merge_summary (int run_counted, struct gcov_summary *summary,\n \n static void\n dump_one_gcov (struct gcov_info *gi_ptr, struct gcov_filename *gf,\n-\t       unsigned run_counted, gcov_type run_max)\n+\t       unsigned run_counted ATTRIBUTE_UNUSED,\n+\t       gcov_type run_max ATTRIBUTE_UNUSED)\n {\n   struct gcov_summary summary = {};\n   int error;\n@@ -492,7 +480,15 @@ dump_one_gcov (struct gcov_info *gi_ptr, struct gcov_filename *gf,\n \n   gcov_rewrite ();\n \n-  merge_summary (run_counted, &summary, run_max);\n+#if !IN_GCOV_TOOL\n+  if (!run_counted)\n+    {\n+      summary.runs++;\n+      summary.sum_max += run_max;\n+    }\n+#else\n+  summary = gi_ptr->summary;\n+#endif\n \n   write_one_data (gi_ptr, &summary);\n   /* fall through */"}, {"sha": "09e34f0a33a3736b1ee9798efe214b80afa9443c", "filename": "libgcc/libgcov-util.c", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/libgcc%2Flibgcov-util.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/libgcc%2Flibgcov-util.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Flibgcov-util.c?ref=88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "patch": "@@ -80,8 +80,6 @@ static int k_ctrs_mask[GCOV_COUNTERS];\n static struct gcov_ctr_info k_ctrs[GCOV_COUNTERS];\n /* Number of kind of counters that have been seen.  */\n static int k_ctrs_types;\n-/* The object summary being processed.  */\n-static struct gcov_summary *curr_object_summary;\n \n /* Merge functions for counters.  */\n #define DEF_GCOV_COUNTER(COUNTER, NAME, FN_TYPE) __gcov_merge ## FN_TYPE,\n@@ -225,8 +223,7 @@ tag_counters (unsigned tag, unsigned length)\n static void\n tag_summary (unsigned tag ATTRIBUTE_UNUSED, unsigned length ATTRIBUTE_UNUSED)\n {\n-  curr_object_summary = (gcov_summary *) xcalloc (sizeof (gcov_summary), 1);\n-  gcov_read_summary (curr_object_summary);\n+  gcov_read_summary (&curr_gcov_info->summary);\n }\n \n /* This function is called at the end of reading a gcda file.\n@@ -300,7 +297,6 @@ read_gcda_file (const char *filename)\n   obstack_init (&fn_info);\n   num_fn_info = 0;\n   curr_fn_info = 0;\n-  curr_object_summary = NULL;\n   {\n     size_t len = strlen (filename) + 1;\n     char *str_dup = (char*) xmalloc (len);\n@@ -584,6 +580,11 @@ gcov_merge (struct gcov_info *info1, struct gcov_info *info2, int w)\n   int has_mismatch = 0;\n \n   gcc_assert (info2->n_functions == n_functions);\n+\n+  /* Merge summary.  */\n+  info1->summary.runs += info2->summary.runs;\n+  info1->summary.sum_max += info2->summary.sum_max;\n+\n   for (f_ix = 0; f_ix < n_functions; f_ix++)\n     {\n       unsigned t_ix;"}, {"sha": "81e18950a50077ce71bbd739f595ccfde646f4e8", "filename": "libgcc/libgcov.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/libgcc%2Flibgcov.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33/libgcc%2Flibgcov.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Flibgcov.h?ref=88891c5ff0e3e20d3dd743c4eb6cc45399ee5c33", "patch": "@@ -217,6 +217,7 @@ struct gcov_info\n                                                   to function information  */\n #else\n   struct gcov_fn_info **functions;\n+  struct gcov_summary summary;\n #endif /* !IN_GCOV_TOOL */\n };\n "}]}