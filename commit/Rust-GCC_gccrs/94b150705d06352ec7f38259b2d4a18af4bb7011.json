{"sha": "94b150705d06352ec7f38259b2d4a18af4bb7011", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTRiMTUwNzA1ZDA2MzUyZWM3ZjM4MjU5YjJkNGExOGFmNGJiNzAxMQ==", "commit": {"author": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2013-07-21T13:44:03Z"}, "committer": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2013-07-21T13:44:03Z"}, "message": "re PR fortran/56937 (Unnecessarily temporary with array-vector assignments)\n\n2013-07-21  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/56937\n\t* dependency.c (gfc_dep_resolver):  Treat identical\n\tarray subscripts as identical; don't unconditionally\n\treturn a dependency if an array subscript is found.\n\n2013-07-21  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/56937\n\t* gfortran.dg/dependency_42.f90:  New test.\n\t* gfortran.dg/dependency_43.f90:  New test.\n\nFrom-SVN: r201094", "tree": {"sha": "fe1ec330c9c583ea303c069de034b2b9f4ef20ce", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fe1ec330c9c583ea303c069de034b2b9f4ef20ce"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/94b150705d06352ec7f38259b2d4a18af4bb7011", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94b150705d06352ec7f38259b2d4a18af4bb7011", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94b150705d06352ec7f38259b2d4a18af4bb7011", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94b150705d06352ec7f38259b2d4a18af4bb7011/comments", "author": null, "committer": null, "parents": [{"sha": "82a4f54cc5ff37df751528d1a30e9b573d2496ee", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82a4f54cc5ff37df751528d1a30e9b573d2496ee", "html_url": "https://github.com/Rust-GCC/gccrs/commit/82a4f54cc5ff37df751528d1a30e9b573d2496ee"}], "stats": {"total": 63, "additions": 60, "deletions": 3}, "files": [{"sha": "f1f2437c3e3d42fa0dc42ff6d1bb8aa95bf0c92d", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=94b150705d06352ec7f38259b2d4a18af4bb7011", "patch": "@@ -1,3 +1,10 @@\n+2013-07-21  Thomas Koenig  <tkoenig@gcc.gnu.org>\n+\n+\tPR fortran/56937\n+\t* dependency.c (gfc_dep_resolver):  Treat identical\n+\tarray subscripts as identical; don't unconditionally\n+\treturn a dependency if an array subscript is found.\n+\n 2013-07-21  Tobias Burnus  <burnus@net-b.de>\n \n \tPR fortran/35862"}, {"sha": "350c7bd07a2c065d1caeb408e6a14862b3cef269", "filename": "gcc/fortran/dependency.c", "status": "modified", "additions": 17, "deletions": 3, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ffortran%2Fdependency.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ffortran%2Fdependency.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fdependency.c?ref=94b150705d06352ec7f38259b2d4a18af4bb7011", "patch": "@@ -2095,11 +2095,23 @@ gfc_dep_resolver (gfc_ref *lref, gfc_ref *rref, gfc_reverse *reverse)\n \n \t  for (n=0; n < lref->u.ar.dimen; n++)\n \t    {\n-\t      /* Assume dependency when either of array reference is vector\n-\t\t subscript.  */\n+\t      /* Handle dependency when either of array reference is vector\n+\t\t subscript. There is no dependency if the vector indices\n+\t\t are equal or if indices are known to be different in a\n+\t\t different dimension.  */\n \t      if (lref->u.ar.dimen_type[n] == DIMEN_VECTOR\n \t\t  || rref->u.ar.dimen_type[n] == DIMEN_VECTOR)\n-\t\treturn 1;\n+\t\t{\n+\t\t  if (lref->u.ar.dimen_type[n] == DIMEN_VECTOR \n+\t\t      && rref->u.ar.dimen_type[n] == DIMEN_VECTOR\n+\t\t      && gfc_dep_compare_expr (lref->u.ar.start[n],\n+\t\t\t\t\t       rref->u.ar.start[n]) == 0)\n+\t\t    this_dep = GFC_DEP_EQUAL;\n+\t\t  else\n+\t\t    this_dep = GFC_DEP_OVERLAP;\n+\n+\t\t  goto update_fin_dep;\n+\t\t}\n \n \t      if (lref->u.ar.dimen_type[n] == DIMEN_RANGE\n \t\t  && rref->u.ar.dimen_type[n] == DIMEN_RANGE)\n@@ -2164,6 +2176,8 @@ gfc_dep_resolver (gfc_ref *lref, gfc_ref *rref, gfc_reverse *reverse)\n \n \t      /* Overlap codes are in order of priority.  We only need to\n \t\t know the worst one.*/\n+\n+\t    update_fin_dep:\n \t      if (this_dep > fin_dep)\n \t\tfin_dep = this_dep;\n \t    }"}, {"sha": "3580ff389bcb9fcebe7cb9d16d4ba8eeb3dd5884", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=94b150705d06352ec7f38259b2d4a18af4bb7011", "patch": "@@ -1,3 +1,9 @@\n+2013-07-21  Thomas Koenig  <tkoenig@gcc.gnu.org>\n+\n+\tPR fortran/56937\n+\t* gfortran.dg/dependency_42.f90:  New test.\n+\t* gfortran.dg/dependency_43.f90:  New test.\n+\n 2013-07-21  Tobias Burnus  <burnus@net-b.de>\n \n \tPR fortran/35862"}, {"sha": "8f067322f9a13e1660078a29a0ed3095bc4941e5", "filename": "gcc/testsuite/gfortran.dg/dependency_42.f90", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_42.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_42.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_42.f90?ref=94b150705d06352ec7f38259b2d4a18af4bb7011", "patch": "@@ -0,0 +1,16 @@\n+! { dg-do run }\n+! { dg-options \"-Warray-temporaries\" }\n+! PR fortran/56937 - unnecessary temporaries with vector indices\n+program main\n+  real :: q(4), r(4), p(3)\n+  integer :: idx(3)\n+  p = [0.5, 1.0, 2.0]\n+  idx = [4,3,1]\n+  r = 1.0\n+  r(idx) = r(idx) + p\n+  q = 1.0\n+  q(4) = q(4) + p(1)\n+  q(3) = q(3) + p(2)\n+  q(1) = q(1) + p(3)\n+  if (any (q - r /= 0)) call abort\n+end"}, {"sha": "c407369c5e6c74dbb27249f7171813ffbe5766b4", "filename": "gcc/testsuite/gfortran.dg/dependency_43.f90", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_43.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94b150705d06352ec7f38259b2d4a18af4bb7011/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_43.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fdependency_43.f90?ref=94b150705d06352ec7f38259b2d4a18af4bb7011", "patch": "@@ -0,0 +1,14 @@\n+! { dg-do run }\n+! { dg-options \"-Warray-temporaries\" }\n+! PR fortran/56937 - unnecessary temporaries with vector indices\n+program main\n+  integer, dimension(3) :: i1, i2\n+  real :: a(3,2)\n+\n+  data a / 1.0, 2.0, 3.0, 4.0, 5.0, 6.0 /\n+  i1 = [ 1, 2, 3 ]\n+  i2 = [ 3, 2, 1 ]\n+  a (i1,1) = a (i2,2)\n+  if (a(1,1) /= 6.0 .or. a(2,1) /= 5.0 .or. a(3,1) /= 4.0) call abort\n+  if (a(1,2) /= 4.0 .or. a(2,2) /= 5.0 .or. a(3,2) /= 6.0) call abort\n+end program main"}]}