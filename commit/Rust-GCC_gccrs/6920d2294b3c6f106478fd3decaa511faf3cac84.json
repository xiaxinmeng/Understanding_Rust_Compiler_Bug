{"sha": "6920d2294b3c6f106478fd3decaa511faf3cac84", "node_id": "C_kwDOANBUbNoAKDY5MjBkMjI5NGIzYzZmMTA2NDc4ZmQzZGVjYWE1MTFmYWYzY2FjODQ", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-07-18T12:15:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-18T12:15:20Z"}, "message": "Merge #1373\n\n1373: Typecheck const generic params r=CohenArthur a=CohenArthur\n\n```rust\r\nstruct Foo<const N: usize>;\r\nstruct Bar<const N: usize = { 15i32 }>; // { dg-error \"expected .usize. got .i32.\" }\r\n```\r\n\r\nThis PR allows us to typecheck the type of const generics as well as make sure that the optional default expression fits that type\n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>", "tree": {"sha": "9425005eaae1a0d2815c0819e01445ccc0197283", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9425005eaae1a0d2815c0819e01445ccc0197283"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6920d2294b3c6f106478fd3decaa511faf3cac84", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi1U7YCRBK7hj4Ov3rIwAATwcIAHMNLnfgiJtb2QdAJAfgb8zM\nVMewo4wKLs2n49nxp403kDkfQpN3lqG1VFQ3NYaEVKp11125eKRDkgLHdaInwd6F\nZgCKMvLFPmftwhUTCYQX/FXi+kODXTOb9PbH/ajF6Wrv1k1tr94YFJUvwrxYcdld\nT3iOIy8ypsmdsvOclo2MpqevJnQ/FN/mkTPKjIL4/CPB8Ez74L14gwEP4dIJi0Gh\nuB018ZyIlZhdDa8lexk4UoKMxdwhrv4IsikqtoA+MXbzv/MIQnUsd2KHV6Fp/WYZ\nBJUWc9O44umIROA1qVDwRzuDFZhO2RZ55iLa++5H9ilXPLXtvsdfxZgilOZOS/4=\n=wNx0\n-----END PGP SIGNATURE-----\n", "payload": "tree 9425005eaae1a0d2815c0819e01445ccc0197283\nparent e4cdb24c468b8a848980f7138767fbe093471c5b\nparent 43cd742e348d376ed4e7e0375b23289286525c8a\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1658146520 +0000\ncommitter GitHub <noreply@github.com> 1658146520 +0000\n\nMerge #1373\n\n1373: Typecheck const generic params r=CohenArthur a=CohenArthur\n\n```rust\r\nstruct Foo<const N: usize>;\r\nstruct Bar<const N: usize = { 15i32 }>; // { dg-error \"expected .usize. got .i32.\" }\r\n```\r\n\r\nThis PR allows us to typecheck the type of const generics as well as make sure that the optional default expression fits that type\n\nCo-authored-by: Arthur Cohen <arthur.cohen@embecosm.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6920d2294b3c6f106478fd3decaa511faf3cac84", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6920d2294b3c6f106478fd3decaa511faf3cac84", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6920d2294b3c6f106478fd3decaa511faf3cac84/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4cdb24c468b8a848980f7138767fbe093471c5b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e4cdb24c468b8a848980f7138767fbe093471c5b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e4cdb24c468b8a848980f7138767fbe093471c5b"}, {"sha": "43cd742e348d376ed4e7e0375b23289286525c8a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/43cd742e348d376ed4e7e0375b23289286525c8a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/43cd742e348d376ed4e7e0375b23289286525c8a"}], "stats": {"total": 40, "additions": 38, "deletions": 2}, "files": [{"sha": "006a254e0d7abf2cf06ba867c325bf9154590df5", "filename": "gcc/rust/hir/rust-hir-dump.cc", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Frust-hir-dump.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Frust-hir-dump.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-hir-dump.cc?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -238,6 +238,10 @@ void\n Dump::visit (TypeParam &)\n {}\n \n+void\n+Dump::visit (ConstGenericParam &)\n+{}\n+\n void\n Dump::visit (LifetimeWhereClauseItem &)\n {}"}, {"sha": "af104da15691897ed41741f66cc1254e7f9c8491", "filename": "gcc/rust/hir/rust-hir-dump.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Frust-hir-dump.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Frust-hir-dump.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Frust-hir-dump.h?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -108,6 +108,7 @@ class Dump : public HIRFullVisitor\n   virtual void visit (AsyncBlockExpr &) override;\n \n   virtual void visit (TypeParam &) override;\n+  virtual void visit (ConstGenericParam &) override;\n \n   virtual void visit (LifetimeWhereClauseItem &) override;\n   virtual void visit (TypeBoundWhereClauseItem &) override;"}, {"sha": "af838fd450871a29bfca4a6da3308319b7de6820", "filename": "gcc/rust/hir/tree/rust-hir-full-decls.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-full-decls.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-full-decls.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-full-decls.h?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -141,6 +141,7 @@ class ExprStmtWithBlock;\n \n // rust-item.h\n class TypeParam;\n+class ConstGenericParam;\n class WhereClauseItem;\n class LifetimeWhereClauseItem;\n class TypeBoundWhereClauseItem;"}, {"sha": "11eacbe3e363c9b017265df2df2f65b9db6132b3", "filename": "gcc/rust/hir/tree/rust-hir-visitor.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-visitor.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-visitor.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir-visitor.h?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -93,6 +93,7 @@ class HIRFullVisitor\n   virtual void visit (AwaitExpr &expr) = 0;\n   virtual void visit (AsyncBlockExpr &expr) = 0;\n   virtual void visit (TypeParam &param) = 0;\n+  virtual void visit (ConstGenericParam &param) = 0;\n   virtual void visit (LifetimeWhereClauseItem &item) = 0;\n   virtual void visit (TypeBoundWhereClauseItem &item) = 0;\n   virtual void visit (Module &module) = 0;\n@@ -238,6 +239,7 @@ class HIRFullVisitorBase : public HIRFullVisitor\n   virtual void visit (AsyncBlockExpr &) override {}\n \n   virtual void visit (TypeParam &) override {}\n+  virtual void visit (ConstGenericParam &) override {}\n \n   virtual void visit (LifetimeWhereClauseItem &) override {}\n   virtual void visit (TypeBoundWhereClauseItem &) override {}"}, {"sha": "58f4db2fcc672b7dcb12ea3b7c6c2beab54f2cb4", "filename": "gcc/rust/hir/tree/rust-hir.h", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Ftree%2Frust-hir.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Fhir%2Ftree%2Frust-hir.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fhir%2Ftree%2Frust-hir.h?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -769,6 +769,16 @@ class ConstGenericParam : public GenericParam\n \n   Location get_locus () const override final { return locus; };\n \n+  bool has_default_expression () { return default_expression != nullptr; }\n+\n+  std::unique_ptr<Type> &get_type () { return type; }\n+  std::unique_ptr<Expr> &get_default_expression ()\n+  {\n+    rust_assert (has_default_expression ());\n+\n+    return default_expression;\n+  }\n+\n protected:\n   /* Use covariance to implement clone function as returning this object rather\n    * than base */"}, {"sha": "69377e28d2208ee4c4ea5af4009b5da533748aa9", "filename": "gcc/rust/typecheck/rust-hir-type-check-toplevel.cc", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-toplevel.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-toplevel.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Ftypecheck%2Frust-hir-type-check-toplevel.cc?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -38,10 +38,26 @@ TypeCheckTopLevel::resolve_generic_params (\n       switch (generic_param.get ()->get_kind ())\n \t{\n \tcase HIR::GenericParam::GenericKind::LIFETIME:\n-\tcase HIR::GenericParam::GenericKind::CONST:\n-\t  // FIXME: Skipping Lifetime and Const completely until better\n+\t  // FIXME: Skipping Lifetime completely until better\n \t  // handling.\n \t  break;\n+\t  case HIR::GenericParam::GenericKind::CONST: {\n+\t    auto param\n+\t      = static_cast<HIR::ConstGenericParam *> (generic_param.get ());\n+\t    auto specified_type\n+\t      = TypeCheckType::Resolve (param->get_type ().get ());\n+\n+\t    if (param->has_default_expression ())\n+\t      {\n+\t\tauto expr_type = TypeCheckExpr::Resolve (\n+\t\t  param->get_default_expression ().get ());\n+\t\tspecified_type->coerce (expr_type);\n+\t      }\n+\n+\t    context->insert_type (generic_param->get_mappings (),\n+\t\t\t\t  specified_type);\n+\t  }\n+\t  break;\n \n \t  case HIR::GenericParam::GenericKind::TYPE: {\n \t    auto param_type"}, {"sha": "de261236d933188dcea0dccd51bb358c56583efb", "filename": "gcc/testsuite/rust/compile/const_generics_6.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Ftestsuite%2Frust%2Fcompile%2Fconst_generics_6.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6920d2294b3c6f106478fd3decaa511faf3cac84/gcc%2Ftestsuite%2Frust%2Fcompile%2Fconst_generics_6.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Fconst_generics_6.rs?ref=6920d2294b3c6f106478fd3decaa511faf3cac84", "patch": "@@ -0,0 +1,2 @@\n+struct Foo<const N: usize>;\n+struct Bar<const N: usize = { 15i32 }>; // { dg-error \"expected .usize. got .i32.\" }"}]}