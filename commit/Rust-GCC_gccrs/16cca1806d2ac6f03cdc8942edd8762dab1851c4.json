{"sha": "16cca1806d2ac6f03cdc8942edd8762dab1851c4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTZjY2ExODA2ZDJhYzZmMDNjZGM4OTQyZWRkODc2MmRhYjE4NTFjNA==", "commit": {"author": {"name": "H.J. Lu", "email": "hjl.tools@gmail.com", "date": "2021-09-15T06:17:58Z"}, "committer": {"name": "liuhongt", "email": "hongtao.liu@intel.com", "date": "2021-09-17T08:17:57Z"}, "message": "x86: Properly handle USE_VECTOR_FP_CONVERTS/USE_VECTOR_CONVERTS\n\nCheck TARGET_USE_VECTOR_FP_CONVERTS or TARGET_USE_VECTOR_CONVERTS when\nhandling avx_partial_xmm_update attribute.  Don't convert AVX partial\nXMM register update if vector packed SSE conversion should be used.\n\ngcc/\n\n\tPR target/101900\n\t* config/i386/i386-features.c (remove_partial_avx_dependency):\n\tCheck TARGET_USE_VECTOR_FP_CONVERTS and TARGET_USE_VECTOR_CONVERTS\n\tbefore generating vxorps.\n\ngcc/testsuite\n\n\tPR target/101900\n\t* gcc.target/i386/pr101900-1.c: New test.\n\t* gcc.target/i386/pr101900-2.c: Likewise.\n\t* gcc.target/i386/pr101900-3.c: Likewise.", "tree": {"sha": "a2ef6b0885028e9ec58be42cab6a5d7102f75691", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a2ef6b0885028e9ec58be42cab6a5d7102f75691"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/16cca1806d2ac6f03cdc8942edd8762dab1851c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/16cca1806d2ac6f03cdc8942edd8762dab1851c4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/16cca1806d2ac6f03cdc8942edd8762dab1851c4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/16cca1806d2ac6f03cdc8942edd8762dab1851c4/comments", "author": {"login": "hjl-tools", "id": 1072356, "node_id": "MDQ6VXNlcjEwNzIzNTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hjl-tools", "html_url": "https://github.com/hjl-tools", "followers_url": "https://api.github.com/users/hjl-tools/followers", "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}", "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}", "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions", "organizations_url": "https://api.github.com/users/hjl-tools/orgs", "repos_url": "https://api.github.com/users/hjl-tools/repos", "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}", "received_events_url": "https://api.github.com/users/hjl-tools/received_events", "type": "User", "site_admin": false}, "committer": {"login": "algebra84", "id": 22926165, "node_id": "MDQ6VXNlcjIyOTI2MTY1", "avatar_url": "https://avatars.githubusercontent.com/u/22926165?v=4", "gravatar_id": "", "url": "https://api.github.com/users/algebra84", "html_url": "https://github.com/algebra84", "followers_url": "https://api.github.com/users/algebra84/followers", "following_url": "https://api.github.com/users/algebra84/following{/other_user}", "gists_url": "https://api.github.com/users/algebra84/gists{/gist_id}", "starred_url": "https://api.github.com/users/algebra84/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/algebra84/subscriptions", "organizations_url": "https://api.github.com/users/algebra84/orgs", "repos_url": "https://api.github.com/users/algebra84/repos", "events_url": "https://api.github.com/users/algebra84/events{/privacy}", "received_events_url": "https://api.github.com/users/algebra84/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c3a2437fec1963d9150b7cf6bd03c1d8d184a301", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c3a2437fec1963d9150b7cf6bd03c1d8d184a301", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c3a2437fec1963d9150b7cf6bd03c1d8d184a301"}], "stats": {"total": 78, "additions": 75, "deletions": 3}, "files": [{"sha": "a65f60122a5f1c28aef6acecf58db4dc24b5235b", "filename": "gcc/config/i386/i386-features.c", "status": "modified", "additions": 20, "deletions": 3, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Fconfig%2Fi386%2Fi386-features.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Fconfig%2Fi386%2Fi386-features.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386-features.c?ref=16cca1806d2ac6f03cdc8942edd8762dab1851c4", "patch": "@@ -2210,15 +2210,32 @@ remove_partial_avx_dependency (void)\n \t      != AVX_PARTIAL_XMM_UPDATE_TRUE)\n \t    continue;\n \n-\t  if (!v4sf_const0)\n-\t    v4sf_const0 = gen_reg_rtx (V4SFmode);\n-\n \t  /* Convert PARTIAL_XMM_UPDATE_TRUE insns, DF -> SF, SF -> DF,\n \t     SI -> SF, SI -> DF, DI -> SF, DI -> DF, to vec_dup and\n \t     vec_merge with subreg.  */\n \t  rtx src = SET_SRC (set);\n \t  rtx dest = SET_DEST (set);\n \t  machine_mode dest_mode = GET_MODE (dest);\n+\t  machine_mode src_mode = GET_MODE (XEXP (src, 0));\n+\n+\t  switch (src_mode)\n+\t    {\n+\t    case E_SFmode:\n+\t    case E_DFmode:\n+\t      if (TARGET_USE_VECTOR_FP_CONVERTS)\n+\t\tcontinue;\n+\t      break;\n+\t    case E_SImode:\n+\t    case E_DImode:\n+\t      if (TARGET_USE_VECTOR_CONVERTS)\n+\t\tcontinue;\n+\t      break;\n+\t    default:\n+\t      break;\n+\t    }\n+\n+\t  if (!v4sf_const0)\n+\t    v4sf_const0 = gen_reg_rtx (V4SFmode);\n \n \t  rtx zero;\n \t  machine_mode dest_vecmode;"}, {"sha": "0a45f8e340a86f70ce51d6ff84eaadf52a78459f", "filename": "gcc/testsuite/gcc.target/i386/pr101900-1.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-1.c?ref=16cca1806d2ac6f03cdc8942edd8762dab1851c4", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=skylake -mfpmath=sse -mtune-ctrl=use_vector_fp_converts\" } */\n+\n+extern float f;\n+extern double d;\n+extern int i;\n+\n+void\n+foo (void)\n+{\n+  d = f;\n+  f = i;\n+}\n+\n+/* { dg-final { scan-assembler \"vcvtps2pd\" } } */\n+/* { dg-final { scan-assembler \"vcvtsi2ssl\" } } */\n+/* { dg-final { scan-assembler-not \"vcvtss2sd\" } } */\n+/* { dg-final { scan-assembler-times \"vxorps\\[^\\n\\r\\]*xmm\\[0-9\\]\" 1 } } */"}, {"sha": "c8b2d1da5ae99d85ee5d08d23ed6e70f889fb3cd", "filename": "gcc/testsuite/gcc.target/i386/pr101900-2.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-2.c?ref=16cca1806d2ac6f03cdc8942edd8762dab1851c4", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=skylake -mfpmath=sse -mtune-ctrl=use_vector_converts\" } */\n+\n+extern float f;\n+extern double d;\n+extern int i;\n+\n+void\n+foo (void)\n+{\n+  d = f;\n+  f = i;\n+}\n+\n+/* { dg-final { scan-assembler \"vcvtss2sd\" } } */\n+/* { dg-final { scan-assembler \"vcvtdq2ps\" } } */\n+/* { dg-final { scan-assembler-not \"vcvtsi2ssl\" } } */\n+/* { dg-final { scan-assembler-times \"vxorps\\[^\\n\\r\\]*xmm\\[0-9\\]\" 1 } } */"}, {"sha": "6ee565b5bd4b89b2c81acdf7030c604e71fd7e62", "filename": "gcc/testsuite/gcc.target/i386/pr101900-3.c", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/16cca1806d2ac6f03cdc8942edd8762dab1851c4/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fi386%2Fpr101900-3.c?ref=16cca1806d2ac6f03cdc8942edd8762dab1851c4", "patch": "@@ -0,0 +1,19 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -march=skylake -mfpmath=sse -mtune-ctrl=use_vector_fp_converts,use_vector_converts\" } */\n+\n+extern float f;\n+extern double d;\n+extern int i;\n+\n+void\n+foo (void)\n+{\n+  d = f;\n+  f = i;\n+}\n+\n+/* { dg-final { scan-assembler \"vcvtps2pd\" } } */\n+/* { dg-final { scan-assembler \"vcvtdq2ps\" } } */\n+/* { dg-final { scan-assembler-not \"vcvtss2sd\" } } */\n+/* { dg-final { scan-assembler-not \"vcvtsi2ssl\" } } */\n+/* { dg-final { scan-assembler-not \"vxorps\" } } */"}]}