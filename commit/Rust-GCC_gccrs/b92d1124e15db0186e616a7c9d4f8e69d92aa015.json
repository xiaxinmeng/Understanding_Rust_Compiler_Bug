{"sha": "b92d1124e15db0186e616a7c9d4f8e69d92aa015", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjkyZDExMjRlMTVkYjAxODZlNjE2YTdjOWQ0ZjhlNjlkOTJhYTAxNQ==", "commit": {"author": {"name": "Andrew Stubbs", "email": "ams@codesourcery.com", "date": "2019-12-17T13:01:25Z"}, "committer": {"name": "Andrew Stubbs", "email": "ams@gcc.gnu.org", "date": "2019-12-17T13:01:25Z"}, "message": "Add extract_last for amdgcn\n\n2019-12-17  Andrew Stubbs  <ams@codesourcery.com>\n\n\tgcc/\n\t* config/gcn/gcn-valu.md (extract_last_<mode>): New expander.\n\t(fold_extract_last_<mode>): New expander.\n\n\tgcc/testsuite/\n\t* lib/target-supports.exp\n\t(check_effective_target_vect_fold_extract_last): Add amdgcn.\n\nFrom-SVN: r279459", "tree": {"sha": "e863707a1535bfa874993ad59c5366457b352f4f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e863707a1535bfa874993ad59c5366457b352f4f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b92d1124e15db0186e616a7c9d4f8e69d92aa015", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b92d1124e15db0186e616a7c9d4f8e69d92aa015", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b92d1124e15db0186e616a7c9d4f8e69d92aa015", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b92d1124e15db0186e616a7c9d4f8e69d92aa015/comments", "author": {"login": "ams-cs", "id": 2235130, "node_id": "MDQ6VXNlcjIyMzUxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/2235130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ams-cs", "html_url": "https://github.com/ams-cs", "followers_url": "https://api.github.com/users/ams-cs/followers", "following_url": "https://api.github.com/users/ams-cs/following{/other_user}", "gists_url": "https://api.github.com/users/ams-cs/gists{/gist_id}", "starred_url": "https://api.github.com/users/ams-cs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ams-cs/subscriptions", "organizations_url": "https://api.github.com/users/ams-cs/orgs", "repos_url": "https://api.github.com/users/ams-cs/repos", "events_url": "https://api.github.com/users/ams-cs/events{/privacy}", "received_events_url": "https://api.github.com/users/ams-cs/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "34bac26458e59295541a7f485def72721a8981ef", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/34bac26458e59295541a7f485def72721a8981ef", "html_url": "https://github.com/Rust-GCC/gccrs/commit/34bac26458e59295541a7f485def72721a8981ef"}], "stats": {"total": 55, "additions": 54, "deletions": 1}, "files": [{"sha": "161768c74055db6b20b4e1139e409c04a996b7ef", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=b92d1124e15db0186e616a7c9d4f8e69d92aa015", "patch": "@@ -1,3 +1,8 @@\n+2019-12-17  Andrew Stubbs  <ams@codesourcery.com>\n+\n+\t* config/gcn/gcn-valu.md (extract_last_<mode>): New expander.\n+\t(fold_extract_last_<mode>): New expander.\n+\n 2019-12-17  Andrew Stubbs  <ams@codesourcery.com>\n \n \t* config/gcn/gcn.h (CLZ_DEFINED_VALUE_AT_ZERO): Define."}, {"sha": "3b3be8a9e368a5fd985530011d53060c6561d355", "filename": "gcc/config/gcn/gcn-valu.md", "status": "modified", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2Fconfig%2Fgcn%2Fgcn-valu.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2Fconfig%2Fgcn%2Fgcn-valu.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fgcn%2Fgcn-valu.md?ref=b92d1124e15db0186e616a7c9d4f8e69d92aa015", "patch": "@@ -591,6 +591,48 @@\n    (set_attr \"exec\" \"none\")\n    (set_attr \"laneselect\" \"yes\")])\n \n+(define_expand \"extract_last_<mode>\"\n+  [(match_operand:<SCALAR_MODE> 0 \"register_operand\")\n+   (match_operand:DI 1 \"gcn_alu_operand\")\n+   (match_operand:VEC_ALLREG_MODE 2 \"register_operand\")]\n+  \"can_create_pseudo_p ()\"\n+  {\n+    rtx dst = operands[0];\n+    rtx mask = operands[1];\n+    rtx vect = operands[2];\n+    rtx tmpreg = gen_reg_rtx (SImode);\n+\n+    emit_insn (gen_clzdi2 (tmpreg, mask));\n+    emit_insn (gen_subsi3 (tmpreg, GEN_INT (63), tmpreg));\n+    emit_insn (gen_vec_extract<mode><scalar_mode> (dst, vect, tmpreg));\n+    DONE;\n+  })\n+\n+(define_expand \"fold_extract_last_<mode>\"\n+  [(match_operand:<SCALAR_MODE> 0 \"register_operand\")\n+   (match_operand:<SCALAR_MODE> 1 \"gcn_alu_operand\")\n+   (match_operand:DI 2 \"gcn_alu_operand\")\n+   (match_operand:VEC_ALLREG_MODE 3 \"register_operand\")]\n+  \"can_create_pseudo_p ()\"\n+  {\n+    rtx dst = operands[0];\n+    rtx default_value = operands[1];\n+    rtx mask = operands[2];\n+    rtx vect = operands[3];\n+    rtx else_label = gen_label_rtx ();\n+    rtx end_label = gen_label_rtx ();\n+\n+    rtx cond = gen_rtx_EQ (VOIDmode, mask, const0_rtx);\n+    emit_jump_insn (gen_cbranchdi4 (cond, mask, const0_rtx, else_label));\n+    emit_insn (gen_extract_last_<mode> (dst, mask, vect));\n+    emit_jump_insn (gen_jump (end_label));\n+    emit_barrier ();\n+    emit_label (else_label);\n+    emit_move_insn (dst, default_value);\n+    emit_label (end_label);\n+    DONE;\n+  })\n+\n (define_expand \"vec_init<mode><scalar_mode>\"\n   [(match_operand:VEC_ALLREG_MODE 0 \"register_operand\")\n    (match_operand 1)]"}, {"sha": "28b7400dfd7dac5884b1529cc120138fd6f4ec20", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b92d1124e15db0186e616a7c9d4f8e69d92aa015", "patch": "@@ -1,3 +1,8 @@\n+2019-12-17  Andrew Stubbs  <ams@codesourcery.com>\n+\n+\t* lib/target-supports.exp\n+\t(check_effective_target_vect_fold_extract_last): Add amdgcn.\n+\n 2019-12-17  Hongyu Wang  <hongyu.wang@intel.com>\n \n \t* gcc.target/i386/pr92651.c: New testcase."}, {"sha": "98f1141a8a4e5b55c58c4512d93f280fe675e601", "filename": "gcc/testsuite/lib/target-supports.exp", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2Ftestsuite%2Flib%2Ftarget-supports.exp", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b92d1124e15db0186e616a7c9d4f8e69d92aa015/gcc%2Ftestsuite%2Flib%2Ftarget-supports.exp", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Flib%2Ftarget-supports.exp?ref=b92d1124e15db0186e616a7c9d4f8e69d92aa015", "patch": "@@ -6974,7 +6974,8 @@ proc check_effective_target_vect_logical_reduc { } {\n # Return 1 if the target supports the fold_extract_last optab.\n \n proc check_effective_target_vect_fold_extract_last { } {\n-    return [check_effective_target_aarch64_sve]\n+    return [expr { [check_effective_target_aarch64_sve]\n+\t\t   || [istarget amdgcn*-*-*] }]\n }\n \n # Return 1 if the target supports section-anchors"}]}