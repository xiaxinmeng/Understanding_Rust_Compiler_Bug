{"sha": "e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTllNGRkZmM1YWJiZjllZTVlNjU3ZDYyNjI2NGNlZjg5ZjEwYjRjMw==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-12-15T23:17:40Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-12-19T19:39:04Z"}, "message": "d: Fix ICE in in force_decl_die, at dwarf2out.c with -gdwarf-2 -gstrict-dwarf [PR98067]\n\nManifest constants in D are represented as CONST_DECLs, which can be\nimported from one module to another.  However, when compiling on strict\ndwarf2 targets such as *-*-darwin10, importing CONST_DECLs cannot be\nrepresented in debug as D did not exist as an AT_language until dwarf3,\nand the only available fallback being DW_LANG_C.  As CONST_DECLs are\ntreated as enumerators in C, and not outputted individually in\ngen_decl_die, this causes an internal error in force_decl_die to occur.\n\nTo handle this, similar to other places in dwarf2out, if a CONST_DECL is\nseen in dwarf2out_imported_module_or_decl_1, then we simply return early\nif the language is not one of Ada, D, or Fortran.\n\ngcc/ChangeLog:\n\n\tPR d/98067\n\t* dwarf2out.c (dwarf2out_imported_module_or_decl_1): Handle\n\t  CONST_DECL only if is_fortran, is_ada, or is_dlang.\n\ngcc/testsuite/ChangeLog:\n\n\tPR d/98067\n\t* gdc.dg/debug/debug.exp: New test.\n\t* gdc.dg/debug/dwarf2/dwarf2.exp: New test.\n\t* gdc.dg/debug/dwarf2/imports/pr98067.d: New test.\n\t* gdc.dg/debug/dwarf2/langdw2.d: New test.\n\t* gdc.dg/debug/dwarf2/langdw3.d: New test.\n\t* gdc.dg/debug/dwarf2/pr98067.d: New test.\n\t* gdc.dg/debug/trivial.d: New test.", "tree": {"sha": "27db000303acbbfe2ddbd905428e3a5485a67081", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/27db000303acbbfe2ddbd905428e3a5485a67081"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9032d2b2414ed22e53a9980a51b835d3caf83c48", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9032d2b2414ed22e53a9980a51b835d3caf83c48", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9032d2b2414ed22e53a9980a51b835d3caf83c48"}], "stats": {"total": 94, "additions": 94, "deletions": 0}, "files": [{"sha": "027f327c1a12f05bd0cbbdfca6ff53a00cb1ce64", "filename": "gcc/dwarf2out.c", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Fdwarf2out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Fdwarf2out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdwarf2out.c?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -26705,6 +26705,13 @@ dwarf2out_imported_module_or_decl_1 (tree decl,\n \t      gen_type_die_for_member (type, decl,\n \t\t\t\t       get_context_die (TYPE_CONTEXT (type)));\n \t    }\n+\t  if (TREE_CODE (decl) == CONST_DECL)\n+\t    {\n+\t      /* Individual enumerators of an enum type do not get output here\n+\t\t (see gen_decl_die), so we cannot call force_decl_die.  */\n+\t      if (!is_fortran () && !is_ada () && !is_dlang ())\n+\t\treturn;\n+\t    }\n \t  if (TREE_CODE (decl) == NAMELIST_DECL)\n \t    at_import_die = gen_namelist_decl (DECL_NAME (decl),\n \t\t\t\t\t get_context_die (DECL_CONTEXT (decl)),"}, {"sha": "1607c4d6d4484e5fbf62f4d43f315034b633982b", "filename": "gcc/testsuite/gdc.dg/debug/debug.exp", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdebug.exp", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdebug.exp", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdebug.exp?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,28 @@\n+# Copyright (C) 2020 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+# \n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+# \n+# You should have received a copy of the GNU General Public License\n+# along with GCC; see the file COPYING3.  If not see\n+# <http://www.gnu.org/licenses/>.\n+\n+# Load support procs.\n+load_lib gdc-dg.exp\n+\n+# Initialize `dg'.\n+dg-init\n+\n+# Main loop.\n+gcc-dg-debug-runtest gdc_target_compile trivial.d [list -O -O3] \\\n+    [lsort [glob -nocomplain $srcdir/$subdir/*.d]]\n+\n+# All done.\n+dg-finish"}, {"sha": "c81afd00f5e5b68095be222579662a9586f30f52", "filename": "gcc/testsuite/gdc.dg/debug/dwarf2/dwarf2.exp", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fdwarf2.exp", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fdwarf2.exp", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fdwarf2.exp?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,31 @@\n+#   Copyright (C) 2020 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+# \n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+# \n+# You should have received a copy of the GNU General Public License\n+# along with GCC; see the file COPYING3.  If not see\n+# <http://www.gnu.org/licenses/>.\n+\n+# Load support procs.\n+load_lib gdc-dg.exp\n+\n+# Main loop.\n+set comp_output [gdc_target_compile \\\n+    \"$srcdir/$subdir/../trivial.d\" \"trivial.S\" assembly \\\n+    \"additional_flags=-gdwarf\"]\n+if { ! [string match \"*: target system does not support the * debug format*\" \\\n+    $comp_output] } {\n+    remove-build-file \"trivial.S\"\n+    gdc-dg-runtest [lsort [glob -nocomplain $srcdir/$subdir/*.d ] ] \"\" \"-gdwarf\"\n+}\n+\n+# All done.\n+dg-finish"}, {"sha": "d740d71a3e452a4204d99fb8a98c1368fbcfff78", "filename": "gcc/testsuite/gdc.dg/debug/dwarf2/imports/pr98067.d", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fimports%2Fpr98067.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fimports%2Fpr98067.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fimports%2Fpr98067.d?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,3 @@\n+module imports.pr98067;\n+\n+enum MAP_ANON = 0x10;"}, {"sha": "61c39279d8da4830b1ccd15d1148da1bd2a4336c", "filename": "gcc/testsuite/gdc.dg/debug/dwarf2/langdw2.d", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Flangdw2.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Flangdw2.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Flangdw2.d?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,7 @@\n+// DW_LANG_D is not available in dwarf2, so we should produce DW_LANG_C (0x2)\n+// as AT_language.\n+// { dg-do compile }\n+// { dg-options \"-gdwarf-2 -gstrict-dwarf -dA\" }\n+// { dg-final { scan-assembler \"0x2\\[^\\n\\r\\]*AT_language\" } }\n+\n+module langdw2;"}, {"sha": "7bdc68c46077f5acc322ae1be575d098efab0c81", "filename": "gcc/testsuite/gdc.dg/debug/dwarf2/langdw3.d", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Flangdw3.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Flangdw3.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Flangdw3.d?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,6 @@\n+// We should produce DW_LANG_D (0x13) as AT_language.\n+// { dg-do compile }\n+// { dg-options \"-gdwarf-3 -dA\" }\n+// { dg-final { scan-assembler \"0x13\\[^\\n\\r\\]*AT_language\" } }\n+\n+module langdw3;"}, {"sha": "4beb268e41d0bf4a3e3c734c109091c361daa073", "filename": "gcc/testsuite/gdc.dg/debug/dwarf2/pr98067.d", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fpr98067.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fpr98067.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Fdwarf2%2Fpr98067.d?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,6 @@\n+// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=98067\n+// { dg-options \"-gdwarf-2 -gstrict-dwarf -I $srcdir/gdc.dg/debug/dwarf2\" }\n+// { dg-do compile }\n+module pr98067;\n+\n+import imports.pr98067 : MAP_ANON;"}, {"sha": "dab2b683a49a1fd443f7275f9e8156bc900b2f32", "filename": "gcc/testsuite/gdc.dg/debug/trivial.d", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Ftrivial.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Ftrivial.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fdebug%2Ftrivial.d?ref=e9e4ddfc5abbf9ee5e657d626264cef89f10b4c3", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do run } */\n+\n+int main()\n+{\n+    return 0;\n+}"}]}