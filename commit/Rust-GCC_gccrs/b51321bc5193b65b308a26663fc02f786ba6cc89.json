{"sha": "b51321bc5193b65b308a26663fc02f786ba6cc89", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjUxMzIxYmM1MTkzYjY1YjMwOGEyNjY2M2ZjMDJmNzg2YmE2Y2M4OQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-04-07T13:51:15Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-04-07T13:51:15Z"}, "message": "varasm: Fix up constpool alias handling [PR99872]\n\nLast year, I have added in r11-2944-g0106300f6c3f7bae5eb1c46dbd45aa07c94e1b15\n(aka PR54201 fix) code to find bitwise duplicates in constant pool and output\nthem as aliases instead of duplicating the data.\n\nUnfortunately this broke mingw32 -m32.\nOn most targets, ASM_GENERATE_INTERNAL_LABEL with \"LC\" emits something like\n*.LC123 and the targets don't add user label prefixes, so the aliases\nthat we print should be something like\n        .set    .LC5, .LC6\nor\n        .set    .LC5, .LC6 + 8\nand I wasn't sure if ASM_OUTPUT_DEF can handle the * and therefore I have\nstripped it.\nBut, on mingw32 -m32, ASM_GENERATE_INTERNAL_LABEL with \"LC\" emits\n*LC123 and the target has user label prefixes, which means what I wrote\nresults in\nLC6:\n        ...\n        .set    _LC5, _LC6\nwhich results in unresolved symbols.  I went through the ASM_OUTPUT_DEF\ndefinitions of all targets and all of them use assemble_name twice under\nthe hood (with various differences on what they print before, in between or\nafter those names).  And assemble_name handles the name encoding properly,\nso if we pass it ASM_OUTPUT_DEF (..., \"*.LC123\", \"*.LC456+16\") it will\nemit .LC123 and .LC456+16 and if we pass it \"*LC789\", it will emit\nLC789.\n\n2021-04-07  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR target/99872\n\t* varasm.c (output_constant_pool_contents): Don't strip name encoding\n\tfrom XSTR (desc->sym, 0) or from label before passing those to\n\tASM_OUTPUT_DEF.", "tree": {"sha": "80bae5574d074fea54c2a2b785a2a7ed27be8716", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/80bae5574d074fea54c2a2b785a2a7ed27be8716"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b51321bc5193b65b308a26663fc02f786ba6cc89", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b51321bc5193b65b308a26663fc02f786ba6cc89", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b51321bc5193b65b308a26663fc02f786ba6cc89", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b51321bc5193b65b308a26663fc02f786ba6cc89/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c01ae2ab6b227e21835d128c90e974dce4604be9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c01ae2ab6b227e21835d128c90e974dce4604be9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c01ae2ab6b227e21835d128c90e974dce4604be9"}], "stats": {"total": 4, "additions": 2, "deletions": 2}, "files": [{"sha": "8bb921faa269dc1f5325ae67106286cae2b953fc", "filename": "gcc/varasm.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b51321bc5193b65b308a26663fc02f786ba6cc89/gcc%2Fvarasm.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b51321bc5193b65b308a26663fc02f786ba6cc89/gcc%2Fvarasm.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvarasm.c?ref=b51321bc5193b65b308a26663fc02f786ba6cc89", "patch": "@@ -4290,13 +4290,13 @@ output_constant_pool_contents (struct rtx_constant_pool *pool)\n     if (desc->mark < 0)\n       {\n #ifdef ASM_OUTPUT_DEF\n-\tconst char *name = targetm.strip_name_encoding (XSTR (desc->sym, 0));\n+\tconst char *name = XSTR (desc->sym, 0);\n \tchar label[256];\n \tchar buffer[256 + 32];\n \tconst char *p;\n \n \tASM_GENERATE_INTERNAL_LABEL (label, \"LC\", ~desc->mark);\n-\tp = targetm.strip_name_encoding (label);\n+\tp = label;\n \tif (desc->offset)\n \t  {\n \t    sprintf (buffer, \"%s+%ld\", p, (long) (desc->offset));"}]}