{"sha": "c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzQ5ZmNmZGRhYTQ3ZjI4MjhmZTJhZjExYWU4NTdjZDY3ZjUzZTIzZg==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2021-02-22T14:43:32Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2021-02-22T14:52:19Z"}, "message": "c++: cross-header-unit template definitions [PR 99153]\n\nA member function can be defined in a different header-file than the\none defining the class.  In such situations we must unmark the decl as\nimported.  When the entity is a template we failed to unmark the\ntemplate_decl.\n\nPerhaps the duplication of these flags on the template_decl from the\nunderlying decl is an error.  I set on the fence about it for a long\ntime during development, but I don't think now is the time to change\nthat (barring catastrophic bugs).\n\n\tPR c++/99153\n\tgcc/cp/\n\t* decl.c (duplicate_decls): Move DECL_MODULE_IMPORT_P propagation\n\tto common-path.\n\t* module.cc (set_defining_module): Add assert.\n\tgcc/testsuite/\n\t* g++.dg/modules/pr99153_a.H: New.\n\t* g++.dg/modules/pr99153_b.H: New.", "tree": {"sha": "5a9c6bd1dd5971b2f2d39da68146a32d2590762b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5a9c6bd1dd5971b2f2d39da68146a32d2590762b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c31a3a6d31b6214ea774d403bf8ab7ebe1ea862", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4c31a3a6d31b6214ea774d403bf8ab7ebe1ea862", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4c31a3a6d31b6214ea774d403bf8ab7ebe1ea862"}], "stats": {"total": 53, "additions": 40, "deletions": 13}, "files": [{"sha": "7fa8f52d6677a91b31ac584548e2e4a33c47c180", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "patch": "@@ -2879,19 +2879,6 @@ duplicate_decls (tree newdecl, tree olddecl, bool hiding, bool was_hidden)\n \t      (char *) newdecl + sizeof (struct tree_common),\n \t      sizeof (struct tree_decl_common) - sizeof (struct tree_common));\n \n-      if (DECL_LANG_SPECIFIC (olddecl) && DECL_TEMPLATE_INFO (olddecl))\n-\t{\n-\t  /* Repropagate the module information to the template.  */\n-\t  tree tmpl = DECL_TI_TEMPLATE (olddecl);\n-\n-\t  if (DECL_TEMPLATE_RESULT (tmpl) == olddecl)\n-\t    {\n-\t      DECL_MODULE_PURVIEW_P (tmpl) = DECL_MODULE_PURVIEW_P (olddecl);\n-\t      gcc_checking_assert (!DECL_MODULE_IMPORT_P (olddecl));\n-\t      DECL_MODULE_IMPORT_P (tmpl) = false;\n-\t    }\n-\t}\n-\n       switch (TREE_CODE (newdecl))\n \t{\n \tcase LABEL_DECL:\n@@ -2925,6 +2912,19 @@ duplicate_decls (tree newdecl, tree olddecl, bool hiding, bool was_hidden)\n \t}\n     }\n \n+  if (DECL_LANG_SPECIFIC (olddecl) && DECL_TEMPLATE_INFO (olddecl))\n+    {\n+      /* Repropagate the module information to the template.  */\n+      tree tmpl = DECL_TI_TEMPLATE (olddecl);\n+\n+      if (DECL_TEMPLATE_RESULT (tmpl) == olddecl)\n+\t{\n+\t  DECL_MODULE_PURVIEW_P (tmpl) = DECL_MODULE_PURVIEW_P (olddecl);\n+\t  gcc_checking_assert (!DECL_MODULE_IMPORT_P (olddecl));\n+\t  DECL_MODULE_IMPORT_P (tmpl) = false;\n+\t}\n+    }\n+\n   if (VAR_OR_FUNCTION_DECL_P (newdecl))\n     {\n       if (DECL_EXTERNAL (olddecl)"}, {"sha": "7a40be3db353ce2bb78d9da5c8d32cf789b316ad", "filename": "gcc/cp/module.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Fcp%2Fmodule.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Fcp%2Fmodule.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fmodule.cc?ref=c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "patch": "@@ -18516,6 +18516,7 @@ set_defining_module (tree decl)\n \t\t  gcc_checking_assert (!use_tpl);\n \t\t  /* Get to the TEMPLATE_DECL.  */\n \t\t  decl = TI_TEMPLATE (ti);\n+\t\t  gcc_checking_assert (!DECL_MODULE_IMPORT_P (decl));\n \t\t}\n \n \t      /* Record it on the class_members list.  */"}, {"sha": "3eaa76bdc323fe7923812e0cd74f2bdae780b770", "filename": "gcc/testsuite/g++.dg/modules/pr99153_a.H", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99153_a.H", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99153_a.H", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99153_a.H?ref=c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "patch": "@@ -0,0 +1,11 @@\n+// { dg-additional-options -fmodule-header }\n+// { dg-module-cmi {} }\n+\n+template<typename _T1>\n+struct pair\n+{\n+  inline void Frob ();\n+};\n+\n+template<typename _T2>\n+inline void Widget ();"}, {"sha": "5699378d3179d72df0fe379959e6a32501ed749c", "filename": "gcc/testsuite/g++.dg/modules/pr99153_b.H", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99153_b.H", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c49fcfddaa47f2828fe2af11ae857cd67f53e23f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99153_b.H", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fmodules%2Fpr99153_b.H?ref=c49fcfddaa47f2828fe2af11ae857cd67f53e23f", "patch": "@@ -0,0 +1,15 @@\n+// PR 99153 Mismatched flags on template and result\n+// { dg-additional-options -fmodule-header }\n+// { dg-module-cmi {} }\n+\n+import  \"pr99153_a.H\";\n+\n+template<class _T1>\n+inline  void pair<_T1>::Frob()\n+{ }\n+\n+\n+template<typename _T2>\n+inline void Widget () \n+{\n+}"}]}