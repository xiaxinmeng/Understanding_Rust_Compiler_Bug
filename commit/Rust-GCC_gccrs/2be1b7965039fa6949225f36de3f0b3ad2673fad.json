{"sha": "2be1b7965039fa6949225f36de3f0b3ad2673fad", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmJlMWI3OTY1MDM5ZmE2OTQ5MjI1ZjM2ZGUzZjBiM2FkMjY3M2ZhZA==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2016-10-25T18:10:44Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2016-10-25T18:10:44Z"}, "message": "Implement ~line_maps ()\n\nline_maps instances such as the global line_table are\nGC-managed, but the htab within location_adhoc_data_map.htab\nis not GC-managed.\n\nPreviously this was deleted manually by a call to\nlocation_adhoc_data_fini within toplev::main.\n\nHowever, on adding a call to forcibly_ggc_collect after the\nselftests, all of the htabs for the various line_tables\ncreated during the selftests start showing up as leaks\nin \"make selftest-valgrind\", e.g.:\n\n13,536 (1,344 direct, 12,192 indirect) bytes in 12 blocks are definitely lost in loss record 1,065 of 1,086\n   at 0x4A081D4: calloc (in /usr/lib64/valgrind/vgpreload_memcheck-amd64-linux.so)\n   by 0x16DB3B0: xcalloc (xmalloc.c:163)\n   by 0x16D8D34: htab_create_typed_alloc (hashtab.c:358)\n   by 0x16D8DBD: htab_create_alloc (hashtab.c:286)\n   by 0x16A2CCC: linemap_init(line_maps*, unsigned int) (line-map.c:353)\n   by 0x1685605: selftest::line_table_test::line_table_test(selftest::line_table_case const&) (input.c:1624)\n   by 0x167D09C: selftest::test_applying_fixits_modernize_named_init(selftest::line_table_case const&) (edit-context.c:1430)\n   by 0x1686827: selftest::for_each_line_table_case(void (*)(selftest::line_table_case const&)) (input.c:3227)\n   by 0x167F067: selftest::edit_context_c_tests() (edit-context.c:1658)\n   by 0x1616E67: selftest::run_tests() (selftest-run-tests.c:71)\n   by 0xC0DB25: toplev::run_self_tests() (toplev.c:2076)\n   by 0x618EB4: toplev::main(int, char**) (toplev.c:2153)\n\nThis patch removes the manual one-time cleanup in favor of\nadding a destructor to class line_maps, which cleans up\nthe non-GC-managed htab.\n\nDoing so improves \"make selftest-valgrind\" from:\n\n==61118== LEAK SUMMARY:\n==61118==    definitely lost: 121,248 bytes in 1,515 blocks\n==61118==    indirectly lost: 974,344 bytes in 959 blocks\n==61118==      possibly lost: 0 bytes in 0 blocks\n==61118==    still reachable: 1,332,599 bytes in 3,684 blocks\n==61118==         suppressed: 0 bytes in 0 blocks\n\nto:\n\n==57182== LEAK SUMMARY:\n==57182==    definitely lost: 13,840 bytes in 556 blocks\n==57182==    indirectly lost: 0 bytes in 0 blocks\n==57182==      possibly lost: 0 bytes in 0 blocks\n==57182==    still reachable: 1,355,703 bytes in 3,684 blocks\n==57182==         suppressed: 0 bytes in 0 blocks\n\ngcc/ChangeLog:\n\t* toplev.c (toplev::main): Remove call to\n\tlocation_adhoc_data_fini.\n\nlibcpp/ChangeLog:\n\t* include/line-map.h (line_maps::~line_maps): New dtor.\n\t(location_adhoc_data_fini): Delete decl.\n\t* line-map.c (line_maps::~line_maps): New dtor.\n\t(location_adhoc_data_fini): Delete.\n\nFrom-SVN: r241533", "tree": {"sha": "3f41bfa064ffc2fe0735f49afa33048345eca448", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3f41bfa064ffc2fe0735f49afa33048345eca448"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2be1b7965039fa6949225f36de3f0b3ad2673fad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2be1b7965039fa6949225f36de3f0b3ad2673fad", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2be1b7965039fa6949225f36de3f0b3ad2673fad", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2be1b7965039fa6949225f36de3f0b3ad2673fad/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "f64e0c029c452c9fc508adebf18d0ceb3ffdc066", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f64e0c029c452c9fc508adebf18d0ceb3ffdc066", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f64e0c029c452c9fc508adebf18d0ceb3ffdc066"}], "stats": {"total": 31, "additions": 22, "deletions": 9}, "files": [{"sha": "f44656fac3c7e861e543fcfd531482cd88131916", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2be1b7965039fa6949225f36de3f0b3ad2673fad/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2be1b7965039fa6949225f36de3f0b3ad2673fad/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=2be1b7965039fa6949225f36de3f0b3ad2673fad", "patch": "@@ -1,3 +1,8 @@\n+2016-10-25  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* toplev.c (toplev::main): Remove call to\n+\tlocation_adhoc_data_fini.\n+\n 2016-10-25  Eric Botcazou  <ebotcazou@adacore.com>\n \n \t* tree.h (wi::fits_to_tree_p): Accept only 0 and 1 for boolean types."}, {"sha": "59b84eb4d4be9f61df80494783150f2c457ab5fe", "filename": "gcc/toplev.c", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2be1b7965039fa6949225f36de3f0b3ad2673fad/gcc%2Ftoplev.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2be1b7965039fa6949225f36de3f0b3ad2673fad/gcc%2Ftoplev.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftoplev.c?ref=2be1b7965039fa6949225f36de3f0b3ad2673fad", "patch": "@@ -2169,7 +2169,6 @@ toplev::main (int argc, char **argv)\n   diagnostic_finish (global_dc);\n \n   finalize_plugins ();\n-  location_adhoc_data_fini (line_table);\n \n   after_memory_report = true;\n "}, {"sha": "5ff0aad08f876660c0d44aa91f030dcfc63f94fe", "filename": "libcpp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2be1b7965039fa6949225f36de3f0b3ad2673fad/libcpp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2be1b7965039fa6949225f36de3f0b3ad2673fad/libcpp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2FChangeLog?ref=2be1b7965039fa6949225f36de3f0b3ad2673fad", "patch": "@@ -1,3 +1,10 @@\n+2016-10-25  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* include/line-map.h (line_maps::~line_maps): New dtor.\n+\t(location_adhoc_data_fini): Delete decl.\n+\t* line-map.c (line_maps::~line_maps): New dtor.\n+\t(location_adhoc_data_fini): Delete.\n+\n 2016-10-21  Andris Pavenis  <andris.pavenis@iki.fi>\n \n \tPR preprocessor/71681"}, {"sha": "b61c3cc0d2c669c76bee7d80213ba3960f89472a", "filename": "libcpp/include/line-map.h", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2be1b7965039fa6949225f36de3f0b3ad2673fad/libcpp%2Finclude%2Fline-map.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2be1b7965039fa6949225f36de3f0b3ad2673fad/libcpp%2Finclude%2Fline-map.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2Finclude%2Fline-map.h?ref=2be1b7965039fa6949225f36de3f0b3ad2673fad", "patch": "@@ -699,6 +699,8 @@ struct GTY(()) location_adhoc_data_map {\n \n /* A set of chronological line_map structures.  */\n struct GTY(()) line_maps {\n+\n+  ~line_maps ();\n   \n   maps_info_ordinary info_ordinary;\n \n@@ -977,7 +979,6 @@ LINEMAPS_LAST_ALLOCATED_MACRO_MAP (const line_maps *set)\n   return (line_map_macro *)LINEMAPS_LAST_ALLOCATED_MAP (set, true);\n }\n \n-extern void location_adhoc_data_fini (struct line_maps *);\n extern source_location get_combined_adhoc_loc (struct line_maps *,\n \t\t\t\t\t       source_location,\n \t\t\t\t\t       source_range,"}, {"sha": "c98ee45965a60010f99f6c65eaed594a8aa8e896", "filename": "libcpp/line-map.c", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2be1b7965039fa6949225f36de3f0b3ad2673fad/libcpp%2Fline-map.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2be1b7965039fa6949225f36de3f0b3ad2673fad/libcpp%2Fline-map.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libcpp%2Fline-map.c?ref=2be1b7965039fa6949225f36de3f0b3ad2673fad", "patch": "@@ -57,6 +57,14 @@ static source_location linemap_macro_loc_to_exp_point (struct line_maps *,\n extern unsigned num_expanded_macros_counter;\n extern unsigned num_macro_tokens_counter;\n \n+/* Destructor for class line_maps.\n+   Ensure non-GC-managed memory is released.  */\n+\n+line_maps::~line_maps ()\n+{\n+  htab_delete (location_adhoc_data_map.htab);\n+}\n+\n /* Hash function for location_adhoc_data hashtable.  */\n \n static hashval_t\n@@ -333,13 +341,6 @@ get_pure_location (line_maps *set, source_location loc)\n   return loc & ~((1 << ordmap->m_range_bits) - 1);\n }\n \n-/* Finalize the location_adhoc_data structure.  */\n-void\n-location_adhoc_data_fini (struct line_maps *set)\n-{\n-  htab_delete (set->location_adhoc_data_map.htab);\n-}\n-\n /* Initialize a line map set.  */\n \n void"}]}