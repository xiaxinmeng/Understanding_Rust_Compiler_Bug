{"sha": "d686cb0d740b0278fdbd7915f43faff14b203888", "node_id": "C_kwDOANBUbNoAKGQ2ODZjYjBkNzQwYjAyNzhmZGJkNzkxNWY0M2ZhZmYxNGIyMDM4ODg", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-11-19T13:26:07Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-11-19T13:26:07Z"}, "message": "libphobos: Don't call __gthread_key_delete in the emutls destroy function.\n\nFixes a EXC_BAD_ACCESS issue seen on Darwin when the libphobos DSO gets\nunloaded.  Based on reading libgcc's emutls implementation, as it\ndoesn't call __gthread_key_delete directly, neither should libphobos.\n\nlibphobos/ChangeLog:\n\n\t* libdruntime/gcc/emutls.d (emutlsDestroyThread): Don't remove entry\n\tfrom global array.\n\t(_d_emutls_destroy): Don't call __gthread_key_delete.", "tree": {"sha": "8f7615b8e9467f6d2d9e5b352f4f04e4602e2403", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8f7615b8e9467f6d2d9e5b352f4f04e4602e2403"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d686cb0d740b0278fdbd7915f43faff14b203888", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d686cb0d740b0278fdbd7915f43faff14b203888", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d686cb0d740b0278fdbd7915f43faff14b203888", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d686cb0d740b0278fdbd7915f43faff14b203888/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ea2954df43d4162af23a20c84f4c5485463977ac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ea2954df43d4162af23a20c84f4c5485463977ac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ea2954df43d4162af23a20c84f4c5485463977ac"}], "stats": {"total": 6, "additions": 0, "deletions": 6}, "files": [{"sha": "462230508ab21a1942afc9813f931f6fdc9cc7b5", "filename": "libphobos/libdruntime/gcc/emutls.d", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d686cb0d740b0278fdbd7915f43faff14b203888/libphobos%2Flibdruntime%2Fgcc%2Femutls.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d686cb0d740b0278fdbd7915f43faff14b203888/libphobos%2Flibdruntime%2Fgcc%2Femutls.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2Fgcc%2Femutls.d?ref=d686cb0d740b0278fdbd7915f43faff14b203888", "patch": "@@ -229,9 +229,6 @@ void** emutlsAlloc(shared __emutls_object* obj) nothrow @nogc\n extern (C) void emutlsDestroyThread(void* ptr) nothrow @nogc\n {\n     auto arr = cast(TlsArray*) ptr;\n-    emutlsMutex.lock_nothrow();\n-    emutlsArrays.remove(arr);\n-    emutlsMutex.unlock_nothrow();\n \n     foreach (entry; *arr)\n     {\n@@ -308,9 +305,6 @@ void _d_emutls_scan(scope void delegate(void* pbeg, void* pend) nothrow cb) noth\n // Call this after druntime has been unloaded\n void _d_emutls_destroy() nothrow @nogc\n {\n-    if (__gthread_key_delete(emutlsKey) != 0)\n-        abort();\n-\n     (cast(Mutex) _emutlsMutex.ptr).__dtor();\n     destroy(emutlsArrays);\n }"}]}