{"sha": "0397ac35755f5edc409010579811e9101f86ab2c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDM5N2FjMzU3NTVmNWVkYzQwOTAxMDU3OTgxMWU5MTAxZjg2YWIyYw==", "commit": {"author": {"name": "Richard Henderson", "email": "rth@redhat.com", "date": "2004-06-23T02:27:22Z"}, "committer": {"name": "Richard Henderson", "email": "rth@gcc.gnu.org", "date": "2004-06-23T02:27:22Z"}, "message": "i386.c (TARGET_STRUCT_VALUE_RTX): New.\n\n        * config/i386/i386.c (TARGET_STRUCT_VALUE_RTX): New.\n        (ix86_return_in_memory): Move SSE vector return warning ...\n        (ix86_struct_value_rtx): ... here.  New.\n\nFrom-SVN: r83533", "tree": {"sha": "be0cc8f8df5358e5dc66e7b90c6d8921ee0f2dee", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/be0cc8f8df5358e5dc66e7b90c6d8921ee0f2dee"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0397ac35755f5edc409010579811e9101f86ab2c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0397ac35755f5edc409010579811e9101f86ab2c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0397ac35755f5edc409010579811e9101f86ab2c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0397ac35755f5edc409010579811e9101f86ab2c/comments", "author": null, "committer": null, "parents": [{"sha": "2e5a151084e83d504acb5056d57f67cde737335b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5a151084e83d504acb5056d57f67cde737335b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2e5a151084e83d504acb5056d57f67cde737335b"}], "stats": {"total": 64, "additions": 43, "deletions": 21}, "files": [{"sha": "526a8ec00301d8bab466cd29f0f00a5ff9cc2480", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0397ac35755f5edc409010579811e9101f86ab2c/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0397ac35755f5edc409010579811e9101f86ab2c/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=0397ac35755f5edc409010579811e9101f86ab2c", "patch": "@@ -1,3 +1,9 @@\n+2004-06-22  Richard Henderson  <rth@redhat.com>\n+\n+\t* config/i386/i386.c (TARGET_STRUCT_VALUE_RTX): New.\n+\t(ix86_return_in_memory): Move SSE vector return warning ...\n+\t(ix86_struct_value_rtx): ... here.  New.\n+\n 2004-06-22  Richard Henderson  <rth@redhat.com>\n \n \t* tree.def (VTABLE_REF): Remove."}, {"sha": "fea329863fb7382dbc15724e9b33990aafd02da2", "filename": "gcc/config/i386/i386.c", "status": "modified", "additions": 37, "deletions": 21, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0397ac35755f5edc409010579811e9101f86ab2c/gcc%2Fconfig%2Fi386%2Fi386.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0397ac35755f5edc409010579811e9101f86ab2c/gcc%2Fconfig%2Fi386%2Fi386.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Fi386.c?ref=0397ac35755f5edc409010579811e9101f86ab2c", "patch": "@@ -922,6 +922,7 @@ static tree ix86_handle_cdecl_attribute (tree *, tree, tree, int, bool *);\n static tree ix86_handle_regparm_attribute (tree *, tree, tree, int, bool *);\n static int ix86_value_regno (enum machine_mode);\n static bool contains_128bit_aligned_vector_p (tree);\n+static rtx ix86_struct_value_rtx (tree, int);\n static bool ix86_ms_bitfield_layout_p (tree);\n static tree ix86_handle_struct_attribute (tree *, tree, tree, int, bool *);\n static int extended_reg_mentioned_1 (rtx *, void *);\n@@ -1068,7 +1069,8 @@ static void init_ext_80387_constants (void);\n \n #undef TARGET_PROMOTE_PROTOTYPES\n #define TARGET_PROMOTE_PROTOTYPES hook_bool_tree_true\n-\n+#undef TARGET_STRUCT_VALUE_RTX\n+#define TARGET_STRUCT_VALUE_RTX ix86_struct_value_rtx\n #undef TARGET_SETUP_INCOMING_VARARGS\n #define TARGET_SETUP_INCOMING_VARARGS ix86_setup_incoming_varargs\n \n@@ -2900,27 +2902,9 @@ ix86_return_in_memory (tree type)\n       if (size == 8)\n \treturn 1;\n \n-      /* SSE values are returned in XMM0.  */\n-      /* ??? Except when it doesn't exist?  We have a choice of\n-\t either (1) being abi incompatible with a -march switch,\n-\t or (2) generating an error here.  Given no good solution,\n-\t I think the safest thing is one warning.  The user won't\n-\t be able to use -Werror, but....  */\n+      /* SSE values are returned in XMM0, except when it doesn't exist.  */\n       if (size == 16)\n-\t{\n-\t  static bool warned;\n-\n-\t  if (TARGET_SSE)\n-\t    return 0;\n-\n-\t  if (!warned)\n-\t    {\n-\t      warned = true;\n-\t      warning (\"SSE vector return without SSE enabled \"\n-\t\t       \"changes the ABI\");\n-\t    }\n-\t  return 1;\n-\t}\n+\treturn (TARGET_SSE ? 0 : 1);\n     }\n \n   if (mode == XFmode)\n@@ -2931,6 +2915,38 @@ ix86_return_in_memory (tree type)\n   return 0;\n }\n \n+/* When returning SSE vector types, we have a choice of either\n+     (1) being abi incompatible with a -march switch, or\n+     (2) generating an error.\n+   Given no good solution, I think the safest thing is one warning.\n+   The user won't be able to use -Werror, but....\n+\n+   Choose the STRUCT_VALUE_RTX hook because that's (at present) only\n+   called in response to actually generating a caller or callee that\n+   uses such a type.  As opposed to RETURN_IN_MEMORY, which is called\n+   via aggregate_value_p for general type probing from tree-ssa.  */\n+\n+static rtx\n+ix86_struct_value_rtx (tree type, int incoming ATTRIBUTE_UNUSED)\n+{\n+  static bool warned;\n+\n+  if (!TARGET_SSE && type && !warned)\n+    {\n+      /* Look at the return type of the function, not the function type.  */\n+      enum machine_mode mode = TYPE_MODE (TREE_TYPE (type));\n+\n+      if (mode == TImode\n+\t  || (VECTOR_MODE_P (mode) && GET_MODE_SIZE (mode) == 16))\n+\t{\n+\t  warned = true;\n+\t  warning (\"SSE vector return without SSE enabled changes the ABI\");\n+\t}\n+    }\n+\n+  return NULL;\n+}\n+\n /* Define how to find the value returned by a library function\n    assuming the value has mode MODE.  */\n rtx"}]}