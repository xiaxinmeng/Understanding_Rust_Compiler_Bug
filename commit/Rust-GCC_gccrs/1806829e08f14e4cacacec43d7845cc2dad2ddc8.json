{"sha": "1806829e08f14e4cacacec43d7845cc2dad2ddc8", "node_id": "C_kwDOANBUbNoAKDE4MDY4MjllMDhmMTRlNGNhY2FjZWM0M2Q3ODQ1Y2MyZGFkMmRkYzg", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-03-26T07:11:58Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-03-26T07:11:58Z"}, "message": "c++: Fix up __builtin_{bit_cast,convertvector} parsing\n\nJonathan reported on IRC that we don't parse\n__builtin_bit_cast (type, val).field\netc.\nThe problem is that for these 2 builtins we return from\ncp_parser_postfix_expression instead of setting postfix_expression\nto the cp_build_* value and falling through into the postfix regression\nsuffix handling loop.\n\n2022-03-26  Jakub Jelinek  <jakub@redhat.com>\n\n\t* parser.cc (cp_parser_postfix_expression)\n\t<case RID_BILTIN_CONVERTVECTOR, case RID_BUILTIN_BIT_CAST>: Don't\n\treturn cp_build_{vec,convert,bit_cast} result right away, instead\n\tset postfix_expression to it and break.\n\n\t* c-c++-common/builtin-convertvector-3.c: New test.\n\t* g++.dg/cpp2a/bit-cast15.C: New test.", "tree": {"sha": "910f52f8dacb211d7f8c331db8f691ca1c9bff74", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/910f52f8dacb211d7f8c331db8f691ca1c9bff74"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1806829e08f14e4cacacec43d7845cc2dad2ddc8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1806829e08f14e4cacacec43d7845cc2dad2ddc8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1806829e08f14e4cacacec43d7845cc2dad2ddc8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1806829e08f14e4cacacec43d7845cc2dad2ddc8/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75d1c8fea9541dee5a4ce0aa7d8c199574fd42b9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/75d1c8fea9541dee5a4ce0aa7d8c199574fd42b9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/75d1c8fea9541dee5a4ce0aa7d8c199574fd42b9"}], "stats": {"total": 42, "additions": 38, "deletions": 4}, "files": [{"sha": "d3c22ee6227004863439c89baff00fbc03aa535f", "filename": "gcc/cp/parser.cc", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1806829e08f14e4cacacec43d7845cc2dad2ddc8/gcc%2Fcp%2Fparser.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1806829e08f14e4cacacec43d7845cc2dad2ddc8/gcc%2Fcp%2Fparser.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fparser.cc?ref=1806829e08f14e4cacacec43d7845cc2dad2ddc8", "patch": "@@ -7525,8 +7525,10 @@ cp_parser_postfix_expression (cp_parser *parser, bool address_p, bool cast_p,\n \t}\n \t/* Look for the closing `)'.  */\n \tparens.require_close (parser);\n-\treturn cp_build_vec_convert (expression, type_location, type,\n-\t\t\t\t     tf_warning_or_error);\n+\tpostfix_expression\n+\t  = cp_build_vec_convert (expression, type_location, type,\n+\t\t\t\t  tf_warning_or_error);\n+\tbreak;\n       }\n \n     case RID_BUILTIN_BIT_CAST:\n@@ -7551,8 +7553,10 @@ cp_parser_postfix_expression (cp_parser *parser, bool address_p, bool cast_p,\n \texpression = cp_parser_assignment_expression (parser);\n \t/* Look for the closing `)'.  */\n \tparens.require_close (parser);\n-\treturn cp_build_bit_cast (type_location, type, expression,\n-\t\t\t\t  tf_warning_or_error);\n+\tpostfix_expression\n+\t  = cp_build_bit_cast (type_location, type, expression,\n+\t\t\t       tf_warning_or_error);\n+\tbreak;\n       }\n \n     default:"}, {"sha": "882cd551ef82815ced09e4e052a87ecbdaf0f077", "filename": "gcc/testsuite/c-c++-common/builtin-convertvector-3.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1806829e08f14e4cacacec43d7845cc2dad2ddc8/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fbuiltin-convertvector-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1806829e08f14e4cacacec43d7845cc2dad2ddc8/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fbuiltin-convertvector-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fbuiltin-convertvector-3.c?ref=1806829e08f14e4cacacec43d7845cc2dad2ddc8", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2\" } */\n+\n+typedef int v4si __attribute__((vector_size (4 * sizeof (int))));\n+typedef double v4df __attribute__((vector_size (4 * sizeof (double))));\n+double\n+foo (void)\n+{\n+  v4si a = { 1, 2, 3, 4 };\n+  return __builtin_convertvector (a, v4df)[1];\n+}"}, {"sha": "5326af0503dd705cdc9a81cffb69328d6f527b2a", "filename": "gcc/testsuite/g++.dg/cpp2a/bit-cast15.C", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1806829e08f14e4cacacec43d7845cc2dad2ddc8/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fbit-cast15.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1806829e08f14e4cacacec43d7845cc2dad2ddc8/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fbit-cast15.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fbit-cast15.C?ref=1806829e08f14e4cacacec43d7845cc2dad2ddc8", "patch": "@@ -0,0 +1,19 @@\n+// { dg-do compile }\n+\n+struct S { short a, b; };\n+struct T { float a[4]; };\n+struct U { int b[4]; };\n+\n+#if __SIZEOF_FLOAT__ == __SIZEOF_INT__\n+int\n+f1 (T &x)\n+{\n+  return __builtin_bit_cast (U, x).b[1];\n+}\n+\n+float\n+f2 (int (&x)[4])\n+{\n+  return __builtin_bit_cast (T, x).a[2];\n+}\n+#endif"}]}