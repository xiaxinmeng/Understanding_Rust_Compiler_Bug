{"sha": "3943b161342a68ec90a7b977cf6a8e451671e25d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Mzk0M2IxNjEzNDJhNjhlYzkwYTdiOTc3Y2Y2YThlNDUxNjcxZTI1ZA==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@acm.org", "date": "2018-02-16T16:21:36Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2018-02-16T16:21:36Z"}, "message": "[C++ PATCH] Deprecate -ffriend-injection\n\nhttps://gcc.gnu.org/ml/gcc-patches/2018-02/msg00998.html\n\tDeprecate -ffriend-injection.\n\t* decl.c (cxx_init_decl_processing): Emit warning on option.\n\t* name-lookup.c (do_pushdecl): Emit warning if we push a visible\n\tfriend.\n\n\t* doc/extend.texi (Backwards Compatibility): Mention friend\n\tinjection.  Note for-scope is deprecated.\n\t* doc/invoke.texi (-ffriend-injection): Deprecate.\n\n\t* g++.old-deja/g++.jason/scoping15.C: Expect warnings.\n\t* g++.old-deja/g++.mike/net43.C: Likewise.\n\nFrom-SVN: r257742", "tree": {"sha": "282b1d1719ed513f3ba4f31dc34994199012094a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/282b1d1719ed513f3ba4f31dc34994199012094a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3943b161342a68ec90a7b977cf6a8e451671e25d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3943b161342a68ec90a7b977cf6a8e451671e25d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3943b161342a68ec90a7b977cf6a8e451671e25d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3943b161342a68ec90a7b977cf6a8e451671e25d/comments", "author": {"login": "urnathan", "id": 13103001, "node_id": "MDQ6VXNlcjEzMTAzMDAx", "avatar_url": "https://avatars.githubusercontent.com/u/13103001?v=4", "gravatar_id": "", "url": "https://api.github.com/users/urnathan", "html_url": "https://github.com/urnathan", "followers_url": "https://api.github.com/users/urnathan/followers", "following_url": "https://api.github.com/users/urnathan/following{/other_user}", "gists_url": "https://api.github.com/users/urnathan/gists{/gist_id}", "starred_url": "https://api.github.com/users/urnathan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/urnathan/subscriptions", "organizations_url": "https://api.github.com/users/urnathan/orgs", "repos_url": "https://api.github.com/users/urnathan/repos", "events_url": "https://api.github.com/users/urnathan/events{/privacy}", "received_events_url": "https://api.github.com/users/urnathan/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d65da12f2b93cea64a7122022208439cd282dfc2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d65da12f2b93cea64a7122022208439cd282dfc2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d65da12f2b93cea64a7122022208439cd282dfc2"}], "stats": {"total": 65, "additions": 55, "deletions": 10}, "files": [{"sha": "d3c06450004abb810d8b09db1847b517989680b8", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -1,3 +1,9 @@\n+2018-02-16  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* doc/extend.texi (Backwards Compatibility): Mention friend\n+\tinjection.  Note for-scope is deprecated.\n+\t* doc/invoke.texi (-ffriend-injection): Deprecate.\n+\n 2018-02-16  Segher Boessenkool  <segher@kernel.crashing.org>\n \n \t* combine.c (try_combine): When adjusting LOG_LINKS for the destination"}, {"sha": "ee08e689b4ea7e0d812e88d2b33ade0538507ae6", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -1,3 +1,10 @@\n+2018-02-16  Nathan Sidwell  <nathan@acm.org>\n+\n+\tDeprecate -ffriend-injection.\n+\t* decl.c (cxx_init_decl_processing): Emit warning on option.\n+\t* name-lookup.c (do_pushdecl): Emit warning if we push a visible\n+\tfriend.\n+\n 2018-02-16  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/82468"}, {"sha": "15f7f1224627df4a51e118e63cdc38d591ddcea2", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -4091,8 +4091,14 @@ cxx_init_decl_processing (void)\n   pop_namespace ();\n \n   flag_noexcept_type = (cxx_dialect >= cxx17);\n+  /* There's no fixed location for <command-line>, the current\n+     location is <builtins>, which is somewhat confusing.  */\n   if (!flag_new_for_scope)\n-    warning (OPT_Wdeprecated, \"%<-fno-for-scope%> is deprecated\");\n+    warning_at (UNKNOWN_LOCATION, OPT_Wdeprecated,\n+\t\t\"%<-fno-for-scope%> is deprecated\");\n+  if (flag_friend_injection)\n+    warning_at (UNKNOWN_LOCATION, OPT_Wdeprecated,\n+\t\t\"%<-ffriend-injection%> is deprecated\");\n \n   c_common_nodes_and_builtins ();\n "}, {"sha": "9117e0b30ebb46794317bce0b645cfce5795cce1", "filename": "gcc/cp/name-lookup.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fcp%2Fname-lookup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fcp%2Fname-lookup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fname-lookup.c?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -3071,6 +3071,7 @@ do_pushdecl (tree decl, bool is_friend)\n \told = OVL_CHAIN (old);\n \n       check_template_shadow (decl);\n+      bool visible_injection = false;\n \n       if (DECL_DECLARES_FUNCTION_P (decl))\n \t{\n@@ -3091,6 +3092,8 @@ do_pushdecl (tree decl, bool is_friend)\n \t      if (!flag_friend_injection)\n \t\t/* Hide it from ordinary lookup.  */\n \t\tDECL_ANTICIPATED (decl) = DECL_HIDDEN_FRIEND_P (decl) = true;\n+\t      else\n+\t\tvisible_injection = true;\n \t    }\n \t}\n \n@@ -3142,6 +3145,9 @@ do_pushdecl (tree decl, bool is_friend)\n \t}\n       else if (VAR_P (decl))\n \tmaybe_register_incomplete_var (decl);\n+      else if (visible_injection)\n+\twarning (0, \"injected friend %qD is visible\"\n+\t\t\" due to %<-ffriend-injection%>\", decl);\n \n       if ((VAR_P (decl) || TREE_CODE (decl) == FUNCTION_DECL)\n \t  && DECL_EXTERN_C_P (decl))"}, {"sha": "ee37eee4a5a56a783c463d3b84794f4fc7cdc771", "filename": "gcc/doc/extend.texi", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fdoc%2Fextend.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fdoc%2Fextend.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Fextend.texi?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -23881,11 +23881,23 @@ deprecated.   @xref{Deprecated Features}.\n \n @table @code\n @item For scope\n-If a variable is declared at for scope, it used to remain in scope until\n-the end of the scope that contained the for statement (rather than just\n-within the for scope).  G++ retains this, but issues a warning, if such a\n+If a variable is declared at for scope, it used to remain in scope\n+until the end of the scope that contained the for statement (rather\n+than just within the for scope).  The deprecated\n+@option{-fno-for-scope} option enables this non-standard behaviour.\n+Without the option, G++ retains this, but issues a warning, if such a\n variable is accessed outside the for scope.\n \n+The behaviour is deprecated, only available with @option{-std=c++98}\n+@option{-std=gnu++98} languages and you must use the\n+@option{-fpermissive} option to enable it.  The behaviour will be\n+removed.\n+\n+@item Friend Injection\n+The @option{-ffriend-injection} option makes injected friends visible\n+to regular name lookup, unlike standard C++.  This option is\n+deprecated and will be removed.\n+\n @item Implicit C language\n Old C system header files did not contain an @code{extern \"C\" @{@dots{}@}}\n scope to set the language.  On such systems, all header files are"}, {"sha": "277c99a0527b302fc8578b9ee9cbbf15f1a54b5b", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -2451,8 +2451,7 @@ However, in ISO C++ a friend function that is not declared\n in an enclosing scope can only be found using argument dependent\n lookup.  GCC defaults to the standard behavior.\n \n-This option is for compatibility, and may be removed in a future\n-release of G++.\n+This option is deprecated and will be removed.\n \n @item -fno-elide-constructors\n @opindex fno-elide-constructors"}, {"sha": "0bed6c3f09db5cc7d604cde8ecab8e1aafc699bd", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -1,3 +1,8 @@\n+2018-02-16  Nathan Sidwell  <nathan@acm.org>\n+\n+\t* g++.old-deja/g++.jason/scoping15.C: Expect warnings.\n+\t* g++.old-deja/g++.mike/net43.C: Likewise.\n+\n 2018-02-16  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/82468"}, {"sha": "69207e9334b22d1f87ddda9a04cd8d0022d3fdf0", "filename": "gcc/testsuite/g++.old-deja/g++.jason/scoping15.C", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.jason%2Fscoping15.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.jason%2Fscoping15.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.jason%2Fscoping15.C?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -3,14 +3,17 @@\n // Bug: g++ ignores the :: qualification and dies trying to treat an integer\n // variable as a list of functions.\n \n+class DComplex;\n+double imag (const DComplex&);\n+\n class DComplex {\n public:\n-  friend  double   imag(const DComplex& a);\n+  friend  double   imag(const DComplex& a); // Not injected, no warning\n };\n \n class FComplex {\n public:\n-  friend  float    imag(const FComplex& a);\n+  friend  float    imag(const FComplex& a); // { dg-warning \"is visible\"\n };\n \n void\n@@ -19,3 +22,4 @@ scnrm2(FComplex cx[])\n   int imag;\n   ::imag( cx[0] );\n }\n+// { dg-warning \"ffriend-injection.* is deprecated\" \"\" { target *-*-* } cc1plus: }"}, {"sha": "de266de4a8768cd85021cf2a4503bde5722f96b6", "filename": "gcc/testsuite/g++.old-deja/g++.mike/net43.C", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.mike%2Fnet43.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3943b161342a68ec90a7b977cf6a8e451671e25d/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.mike%2Fnet43.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.old-deja%2Fg%2B%2B.mike%2Fnet43.C?ref=3943b161342a68ec90a7b977cf6a8e451671e25d", "patch": "@@ -1,9 +1,9 @@\n // { dg-do assemble  }\n-// { dg-options \"-ffriend-injection\" }\n+// { dg-options \"-ffriend-injection -Wno-deprecated\" }\n \n class foo {\n  public:\n-   friend int operator ^(const foo&, const foo&);\n+  friend int operator ^(const foo&, const foo&); // { dg-message \"is visible\" }\n };\n \n int main ()"}]}