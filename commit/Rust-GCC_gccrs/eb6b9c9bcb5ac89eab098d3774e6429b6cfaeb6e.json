{"sha": "eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZWI2YjljOWJjYjVhYzg5ZWFiMDk4ZDM3NzRlNjQyOWI2Y2ZhZWI2ZQ==", "commit": {"author": {"name": "Gary Dismukes", "email": "dismukes@adacore.com", "date": "2019-08-19T08:36:30Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-08-19T08:36:30Z"}, "message": "[Ada] Improve warnings about \"too few elements\" and \"too many elements\"\n\nWhen warning about length-check failures detected at compile time that\nare flagged with \"too few elements\" or \"too many elements\", the compiler\nnow gives an additional message indicating the number of elements\nexpected by the context versus how many are present in the conflicting\nexpression (such as an aggregate that has too few or too many\ncomponents).\n\nThe test below reports the following warnings when compiled with this command:\n\n$ gcc -c -gnatj78 length_warnings.adb\n\nlength_warnings.adb:6:09: warning: too few elements for subtype of\n                          \"Boolean_Array\" defined at line 5, expected 10\n                          elements; found 9 elements, \"Constraint_Error\" will\n                          be raised at run time\nlength_warnings.adb:10:09: warning: too few elements for subtype of\n                           \"Boolean_Array\" defined at line 9, expected 2\n                           elements; found 1 element, \"Constraint_Error\" will\n                           be raised at run time\nlength_warnings.adb:14:09: warning: too many elements for subtype of\n                           \"Boolean_Array\" defined at line 13, expected 10\n                           elements; found 11 elements, \"Constraint_Error\"\n                           will be raised at run time\nlength_warnings.adb:18:09: warning: too many elements for subtype of\n                           \"Boolean_Array\" defined at line 17, expected 0\n                           elements; found 1 element, \"Constraint_Error\" will\n                           be raised at run time\nlength_warnings.adb:22:09: warning: too many elements for subtype of\n                           \"Boolean_Array\" defined at line 21, expected 1\n                           element; found 2 elements, \"Constraint_Error\" will\n                           be raised at run time\n\nprocedure Length_Check_Warnings is\n\n   type Boolean_Array is array (Natural range <>) of Boolean;\n\n   Bits_A : Boolean_Array (1 .. 10)\n     := (True, True, True, True, True, True, True, True, True);\n   -- Too few elements\n\n   Bits_B : Boolean_Array (1 .. 2)\n     := (1 => False);\n   -- Too few elements\n\n   Bits_C : Boolean_Array (1 .. 10)\n     := (True, True, True, True, True, True, True, True, True, True, True);\n   -- Too many elements\n\n   Bits_D : Boolean_Array (1 .. 0)\n     := (1 => True);\n   -- Too many elements\n\n   Bits_E : Boolean_Array (1 .. 1)\n     := (True, False);\n   -- Too many elements\n\nbegin\n   null;\nend Length_Check_Warnings;\n\n2019-08-19  Gary Dismukes  <dismukes@adacore.com>\n\ngcc/ada/\n\n\t* checks.adb (Length_Mismatch_Info_Message): New function in\n\tSelected_Length_Checks to return a message indicating the\n\telement counts for the mismatched lengths for a failed\n\tcompile-time length check.\n\t(Plural_Or_Singular_Ending): Support function in\n\tLength_Mismatch_Info_Message to return either \"\" or \"s\", for\n\tconcatenating to the end of words.\n\t(Selected_Length_Checks): Pass the result of\n\tLength_Mismatch_Info_Message as an extra warning message to\n\tCompile_Time_Constraint_Error to indicate the mismatched lengths\n\tfor a failed compile-time length check.\n\t* sem_util.ads (Compile_Time_Constraint_Error): Add an optional\n\tmessage formal (Extra_Msg), defaulted to the empty string.\n\t* sem_util.adb (Compile_Time_Constraint_Error): Output an extra\n\tmessage following the main warning message (when Extra_Msg is\n\tnot the empty string).\n\nFrom-SVN: r274652", "tree": {"sha": "d016a852efb003cea4d6f88e26f98a48140c724e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d016a852efb003cea4d6f88e26f98a48140c724e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/comments", "author": {"login": "dismukes", "id": 50880541, "node_id": "MDQ6VXNlcjUwODgwNTQx", "avatar_url": "https://avatars.githubusercontent.com/u/50880541?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dismukes", "html_url": "https://github.com/dismukes", "followers_url": "https://api.github.com/users/dismukes/followers", "following_url": "https://api.github.com/users/dismukes/following{/other_user}", "gists_url": "https://api.github.com/users/dismukes/gists{/gist_id}", "starred_url": "https://api.github.com/users/dismukes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dismukes/subscriptions", "organizations_url": "https://api.github.com/users/dismukes/orgs", "repos_url": "https://api.github.com/users/dismukes/repos", "events_url": "https://api.github.com/users/dismukes/events{/privacy}", "received_events_url": "https://api.github.com/users/dismukes/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "593e0eba77594774db054cd98b879fbe1ffa29cc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/593e0eba77594774db054cd98b879fbe1ffa29cc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/593e0eba77594774db054cd98b879fbe1ffa29cc"}], "stats": {"total": 94, "additions": 82, "deletions": 12}, "files": [{"sha": "6f31df16ac8b7705e0607486e5388eafbe75b5cc", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "patch": "@@ -1,3 +1,22 @@\n+2019-08-19  Gary Dismukes  <dismukes@adacore.com>\n+\n+\t* checks.adb (Length_Mismatch_Info_Message): New function in\n+\tSelected_Length_Checks to return a message indicating the\n+\telement counts for the mismatched lengths for a failed\n+\tcompile-time length check.\n+\t(Plural_Or_Singular_Ending): Support function in\n+\tLength_Mismatch_Info_Message to return either \"\" or \"s\", for\n+\tconcatenating to the end of words.\n+\t(Selected_Length_Checks): Pass the result of\n+\tLength_Mismatch_Info_Message as an extra warning message to\n+\tCompile_Time_Constraint_Error to indicate the mismatched lengths\n+\tfor a failed compile-time length check.\n+\t* sem_util.ads (Compile_Time_Constraint_Error): Add an optional\n+\tmessage formal (Extra_Msg), defaulted to the empty string.\n+\t* sem_util.adb (Compile_Time_Constraint_Error): Output an extra\n+\tmessage following the main warning message (when Extra_Msg is\n+\tnot the empty string).\n+\n 2019-08-19  Patrick Bernardi  <bernardi@adacore.com>\n \n \t* socket.c: Removed the redefinition of getaddrinfo, getnameinfo"}, {"sha": "03cfcef1a3880109f9e3a9c89435ea952182ac5e", "filename": "gcc/ada/checks.adb", "status": "modified", "additions": 42, "deletions": 2, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2Fchecks.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2Fchecks.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fchecks.adb?ref=eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "patch": "@@ -9542,6 +9542,12 @@ package body Checks is\n       --  Returns expression to compute:\n       --    Typ'Length /= Expr'Length\n \n+      function Length_Mismatch_Info_Message\n+        (Left_Element_Count  : Uint;\n+         Right_Element_Count : Uint) return String;\n+      --  Returns a message indicating how many elements were expected\n+      --  (Left_Element_Count) and how many were found (Right_Element_Count).\n+\n       ---------------\n       -- Add_Check --\n       ---------------\n@@ -9729,6 +9735,36 @@ package body Checks is\n              Right_Opnd => Get_N_Length (Expr, Indx));\n       end Length_N_Cond;\n \n+      ----------------------------------\n+      -- Length_Mismatch_Info_Message --\n+      ----------------------------------\n+\n+      function Length_Mismatch_Info_Message\n+        (Left_Element_Count  : Uint;\n+         Right_Element_Count : Uint) return String\n+      is\n+\n+         function Plural_Vs_Singular_Ending (Count : Uint) return String;\n+         --  Returns an empty string if Count is 1; otherwise returns \"s\"\n+\n+         function Plural_Vs_Singular_Ending (Count : Uint) return String is\n+         begin\n+            if Count = 1 then\n+               return \"\";\n+            else\n+               return \"s\";\n+            end if;\n+         end Plural_Vs_Singular_Ending;\n+\n+      begin\n+         return \"expected \" & UI_Image (Left_Element_Count)\n+                  & \" element\"\n+                  & Plural_Vs_Singular_Ending (Left_Element_Count)\n+                  & \"; found \" & UI_Image (Right_Element_Count)\n+                  & \" element\"\n+                  & Plural_Vs_Singular_Ending (Right_Element_Count);\n+      end Length_Mismatch_Info_Message;\n+\n       -----------------\n       -- Same_Bounds --\n       -----------------\n@@ -9923,12 +9959,16 @@ package body Checks is\n                            if L_Length > R_Length then\n                               Add_Check\n                                 (Compile_Time_Constraint_Error\n-                                  (Wnode, \"too few elements for}??\", T_Typ));\n+                                  (Wnode, \"too few elements for}??\", T_Typ,\n+                                   Extra_Msg => Length_Mismatch_Info_Message\n+                                                  (L_Length, R_Length)));\n \n                            elsif L_Length < R_Length then\n                               Add_Check\n                                 (Compile_Time_Constraint_Error\n-                                  (Wnode, \"too many elements for}??\", T_Typ));\n+                                  (Wnode, \"too many elements for}??\", T_Typ,\n+                                   Extra_Msg => Length_Mismatch_Info_Message\n+                                                  (L_Length, R_Length)));\n                            end if;\n \n                         --  The comparison for an individual index subtype"}, {"sha": "dcef852d975e427259284d2c1905f22f7fa04a29", "filename": "gcc/ada/sem_util.adb", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2Fsem_util.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2Fsem_util.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.adb?ref=eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "patch": "@@ -5358,11 +5358,12 @@ package body Sem_Util is\n    -----------------------------------\n \n    function Compile_Time_Constraint_Error\n-     (N    : Node_Id;\n-      Msg  : String;\n-      Ent  : Entity_Id  := Empty;\n-      Loc  : Source_Ptr := No_Location;\n-      Warn : Boolean    := False) return Node_Id\n+     (N         : Node_Id;\n+      Msg       : String;\n+      Ent       : Entity_Id  := Empty;\n+      Loc       : Source_Ptr := No_Location;\n+      Warn      : Boolean    := False;\n+      Extra_Msg : String     := \"\") return Node_Id\n    is\n       Msgc : String (1 .. Msg'Length + 3);\n       --  Copy of message, with room for possible ?? or << and ! at end\n@@ -5456,6 +5457,12 @@ package body Sem_Util is\n                Error_Msg_NEL (Msgc (1 .. Msgl), N, Etype (N), Eloc);\n             end if;\n \n+            --  Emit any extra message as a continuation\n+\n+            if Extra_Msg /= \"\" then\n+               Error_Msg_N ('\\' & Extra_Msg, N);\n+            end if;\n+\n             if Wmsg then\n \n                --  Check whether the context is an Init_Proc"}, {"sha": "4d738da1de6d8bd26d310a0781a8d7a30f8f1a07", "filename": "gcc/ada/sem_util.ads", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2Fsem_util.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e/gcc%2Fada%2Fsem_util.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.ads?ref=eb6b9c9bcb5ac89eab098d3774e6429b6cfaeb6e", "patch": "@@ -465,16 +465,20 @@ package Sem_Util is\n    --  the type itself.\n \n    function Compile_Time_Constraint_Error\n-     (N    : Node_Id;\n-      Msg  : String;\n-      Ent  : Entity_Id  := Empty;\n-      Loc  : Source_Ptr := No_Location;\n-      Warn : Boolean    := False) return Node_Id;\n+     (N         : Node_Id;\n+      Msg       : String;\n+      Ent       : Entity_Id  := Empty;\n+      Loc       : Source_Ptr := No_Location;\n+      Warn      : Boolean    := False;\n+      Extra_Msg : String     := \"\") return Node_Id;\n    --  This is similar to Apply_Compile_Time_Constraint_Error in that it\n    --  generates a warning (or error) message in the same manner, but it does\n    --  not replace any nodes. For convenience, the function always returns its\n    --  first argument. The message is a warning if the message ends with ?, or\n    --  we are operating in Ada 83 mode, or the Warn parameter is set to True.\n+   --  If Extra_Msg is not a null string, then it's associated with N and\n+   --  emitted immediately after the main message (and before output of any\n+   --  message indicating that Constraint_Error will be raised).\n \n    procedure Conditional_Delay (New_Ent, Old_Ent : Entity_Id);\n    --  Sets the Has_Delayed_Freeze flag of New_Ent if the Delayed_Freeze flag"}]}