{"sha": "f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjYxZTVkNGQ4YjZkNGNmYTk2ODYzMTg3ZmE2MWI4YzZiMDU3YTQ5MQ==", "commit": {"author": {"name": "Sandra Loosemore", "email": "sandra@codesourcery.com", "date": "2021-06-22T19:42:17Z"}, "committer": {"name": "Sandra Loosemore", "email": "sandra@codesourcery.com", "date": "2021-06-22T19:45:47Z"}, "message": "Fortran: fix sm computation in CFI_allocate [PR93524]\n\nThis patch fixes a bug in setting the step multiplier field in the\nC descriptor for array dimensions > 2.\n\n2021-06-21  Sandra Loosemore  <sandra@codesourcery.com>\n\t    Tobias Burnus  <tobias@codesourcery.com>\n\nlibgfortran/\n\tPR fortran/93524\n\t* runtime/ISO_Fortran_binding.c (CFI_allocate): Fix\n\tsm computation.\n\ngcc/testsuite/\n\tPR fortran/93524\n\t* gfortran.dg/pr93524.c: New.\n\t* gfortran.dg/pr93524.f90: New.", "tree": {"sha": "c72c4ba437b68586b2435717827e48bc7b8a317c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c72c4ba437b68586b2435717827e48bc7b8a317c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/comments", "author": {"login": "SandraLoosemore", "id": 104087111, "node_id": "U_kgDOBjQ-Rw", "avatar_url": "https://avatars.githubusercontent.com/u/104087111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SandraLoosemore", "html_url": "https://github.com/SandraLoosemore", "followers_url": "https://api.github.com/users/SandraLoosemore/followers", "following_url": "https://api.github.com/users/SandraLoosemore/following{/other_user}", "gists_url": "https://api.github.com/users/SandraLoosemore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SandraLoosemore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SandraLoosemore/subscriptions", "organizations_url": "https://api.github.com/users/SandraLoosemore/orgs", "repos_url": "https://api.github.com/users/SandraLoosemore/repos", "events_url": "https://api.github.com/users/SandraLoosemore/events{/privacy}", "received_events_url": "https://api.github.com/users/SandraLoosemore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SandraLoosemore", "id": 104087111, "node_id": "U_kgDOBjQ-Rw", "avatar_url": "https://avatars.githubusercontent.com/u/104087111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SandraLoosemore", "html_url": "https://github.com/SandraLoosemore", "followers_url": "https://api.github.com/users/SandraLoosemore/followers", "following_url": "https://api.github.com/users/SandraLoosemore/following{/other_user}", "gists_url": "https://api.github.com/users/SandraLoosemore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SandraLoosemore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SandraLoosemore/subscriptions", "organizations_url": "https://api.github.com/users/SandraLoosemore/orgs", "repos_url": "https://api.github.com/users/SandraLoosemore/repos", "events_url": "https://api.github.com/users/SandraLoosemore/events{/privacy}", "received_events_url": "https://api.github.com/users/SandraLoosemore/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e02840c1a92abecd211ffaf05b28329bcb534583", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e02840c1a92abecd211ffaf05b28329bcb534583", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e02840c1a92abecd211ffaf05b28329bcb534583"}], "stats": {"total": 55, "additions": 51, "deletions": 4}, "files": [{"sha": "24e5e094631f97fa75feeaddec60258719029b99", "filename": "gcc/testsuite/gfortran.dg/pr93524.c", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr93524.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr93524.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr93524.c?ref=f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "patch": "@@ -0,0 +1,33 @@\n+/* Test the fix for PR93524, in which CFI_allocate was computing\n+   sm incorrectly for dimensions > 2.  */\n+\n+#include <stdlib.h>  // For size_t\n+#include \"../../../libgfortran/ISO_Fortran_binding.h\"\n+\n+void my_fortran_sub_1 (CFI_cdesc_t *dv); \n+void my_fortran_sub_2 (CFI_cdesc_t *dv); \n+\n+int main ()\n+{\n+  CFI_CDESC_T (3) a;\n+  CFI_cdesc_t *dv = (CFI_cdesc_t *) &a;\n+  // dv, base_addr, attribute,            type, elem_len, rank, extents\n+  CFI_establish (dv, NULL, CFI_attribute_allocatable, CFI_type_float, 0, 3, NULL); \n+\n+  if (dv->base_addr != NULL)\n+    return 1;  // shall not be allocated\n+\n+  CFI_index_t lower_bounds[] = {-10, 0, 3}; \n+  CFI_index_t upper_bounds[] = {10, 5, 10}; \n+  size_t elem_len = 0;  // only needed for strings\n+  if (CFI_SUCCESS != CFI_allocate (dv, lower_bounds, upper_bounds, elem_len))\n+    return 2;\n+\n+  if (!CFI_is_contiguous (dv))\n+    return 2;  // allocatables shall be contiguous,unless a strided section is used\n+\n+  my_fortran_sub_1 (dv);\n+  my_fortran_sub_2 (dv);\n+  CFI_deallocate (dv);\n+  return 0;\n+}"}, {"sha": "0cebc8f24a8127f3b78e580611b34404ad3132f5", "filename": "gcc/testsuite/gfortran.dg/pr93524.f90", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr93524.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr93524.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr93524.f90?ref=f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "patch": "@@ -0,0 +1,17 @@\n+! { dg-additional-sources pr93524.c }\n+! { dg-do run }\n+!\n+! Test the fix for PR93524.  The main program is in pr93524.c.\n+\n+subroutine my_fortran_sub_1 (A) bind(C)\n+  real :: A(:, :, :)\n+  if (any (lbound(A) /= 1)) stop 1\n+  if (any (ubound(A) /= [21,6,8])) stop 2\n+  if (.not. is_contiguous (A)) stop 3\n+end\n+subroutine my_fortran_sub_2 (A) bind(C)\n+  real, ALLOCATABLE :: A(:, :, :)\n+  if (any (lbound(A) /= [-10,0,3])) stop 1\n+  if (any (ubound(A) /= [10,5,10])) stop 2\n+  if (.not. is_contiguous (A)) stop 3\n+end subroutine my_fortran_sub_2"}, {"sha": "09788321c9e6520f30f527ab58218a3e0b29214c", "filename": "libgfortran/runtime/ISO_Fortran_binding.c", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/libgfortran%2Fruntime%2FISO_Fortran_binding.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f61e5d4d8b6d4cfa96863187fa61b8c6b057a491/libgfortran%2Fruntime%2FISO_Fortran_binding.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fruntime%2FISO_Fortran_binding.c?ref=f61e5d4d8b6d4cfa96863187fa61b8c6b057a491", "patch": "@@ -254,10 +254,7 @@ CFI_allocate (CFI_cdesc_t *dv, const CFI_index_t lower_bounds[],\n \t{\n \t  dv->dim[i].lower_bound = lower_bounds[i];\n \t  dv->dim[i].extent = upper_bounds[i] - dv->dim[i].lower_bound + 1;\n-\t  if (i == 0)\n-\t    dv->dim[i].sm = dv->elem_len;\n-\t  else\n-\t    dv->dim[i].sm = dv->elem_len * dv->dim[i - 1].extent;\n+\t  dv->dim[i].sm = dv->elem_len * arr_len;\n \t  arr_len *= dv->dim[i].extent;\n         }\n     }"}]}