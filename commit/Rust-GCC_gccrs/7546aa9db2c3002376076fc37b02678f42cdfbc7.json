{"sha": "7546aa9db2c3002376076fc37b02678f42cdfbc7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzU0NmFhOWRiMmMzMDAyMzc2MDc2ZmMzN2IwMjY3OGY0MmNkZmJjNw==", "commit": {"author": {"name": "Richard Henderson", "email": "rth@redhat.com", "date": "2011-11-26T21:16:49Z"}, "committer": {"name": "Richard Henderson", "email": "rth@gcc.gnu.org", "date": "2011-11-26T21:16:49Z"}, "message": "crtstuff: adjust tm clones for no attribute hidden\n\n        * crtstuff.c (__TMC_LIST__): Mark used not unused.\n        (__TMC_END__): Only declare if hidden is available; in the definition,\n        if hidden is unavailable add a null record.\n        (deregister_tm_clones, register_tm_clones): New.\n        (__do_global_dtors_aux, frame_dummy): Use them.\n        (__do_global_dtors, __do_global_ctors_1): Likewise.\n\nFrom-SVN: r181744", "tree": {"sha": "02ea37e2e5f9a575226f09236d4eb72a053aeb89", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/02ea37e2e5f9a575226f09236d4eb72a053aeb89"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/7546aa9db2c3002376076fc37b02678f42cdfbc7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7546aa9db2c3002376076fc37b02678f42cdfbc7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7546aa9db2c3002376076fc37b02678f42cdfbc7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7546aa9db2c3002376076fc37b02678f42cdfbc7/comments", "author": null, "committer": null, "parents": [{"sha": "7e872b900f2c68ffa604f40cb43db717a744bbcc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7e872b900f2c68ffa604f40cb43db717a744bbcc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7e872b900f2c68ffa604f40cb43db717a744bbcc"}], "stats": {"total": 103, "additions": 65, "deletions": 38}, "files": [{"sha": "93c58707ce40c9c061e2d7949d8d4895e56d9f9e", "filename": "libgcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7546aa9db2c3002376076fc37b02678f42cdfbc7/libgcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7546aa9db2c3002376076fc37b02678f42cdfbc7/libgcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2FChangeLog?ref=7546aa9db2c3002376076fc37b02678f42cdfbc7", "patch": "@@ -1,3 +1,12 @@\n+2011-11-26  Richard Henderson  <rth@redhat.com>\n+\n+\t* crtstuff.c (__TMC_LIST__): Mark used not unused.\n+\t(__TMC_END__): Only declare if hidden is available; in the definition,\n+\tif hidden is unavailable add a null record.\n+\t(deregister_tm_clones, register_tm_clones): New.\n+\t(__do_global_dtors_aux, frame_dummy): Use them.\n+\t(__do_global_dtors, __do_global_ctors_1): Likewise.\n+\n 2011-11-22  Iain Sandoe  <iains@gcc.gnu.org>\n \n \t* config/darwin-crt-tm.c: New file."}, {"sha": "77b8d4201cdd4f0f29fe8fd57c9f30d49d3a7763", "filename": "libgcc/crtstuff.c", "status": "modified", "additions": 56, "deletions": 38, "changes": 94, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/7546aa9db2c3002376076fc37b02678f42cdfbc7/libgcc%2Fcrtstuff.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/7546aa9db2c3002376076fc37b02678f42cdfbc7/libgcc%2Fcrtstuff.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgcc%2Fcrtstuff.c?ref=7546aa9db2c3002376076fc37b02678f42cdfbc7", "patch": "@@ -252,9 +252,51 @@ STATIC void *__JCR_LIST__[]\n \n #if USE_TM_CLONE_REGISTRY\n STATIC func_ptr __TMC_LIST__[]\n-  __attribute__((unused, section(\".tm_clone_table\"), aligned(sizeof(void*))))\n+  __attribute__((used, section(\".tm_clone_table\"), aligned(sizeof(void*))))\n   = { };\n+# ifdef HAVE_GAS_HIDDEN\n extern func_ptr __TMC_END__[] __attribute__((__visibility__ (\"hidden\")));\n+# endif\n+\n+static inline void\n+deregister_tm_clones (void)\n+{\n+  void (*fn) (void *);\n+\n+#ifdef HAVE_GAS_HIDDEN\n+  if (__TMC_END__ - __TMC_LIST__ == 0)\n+    return;\n+#else\n+  if (__TMC_LIST__[0] == NULL)\n+    return;\n+#endif\n+\n+  fn = _ITM_deregisterTMCloneTable;\n+  __asm (\"\" : \"+r\" (fn));\n+  if (fn)\n+    fn (__TMC_LIST__);\n+}\n+\n+static inline void\n+register_tm_clones (void)\n+{\n+  void (*fn) (void *, size_t);\n+  size_t size;\n+\n+#ifdef HAVE_GAS_HIDDEN\n+  size = (__TMC_END__ - __TMC_LIST__) / 2;\n+#else\n+  for (size = 0; __TMC_LIST__[size * 2] != NULL; size++)\n+    continue;\n+#endif\n+  if (size == 0)\n+    return;\n+\n+  fn = _ITM_registerTMCloneTable;\n+  __asm (\"\" : \"+r\" (fn));\n+  if (fn)\n+    fn (__TMC_LIST__, size);\n+}\n #endif /* USE_TM_CLONE_REGISTRY */\n \n #if defined(INIT_SECTION_ASM_OP) || defined(INIT_ARRAY_SECTION_ASM_OP)\n@@ -347,13 +389,7 @@ __do_global_dtors_aux (void)\n #endif /* !defined(FINI_ARRAY_SECTION_ASM_OP) */\n \n #if USE_TM_CLONE_REGISTRY\n-  if (__TMC_END__ - __TMC_LIST__ > 0)\n-    {\n-      void (*deregister_clones) (void *) = _ITM_deregisterTMCloneTable;\n-      __asm (\"\" : \"+r\" (deregister_clones));\n-      if (deregister_clones)\n-\tderegister_clones (__TMC_LIST__);\n-    }\n+  deregister_tm_clones ();\n #endif /* USE_TM_CLONE_REGISTRY */\n \n #ifdef USE_EH_FRAME_REGISTRY\n@@ -422,16 +458,7 @@ frame_dummy (void)\n #endif /* JCR_SECTION_NAME */\n \n #if USE_TM_CLONE_REGISTRY\n-  if (__TMC_END__ - __TMC_LIST__ > 0)\n-    {\n-      void (*register_clones) (void *, size_t) = _ITM_registerTMCloneTable;\n-      __asm (\"\" : \"+r\" (register_clones));\n-      if (register_clones)\n-\t{\n-\t  size_t size = (size_t)(__TMC_END__ - __TMC_LIST__) / 2;\n-\t  _ITM_registerTMCloneTable (__TMC_LIST__, size);\n-\t}\n-    }\n+  register_tm_clones ();\n #endif /* USE_TM_CLONE_REGISTRY */\n }\n \n@@ -500,13 +527,7 @@ __do_global_dtors (void)\n     f ();\n \n #if USE_TM_CLONE_REGISTRY\n-  if (__TMC_END__ - __TMC_LIST__ > 0)\n-    {\n-      void (*deregister_clones) (void *) = _ITM_deregisterTMCloneTable;\n-      __asm (\"\" : \"+r\" (deregister_clones));\n-      if (deregister_clones)\n-\tderegister_clones (__TMC_LIST__);\n-    }\n+  deregister_tm_clones ();\n #endif /* USE_TM_CLONE_REGISTRY */\n \n #ifdef USE_EH_FRAME_REGISTRY\n@@ -542,16 +563,7 @@ __do_global_ctors_1(void)\n #endif\n \n #if USE_TM_CLONE_REGISTRY\n-  if (__TMC_END__ - __TMC_LIST__ > 0)\n-    {\n-      void (*register_clones) (void *, size_t) = _ITM_registerTMCloneTable;\n-      __asm (\"\" : \"+r\" (register_clones));\n-      if (register_clones)\n-\t{\n-\t  size_t size = (size_t)(__TMC_END__ - __TMC_LIST__) / 2;\n-\t  register_clones (__TMC_LIST__, size);\n-\t}\n-    }\n+  register_tm_clones ();\n #endif /* USE_TM_CLONE_REGISTRY */\n }\n #endif /* USE_EH_FRAME_REGISTRY || JCR_SECTION_NAME || USE_TM_CLONE_REGISTRY */\n@@ -639,10 +651,16 @@ STATIC void *__JCR_END__[1]\n #endif /* JCR_SECTION_NAME */\n \n #if USE_TM_CLONE_REGISTRY\n+# ifndef HAVE_GAS_HIDDEN\n+static\n+# endif\n func_ptr __TMC_END__[]\n-  __attribute__((unused, section(\".tm_clone_table\"), aligned(sizeof(void *)),\n-\t\t __visibility__ (\"hidden\")))\n-  = { };\n+  __attribute__((used, section(\".tm_clone_table\"), aligned(sizeof(void *))))\n+# ifdef HAVE_GAS_HIDDEN\n+  __attribute__((__visibility__ (\"hidden\"))) = { };\n+# else\n+  = { 0, 0 };\n+# endif\n #endif /* USE_TM_CLONE_REGISTRY */\n \n #ifdef INIT_ARRAY_SECTION_ASM_OP"}]}