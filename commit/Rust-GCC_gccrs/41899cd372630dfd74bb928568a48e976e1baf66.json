{"sha": "41899cd372630dfd74bb928568a48e976e1baf66", "node_id": "C_kwDOANBUbNoAKDQxODk5Y2QzNzI2MzBkZmQ3NGJiOTI4NTY4YTQ4ZTk3NmUxYmFmNjY", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2021-12-31T10:40:47Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-01-10T09:38:45Z"}, "message": "[Ada] Switch from __sync to __atomic builtins for Lock_Free_Try_Write\n\ngcc/ada/\n\n\t* libgnat/s-atopri.ads (Atomic_Compare_Exchange): Replaces\n\tdeprecated Sync_Compare_And_Swap.\n\t* libgnat/s-atopri.adb (Lock_Free_Try_Write): Switch from __sync\n\tto __atomic builtins.", "tree": {"sha": "14698bf61a790168f98f1e676209f292277cc2e1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/14698bf61a790168f98f1e676209f292277cc2e1"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/41899cd372630dfd74bb928568a48e976e1baf66", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/41899cd372630dfd74bb928568a48e976e1baf66", "html_url": "https://github.com/Rust-GCC/gccrs/commit/41899cd372630dfd74bb928568a48e976e1baf66", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/41899cd372630dfd74bb928568a48e976e1baf66/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "888fb69365c64ca5dbd4815d7451c35014d264b5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/888fb69365c64ca5dbd4815d7451c35014d264b5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/888fb69365c64ca5dbd4815d7451c35014d264b5"}], "stats": {"total": 34, "additions": 15, "deletions": 19}, "files": [{"sha": "976f49a5f7cf122bbc9c87939d3887b475824729", "filename": "gcc/ada/libgnat/s-atopri.adb", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/41899cd372630dfd74bb928568a48e976e1baf66/gcc%2Fada%2Flibgnat%2Fs-atopri.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/41899cd372630dfd74bb928568a48e976e1baf66/gcc%2Fada%2Flibgnat%2Fs-atopri.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-atopri.adb?ref=41899cd372630dfd74bb928568a48e976e1baf66", "patch": "@@ -55,23 +55,16 @@ package body System.Atomic_Primitives is\n        Expected : in out Atomic_Type;\n        Desired  : Atomic_Type) return Boolean\n    is\n-      function My_Sync_Compare_And_Swap is\n-        new Sync_Compare_And_Swap (Atomic_Type);\n-\n-      Actual : Atomic_Type;\n+      function My_Atomic_Compare_Exchange is\n+        new Atomic_Compare_Exchange (Atomic_Type);\n \n    begin\n       if Expected /= Desired then\n          if Atomic_Type'Atomic_Always_Lock_Free then\n-            Actual := My_Sync_Compare_And_Swap (Ptr, Expected, Desired);\n+            return My_Atomic_Compare_Exchange (Ptr, Expected'Address, Desired);\n          else\n             raise Program_Error;\n          end if;\n-\n-         if Actual /= Expected then\n-            Expected := Actual;\n-            return False;\n-         end if;\n       end if;\n \n       return True;"}, {"sha": "ca8ec11663000203b657386e3642cef5604d7e55", "filename": "gcc/ada/libgnat/s-atopri.ads", "status": "modified", "additions": 12, "deletions": 9, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/41899cd372630dfd74bb928568a48e976e1baf66/gcc%2Fada%2Flibgnat%2Fs-atopri.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/41899cd372630dfd74bb928568a48e976e1baf66/gcc%2Fada%2Flibgnat%2Fs-atopri.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-atopri.ads?ref=41899cd372630dfd74bb928568a48e976e1baf66", "patch": "@@ -80,17 +80,20 @@ package System.Atomic_Primitives is\n \n    generic\n       type Atomic_Type is mod <>;\n-   function Sync_Compare_And_Swap\n-     (Ptr      : Address;\n-      Expected : Atomic_Type;\n-      Desired  : Atomic_Type) return Atomic_Type;\n+   function Atomic_Compare_Exchange\n+     (Ptr           : Address;\n+      Expected      : Address;\n+      Desired       : Atomic_Type;\n+      Weak          : Boolean   := False;\n+      Success_Model : Mem_Model := Seq_Cst;\n+      Failure_Model : Mem_Model := Seq_Cst) return Boolean;\n    pragma Import\n-     (Intrinsic, Sync_Compare_And_Swap, \"__sync_val_compare_and_swap\");\n+     (Intrinsic, Atomic_Compare_Exchange, \"__atomic_compare_exchange_n\");\n \n-   function Sync_Compare_And_Swap_8  is new Sync_Compare_And_Swap (uint8);\n-   function Sync_Compare_And_Swap_16 is new Sync_Compare_And_Swap (uint16);\n-   function Sync_Compare_And_Swap_32 is new Sync_Compare_And_Swap (uint32);\n-   function Sync_Compare_And_Swap_64 is new Sync_Compare_And_Swap (uint64);\n+   function Atomic_Compare_Exchange_8  is new Atomic_Compare_Exchange (uint8);\n+   function Atomic_Compare_Exchange_16 is new Atomic_Compare_Exchange (uint16);\n+   function Atomic_Compare_Exchange_32 is new Atomic_Compare_Exchange (uint32);\n+   function Atomic_Compare_Exchange_64 is new Atomic_Compare_Exchange (uint64);\n \n    function Atomic_Test_And_Set\n      (Ptr   : System.Address;"}]}