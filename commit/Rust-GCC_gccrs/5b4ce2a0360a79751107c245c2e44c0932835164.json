{"sha": "5b4ce2a0360a79751107c245c2e44c0932835164", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWI0Y2UyYTAzNjBhNzk3NTExMDdjMjQ1YzJlNDRjMDkzMjgzNTE2NA==", "commit": {"author": {"name": "Hristian Kirtchev", "email": "kirtchev@adacore.com", "date": "2019-07-10T09:01:38Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-10T09:01:38Z"}, "message": "[Ada] Spurious error on case expression with limited result\n\nThis patch modifies the expansion of case expressions to prevent a\nspurious error caused by the use of assignment statements to capture the\nresult of the case expression when the associated type is limited.\n\n2019-07-10  Hristian Kirtchev  <kirtchev@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch4.adb (Expand_N_Case_Expression): Mark the generated\n\tassignments to the temporary result as being OK because the\n\texpansion of case expressions is correct by construction.\n\t(Is_Copy_Type): Update the predicate to match the comment\n\twithin.\n\ngcc/testsuite/\n\n\t* gnat.dg/limited2.adb, gnat.dg/limited2_pack_1.adb,\n\tgnat.dg/limited2_pack_1.ads, gnat.dg/limited2_pack_2.adb,\n\tgnat.dg/limited2_pack_2.ads: New testcase.\n\nFrom-SVN: r273336", "tree": {"sha": "a336c598eb7e8be8d55e2478f01b8aeea26a05f4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a336c598eb7e8be8d55e2478f01b8aeea26a05f4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5b4ce2a0360a79751107c245c2e44c0932835164", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5b4ce2a0360a79751107c245c2e44c0932835164", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5b4ce2a0360a79751107c245c2e44c0932835164", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5b4ce2a0360a79751107c245c2e44c0932835164/comments", "author": {"login": "kirtchev-adacore", "id": 60669983, "node_id": "MDQ6VXNlcjYwNjY5OTgz", "avatar_url": "https://avatars.githubusercontent.com/u/60669983?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kirtchev-adacore", "html_url": "https://github.com/kirtchev-adacore", "followers_url": "https://api.github.com/users/kirtchev-adacore/followers", "following_url": "https://api.github.com/users/kirtchev-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/kirtchev-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/kirtchev-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kirtchev-adacore/subscriptions", "organizations_url": "https://api.github.com/users/kirtchev-adacore/orgs", "repos_url": "https://api.github.com/users/kirtchev-adacore/repos", "events_url": "https://api.github.com/users/kirtchev-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/kirtchev-adacore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7f8c1cd3675b0e30817d98e52740b918b4e970b0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7f8c1cd3675b0e30817d98e52740b918b4e970b0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7f8c1cd3675b0e30817d98e52740b918b4e970b0"}], "stats": {"total": 70, "additions": 67, "deletions": 3}, "files": [{"sha": "adcb6a94c56e29e0e067d37afcc88bd019e88b25", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -1,3 +1,11 @@\n+2019-07-10  Hristian Kirtchev  <kirtchev@adacore.com>\n+\n+\t* exp_ch4.adb (Expand_N_Case_Expression): Mark the generated\n+\tassignments to the temporary result as being OK because the\n+\texpansion of case expressions is correct by construction.\n+\t(Is_Copy_Type): Update the predicate to match the comment\n+\twithin.\n+\n 2019-07-10  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* bindo-graphs.adb, bindo.adb, debug.adb, exp_ch6.adb,"}, {"sha": "f18632a55dbf4354370b9765b1563a44a0e32a59", "filename": "gcc/ada/exp_ch4.adb", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Fada%2Fexp_ch4.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Fada%2Fexp_ch4.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch4.adb?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -5087,7 +5087,6 @@ package body Exp_Ch4 is\n    ------------------------------\n \n    procedure Expand_N_Case_Expression (N : Node_Id) is\n-\n       function Is_Copy_Type (Typ : Entity_Id) return Boolean;\n       --  Return True if we can copy objects of this type when expanding a case\n       --  expression.\n@@ -5106,7 +5105,7 @@ package body Exp_Ch4 is\n              or else\n                (Minimize_Expression_With_Actions\n                  and then Is_Constrained (Underlying_Type (Typ))\n-                 and then not Is_Limited_View (Underlying_Type (Typ)));\n+                 and then not Is_Limited_Type (Underlying_Type (Typ)));\n       end Is_Copy_Type;\n \n       --  Local variables\n@@ -5283,6 +5282,7 @@ package body Exp_Ch4 is\n          declare\n             Alt_Expr : Node_Id             := Expression (Alt);\n             Alt_Loc  : constant Source_Ptr := Sloc (Alt_Expr);\n+            LHS      : Node_Id;\n             Stmts    : List_Id;\n \n          begin\n@@ -5312,9 +5312,12 @@ package body Exp_Ch4 is\n             --    Target := AX['Unrestricted_Access];\n \n             else\n+               LHS := New_Occurrence_Of (Target, Loc);\n+               Set_Assignment_OK (LHS);\n+\n                Stmts := New_List (\n                  Make_Assignment_Statement (Alt_Loc,\n-                   Name       => New_Occurrence_Of (Target, Loc),\n+                   Name       => LHS,\n                    Expression => Alt_Expr));\n             end if;\n "}, {"sha": "21c5e319c4ffc840310f8687c49130cd9264b67a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -1,3 +1,9 @@\n+2019-07-10  Hristian Kirtchev  <kirtchev@adacore.com>\n+\n+\t* gnat.dg/limited2.adb, gnat.dg/limited2_pack_1.adb,\n+\tgnat.dg/limited2_pack_1.ads, gnat.dg/limited2_pack_2.adb,\n+\tgnat.dg/limited2_pack_2.ads: New testcase.\n+\n 2019-07-10  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/equal8.adb, gnat.dg/equal8.ads,"}, {"sha": "e3b28ec601803794ea4b232dfdc115f581e806f3", "filename": "gcc/testsuite/gnat.dg/limited2.adb", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2.adb?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -0,0 +1,8 @@\n+--  { dg-do compile }\n+\n+with Limited2_Pack_2;\n+\n+procedure Limited2 is\n+begin\n+   Limited2_Pack_2.Create (P => Limited2_Pack_2.C1);\n+end Limited2;"}, {"sha": "1f6e616c911efe64a5359717d35eb3862e143b31", "filename": "gcc/testsuite/gnat.dg/limited2_pack_1.adb", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_1.adb?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -0,0 +1,5 @@\n+package body Limited2_Pack_1 is\n+   type B is record\n+      F : Integer := 0;\n+   end record;\n+end Limited2_Pack_1;"}, {"sha": "c7d0950d0ba8631729349c76091f80452b32491e", "filename": "gcc/testsuite/gnat.dg/limited2_pack_1.ads", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_1.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_1.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_1.ads?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -0,0 +1,8 @@\n+package Limited2_Pack_1 is\n+   type A is limited private;\n+   type A_Ptr is access all A;\n+\n+private\n+   type B;\n+   type A is access all B;\n+end Limited2_Pack_1;"}, {"sha": "2a4ddd1d25d9c49c22c12bdc5000a1a1445b60ae", "filename": "gcc/testsuite/gnat.dg/limited2_pack_2.adb", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_2.adb?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -0,0 +1,21 @@\n+with Limited2_Pack_1;\n+\n+package body Limited2_Pack_2 is\n+   Obj_1 : Limited2_Pack_1.A;\n+   Obj_2 : Limited2_Pack_1.A;\n+   Obj_3 : Limited2_Pack_1.A;\n+\n+   procedure M (R : Limited2_Pack_1.A) is\n+   begin\n+      null;\n+   end M;\n+\n+   procedure Create (P : in C) is\n+   begin\n+      M (R => Obj_1);\n+      M (R => (case P is\n+                 when C1 => Obj_1,\n+                 when C2 => Obj_2,\n+                 when C3 => Obj_3));\n+   end Create;\n+end Limited2_Pack_2;"}, {"sha": "efc1ab6591c8c51d0b1cc0ba65679ba5f962ff82", "filename": "gcc/testsuite/gnat.dg/limited2_pack_2.ads", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_2.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5b4ce2a0360a79751107c245c2e44c0932835164/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_2.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Flimited2_pack_2.ads?ref=5b4ce2a0360a79751107c245c2e44c0932835164", "patch": "@@ -0,0 +1,5 @@\n+package Limited2_Pack_2 is\n+   type C is (C1, C2, C3);\n+\n+   procedure Create (P : in C);\n+end Limited2_Pack_2;"}]}