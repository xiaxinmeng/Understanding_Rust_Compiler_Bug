{"sha": "dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "node_id": "C_kwDOANBUbNoAKGRjYzI2Njc5NmE2YWZhMThlZWJhMWVkZGU4MWY5ZWI3OGU2YzgzY2U", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2022-05-05T21:01:36Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2022-05-12T13:11:30Z"}, "message": "Refactor '-ldl' handling for libgomp proper and plugins\n\nInstead of implicit global 'LIBS=\"-ldl $LIBS\"' via 'AC_CHECK_LIB', make\n'-ldl' explicit for libgomp proper, and clean up 'PLUGIN_GCN_LIBS',\n'PLUGIN_NVPTX_LIBS' accordingly.\n\n\tlibgomp/\n\t* Makefile.am (libgomp_la_LIBADD): Initialize.\n\t* plugin/configfrag.ac (DL_LIBS): New.\n\t(PLUGIN_GCN_LIBS): Remove.\n\t(PLUGIN_NVPTX_LIBS): Don't set in the 'PLUGIN_NVPTX_DYNAMIC' case.\n\t* plugin/Makefrag.am (libgomp_la_LIBADD)\n\t(libgomp_plugin_gcn_la_LIBADD): Consider '$(DL_LIBS)'.\n\t(libgomp_plugin_nvptx_la_LIBADD) <PLUGIN_NVPTX_DYNAMIC>: Likewise.\n\t* Makefile.in: Regenerate.\n\t* config.h.in: Likewise.\n\t* configure: Likewise.\n\t* testsuite/Makefile.in: Likewise.", "tree": {"sha": "93a894b66a4082ec7fb879779c69ad565fa995e5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/93a894b66a4082ec7fb879779c69ad565fa995e5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dfda40f8147412328f699628a54b0aaa584776e7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dfda40f8147412328f699628a54b0aaa584776e7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dfda40f8147412328f699628a54b0aaa584776e7"}], "stats": {"total": 47, "additions": 19, "deletions": 28}, "files": [{"sha": "428f7a9dab55289cecd105cce82ca5d235620908", "filename": "libgomp/Makefile.am", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2FMakefile.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2FMakefile.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FMakefile.am?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -56,6 +56,7 @@ endif\n libgomp_version_info = -version-info $(libtool_VERSION)\n libgomp_la_LDFLAGS = $(libgomp_version_info) $(libgomp_version_script) \\\n         $(lt_host_flags)\n+libgomp_la_LIBADD =\n libgomp_la_DEPENDENCIES = $(libgomp_version_dep)\n libgomp_la_LINK = $(LINK) $(libgomp_la_LDFLAGS)\n "}, {"sha": "c47b6bd6153fa2ee9c675523403684742b1a9c24", "filename": "libgomp/Makefile.in", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FMakefile.in?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -125,7 +125,7 @@ target_triplet = @target@\n @PLUGIN_NVPTX_DYNAMIC_FALSE@@PLUGIN_NVPTX_TRUE@\t-DPLUGIN_NVPTX_LINK_LIBCUDA\n \n # 'dlopen'ing the CUDA Driver library vs. linking it.\n-@PLUGIN_NVPTX_DYNAMIC_TRUE@@PLUGIN_NVPTX_TRUE@am__append_3 = $(PLUGIN_NVPTX_LIBS)\n+@PLUGIN_NVPTX_DYNAMIC_TRUE@@PLUGIN_NVPTX_TRUE@am__append_3 = $(DL_LIBS)\n @PLUGIN_NVPTX_DYNAMIC_FALSE@@PLUGIN_NVPTX_TRUE@am__append_4 = $(PLUGIN_NVPTX_LIBS)\n @PLUGIN_GCN_TRUE@am__append_5 = libgomp-plugin-gcn.la\n @USE_FORTRAN_TRUE@am__append_6 = openacc.f90\n@@ -219,7 +219,6 @@ libgomp_plugin_nvptx_la_LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC \\\n \t$(libgomp_plugin_nvptx_la_LDFLAGS) $(LDFLAGS) -o $@\n @PLUGIN_NVPTX_TRUE@am_libgomp_plugin_nvptx_la_rpath = -rpath \\\n @PLUGIN_NVPTX_TRUE@\t$(toolexeclibdir)\n-libgomp_la_LIBADD =\n @USE_FORTRAN_TRUE@am__objects_1 = openacc.lo\n am_libgomp_la_OBJECTS = alloc.lo atomic.lo barrier.lo critical.lo \\\n \tenv.lo error.lo icv.lo icv-device.lo iter.lo iter_ull.lo \\\n@@ -384,6 +383,7 @@ CUDA_DRIVER_LIB = @CUDA_DRIVER_LIB@\n CYGPATH_W = @CYGPATH_W@\n DEFS = @DEFS@\n DEPDIR = @DEPDIR@\n+DL_LIBS = @DL_LIBS@\n DSYMUTIL = @DSYMUTIL@\n DUMPBIN = @DUMPBIN@\n ECHO_C = @ECHO_C@\n@@ -441,7 +441,6 @@ PACKAGE_URL = @PACKAGE_URL@\n PACKAGE_VERSION = @PACKAGE_VERSION@\n PATH_SEPARATOR = @PATH_SEPARATOR@\n PERL = @PERL@\n-PLUGIN_GCN_LIBS = @PLUGIN_GCN_LIBS@\n PLUGIN_NVPTX_CPPFLAGS = @PLUGIN_NVPTX_CPPFLAGS@\n PLUGIN_NVPTX_LDFLAGS = @PLUGIN_NVPTX_LDFLAGS@\n PLUGIN_NVPTX_LIBS = @PLUGIN_NVPTX_LIBS@\n@@ -553,6 +552,7 @@ libgomp_version_info = -version-info $(libtool_VERSION)\n libgomp_la_LDFLAGS = $(libgomp_version_info) $(libgomp_version_script) \\\n         $(lt_host_flags)\n \n+libgomp_la_LIBADD = $(DL_LIBS)\n libgomp_la_DEPENDENCIES = $(libgomp_version_dep)\n libgomp_la_LINK = $(LINK) $(libgomp_la_LDFLAGS)\n libgomp_la_SOURCES = alloc.c atomic.c barrier.c critical.c env.c \\\n@@ -586,7 +586,7 @@ libgomp_la_SOURCES = alloc.c atomic.c barrier.c critical.c env.c \\\n @PLUGIN_GCN_TRUE@libgomp_plugin_gcn_la_LDFLAGS = $(libgomp_plugin_gcn_version_info) \\\n @PLUGIN_GCN_TRUE@\t$(lt_host_flags)\n \n-@PLUGIN_GCN_TRUE@libgomp_plugin_gcn_la_LIBADD = libgomp.la $(PLUGIN_GCN_LIBS)\n+@PLUGIN_GCN_TRUE@libgomp_plugin_gcn_la_LIBADD = libgomp.la $(DL_LIBS)\n @PLUGIN_GCN_TRUE@libgomp_plugin_gcn_la_LIBTOOLFLAGS = --tag=disable-static\n nodist_noinst_HEADERS = libgomp_f.h\n nodist_libsubinclude_HEADERS = omp.h openacc.h acc_prof.h"}, {"sha": "46d3eac1e610a0986ca4d4de4f3b727ba09c4133", "filename": "libgomp/config.h.in", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fconfig.h.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fconfig.h.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fconfig.h.in?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -51,9 +51,6 @@\n /* Define to 1 if you have the <inttypes.h> header file. */\n #undef HAVE_INTTYPES_H\n \n-/* Define to 1 if you have the `dl' library (-ldl). */\n-#undef HAVE_LIBDL\n-\n /* Define to 1 if you have the `memalign' function. */\n #undef HAVE_MEMALIGN\n "}, {"sha": "66dface222e3528fa7eee36e0ab5dedec64e5d65", "filename": "libgomp/configure", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fconfigure", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fconfigure", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fconfigure?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -675,12 +675,12 @@ offload_additional_lib_paths\n offload_additional_options\n offload_targets\n offload_plugins\n-PLUGIN_GCN_LIBS\n PLUGIN_NVPTX_LIBS\n PLUGIN_NVPTX_LDFLAGS\n PLUGIN_NVPTX_CPPFLAGS\n CUDA_DRIVER_LIB\n CUDA_DRIVER_INCLUDE\n+DL_LIBS\n libtool_VERSION\n ac_ct_FC\n FCFLAGS\n@@ -15057,6 +15057,8 @@ _ACEOF\n # <http://www.gnu.org/licenses/>.\n \n plugin_support=yes\n+DL_LIBS=\n+\n { $as_echo \"$as_me:${as_lineno-$LINENO}: checking for dlsym in -ldl\" >&5\n $as_echo_n \"checking for dlsym in -ldl... \" >&6; }\n if ${ac_cv_lib_dl_dlsym+:} false; then :\n@@ -15094,12 +15096,7 @@ fi\n { $as_echo \"$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_dl_dlsym\" >&5\n $as_echo \"$ac_cv_lib_dl_dlsym\" >&6; }\n if test \"x$ac_cv_lib_dl_dlsym\" = xyes; then :\n-  cat >>confdefs.h <<_ACEOF\n-#define HAVE_LIBDL 1\n-_ACEOF\n-\n-  LIBS=\"-ldl $LIBS\"\n-\n+  DL_LIBS=-ldl\n else\n   plugin_support=no\n fi\n@@ -15221,8 +15218,6 @@ PLUGIN_NVPTX_DYNAMIC=0\n \n \n PLUGIN_GCN=0\n-PLUGIN_GCN_LIBS=\n-\n \n # Parse '--enable-offload-targets', figure out the corresponding libgomp\n # plugins, and configure to find the corresponding offload compilers.\n@@ -15295,7 +15290,6 @@ rm -f core conftest.err conftest.$ac_objext \\\n \t\t       && (test \"x$CUDA_DRIVER_LIB\" = x \\\n \t\t\t   || test \"x$CUDA_DRIVER_LIB\" = xno); then\n \t\t      PLUGIN_NVPTX=1\n-\t\t      PLUGIN_NVPTX_LIBS='-ldl'\n \t\t      PLUGIN_NVPTX_DYNAMIC=1\n \t\t    else\n \t\t      PLUGIN_NVPTX=0\n@@ -15321,8 +15315,6 @@ rm -f core conftest.err conftest.$ac_objext \\\n \t\t;;\n \t      *)\n \t\ttgt_plugin=gcn\n-\t\tPLUGIN_GCN=$tgt\n-\t\tPLUGIN_GCN_LIBS=\"-ldl\"\n \t\tPLUGIN_GCN=1\n \t\t;;\n \t      esac"}, {"sha": "3e453ff6fee569c8da909732e2bc80b7686323a0", "filename": "libgomp/plugin/Makefrag.am", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fplugin%2FMakefrag.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fplugin%2FMakefrag.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fplugin%2FMakefrag.am?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -26,6 +26,8 @@\n # see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n # <http://www.gnu.org/licenses/>.\n \n+libgomp_la_LIBADD += $(DL_LIBS)\n+\n if PLUGIN_NVPTX\n # Nvidia PTX OpenACC plugin.\n libgomp_plugin_nvptx_version_info = -version-info $(libtool_VERSION)\n@@ -46,7 +48,7 @@ endif\n \n # 'dlopen'ing the CUDA Driver library vs. linking it.\n if PLUGIN_NVPTX_DYNAMIC\n-libgomp_plugin_nvptx_la_LIBADD += $(PLUGIN_NVPTX_LIBS)\n+libgomp_plugin_nvptx_la_LIBADD += $(DL_LIBS)\n else\n libgomp_plugin_nvptx_la_CPPFLAGS += -DPLUGIN_NVPTX_LINK_LIBCUDA\n libgomp_plugin_nvptx_la_LIBADD += $(PLUGIN_NVPTX_LIBS)\n@@ -62,6 +64,8 @@ libgomp_plugin_gcn_la_CPPFLAGS = $(AM_CPPFLAGS) \\\n \t-D_GNU_SOURCE\n libgomp_plugin_gcn_la_LDFLAGS = $(libgomp_plugin_gcn_version_info) \\\n \t$(lt_host_flags)\n-libgomp_plugin_gcn_la_LIBADD = libgomp.la $(PLUGIN_GCN_LIBS)\n+libgomp_plugin_gcn_la_LIBADD = libgomp.la\n libgomp_plugin_gcn_la_LIBTOOLFLAGS = --tag=disable-static\n+\n+libgomp_plugin_gcn_la_LIBADD += $(DL_LIBS)\n endif"}, {"sha": "14203048bdb4b39b8a54734903309b462b94fde8", "filename": "libgomp/plugin/configfrag.ac", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fplugin%2Fconfigfrag.ac", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Fplugin%2Fconfigfrag.ac", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fplugin%2Fconfigfrag.ac?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -27,7 +27,9 @@\n # <http://www.gnu.org/licenses/>.\n \n plugin_support=yes\n-AC_CHECK_LIB(dl, dlsym, , [plugin_support=no])\n+DL_LIBS=\n+AC_SUBST(DL_LIBS)\n+AC_CHECK_LIB(dl, dlsym, [DL_LIBS=-ldl], [plugin_support=no])\n if test x\"$plugin_support\" = xyes; then\n   AC_DEFINE(PLUGIN_SUPPORT, 1,\n     [Define if all infrastructure, needed for plugins, is supported.])\n@@ -91,8 +93,6 @@ AC_SUBST(PLUGIN_NVPTX_LDFLAGS)\n AC_SUBST(PLUGIN_NVPTX_LIBS)\n \n PLUGIN_GCN=0\n-PLUGIN_GCN_LIBS=\n-AC_SUBST(PLUGIN_GCN_LIBS)\n \n # Parse '--enable-offload-targets', figure out the corresponding libgomp\n # plugins, and configure to find the corresponding offload compilers.\n@@ -154,7 +154,6 @@ if test x\"$enable_offload_targets\" != x; then\n \t\t       && (test \"x$CUDA_DRIVER_LIB\" = x \\\n \t\t\t   || test \"x$CUDA_DRIVER_LIB\" = xno); then\n \t\t      PLUGIN_NVPTX=1\n-\t\t      PLUGIN_NVPTX_LIBS='-ldl'\n \t\t      PLUGIN_NVPTX_DYNAMIC=1\n \t\t    else\n \t\t      PLUGIN_NVPTX=0\n@@ -180,8 +179,6 @@ if test x\"$enable_offload_targets\" != x; then\n \t\t;;\n \t      *)\n \t\ttgt_plugin=gcn\n-\t\tPLUGIN_GCN=$tgt\n-\t\tPLUGIN_GCN_LIBS=\"-ldl\"\n \t\tPLUGIN_GCN=1\n \t\t;;\n \t      esac"}, {"sha": "048844f0a408d2025c8aac63c0bdb1cda10a873c", "filename": "libgomp/testsuite/Makefile.in", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Ftestsuite%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dcc266796a6afa18eeba1edde81f9eb78e6c83ce/libgomp%2Ftestsuite%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2FMakefile.in?ref=dcc266796a6afa18eeba1edde81f9eb78e6c83ce", "patch": "@@ -152,6 +152,7 @@ CUDA_DRIVER_LIB = @CUDA_DRIVER_LIB@\n CYGPATH_W = @CYGPATH_W@\n DEFS = @DEFS@\n DEPDIR = @DEPDIR@\n+DL_LIBS = @DL_LIBS@\n DSYMUTIL = @DSYMUTIL@\n DUMPBIN = @DUMPBIN@\n ECHO_C = @ECHO_C@\n@@ -209,7 +210,6 @@ PACKAGE_URL = @PACKAGE_URL@\n PACKAGE_VERSION = @PACKAGE_VERSION@\n PATH_SEPARATOR = @PATH_SEPARATOR@\n PERL = @PERL@\n-PLUGIN_GCN_LIBS = @PLUGIN_GCN_LIBS@\n PLUGIN_NVPTX_CPPFLAGS = @PLUGIN_NVPTX_CPPFLAGS@\n PLUGIN_NVPTX_LDFLAGS = @PLUGIN_NVPTX_LDFLAGS@\n PLUGIN_NVPTX_LIBS = @PLUGIN_NVPTX_LIBS@"}]}