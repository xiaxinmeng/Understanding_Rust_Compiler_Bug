{"sha": "36330e2e95564a360e6dbcfb4e7566d5c2177415", "node_id": "C_kwDOANBUbNoAKDM2MzMwZTJlOTU1NjRhMzYwZTZkYmNmYjRlNzU2NmQ1YzIxNzc0MTU", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2023-03-27T14:40:15Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2023-03-29T06:55:34Z"}, "message": "ipa/106124 - ICE with -fkeep-inline-functions and OpenMP\n\nThe testcases in this bug reveal cases where an early generated\ntype is collected because it was unused but gets attempted to\nbe recreated later when a late DIE for a function (an OpenMP\nreduction) is created.  That's unexpected and possibly the fault\nof OpenMP but the following allows the re-creation of the context\ntype to succeed.\n\n\tPR ipa/106124\n\t* dwarf2out.cc (lookup_type_die): Reset TREE_ASM_WRITTEN\n\tso we can re-create the DIE for the type if required.\n\n\t* g++.dg/gomp/pr106124.C: New testcase.", "tree": {"sha": "16ab86a32bcbaf57fecd3210554bfdf3e8577fef", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/16ab86a32bcbaf57fecd3210554bfdf3e8577fef"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/36330e2e95564a360e6dbcfb4e7566d5c2177415", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/36330e2e95564a360e6dbcfb4e7566d5c2177415", "html_url": "https://github.com/Rust-GCC/gccrs/commit/36330e2e95564a360e6dbcfb4e7566d5c2177415", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/36330e2e95564a360e6dbcfb4e7566d5c2177415/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8dd57939c20b5e218404a838f514429f8e414dea", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8dd57939c20b5e218404a838f514429f8e414dea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8dd57939c20b5e218404a838f514429f8e414dea"}], "stats": {"total": 20, "additions": 20, "deletions": 0}, "files": [{"sha": "1a0015ce00ffbdf3f0ebed7044ec23e049d3d035", "filename": "gcc/dwarf2out.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/36330e2e95564a360e6dbcfb4e7566d5c2177415/gcc%2Fdwarf2out.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/36330e2e95564a360e6dbcfb4e7566d5c2177415/gcc%2Fdwarf2out.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdwarf2out.cc?ref=36330e2e95564a360e6dbcfb4e7566d5c2177415", "patch": "@@ -5894,6 +5894,7 @@ lookup_type_die (tree type)\n   if (die && die->removed)\n     {\n       TYPE_SYMTAB_DIE (type) = NULL;\n+      TREE_ASM_WRITTEN (type) = 0;\n       return NULL;\n     }\n   return die;"}, {"sha": "3129749804bff07dc0b7f24c7c206f876af00a97", "filename": "gcc/testsuite/g++.dg/gomp/pr106124.C", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/36330e2e95564a360e6dbcfb4e7566d5c2177415/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr106124.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/36330e2e95564a360e6dbcfb4e7566d5c2177415/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr106124.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fgomp%2Fpr106124.C?ref=36330e2e95564a360e6dbcfb4e7566d5c2177415", "patch": "@@ -0,0 +1,19 @@\n+// { dg-do compile }\n+// { dg-require-effective-target c++11 }\n+// { dg-options \"-g -O2 -fopenmp -fkeep-inline-functions\" }\n+\n+int q;\n+struct A\n+{\n+  typedef int T;\n+#pragma omp declare reduction (x : T : omp_out += omp_in + [] (){ return q; }()) initializer (omp_priv = [](){ return 0; }())\n+  static void foo ();\n+};\n+void bar (int &, int &);\n+void\n+A::foo ()\n+{\n+  int r = 0, s = 0;\n+#pragma omp parallel reduction (x : r, s)\n+  bar (r, s);\n+}"}]}