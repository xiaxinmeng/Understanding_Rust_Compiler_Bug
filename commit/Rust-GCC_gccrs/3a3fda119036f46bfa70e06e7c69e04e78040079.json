{"sha": "3a3fda119036f46bfa70e06e7c69e04e78040079", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2EzZmRhMTE5MDM2ZjQ2YmZhNzBlMDZlN2M2OWUwNGU3ODA0MDA3OQ==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-08-03T20:35:38Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-08-04T08:25:22Z"}, "message": "d: Fix PR96429: Pointer subtraction uses TRUNC_DIV_EXPR\n\ngcc/d/ChangeLog:\n\n\tPR d/96429\n\t* expr.cc (ExprVisitor::visit (BinExp*)): Use EXACT_DIV_EXPR for\n\tpointer diff expressions.\n\ngcc/testsuite/ChangeLog:\n\n\tPR d/96429\n\t* gdc.dg/pr96429.d: New test.", "tree": {"sha": "cc8009d15548d8e188c44e54d0d0ce100e0d0ddc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cc8009d15548d8e188c44e54d0d0ce100e0d0ddc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3a3fda119036f46bfa70e06e7c69e04e78040079", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a3fda119036f46bfa70e06e7c69e04e78040079", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3a3fda119036f46bfa70e06e7c69e04e78040079", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3a3fda119036f46bfa70e06e7c69e04e78040079/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "863de9321813f947018cc60b06ba163ddcfbb5f2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/863de9321813f947018cc60b06ba163ddcfbb5f2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/863de9321813f947018cc60b06ba163ddcfbb5f2"}], "stats": {"total": 38, "additions": 38, "deletions": 0}, "files": [{"sha": "ac3d4aaa1717c72b53217d7ec6c6425bd85599f3", "filename": "gcc/d/expr.cc", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a3fda119036f46bfa70e06e7c69e04e78040079/gcc%2Fd%2Fexpr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a3fda119036f46bfa70e06e7c69e04e78040079/gcc%2Fd%2Fexpr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fexpr.cc?ref=3a3fda119036f46bfa70e06e7c69e04e78040079", "patch": "@@ -620,6 +620,18 @@ class ExprVisitor : public Visitor\n \tbreak;\n \n       case TOKdiv:\n+\t/* Determine if the div expression is a lowered pointer diff operation.\n+\t   The front-end rewrites `(p1 - p2)' into `(p1 - p2) / stride'.  */\n+\tif (MinExp *me = e->e1->isMinExp ())\n+\t  {\n+\t    if (me->e1->type->ty == Tpointer && me->e2->type->ty == Tpointer\n+\t\t&& e->e2->op == TOKint64)\n+\t      {\n+\t\tcode = EXACT_DIV_EXPR;\n+\t\tbreak;\n+\t      }\n+\t  }\n+\n \tcode = e->e1->type->isintegral ()\n \t  ? TRUNC_DIV_EXPR : RDIV_EXPR;\n \tbreak;"}, {"sha": "af096e26b5afed0a335d721ac51075f7a2fd2630", "filename": "gcc/testsuite/gdc.dg/pr96429.d", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3a3fda119036f46bfa70e06e7c69e04e78040079/gcc%2Ftestsuite%2Fgdc.dg%2Fpr96429.d", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3a3fda119036f46bfa70e06e7c69e04e78040079/gcc%2Ftestsuite%2Fgdc.dg%2Fpr96429.d", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgdc.dg%2Fpr96429.d?ref=3a3fda119036f46bfa70e06e7c69e04e78040079", "patch": "@@ -0,0 +1,26 @@\n+// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=96429\n+// { dg-do compile }\n+// { dg-options \"-fdump-tree-original\" }\n+ptrdiff_t subbyte(byte* bp1, byte* bp2)\n+{\n+    // { dg-final { scan-tree-dump \"bp1 - bp2;\" \"original\" } }\n+    return bp1 - bp2;\n+}\n+\n+ptrdiff_t subshort(short* sp1, short* sp2)\n+{\n+    // { dg-final { scan-tree-dump \"\\\\\\(sp1 - sp2\\\\\\) /\\\\\\[ex\\\\\\] 2;\" \"original\" } }\n+    return sp1 - sp2;\n+}\n+\n+ptrdiff_t subint(int* ip1, int* ip2)\n+{\n+    // { dg-final { scan-tree-dump \"\\\\\\(ip1 - ip2\\\\\\) /\\\\\\[ex\\\\\\] 4;\" \"original\" } }\n+    return ip1 - ip2;\n+}\n+\n+ptrdiff_t sublong(long* lp1, long* lp2)\n+{\n+    // { dg-final { scan-tree-dump \"\\\\\\(lp1 - lp2\\\\\\) /\\\\\\[ex\\\\\\] 8;\" \"original\" } }\n+    return lp1 - lp2;\n+}"}]}