{"sha": "90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTBjOGQ5NzEzMGY5ZTNkNGZmZTJhMGMyNmJiYzFiNTExMjRjZDIzOA==", "commit": {"author": {"name": "Alan Modra", "email": "amodra@gmail.com", "date": "2016-02-02T00:01:16Z"}, "committer": {"name": "Alan Modra", "email": "amodra@gcc.gnu.org", "date": "2016-02-02T00:01:16Z"}, "message": "[RS6000] ABI_V4 init of toc section\n\nSince 4c4a180d lto has turned off flag_pic when linking a fixed\nposition executable.  So flag_pic is zero in rs6000_file_start.\nHowever, when we get to actually emitting code, flag_pic may be on\nagain.  This results in undefined references to \".LCTOC1\".\n\n\tPR target/68662\n\t* config/rs6000/rs6000.c (need_toc_init): New var, set it\n\twhenever toc_label_name used.\n\t(rs6000_file_start): Don't set up toc section here,\n\t(rs6000_output_function_epilogue): do so here instead,\n\t(rs6000_xcoff_file_start): and here.\n\t* config/rs6000/rs6000.md (load_toc_aix_si): Set need_toc_init.\n\t(load_toc_aix_di): Likewise.\n\nFrom-SVN: r233061", "tree": {"sha": "7b160fbbcebddbd11d9eae06696812fc688db6e0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7b160fbbcebddbd11d9eae06696812fc688db6e0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "html_url": "https://github.com/Rust-GCC/gccrs/commit/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/comments", "author": {"login": "amodra", "id": 6006325, "node_id": "MDQ6VXNlcjYwMDYzMjU=", "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amodra", "html_url": "https://github.com/amodra", "followers_url": "https://api.github.com/users/amodra/followers", "following_url": "https://api.github.com/users/amodra/following{/other_user}", "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}", "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amodra/subscriptions", "organizations_url": "https://api.github.com/users/amodra/orgs", "repos_url": "https://api.github.com/users/amodra/repos", "events_url": "https://api.github.com/users/amodra/events{/privacy}", "received_events_url": "https://api.github.com/users/amodra/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d0268b37f87359ebf5d6f8bd95fe9829b520749a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d0268b37f87359ebf5d6f8bd95fe9829b520749a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d0268b37f87359ebf5d6f8bd95fe9829b520749a"}], "stats": {"total": 45, "additions": 36, "deletions": 9}, "files": [{"sha": "1d89607433b99c10d23c374863ffa7ed66fe5ee4", "filename": "gcc/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "patch": "@@ -1,3 +1,14 @@\n+2016-02-02  Alan Modra  <amodra@gmail.com>\n+\n+\tPR target/68662\n+\t* config/rs6000/rs6000.c (need_toc_init): New var, set it\n+\twhenever toc_label_name used.\n+\t(rs6000_file_start): Don't set up toc section here,\n+\t(rs6000_output_function_epilogue): do so here instead,\n+\t(rs6000_xcoff_file_start): and here.\n+\t* config/rs6000/rs6000.md (load_toc_aix_si): Set need_toc_init.\n+\t(load_toc_aix_di): Likewise.\n+\n 2016-02-01  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR rtl-optimization/69592"}, {"sha": "e840a2c2d662d24a08c723630a3e533402ad275f", "filename": "gcc/config/rs6000/rs6000.c", "status": "modified", "additions": 21, "deletions": 9, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/gcc%2Fconfig%2Frs6000%2Frs6000.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/gcc%2Fconfig%2Frs6000%2Frs6000.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.c?ref=90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "patch": "@@ -209,7 +209,7 @@ tree rs6000_builtin_types[RS6000_BTI_MAX];\n tree rs6000_builtin_decls[RS6000_BUILTIN_COUNT];\n \n /* Flag to say the TOC is initialized */\n-int toc_initialized;\n+int toc_initialized, need_toc_init;\n char toc_label_name[10];\n \n /* Cached value of rs6000_variable_issue. This is cached in\n@@ -5681,13 +5681,6 @@ rs6000_file_start (void)\n \n   if (DEFAULT_ABI == ABI_ELFv2)\n     fprintf (file, \"\\t.abiversion 2\\n\");\n-\n-  if (DEFAULT_ABI == ABI_AIX || DEFAULT_ABI == ABI_ELFv2\n-      || (TARGET_ELF && flag_pic == 2))\n-    {\n-      switch_to_section (toc_section);\n-      switch_to_section (text_section);\n-    }\n }\n \n \f\n@@ -20363,6 +20356,7 @@ rs6000_output_addr_const_extra (FILE *file, rtx x)\n \t  {\n \t    putc ('-', file);\n \t    assemble_name (file, toc_label_name);\n+\t    need_toc_init = 1;\n \t  }\n \telse if (TARGET_ELF)\n \t  fputs (\"@toc\", file);\n@@ -23991,7 +23985,10 @@ rs6000_emit_load_toc_table (int fromprolog)\n       ASM_GENERATE_INTERNAL_LABEL (buf, \"L\", CODE_LABEL_NUMBER (lab));\n       lab = gen_rtx_SYMBOL_REF (Pmode, ggc_strdup (buf));\n       if (flag_pic == 2)\n-\tgot = gen_rtx_SYMBOL_REF (Pmode, ggc_strdup (toc_label_name));\n+\t{\n+\t  got = gen_rtx_SYMBOL_REF (Pmode, ggc_strdup (toc_label_name));\n+\t  need_toc_init = 1;\n+\t}\n       else\n \tgot = rs6000_got_sym ();\n       tmp1 = tmp2 = dest;\n@@ -24036,6 +24033,7 @@ rs6000_emit_load_toc_table (int fromprolog)\n \t  rtx tocsym, lab;\n \n \t  tocsym = gen_rtx_SYMBOL_REF (Pmode, ggc_strdup (toc_label_name));\n+\t  need_toc_init = 1;\n \t  lab = gen_label_rtx ();\n \t  emit_insn (gen_load_toc_v4_PIC_1b (tocsym, lab));\n \t  emit_move_insn (dest, gen_rtx_REG (Pmode, LR_REGNO));\n@@ -24050,6 +24048,7 @@ rs6000_emit_load_toc_table (int fromprolog)\n       /* This is for AIX code running in non-PIC ELF32.  */\n       rtx realsym = gen_rtx_SYMBOL_REF (Pmode, ggc_strdup (toc_label_name));\n \n+      need_toc_init = 1;\n       emit_insn (gen_elf_high (dest, realsym));\n       emit_insn (gen_elf_low (dest, dest, realsym));\n     }\n@@ -27586,6 +27585,17 @@ rs6000_output_function_epilogue (FILE *file,\n \n       fputs (\"\\t.align 2\\n\", file);\n     }\n+\n+  /* Arrange to define .LCTOC1 label, if not already done.  */\n+  if (need_toc_init)\n+    {\n+      need_toc_init = 0;\n+      if (!toc_initialized)\n+\t{\n+\t  switch_to_section (toc_section);\n+\t  switch_to_section (current_function_section ());\n+\t}\n+    }\n }\n \n /* -fsplit-stack support.  */\n@@ -31733,6 +31743,7 @@ rs6000_elf_declare_function_name (FILE *file, const char *name, tree decl)\n \n       fprintf (file, \"\\t.long \");\n       assemble_name (file, toc_label_name);\n+      need_toc_init = 1;\n       putc ('-', file);\n       ASM_GENERATE_INTERNAL_LABEL (buf, \"LCF\", rs6000_pic_labelno);\n       assemble_name (file, buf);\n@@ -32125,6 +32136,7 @@ rs6000_xcoff_file_start (void)\n   fputc ('\\n', asm_out_file);\n   if (write_symbols != NO_DEBUG)\n     switch_to_section (private_data_section);\n+  switch_to_section (toc_section);\n   switch_to_section (text_section);\n   if (profile_flag)\n     fprintf (asm_out_file, \"\\t.extern %s\\n\", RS6000_MCOUNT);"}, {"sha": "cc2f1bd65a7234f36eb39a21396b6bade07ffd59", "filename": "gcc/config/rs6000/rs6000.md", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/gcc%2Fconfig%2Frs6000%2Frs6000.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238/gcc%2Fconfig%2Frs6000%2Frs6000.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000.md?ref=90c8d97130f9e3d4ffe2a0c26bbc1b51124cd238", "patch": "@@ -9475,6 +9475,8 @@\n   \"*\n {\n   char buf[30];\n+  extern int need_toc_init;\n+  need_toc_init = 1;\n   ASM_GENERATE_INTERNAL_LABEL (buf, \\\"LCTOC\\\", 1);\n   operands[1] = gen_rtx_SYMBOL_REF (Pmode, ggc_strdup (buf));\n   operands[2] = gen_rtx_REG (Pmode, 2);\n@@ -9492,6 +9494,8 @@\n   \"*\n {\n   char buf[30];\n+  extern int need_toc_init;\n+  need_toc_init = 1;\n #ifdef TARGET_RELOCATABLE\n   ASM_GENERATE_INTERNAL_LABEL (buf, \\\"LCTOC\\\",\n \t\t\t       !TARGET_MINIMAL_TOC || TARGET_RELOCATABLE);"}]}