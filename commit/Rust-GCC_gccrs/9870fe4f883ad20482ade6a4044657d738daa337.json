{"sha": "9870fe4f883ad20482ade6a4044657d738daa337", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTg3MGZlNGY4ODNhZDIwNDgyYWRlNmE0MDQ0NjU3ZDczOGRhYTMzNw==", "commit": {"author": {"name": "Rafael Avila de Espindola", "email": "espindola@google.com", "date": "2009-11-17T16:00:19Z"}, "committer": {"name": "Rafael Espindola", "email": "espindola@gcc.gnu.org", "date": "2009-11-17T16:00:19Z"}, "message": "lto-elf.c (lto_file_init): Add offset argument.\n\n2009-11-17  Rafael Avila de Espindola  <espindola@google.com>\n\n\t* lto-elf.c (lto_file_init): Add offset argument.\n\t(lto_elf_file_open): Record the offset.\n\t* lto.c (lto_resolution_read): Change file_name into a lto_file\n\targument. Check offsets.\n\t(lto_file_read): Update call to lto_resolution_read.\n\t* lto.h (lto_file_struct): Add the offset field.\n\nFrom-SVN: r154251", "tree": {"sha": "c38a89384c9700e550405c672c972476d186d9a3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c38a89384c9700e550405c672c972476d186d9a3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9870fe4f883ad20482ade6a4044657d738daa337", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9870fe4f883ad20482ade6a4044657d738daa337", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9870fe4f883ad20482ade6a4044657d738daa337", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9870fe4f883ad20482ade6a4044657d738daa337/comments", "author": null, "committer": null, "parents": [{"sha": "6ca19a974b25008e1e9e9c68c34a904b1b12fb4d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6ca19a974b25008e1e9e9c68c34a904b1b12fb4d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6ca19a974b25008e1e9e9c68c34a904b1b12fb4d"}], "stats": {"total": 48, "additions": 38, "deletions": 10}, "files": [{"sha": "54dabf2cc8a5758fa906aed903370be91e5d9932", "filename": "gcc/lto/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2FChangeLog?ref=9870fe4f883ad20482ade6a4044657d738daa337", "patch": "@@ -1,3 +1,12 @@\n+2009-11-17  Rafael Avila de Espindola  <espindola@google.com>\n+\n+\t* lto-elf.c (lto_file_init): Add offset argument.\n+\t(lto_elf_file_open): Record the offset.\n+\t* lto.c (lto_resolution_read): Change file_name into a lto_file\n+\targument. Check offsets.\n+\t(lto_file_read): Update call to lto_resolution_read.\n+\t* lto.h (lto_file_struct): Add the offset field.\n+\n 2009-11-16  Rafael Avila de Espindola  <espindola@google.com>\n \n \t* lto-elf.c (lto_elf_file_open): Use strtoll to parse the offset."}, {"sha": "368d8d4d75fc7ddb5af0d6fc259d688fb3f54a17", "filename": "gcc/lto/lto-elf.c", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2Flto-elf.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2Flto-elf.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto-elf.c?ref=9870fe4f883ad20482ade6a4044657d738daa337", "patch": "@@ -32,9 +32,10 @@ along with GCC; see the file COPYING3.  If not see\n \n /* Initialize FILE, an LTO file object for FILENAME.  */\n static void\n-lto_file_init (lto_file *file, const char *filename)\n+lto_file_init (lto_file *file, const char *filename, off_t offset)\n {\n   file->filename = filename;\n+  file->offset = offset;\n }\n \n /* An ELF file.  */\n@@ -542,6 +543,7 @@ lto_elf_file_open (const char *filename, bool writable)\n   lto_elf_file *elf_file;\n   lto_file *result = NULL;\n   off_t offset;\n+  off_t header_offset;\n   const char *offset_p;\n   char *fname;\n \n@@ -550,6 +552,7 @@ lto_elf_file_open (const char *filename, bool writable)\n     {\n       fname = xstrdup (filename);\n       offset = 0;\n+      header_offset = 0;\n     }\n   else\n     {\n@@ -567,13 +570,13 @@ lto_elf_file_open (const char *filename, bool writable)\n       /* elf_rand expects the offset to point to the ar header, not the\n          object itself. Subtract the size of the ar header (60 bytes).\n          We don't uses sizeof (struct ar_hd) to avoid including ar.h */\n-      offset -= 60;\n+      header_offset = offset - 60;\n     }\n \n   /* Set up.  */\n   elf_file = XCNEW (lto_elf_file);\n   result = (lto_file *) elf_file;\n-  lto_file_init (result, fname);\n+  lto_file_init (result, fname, offset);\n   elf_file->fd = -1;\n \n   /* Open the file.  */\n@@ -603,8 +606,8 @@ lto_elf_file_open (const char *filename, bool writable)\n   if (offset != 0)\n     {\n       Elf *e;\n-      off_t t = elf_rand (elf_file->elf, offset);\n-      if (t != offset)\n+      off_t t = elf_rand (elf_file->elf, header_offset);\n+      if (t != header_offset)\n         {\n           error (\"could not seek in archive\");\n           goto fail;"}, {"sha": "9cb7d65a60bc8eccb8ab3d392a10c8ebd5eee114", "filename": "gcc/lto/lto.c", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2Flto.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2Flto.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto.c?ref=9870fe4f883ad20482ade6a4044657d738daa337", "patch": "@@ -254,7 +254,7 @@ lto_read_decls (struct lto_file_decl_data *decl_data, const void *data,\n    size is written to SIZE. */\n \n static VEC(ld_plugin_symbol_resolution_t,heap) *\n-lto_resolution_read (FILE *resolution, const char *file_name)\n+lto_resolution_read (FILE *resolution, lto_file *file)\n {\n   /* We require that objects in the resolution file are in the same\n      order as the lto1 command line. */\n@@ -268,15 +268,30 @@ lto_resolution_read (FILE *resolution, const char *file_name)\n   if (!resolution)\n     return NULL;\n \n-  name_len = strlen (file_name);\n+  name_len = strlen (file->filename);\n   obj_name = XNEWVEC (char, name_len + 1);\n   fscanf (resolution, \" \");   /* Read white space. */\n \n   fread (obj_name, sizeof (char), name_len, resolution);\n   obj_name[name_len] = '\\0';\n-  if (strcmp (obj_name, file_name) != 0)\n+  if (strcmp (obj_name, file->filename) != 0)\n     internal_error (\"unexpected file name %s in linker resolution file. \"\n-\t\t    \"Expected %s\", obj_name, file_name);\n+\t\t    \"Expected %s\", obj_name, file->filename);\n+  if (file->offset != 0)\n+    {\n+      int t;\n+      char offset_p[21];\n+      long long offset;\n+      t = fscanf (resolution, \"@%20s\", offset_p);\n+      if (t != 1)\n+        internal_error (\"could not parse file offset\");\n+      errno = 0;\n+      offset = strtoll(offset_p, NULL, 10);\n+      if (errno != 0)\n+        internal_error (\"could not parse file offset\");\n+      if (offset != file->offset)\n+        internal_error (\"unexpected offset\");\n+    }\n \n   free (obj_name);\n \n@@ -332,7 +347,7 @@ lto_file_read (lto_file *file, FILE *resolution_file)\n   size_t len;\n   VEC(ld_plugin_symbol_resolution_t,heap) *resolutions;\n   \n-  resolutions = lto_resolution_read (resolution_file, file->filename);\n+  resolutions = lto_resolution_read (resolution_file, file);\n \n   file_data = XCNEW (struct lto_file_decl_data);\n   file_data->file_name = file->filename;"}, {"sha": "3b92b41e9a38f618d93aa9a10d950922d0e7b61b", "filename": "gcc/lto/lto.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2Flto.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9870fe4f883ad20482ade6a4044657d738daa337/gcc%2Flto%2Flto.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto.h?ref=9870fe4f883ad20482ade6a4044657d738daa337", "patch": "@@ -28,6 +28,7 @@ typedef struct lto_file_struct\n {\n   /* The name of the file.  */\n   const char *filename;\n+  off_t offset;\n } lto_file;\n \n /* In lto-lang.c  */"}]}