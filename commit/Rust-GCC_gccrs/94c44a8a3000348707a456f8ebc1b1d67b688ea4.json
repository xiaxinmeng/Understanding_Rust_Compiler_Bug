{"sha": "94c44a8a3000348707a456f8ebc1b1d67b688ea4", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTRjNDRhOGEzMDAwMzQ4NzA3YTQ1NmY4ZWJjMWIxZDY3YjY4OGVhNA==", "commit": {"author": {"name": "Vadim Godunko", "email": "godunko@adacore.com", "date": "2019-09-17T08:01:48Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-09-17T08:01:48Z"}, "message": "[Ada] Close file descriptors allocated for tty only once\n\n2019-09-17  Vadim Godunko  <godunko@adacore.com>\n\ngcc/ada/\n\n\t* libgnat/g-exptty.ads (Close_Input): New subprogram.\n\t* libgnat/g-exptty.adb (Close_Input): New subprogram.\n\t(Close): Move close of TTY to Close_Input.\n\t* terminals.c (__gnat_close_tty): Set file descriptors to\n\tinvalid value after close.\n\nFrom-SVN: r275783", "tree": {"sha": "6ea3745bc0beb963fc8ed9f6826320b35b2629cc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6ea3745bc0beb963fc8ed9f6826320b35b2629cc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/94c44a8a3000348707a456f8ebc1b1d67b688ea4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94c44a8a3000348707a456f8ebc1b1d67b688ea4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94c44a8a3000348707a456f8ebc1b1d67b688ea4", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94c44a8a3000348707a456f8ebc1b1d67b688ea4/comments", "author": {"login": "godunko", "id": 23206960, "node_id": "MDQ6VXNlcjIzMjA2OTYw", "avatar_url": "https://avatars.githubusercontent.com/u/23206960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/godunko", "html_url": "https://github.com/godunko", "followers_url": "https://api.github.com/users/godunko/followers", "following_url": "https://api.github.com/users/godunko/following{/other_user}", "gists_url": "https://api.github.com/users/godunko/gists{/gist_id}", "starred_url": "https://api.github.com/users/godunko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/godunko/subscriptions", "organizations_url": "https://api.github.com/users/godunko/orgs", "repos_url": "https://api.github.com/users/godunko/repos", "events_url": "https://api.github.com/users/godunko/events{/privacy}", "received_events_url": "https://api.github.com/users/godunko/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "19716ceb1676e1a947527b3ae1d59dce646dd76c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/19716ceb1676e1a947527b3ae1d59dce646dd76c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/19716ceb1676e1a947527b3ae1d59dce646dd76c"}], "stats": {"total": 62, "additions": 53, "deletions": 9}, "files": [{"sha": "1ef2c628201e1a5ac8667de2af8025440d63971e", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=94c44a8a3000348707a456f8ebc1b1d67b688ea4", "patch": "@@ -1,3 +1,11 @@\n+2019-09-17  Vadim Godunko  <godunko@adacore.com>\n+\n+\t* libgnat/g-exptty.ads (Close_Input): New subprogram.\n+\t* libgnat/g-exptty.adb (Close_Input): New subprogram.\n+\t(Close): Move close of TTY to Close_Input.\n+\t* terminals.c (__gnat_close_tty): Set file descriptors to\n+\tinvalid value after close.\n+\n 2019-09-17  Vadim Godunko  <godunko@adacore.com>\n \n \t* libgnat/g-expect.adb (Expect_Internal): Try to call 'poll' few"}, {"sha": "b193448a0d0e6fa8ac607591a77fcffdb164a3ae", "filename": "gcc/ada/libgnat/g-exptty.adb", "status": "modified", "additions": 41, "deletions": 7, "changes": 48, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2Flibgnat%2Fg-exptty.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2Flibgnat%2Fg-exptty.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-exptty.adb?ref=94c44a8a3000348707a456f8ebc1b1d67b688ea4", "patch": "@@ -74,9 +74,6 @@ package body GNAT.Expect.TTY is\n       procedure Free_Process (Process : System.Address);\n       pragma Import (C, Free_Process, \"__gnat_free_process\");\n \n-      procedure Close_TTY (Process : System.Address);\n-      pragma Import (C, Close_TTY, \"__gnat_close_tty\");\n-\n    begin\n       --  If we haven't already closed the process\n \n@@ -123,10 +120,6 @@ package body GNAT.Expect.TTY is\n             Status := Descriptor.Exit_Status;\n          end if;\n \n-         if not On_Windows then\n-            Close_TTY (Descriptor.Process);\n-         end if;\n-\n          Free_Process (Descriptor.Process'Address);\n          Descriptor.Process := System.Null_Address;\n \n@@ -141,6 +134,47 @@ package body GNAT.Expect.TTY is\n       Close (Descriptor, Status);\n    end Close;\n \n+   -----------------\n+   -- Close_Input --\n+   -----------------\n+\n+   overriding procedure Close_Input\n+     (Descriptor : in out TTY_Process_Descriptor)\n+   is\n+      function TTY_FD\n+        (Handle : System.Address) return GNAT.OS_Lib.File_Descriptor;\n+      pragma Import (C, TTY_FD, \"__gnat_tty_fd\");\n+\n+      procedure Close_TTY (Process : System.Address);\n+      pragma Import (C, Close_TTY, \"__gnat_close_tty\");\n+\n+   begin\n+      if not On_Windows and then Descriptor.Process /= System.Null_Address then\n+         --  Check whether input/output/error streams use master descriptor and\n+         --  reset corresponding members.\n+\n+         if Descriptor.Input_Fd = TTY_FD (Descriptor.Process) then\n+            Descriptor.Input_Fd := Invalid_FD;\n+         end if;\n+\n+         if Descriptor.Output_Fd = TTY_FD (Descriptor.Process) then\n+            Descriptor.Output_Fd := Invalid_FD;\n+         end if;\n+\n+         if Descriptor.Error_Fd = TTY_FD (Descriptor.Process) then\n+            Descriptor.Error_Fd := Invalid_FD;\n+         end if;\n+\n+         --  Close master descriptor.\n+\n+         Close_TTY (Descriptor.Process);\n+      end if;\n+\n+      --  Call parent's implementation to close all remaining descriptors.\n+\n+      Process_Descriptor (Descriptor).Close_Input;\n+   end Close_Input;\n+\n    -----------------------------\n    -- Close_Pseudo_Descriptor --\n    -----------------------------"}, {"sha": "81068a69ed74baaee6d236a9d6a9494982d8da6c", "filename": "gcc/ada/libgnat/g-exptty.ads", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2Flibgnat%2Fg-exptty.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2Flibgnat%2Fg-exptty.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fg-exptty.ads?ref=94c44a8a3000348707a456f8ebc1b1d67b688ea4", "patch": "@@ -134,6 +134,8 @@ private\n       Cmd   : String;\n       Args  : System.Address);\n \n+   procedure Close_Input (Descriptor : in out TTY_Process_Descriptor);\n+\n    Still_Active : constant Integer := -1;\n \n    type TTY_Process_Descriptor is new Process_Descriptor with record"}, {"sha": "0ce3fb788f983bb61a4528b93908b035cbd0e39d", "filename": "gcc/ada/terminals.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2Fterminals.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94c44a8a3000348707a456f8ebc1b1d67b688ea4/gcc%2Fada%2Fterminals.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fterminals.c?ref=94c44a8a3000348707a456f8ebc1b1d67b688ea4", "patch": "@@ -1648,8 +1648,8 @@ __gnat_new_tty (void)\n  */\n void __gnat_close_tty (pty_desc* desc)\n {\n-  if (desc->master_fd >= 0) close (desc->master_fd);\n-  if (desc->slave_fd  >= 0) close (desc->slave_fd);\n+  if (desc->master_fd >= 0) { close (desc->master_fd); desc->master_fd = -1; }\n+  if (desc->slave_fd  >= 0) { close (desc->slave_fd);  desc->slave_fd  = -1; }\n }\n \n /* __gnat_tty_name - return slave side device name"}]}