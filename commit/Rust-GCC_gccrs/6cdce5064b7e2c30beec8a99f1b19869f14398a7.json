{"sha": "6cdce5064b7e2c30beec8a99f1b19869f14398a7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmNkY2U1MDY0YjdlMmMzMGJlZWM4YTk5ZjFiMTk4NjlmMTQzOThhNw==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2018-07-31T09:56:21Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-07-31T09:56:21Z"}, "message": "[Ada] Spurious error on default parameter in protected operation\n\nThis patch fixes a spurious compiler error on a call to a protected\noperation whose profile includes a defaulted in-parameter that is a call\nto another protected function of the same object.\n\n2018-07-31  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch6.adb (Expand_Protected_Subprogram_Call): Handle\n\tproperly a protected call that includes a default parameter that\n\tis a call to a protected function of the same type.\n\ngcc/testsuite/\n\n\t* gnat.dg/prot5.adb, gnat.dg/prot5_pkg.adb,\n\tgnat.dg/prot5_pkg.ads: New testcase.\n\nFrom-SVN: r263101", "tree": {"sha": "a9c4a33556cefd3b66bc8a316f84ce245d638003", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a9c4a33556cefd3b66bc8a316f84ce245d638003"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6cdce5064b7e2c30beec8a99f1b19869f14398a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6cdce5064b7e2c30beec8a99f1b19869f14398a7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6cdce5064b7e2c30beec8a99f1b19869f14398a7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6cdce5064b7e2c30beec8a99f1b19869f14398a7/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c992e2e4bd68729e7849c5649a9492263aedc063", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c992e2e4bd68729e7849c5649a9492263aedc063", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c992e2e4bd68729e7849c5649a9492263aedc063"}], "stats": {"total": 68, "additions": 68, "deletions": 0}, "files": [{"sha": "e54c9e0bb7a859af602148162a9064b065c8efe3", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=6cdce5064b7e2c30beec8a99f1b19869f14398a7", "patch": "@@ -1,3 +1,9 @@\n+2018-07-31  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* exp_ch6.adb (Expand_Protected_Subprogram_Call): Handle\n+\tproperly a protected call that includes a default parameter that\n+\tis a call to a protected function of the same type.\n+\n 2018-07-31  Justin Squirek  <squirek@adacore.com>\n \n \t* lib-writ.adb (Write_With_Lines): Modfiy the generation of"}, {"sha": "224f4c76722f05c3973337281debb18daab286a6", "filename": "gcc/ada/exp_ch6.adb", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Fada%2Fexp_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Fada%2Fexp_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch6.adb?ref=6cdce5064b7e2c30beec8a99f1b19869f14398a7", "patch": "@@ -6387,6 +6387,30 @@ package body Exp_Ch6 is\n          then\n             Rec := New_Occurrence_Of (First_Entity (Current_Scope), Sloc (N));\n \n+         --  A default parameter of a protected operation may be a call to\n+         --  a protected function of the type. This appears as an internal\n+         --  call in the profile of the operation, but if the context is an\n+         --  external call we must convert the call into an external one,\n+         --  using the protected object that is the target, so that:\n+\n+         --     Prot.P (F)\n+         --  is transformed into\n+         --     Prot.P (Prot.F)\n+\n+         elsif Nkind (Parent (N)) = N_Procedure_Call_Statement\n+           and then Nkind (Name (Parent (N))) = N_Selected_Component\n+           and then Is_Protected_Type (Etype (Prefix (Name (Parent (N)))))\n+           and then Is_Entity_Name (Name (N))\n+           and then Scope (Entity (Name (N))) =\n+                     Etype (Prefix (Name (Parent (N))))\n+         then\n+            Rewrite (Name (N),\n+              Make_Selected_Component (Sloc (N),\n+                Prefix => New_Copy_Tree (Prefix (Name (Parent (N)))),\n+                Selector_Name => Relocate_Node (Name (N))));\n+            Analyze_And_Resolve (N);\n+            return;\n+\n          else\n             --  If the context is the initialization procedure for a protected\n             --  type, the call is legal because the called entity must be a"}, {"sha": "6b4e6799d423de0bac736495e170ebd411b61682", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6cdce5064b7e2c30beec8a99f1b19869f14398a7", "patch": "@@ -1,3 +1,8 @@\n+2018-07-31  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/prot5.adb, gnat.dg/prot5_pkg.adb,\n+\tgnat.dg/prot5_pkg.ads: New testcase.\n+\n 2018-07-31  Justin Squirek  <squirek@adacore.com>\n \n \t* gnat.dg/addr11.adb: New testcase."}, {"sha": "b7243a6341a5e97196267775275e646f361995e3", "filename": "gcc/testsuite/gnat.dg/prot5.adb", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5.adb?ref=6cdce5064b7e2c30beec8a99f1b19869f14398a7", "patch": "@@ -0,0 +1,12 @@\n+--  { dg-do run }\n+--  { dg-options -gnata }\n+\n+with Prot5_Pkg;\n+\n+procedure Prot5 is\n+begin\n+   Prot5_Pkg.P.Proc (10);                   --  explicit parameter\n+   Prot5_Pkg.P.Proc (Prot5_Pkg.P.Get_Data); --  explicit call to protected operation\n+   Prot5_Pkg.P.Proc;                        -- defaulted call.\n+   pragma Assert (Prot5_Pkg.P.Get_Data = 80);\n+end Prot5;"}, {"sha": "58536c54f50c1248865e2b6385a94f188ca5aacd", "filename": "gcc/testsuite/gnat.dg/prot5_pkg.adb", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5_pkg.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5_pkg.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5_pkg.adb?ref=6cdce5064b7e2c30beec8a99f1b19869f14398a7", "patch": "@@ -0,0 +1,13 @@\n+package body Prot5_Pkg is\n+   protected body P is\n+      function Get_Data return Integer is\n+      begin\n+         return Data;\n+      end Get_Data;\n+\n+      procedure Proc (A : Integer := Get_Data) is\n+      begin\n+         Data := A * 2;\n+      end Proc;\n+   end P;\n+end Prot5_Pkg;"}, {"sha": "e488d09b78e384c0c96f1d310dacd3dbad17d666", "filename": "gcc/testsuite/gnat.dg/prot5_pkg.ads", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5_pkg.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6cdce5064b7e2c30beec8a99f1b19869f14398a7/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5_pkg.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fprot5_pkg.ads?ref=6cdce5064b7e2c30beec8a99f1b19869f14398a7", "patch": "@@ -0,0 +1,8 @@\n+package Prot5_Pkg is\n+   protected P is\n+      function Get_Data return Integer;\n+      procedure Proc (A : Integer := Get_Data);\n+   private\n+      Data : Integer;\n+   end P;\n+end Prot5_Pkg;"}]}