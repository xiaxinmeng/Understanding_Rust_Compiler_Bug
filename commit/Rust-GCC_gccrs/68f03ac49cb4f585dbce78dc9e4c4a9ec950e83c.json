{"sha": "68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c", "node_id": "C_kwDOANBUbNoAKDY4ZjAzYWM0OWNiNGY1ODVkYmNlNzhkYzllNGM0YTllYzk1MGU4M2M", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-01-20T10:58:20Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-01-20T10:58:20Z"}, "message": "dwarf2out: Fix -gsplit-dwarf on riscv [PR103874]\n\nriscv*-*-* are the only modern targets that !HAVE_AS_LEB128 (apparently\ndue to some aggressive linker optimizations).\nAs the following testcase shows, we mishandle in index_rnglists the\n!HAVE_AS_LEB128 && !have_multiple_function_sections case.\n\noutput_rnglists does roughly:\n  FOR_EACH_VEC_SAFE_ELT (ranges_table, i, r)\n    {\n...\n      if (block_num > 0)\n        {\n...\n          if (HAVE_AS_LEB128)\n            {\n              if (!have_multiple_function_sections)\n                {\n                  // code not using r->*_entry\n                  continue;\n                }\n              // code that sometimes doesn't use r->*_entry,\n              // sometimes r->begin_entry\n            }\n          else if (dwarf_split_debug_info)\n            {\n              // code that uses both r->begin_entry and r->end_entry\n            }\n          else\n            {\n              // code not using r->*_entry\n            }\n        }\n      else if (block_num < 0)\n        {\n          if (!have_multiple_function_sections)\n            gcc_unreachable ();\n...\n        }\n    }\nand index_rnglists is what sets up those r->{begin,end}_entry members.\nThe code did an early if (!have_multiple_function_sections) continue;\nwhich is fine for the HAVE_AS_LEB128 case, because r->*_entry is not\nused in that case, but not for !HAVE_AS_LEB128 that uses it anyway.\n\n2022-01-20  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR debug/103874\n\t* dwarf2out.cc (index_rnglists): For !HAVE_AS_LEB128 and\n\tblock_num > 0, index entry even if !have_multiple_function_sections.\n\n\t* gcc.dg/debug/dwarf2/pr103874.c: New test.", "tree": {"sha": "7e8a00b4649b3b5bbfeff3b6218965d19ffcb696", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7e8a00b4649b3b5bbfeff3b6218965d19ffcb696"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b78dee64def7e251a1d0678613c8aaabe7b176c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7b78dee64def7e251a1d0678613c8aaabe7b176c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7b78dee64def7e251a1d0678613c8aaabe7b176c"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "a5a7f630f9c1005af91075d2be393f2c57ddd036", "filename": "gcc/dwarf2out.cc", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c/gcc%2Fdwarf2out.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c/gcc%2Fdwarf2out.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdwarf2out.cc?ref=68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c", "patch": "@@ -12094,9 +12094,10 @@ index_rnglists (void)\n       if (r->label && r->idx != DW_RANGES_IDX_SKELETON)\n \tr->idx = rnglist_idx++;\n \n-      if (!have_multiple_function_sections)\n-\tcontinue;\n       int block_num = r->num;\n+      if ((HAVE_AS_LEB128 || block_num < 0)\n+\t  && !have_multiple_function_sections)\n+\tcontinue;\n       if (HAVE_AS_LEB128 && (r->label || r->maybe_new_sec))\n \tbase = false;\n       if (block_num > 0)"}, {"sha": "2f0e2d44e420be2542999e1b4df215a45e1d056a", "filename": "gcc/testsuite/gcc.dg/debug/dwarf2/pr103874.c", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c/gcc%2Ftestsuite%2Fgcc.dg%2Fdebug%2Fdwarf2%2Fpr103874.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c/gcc%2Ftestsuite%2Fgcc.dg%2Fdebug%2Fdwarf2%2Fpr103874.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fdebug%2Fdwarf2%2Fpr103874.c?ref=68f03ac49cb4f585dbce78dc9e4c4a9ec950e83c", "patch": "@@ -0,0 +1,12 @@\n+/* PR debug/103874 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -g -gsplit-dwarf -dA -Wno-implicit-function-declaration\" } */\n+\n+void\n+foo (void)\n+{\n+  {\n+    bar ();\n+    baz ();\n+  }\n+}"}]}