{"sha": "c81704b359283bb54696755ead881ab04136da94", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzgxNzA0YjM1OTI4M2JiNTQ2OTY3NTVlYWQ4ODFhYjA0MTM2ZGE5NA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-05-18T08:26:45Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-05-18T08:26:45Z"}, "message": "regcprop: Avoid DCE of asm goto [PR100590]\n\nThe following testcase ICEs, because copyprop_hardreg_forward_1 decides\nto DCE asm goto with REG_UNUSED notes (because the output is unused and\nasm isn't volatile).  But that DCE just removes the asm goto, leaving\na bb with two successors and no insn at the end that would allow that.\n\nThe following patch makes sure we drop that way only INSNs and not\nJUMP_INSNs or CALL_INSNs.\n\n2021-05-18  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR rtl-optimization/100590\n\t* regcprop.c (copyprop_hardreg_forward_1): Only DCE dead sets if\n\tthey are NONJUMP_INSN_P.\n\n\t* gcc.dg/pr100590.c: New test.", "tree": {"sha": "4139e0e23a32beefdd05eee44c4f140e6e9fdefa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4139e0e23a32beefdd05eee44c4f140e6e9fdefa"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c81704b359283bb54696755ead881ab04136da94", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c81704b359283bb54696755ead881ab04136da94", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c81704b359283bb54696755ead881ab04136da94", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c81704b359283bb54696755ead881ab04136da94/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "978b62e554ffb4b34844c72d259ce71fcbd87591", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/978b62e554ffb4b34844c72d259ce71fcbd87591", "html_url": "https://github.com/Rust-GCC/gccrs/commit/978b62e554ffb4b34844c72d259ce71fcbd87591"}], "stats": {"total": 14, "additions": 14, "deletions": 0}, "files": [{"sha": "44f6295b516f4a3d5fbbbdcc6ad6dcfbe0d49855", "filename": "gcc/regcprop.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c81704b359283bb54696755ead881ab04136da94/gcc%2Fregcprop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c81704b359283bb54696755ead881ab04136da94/gcc%2Fregcprop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fregcprop.c?ref=c81704b359283bb54696755ead881ab04136da94", "patch": "@@ -808,6 +808,7 @@ copyprop_hardreg_forward_1 (basic_block bb, struct value_data *vd)\n       /* Detect obviously dead sets (via REG_UNUSED notes) and remove them.  */\n       if (set\n \t  && !RTX_FRAME_RELATED_P (insn)\n+\t  && NONJUMP_INSN_P (insn)\n \t  && !may_trap_p (set)\n \t  && find_reg_note (insn, REG_UNUSED, SET_DEST (set))\n \t  && !side_effects_p (SET_SRC (set))"}, {"sha": "5cd36877fa1db25c7e7e7e9d2735df9094b0bf84", "filename": "gcc/testsuite/gcc.dg/pr100590.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c81704b359283bb54696755ead881ab04136da94/gcc%2Ftestsuite%2Fgcc.dg%2Fpr100590.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c81704b359283bb54696755ead881ab04136da94/gcc%2Ftestsuite%2Fgcc.dg%2Fpr100590.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr100590.c?ref=c81704b359283bb54696755ead881ab04136da94", "patch": "@@ -0,0 +1,13 @@\n+/* PR rtl-optimization/100590 */\n+/* { dg-do compile } */\n+/* { dg-options \"-O1 -fno-dce -w\" } */\n+\n+int\n+foo (void)\n+{\n+  int x;\n+  asm goto (\"\" : \"+r\" (x) : : : lab);\n+  return 0;\n+ lab:\n+  return 1;\n+}"}]}