{"sha": "813fc7bf1866ee281dfa0be67f08016af9279ffe", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODEzZmM3YmYxODY2ZWUyODFkZmEwYmU2N2YwODAxNmFmOTI3OWZmZQ==", "commit": {"author": {"name": "Vincent Celier", "email": "celier@gnat.com", "date": "2004-10-27T13:38:32Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2004-10-27T13:38:32Z"}, "message": "prj-env.adb: (Contains_ALI_Files): New Boolean function\n\n2004-10-26  Vincent Celier  <celier@gnat.com>\n\n\t* prj-env.adb: (Contains_ALI_Files): New Boolean function\n\t(Ada_Objects_Path.Add): For a library project, add to the object path\n\tthe library directory only if there is no object directory or if the\n\tlibrary directory contains ALI files.\n\t(Set_Ada_Paths.Add.Recursive_Add): Ditto\n\nFrom-SVN: r89661", "tree": {"sha": "24461a54c1ffdb9d4cd2b2b01f4ca8d5ecbe19d2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/24461a54c1ffdb9d4cd2b2b01f4ca8d5ecbe19d2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/813fc7bf1866ee281dfa0be67f08016af9279ffe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/813fc7bf1866ee281dfa0be67f08016af9279ffe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/813fc7bf1866ee281dfa0be67f08016af9279ffe", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/813fc7bf1866ee281dfa0be67f08016af9279ffe/comments", "author": null, "committer": null, "parents": [{"sha": "73f17ac8c157e4d2cdc60be0aac5a98808512a20", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/73f17ac8c157e4d2cdc60be0aac5a98808512a20", "html_url": "https://github.com/Rust-GCC/gccrs/commit/73f17ac8c157e4d2cdc60be0aac5a98808512a20"}], "stats": {"total": 68, "additions": 64, "deletions": 4}, "files": [{"sha": "517a2ee57c46fc28672da3fb043bc0545377aaed", "filename": "gcc/ada/prj-env.adb", "status": "modified", "additions": 64, "deletions": 4, "changes": 68, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/813fc7bf1866ee281dfa0be67f08016af9279ffe/gcc%2Fada%2Fprj-env.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/813fc7bf1866ee281dfa0be67f08016af9279ffe/gcc%2Fada%2Fprj-env.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fprj-env.adb?ref=813fc7bf1866ee281dfa0be67f08016af9279ffe", "patch": "@@ -32,7 +32,8 @@ with Prj.Com;  use Prj.Com;\n with Table;\n with Tempdir;\n \n-with GNAT.OS_Lib; use GNAT.OS_Lib;\n+with GNAT.Directory_Operations; use GNAT.Directory_Operations;\n+with GNAT.OS_Lib;               use GNAT.OS_Lib;\n \n package body Prj.Env is\n \n@@ -135,6 +136,9 @@ package body Prj.Env is\n    --  Add Object_Dir to object path table. Make sure it is not duplicate\n    --  and it is the last one in the current table.\n \n+   function Contains_ALI_Files (Dir : Name_Id) return Boolean;\n+   --  Return True if there is at least one ALI file in the directory Dir\n+\n    procedure Create_New_Path_File\n      (Path_FD   : out File_Descriptor;\n       Path_Name : out Name_Id);\n@@ -276,10 +280,18 @@ package body Prj.Env is\n                    and then\n                    (not Including_Libraries or else not Data.Library))\n                then\n-                  --  For a library project, add the library directory\n+                  --  For a library project, add the library directory,\n+                  --  if there is no object directory or if it contains ALI\n+                  --  files; otherwise add the object directory.\n \n                   if Data.Library then\n-                     Add_To_Path (Get_Name_String (Data.Library_Dir));\n+                     if Data.Object_Directory = No_Name\n+                       or else Contains_ALI_Files (Data.Library_Dir)\n+                     then\n+                        Add_To_Path (Get_Name_String (Data.Library_Dir));\n+                     else\n+                        Add_To_Path (Get_Name_String (Data.Object_Directory));\n+                     end if;\n \n                   else\n                      --  For a non library project, add the object directory\n@@ -546,6 +558,45 @@ package body Prj.Env is\n       return Namet.Get_Name_String (Data.File_Names (Body_Part).Path);\n    end Body_Path_Name_Of;\n \n+   ------------------------\n+   -- Contains_ALI_Files --\n+   ------------------------\n+\n+   function Contains_ALI_Files (Dir : Name_Id) return Boolean is\n+      Dir_Name : constant String := Get_Name_String (Dir);\n+      Direct : Dir_Type;\n+      Name   : String (1 .. 1_000);\n+      Last   : Natural;\n+      Result : Boolean := False;\n+\n+   begin\n+      Open (Direct, Dir_Name);\n+\n+      --  For each file in the directory, check if it is an ALI file\n+\n+      loop\n+         Read (Direct, Name, Last);\n+         exit when Last = 0;\n+         Canonical_Case_File_Name (Name (1 .. Last));\n+         Result := Last >= 5 and then Name (Last - 3 .. Last) = \".ali\";\n+         exit when Result;\n+      end loop;\n+\n+      Close (Direct);\n+      return Result;\n+\n+   exception\n+      --  If there is any problem, close the directory if open and return\n+      --  True; the library directory will be added to the path.\n+\n+      when others =>\n+         if Is_Open (Direct) then\n+            Close (Direct);\n+         end if;\n+\n+         return True;\n+   end Contains_ALI_Files;\n+\n    --------------------------------\n    -- Create_Config_Pragmas_File --\n    --------------------------------\n@@ -1966,9 +2017,18 @@ package body Prj.Env is\n                             (not Including_Libraries or else not Data.Library))\n                      then\n                         --  For a library project, add the library directory\n+                        --  if there is no object directory or if the library\n+                        --  directory contains ALI files; otherwise add the\n+                        --  object directory.\n \n                         if Data.Library then\n-                           Add_To_Object_Path (Data.Library_Dir);\n+                           if Data.Object_Directory = No_Name\n+                             or else Contains_ALI_Files (Data.Library_Dir)\n+                           then\n+                              Add_To_Object_Path (Data.Library_Dir);\n+                           else\n+                              Add_To_Object_Path (Data.Object_Directory);\n+                           end if;\n \n                         --  For a non-library project, add the object\n                         --  directory, if it is not a virtual project."}]}