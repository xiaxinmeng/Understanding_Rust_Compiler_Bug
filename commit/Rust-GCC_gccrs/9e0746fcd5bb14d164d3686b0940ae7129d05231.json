{"sha": "9e0746fcd5bb14d164d3686b0940ae7129d05231", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWUwNzQ2ZmNkNWJiMTRkMTY0ZDM2ODZiMDk0MGFlNzEyOWQwNTIzMQ==", "commit": {"author": {"name": "Eric Botcazou", "email": "ebotcazou@adacore.com", "date": "2019-09-19T08:14:23Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-09-19T08:14:23Z"}, "message": "[Ada] Fix bogus visibility error with nested generics and inlining\n\nThis prevents the compiler from issuing a bogus error about the\nvisibility of an operator in an instantiation of a nested generic\npackage which is itself used as an actual of an instantiation of another\ngeneric package, when the instantiations are done in a unit withed from\nthe main unit and containing an inlined subprogram, and cross-unit\ninlining is enabled.\n\nIn most cases, the compiler does not check the visibility of operators\nin an instantiation context because this has already been done when the\ngeneric package has been analyzed. However, there are exceptions like\nthe actuals of an instantiation of a generic child unit which is done\nas a compilation unit and the In_Instance predicate has a special check\nfor these cases.\n\nThis check would incorrectly trigger here and needs to be tightened.\n\n2019-09-19  Eric Botcazou  <ebotcazou@adacore.com>\n\ngcc/ada/\n\n\t* sem_util.adb (In_Instance): Test whether the current unit has\n\tbeen analyzed instead of being on the scope stack to detect the\n\tcase of actuals of an instantiation of a generic child unit done\n\tas a compilation unit.\n\ngcc/testsuite/\n\n\t* gnat.dg/inline20.adb, gnat.dg/inline20_g.adb,\n\tgnat.dg/inline20_g.ads, gnat.dg/inline20_h.ads,\n\tgnat.dg/inline20_i.ads, gnat.dg/inline20_q-io.ads,\n\tgnat.dg/inline20_q.ads, gnat.dg/inline20_r.ads: New testcase.\n\nFrom-SVN: r275952", "tree": {"sha": "a0925593d1b606a60ed49952f71ea5226bb4163f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a0925593d1b606a60ed49952f71ea5226bb4163f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9e0746fcd5bb14d164d3686b0940ae7129d05231", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9e0746fcd5bb14d164d3686b0940ae7129d05231", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9e0746fcd5bb14d164d3686b0940ae7129d05231", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9e0746fcd5bb14d164d3686b0940ae7129d05231/comments", "author": null, "committer": null, "parents": [{"sha": "fd0d7b4e3be10508119636f06807f23d5691088b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd0d7b4e3be10508119636f06807f23d5691088b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fd0d7b4e3be10508119636f06807f23d5691088b"}], "stats": {"total": 115, "additions": 112, "deletions": 3}, "files": [{"sha": "3d348b4e36b99b4478cc21eda838002393ab3f40", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -1,3 +1,10 @@\n+2019-09-19  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* sem_util.adb (In_Instance): Test whether the current unit has\n+\tbeen analyzed instead of being on the scope stack to detect the\n+\tcase of actuals of an instantiation of a generic child unit done\n+\tas a compilation unit.\n+\n 2019-09-19  Dmitriy Anisimkov  <anisimko@adacore.com>\n \n \t* libgnat/g-socket.ads, libgnat/g-socket.adb"}, {"sha": "95699199e3febd94c6beb9786a2eac3adac57c01", "filename": "gcc/ada/sem_util.adb", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Fada%2Fsem_util.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Fada%2Fsem_util.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_util.adb?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -12380,15 +12380,15 @@ package body Sem_Util is\n          if Is_Generic_Instance (S) then\n \n             --  A child instance is always compiled in the context of a parent\n-            --  instance. Nevertheless, the actuals are not analyzed in an\n+            --  instance. Nevertheless, its actuals must not be analyzed in an\n             --  instance context. We detect this case by examining the current\n             --  compilation unit, which must be a child instance, and checking\n-            --  that it is not currently on the scope stack.\n+            --  that it has not been analyzed yet.\n \n             if Is_Child_Unit (Curr_Unit)\n               and then Nkind (Unit (Cunit (Current_Sem_Unit))) =\n                                                      N_Package_Instantiation\n-              and then not In_Open_Scopes (Curr_Unit)\n+              and then Ekind (Curr_Unit) = E_Void\n             then\n                return False;\n             else"}, {"sha": "f667897bd33bf8c345cc0053be0bb0daec2a0d3b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -1,3 +1,10 @@\n+2019-09-19  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* gnat.dg/inline20.adb, gnat.dg/inline20_g.adb,\n+\tgnat.dg/inline20_g.ads, gnat.dg/inline20_h.ads,\n+\tgnat.dg/inline20_i.ads, gnat.dg/inline20_q-io.ads,\n+\tgnat.dg/inline20_q.ads, gnat.dg/inline20_r.ads: New testcase.\n+\n 2019-09-19  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/generic2-child.ads, gnat.dg/generic2-io_any.adb,"}, {"sha": "dde9a539faa84af923b61ad3ceedc05670660ea9", "filename": "gcc/testsuite/gnat.dg/inline20.adb", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20.adb?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,9 @@\n+--  { dg-do compile }\n+--  { dg-options \"-O -gnatn2\" }\n+with Inline20_Q.IO;\n+with Inline20_R;\n+\n+procedure Inline20 is\n+begin\n+   Inline20_R.Log (Inline20_Q.IO.F);\n+end;"}, {"sha": "dbae5962a1e0d3c751b730b9aad872ba4df5926b", "filename": "gcc/testsuite/gnat.dg/inline20_g.adb", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_g.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_g.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_g.adb?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,18 @@\n+with Ada.Streams; use Ada.Streams;\n+\n+package body Inline20_G is\n+\n+   package body Nested_G is\n+\n+      procedure Get (Data : T; Into : out Offset_Type) is\n+      begin\n+         Into := (T'Descriptor_Size + Data'Size) / Standard'Storage_Unit;\n+      end;\n+\n+      function F return Integer is\n+      begin\n+         return 0;\n+      end;\n+   end Nested_G;\n+\n+end Inline20_G;"}, {"sha": "adf2df6914f2fcbcac3a3a9c7bb0bf19e2116310", "filename": "gcc/testsuite/gnat.dg/inline20_g.ads", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_g.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_g.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_g.ads?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,18 @@\n+with Ada.Streams;\n+\n+generic\n+package Inline20_G is\n+\n+   subtype Offset_Type is Ada.Streams.Stream_Element_Offset;\n+\n+   generic\n+      type T is private;\n+   package Nested_G is\n+\n+      procedure Get (Data : T; Into : out Offset_Type);\n+\n+      function F return Integer with Inline;\n+\n+   end Nested_G;\n+\n+end Inline20_G;"}, {"sha": "59377986e25a4e9c6bbb73ed90e5faa9a2c9b1b4", "filename": "gcc/testsuite/gnat.dg/inline20_h.ads", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_h.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_h.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_h.ads?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,15 @@\n+with Inline20_G;\n+\n+generic\n+   with package Msg is new Inline20_G (<>);\n+package Inline20_H is\n+\n+   generic\n+      type T is private;\n+      with function Image (Data : T) return String;\n+   package Nested_H is\n+      package My_Nested_G is new Msg.Nested_G (T);\n+      function F return Integer renames My_Nested_G.F;\n+   end Nested_H;\n+\n+end Inline20_H;"}, {"sha": "d946375388e63f748d0d0be55042645153630d04", "filename": "gcc/testsuite/gnat.dg/inline20_i.ads", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_i.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_i.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_i.ads?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,19 @@\n+with Inline20_R;\n+\n+generic\n+package Inline20_I is\n+\n+   type Rec is null record;\n+\n+   generic\n+   package Generic_IO is\n+\n+      function Image (Quote : Rec) return String;\n+\n+      package My_Nested_H is new Inline20_R.My_H.Nested_H (Rec, Image);\n+\n+      function F return Integer renames My_Nested_H.F;\n+\n+   end Generic_IO;\n+\n+end Inline20_I;\n\\ No newline at end of file"}, {"sha": "8e8188733ed1410c71dac7ebe9744a61d94ae681", "filename": "gcc/testsuite/gnat.dg/inline20_q-io.ads", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_q-io.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_q-io.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_q-io.ads?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1 @@\n+package Inline20_Q.IO is new Inline20_Q.Generic_IO;"}, {"sha": "08c81cde0a5bd862ebeafec73472305642d7832b", "filename": "gcc/testsuite/gnat.dg/inline20_q.ads", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_q.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_q.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_q.ads?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,3 @@\n+with Inline20_I;\n+\n+package Inline20_Q is new Inline20_I;"}, {"sha": "4b96f751d20daef705ef252643c119e2433e95a6", "filename": "gcc/testsuite/gnat.dg/inline20_r.ads", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_r.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e0746fcd5bb14d164d3686b0940ae7129d05231/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_r.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Finline20_r.ads?ref=9e0746fcd5bb14d164d3686b0940ae7129d05231", "patch": "@@ -0,0 +1,12 @@\n+with Inline20_G;\n+with Inline20_H;\n+\n+package Inline20_R is\n+\n+   package My_G is new Inline20_G;\n+\n+   package My_H is new Inline20_H (My_G);\n+\n+   procedure Log (I : Integer);\n+\n+end Inline20_R;"}]}