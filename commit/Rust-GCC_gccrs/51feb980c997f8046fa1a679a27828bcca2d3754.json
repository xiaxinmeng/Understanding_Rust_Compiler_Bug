{"sha": "51feb980c997f8046fa1a679a27828bcca2d3754", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTFmZWI5ODBjOTk3ZjgwNDZmYTFhNjc5YTI3ODI4YmNjYTJkMzc1NA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-11-24T08:34:13Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-11-24T08:34:13Z"}, "message": "tree-object-size.c (pass_through_call): Use gimple_call_return_flags ERF_RETURN*ARG* for builtins other than...\n\n\t* tree-object-size.c (pass_through_call): Use gimple_call_return_flags\n\tERF_RETURN*ARG* for builtins other than BUILT_IN_ASSUME_ALIGNED,\n\tcheck for the latter with gimple_call_builtin_p.  Do not handle\n\tBUILT_IN_STPNCPY_CHK which is not a pass through call.\n\n\t* gcc.dg/builtin-object-size-18.c: New test.\n\nFrom-SVN: r255133", "tree": {"sha": "859451408331735c0092b2e45e4f12b829b4cfc4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/859451408331735c0092b2e45e4f12b829b4cfc4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/51feb980c997f8046fa1a679a27828bcca2d3754", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/51feb980c997f8046fa1a679a27828bcca2d3754", "html_url": "https://github.com/Rust-GCC/gccrs/commit/51feb980c997f8046fa1a679a27828bcca2d3754", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/51feb980c997f8046fa1a679a27828bcca2d3754/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "489154e71b1b64e05f4b002289480a20976d2588", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/489154e71b1b64e05f4b002289480a20976d2588", "html_url": "https://github.com/Rust-GCC/gccrs/commit/489154e71b1b64e05f4b002289480a20976d2588"}], "stats": {"total": 63, "additions": 36, "deletions": 27}, "files": [{"sha": "787e545949e0789a38d8d6e417d591efc752ae5b", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=51feb980c997f8046fa1a679a27828bcca2d3754", "patch": "@@ -1,3 +1,10 @@\n+2017-11-24  Jakub Jelinek  <jakub@redhat.com>\n+\n+\t* tree-object-size.c (pass_through_call): Use gimple_call_return_flags\n+\tERF_RETURN*ARG* for builtins other than BUILT_IN_ASSUME_ALIGNED,\n+\tcheck for the latter with gimple_call_builtin_p.  Do not handle\n+\tBUILT_IN_STPNCPY_CHK which is not a pass through call.\n+\n 2017-11-24  Christophe Lyon  <christophe.lyon@linaro.org>\n \n \t* config/arm/arm_neon.h: Fix pragma GCC push_options before"}, {"sha": "480a5c637ff7ba27825bb200831dc188ee54c67a", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=51feb980c997f8046fa1a679a27828bcca2d3754", "patch": "@@ -1,3 +1,7 @@\n+2017-11-24  Jakub Jelinek  <jakub@redhat.com>\n+\n+\t* gcc.dg/builtin-object-size-18.c: New test.\n+\n 2017-11-23  Julia Koval  <julia.koval@intel.com>\n \n \tgcc.target/i386/avx512f-vpexpandb-1.c: New test."}, {"sha": "e065393282a9e05ffcd2bb89fbfe5f261006a432", "filename": "gcc/testsuite/gcc.dg/builtin-object-size-18.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2Ftestsuite%2Fgcc.dg%2Fbuiltin-object-size-18.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2Ftestsuite%2Fgcc.dg%2Fbuiltin-object-size-18.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fbuiltin-object-size-18.c?ref=51feb980c997f8046fa1a679a27828bcca2d3754", "patch": "@@ -0,0 +1,15 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -fdump-tree-optimized\" } */\n+/* __stpncpy_chk could return buf up to buf + 64, so\n+   the minimum object size might be far smaller than 64.  */\n+/* { dg-final { scan-tree-dump-not \"return 64;\" \"optimized\" } } */\n+\n+typedef __SIZE_TYPE__ size_t;\n+\n+size_t\n+foo (const char *p, size_t s, size_t t)\n+{\n+  char buf[64];\n+  char *q = __builtin___stpncpy_chk (buf, p, s, t);\n+  return __builtin_object_size (q, 2);\n+}"}, {"sha": "14cb435f07f401db9b56db8fb019631a8f6b39e6", "filename": "gcc/tree-object-size.c", "status": "modified", "additions": 10, "deletions": 27, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2Ftree-object-size.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/51feb980c997f8046fa1a679a27828bcca2d3754/gcc%2Ftree-object-size.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-object-size.c?ref=51feb980c997f8046fa1a679a27828bcca2d3754", "patch": "@@ -464,34 +464,17 @@ alloc_object_size (const gcall *call, int object_size_type)\n static tree\n pass_through_call (const gcall *call)\n {\n-  tree callee = gimple_call_fndecl (call);\n+  unsigned rf = gimple_call_return_flags (call);\n+  if (rf & ERF_RETURNS_ARG)\n+    {\n+      unsigned argnum = rf & ERF_RETURN_ARG_MASK;\n+      if (argnum < gimple_call_num_args (call))\n+\treturn gimple_call_arg (call, argnum);\n+    }\n \n-  if (callee\n-      && DECL_BUILT_IN_CLASS (callee) == BUILT_IN_NORMAL)\n-    switch (DECL_FUNCTION_CODE (callee))\n-      {\n-      case BUILT_IN_MEMCPY:\n-      case BUILT_IN_MEMMOVE:\n-      case BUILT_IN_MEMSET:\n-      case BUILT_IN_STRCPY:\n-      case BUILT_IN_STRNCPY:\n-      case BUILT_IN_STRCAT:\n-      case BUILT_IN_STRNCAT:\n-      case BUILT_IN_MEMCPY_CHK:\n-      case BUILT_IN_MEMMOVE_CHK:\n-      case BUILT_IN_MEMSET_CHK:\n-      case BUILT_IN_STRCPY_CHK:\n-      case BUILT_IN_STRNCPY_CHK:\n-      case BUILT_IN_STPNCPY_CHK:\n-      case BUILT_IN_STRCAT_CHK:\n-      case BUILT_IN_STRNCAT_CHK:\n-      case BUILT_IN_ASSUME_ALIGNED:\n-\tif (gimple_call_num_args (call) >= 1)\n-\t  return gimple_call_arg (call, 0);\n-\tbreak;\n-      default:\n-\tbreak;\n-      }\n+  /* __builtin_assume_aligned is intentionally not marked RET1.  */\n+  if (gimple_call_builtin_p (call, BUILT_IN_ASSUME_ALIGNED))\n+    return gimple_call_arg (call, 0);\n \n   return NULL_TREE;\n }"}]}