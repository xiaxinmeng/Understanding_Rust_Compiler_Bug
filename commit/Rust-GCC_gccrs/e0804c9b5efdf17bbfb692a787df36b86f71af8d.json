{"sha": "e0804c9b5efdf17bbfb692a787df36b86f71af8d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTA4MDRjOWI1ZWZkZjE3YmJmYjY5MmE3ODdkZjM2Yjg2ZjcxYWY4ZA==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-01-10T18:47:02Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2020-01-10T18:47:02Z"}, "message": "PR c++/93143 - incorrect tree sharing with constexpr.\n\nWe don't unshare CONSTRUCTORs as often during constexpr evaluation, so we\nneed to unshare them here.\n\n\t* constexpr.c (cxx_eval_outermost_constant_expr): Don't assume\n\tCONSTRUCTORs are already unshared.\n\nFrom-SVN: r280127", "tree": {"sha": "85f98decaabbf13fa0629a17b3dd0716131067bb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/85f98decaabbf13fa0629a17b3dd0716131067bb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e0804c9b5efdf17bbfb692a787df36b86f71af8d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e0804c9b5efdf17bbfb692a787df36b86f71af8d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e0804c9b5efdf17bbfb692a787df36b86f71af8d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e0804c9b5efdf17bbfb692a787df36b86f71af8d/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "640b23d7ff5f3fad005dcbfb04a36e27000fc150", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/640b23d7ff5f3fad005dcbfb04a36e27000fc150", "html_url": "https://github.com/Rust-GCC/gccrs/commit/640b23d7ff5f3fad005dcbfb04a36e27000fc150"}], "stats": {"total": 37, "additions": 34, "deletions": 3}, "files": [{"sha": "1a36cd3c89ec44c5b2e6793640881b65e015c95c", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e0804c9b5efdf17bbfb692a787df36b86f71af8d/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e0804c9b5efdf17bbfb692a787df36b86f71af8d/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=e0804c9b5efdf17bbfb692a787df36b86f71af8d", "patch": "@@ -1,5 +1,9 @@\n 2020-01-10  Jason Merrill  <jason@redhat.com>\n \n+\tPR c++/93143 - incorrect tree sharing with constexpr.\n+\t* constexpr.c (cxx_eval_outermost_constant_expr): Don't assume\n+\tCONSTRUCTORs are already unshared.\n+\n \tPR c++/93173 - incorrect tree sharing.\n \tPR c++/93033\n \t* cp-gimplify.c (cp_gimplify_init_expr, cp_gimplify_expr): Use"}, {"sha": "3ca3b9ecd653d684e37219f5e1860923a6a7898c", "filename": "gcc/cp/constexpr.c", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e0804c9b5efdf17bbfb692a787df36b86f71af8d/gcc%2Fcp%2Fconstexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e0804c9b5efdf17bbfb692a787df36b86f71af8d/gcc%2Fcp%2Fconstexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fconstexpr.c?ref=e0804c9b5efdf17bbfb692a787df36b86f71af8d", "patch": "@@ -6347,10 +6347,10 @@ cxx_eval_outermost_constant_expr (tree t, bool allow_non_constant,\n   if (!non_constant_p && overflow_p)\n     non_constant_p = true;\n \n-  /* Unshare the result unless it's a CONSTRUCTOR in which case it's already\n-     unshared.  */\n+  /* Unshare the result.  */\n   bool should_unshare = true;\n-  if (r == t || TREE_CODE (r) == CONSTRUCTOR)\n+  if (r == t || (TREE_CODE (t) == TARGET_EXPR\n+\t\t && TARGET_EXPR_INITIAL (t) == r))\n     should_unshare = false;\n \n   if (non_constant_p && !allow_non_constant)"}, {"sha": "80e24e2d6971e9b945b615c8e9899e41cbb148b2", "filename": "gcc/testsuite/g++.dg/cpp0x/constexpr-array22.C", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e0804c9b5efdf17bbfb692a787df36b86f71af8d/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-array22.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e0804c9b5efdf17bbfb692a787df36b86f71af8d/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-array22.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fconstexpr-array22.C?ref=e0804c9b5efdf17bbfb692a787df36b86f71af8d", "patch": "@@ -0,0 +1,27 @@\n+// PR c++/93143\n+// { dg-do run { target c++11 } }\n+\n+struct A { char a[2]; };\n+\n+static constexpr A foo () { return A{1}; }\n+\n+void bar ()\n+{\n+  A a = foo ();\n+  if (a.a[0] != 1)\n+    __builtin_abort(); \n+}\n+\n+void foobar ()\n+{\n+  A x[] = { foo (), foo () };\n+  A a = foo ();\n+  if (a.a[0] != 1)\n+    __builtin_abort(); \n+}\n+\n+int main()\n+{\n+  bar();\n+  foobar();\n+}"}]}