{"sha": "b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjgxZjdiODM2MzFiZTdkZWRjZGNmNDRlZWQ2ZGQ1NzVhZGEzYWMyMw==", "commit": {"author": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2019-04-06T22:10:28Z"}, "committer": {"name": "Thomas Koenig", "email": "tkoenig@gcc.gnu.org", "date": "2019-04-06T22:10:28Z"}, "message": "re PR fortran/87352 (Large stack usage with new gfortran)\n\n2019-04-06  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/87352\n\t* gfortran.h (gfc_component): Add finalized field.\n\t* class.c (finalize_component): If the component is already\n\tfinalized, return early.  Set component->finalized on exit.\n\n2019-04-06  Thomas Koenig  <tkoenig@gcc.gnu.org>\n\n\tPR fortran/87352\n\t* gfortran.dg/finalize_28.f90: Adjust count of __builtin_free.\n\t* gfortran.dg/finalize_33.f90: Likewise.\n\t* gfortran.dg/finalize_34.f90: New test.\n\nFrom-SVN: r270184", "tree": {"sha": "7bc7716412e765e98c5dbc22808a8b12304c7246", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/7bc7716412e765e98c5dbc22808a8b12304c7246"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/comments", "author": null, "committer": null, "parents": [{"sha": "2955784caf887cbc6949b766bc38d6f9e0f3fc48", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2955784caf887cbc6949b766bc38d6f9e0f3fc48", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2955784caf887cbc6949b766bc38d6f9e0f3fc48"}], "stats": {"total": 48, "additions": 46, "deletions": 2}, "files": [{"sha": "563ef9d3a3c241e9a39e777680c34780bf622a0a", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -1,3 +1,10 @@\n+2019-04-06  Thomas Koenig  <tkoenig@gcc.gnu.org>\n+\n+\tPR fortran/87352\n+\t* gfortran.h (gfc_component): Add finalized field.\n+\t* class.c (finalize_component): If the component is already\n+\tfinalized, return early.  Set component->finalized on exit.\n+\n 2019-04-06  Thomas Koenig  <tkoenig@gcc.gnu.org>\n \n \tPR fortran/89981"}, {"sha": "8a1f43f116c52e92984d6bc79eabcce2e5ed90c6", "filename": "gcc/fortran/class.c", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ffortran%2Fclass.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ffortran%2Fclass.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fclass.c?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -911,6 +911,9 @@ finalize_component (gfc_expr *expr, gfc_symbol *derived, gfc_component *comp,\n   if (!comp_is_finalizable (comp))\n     return;\n \n+  if (comp->finalized)\n+    return;\n+\n   e = gfc_copy_expr (expr);\n   if (!e->ref)\n     e->ref = ref = gfc_get_ref ();\n@@ -1038,6 +1041,7 @@ finalize_component (gfc_expr *expr, gfc_symbol *derived, gfc_component *comp,\n \t\t\t    sub_ns);\n       gfc_free_expr (e);\n     }\n+  comp->finalized = true;\n }\n \n "}, {"sha": "be975cda0749a0cd423929cf8a7c1e4d51a628af", "filename": "gcc/fortran/gfortran.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ffortran%2Fgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ffortran%2Fgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.h?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -1094,6 +1094,7 @@ typedef struct gfc_component\n   struct gfc_typebound_proc *tb;\n   /* When allocatable/pointer and in a coarray the associated token.  */\n   tree caf_token;\n+  bool finalized;\n }\n gfc_component;\n "}, {"sha": "4208625d09e3ebb720303a2ad3c8d75c0eccf2b5", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -1,3 +1,10 @@\n+2019-04-06  Thomas Koenig  <tkoenig@gcc.gnu.org>\n+\n+\tPR fortran/87352\n+\t* gfortran.dg/finalize_28.f90: Adjust count of __builtin_free.\n+\t* gfortran.dg/finalize_33.f90: Likewise.\n+\t* gfortran.dg/finalize_34.f90: New test.\n+\n 2019-04-06  Thomas Koenig  <tkoenig@gcc.gnu.org>\n \n \tPR fortran/89981"}, {"sha": "597413b2dd3f14b82472fd3600442a891d036854", "filename": "gcc/testsuite/gfortran.dg/finalize_28.f90", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_28.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_28.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_28.f90?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -21,4 +21,4 @@ subroutine coo_dump_edges(g, edges)\n     integer, intent(out) :: edges(:,:)\n   end subroutine coo_dump_edges\n end module coo_graphs\n-! { dg-final { scan-tree-dump-times \"__builtin_free\" 6 \"original\" } }\n+! { dg-final { scan-tree-dump-times \"__builtin_free\" 5 \"original\" } }"}, {"sha": "2205f9eed7f2bfb1c6ab3f9bb493ee56bf97cc56", "filename": "gcc/testsuite/gfortran.dg/finalize_33.f90", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_33.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_33.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_33.f90?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -116,4 +116,4 @@ end subroutine event_transforms_1            ! generates 3 final calls to mci_mi\n                                                ! (iii) mci_template\n end program main_ut\n ! { dg-final { scan-tree-dump-times \"__builtin_malloc\" 17 \"original\" } }\n-! { dg-final { scan-tree-dump-times \"__builtin_free\" 20 \"original\" } }\n+! { dg-final { scan-tree-dump-times \"__builtin_free\" 19 \"original\" } }"}, {"sha": "e2f02a5c51c584ea6ad5ef08df28a4f2377e8fe8", "filename": "gcc/testsuite/gfortran.dg/finalize_34.f90", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_34.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b81f7b83631be7dedcdcf44eed6dd575ada3ac23/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_34.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Ffinalize_34.f90?ref=b81f7b83631be7dedcdcf44eed6dd575ada3ac23", "patch": "@@ -0,0 +1,25 @@\n+! { dg-do compile }\n+! { dg-additional-options \"-fdump-tree-original\" }\n+! PR 87352 - this used to cause an excessive number of deallocations.\n+module testmodule\n+  implicit none\n+  public\n+\n+  type :: evtlist_type\n+     real,  allocatable, dimension(:) :: p1\n+     real,  allocatable, dimension(:) :: p2\n+     real,  allocatable, dimension(:) :: p3\n+     real,  allocatable, dimension(:) :: p4\n+  end type evtlist_type\n+\n+  type :: evtlistlist_type\n+     type(evtlist_type)  :: evtlist(1:1)\n+  end type evtlistlist_type\n+\n+end module testmodule \n+\n+program main\n+  use testmodule\n+  type(evtlist_type), dimension(10) :: a\n+end program main\n+! { dg-final  { scan-tree-dump-times \"__builtin_free\" 8 \"original\" } }"}]}