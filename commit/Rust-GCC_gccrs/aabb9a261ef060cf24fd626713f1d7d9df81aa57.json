{"sha": "aabb9a261ef060cf24fd626713f1d7d9df81aa57", "node_id": "C_kwDOANBUbNoAKGFhYmI5YTI2MWVmMDYwY2YyNGZkNjI2NzEzZjFkN2Q5ZGY4MWFhNTc", "commit": {"author": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2022-04-09T19:05:52Z"}, "committer": {"name": "Jan Hubicka", "email": "jh@suse.cz", "date": "2022-04-09T19:07:07Z"}, "message": "Propagate nondeterministic and side_effects flags in modref summary after inlining\n\ngcc/ChangeLog:\n\n2022-04-09  Jan Hubicka  <hubicka@ucw.cz>\n\n\t* ipa-modref.cc (ipa_merge_modref_summary_after_inlining): Propagate\n\tnondeterministic and side_effects flags.\n\ngcc/testsuite/ChangeLog:\n\n2022-04-09  Jan Hubicka  <hubicka@ucw.cz>\n\n\t* gcc.dg/ipa/pr105160.c: New test.", "tree": {"sha": "93060c9eaa711630c6d005ef987d8d50f94cfadc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/93060c9eaa711630c6d005ef987d8d50f94cfadc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/aabb9a261ef060cf24fd626713f1d7d9df81aa57", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aabb9a261ef060cf24fd626713f1d7d9df81aa57", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aabb9a261ef060cf24fd626713f1d7d9df81aa57", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aabb9a261ef060cf24fd626713f1d7d9df81aa57/comments", "author": null, "committer": null, "parents": [{"sha": "c8f7324e81c1bb7093a5b44317af385e5774f9a3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c8f7324e81c1bb7093a5b44317af385e5774f9a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c8f7324e81c1bb7093a5b44317af385e5774f9a3"}], "stats": {"total": 100, "additions": 100, "deletions": 0}, "files": [{"sha": "556816ab4296d987bc58d979f05ec464a1f3d91b", "filename": "gcc/ipa-modref.cc", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aabb9a261ef060cf24fd626713f1d7d9df81aa57/gcc%2Fipa-modref.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aabb9a261ef060cf24fd626713f1d7d9df81aa57/gcc%2Fipa-modref.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-modref.cc?ref=aabb9a261ef060cf24fd626713f1d7d9df81aa57", "patch": "@@ -5281,6 +5281,29 @@ ipa_merge_modref_summary_after_inlining (cgraph_edge *edge)\n       if (!ignore_stores)\n \tto_info_lto->stores->collapse ();\n     }\n+  /* Merge side effects and non-determinism.\n+     PURE/CONST flags makes functions deterministic and if there is\n+     no LOOPING_CONST_OR_PURE they also have no side effects.  */\n+  if (!(flags & (ECF_CONST | ECF_NOVOPS | ECF_PURE))\n+      || (flags & ECF_LOOPING_CONST_OR_PURE))\n+    {\n+      if (to_info)\n+\t{\n+\t  if (!callee_info || callee_info->side_effects)\n+\t    to_info->side_effects = true;\n+\t  if ((!callee_info || callee_info->nondeterministic)\n+\t      && !ignore_nondeterminism_p (edge->caller->decl, flags))\n+\t    to_info->nondeterministic = true;\n+\t}\n+      if (to_info_lto)\n+\t{\n+\t  if (!callee_info_lto || callee_info_lto->side_effects)\n+\t    to_info_lto->side_effects = true;\n+\t  if ((!callee_info_lto || callee_info_lto->nondeterministic)\n+\t      && !ignore_nondeterminism_p (edge->caller->decl, flags))\n+\t    to_info_lto->nondeterministic = true;\n+\t}\n+     }\n   if (callee_info || callee_info_lto)\n     {\n       auto_vec <modref_parm_map, 32> parm_map;"}, {"sha": "ea80545b102a0a9fe85f929d70720706f902ff67", "filename": "gcc/testsuite/gcc.dg/ipa/pr105160.c", "status": "added", "additions": 77, "deletions": 0, "changes": 77, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/aabb9a261ef060cf24fd626713f1d7d9df81aa57/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fpr105160.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/aabb9a261ef060cf24fd626713f1d7d9df81aa57/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fpr105160.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fipa%2Fpr105160.c?ref=aabb9a261ef060cf24fd626713f1d7d9df81aa57", "patch": "@@ -0,0 +1,77 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O -fdump-ipa-modref\" } */\n+#define sysreg_read(regname)\t\t\\\n+({\t\t\t\t\t\\\n+\tunsigned long __sr_val;\t\t\\\n+\tasm volatile(\"\");\t\t\\\n+\t\t\t\t\t\\\n+\t__sr_val;\t\t\t\\\n+})\n+\n+#define sysreg_write(regname, __sw_val)\t\\\n+do {\t\t\t\t\t\\\n+\tasm volatile(\"\");\t\t\t\\\n+} while (0)\n+\n+#define isb()\t\t\t\t\\\n+do {\t\t\t\t\t\\\n+\tasm volatile(\t\t\t\\\n+\t\"isb\"\t\t\t\t\\\n+\t:\t\t\t\t\\\n+\t:\t\t\t\t\\\n+\t: \"memory\");\t\t\t\\\n+} while (0)\n+\n+static unsigned long sctlr_read(void)\n+{\n+\treturn sysreg_read(sctlr_el1);\n+}\n+\n+static void sctlr_write(unsigned long val)\n+{\n+\tsysreg_write(sctlr_el1, val);\n+}\n+\n+static void sctlr_rmw(void)\n+{\n+\tunsigned long val;\n+\n+\tval = sctlr_read();\n+\tval |= 1UL << 7;\n+\tsctlr_write(val);\n+}\n+\n+void sctlr_read_multiple(void)\n+{\n+\tsctlr_read();\n+\tsctlr_read();\n+\tsctlr_read();\n+\tsctlr_read();\n+}\n+\n+void sctlr_write_multiple(void)\n+{\n+\tsctlr_write(0);\n+\tsctlr_write(0);\n+\tsctlr_write(0);\n+\tsctlr_write(0);\n+\tsctlr_write(0);\n+}\n+\n+void sctlr_rmw_multiple(void)\n+{\n+\tsctlr_rmw();\n+\tsctlr_rmw();\n+\tsctlr_rmw();\n+\tsctlr_rmw();\n+}\n+\n+void function(void)\n+{\n+\tsctlr_read_multiple();\n+\tsctlr_write_multiple();\n+\tsctlr_rmw_multiple();\n+\n+\tisb();\n+}\n+/* { dg-final { scan-ipa-dump-not \"Function found to be const\" \"modref\"  } } */"}]}