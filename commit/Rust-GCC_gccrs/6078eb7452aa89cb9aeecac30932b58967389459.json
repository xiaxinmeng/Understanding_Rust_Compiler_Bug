{"sha": "6078eb7452aa89cb9aeecac30932b58967389459", "node_id": "C_kwDOANBUbNoAKDYwNzhlYjc0NTJhYTg5Y2I5YWVlY2FjMzA5MzJiNTg5NjczODk0NTk", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2021-11-06T22:36:08Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2021-11-06T22:36:08Z"}, "message": "Fix can_be_discarded_p wrt partitioned functions.\n\ngcc/ChangeLog:\n\n\t* cgraph.h (cgraph_node::can_be_discarded_p): Do not\n\treturn true on functions from other partition.\n\ngcc/lto/ChangeLog:\n\n\tPR ipa/103070\n\tPR ipa/103058\n\t* lto-partition.c (must_not_rename): Update comment.\n\t(promote_symbol): Set resolution to LDPR_PREVAILING_DEF_IRONLY.", "tree": {"sha": "8b5eb1a8f0131a2b7af6ffd5c866bd7009a1b56c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8b5eb1a8f0131a2b7af6ffd5c866bd7009a1b56c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6078eb7452aa89cb9aeecac30932b58967389459", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6078eb7452aa89cb9aeecac30932b58967389459", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6078eb7452aa89cb9aeecac30932b58967389459", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6078eb7452aa89cb9aeecac30932b58967389459/comments", "author": null, "committer": null, "parents": [{"sha": "df2135e88a8f78c853b35246ad426b01b6d08378", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/df2135e88a8f78c853b35246ad426b01b6d08378", "html_url": "https://github.com/Rust-GCC/gccrs/commit/df2135e88a8f78c853b35246ad426b01b6d08378"}], "stats": {"total": 11, "additions": 9, "deletions": 2}, "files": [{"sha": "0a1f7c8960eb8fd77967d7fad5bf80c8a6026788", "filename": "gcc/cgraph.h", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6078eb7452aa89cb9aeecac30932b58967389459/gcc%2Fcgraph.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6078eb7452aa89cb9aeecac30932b58967389459/gcc%2Fcgraph.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcgraph.h?ref=6078eb7452aa89cb9aeecac30932b58967389459", "patch": "@@ -404,7 +404,8 @@ struct GTY((desc (\"%h.type\"), tag (\"SYMTAB_SYMBOL\"),\n   inline bool\n   can_be_discarded_p (void)\n   {\n-    return (DECL_EXTERNAL (decl)\n+    return ((DECL_EXTERNAL (decl)\n+\t     && !in_other_partition)\n \t    || ((get_comdat_group ()\n \t\t || DECL_COMMON (decl)\n \t\t || (DECL_SECTION_NAME (decl) && DECL_WEAK (decl)))"}, {"sha": "bee402181596a5e2bbd4594a87b9453fe9b7effc", "filename": "gcc/lto/lto-partition.c", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6078eb7452aa89cb9aeecac30932b58967389459/gcc%2Flto%2Flto-partition.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6078eb7452aa89cb9aeecac30932b58967389459/gcc%2Flto%2Flto-partition.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto%2Flto-partition.c?ref=6078eb7452aa89cb9aeecac30932b58967389459", "patch": "@@ -852,7 +852,9 @@ must_not_rename (symtab_node *node, const char *name)\n   /* Avoid mangling of already mangled clones. \n      ???  should have a flag whether a symbol has a 'private' name already,\n      since we produce some symbols like that i.e. for global constructors\n-     that are not really clones.  */\n+     that are not really clones.\n+     ???  it is what unique_name means.  We only need to set it when doing\n+     private symbols.  */\n   if (node->unique_name)\n     {\n       if (dump_file)\n@@ -995,6 +997,10 @@ promote_symbol (symtab_node *node)\n      defined by the non-LTO part.  */\n   privatize_symbol_name (node);\n   TREE_PUBLIC (node->decl) = 1;\n+  /* After privatization the node should not conflict with any other symbol,\n+     so it is prevailing.  This is important to keep binds_to_current_def_p\n+     to work across partitions.  */\n+  node->resolution = LDPR_PREVAILING_DEF_IRONLY;\n   DECL_VISIBILITY (node->decl) = VISIBILITY_HIDDEN;\n   DECL_VISIBILITY_SPECIFIED (node->decl) = true;\n   if (dump_file)"}]}