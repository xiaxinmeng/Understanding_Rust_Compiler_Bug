{"sha": "35f48a901dacbff644f8573553d2b1ca6d1b609c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzVmNDhhOTAxZGFjYmZmNjQ0Zjg1NzM1NTNkMmIxY2E2ZDFiNjA5Yw==", "commit": {"author": {"name": "Janne Blomqvist", "email": "jb@gcc.gnu.org", "date": "2013-11-15T22:00:36Z"}, "committer": {"name": "Janne Blomqvist", "email": "jb@gcc.gnu.org", "date": "2013-11-15T22:00:36Z"}, "message": "When file status is unknown, don't set O_CREAT when opening read-only.\n\n2013-11-15  Janne Blomqvist  <jb@gcc.gnu.org>\n\t    Jerry DeLisle  <jvdelisle@gcc.gnu.org>\n\n\tPR fortran/59108\n\t* io/unix.c (regular_file): Don't set O_CREAT when opening a file\n\tread-only with unknown status. Mask out O_CREAT when falling back\n\tto opening read-only if ACTION= is not set and read-write fails.\n\nCo-Authored-By: Jerry DeLisle <jvdelisle@gcc.gnu.org>\n\nFrom-SVN: r204864", "tree": {"sha": "285137952297d3a8123cac1f2509532a3cb644d6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/285137952297d3a8123cac1f2509532a3cb644d6"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/35f48a901dacbff644f8573553d2b1ca6d1b609c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/35f48a901dacbff644f8573553d2b1ca6d1b609c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/35f48a901dacbff644f8573553d2b1ca6d1b609c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/35f48a901dacbff644f8573553d2b1ca6d1b609c/comments", "author": null, "committer": null, "parents": [{"sha": "c02065fca15d60c9d34ca18b5718a145c4571db7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c02065fca15d60c9d34ca18b5718a145c4571db7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c02065fca15d60c9d34ca18b5718a145c4571db7"}], "stats": {"total": 28, "additions": 21, "deletions": 7}, "files": [{"sha": "c18391f106fe5245936142c5b1b5f6e35b25f2fa", "filename": "libgfortran/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/35f48a901dacbff644f8573553d2b1ca6d1b609c/libgfortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/35f48a901dacbff644f8573553d2b1ca6d1b609c/libgfortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2FChangeLog?ref=35f48a901dacbff644f8573553d2b1ca6d1b609c", "patch": "@@ -1,3 +1,11 @@\n+2013-11-15  Janne Blomqvist  <jb@gcc.gnu.org>\n+\t    Jerry DeLisle  <jvdelisle@gcc.gnu.org>\n+\n+\tPR fortran/59108\n+\t* io/unix.c (regular_file): Don't set O_CREAT when opening a file\n+\tread-only with unknown status. Mask out O_CREAT when falling back\n+\tto opening read-only if ACTION= is not set and read-write fails.\n+\n 2013-11-15  Steve Ellcey  <sellcey@mips.com>\n \n \t* configure.ac: Do not define HAVE_STRTOLD."}, {"sha": "c2bc28aed15771e22bb20d0b0553f842ef4b59f9", "filename": "libgfortran/io/unix.c", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/35f48a901dacbff644f8573553d2b1ca6d1b609c/libgfortran%2Fio%2Funix.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/35f48a901dacbff644f8573553d2b1ca6d1b609c/libgfortran%2Fio%2Funix.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fio%2Funix.c?ref=35f48a901dacbff644f8573553d2b1ca6d1b609c", "patch": "@@ -1245,7 +1245,7 @@ regular_file (st_parameter_open *opp, unit_flags *flags)\n   char path[min(PATH_MAX, opp->file_len + 1)];\n   int mode;\n   int rwflag;\n-  int crflag;\n+  int crflag, crflag2;\n   int fd;\n   int err;\n \n@@ -1297,8 +1297,6 @@ regular_file (st_parameter_open *opp, unit_flags *flags)\n     }\n #endif\n \n-  rwflag = 0;\n-\n   switch (flags->action)\n     {\n     case ACTION_READ:\n@@ -1329,15 +1327,19 @@ regular_file (st_parameter_open *opp, unit_flags *flags)\n       break;\n \n     case STATUS_UNKNOWN:\n-    case STATUS_SCRATCH:\n-      crflag = O_CREAT;\n+      if (rwflag == O_RDONLY)\n+\tcrflag = 0;\n+      else\n+\tcrflag = O_CREAT;\n       break;\n \n     case STATUS_REPLACE:\n       crflag = O_CREAT | O_TRUNC;\n       break;\n \n     default:\n+      /* Note: STATUS_SCRATCH is handled by tempfile () and should\n+\t never be seen here.  */\n       internal_error (&opp->common, \"regular_file(): Bad status\");\n     }\n \n@@ -1366,14 +1368,18 @@ regular_file (st_parameter_open *opp, unit_flags *flags)\n \n   /* retry for read-only access */\n   rwflag = O_RDONLY;\n-  fd = open (path, rwflag | crflag, mode);\n+  if (flags->status == STATUS_UNKNOWN)\n+    crflag2 = crflag & ~(O_CREAT);\n+  else\n+    crflag2 = crflag;\n+  fd = open (path, rwflag | crflag2, mode);\n   if (fd >=0)\n     {\n       flags->action = ACTION_READ;\n       return fd;\t\t/* success */\n     }\n   \n-  if (errno != EACCES)\n+  if (errno != EACCES && errno != ENOENT)\n     return fd;\t\t\t/* failure */\n \n   /* retry for write-only access */"}]}