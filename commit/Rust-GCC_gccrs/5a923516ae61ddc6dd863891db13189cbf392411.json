{"sha": "5a923516ae61ddc6dd863891db13189cbf392411", "node_id": "C_kwDOANBUbNoAKDVhOTIzNTE2YWU2MWRkYzZkZDg2Mzg5MWRiMTMxODljYmYzOTI0MTE", "commit": {"author": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2023-03-28T14:21:50Z"}, "committer": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2023-03-28T14:59:54Z"}, "message": "RISC-V: Define __riscv_v_intrinsic [PR109312]\n\nRVV intrinsic has defined a macro to identity the version of RVV\nintrinsic spec, we missed that before, thanksful we are catch this\nbefore release.\n\ngcc/ChangeLog:\n\n\tPR target/109312\n\t* config/riscv/riscv-c.cc (riscv_ext_version_value): New.\n\t(riscv_cpu_cpp_builtins): Define __riscv_v_intrinsic and\n\tminor refactor.\n\ngcc/testsuite/ChangeLog:\n\n\tPR target/109312\n\t* gcc.target/riscv/predef-__riscv_v_intrinsic.c: New test.", "tree": {"sha": "0ae36b1064983104f17804d8001287ee4612f9b9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0ae36b1064983104f17804d8001287ee4612f9b9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5a923516ae61ddc6dd863891db13189cbf392411", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a923516ae61ddc6dd863891db13189cbf392411", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5a923516ae61ddc6dd863891db13189cbf392411", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a923516ae61ddc6dd863891db13189cbf392411/comments", "author": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97383b4116ea63486eb5bfb0a7140871bed75fb4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/97383b4116ea63486eb5bfb0a7140871bed75fb4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/97383b4116ea63486eb5bfb0a7140871bed75fb4"}], "stats": {"total": 29, "additions": 25, "deletions": 4}, "files": [{"sha": "6ad562dcb8b2f078adc1bfcf9c5ea3615c95c53c", "filename": "gcc/config/riscv/riscv-c.cc", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a923516ae61ddc6dd863891db13189cbf392411/gcc%2Fconfig%2Friscv%2Friscv-c.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a923516ae61ddc6dd863891db13189cbf392411/gcc%2Fconfig%2Friscv%2Friscv-c.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-c.cc?ref=5a923516ae61ddc6dd863891db13189cbf392411", "patch": "@@ -34,6 +34,12 @@ along with GCC; see the file COPYING3.  If not see\n \n #define builtin_define(TXT) cpp_define (pfile, TXT)\n \n+static int\n+riscv_ext_version_value (unsigned major, unsigned minor)\n+{\n+  return (major * 1000000) + (minor * 1000);\n+}\n+\n /* Implement TARGET_CPU_CPP_BUILTINS.  */\n \n void\n@@ -118,7 +124,11 @@ riscv_cpu_cpp_builtins (cpp_reader *pfile)\n     builtin_define_with_int_value (\"__riscv_v_elen_fp\", 0);\n \n   if (TARGET_MIN_VLEN)\n-    builtin_define (\"__riscv_vector\");\n+    {\n+      builtin_define (\"__riscv_vector\");\n+      builtin_define_with_int_value (\"__riscv_v_intrinsic\",\n+\t\t\t\t     riscv_ext_version_value (0, 11));\n+    }\n \n   /* Define architecture extension test macros.  */\n   builtin_define_with_int_value (\"__riscv_arch_test\", 1);\n@@ -141,13 +151,13 @@ riscv_cpu_cpp_builtins (cpp_reader *pfile)\n        subset != subset_list->end ();\n        subset = subset->next)\n     {\n-      int version_value = (subset->major_version * 1000000)\n-\t\t\t   + (subset->minor_version * 1000);\n+      int version_value = riscv_ext_version_value (subset->major_version,\n+\t\t\t\t\t\t   subset->minor_version);\n       /* Special rule for zicsr and zifencei, it's used for ISA spec 2.2 or\n \t earlier.  */\n       if ((subset->name == \"zicsr\" || subset->name == \"zifencei\")\n \t  && version_value == 0)\n-\tversion_value = 2000000;\n+\tversion_value = riscv_ext_version_value (2, 0);\n \n       sprintf (buf, \"__riscv_%s\", subset->name.c_str ());\n       builtin_define_with_int_value (buf, version_value);"}, {"sha": "dbbedf54f8780699db63b77e7033b54946a9f767", "filename": "gcc/testsuite/gcc.target/riscv/predef-__riscv_v_intrinsic.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a923516ae61ddc6dd863891db13189cbf392411/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fpredef-__riscv_v_intrinsic.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a923516ae61ddc6dd863891db13189cbf392411/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fpredef-__riscv_v_intrinsic.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fpredef-__riscv_v_intrinsic.c?ref=5a923516ae61ddc6dd863891db13189cbf392411", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-march=rv64imafdcv -mabi=lp64d\" } */\n+\n+int main () {\n+\n+#if __riscv_v_intrinsic != 11000\n+#error \"__riscv_v_intrinsic\"\n+#endif\n+\n+  return 0;\n+}"}]}