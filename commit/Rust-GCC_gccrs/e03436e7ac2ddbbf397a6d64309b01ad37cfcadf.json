{"sha": "e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTAzNDM2ZTdhYzJkZGJiZjM5N2E2ZDY0MzA5YjAxYWQzN2NmY2FkZg==", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2019-05-17T19:13:04Z"}, "committer": {"name": "Thomas Schwinge", "email": "tschwinge@gcc.gnu.org", "date": "2019-05-17T19:13:04Z"}, "message": "[PR89433] Refer to OpenACC 'routine' clauses from \"omp declare target\" attribute\n\n\tgcc/c-family/\n\tPR c/89433\n\t* c-attribs.c (c_common_attribute_table): Set min_len to -1 for\n\t\"omp declare target\".\n\tgcc/c/\n\tPR c/89433\n\t* c-parser.c (c_finish_oacc_routine): Refer to OpenACC 'routine'\n\tclauses from \"omp declare target\" attribute.\n\tgcc/cp/\n\tPR c++/89433\n\t* parser.c (cp_finalize_oacc_routine): Refer to OpenACC 'routine'\n\tclauses from \"omp declare target\" attribute.\n\tgcc/fortran/\n\tPR fortran/89433\n\t* f95-lang.c (gfc_attribute_table): Set min_len to -1 for \"omp\n\tdeclare target\".\n\t* trans-decl.c (add_attributes_to_decl): Refer to OpenACC\n\t'routine' clauses from \"omp declare target\" attribute.\n\tgcc/testsuite/\n\tPR testsuite/89433\n\t* c-c++-common/goacc/classify-routine.c: Update.\n\t* gfortran.dg/goacc/classify-routine.f95: Likewise.\n\nFrom-SVN: r271343", "tree": {"sha": "22150e0e84ce3e0e987558f9ad64fc859fc24264", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/22150e0e84ce3e0e987558f9ad64fc859fc24264"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5d9a8091e2d2ad4122369a40ad3cd0d4e6131321", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5d9a8091e2d2ad4122369a40ad3cd0d4e6131321", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5d9a8091e2d2ad4122369a40ad3cd0d4e6131321"}], "stats": {"total": 66, "additions": 51, "deletions": 15}, "files": [{"sha": "50687764221bd442a1a762a1ed2bf76542a84154", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -1,3 +1,9 @@\n+2019-05-17  Thomas Schwinge  <thomas@codesourcery.com>\n+\n+\tPR c/89433\n+\t* c-attribs.c (c_common_attribute_table): Set min_len to -1 for\n+\t\"omp declare target\".\n+\n 2019-05-16  Martin Sebor  <msebor@redhat.com>\n \n         * c-attribs.c (handle_no_sanitize_attribute): Quote identifiers,"}, {"sha": "03203470955abccc1846485845a21fb9b0cda548", "filename": "gcc/c-family/c-attribs.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc-family%2Fc-attribs.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc-family%2Fc-attribs.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-attribs.c?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -437,7 +437,7 @@ const struct attribute_spec c_common_attribute_table[] =\n \t\t\t      handle_omp_declare_simd_attribute, NULL },\n   { \"simd\",\t\t      0, 1, true,  false, false, false,\n \t\t\t      handle_simd_attribute, NULL },\n-  { \"omp declare target\",     0, 0, true, false, false, false,\n+  { \"omp declare target\",     0, -1, true, false, false, false,\n \t\t\t      handle_omp_declare_target_attribute, NULL },\n   { \"omp declare target link\", 0, 0, true, false, false, false,\n \t\t\t      handle_omp_declare_target_attribute, NULL },"}, {"sha": "f0cab2e65929fe8254b3f74a610158c43cc35cc3", "filename": "gcc/c/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2FChangeLog?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -1,3 +1,9 @@\n+2019-05-17  Thomas Schwinge  <thomas@codesourcery.com>\n+\n+\tPR c/89433\n+\t* c-parser.c (c_finish_oacc_routine): Refer to OpenACC 'routine'\n+\tclauses from \"omp declare target\" attribute.\n+\n 2019-05-16  Martin Sebor  <msebor@redhat.com>\n \n         * c-decl.c (start_decl): Quote keywords, operators, and"}, {"sha": "3cbbb199bddabcd5a589f42c596dfd2eeeadcf1a", "filename": "gcc/c/c-parser.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc%2Fc-parser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fc%2Fc-parser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2Fc-parser.c?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -15904,7 +15904,7 @@ c_finish_oacc_routine (struct oacc_routine_data *data, tree fndecl,\n   /* Add an \"omp declare target\" attribute.  */\n   DECL_ATTRIBUTES (fndecl)\n     = tree_cons (get_identifier (\"omp declare target\"),\n-\t\t NULL_TREE, DECL_ATTRIBUTES (fndecl));\n+\t\t data->clauses, DECL_ATTRIBUTES (fndecl));\n \n   /* Remember that we've used this \"#pragma acc routine\".  */\n   data->fndecl_seen = true;"}, {"sha": "40622acc0ff224df32fdd0017f22f6de3d52beb6", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -1,3 +1,9 @@\n+2019-05-17  Thomas Schwinge  <thomas@codesourcery.com>\n+\n+\tPR c++/89433\n+\t* parser.c (cp_finalize_oacc_routine): Refer to OpenACC 'routine'\n+\tclauses from \"omp declare target\" attribute.\n+\n 2019-05-16  Martin Sebor  <msebor@redhat.com>\n \n         * call.c (print_z_candidate): Wrap diagnostic text in a gettext"}, {"sha": "15424b6b63372f85ddf8184aa54250d92215dc14", "filename": "gcc/cp/parser.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fcp%2Fparser.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Fcp%2Fparser.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fparser.c?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -40292,7 +40292,7 @@ cp_finalize_oacc_routine (cp_parser *parser, tree fndecl, bool is_defn)\n       /* Add an \"omp declare target\" attribute.  */\n       DECL_ATTRIBUTES (fndecl)\n \t= tree_cons (get_identifier (\"omp declare target\"),\n-\t\t     NULL_TREE, DECL_ATTRIBUTES (fndecl));\n+\t\t     parser->oacc_routine->clauses, DECL_ATTRIBUTES (fndecl));\n \n       /* Don't unset parser->oacc_routine here: we may still need it to\n \t diagnose wrong usage.  But, remember that we've used this \"#pragma acc"}, {"sha": "f09e715353bd935fcbe2fb064c1ebdb50a389b36", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -1,3 +1,11 @@\n+2019-05-17  Thomas Schwinge  <thomas@codesourcery.com>\n+\n+\tPR fortran/89433\n+\t* f95-lang.c (gfc_attribute_table): Set min_len to -1 for \"omp\n+\tdeclare target\".\n+\t* trans-decl.c (add_attributes_to_decl): Refer to OpenACC\n+\t'routine' clauses from \"omp declare target\" attribute.\n+\n 2019-05-16  Martin Sebor  <msebor@redhat.com>\n \n \t* gfortranspec.c (append_arg): Spell out the word \"argument.\""}, {"sha": "6b9f490d2bbc41df168a6897d3f7c75367663a15", "filename": "gcc/fortran/f95-lang.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ffortran%2Ff95-lang.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ffortran%2Ff95-lang.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ff95-lang.c?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -91,7 +91,7 @@ static const struct attribute_spec gfc_attribute_table[] =\n {\n   /* { name, min_len, max_len, decl_req, type_req, fn_type_req,\n        affects_type_identity, handler, exclude } */\n-  { \"omp declare target\", 0, 0, true,  false, false, false,\n+  { \"omp declare target\", 0, -1, true,  false, false, false,\n     gfc_handle_omp_declare_target_attribute, NULL },\n   { \"omp declare target link\", 0, 0, true,  false, false, false,\n     gfc_handle_omp_declare_target_attribute, NULL },"}, {"sha": "8420870a6b782c9702ef9e45291d4b2789c1558a", "filename": "gcc/fortran/trans-decl.c", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ffortran%2Ftrans-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ffortran%2Ftrans-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.c?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -1400,12 +1400,7 @@ add_attributes_to_decl (symbol_attribute sym_attr, tree list)\n \tlist = chainon (list, attr);\n       }\n \n-  if (sym_attr.omp_declare_target_link)\n-    list = tree_cons (get_identifier (\"omp declare target link\"),\n-\t\t      NULL_TREE, list);\n-  else if (sym_attr.omp_declare_target)\n-    list = tree_cons (get_identifier (\"omp declare target\"),\n-\t\t      NULL_TREE, list);\n+  tree clauses = NULL_TREE;\n \n   if (sym_attr.oacc_routine_lop != OACC_ROUTINE_LOP_NONE)\n     {\n@@ -1430,11 +1425,20 @@ add_attributes_to_decl (symbol_attribute sym_attr, tree list)\n \t  gcc_unreachable ();\n \t}\n       tree c = build_omp_clause (UNKNOWN_LOCATION, code);\n+      OMP_CLAUSE_CHAIN (c) = clauses;\n+      clauses = c;\n \n-      tree dims = oacc_build_routine_dims (c);\n+      tree dims = oacc_build_routine_dims (clauses);\n       list = oacc_replace_fn_attrib_attr (list, dims);\n     }\n \n+  if (sym_attr.omp_declare_target_link)\n+    list = tree_cons (get_identifier (\"omp declare target link\"),\n+\t\t      NULL_TREE, list);\n+  else if (sym_attr.omp_declare_target)\n+    list = tree_cons (get_identifier (\"omp declare target\"),\n+\t\t      clauses, list);\n+\n   return list;\n }\n "}, {"sha": "0f44c6d4ab0e32ae29c579e14fa5245401a25e60", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -1,3 +1,9 @@\n+2019-05-17  Thomas Schwinge  <thomas@codesourcery.com>\n+\n+\tPR testsuite/89433\n+\t* c-c++-common/goacc/classify-routine.c: Update.\n+\t* gfortran.dg/goacc/classify-routine.f95: Likewise.\n+\n 2019-05-16  Martin Sebor  <msebor@redhat.com>\n \n         * c-c++-common/Wbool-operation-1.c: Adjust text of expected diagnostics."}, {"sha": "0b9ba6ea69fc31f1313372bb9fd7118dc0b6920d", "filename": "gcc/testsuite/c-c++-common/goacc/classify-routine.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fclassify-routine.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fclassify-routine.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgoacc%2Fclassify-routine.c?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -22,10 +22,10 @@ void ROUTINE ()\n }\n \n /* Check the offloaded function's attributes.\n-   { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(omp declare target, oacc function \\\\(0 1, 1 0, 1 0\\\\)\\\\)\\\\)\" 1 \"ompexp\" } } */\n+   { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(omp declare target \\\\(worker\\\\), oacc function \\\\(0 1, 1 0, 1 0\\\\)\\\\)\\\\)\" 1 \"ompexp\" } } */\n \n /* Check the offloaded function's classification and compute dimensions (will\n    always be 1 x 1 x 1 for non-offloading compilation).\n    { dg-final { scan-tree-dump-times \"(?n)Function is OpenACC routine level 1\" 1 \"oaccdevlow\" } }\n    { dg-final { scan-tree-dump-times \"(?n)Compute dimensions \\\\\\[1, 1, 1\\\\\\]\" 1 \"oaccdevlow\" } }\n-   { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(oacc function \\\\(0 1, 1 1, 1 1\\\\), omp declare target, oacc function \\\\(0 1, 1 0, 1 0\\\\)\\\\)\\\\)\" 1 \"oaccdevlow\" } } */\n+   { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(oacc function \\\\(0 1, 1 1, 1 1\\\\), omp declare target \\\\(worker\\\\), oacc function \\\\(0 1, 1 0, 1 0\\\\)\\\\)\\\\)\" 1 \"oaccdevlow\" } } */"}, {"sha": "401d5270391e213a320a8d7e5c136a2beed89ff1", "filename": "gcc/testsuite/gfortran.dg/goacc/classify-routine.f95", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fclassify-routine.f95", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e03436e7ac2ddbbf397a6d64309b01ad37cfcadf/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fclassify-routine.f95", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgoacc%2Fclassify-routine.f95?ref=e03436e7ac2ddbbf397a6d64309b01ad37cfcadf", "patch": "@@ -21,10 +21,10 @@ subroutine ROUTINE\n end subroutine ROUTINE\n \n ! Check the offloaded function's attributes.\n-! { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(omp declare target, oacc function \\\\(0 1, 1 0, 1 0\\\\)\\\\)\\\\)\" 1 \"ompexp\" } }\n+! { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(oacc function \\\\(0 1, 1 0, 1 0\\\\), omp declare target \\\\(worker\\\\)\\\\)\\\\)\" 1 \"ompexp\" } }\n \n ! Check the offloaded function's classification and compute dimensions (will\n ! always be 1 x 1 x 1 for non-offloading compilation).\n ! { dg-final { scan-tree-dump-times \"(?n)Function is OpenACC routine level 1\" 1 \"oaccdevlow\" } }\n ! { dg-final { scan-tree-dump-times \"(?n)Compute dimensions \\\\\\[1, 1, 1\\\\\\]\" 1 \"oaccdevlow\" } }\n-! { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(oacc function \\\\(0 1, 1 1, 1 1\\\\), omp declare target, oacc function \\\\(0 1, 1 0, 1 0\\\\)\\\\)\\\\)\" 1 \"oaccdevlow\" } }\n+! { dg-final { scan-tree-dump-times \"(?n)__attribute__\\\\(\\\\(oacc function \\\\(0 1, 1 1, 1 1\\\\), omp declare target \\\\(worker\\\\)\\\\)\\\\)\" 1 \"oaccdevlow\" } }"}]}