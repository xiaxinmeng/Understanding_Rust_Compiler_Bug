{"sha": "3749c3aff6512003a61b7cf4a96eff0e8926d781", "node_id": "C_kwDOANBUbNoAKDM3NDljM2FmZjY1MTIwMDNhNjFiN2NmNGE5NmVmZjBlODkyNmQ3ODE", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-10-01T08:42:07Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-10-01T08:42:07Z"}, "message": "openmp: Avoid PLT relocations for omp_* symbols in libgomp\n\nThis patch avoids the following relocations:\nreadelf -Wr libgomp.so.1.0.0 | grep omp_\n00000000000470e0  0000020700000007 R_X86_64_JUMP_SLOT     000000000001d9d0 omp_fulfill_event@@OMP_5.0.1 + 0\n0000000000047170  000000b800000007 R_X86_64_JUMP_SLOT     000000000000e760 omp_display_env@@OMP_5.1 + 0\n00000000000471e0  000000e800000007 R_X86_64_JUMP_SLOT     000000000000f910 omp_get_initial_device@@OMP_4.5 + 0\n0000000000047280  0000019500000007 R_X86_64_JUMP_SLOT     0000000000015940 omp_get_active_level@@OMP_3.0 + 0\n00000000000472c8  0000020d00000007 R_X86_64_JUMP_SLOT     0000000000035210 omp_get_team_num@@OMP_4.0 + 0\n00000000000472f0  0000014700000007 R_X86_64_JUMP_SLOT     0000000000035200 omp_get_num_teams@@OMP_4.0 + 0\nby using ialias{,_call,_redirect} macros as needed.\n\nWe still have many acc_* PLT relocations, could somebody please fix those?\nreadelf -Wr libgomp.so.1.0.0 | grep acc_\n0000000000046fb8  000001ed00000006 R_X86_64_GLOB_DAT      0000000000036350 acc_prof_unregister@@OACC_2.5.1 + 0\n0000000000046fd8  000000a400000006 R_X86_64_GLOB_DAT      0000000000035f30 acc_prof_register@@OACC_2.5.1 + 0\n0000000000046fe0  000001d100000006 R_X86_64_GLOB_DAT      0000000000035ee0 acc_prof_lookup@@OACC_2.5.1 + 0\n0000000000047058  000001dd00000007 R_X86_64_JUMP_SLOT     0000000000031f40 acc_create_async@@OACC_2.5 + 0\n0000000000047068  0000011500000007 R_X86_64_JUMP_SLOT     000000000002fc60 acc_get_property@@OACC_2.6 + 0\n0000000000047070  000001fb00000007 R_X86_64_JUMP_SLOT     0000000000032ce0 acc_wait_all@@OACC_2.0 + 0\n0000000000047080  0000006500000007 R_X86_64_JUMP_SLOT     000000000002f990 acc_on_device@@OACC_2.0 + 0\n0000000000047088  000000ae00000007 R_X86_64_JUMP_SLOT     0000000000032140 acc_attach_async@@OACC_2.6 + 0\n0000000000047090  0000021900000007 R_X86_64_JUMP_SLOT     000000000002f550 acc_get_device_type@@OACC_2.0 + 0\n0000000000047098  000001cb00000007 R_X86_64_JUMP_SLOT     0000000000032090 acc_copyout_finalize@@OACC_2.5 + 0\n00000000000470a8  0000005200000007 R_X86_64_JUMP_SLOT     0000000000031f80 acc_copyin@@OACC_2.0 + 0\n00000000000470b8  000001ad00000007 R_X86_64_JUMP_SLOT     0000000000032030 acc_delete_finalize@@OACC_2.5 + 0\n00000000000470e8  0000010900000007 R_X86_64_JUMP_SLOT     0000000000031f00 acc_create@@OACC_2.0 + 0\n00000000000470f8  0000005900000007 R_X86_64_JUMP_SLOT     0000000000032b70 acc_wait_async@@OACC_2.0 + 0\n0000000000047110  0000013100000007 R_X86_64_JUMP_SLOT     0000000000032860 acc_async_test@@OACC_2.0 + 0\n0000000000047118  000001ff00000007 R_X86_64_JUMP_SLOT     000000000002f720 acc_get_device_num@@OACC_2.0 + 0\n0000000000047128  0000019100000007 R_X86_64_JUMP_SLOT     0000000000032020 acc_delete_async@@OACC_2.5 + 0\n0000000000047130  000001d200000007 R_X86_64_JUMP_SLOT     000000000002efa0 acc_shutdown@@OACC_2.0 + 0\n0000000000047150  000000d000000007 R_X86_64_JUMP_SLOT     0000000000031f00 acc_present_or_create@@OACC_2.0 + 0\n0000000000047188  0000019200000007 R_X86_64_JUMP_SLOT     0000000000031910 acc_is_present@@OACC_2.0 + 0\n0000000000047190  000001aa00000007 R_X86_64_JUMP_SLOT     000000000002fca0 acc_get_property_string@@OACC_2.6 + 0\n00000000000471d0  000001bf00000007 R_X86_64_JUMP_SLOT     0000000000032120 acc_update_self_async@@OACC_2.5 + 0\n0000000000047200  0000020500000007 R_X86_64_JUMP_SLOT     0000000000032e00 acc_wait_all_async@@OACC_2.0 + 0\n0000000000047208  000000a600000007 R_X86_64_JUMP_SLOT     0000000000031790 acc_deviceptr@@OACC_2.0 + 0\n0000000000047218  0000007500000007 R_X86_64_JUMP_SLOT     0000000000032000 acc_delete@@OACC_2.0 + 0\n0000000000047238  000001e900000007 R_X86_64_JUMP_SLOT     000000000002f3a0 acc_set_device_type@@OACC_2.0 + 0\n0000000000047240  000001f600000007 R_X86_64_JUMP_SLOT     000000000002ef20 acc_init@@OACC_2.0 + 0\n0000000000047248  0000018800000007 R_X86_64_JUMP_SLOT     0000000000032060 acc_copyout@@OACC_2.0 + 0\n0000000000047258  0000021f00000007 R_X86_64_JUMP_SLOT     0000000000032a80 acc_wait@@OACC_2.0 + 0\n0000000000047270  000001bc00000007 R_X86_64_JUMP_SLOT     0000000000032100 acc_update_self@@OACC_2.0 + 0\n0000000000047288  0000011400000007 R_X86_64_JUMP_SLOT     0000000000032080 acc_copyout_async@@OACC_2.5 + 0\n0000000000047290  0000013d00000007 R_X86_64_JUMP_SLOT     000000000002f850 acc_set_device_num@@OACC_2.0 + 0\n00000000000472a8  000000c500000007 R_X86_64_JUMP_SLOT     00000000000320e0 acc_update_device_async@@OACC_2.5 + 0\n00000000000472c0  0000014600000007 R_X86_64_JUMP_SLOT     0000000000031fc0 acc_copyin_async@@OACC_2.5 + 0\n00000000000472f8  0000006a00000007 R_X86_64_JUMP_SLOT     000000000002f310 acc_get_num_devices@@OACC_2.0 + 0\n0000000000047350  0000021700000007 R_X86_64_JUMP_SLOT     0000000000031f80 acc_present_or_copyin@@OACC_2.0 + 0\n0000000000047360  0000020900000007 R_X86_64_JUMP_SLOT     00000000000320c0 acc_update_device@@OACC_2.0 + 0\n0000000000047380  0000008400000007 R_X86_64_JUMP_SLOT     0000000000032950 acc_async_test_all@@OACC_2.0 + 0\n\n2021-10-01  Jakub Jelinek  <jakub@redhat.com>\n\n\t* affinity-fmt.c (omp_get_team_num, omp_get_num_teams): Add\n\tialias_redirect.\n\t* env.c (handle_omp_display_env): Use ialias_call.\n\t* icv-device.c: Move ialias right below each function.\n\t(omp_get_device_num): Use ialias_call.\n\t* fortran.c (omp_fulfill_event): Add ialias_redirect.\n\t* icv.c (omp_get_active_level): Add ialias_redirect.", "tree": {"sha": "debf17ccc76ce25d7a749cc34444172fc5b2cb9c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/debf17ccc76ce25d7a749cc34444172fc5b2cb9c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3749c3aff6512003a61b7cf4a96eff0e8926d781", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3749c3aff6512003a61b7cf4a96eff0e8926d781", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3749c3aff6512003a61b7cf4a96eff0e8926d781", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3749c3aff6512003a61b7cf4a96eff0e8926d781/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "998e434f8f9ce42842710af9e33c1b9732b22999", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/998e434f8f9ce42842710af9e33c1b9732b22999", "html_url": "https://github.com/Rust-GCC/gccrs/commit/998e434f8f9ce42842710af9e33c1b9732b22999"}], "stats": {"total": 25, "additions": 18, "deletions": 7}, "files": [{"sha": "75940b554a7a3427d0978f777e3a61b6e16066f4", "filename": "libgomp/affinity-fmt.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Faffinity-fmt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Faffinity-fmt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Faffinity-fmt.c?ref=3749c3aff6512003a61b7cf4a96eff0e8926d781", "patch": "@@ -37,6 +37,9 @@\n #include <sys/utsname.h>\n #endif\n \n+ialias_redirect (omp_get_team_num)\n+ialias_redirect (omp_get_num_teams)\n+\n bool\n gomp_print_string (const char *str, size_t len)\n {"}, {"sha": "69ce1d24ee001f786ae960c185a1092f3b966e18", "filename": "libgomp/env.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Fenv.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Fenv.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Fenv.c?ref=3749c3aff6512003a61b7cf4a96eff0e8926d781", "patch": "@@ -1416,7 +1416,7 @@ handle_omp_display_env (void)\n     gomp_error (\"Invalid value for environment variable OMP_DISPLAY_ENV\");\n \n   if (display)\n-    omp_display_env (verbose);\n+    ialias_call (omp_display_env) (verbose);\n }\n \n "}, {"sha": "d171c7992eb0f5a43a675cfe0cb1ea7fd0e4eb5e", "filename": "libgomp/fortran.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Ffortran.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Ffortran.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ffortran.c?ref=3749c3aff6512003a61b7cf4a96eff0e8926d781", "patch": "@@ -96,6 +96,7 @@ ialias_redirect (omp_destroy_allocator)\n ialias_redirect (omp_set_default_allocator)\n ialias_redirect (omp_get_default_allocator)\n ialias_redirect (omp_display_env)\n+ialias_redirect (omp_fulfill_event)\n #endif\n \n #ifndef LIBGOMP_GNU_SYMBOL_VERSIONING"}, {"sha": "709ceeb7b01f9f83d670b60c3da7a081a34bcbdf", "filename": "libgomp/icv-device.c", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Ficv-device.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Ficv-device.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ficv-device.c?ref=3749c3aff6512003a61b7cf4a96eff0e8926d781", "patch": "@@ -35,43 +35,48 @@ omp_set_default_device (int device_num)\n   icv->default_device_var = device_num >= 0 ? device_num : 0;\n }\n \n+ialias (omp_set_default_device)\n+\n int\n omp_get_default_device (void)\n {\n   struct gomp_task_icv *icv = gomp_icv (false);\n   return icv->default_device_var;\n }\n \n+ialias (omp_get_default_device)\n+\n int\n omp_get_initial_device (void)\n {\n   return gomp_get_num_devices ();\n }\n \n+ialias (omp_get_initial_device)\n+\n int\n omp_get_num_devices (void)\n {\n   return gomp_get_num_devices ();\n }\n \n+ialias (omp_get_num_devices)\n+\n int\n omp_is_initial_device (void)\n {\n   /* Hardcoded to 1 on host, should be 0 on MIC, HSAIL, PTX.  */\n   return 1;\n }\n \n+ialias (omp_is_initial_device)\n+\n int\n omp_get_device_num (void)\n {\n   /* By specification, this is equivalent to omp_get_initial_device\n      on the host.  */\n-  return omp_get_initial_device ();\n+  return ialias_call (omp_get_initial_device) ();\n }\n \n-ialias (omp_set_default_device)\n-ialias (omp_get_default_device)\n-ialias (omp_get_initial_device)\n-ialias (omp_get_num_devices)\n-ialias (omp_is_initial_device)\n ialias (omp_get_device_num)"}, {"sha": "4b4892fb35ed98431fa3c4ee3fc4ccbcbf2354de", "filename": "libgomp/icv.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Ficv.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3749c3aff6512003a61b7cf4a96eff0e8926d781/libgomp%2Ficv.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ficv.c?ref=3749c3aff6512003a61b7cf4a96eff0e8926d781", "patch": "@@ -30,6 +30,8 @@\n #include \"gomp-constants.h\"\n #include <limits.h>\n \n+ialias_redirect (omp_get_active_level)\n+\n void\n omp_set_num_threads (int n)\n {"}]}