{"sha": "d21c7dd6a2cf854da4776082cc6903acbdf8391f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDIxYzdkZDZhMmNmODU0ZGE0Nzc2MDgyY2M2OTAzYWNiZGY4MzkxZg==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2019-07-01T13:37:47Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-01T13:37:47Z"}, "message": "[Ada] Spurious error on inst. of partially defaulted formal package\n\nThis patch removes a spurious error on an instantiation whose generic\nunit has a formal package where some formal parameters are\nbox-initialiaed.  Previously the code assumed that box-initialization\nfor a formal package applied to all its formal parameters.\n\n2019-07-01  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_ch12.adb (Is_Defaulted): New predicate in\n\tCheck_Formal_Package_Intance, to skip the conformance of checks\n\ton parameters of a formal package that are defaulted,\n\ngcc/testsuite/\n\n\t* gnat.dg/generic_inst3.adb,\n\tgnat.dg/generic_inst3_kafka_lib-topic.ads,\n\tgnat.dg/generic_inst3_kafka_lib.ads,\n\tgnat.dg/generic_inst3_markets.ads,\n\tgnat.dg/generic_inst3_traits-encodables.ads,\n\tgnat.dg/generic_inst3_traits.ads: New testcase.\n\nFrom-SVN: r272883", "tree": {"sha": "bad13ae0930e056837e7a5850e4f592197534b5a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/bad13ae0930e056837e7a5850e4f592197534b5a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d21c7dd6a2cf854da4776082cc6903acbdf8391f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d21c7dd6a2cf854da4776082cc6903acbdf8391f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d21c7dd6a2cf854da4776082cc6903acbdf8391f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d21c7dd6a2cf854da4776082cc6903acbdf8391f/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6578a6bfec1ae4a6a077055ebf0024e0079b80f7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6578a6bfec1ae4a6a077055ebf0024e0079b80f7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6578a6bfec1ae4a6a077055ebf0024e0079b80f7"}], "stats": {"total": 100, "additions": 100, "deletions": 0}, "files": [{"sha": "6396196a57b7a06d4a777e57513aed6882a67fe8", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -1,3 +1,9 @@\n+2019-07-01  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_ch12.adb (Is_Defaulted): New predicate in\n+\tCheck_Formal_Package_Intance, to skip the conformance of checks\n+\ton parameters of a formal package that are defaulted,\n+\n 2019-07-01  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* checks.adb, exp_ch9.adb, exp_unst.adb, sem_ch4.adb,"}, {"sha": "9ddfc970b25b2429dd6a9c6b1bc5b965b547fa8c", "filename": "gcc/ada/sem_ch12.adb", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Fada%2Fsem_ch12.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Fada%2Fsem_ch12.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch12.adb?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -6195,6 +6195,12 @@ package body Sem_Ch12 is\n       --  Common error routine for mismatch between the parameters of the\n       --  actual instance and those of the formal package.\n \n+      function Is_Defaulted (Param : Entity_Id) return Boolean;\n+      --  If the formql package has partly box-initialized formals, skip\n+      --  conformace check for these formals. Previously the code assumed\n+      --  that boc initialization for a formal package applied to all\n+      --  its formal parameters.\n+\n       function Same_Instantiated_Constant (E1, E2 : Entity_Id) return Boolean;\n       --  The formal may come from a nested formal package, and the actual may\n       --  have been constant-folded. To determine whether the two denote the\n@@ -6245,6 +6251,32 @@ package body Sem_Ch12 is\n          end if;\n       end Check_Mismatch;\n \n+      ------------------\n+      -- Is_Defaulted --\n+      ------------------\n+\n+      function Is_Defaulted (Param : Entity_Id) return Boolean is\n+         Assoc : Node_Id;\n+      begin\n+         Assoc := First (Generic_Associations\n+                     (Parent (Associated_Formal_Package (Actual_Pack))));\n+\n+         while Present (Assoc) loop\n+            if Nkind (Assoc) = N_Others_Choice then\n+               return True;\n+\n+            elsif Nkind (Assoc) = N_Generic_Association\n+              and then Chars (Selector_Name (Assoc)) = Chars (Param)\n+            then\n+               return Box_Present (Assoc);\n+            end if;\n+\n+            Next (Assoc);\n+         end loop;\n+\n+         return False;\n+      end Is_Defaulted;\n+\n       --------------------------------\n       -- Same_Instantiated_Constant --\n       --------------------------------\n@@ -6414,6 +6446,9 @@ package body Sem_Ch12 is\n          then\n             goto Next_E;\n \n+         elsif Is_Defaulted (E1) then\n+            goto Next_E;\n+\n          elsif Is_Type (E1) then\n \n             --  Subtypes must statically match. E1, E2 are the local entities"}, {"sha": "8936a8e547aba15ff31dbb5555e0e15b6cdf4509", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -1,3 +1,12 @@\n+2019-07-01  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/generic_inst3.adb,\n+\tgnat.dg/generic_inst3_kafka_lib-topic.ads,\n+\tgnat.dg/generic_inst3_kafka_lib.ads,\n+\tgnat.dg/generic_inst3_markets.ads,\n+\tgnat.dg/generic_inst3_traits-encodables.ads,\n+\tgnat.dg/generic_inst3_traits.ads: New testcase.\n+\n 2019-07-01  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/enum_rep.adb, gnat.dg/enum_rep.ads: New testcase."}, {"sha": "545d72ee9d30740c145dc36136867a7b9c1cebec", "filename": "gcc/testsuite/gnat.dg/generic_inst3.adb", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3.adb?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -0,0 +1,20 @@\n+--  { dg-do compile }\n+\n+with Generic_Inst3_Kafka_Lib.Topic;\n+with Generic_Inst3_Traits.Encodables;\n+with Generic_Inst3_Markets;\n+\n+procedure Generic_Inst3 is\n+   generic\n+      with package Values is new Generic_Inst3_Traits.Encodables (<>);\n+      with package Topic is new Generic_Inst3_Kafka_Lib.Topic\n+          (Values => Values, others => <>);\n+   package Dummy is\n+   end Dummy;\n+\n+   package Inst is new Dummy\n+      (Values => Generic_Inst3_Markets.Data_Encodables,\n+       Topic  => Generic_Inst3_Markets.Data_Topic);\n+begin\n+   null;\n+end Generic_Inst3;"}, {"sha": "b0ff8ff28bc82a42bbb7b80ef814a0a8826fb1e6", "filename": "gcc/testsuite/gnat.dg/generic_inst3_kafka_lib-topic.ads", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_kafka_lib-topic.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_kafka_lib-topic.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_kafka_lib-topic.ads?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -0,0 +1,7 @@\n+with Generic_Inst3_Traits.Encodables;\n+generic\n+   Topic_Name : String;\n+   with package Keys is new Generic_Inst3_Traits.Encodables (<>);\n+   with package Values is new Generic_Inst3_Traits.Encodables (<>);\n+package Generic_Inst3_Kafka_Lib.Topic is\n+end Generic_Inst3_Kafka_Lib.Topic;"}, {"sha": "2fbaee9fbda4f9aa91e9f321084efaa0611bb108", "filename": "gcc/testsuite/gnat.dg/generic_inst3_kafka_lib.ads", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_kafka_lib.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_kafka_lib.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_kafka_lib.ads?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -0,0 +1,2 @@\n+package Generic_Inst3_Kafka_Lib is\n+end Generic_Inst3_Kafka_Lib;"}, {"sha": "9add3aba747b50f40db04748dc055943f71ee1d8", "filename": "gcc/testsuite/gnat.dg/generic_inst3_markets.ads", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_markets.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_markets.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_markets.ads?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -0,0 +1,10 @@\n+with Generic_Inst3_Kafka_Lib.Topic;\n+with Generic_Inst3_Traits.Encodables;\n+package Generic_Inst3_Markets is\n+   type Data_Type is null record;\n+   function Image (D : Data_Type) return String is (\"\");\n+   package Data_Encodables is new Generic_Inst3_Traits.Encodables (Data_Type, Image);\n+   package Data_Topic is new Generic_Inst3_Kafka_Lib.Topic\n+      (Keys => Data_Encodables, Values => Data_Encodables,\n+       Topic_Name => \"bla\");\n+end Generic_Inst3_Markets;"}, {"sha": "3e8814e182488a5db10e5e705df3e50612909434", "filename": "gcc/testsuite/gnat.dg/generic_inst3_traits-encodables.ads", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_traits-encodables.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_traits-encodables.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_traits-encodables.ads?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -0,0 +1,8 @@\n+with Ada.Streams;\n+generic\n+   pragma Warnings (Off, \"is not referenced\");\n+   type T (<>) is private;\n+   with function Image (Val : in T) return String;\n+package Generic_Inst3_Traits.Encodables is\n+   pragma Pure;\n+end Generic_Inst3_Traits.Encodables;"}, {"sha": "aeb2cd1c529473b0e09ab4fea0190ea1111a64e8", "filename": "gcc/testsuite/gnat.dg/generic_inst3_traits.ads", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_traits.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d21c7dd6a2cf854da4776082cc6903acbdf8391f/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_traits.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fgeneric_inst3_traits.ads?ref=d21c7dd6a2cf854da4776082cc6903acbdf8391f", "patch": "@@ -0,0 +1,3 @@\n+package Generic_Inst3_Traits is\n+   pragma Pure;\n+end Generic_Inst3_Traits;"}]}