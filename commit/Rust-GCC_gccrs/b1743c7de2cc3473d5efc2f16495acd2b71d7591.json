{"sha": "b1743c7de2cc3473d5efc2f16495acd2b71d7591", "node_id": "C_kwDOANBUbNoAKGIxNzQzYzdkZTJjYzM0NzNkNWVmYzJmMTY0OTVhY2QyYjcxZDc1OTE", "commit": {"author": {"name": "Steve Baird", "email": "baird@adacore.com", "date": "2022-05-04T23:23:40Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-06-01T08:43:18Z"}, "message": "[Ada] Another case where freezing incorrectly suppresses checks\n\nAvoid improperly suppressing checks for the wrapper subprogram that is\nbuilt when a null type extension inherits (and does not override) a\nfunction with a controlling result. This is a follow-up to other changes\nalready made on this ticket.\n\ngcc/ada/\n\n\t* exp_ch3.adb (Make_Controlling_Function_Wrappers): Set the\n\tCorresponding_Spec field of a wrapper subprogram body before\n\tanalyzing the subprogram body; the field will be set (again)\n\tduring analysis, but we need it to be set earlier.\n\t* exp_ch13.adb (Expand_N_Freeze_Entity): Add wrapper subprogram\n\tbodies to the list of declarations for which we do not want to\n\tsuppress checks.", "tree": {"sha": "d35968d31e0ea463216ec9b0cd4ed3c6e32d9c27", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d35968d31e0ea463216ec9b0cd4ed3c6e32d9c27"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b1743c7de2cc3473d5efc2f16495acd2b71d7591", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b1743c7de2cc3473d5efc2f16495acd2b71d7591", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b1743c7de2cc3473d5efc2f16495acd2b71d7591", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b1743c7de2cc3473d5efc2f16495acd2b71d7591/comments", "author": {"login": "swbaird", "id": 50751052, "node_id": "MDQ6VXNlcjUwNzUxMDUy", "avatar_url": "https://avatars.githubusercontent.com/u/50751052?v=4", "gravatar_id": "", "url": "https://api.github.com/users/swbaird", "html_url": "https://github.com/swbaird", "followers_url": "https://api.github.com/users/swbaird/followers", "following_url": "https://api.github.com/users/swbaird/following{/other_user}", "gists_url": "https://api.github.com/users/swbaird/gists{/gist_id}", "starred_url": "https://api.github.com/users/swbaird/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/swbaird/subscriptions", "organizations_url": "https://api.github.com/users/swbaird/orgs", "repos_url": "https://api.github.com/users/swbaird/repos", "events_url": "https://api.github.com/users/swbaird/events{/privacy}", "received_events_url": "https://api.github.com/users/swbaird/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "378523d4a316fa42580915a74c30aa77a0b5e85c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/378523d4a316fa42580915a74c30aa77a0b5e85c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/378523d4a316fa42580915a74c30aa77a0b5e85c"}], "stats": {"total": 19, "additions": 15, "deletions": 4}, "files": [{"sha": "d2be185aa56b4bf1d818b93cebcb397e41377f58", "filename": "gcc/ada/exp_ch13.adb", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b1743c7de2cc3473d5efc2f16495acd2b71d7591/gcc%2Fada%2Fexp_ch13.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b1743c7de2cc3473d5efc2f16495acd2b71d7591/gcc%2Fada%2Fexp_ch13.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch13.adb?ref=b1743c7de2cc3473d5efc2f16495acd2b71d7591", "patch": "@@ -626,18 +626,22 @@ package body Exp_Ch13 is\n       end if;\n \n       --  Analyze actions generated by freezing. The init_proc contains source\n-      --  expressions that may raise Constraint_Error, and the assignment\n+      --  expressions that may raise Constraint_Error, the assignment\n       --  procedure for complex types needs checks on individual component\n-      --  assignments, but all other freezing actions should be compiled with\n-      --  all checks off.\n+      --  assignments, and wrappers may need checks. Other freezing actions\n+      --  should be compiled with all checks off.\n \n       if Present (Actions (N)) then\n          Decl := First (Actions (N));\n          while Present (Decl) loop\n             if Nkind (Decl) = N_Subprogram_Body\n               and then (Is_Init_Proc (Defining_Entity (Decl))\n                           or else\n-                            Chars (Defining_Entity (Decl)) = Name_uAssign)\n+                            Chars (Defining_Entity (Decl)) = Name_uAssign\n+                          or else\n+                            (Present (Corresponding_Spec (Decl))\n+                               and then Is_Wrapper\n+                                          (Corresponding_Spec (Decl))))\n             then\n                Analyze (Decl);\n "}, {"sha": "5403f3b4f6442e974159dc75f03750a9d91f1784", "filename": "gcc/ada/exp_ch3.adb", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b1743c7de2cc3473d5efc2f16495acd2b71d7591/gcc%2Fada%2Fexp_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b1743c7de2cc3473d5efc2f16495acd2b71d7591/gcc%2Fada%2Fexp_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch3.adb?ref=b1743c7de2cc3473d5efc2f16495acd2b71d7591", "patch": "@@ -10031,6 +10031,13 @@ package body Exp_Ch3 is\n             Mutate_Ekind (Func_Id, E_Function);\n             Set_Is_Wrapper (Func_Id);\n \n+            --  Corresponding_Spec will be set again to the same value during\n+            --  analysis, but we need this information earlier.\n+            --  Expand_N_Freeze_Entity needs to know whether a subprogram body\n+            --  is a wrapper's body in order to get check suppression right.\n+\n+            Set_Corresponding_Spec (Func_Body, Func_Id);\n+\n             Override_Dispatching_Operation (Tag_Typ, Subp, New_Op => Func_Id);\n          end if;\n "}]}