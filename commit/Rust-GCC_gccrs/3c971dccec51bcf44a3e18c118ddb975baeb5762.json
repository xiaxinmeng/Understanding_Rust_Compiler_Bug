{"sha": "3c971dccec51bcf44a3e18c118ddb975baeb5762", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2M5NzFkY2NlYzUxYmNmNDRhM2UxOGMxMThkZGI5NzViYWViNTc2Mg==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2010-10-12T12:23:32Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2010-10-12T12:23:32Z"}, "message": "[multiple changes]\n\n2010-10-12  Robert Dewar  <dewar@adacore.com>\n\n\t* sem_ch6.adb (Process_PPCs): Fix error in inheriting Pre'Class when no\n\texception messages are generated.\n\t(Process_PPCs): Fix error in inheriting Pre'Class.\n\n2010-10-12  Jose Ruiz  <ruiz@adacore.com>\n\n\t* gnatcmd.adb: Use response file for GNATstack.\n\t(Check_Files): Pass the list of .ci files for GNATstack using a response\n\tfile to avoid problems with command line length.\n\tFactor out the code handling response file into a new procedure named\n\tAdd_To_Response_File.\n\n2010-10-12  Vincent Celier  <celier@adacore.com>\n\n\t* debug.adb: For gnatmake, document the meaning of -dm\n\t* make.adb (Gnatmake): If -dm is used, indicate the maximum number of\n\tsimultaneous compilations.\n\t* switch-m.adb (Scan_Make_Switches): Allow -j0, meaning as many\n\tsimultaneous compilations as the number of processors.\n\nFrom-SVN: r165367", "tree": {"sha": "2501ed9d90bad70089eaffc698ccc3c0409bf74b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2501ed9d90bad70089eaffc698ccc3c0409bf74b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3c971dccec51bcf44a3e18c118ddb975baeb5762", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3c971dccec51bcf44a3e18c118ddb975baeb5762", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3c971dccec51bcf44a3e18c118ddb975baeb5762", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3c971dccec51bcf44a3e18c118ddb975baeb5762/comments", "author": null, "committer": null, "parents": [{"sha": "cf3e10419923a5e46f21d6621425a8acd63ddeac", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cf3e10419923a5e46f21d6621425a8acd63ddeac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cf3e10419923a5e46f21d6621425a8acd63ddeac"}], "stats": {"total": 287, "additions": 162, "deletions": 125}, "files": [{"sha": "7e6bc3a3179bbd6c372c95de7129b70fd1df1a0b", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=3c971dccec51bcf44a3e18c118ddb975baeb5762", "patch": "@@ -1,3 +1,25 @@\n+2010-10-12  Robert Dewar  <dewar@adacore.com>\n+\n+\t* sem_ch6.adb (Process_PPCs): Fix error in inheriting Pre'Class when no\n+\texception messages are generated.\n+\t(Process_PPCs): Fix error in inheriting Pre'Class.\n+\n+2010-10-12  Jose Ruiz  <ruiz@adacore.com>\n+\n+\t* gnatcmd.adb: Use response file for GNATstack.\n+\t(Check_Files): Pass the list of .ci files for GNATstack using a response\n+\tfile to avoid problems with command line length.\n+\tFactor out the code handling response file into a new procedure named\n+\tAdd_To_Response_File.\n+\n+2010-10-12  Vincent Celier  <celier@adacore.com>\n+\n+\t* debug.adb: For gnatmake, document the meaning of -dm\n+\t* make.adb (Gnatmake): If -dm is used, indicate the maximum number of\n+\tsimultaneous compilations.\n+\t* switch-m.adb (Scan_Make_Switches): Allow -j0, meaning as many\n+\tsimultaneous compilations as the number of processors.\n+\n 2010-10-12  Joseph Myers  <joseph@codesourcery.com>\n \n \t* gcc-interface/Make-lang.in (ada/misc.o): Use $(OPTIONS_H)"}, {"sha": "a92542fdb9a1edb98e62db79e357c2cb10d0b464", "filename": "gcc/ada/debug.adb", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fdebug.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fdebug.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fdebug.adb?ref=3c971dccec51bcf44a3e18c118ddb975baeb5762", "patch": "@@ -198,7 +198,7 @@ package body Debug is\n    --  dj\n    --  dk\n    --  dl\n-   --  dm\n+   --  dm  Display the number of maximum simultaneous compilations\n    --  dn  Do not delete temp files created by gnatmake\n    --  do\n    --  dp  Prints the contents of the Q used by Make.Compile_Sources"}, {"sha": "f7404c5df6d80cb22d131d93b429b860a1bba2ab", "filename": "gcc/ada/gnatcmd.adb", "status": "modified", "additions": 100, "deletions": 103, "changes": 203, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fgnatcmd.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fgnatcmd.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fgnatcmd.adb?ref=3c971dccec51bcf44a3e18c118ddb975baeb5762", "patch": "@@ -319,6 +319,42 @@ procedure GNATCmd is\n       Status      : Integer;\n       Success     : Boolean;\n \n+      procedure Add_To_Response_File\n+        (File_Name : String; Check_File : Boolean := True);\n+      --  Include the file name passed as parameter in the response file for\n+      --  the tool being called. If the response file can not be written then\n+      --  the file name is passed in the parameter list of the tool. If the\n+      --  Check_File parameter is True then the procedure verifies the\n+      --  existence of the file before adding it to the response file.\n+\n+      procedure Add_To_Response_File\n+        (File_Name : String; Check_File : Boolean := True)\n+      is\n+      begin\n+         Name_Len := 0;\n+\n+         Add_Str_To_Name_Buffer (File_Name);\n+\n+         if not Check_File or else\n+           Is_Regular_File (Name_Buffer (1 .. Name_Len))\n+         then\n+            if FD /= Invalid_FD then\n+               Name_Len := Name_Len + 1;\n+               Name_Buffer (Name_Len) := ASCII.LF;\n+\n+               Status := Write (FD, Name_Buffer (1)'Address, Name_Len);\n+\n+               if Status /= Name_Len then\n+                  Osint.Fail (\"disk full\");\n+               end if;\n+            else\n+               Last_Switches.Increment_Last;\n+               Last_Switches.Table (Last_Switches.Last) :=\n+                 new String'(File_Name);\n+            end if;\n+         end if;\n+      end Add_To_Response_File;\n+\n    begin\n       --  Check if there is at least one argument that is not a switch or if\n       --  there is a -files= switch.\n@@ -363,11 +399,13 @@ procedure GNATCmd is\n       if Add_Sources then\n \n          --  For gnatcheck, gnatpp, and gnatmetric, create a temporary file\n-         --  and put the list of sources in it.\n+         --  and put the list of sources in it. For gnatstack create a\n+         --  temporary file with the list of .ci files.\n \n          if The_Command = Check  or else\n             The_Command = Pretty or else\n-            The_Command = Metric\n+            The_Command = Metric or else\n+            The_Command = Stack\n          then\n             Tempdir.Create_Temp_File (FD, Temp_File_Name);\n             Last_Switches.Increment_Last;\n@@ -377,7 +415,6 @@ procedure GNATCmd is\n \n          declare\n             Proj : Project_List;\n-            File : String_Access;\n \n          begin\n             --  Gnatstack needs to add the .ci file for the binder generated\n@@ -396,40 +433,33 @@ procedure GNATCmd is\n \n                         Main := Proj.Project.Mains;\n                         while Main /= Nil_String loop\n-                           File :=\n-                             new String'\n-                               (Get_Name_String\n-                                 (Proj.Project.Object_Directory.Name)        &\n-                                B_Start.all                                  &\n-                                MLib.Fil.Ext_To\n-                                  (Get_Name_String\n-                                     (Project_Tree.String_Elements.Table\n-                                        (Main).Value),\n-                                   \"ci\"));\n+                           Add_To_Response_File\n+                             (Get_Name_String\n+                                (Proj.Project.Object_Directory.Name) &\n+                              B_Start.all                            &\n+                              MLib.Fil.Ext_To\n+                                (Get_Name_String\n+                                   (Project_Tree.String_Elements.Table\n+                                      (Main).Value),\n+                                 \"ci\"));\n \n                            --  When looking for the .ci file for a binder\n                            --  generated file, look for both b~xxx and b__xxx\n                            --  as gprbuild always uses b__ as the prefix of\n                            --  such files.\n \n-                           if not Is_Regular_File (File.all)\n+                           if not Is_Regular_File (Name_Buffer (1 .. Name_Len))\n                              and then B_Start.all /= \"b__\"\n                            then\n-                              File :=\n-                                new String'\n-                                  (Get_Name_String\n-                                     (Proj.Project.Object_Directory.Name)    &\n-                                   \"b__\"                                     &\n-                                   MLib.Fil.Ext_To\n-                                     (Get_Name_String\n-                                        (Project_Tree.String_Elements.Table\n-                                           (Main).Value),\n-                                      \"ci\"));\n-                           end if;\n-\n-                           if Is_Regular_File (File.all) then\n-                              Last_Switches.Increment_Last;\n-                              Last_Switches.Table (Last_Switches.Last) := File;\n+                              Add_To_Response_File\n+                                (Get_Name_String\n+                                   (Proj.Project.Object_Directory.Name) &\n+                                 \"b__\"                                  &\n+                                 MLib.Fil.Ext_To\n+                                   (Get_Name_String\n+                                      (Project_Tree.String_Elements.Table\n+                                         (Main).Value),\n+                                    \"ci\"));\n                            end if;\n \n                            Main :=\n@@ -442,30 +472,27 @@ procedure GNATCmd is\n                            --  files that contains the initialization and\n                            --  finalization of the library.\n \n-                           File :=\n-                             new String'\n-                               (Get_Name_String\n-                                 (Proj.Project.Object_Directory.Name)        &\n-                                B_Start.all                                  &\n-                                Get_Name_String (Proj.Project.Library_Name)  &\n-                                \".ci\");\n+                           Add_To_Response_File\n+                             (Get_Name_String\n+                                (Proj.Project.Object_Directory.Name)      &\n+                              B_Start.all                                 &\n+                              Get_Name_String (Proj.Project.Library_Name) &\n+                              \".ci\");\n \n-                           if not Is_Regular_File (File.all) and then\n-                               B_Start.all /= \"b__\"\n-                           then\n-                              File :=\n-                                new String'\n-                                  (Get_Name_String\n-                                     (Proj.Project.Object_Directory.Name)    &\n-                                   \"b__\"                                     &\n-                                   Get_Name_String\n-                                     (Proj.Project.Library_Name)             &\n-                                   \".ci\");\n-                           end if;\n+                           --  When looking for the .ci file for a binder\n+                           --  generated file, look for both b~xxx and b__xxx\n+                           --  as gprbuild always uses b__ as the prefix of\n+                           --  such files.\n \n-                           if Is_Regular_File (File.all) then\n-                              Last_Switches.Increment_Last;\n-                              Last_Switches.Table (Last_Switches.Last) := File;\n+                           if not Is_Regular_File (Name_Buffer (1 .. Name_Len))\n+                               and then B_Start.all /= \"b__\"\n+                           then\n+                              Add_To_Response_File\n+                                (Get_Name_String\n+                                   (Proj.Project.Object_Directory.Name)      &\n+                                 \"b__\"                                       &\n+                                 Get_Name_String (Proj.Project.Library_Name) &\n+                                 \".ci\");\n                            end if;\n                         end if;\n                      end;\n@@ -574,20 +601,14 @@ procedure GNATCmd is\n                         end if;\n \n                         if not Subunit then\n-                           File :=\n-                             new String'\n-                               (Get_Name_String\n-                                 (Unit.File_Names\n-                                   (Impl).Project. Object_Directory.Name)  &\n-                                MLib.Fil.Ext_To\n-                                  (Get_Name_String\n-                                     (Unit.File_Names (Impl).Display_File),\n-                                   \"ci\"));\n-\n-                           if Is_Regular_File (File.all) then\n-                              Last_Switches.Increment_Last;\n-                              Last_Switches.Table (Last_Switches.Last) := File;\n-                           end if;\n+                           Add_To_Response_File\n+                             (Get_Name_String\n+                                (Unit.File_Names\n+                                   (Impl).Project. Object_Directory.Name) &\n+                              MLib.Fil.Ext_To\n+                                (Get_Name_String\n+                                   (Unit.File_Names (Impl).Display_File),\n+                                 \"ci\"));\n                         end if;\n                      end if;\n \n@@ -599,20 +620,14 @@ procedure GNATCmd is\n                      if Check_Project\n                           (Unit.File_Names (Spec).Project, Project)\n                      then\n-                        File :=\n-                          new String'\n-                            (Get_Name_String\n-                              (Unit.File_Names\n-                                (Spec).Project. Object_Directory.Name)     &\n-                             Dir_Separator                                 &\n-                             MLib.Fil.Ext_To\n-                               (Get_Name_String (Unit.File_Names (Spec).File),\n-                                \"ci\"));\n-\n-                        if Is_Regular_File (File.all) then\n-                           Last_Switches.Increment_Last;\n-                           Last_Switches.Table (Last_Switches.Last) := File;\n-                        end if;\n+                        Add_To_Response_File\n+                          (Get_Name_String\n+                             (Unit.File_Names\n+                                (Spec).Project. Object_Directory.Name) &\n+                           Dir_Separator                               &\n+                           MLib.Fil.Ext_To\n+                             (Get_Name_String (Unit.File_Names (Spec).File),\n+                              \"ci\"));\n                      end if;\n                   end if;\n \n@@ -627,30 +642,12 @@ procedure GNATCmd is\n                                   (Unit.File_Names (Kind).Project, Project)\n                        and then not Unit.File_Names (Kind).Locally_Removed\n                      then\n-                        Name_Len := 0;\n-                        Add_Char_To_Name_Buffer ('\"');\n-                        Add_Str_To_Name_Buffer\n-                          (Get_Name_String\n-                            (Unit.File_Names (Kind).Path.Display_Name));\n-                        Add_Char_To_Name_Buffer ('\"');\n-\n-                        if FD /= Invalid_FD then\n-                           Name_Len := Name_Len + 1;\n-                           Name_Buffer (Name_Len) := ASCII.LF;\n-                           Status :=\n-                             Write (FD, Name_Buffer (1)'Address, Name_Len);\n-\n-                           if Status /= Name_Len then\n-                              Osint.Fail (\"disk full\");\n-                           end if;\n-\n-                        else\n-                           Last_Switches.Increment_Last;\n-                           Last_Switches.Table (Last_Switches.Last) :=\n-                             new String'(Get_Name_String\n-                                          (Unit.File_Names\n-                                            (Kind).Path.Display_Name));\n-                        end if;\n+                        Add_To_Response_File\n+                          (\"\"\"\"                                         &\n+                           Get_Name_String\n+                             (Unit.File_Names (Kind).Path.Display_Name) &\n+                           \"\"\"\",\n+                           Check_File => False);\n                      end if;\n                   end loop;\n                end if;"}, {"sha": "98351649839b299e402641a61e222723ab624586", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=3c971dccec51bcf44a3e18c118ddb975baeb5762", "patch": "@@ -5321,6 +5321,11 @@ package body Make is\n          Saved_Maximum_Processes := Maximum_Processes;\n       end if;\n \n+      if Debug.Debug_Flag_M then\n+         Write_Line (\"Maximum number of simultaneous compilations =\" &\n+                     Saved_Maximum_Processes'Img);\n+      end if;\n+\n       --  Allocate as many temporary mapping file names as the maximum number\n       --  of compilations processed, for each possible project.\n "}, {"sha": "b3a906ead0b08e4c963ce3cf172ebc0c62f5b4a5", "filename": "gcc/ada/sem_ch6.adb", "status": "modified", "additions": 22, "deletions": 19, "changes": 41, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fsem_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fsem_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch6.adb?ref=3c971dccec51bcf44a3e18c118ddb975baeb5762", "patch": "@@ -8569,7 +8569,6 @@ package body Sem_Ch6 is\n       --  Now set the kind (mode) of each formal\n \n       Param_Spec := First (T);\n-\n       while Present (Param_Spec) loop\n          Formal := Defining_Identifier (Param_Spec);\n          Set_Formal_Mode (Formal);\n@@ -8791,7 +8790,7 @@ package body Sem_Ch6 is\n                if Pragma_Name (Prag) = Name_Precondition\n                  and then Class_Present (Prag)\n                then\n-                  Inherited_Precond := Grab_PPC;\n+                  Inherited_Precond := Grab_PPC (Inherited (J));\n \n                   --  No precondition so far, so establish this as the first\n \n@@ -8838,23 +8837,27 @@ package body Sem_Ch6 is\n                      --       also failed inherited precondition from bla\n                      --       ...\n \n-                     declare\n-                        New_Msg : constant Node_Id :=\n-                                    Get_Pragma_Arg\n-                                      (Last\n-                                        (Pragma_Argument_Associations\n-                                          (Inherited_Precond)));\n-                        Old_Msg : constant Node_Id :=\n-                                    Get_Pragma_Arg\n-                                      (Last\n-                                        (Pragma_Argument_Associations\n-                                          (Precond)));\n-                     begin\n-                        Start_String (Strval (Old_Msg));\n-                        Store_String_Chars (ASCII.LF & \"  also \");\n-                        Store_String_Chars (Strval (New_Msg));\n-                        Set_Strval (Old_Msg, End_String);\n-                     end;\n+                     --  Skip this if exception locations are suppressed\n+\n+                     if not Exception_Locations_Suppressed then\n+                        declare\n+                           New_Msg : constant Node_Id :=\n+                                       Get_Pragma_Arg\n+                                         (Last\n+                                            (Pragma_Argument_Associations\n+                                               (Inherited_Precond)));\n+                           Old_Msg : constant Node_Id :=\n+                                       Get_Pragma_Arg\n+                                         (Last\n+                                            (Pragma_Argument_Associations\n+                                               (Precond)));\n+                        begin\n+                           Start_String (Strval (Old_Msg));\n+                           Store_String_Chars (ASCII.LF & \"  also \");\n+                           Store_String_Chars (Strval (New_Msg));\n+                           Set_Strval (Old_Msg, End_String);\n+                        end;\n+                     end if;\n                   end if;\n                end if;\n "}, {"sha": "9576d52cecec90390c671221eb79584d872165e0", "filename": "gcc/ada/switch-m.adb", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fswitch-m.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3c971dccec51bcf44a3e18c118ddb975baeb5762/gcc%2Fada%2Fswitch-m.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fswitch-m.adb?ref=3c971dccec51bcf44a3e18c118ddb975baeb5762", "patch": "@@ -31,6 +31,8 @@ with Prj;      use Prj;\n with Prj.Env;  use Prj.Env;\n with Table;\n \n+with System.Multiprocessors; use System.Multiprocessors;\n+\n package body Switch.M is\n \n    package Normalized_Switches is new Table.Table\n@@ -751,14 +753,22 @@ package body Switch.M is\n             Ptr := Ptr + 1;\n \n             declare\n-               Max_Proc : Pos;\n+               Max_Proc : Nat;\n             begin\n-               Scan_Pos (Switch_Chars, Max, Ptr, Max_Proc, C);\n+               Scan_Nat (Switch_Chars, Max, Ptr, Max_Proc, C);\n \n                if Ptr <= Max then\n                   Bad_Switch (Switch_Chars);\n \n                else\n+                  if Max_Proc = 0 then\n+                     Max_Proc := Nat (Number_Of_CPUs);\n+\n+                     if Max_Proc = 0 then\n+                        Max_Proc := 1;\n+                     end if;\n+                  end if;\n+\n                   Maximum_Processes := Positive (Max_Proc);\n                end if;\n             end;"}]}