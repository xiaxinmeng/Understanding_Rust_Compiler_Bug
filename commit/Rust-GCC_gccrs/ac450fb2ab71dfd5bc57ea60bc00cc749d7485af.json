{"sha": "ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWM0NTBmYjJhYjcxZGZkNWJjNTdlYTYwYmMwMGNjNzQ5ZDc0ODVhZg==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2018-05-23T10:23:02Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-05-23T10:23:02Z"}, "message": "[Ada] Missing legality check on iterator over formal container\n\nThis patch adds a check on an iterator over a GNAT-specific formal container,\nwhen the iterator specification includes a subtype indication that must be\ncompatible with the element type of the container.\n\n2018-05-23  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_ch5.adb (Analyze_Iterator_Specification): If a subtype indication\n\tis present, verify its legality when the domain of iteration is a\n\tGNAT-specific formal container, as is already done for arrays and\n\tpredefined containers.\n\ngcc/testsuite/\n\n\t* gnat.dg/iter1.adb, gnat.dg/iter1.ads: New testcase.\n\nFrom-SVN: r260587", "tree": {"sha": "32492f4adda4534d18fcf83808558ded4ad908cf", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/32492f4adda4534d18fcf83808558ded4ad908cf"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "fd82aeff6d4338a3b9f280e423ec5236ae0fc510", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fd82aeff6d4338a3b9f280e423ec5236ae0fc510", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fd82aeff6d4338a3b9f280e423ec5236ae0fc510"}], "stats": {"total": 108, "additions": 77, "deletions": 31}, "files": [{"sha": "e101c99efc82266ed918e436faa0fd82aab0adf2", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "patch": "@@ -1,3 +1,10 @@\n+2018-05-23  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_ch5.adb (Analyze_Iterator_Specification): If a subtype indication\n+\tis present, verify its legality when the domain of iteration is a\n+\tGNAT-specific formal container, as is already done for arrays and\n+\tpredefined containers.\n+\n 2018-05-23  Yannick Moy  <moy@adacore.com>\n \n \t* sem_util.adb (Enclosing_Declaration): Fix the case of a named number"}, {"sha": "b8a222a0ba39bdb670aa5395bf54701fb813de05", "filename": "gcc/ada/sem_ch5.adb", "status": "modified", "additions": 38, "deletions": 31, "changes": 69, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Fada%2Fsem_ch5.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Fada%2Fsem_ch5.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch5.adb?ref=ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "patch": "@@ -2063,11 +2063,25 @@ package body Sem_Ch5 is\n       --  indicator, verify that the container type has an Iterate aspect that\n       --  implements the reversible iterator interface.\n \n+      procedure Check_Subtype_Indication (Comp_Type : Entity_Id);\n+      --  If a subtype indication is present, verify that it is consistent\n+      --  with the component type of the array or container name.\n+\n       function Get_Cursor_Type (Typ : Entity_Id) return Entity_Id;\n       --  For containers with Iterator and related aspects, the cursor is\n       --  obtained by locating an entity with the proper name in the scope\n       --  of the type.\n \n+      --  Local variables\n+\n+      Def_Id    : constant Node_Id    := Defining_Identifier (N);\n+      Iter_Name : constant Node_Id    := Name (N);\n+      Loc       : constant Source_Ptr := Sloc (N);\n+      Subt      : constant Node_Id    := Subtype_Indication (N);\n+\n+      Bas       : Entity_Id := Empty;  -- initialize to prevent warning\n+      Typ       : Entity_Id;\n+\n       -----------------------------\n       -- Check_Reverse_Iteration --\n       -----------------------------\n@@ -2091,6 +2105,26 @@ package body Sem_Ch5 is\n          end if;\n       end Check_Reverse_Iteration;\n \n+      -------------------------------\n+      --  Check_Subtype_Indication --\n+      -------------------------------\n+\n+      procedure Check_Subtype_Indication (Comp_Type : Entity_Id) is\n+      begin\n+         if Present (Subt)\n+           and then (not Covers (Base_Type ((Bas)), Comp_Type)\n+                      or else not Subtypes_Statically_Match (Bas, Comp_Type))\n+         then\n+            if Is_Array_Type (Typ) then\n+               Error_Msg_N\n+                 (\"subtype indication does not match component type\", Subt);\n+            else\n+               Error_Msg_N\n+                 (\"subtype indication does not match element type\", Subt);\n+            end if;\n+         end if;\n+      end Check_Subtype_Indication;\n+\n       ---------------------\n       -- Get_Cursor_Type --\n       ---------------------\n@@ -2127,16 +2161,6 @@ package body Sem_Ch5 is\n          return Etype (Ent);\n       end Get_Cursor_Type;\n \n-      --  Local variables\n-\n-      Def_Id    : constant Node_Id    := Defining_Identifier (N);\n-      Iter_Name : constant Node_Id    := Name (N);\n-      Loc       : constant Source_Ptr := Sloc (N);\n-      Subt      : constant Node_Id    := Subtype_Indication (N);\n-\n-      Bas : Entity_Id := Empty;  -- initialize to prevent warning\n-      Typ : Entity_Id;\n-\n    --   Start of processing for Analyze_Iterator_Specification\n \n    begin\n@@ -2394,15 +2418,7 @@ package body Sem_Ch5 is\n                   & \"component of a mutable object\", N);\n             end if;\n \n-            if Present (Subt)\n-              and then\n-                (Base_Type (Bas) /= Base_Type (Component_Type (Typ))\n-                  or else\n-                    not Subtypes_Statically_Match (Bas, Component_Type (Typ)))\n-            then\n-               Error_Msg_N\n-                 (\"subtype indication does not match component type\", Subt);\n-            end if;\n+            Check_Subtype_Indication (Component_Type (Typ));\n \n          --  Here we have a missing Range attribute\n \n@@ -2452,6 +2468,8 @@ package body Sem_Ch5 is\n                   end if;\n                end;\n \n+               Check_Subtype_Indication (Etype (Def_Id));\n+\n             --  For a predefined container, The type of the loop variable is\n             --  the Iterator_Element aspect of the container type.\n \n@@ -2477,18 +2495,7 @@ package body Sem_Ch5 is\n                      Cursor_Type := Get_Cursor_Type (Typ);\n                      pragma Assert (Present (Cursor_Type));\n \n-                     --  If subtype indication was given, verify that it covers\n-                     --  the element type of the container.\n-\n-                     if Present (Subt)\n-                       and then (not Covers (Bas, Etype (Def_Id))\n-                                  or else not Subtypes_Statically_Match\n-                                                (Bas, Etype (Def_Id)))\n-                     then\n-                        Error_Msg_N\n-                          (\"subtype indication does not match element type\",\n-                           Subt);\n-                     end if;\n+                     Check_Subtype_Indication (Etype (Def_Id));\n \n                      --  If the container has a variable indexing aspect, the\n                      --  element is a variable and is modifiable in the loop."}, {"sha": "f0cd8a2cf4a2b64389b153c3e607cdab74c462a1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "patch": "@@ -1,3 +1,7 @@\n+2018-05-23  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/iter1.adb, gnat.dg/iter1.ads: New testcase.\n+\n 2018-05-23  Hristian Kirtchev  <kirtchev@adacore.com>\n \n \t* gnat.dg/elab5.adb, gnat.dg/elab5_pkg.adb, gnat.dg/elab5_pkg.ads: New"}, {"sha": "a0a69cf90181e709b8d27eeec86270e05e1087eb", "filename": "gcc/testsuite/gnat.dg/iter1.adb", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Ftestsuite%2Fgnat.dg%2Fiter1.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Ftestsuite%2Fgnat.dg%2Fiter1.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fiter1.adb?ref=ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "patch": "@@ -0,0 +1,20 @@\n+--  { dg-do compile }\n+\n+with Ada.Text_IO;\n+\n+package body Iter1 is\n+\n+   type Table is array (Integer range <>) of Float;\n+   My_Table : Table := (1.0, 2.0, 3.0);\n+\n+   procedure Dummy (L : My_Lists.List) is\n+   begin\n+      for Item : Boolean of L loop --  { dg-error \"subtype indication does not match element type\" }\n+         Ada.Text_IO.Put_Line (Integer'Image (Item));\n+      end loop;\n+\n+      for Item : Boolean of My_Table loop --  { dg-error \"subtype indication does not match component type\" }\n+         null;\n+      end loop;\n+   end;\n+end Iter1;"}, {"sha": "8329f756fef4e28156b0d19ea90cabebe8fa8c5b", "filename": "gcc/testsuite/gnat.dg/iter1.ads", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Ftestsuite%2Fgnat.dg%2Fiter1.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ac450fb2ab71dfd5bc57ea60bc00cc749d7485af/gcc%2Ftestsuite%2Fgnat.dg%2Fiter1.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fiter1.ads?ref=ac450fb2ab71dfd5bc57ea60bc00cc749d7485af", "patch": "@@ -0,0 +1,8 @@\n+with Ada.Containers.Formal_Doubly_Linked_Lists;\n+\n+package Iter1 is\n+   package My_Lists is new Ada.Containers.Formal_Doubly_Linked_Lists\n+     (Element_Type => Integer);\n+\n+   procedure Dummy (L : My_Lists.List);\n+end Iter1;"}]}