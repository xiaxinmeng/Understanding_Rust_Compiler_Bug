{"sha": "4527ea2ed93d705b05a01a63561839748655505c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDUyN2VhMmVkOTNkNzA1YjA1YTAxYTYzNTYxODM5NzQ4NjU1NTA1Yw==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2019-08-19T08:36:17Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-08-19T08:36:17Z"}, "message": "[Ada] Improve placement of warning on formals of generic subprograms\n\nThis patch modifies the handling of warnings on unused formal parameters\nof generic subprograms. Previously such warnings were placed on the\nformal appearing in the subprogram declaration, in contrast with\nwarnings on non-generic subprograms, where the warning is placed on the\ncorresponding entity in the body of the subprogram. This patch makes the\nhandling of both cases uniform. It is preferable to place the warning in\nthe body because this also provides a better suggestion for the\nplacement of an Unreferenced pragma to suppress the warning when desired.\n\n2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n\ngcc/ada/\n\n\t* sem_warn.adb (Check_References, Generic_Body_Formal): When a\n\tformal parameter of a generic subprogram is not referenced in\n\tthe body, place the corresponding warning on the corresponding\n\tentity in the specification of the generic body, as is done for\n\tnon-generic subprograms.\n\ngcc/testsuite/\n\n\t* gnat.dg/warn28.adb, gnat.dg/warn28.ads: New testcase.\n\nFrom-SVN: r274649", "tree": {"sha": "e92044a4a16697a30563c5db57d5082d4a1acf2d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e92044a4a16697a30563c5db57d5082d4a1acf2d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4527ea2ed93d705b05a01a63561839748655505c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4527ea2ed93d705b05a01a63561839748655505c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4527ea2ed93d705b05a01a63561839748655505c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4527ea2ed93d705b05a01a63561839748655505c/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "dafa2ae46c9f0d95821fd365e8c554008b934819", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dafa2ae46c9f0d95821fd365e8c554008b934819", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dafa2ae46c9f0d95821fd365e8c554008b934819"}], "stats": {"total": 104, "additions": 103, "deletions": 1}, "files": [{"sha": "64f3cbb7c37397dc38c0ab6362df92c13f8713ca", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=4527ea2ed93d705b05a01a63561839748655505c", "patch": "@@ -1,3 +1,11 @@\n+2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* sem_warn.adb (Check_References, Generic_Body_Formal): When a\n+\tformal parameter of a generic subprogram is not referenced in\n+\tthe body, place the corresponding warning on the corresponding\n+\tentity in the specification of the generic body, as is done for\n+\tnon-generic subprograms.\n+\n 2019-08-19  Bob Duff  <duff@adacore.com>\n \n \t* errout.ads (Size_Too_Small_Message): New constant."}, {"sha": "ca6515c3bcda19c4098752b5e3c3aa8d21ef8ffa", "filename": "gcc/ada/sem_warn.adb", "status": "modified", "additions": 46, "deletions": 1, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Fada%2Fsem_warn.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Fada%2Fsem_warn.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_warn.adb?ref=4527ea2ed93d705b05a01a63561839748655505c", "patch": "@@ -818,6 +818,14 @@ package body Sem_Warn is\n       --  For an entry formal entity from an entry declaration, find the\n       --  corresponding body formal from the given accept statement.\n \n+      function Generic_Body_Formal (E : Entity_Id) return Entity_Id;\n+      --  Warnings on unused formals of subprograms are placed on the entity\n+      --  in the subprogram body, which seems preferable because it suggests\n+      --  a better codefix for GPS. The analysis of generic subprogram bodies\n+      --  uses a different circuitry, so the choice for the proper placement\n+      --  of the warning in the generic case takes place here, by finding the\n+      --  body entity that corresponds to a formal in a spec.\n+\n       procedure May_Need_Initialized_Actual (Ent : Entity_Id);\n       --  If an entity of a generic type has default initialization, then the\n       --  corresponding actual type should be fully initialized, or else there\n@@ -876,6 +884,35 @@ package body Sem_Warn is\n          raise Program_Error;\n       end Body_Formal;\n \n+      -------------------------\n+      -- Generic_Body_Formal --\n+      -------------------------\n+\n+      function Generic_Body_Formal (E : Entity_Id) return Entity_Id is\n+         Gen_Decl : constant Node_Id   := Unit_Declaration_Node (Scope (E));\n+         Gen_Body : constant Entity_Id := Corresponding_Body (Gen_Decl);\n+         Form     : Entity_Id;\n+\n+      begin\n+         if No (Gen_Body) then\n+            return E;\n+\n+         else\n+            Form := First_Entity (Gen_Body);\n+            while Present (Form) loop\n+               if Chars (Form) = Chars (E) then\n+                  return Form;\n+               end if;\n+\n+               Next_Entity (Form);\n+            end loop;\n+         end if;\n+\n+         --  Should never fall through, should always find a match\n+\n+         raise Program_Error;\n+      end Generic_Body_Formal;\n+\n       ---------------------------------\n       -- May_Need_Initialized_Actual --\n       ---------------------------------\n@@ -1688,7 +1725,15 @@ package body Sem_Warn is\n                   elsif not Warnings_Off_E1\n                     and then not Has_Junk_Name (E1)\n                   then\n-                     Unreferenced_Entities.Append (E1);\n+                     if Is_Formal (E1)\n+                       and then Nkind (Unit_Declaration_Node (Scope (E1)))\n+                         = N_Generic_Subprogram_Declaration\n+                     then\n+                        Unreferenced_Entities.Append\n+                          (Generic_Body_Formal (E1));\n+                     else\n+                        Unreferenced_Entities.Append (E1);\n+                     end if;\n                   end if;\n                end if;\n "}, {"sha": "f3cff77d8e8ec17da6d20a5922c671f5ee0cdc41", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=4527ea2ed93d705b05a01a63561839748655505c", "patch": "@@ -1,3 +1,7 @@\n+2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* gnat.dg/warn28.adb, gnat.dg/warn28.ads: New testcase.\n+\n 2019-08-19  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/rep_clause9.adb: New testcase."}, {"sha": "c397dda81f22fcb765faa3cb60d60e25857b43b1", "filename": "gcc/testsuite/gnat.dg/warn28.adb", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Ftestsuite%2Fgnat.dg%2Fwarn28.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Ftestsuite%2Fgnat.dg%2Fwarn28.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fwarn28.adb?ref=4527ea2ed93d705b05a01a63561839748655505c", "patch": "@@ -0,0 +1,36 @@\n+--  { dg-do compile }\n+--  { dg-options \"-gnatwa\" }\n+\n+package body Warn28 is\n+\n+   function Id (X : Integer) return Integer is (2 * X);\n+\n+   procedure TheProcedure1 (TheParameter : in Integer)\n+   is\n+   X : Integer;\n+   begin\n+\n+      X := Id (TheParameter);\n+      if X < 3 then\n+         X := X ** 3;\n+      end if;\n+   end TheProcedure1;\n+\n+   procedure Junk (It : Integer) is  --  { dg-warning \"formal parameter \\\"It\\\" is not referenced\" }\n+      X : Integer := Id (34);\n+   begin\n+      if X < 3 then\n+         X := X ** 3;\n+      end if;\n+   end;\n+\n+   procedure TheProcedure (TheParameter : in Integer)  --  { dg-warning \"formal parameter \\\"TheParameter\\\" is not referenced\" }\n+   is\n+\n+   begin\n+\n+      null;\n+\n+   end TheProcedure;\n+\n+end Warn28;"}, {"sha": "c06c33e05919807c22a0c34fa268426b174c30d5", "filename": "gcc/testsuite/gnat.dg/warn28.ads", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Ftestsuite%2Fgnat.dg%2Fwarn28.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4527ea2ed93d705b05a01a63561839748655505c/gcc%2Ftestsuite%2Fgnat.dg%2Fwarn28.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgnat.dg%2Fwarn28.ads?ref=4527ea2ed93d705b05a01a63561839748655505c", "patch": "@@ -0,0 +1,9 @@\n+package Warn28 is\n+\n+   procedure TheProcedure1 (TheParameter : in Integer);\n+   procedure Junk (It : Integer);\n+\n+   generic\n+   procedure TheProcedure (TheParameter : in Integer);\n+\n+end Warn28;"}]}