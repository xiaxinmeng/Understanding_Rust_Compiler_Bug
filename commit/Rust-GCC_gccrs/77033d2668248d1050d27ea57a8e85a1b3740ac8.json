{"sha": "77033d2668248d1050d27ea57a8e85a1b3740ac8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzcwMzNkMjY2ODI0OGQxMDUwZDI3ZWE1N2E4ZTg1YTFiMzc0MGFjOA==", "commit": {"author": {"name": "Tim Shen", "email": "timshen@google.com", "date": "2015-01-22T05:02:38Z"}, "committer": {"name": "Tim Shen", "email": "timshen@gcc.gnu.org", "date": "2015-01-22T05:02:38Z"}, "message": "re PR libstdc++/64649 (regex_traits::lookup_classname() only works with random access iterators)\n\n\tPR libstdc++/64649\n\t* include/bits/regex.tcc (regex_traits<>::lookup_collatename,\n\tregex_traits<>::lookup_classname): Correctly narrow input chars.\n\t* testsuite/28_regex/traits/wchar_t/user_defined.cc: New testcase.\n\nFrom-SVN: r219986", "tree": {"sha": "90302357b43d6ab8e2367e5fa7e0b3b492326363", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/90302357b43d6ab8e2367e5fa7e0b3b492326363"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/77033d2668248d1050d27ea57a8e85a1b3740ac8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/77033d2668248d1050d27ea57a8e85a1b3740ac8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/77033d2668248d1050d27ea57a8e85a1b3740ac8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/77033d2668248d1050d27ea57a8e85a1b3740ac8/comments", "author": {"login": "timshen91", "id": 1157432, "node_id": "MDQ6VXNlcjExNTc0MzI=", "avatar_url": "https://avatars.githubusercontent.com/u/1157432?v=4", "gravatar_id": "", "url": "https://api.github.com/users/timshen91", "html_url": "https://github.com/timshen91", "followers_url": "https://api.github.com/users/timshen91/followers", "following_url": "https://api.github.com/users/timshen91/following{/other_user}", "gists_url": "https://api.github.com/users/timshen91/gists{/gist_id}", "starred_url": "https://api.github.com/users/timshen91/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/timshen91/subscriptions", "organizations_url": "https://api.github.com/users/timshen91/orgs", "repos_url": "https://api.github.com/users/timshen91/repos", "events_url": "https://api.github.com/users/timshen91/events{/privacy}", "received_events_url": "https://api.github.com/users/timshen91/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "fa3340ec8f4d26bba4efa5095c8a2a142f34b8bc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fa3340ec8f4d26bba4efa5095c8a2a142f34b8bc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fa3340ec8f4d26bba4efa5095c8a2a142f34b8bc"}], "stats": {"total": 40, "additions": 37, "deletions": 3}, "files": [{"sha": "099ad8b853a2ca6a5760638fa4fb1b128ad558f8", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/77033d2668248d1050d27ea57a8e85a1b3740ac8/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/77033d2668248d1050d27ea57a8e85a1b3740ac8/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=77033d2668248d1050d27ea57a8e85a1b3740ac8", "patch": "@@ -1,3 +1,10 @@\n+2015-01-22  Tim Shen  <timshen@google.com>\n+\n+\tPR libstdc++/64649\n+\t* include/bits/regex.tcc (regex_traits<>::lookup_collatename,\n+\tregex_traits<>::lookup_classname): Correctly narrow input chars.\n+\t* testsuite/28_regex/traits/wchar_t/user_defined.cc: New testcase.\n+\n 2015-01-21  Jonathan Wakely  <jwakely@redhat.com>\n \n \t* config/abi/pre/gnu.ver: Use [jmy] for size_t parameters."}, {"sha": "aad56e08c8c4aeeb5c891f43a1200dedb94208df", "filename": "libstdc++-v3/include/bits/regex.tcc", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/77033d2668248d1050d27ea57a8e85a1b3740ac8/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fregex.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/77033d2668248d1050d27ea57a8e85a1b3740ac8/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fregex.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fregex.tcc?ref=77033d2668248d1050d27ea57a8e85a1b3740ac8", "patch": "@@ -269,7 +269,10 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \t  \"DEL\",\n \t};\n \n-      string __s(__first, __last);\n+      string __s;\n+      for (; __first != __last; ++__first)\n+\t__s += __fctyp.narrow(*__first, 0);\n+\n       for (const auto& __it : __collatenames)\n \tif (__s == __it)\n \t  return string_type(1, __fctyp.widen(\n@@ -311,8 +314,8 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n       };\n \n       string __s;\n-      for (auto __cur = __first; __cur != __last; ++__cur)\n-\t__s += __fctyp.narrow(__fctyp.tolower(*__cur), '?');\n+      for (; __first != __last; ++__first)\n+\t__s += __fctyp.narrow(__fctyp.tolower(*__first), 0);\n \n       for (const auto& __it : __classnames)\n \tif (__s == __it.first)"}, {"sha": "8c686beaf1f7b79c92be702f2ec8a2cbcc8781be", "filename": "libstdc++-v3/testsuite/28_regex/traits/wchar_t/user_defined.cc", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/77033d2668248d1050d27ea57a8e85a1b3740ac8/libstdc%2B%2B-v3%2Ftestsuite%2F28_regex%2Ftraits%2Fwchar_t%2Fuser_defined.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/77033d2668248d1050d27ea57a8e85a1b3740ac8/libstdc%2B%2B-v3%2Ftestsuite%2F28_regex%2Ftraits%2Fwchar_t%2Fuser_defined.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F28_regex%2Ftraits%2Fwchar_t%2Fuser_defined.cc?ref=77033d2668248d1050d27ea57a8e85a1b3740ac8", "patch": "@@ -55,8 +55,32 @@ test01()\n   VERIFY(!regex_match(L\"\\u2029\", re));\n }\n \n+struct MyCtype : std::ctype<wchar_t>\n+{\n+  char\n+  do_narrow(wchar_t c, char dflt) const override\n+  {\n+    if (c >= 256)\n+      return dflt;\n+    return ((char)c)+1;\n+  }\n+};\n+\n+void\n+test02()\n+{\n+  std::locale loc(std::locale(), new MyCtype);\n+  std::regex_traits<wchar_t> traits;\n+  traits.imbue(loc);\n+  wchar_t wch = L'p';\n+  VERIFY(traits.lookup_collatename(&wch, &wch+1) == L\"q\");\n+  std::wstring ws = L\"chfhs\"; // chars of \"digit\" shifted by 1.\n+  VERIFY(traits.lookup_classname(ws.begin(), ws.end()) != 0);\n+}\n+\n int main()\n {\n   test01();\n+  test02();\n   return 0;\n }"}]}