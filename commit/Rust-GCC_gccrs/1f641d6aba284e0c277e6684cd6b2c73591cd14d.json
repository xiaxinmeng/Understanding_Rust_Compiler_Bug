{"sha": "1f641d6aba284e0c277e6684cd6b2c73591cd14d", "node_id": "C_kwDOANBUbNoAKDFmNjQxZDZhYmEyODRlMGMyNzdlNjY4NGNkNmIyYzczNTkxY2QxNGQ", "commit": {"author": {"name": "Wilco Dijkstra", "email": "wilco.dijkstra@arm.com", "date": "2023-02-10T17:41:05Z"}, "committer": {"name": "Wilco Dijkstra", "email": "wilco.dijkstra@arm.com", "date": "2023-03-24T16:51:26Z"}, "message": "libatomic: Fix SEQ_CST 128-bit atomic load [PR108891]\n\nThe LSE2 ifunc for 16-byte atomic load requires a barrier before the LDP -\nwithout it, it effectively has Load-AcquirePC semantics similar to LDAPR,\nwhich is less restrictive than what __ATOMIC_SEQ_CST requires.  This patch\nfixes this and adds comments to make it easier to see which sequence is\nused for each case.  Use a load/store exclusive loop for store to simplify\ntesting memory ordering is correct (it is slightly faster too).\n\nlibatomic/\n\tPR libgcc/108891\n\t* config/linux/aarch64/atomic_16.S: Fix libat_load_16_i1.\n\tAdd comments describing the memory order.", "tree": {"sha": "d977709ea8d2607e7465f92ed8b19b9c57776803", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d977709ea8d2607e7465f92ed8b19b9c57776803"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1f641d6aba284e0c277e6684cd6b2c73591cd14d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1f641d6aba284e0c277e6684cd6b2c73591cd14d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1f641d6aba284e0c277e6684cd6b2c73591cd14d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1f641d6aba284e0c277e6684cd6b2c73591cd14d/comments", "author": {"login": "Wilco1", "id": 58446312, "node_id": "MDQ6VXNlcjU4NDQ2MzEy", "avatar_url": "https://avatars.githubusercontent.com/u/58446312?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Wilco1", "html_url": "https://github.com/Wilco1", "followers_url": "https://api.github.com/users/Wilco1/followers", "following_url": "https://api.github.com/users/Wilco1/following{/other_user}", "gists_url": "https://api.github.com/users/Wilco1/gists{/gist_id}", "starred_url": "https://api.github.com/users/Wilco1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Wilco1/subscriptions", "organizations_url": "https://api.github.com/users/Wilco1/orgs", "repos_url": "https://api.github.com/users/Wilco1/repos", "events_url": "https://api.github.com/users/Wilco1/events{/privacy}", "received_events_url": "https://api.github.com/users/Wilco1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Wilco1", "id": 58446312, "node_id": "MDQ6VXNlcjU4NDQ2MzEy", "avatar_url": "https://avatars.githubusercontent.com/u/58446312?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Wilco1", "html_url": "https://github.com/Wilco1", "followers_url": "https://api.github.com/users/Wilco1/followers", "following_url": "https://api.github.com/users/Wilco1/following{/other_user}", "gists_url": "https://api.github.com/users/Wilco1/gists{/gist_id}", "starred_url": "https://api.github.com/users/Wilco1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Wilco1/subscriptions", "organizations_url": "https://api.github.com/users/Wilco1/orgs", "repos_url": "https://api.github.com/users/Wilco1/repos", "events_url": "https://api.github.com/users/Wilco1/events{/privacy}", "received_events_url": "https://api.github.com/users/Wilco1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "243fa4883cf6fccaaafddcc82e6b58843c82fb30", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/243fa4883cf6fccaaafddcc82e6b58843c82fb30", "html_url": "https://github.com/Rust-GCC/gccrs/commit/243fa4883cf6fccaaafddcc82e6b58843c82fb30"}], "stats": {"total": 189, "additions": 115, "deletions": 74}, "files": [{"sha": "05439ce394b9653c9bcb582761ff7aaa7c8f9643", "filename": "libatomic/config/linux/aarch64/atomic_16.S", "status": "modified", "additions": 115, "deletions": 74, "changes": 189, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1f641d6aba284e0c277e6684cd6b2c73591cd14d/libatomic%2Fconfig%2Flinux%2Faarch64%2Fatomic_16.S", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1f641d6aba284e0c277e6684cd6b2c73591cd14d/libatomic%2Fconfig%2Flinux%2Faarch64%2Fatomic_16.S", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libatomic%2Fconfig%2Flinux%2Faarch64%2Fatomic_16.S?ref=1f641d6aba284e0c277e6684cd6b2c73591cd14d", "patch": "@@ -72,63 +72,72 @@ name:\t\t\t\t\\\n \n ENTRY (libat_load_16_i1)\n \tcbnz\tw1, 1f\n+\n+\t/* RELAXED.  */\n \tldp\tres0, res1, [x0]\n \tret\n 1:\n-\tcmp\tw1, ACQUIRE\n-\tb.hi\t2f\n+\tcmp\tw1, SEQ_CST\n+\tb.eq\t2f\n+\n+\t/* ACQUIRE/CONSUME (Load-AcquirePC semantics).  */\n \tldp\tres0, res1, [x0]\n \tdmb\tishld\n \tret\n-2:\n+\n+\t/* SEQ_CST.  */\n+2:\tldar\ttmp0, [x0]\t/* Block reordering with Store-Release instr.  */\n \tldp\tres0, res1, [x0]\n-\tdmb\tish\n+\tdmb\tishld\n \tret\n END (libat_load_16_i1)\n \n \n ENTRY (libat_store_16_i1)\n \tcbnz\tw4, 1f\n+\n+\t/* RELAXED.  */\n \tstp\tin0, in1, [x0]\n \tret\n-1:\n-\tdmb\tish\n-\tstp\tin0, in1, [x0]\n-\tcmp\tw4, SEQ_CST\n-\tbeq\t2f\n-\tret\n-2:\n-\tdmb\tish\n+\n+\t/* RELEASE/SEQ_CST.  */\n+1:\tldaxp\txzr, tmp0, [x0]\n+\tstlxp\tw4, in0, in1, [x0]\n+\tcbnz\tw4, 1b\n \tret\n END (libat_store_16_i1)\n \n \n ENTRY (libat_exchange_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tstxp\tw4, in0, in1, [x5]\n \tcbnz\tw4, 1b\n \tret\n 2:\n \tcmp\tw4, ACQUIRE\n \tb.hi\t4f\n-3:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME.  */\n+3:\tldaxp\tres0, res1, [x5]\n \tstxp\tw4, in0, in1, [x5]\n \tcbnz\tw4, 3b\n \tret\n 4:\n \tcmp\tw4, RELEASE\n \tb.ne\t6f\n-5:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELEASE.  */\n+5:\tldxp\tres0, res1, [x5]\n \tstlxp\tw4, in0, in1, [x5]\n \tcbnz\tw4, 5b\n \tret\n-6:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQ_REL/SEQ_CST.  */\n+6:\tldaxp\tres0, res1, [x5]\n \tstlxp\tw4, in0, in1, [x5]\n \tcbnz\tw4, 6b\n \tret\n@@ -142,6 +151,8 @@ ENTRY (libat_compare_exchange_16_i1)\n \tcbz\tw4, 2f\n \tcmp\tw4, RELEASE\n \tb.hs\t3f\n+\n+\t/* ACQUIRE/CONSUME.  */\n \tcaspa\texp0, exp1, in0, in1, [x0]\n 0:\n \tcmp\texp0, tmp0\n@@ -153,31 +164,36 @@ ENTRY (libat_compare_exchange_16_i1)\n \tstp\texp0, exp1, [x1]\n \tmov\tx0, 0\n \tret\n-2:\n-\tcasp\texp0, exp1, in0, in1, [x0]\n+\n+\t/* RELAXED.  */\n+2:\tcasp\texp0, exp1, in0, in1, [x0]\n \tb\t0b\n-3:\n-\tb.hi\t4f\n+\n+\t/* RELEASE.  */\n+3:\tb.hi\t4f\n \tcaspl\texp0, exp1, in0, in1, [x0]\n \tb\t0b\n-4:\n-\tcaspal\texp0, exp1, in0, in1, [x0]\n+\n+\t/* ACQ_REL/SEQ_CST.  */\n+4:\tcaspal\texp0, exp1, in0, in1, [x0]\n \tb\t0b\n END (libat_compare_exchange_16_i1)\n \n \n ENTRY (libat_fetch_add_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tadds\ttmplo, reslo, inlo\n \tadc\ttmphi, reshi, inhi\n \tstxp\tw4, tmp0, tmp1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \tadds\ttmplo, reslo, inlo\n \tadc\ttmphi, reshi, inhi\n \tstlxp\tw4, tmp0, tmp1, [x5]\n@@ -189,15 +205,17 @@ END (libat_fetch_add_16_i1)\n ENTRY (libat_add_fetch_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tadds\treslo, reslo, inlo\n \tadc\treshi, reshi, inhi\n \tstxp\tw4, res0, res1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \tadds\treslo, reslo, inlo\n \tadc\treshi, reshi, inhi\n \tstlxp\tw4, res0, res1, [x5]\n@@ -209,15 +227,17 @@ END (libat_add_fetch_16_i1)\n ENTRY (libat_fetch_sub_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tsubs\ttmplo, reslo, inlo\n \tsbc\ttmphi, reshi, inhi\n \tstxp\tw4, tmp0, tmp1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \tsubs\ttmplo, reslo, inlo\n \tsbc\ttmphi, reshi, inhi\n \tstlxp\tw4, tmp0, tmp1, [x5]\n@@ -229,15 +249,17 @@ END (libat_fetch_sub_16_i1)\n ENTRY (libat_sub_fetch_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tsubs\treslo, reslo, inlo\n \tsbc\treshi, reshi, inhi\n \tstxp\tw4, res0, res1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \tsubs\treslo, reslo, inlo\n \tsbc\treshi, reshi, inhi\n \tstlxp\tw4, res0, res1, [x5]\n@@ -249,15 +271,17 @@ END (libat_sub_fetch_16_i1)\n ENTRY (libat_fetch_or_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \torr\ttmp0, res0, in0\n \torr\ttmp1, res1, in1\n \tstxp\tw4, tmp0, tmp1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \torr\ttmp0, res0, in0\n \torr\ttmp1, res1, in1\n \tstlxp\tw4, tmp0, tmp1, [x5]\n@@ -269,15 +293,17 @@ END (libat_fetch_or_16_i1)\n ENTRY (libat_or_fetch_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \torr\tres0, res0, in0\n \torr\tres1, res1, in1\n \tstxp\tw4, res0, res1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \torr\tres0, res0, in0\n \torr\tres1, res1, in1\n \tstlxp\tw4, res0, res1, [x5]\n@@ -289,15 +315,17 @@ END (libat_or_fetch_16_i1)\n ENTRY (libat_fetch_and_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tand\ttmp0, res0, in0\n \tand\ttmp1, res1, in1\n \tstxp\tw4, tmp0, tmp1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \tand\ttmp0, res0, in0\n \tand\ttmp1, res1, in1\n \tstlxp\tw4, tmp0, tmp1, [x5]\n@@ -309,15 +337,17 @@ END (libat_fetch_and_16_i1)\n ENTRY (libat_and_fetch_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \tand\tres0, res0, in0\n \tand\tres1, res1, in1\n \tstxp\tw4, res0, res1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \tand\tres0, res0, in0\n \tand\tres1, res1, in1\n \tstlxp\tw4, res0, res1, [x5]\n@@ -329,15 +359,17 @@ END (libat_and_fetch_16_i1)\n ENTRY (libat_fetch_xor_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \teor\ttmp0, res0, in0\n \teor\ttmp1, res1, in1\n \tstxp\tw4, tmp0, tmp1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \teor\ttmp0, res0, in0\n \teor\ttmp1, res1, in1\n \tstlxp\tw4, tmp0, tmp1, [x5]\n@@ -349,15 +381,17 @@ END (libat_fetch_xor_16_i1)\n ENTRY (libat_xor_fetch_16_i1)\n \tmov\tx5, x0\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \teor\tres0, res0, in0\n \teor\tres1, res1, in1\n \tstxp\tw4, res0, res1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \teor\tres0, res0, in0\n \teor\tres1, res1, in1\n \tstlxp\tw4, res0, res1, [x5]\n@@ -371,15 +405,17 @@ ENTRY (libat_fetch_nand_16_i1)\n \tmvn\tin0, in0\n \tmvn\tin1, in1\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \torn\ttmp0, in0, res0\n \torn\ttmp1, in1, res1\n \tstxp\tw4, tmp0, tmp1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \torn\ttmp0, in0, res0\n \torn\ttmp1, in1, res1\n \tstlxp\tw4, tmp0, tmp1, [x5]\n@@ -393,15 +429,17 @@ ENTRY (libat_nand_fetch_16_i1)\n \tmvn\tin0, in0\n \tmvn\tin1, in1\n \tcbnz\tw4, 2f\n-1:\n-\tldxp\tres0, res1, [x5]\n+\n+\t/* RELAXED.  */\n+1:\tldxp\tres0, res1, [x5]\n \torn\tres0, in0, res0\n \torn\tres1, in1, res1\n \tstxp\tw4, res0, res1, [x5]\n \tcbnz\tw4, 1b\n \tret\n-2:\n-\tldaxp\tres0, res1, [x5]\n+\n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n+2:\tldaxp\tres0, res1, [x5]\n \torn\tres0, in0, res0\n \torn\tres1, in1, res1\n \tstlxp\tw4, res0, res1, [x5]\n@@ -413,9 +451,12 @@ END (libat_nand_fetch_16_i1)\n ENTRY (libat_test_and_set_16_i1)\n \tmov\tw2, 1\n \tcbnz\tw1, 2f\n+\n+\t/* RELAXED.  */\n \tswpb\tw0, w2, [x0]\n \tret\n \n+\t/* ACQUIRE/CONSUME/RELEASE/ACQ_REL/SEQ_CST.  */\n 2:\tswpalb\tw0, w2, [x0]\n \tret\n END (libat_test_and_set_16_i1)"}]}