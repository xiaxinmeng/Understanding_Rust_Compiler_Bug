{"sha": "426a04b84f4fed696149d8ba980dd48c6eb49de7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDI2YTA0Yjg0ZjRmZWQ2OTYxNDlkOGJhOTgwZGQ0OGM2ZWI0OWRlNw==", "commit": {"author": {"name": "Alan Modra", "email": "amodra@gmail.com", "date": "2018-11-26T23:53:56Z"}, "committer": {"name": "Alan Modra", "email": "amodra@gcc.gnu.org", "date": "2018-11-26T23:53:56Z"}, "message": "[RS6000] Use config/linux.h for powerpc*-*-linux*\n\nUsing the macros in config/linux.h rather than duplicating them helps\nstop future bitrot, and repairs existing bitrot (4 choices for libc in\nlinux.h, fewer in the rs6000 files not that it matters much).  Also\nfixes the fact that __gnu_linux__ was always defined rather than just\nwhen glibc was the libc of choice.\n\n\t* config.gcc (powerpc*-*-linux*): Add linux.h to tm_file.\n\t* config/rs6000/linux.h (TARGET_OS_CPP_BUILTINS): Use\n\tGNU_USER_TARGET_OS_CPP_BUILTINS.\n\t(RS6000_ABI_NAME): Define.\n\t* config/rs6000/linux64.h (TARGET_OS_CPP_BUILTINS): Use\n\tGNU_USER_TARGET_OS_CPP_BUILTINS.\n\t(MUSL_DYNAMIC_LINKER32): Undef before defining.\n\t(UCLIBC_DYNAMIC_LINKER32, UCLIBC_DYNAMIC_LINKER64): Don't define.\n\t(CHOOSE_DYNAMIC_LINKER): Don't define.\n\t(GNU_USER_DYNAMIC_LINKER32, GNU_USER_DYNAMIC_LINKER64): Don't define.\n\t* config/rs6000/sysv4.h (MUSL_DYNAMIC_LINKER): Undef before defining.\n\t(CHOOSE_DYNAMIC_LINKER, GNU_USER_DYNAMIC_LINKER): Only define when\n\tnot already defined.\n\t(CPP_OS_LINUX_SPEC): Remove defines and asserts handled by\n\tTARGET_OS_CPP_BUILTINS.\n\nFrom-SVN: r266493", "tree": {"sha": "6abb571436a639bca50edc790eb111d91f0a0329", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6abb571436a639bca50edc790eb111d91f0a0329"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/426a04b84f4fed696149d8ba980dd48c6eb49de7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/426a04b84f4fed696149d8ba980dd48c6eb49de7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/426a04b84f4fed696149d8ba980dd48c6eb49de7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/426a04b84f4fed696149d8ba980dd48c6eb49de7/comments", "author": {"login": "amodra", "id": 6006325, "node_id": "MDQ6VXNlcjYwMDYzMjU=", "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amodra", "html_url": "https://github.com/amodra", "followers_url": "https://api.github.com/users/amodra/followers", "following_url": "https://api.github.com/users/amodra/following{/other_user}", "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}", "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amodra/subscriptions", "organizations_url": "https://api.github.com/users/amodra/orgs", "repos_url": "https://api.github.com/users/amodra/repos", "events_url": "https://api.github.com/users/amodra/events{/privacy}", "received_events_url": "https://api.github.com/users/amodra/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "2426ee774baaea8d4a447229830ac0f31c69ab25", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2426ee774baaea8d4a447229830ac0f31c69ab25", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2426ee774baaea8d4a447229830ac0f31c69ab25"}], "stats": {"total": 78, "additions": 41, "deletions": 37}, "files": [{"sha": "19a802c6c7200725b6733452326e06ae5e893b65", "filename": "gcc/ChangeLog", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=426a04b84f4fed696149d8ba980dd48c6eb49de7", "patch": "@@ -1,3 +1,21 @@\n+2018-11-27  Alan Modra  <amodra@gmail.com>\n+\n+\t* config.gcc (powerpc*-*-linux*): Add linux.h to tm_file.\n+\t* config/rs6000/linux.h (TARGET_OS_CPP_BUILTINS): Use\n+\tGNU_USER_TARGET_OS_CPP_BUILTINS.\n+\t(RS6000_ABI_NAME): Define.\n+\t* config/rs6000/linux64.h (TARGET_OS_CPP_BUILTINS): Use\n+\tGNU_USER_TARGET_OS_CPP_BUILTINS.\n+\t(MUSL_DYNAMIC_LINKER32): Undef before defining.\n+\t(UCLIBC_DYNAMIC_LINKER32, UCLIBC_DYNAMIC_LINKER64): Don't define.\n+\t(CHOOSE_DYNAMIC_LINKER): Don't define.\n+\t(GNU_USER_DYNAMIC_LINKER32, GNU_USER_DYNAMIC_LINKER64): Don't define.\n+\t* config/rs6000/sysv4.h (MUSL_DYNAMIC_LINKER): Undef before defining.\n+\t(CHOOSE_DYNAMIC_LINKER, GNU_USER_DYNAMIC_LINKER): Only define when\n+\tnot already defined.\n+\t(CPP_OS_LINUX_SPEC): Remove defines and asserts handled by\n+\tTARGET_OS_CPP_BUILTINS.\n+\n 2018-11-26  Jozef Lawrynowicz  <jozef.l@mittosystems.com>\n \n \t* doc/sourcebuild.texi: Document check_effective_target_newlib_nano_io."}, {"sha": "00906fc477dae42284a175fb9915b8bbce18be79", "filename": "gcc/config.gcc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig.gcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig.gcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig.gcc?ref=426a04b84f4fed696149d8ba980dd48c6eb49de7", "patch": "@@ -2643,7 +2643,7 @@ powerpc*-*-linux*spe*)\n \ttm_file=\"${tm_file} powerpcspe/linuxspe.h powerpcspe/e500.h\"\n \t;;\n powerpc*-*-linux*)\n-\ttm_file=\"${tm_file} dbxelf.h elfos.h gnu-user.h freebsd-spec.h rs6000/sysv4.h\"\n+\ttm_file=\"${tm_file} dbxelf.h elfos.h gnu-user.h linux.h freebsd-spec.h rs6000/sysv4.h\"\n \textra_options=\"${extra_options} rs6000/sysv4.opt\"\n \ttmake_file=\"${tmake_file} rs6000/t-fprules rs6000/t-ppccomm\"\n \textra_objs=\"$extra_objs rs6000-linux.o\""}, {"sha": "29653c1345573bb43f39147f824adf6ff411f630", "filename": "gcc/config/rs6000/linux.h", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig%2Frs6000%2Flinux.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig%2Frs6000%2Flinux.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Flinux.h?ref=426a04b84f4fed696149d8ba980dd48c6eb49de7", "patch": "@@ -46,15 +46,17 @@\n #define TARGET_LIBC_HAS_FUNCTION linux_libc_has_function\n \n #undef  TARGET_OS_CPP_BUILTINS\n-#define TARGET_OS_CPP_BUILTINS()\t\t\\\n-  do\t\t\t\t\t\t\\\n-    {\t\t\t\t\t\t\\\n-      builtin_define_std (\"PPC\");\t\t\\\n-      builtin_define_std (\"powerpc\");\t\t\\\n-      builtin_assert (\"cpu=powerpc\");\t\t\\\n-      builtin_assert (\"machine=powerpc\");\t\\\n-      TARGET_OS_SYSV_CPP_BUILTINS ();\t\t\\\n-    }\t\t\t\t\t\t\\\n+#define TARGET_OS_CPP_BUILTINS()\t\t\t\\\n+  do\t\t\t\t\t\t\t\\\n+    {\t\t\t\t\t\t\t\\\n+      if (strcmp (rs6000_abi_name, \"linux\") == 0)\t\\\n+\tGNU_USER_TARGET_OS_CPP_BUILTINS();\t\t\\\n+      builtin_define_std (\"PPC\");\t\t\t\\\n+      builtin_define_std (\"powerpc\");\t\t\t\\\n+      builtin_assert (\"cpu=powerpc\");\t\t\t\\\n+      builtin_assert (\"machine=powerpc\");\t\t\\\n+      TARGET_OS_SYSV_CPP_BUILTINS ();\t\t\t\\\n+    }\t\t\t\t\t\t\t\\\n   while (0)\n \n #define GNU_USER_TARGET_D_OS_VERSIONS()\t\t\\\n@@ -126,6 +128,9 @@\n #define RELOCATABLE_NEEDS_FIXUP \\\n   (rs6000_isa_flags & rs6000_isa_flags_explicit & OPTION_MASK_RELOCATABLE)\n \n+#undef\tRS6000_ABI_NAME\n+#define\tRS6000_ABI_NAME \"linux\"\n+\n #ifdef TARGET_LIBC_PROVIDES_SSP\n /* ppc32 glibc provides __stack_chk_guard in -0x7008(2).  */\n #define TARGET_THREAD_SSP_OFFSET\t-0x7008"}, {"sha": "b1818b43cf465005993b666399e15f6d3815e0c1", "filename": "gcc/config/rs6000/linux64.h", "status": "modified", "additions": 4, "deletions": 21, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig%2Frs6000%2Flinux64.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig%2Frs6000%2Flinux64.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Flinux64.h?ref=426a04b84f4fed696149d8ba980dd48c6eb49de7", "patch": "@@ -369,6 +369,8 @@ extern int dot_symbols;\n #define TARGET_OS_CPP_BUILTINS()\t\t\t\\\n   do\t\t\t\t\t\t\t\\\n     {\t\t\t\t\t\t\t\\\n+      if (strcmp (rs6000_abi_name, \"linux\") == 0)\t\\\n+\tGNU_USER_TARGET_OS_CPP_BUILTINS();\t\t\\\n       if (TARGET_64BIT)\t\t\t\t\t\\\n \t{\t\t\t\t\t\t\\\n \t  builtin_define (\"__PPC__\");\t\t\t\\\n@@ -438,32 +440,13 @@ extern int dot_symbols;\n \":%(dynamic_linker_prefix)/lib64/ld64.so.1}\"\n #endif\n \n+#undef MUSL_DYNAMIC_LINKER32\n #define MUSL_DYNAMIC_LINKER32 \\\n   \"/lib/ld-musl-powerpc\" MUSL_DYNAMIC_LINKER_E \"%{msoft-float:-sf}.so.1\"\n+#undef MUSL_DYNAMIC_LINKER64\n #define MUSL_DYNAMIC_LINKER64 \\\n   \"/lib/ld-musl-powerpc64\" MUSL_DYNAMIC_LINKER_E \"%{msoft-float:-sf}.so.1\"\n \n-#define UCLIBC_DYNAMIC_LINKER32 \"/lib/ld-uClibc.so.0\"\n-#define UCLIBC_DYNAMIC_LINKER64 \"/lib/ld64-uClibc.so.0\"\n-#if DEFAULT_LIBC == LIBC_UCLIBC\n-#define CHOOSE_DYNAMIC_LINKER(G, U, M) \\\n-  \"%{mglibc:\" G \";:%{mmusl:\" M \";:\" U \"}}\"\n-#elif DEFAULT_LIBC == LIBC_GLIBC\n-#define CHOOSE_DYNAMIC_LINKER(G, U, M) \\\n-  \"%{muclibc:\" U \";:%{mmusl:\" M \";:\" G \"}}\"\n-#elif DEFAULT_LIBC == LIBC_MUSL\n-#define CHOOSE_DYNAMIC_LINKER(G, U, M) \\\n-  \"%{mglibc:\" G \";:%{muclibc:\" U \";:\" M \"}}\"\n-#else\n-#error \"Unsupported DEFAULT_LIBC\"\n-#endif\n-#define GNU_USER_DYNAMIC_LINKER32 \\\n-  CHOOSE_DYNAMIC_LINKER (GLIBC_DYNAMIC_LINKER32, UCLIBC_DYNAMIC_LINKER32, \\\n-\t\t\t MUSL_DYNAMIC_LINKER32)\n-#define GNU_USER_DYNAMIC_LINKER64 \\\n-  CHOOSE_DYNAMIC_LINKER (GLIBC_DYNAMIC_LINKER64, UCLIBC_DYNAMIC_LINKER64, \\\n-\t\t\t MUSL_DYNAMIC_LINKER64)\n-\n #undef  DEFAULT_ASM_ENDIAN\n #if (TARGET_DEFAULT & MASK_LITTLE_ENDIAN)\n #define DEFAULT_ASM_ENDIAN \" -mlittle\""}, {"sha": "73541af3e69a9a72488ce3adb76732af68b3bf6e", "filename": "gcc/config/rs6000/sysv4.h", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig%2Frs6000%2Fsysv4.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/426a04b84f4fed696149d8ba980dd48c6eb49de7/gcc%2Fconfig%2Frs6000%2Fsysv4.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Fsysv4.h?ref=426a04b84f4fed696149d8ba980dd48c6eb49de7", "patch": "@@ -786,8 +786,10 @@ ENDIAN_SELECT(\" -mbig\", \" -mlittle\", DEFAULT_ASM_ENDIAN)\n \n #define GLIBC_DYNAMIC_LINKER \"/lib/ld.so.1\"\n #define UCLIBC_DYNAMIC_LINKER \"/lib/ld-uClibc.so.0\"\n+#undef MUSL_DYNAMIC_LINKER\n #define MUSL_DYNAMIC_LINKER \\\n   \"/lib/ld-musl-powerpc\" MUSL_DYNAMIC_LINKER_E \"%{msoft-float:-sf}.so.1\"\n+#ifndef GNU_USER_DYNAMIC_LINKER\n #if DEFAULT_LIBC == LIBC_UCLIBC\n #define CHOOSE_DYNAMIC_LINKER(G, U, M) \\\n   \"%{mglibc:\" G \";:%{mmusl:\" M \";:\" U \"}}\"\n@@ -803,6 +805,7 @@ ENDIAN_SELECT(\" -mbig\", \" -mlittle\", DEFAULT_ASM_ENDIAN)\n #define GNU_USER_DYNAMIC_LINKER \\\n   CHOOSE_DYNAMIC_LINKER (GLIBC_DYNAMIC_LINKER, UCLIBC_DYNAMIC_LINKER, \\\n \t\t\t MUSL_DYNAMIC_LINKER)\n+#endif\n \n #define LINK_OS_LINUX_SPEC \"-m elf32ppclinux %{!shared: %{!static: \\\n   %{rdynamic:-export-dynamic} \\\n@@ -812,12 +815,7 @@ ENDIAN_SELECT(\" -mbig\", \" -mlittle\", DEFAULT_ASM_ENDIAN)\n # define LINK_EH_SPEC \"%{!static|static-pie:--eh-frame-hdr} \"\n #endif\n \n-#define CPP_OS_LINUX_SPEC \"-D__unix__ -D__gnu_linux__ -D__linux__ \\\n-%{!undef:\t\t\t\t\t\t\t  \\\n-  %{!ansi:\t\t\t\t\t\t\t  \\\n-    %{!std=*:-Dunix -D__unix -Dlinux -D__linux}\t\t\t  \\\n-    %{std=gnu*:-Dunix -D__unix -Dlinux -D__linux}}}\t\t  \\\n--Asystem=linux -Asystem=unix -Asystem=posix %{pthread:-D_REENTRANT}\"\n+#define CPP_OS_LINUX_SPEC \"%{pthread:-D_REENTRANT}\"\n \n /* NetBSD support.  */\n #define LIB_NETBSD_SPEC \"\\"}]}