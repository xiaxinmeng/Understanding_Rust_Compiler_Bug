{"sha": "57706dd7e001d8302b596521217827855324e748", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NTc3MDZkZDdlMDAxZDgzMDJiNTk2NTIxMjE3ODI3ODU1MzI0ZTc0OA==", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2021-01-06T07:11:57Z"}, "committer": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2021-01-06T07:26:10Z"}, "message": "gcc-changelog: workaround for utf8 filenames\n\ncontrib/ChangeLog:\n\n\t* gcc-changelog/git_commit.py: Add decode_path function.\n\t* gcc-changelog/git_email.py: Use it in order to solve\n\tutf8 encoding filename issues.\n\t* gcc-changelog/git_repository.py: Likewise.\n\t* gcc-changelog/test_email.py: Test it.", "tree": {"sha": "feeaa5162dd2fd4f0dfa4452d9694414857a39db", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/feeaa5162dd2fd4f0dfa4452d9694414857a39db"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/57706dd7e001d8302b596521217827855324e748", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/57706dd7e001d8302b596521217827855324e748", "html_url": "https://github.com/Rust-GCC/gccrs/commit/57706dd7e001d8302b596521217827855324e748", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/57706dd7e001d8302b596521217827855324e748/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac3966e315ada63eb379d560a012fa77c3909155", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ac3966e315ada63eb379d560a012fa77c3909155", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ac3966e315ada63eb379d560a012fa77c3909155"}], "stats": {"total": 41, "additions": 26, "deletions": 15}, "files": [{"sha": "ee1973371be47315dccdb1dbdd177482f35e3c44", "filename": "contrib/gcc-changelog/git_commit.py", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Fgit_commit.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Fgit_commit.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Fgit_commit.py?ref=57706dd7e001d8302b596521217827855324e748", "patch": "@@ -174,6 +174,24 @@\n DATE_FORMAT = '%Y-%m-%d'\n \n \n+def decode_path(path):\n+    # When core.quotepath is true (default value), utf8 chars are encoded like:\n+    # \"b/ko\\304\\215ka.txt\"\n+    #\n+    # The upstream bug is fixed:\n+    # https://github.com/gitpython-developers/GitPython/issues/1099\n+    #\n+    # but we still need a workaround for older versions of the library.\n+    # Please take a look at the explanation of the transformation:\n+    # https://stackoverflow.com/questions/990169/how-do-convert-unicode-escape-sequences-to-unicode-characters-in-a-python-string\n+\n+    if path.startswith('\"') and path.endswith('\"'):\n+        return (path.strip('\"').encode('utf8').decode('unicode-escape')\n+                .encode('latin-1').decode('utf8'))\n+    else:\n+        return path\n+\n+\n class Error:\n     def __init__(self, message, line=None):\n         self.message = message\n@@ -303,14 +321,6 @@ def __init__(self, info, strict=True, commit_to_info_hook=None):\n                                      'separately from normal commits'))\n             return\n \n-        # check for an encoded utf-8 filename\n-        hint = 'git config --global core.quotepath false'\n-        for modified, _ in self.info.modified_files:\n-            if modified.startswith('\"') or modified.endswith('\"'):\n-                self.errors.append(Error('Quoted UTF8 filename, please set: '\n-                                         f'\"{hint}\"', modified))\n-                return\n-\n         all_are_ignored = (len(project_files) + len(ignored_files)\n                            == len(self.info.modified_files))\n         self.parse_lines(all_are_ignored)"}, {"sha": "00ad00458f407758b6b42bc9e642974f6e8e997e", "filename": "contrib/gcc-changelog/git_email.py", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Fgit_email.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Fgit_email.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Fgit_email.py?ref=57706dd7e001d8302b596521217827855324e748", "patch": "@@ -22,7 +22,7 @@\n \n from dateutil.parser import parse\n \n-from git_commit import GitCommit, GitInfo\n+from git_commit import GitCommit, GitInfo, decode_path\n \n from unidiff import PatchSet, PatchedFile\n \n@@ -52,8 +52,8 @@ def __init__(self, filename, strict=False):\n         modified_files = []\n         for f in diff:\n             # Strip \"a/\" and \"b/\" prefixes\n-            source = f.source_file[2:]\n-            target = f.target_file[2:]\n+            source = decode_path(f.source_file)[2:]\n+            target = decode_path(f.target_file)[2:]\n \n             if f.is_added_file:\n                 t = 'A'"}, {"sha": "a0e293d756d8b82d9229ae15b2f25066b8631d4e", "filename": "contrib/gcc-changelog/git_repository.py", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Fgit_repository.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Fgit_repository.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Fgit_repository.py?ref=57706dd7e001d8302b596521217827855324e748", "patch": "@@ -26,7 +26,7 @@\n     print('  Debian, Ubuntu: python3-git')\n     exit(1)\n \n-from git_commit import GitCommit, GitInfo\n+from git_commit import GitCommit, GitInfo, decode_path\n \n \n def parse_git_revisions(repo_path, revisions, strict=True):\n@@ -51,11 +51,11 @@ def commit_to_info(commit):\n                     # Consider that renamed files are two operations:\n                     # the deletion of the original name\n                     # and the addition of the new one.\n-                    modified_files.append((file.a_path, 'D'))\n+                    modified_files.append((decode_path(file.a_path), 'D'))\n                     t = 'A'\n                 else:\n                     t = 'M'\n-                modified_files.append((file.b_path, t))\n+                modified_files.append((decode_path(file.b_path), t))\n \n             date = datetime.utcfromtimestamp(c.committed_date)\n             author = '%s  <%s>' % (c.author.name, c.author.email)"}, {"sha": "5db56caef9e16a97cf7bcd4ed63f0e94dc19dd63", "filename": "contrib/gcc-changelog/test_email.py", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Ftest_email.py", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/57706dd7e001d8302b596521217827855324e748/contrib%2Fgcc-changelog%2Ftest_email.py", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/contrib%2Fgcc-changelog%2Ftest_email.py?ref=57706dd7e001d8302b596521217827855324e748", "patch": "@@ -402,4 +402,5 @@ def test_unicode_chars_in_filename(self):\n \n     def test_bad_unicode_chars_in_filename(self):\n         email = self.from_patch_glob('0001-Add-horse2.patch')\n-        assert email.errors[0].message.startswith('Quoted UTF8 filename')\n+        assert not email.errors\n+        assert email.changelog_entries[0].files == ['kon\u00ed\u010dek.txt']"}]}