{"sha": "dbe0163146c0c078d39d586bc3ff14a767904c2d", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGJlMDE2MzE0NmMwYzA3OGQzOWQ1ODZiYzNmZjE0YTc2NzkwNGMyZA==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2008-08-06T08:32:32Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2008-08-06T08:32:32Z"}, "message": "g-awk.adb (Finalize): Do not use directly objects of the type in the finalization routine to prevent...\n\n2008-08-06  Ed Schonberg  <schonberg@adacore.com>\n\n\t* g-awk.adb (Finalize): Do not use directly objects of the type in the\n\tfinalization routine to prevent elaboration order anomalies in new\n\tfinalization scheme.\n\nFrom-SVN: r138772", "tree": {"sha": "9b0a9cb59a650c84ff494f56db6e04a1fd09b533", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9b0a9cb59a650c84ff494f56db6e04a1fd09b533"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dbe0163146c0c078d39d586bc3ff14a767904c2d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbe0163146c0c078d39d586bc3ff14a767904c2d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dbe0163146c0c078d39d586bc3ff14a767904c2d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbe0163146c0c078d39d586bc3ff14a767904c2d/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "4dd80bb73b99a1b1b01ffca9871a63b31b6f03d1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4dd80bb73b99a1b1b01ffca9871a63b31b6f03d1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4dd80bb73b99a1b1b01ffca9871a63b31b6f03d1"}], "stats": {"total": 79, "additions": 49, "deletions": 30}, "files": [{"sha": "0dee657b140f6208b57d81e0c8641ecf3e869049", "filename": "gcc/ada/g-awk.adb", "status": "modified", "additions": 49, "deletions": 30, "changes": 79, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbe0163146c0c078d39d586bc3ff14a767904c2d/gcc%2Fada%2Fg-awk.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbe0163146c0c078d39d586bc3ff14a767904c2d/gcc%2Fada%2Fg-awk.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fg-awk.adb?ref=dbe0163146c0c078d39d586bc3ff14a767904c2d", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---                     Copyright (C) 2000-2007, AdaCore                     --\n+--                     Copyright (C) 2000-2008, AdaCore                     --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -36,10 +36,6 @@ pragma Ada_95;\n --  Default_Session (see below) do not work when compiling clients of this\n --  package that instantiate generic units herein.\n \n-pragma Style_Checks (All_Checks);\n---  Turn off alpha ordering check for subprograms, since we cannot\n---  Put Finalize and Initialize in alpha order (see comments).\n-\n with Ada.Exceptions;\n with Ada.Text_IO;\n with Ada.Strings.Unbounded;\n@@ -56,6 +52,18 @@ package body GNAT.AWK is\n    use Ada;\n    use Ada.Strings.Unbounded;\n \n+   -----------------------\n+   -- Local subprograms --\n+   -----------------------\n+\n+   --  The following two subprograms provide a functional interface to the\n+   --  two special session variables, that are manipulated explicitly by\n+   --  Finalize, but must be declared after Finalize to prevent static\n+   --  elaboration warnings.\n+\n+   function Get_Def return Session_Data_Access;\n+   procedure Set_Cur;\n+\n    ----------------\n    -- Split mode --\n    ----------------\n@@ -277,6 +285,24 @@ package body GNAT.AWK is\n    procedure Free is\n       new Unchecked_Deallocation (Session_Data, Session_Data_Access);\n \n+   --------------\n+   -- Finalize --\n+   --------------\n+\n+   procedure Finalize (Session : in out Session_Type) is\n+   begin\n+      --  We release the session data only if it is not the default session\n+\n+      if Session.Data /= Get_Def then\n+         Free (Session.Data);\n+\n+         --  Since we have closed the current session, set it to point now to\n+         --  the default session.\n+\n+         Set_Cur;\n+      end if;\n+   end Finalize;\n+\n    ----------------\n    -- Initialize --\n    ----------------\n@@ -301,34 +327,9 @@ package body GNAT.AWK is\n    -- Session Variables --\n    -----------------------\n \n-   --  These must come after the body of Initialize, since they make\n-   --  implicit calls to Initialize at elaboration time.\n-\n    Def_Session : Session_Type;\n    Cur_Session : Session_Type;\n \n-   --------------\n-   -- Finalize --\n-   --------------\n-\n-   --  Note: Finalize must come after Initialize and the definition\n-   --  of the Def_Session and Cur_Session variables, since it references\n-   --  the latter.\n-\n-   procedure Finalize (Session : in out Session_Type) is\n-   begin\n-      --  We release the session data only if it is not the default session\n-\n-      if Session.Data /= Def_Session.Data then\n-         Free (Session.Data);\n-\n-         --  Since we have closed the current session, set it to point now to\n-         --  the default session.\n-\n-         Cur_Session.Data := Def_Session.Data;\n-      end if;\n-   end Finalize;\n-\n    ----------------------\n    -- Private Services --\n    ----------------------\n@@ -1480,6 +1481,24 @@ package body GNAT.AWK is\n       Split.Current_Line (Session.Data.Separators.all, Session);\n    end Split_Line;\n \n+   -------------\n+   -- Get_Def --\n+   -------------\n+\n+   function Get_Def return Session_Data_Access is\n+   begin\n+      return Def_Session.Data;\n+   end Get_Def;\n+\n+   -------------\n+   -- Set_Cur --\n+   -------------\n+\n+   procedure Set_Cur is\n+   begin\n+      Cur_Session.Data := Def_Session.Data;\n+   end Set_Cur;\n+\n begin\n    --  We have declared two sessions but both should share the same data.\n    --  The current session must point to the default session as its initial"}]}