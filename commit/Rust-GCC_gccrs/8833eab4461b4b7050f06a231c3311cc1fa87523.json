{"sha": "8833eab4461b4b7050f06a231c3311cc1fa87523", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODgzM2VhYjQ0NjFiNGI3MDUwZjA2YTIzMWMzMzExY2MxZmE4NzUyMw==", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2020-12-07T14:55:59Z"}, "committer": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2020-12-16T09:25:32Z"}, "message": "Add -Wtsan.\n\ngcc/ChangeLog:\n\n\tPR sanitizer/97868\n\t* common.opt: Add new warning -Wtsan.\n\t* doc/invoke.texi: Likewise.\n\t* tsan.c (instrument_builtin_call): Warn users about unsupported\n\tstd::atomic_thread_fence.\n\ngcc/testsuite/ChangeLog:\n\n\tPR sanitizer/97868\n\t* gcc.dg/tsan/atomic-fence.c: New test.", "tree": {"sha": "311bae63eda19649eb32f3383b3408d1e7891598", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/311bae63eda19649eb32f3383b3408d1e7891598"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8833eab4461b4b7050f06a231c3311cc1fa87523", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8833eab4461b4b7050f06a231c3311cc1fa87523", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8833eab4461b4b7050f06a231c3311cc1fa87523", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8833eab4461b4b7050f06a231c3311cc1fa87523/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5c5eb7e4872025e8d5e8ae2f0e568403f7c8803d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5c5eb7e4872025e8d5e8ae2f0e568403f7c8803d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5c5eb7e4872025e8d5e8ae2f0e568403f7c8803d"}], "stats": {"total": 33, "additions": 32, "deletions": 1}, "files": [{"sha": "4ab5fe44737d6cefb9cfa06b4617321ec50786d2", "filename": "gcc/common.opt", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Fcommon.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Fcommon.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcommon.opt?ref=8833eab4461b4b7050f06a231c3311cc1fa87523", "patch": "@@ -842,6 +842,10 @@ Wvector-operation-performance\n Common Var(warn_vector_operation_performance) Warning\n Warn when a vector operation is compiled outside the SIMD.\n \n+Wtsan\n+Common Var(warn_tsan) Init(1) Warning\n+Warn about unsupported features in ThreadSanitizer.\n+\n Xassembler\n Driver Separate\n "}, {"sha": "054b83715934e0b021d83b7e07eded4b91548ccd", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=8833eab4461b4b7050f06a231c3311cc1fa87523", "patch": "@@ -387,7 +387,7 @@ Objective-C and Objective-C++ Dialects}.\n -Wswitch  -Wno-switch-bool  -Wswitch-default  -Wswitch-enum @gol\n -Wno-switch-outside-range  -Wno-switch-unreachable  -Wsync-nand @gol\n -Wsystem-headers  -Wtautological-compare  -Wtrampolines  -Wtrigraphs @gol\n--Wtype-limits  -Wundef @gol\n+-Wtsan -Wtype-limits  -Wundef @gol\n -Wuninitialized  -Wunknown-pragmas @gol\n -Wunsuffixed-float-constants  -Wunused @gol\n -Wunused-but-set-parameter  -Wunused-but-set-variable @gol\n@@ -8023,6 +8023,16 @@ Note that the code above is invalid in C++11.\n \n This warning is enabled by default.\n \n+@item -Wtsan\n+@opindex Wtsan\n+@opindex Wno-tsan\n+Warn about unsupported features in ThreadSanitizer.\n+\n+ThreadSanitizer does not support @code{std::atomic_thread_fence} and\n+can report false positives.\n+\n+This warning is enabled by default.\n+\n @item -Wtype-limits\n @opindex Wtype-limits\n @opindex Wno-type-limits"}, {"sha": "013720c2969ac57d94b477933ddfe49569fe6cfc", "filename": "gcc/testsuite/gcc.dg/tsan/atomic-fence.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Ftestsuite%2Fgcc.dg%2Ftsan%2Fatomic-fence.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Ftestsuite%2Fgcc.dg%2Ftsan%2Fatomic-fence.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftsan%2Fatomic-fence.c?ref=8833eab4461b4b7050f06a231c3311cc1fa87523", "patch": "@@ -0,0 +1,11 @@\n+/* PR sanitizer/97868 */\n+/* { dg-do compile } */\n+/* { dg-options \"-fsanitize=thread\" } */\n+\n+int\n+main ()\n+{\n+  __atomic_thread_fence (__ATOMIC_RELAXED); /* { dg-warning \".atomic_thread_fence. is not supported with .-fsanitize=thread.\" } */\n+  return 0;\n+}\n+"}, {"sha": "1bc020e76480a53a363e0e518fa29cedd25ee818", "filename": "gcc/tsan.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Ftsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8833eab4461b4b7050f06a231c3311cc1fa87523/gcc%2Ftsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftsan.c?ref=8833eab4461b4b7050f06a231c3311cc1fa87523", "patch": "@@ -45,6 +45,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"asan.h\"\n #include \"builtins.h\"\n #include \"target.h\"\n+#include \"diagnostic-core.h\"\n \n /* Number of instrumented memory accesses in the current function.  */\n \n@@ -500,6 +501,11 @@ instrument_builtin_call (gimple_stmt_iterator *gsi)\n       continue;\n     else\n       {\n+\tif (fcode == BUILT_IN_ATOMIC_THREAD_FENCE)\n+\t  warning_at (gimple_location (stmt), OPT_Wtsan,\n+\t\t      \"%qs is not supported with %qs\", \"atomic_thread_fence\",\n+\t\t      \"-fsanitize=thread\");\n+\n \ttree decl = builtin_decl_implicit (tsan_atomic_table[i].tsan_fcode);\n \tif (decl == NULL_TREE)\n \t  return;"}]}