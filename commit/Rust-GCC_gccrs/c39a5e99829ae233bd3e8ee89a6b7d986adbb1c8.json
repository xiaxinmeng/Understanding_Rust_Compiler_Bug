{"sha": "c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzM5YTVlOTk4MjlhZTIzM2JkM2U4ZWU4OWE2YjdkOTg2YWRiYjFjOA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2014-11-18T22:15:42Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2014-11-18T22:15:42Z"}, "message": "re PR sanitizer/63813 ([UBSAN] ICE in ubsan_type_descriptor, at ubsan.c:346)\n\n\tPR sanitizer/63813\n\t* c-ubsan.c (ubsan_maybe_instrument_reference_or_call): Change type\n\targument to ptype, set type to TREE_TYPE (ptype).  Don't call\n\tget_pointer_alignment for non-pointers.  Use ptype, or if it is\n\treference type, corresponding pointer type, as type of kind\n\targument.\n\t(ubsan_maybe_instrument_reference,\n\tubsan_maybe_instrument_member_call): Adjust callers.\n\n\t* g++.dg/ubsan/pr63813.C: New test.\n\nFrom-SVN: r217741", "tree": {"sha": "3100f945556d63aeaa058af9f42a2c3172835edc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3100f945556d63aeaa058af9f42a2c3172835edc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d236c8038dfe895644d47100f68b8ca198d42b57", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d236c8038dfe895644d47100f68b8ca198d42b57", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d236c8038dfe895644d47100f68b8ca198d42b57"}], "stats": {"total": 54, "additions": 44, "deletions": 10}, "files": [{"sha": "cc6771a1bf59d9813a87a0aa81602e7fa603788c", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "patch": "@@ -1,3 +1,14 @@\n+2014-11-18  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR sanitizer/63813\n+\t* c-ubsan.c (ubsan_maybe_instrument_reference_or_call): Change type\n+\targument to ptype, set type to TREE_TYPE (ptype).  Don't call\n+\tget_pointer_alignment for non-pointers.  Use ptype, or if it is\n+\treference type, corresponding pointer type, as type of kind\n+\targument.\n+\t(ubsan_maybe_instrument_reference,\n+\tubsan_maybe_instrument_member_call): Adjust callers.\n+\n 2014-11-15  Marek Polacek  <polacek@redhat.com>\n \n \tPR middle-end/63884"}, {"sha": "90b03f23e73993497ab19d0a9b2c5a6d88650aa8", "filename": "gcc/c-family/c-ubsan.c", "status": "modified", "additions": 18, "deletions": 10, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Fc-family%2Fc-ubsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Fc-family%2Fc-ubsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-ubsan.c?ref=c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "patch": "@@ -383,18 +383,19 @@ ubsan_maybe_instrument_array_ref (tree *expr_p, bool ignore_off_by_one)\n }\n \n static tree\n-ubsan_maybe_instrument_reference_or_call (location_t loc, tree op, tree type,\n+ubsan_maybe_instrument_reference_or_call (location_t loc, tree op, tree ptype,\n \t\t\t\t\t  enum ubsan_null_ckind ckind)\n {\n-  tree orig_op = op;\n-  bool instrument = false;\n-  unsigned int mina = 0;\n-\n   if (current_function_decl == NULL_TREE\n       || lookup_attribute (\"no_sanitize_undefined\",\n \t\t\t   DECL_ATTRIBUTES (current_function_decl)))\n     return NULL_TREE;\n \n+  tree type = TREE_TYPE (ptype);\n+  tree orig_op = op;\n+  bool instrument = false;\n+  unsigned int mina = 0;\n+\n   if (flag_sanitize & SANITIZE_ALIGNMENT)\n     {\n       mina = min_align_of_type (type);\n@@ -431,13 +432,20 @@ ubsan_maybe_instrument_reference_or_call (location_t loc, tree op, tree type,\n \t}\n       else if (flag_sanitize & SANITIZE_NULL)\n \tinstrument = true;\n-      if (mina && mina > get_pointer_alignment (op) / BITS_PER_UNIT)\n-\tinstrument = true;\n+      if (mina && mina > 1)\n+\t{\n+\t  if (!POINTER_TYPE_P (TREE_TYPE (op))\n+\t      || mina > get_pointer_alignment (op) / BITS_PER_UNIT)\n+\t    instrument = true;\n+\t}\n     }\n   if (!instrument)\n     return NULL_TREE;\n   op = save_expr (orig_op);\n-  tree kind = build_int_cst (TREE_TYPE (op), ckind);\n+  gcc_assert (POINTER_TYPE_P (ptype));\n+  if (TREE_CODE (ptype) == REFERENCE_TYPE)\n+    ptype = build_pointer_type (TREE_TYPE (ptype));\n+  tree kind = build_int_cst (ptype, ckind);\n   tree align = build_int_cst (pointer_sized_int_node, mina);\n   tree call\n     = build_call_expr_internal_loc (loc, IFN_UBSAN_NULL, void_type_node,\n@@ -453,7 +461,7 @@ ubsan_maybe_instrument_reference (tree stmt)\n {\n   tree op = TREE_OPERAND (stmt, 0);\n   op = ubsan_maybe_instrument_reference_or_call (EXPR_LOCATION (stmt), op,\n-\t\t\t\t\t\t TREE_TYPE (TREE_TYPE (stmt)),\n+\t\t\t\t\t\t TREE_TYPE (stmt),\n \t\t\t\t\t\t UBSAN_REF_BINDING);\n   if (op)\n     TREE_OPERAND (stmt, 0) = op;\n@@ -471,7 +479,7 @@ ubsan_maybe_instrument_member_call (tree stmt, bool is_ctor)\n       || !POINTER_TYPE_P (TREE_TYPE (op)))\n     return;\n   op = ubsan_maybe_instrument_reference_or_call (EXPR_LOCATION (stmt), op,\n-\t\t\t\t\t\t TREE_TYPE (TREE_TYPE (op)),\n+\t\t\t\t\t\t TREE_TYPE (op),\n \t\t\t\t\t\t is_ctor ? UBSAN_CTOR_CALL\n \t\t\t\t\t\t : UBSAN_MEMBER_CALL);\n   if (op)"}, {"sha": "49f497396f71b1bf4e30b0a1d4e1405aa7eb92f4", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "patch": "@@ -1,5 +1,8 @@\n 2014-11-18  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR sanitizer/63813\n+\t* g++.dg/ubsan/pr63813.C: New test.\n+\n \tPR tree-optimization/61042\n \t* gcc.c-torture/compile/pr61042.c: New test.\n "}, {"sha": "6ca5b2d18c9abeee1610176219196cc66e4749e5", "filename": "gcc/testsuite/g++.dg/ubsan/pr63813.C", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr63813.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr63813.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fubsan%2Fpr63813.C?ref=c39a5e99829ae233bd3e8ee89a6b7d986adbb1c8", "patch": "@@ -0,0 +1,12 @@\n+// PR sanitizer/63813\n+// { dg-do compile }\n+// { dg-options \"-fsanitize=undefined -O1\" }\n+\n+struct A {};\n+struct B { long foo () const; A &bar () const; };\n+\n+A &\n+B::bar () const\n+{\n+  return *reinterpret_cast <A *> (foo ());\n+}"}]}