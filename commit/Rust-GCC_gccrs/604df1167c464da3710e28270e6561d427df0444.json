{"sha": "604df1167c464da3710e28270e6561d427df0444", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjA0ZGYxMTY3YzQ2NGRhMzcxMGUyODI3MGU2NTYxZDQyN2RmMDQ0NA==", "commit": {"author": {"name": "Daniel Franke", "email": "franke.daniel@gmail.com", "date": "2009-12-10T19:57:16Z"}, "committer": {"name": "Daniel Franke", "email": "dfranke@gcc.gnu.org", "date": "2009-12-10T19:57:16Z"}, "message": "re PR fortran/34402 (Diagnose illegal initialization of derived type containing allocatable component)\n\ngcc/fortran/:\n2009-12-10  Daniel Franke  <franke.daniel@gmail.com>\n\n        PR fortran/34402\n        * expr.c (check_alloc_comp_init): New.\n        (check_init_expr): Verify that allocatable components\n        are not data-initalized.\n\ngcc/testsuite/:\n2009-12-10  Daniel Franke  <franke.daniel@gmail.com>\n\n        PR fortran/34402\n        * gfortran.dg/alloc_comp_init_expr.f03: New.\n\nFrom-SVN: r155138", "tree": {"sha": "6a1a7279f72c67acf7c1ac2ad4c4844e6d36a1e3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6a1a7279f72c67acf7c1ac2ad4c4844e6d36a1e3"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/604df1167c464da3710e28270e6561d427df0444", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/604df1167c464da3710e28270e6561d427df0444", "html_url": "https://github.com/Rust-GCC/gccrs/commit/604df1167c464da3710e28270e6561d427df0444", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/604df1167c464da3710e28270e6561d427df0444/comments", "author": {"login": "dfranke76", "id": 15729164, "node_id": "MDQ6VXNlcjE1NzI5MTY0", "avatar_url": "https://avatars.githubusercontent.com/u/15729164?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dfranke76", "html_url": "https://github.com/dfranke76", "followers_url": "https://api.github.com/users/dfranke76/followers", "following_url": "https://api.github.com/users/dfranke76/following{/other_user}", "gists_url": "https://api.github.com/users/dfranke76/gists{/gist_id}", "starred_url": "https://api.github.com/users/dfranke76/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dfranke76/subscriptions", "organizations_url": "https://api.github.com/users/dfranke76/orgs", "repos_url": "https://api.github.com/users/dfranke76/repos", "events_url": "https://api.github.com/users/dfranke76/events{/privacy}", "received_events_url": "https://api.github.com/users/dfranke76/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "df4d18ad801420200b2698b7d637f4e7d6ba2507", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/df4d18ad801420200b2698b7d637f4e7d6ba2507", "html_url": "https://github.com/Rust-GCC/gccrs/commit/df4d18ad801420200b2698b7d637f4e7d6ba2507"}], "stats": {"total": 68, "additions": 64, "deletions": 4}, "files": [{"sha": "7280dd70e37b7a129fca14fd30844aa97e8fe299", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/604df1167c464da3710e28270e6561d427df0444/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/604df1167c464da3710e28270e6561d427df0444/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=604df1167c464da3710e28270e6561d427df0444", "patch": "@@ -1,3 +1,10 @@\n+2009-12-10  Daniel Franke  <franke.daniel@gmail.com>\n+\n+\tPR fortran/34402\n+\t* expr.c (check_alloc_comp_init): New.\n+\t(check_init_expr): Verify that allocatable components\n+\tare not data-initalized.\n+\n 2008-12-08  Daniel Kraft  <d@domob.eu>\n \n \tPR fortran/41177"}, {"sha": "f0cfd1896288d595629c48e3dcb79186e494d327", "filename": "gcc/fortran/expr.c", "status": "modified", "additions": 38, "deletions": 4, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/604df1167c464da3710e28270e6561d427df0444/gcc%2Ffortran%2Fexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/604df1167c464da3710e28270e6561d427df0444/gcc%2Ffortran%2Fexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fexpr.c?ref=604df1167c464da3710e28270e6561d427df0444", "patch": "@@ -2034,6 +2034,32 @@ check_intrinsic_op (gfc_expr *e, gfc_try (*check_function) (gfc_expr *))\n   return FAILURE;\n }\n \n+/* F2003, 7.1.7 (3): In init expression, allocatable components\n+   must not be data-initialized.  */\n+static gfc_try\n+check_alloc_comp_init (gfc_expr *e)\n+{\n+  gfc_component *c;\n+  gfc_constructor *ctor;\n+\n+  gcc_assert (e->expr_type == EXPR_STRUCTURE);\n+  gcc_assert (e->ts.type == BT_DERIVED);\n+\n+  for (c = e->ts.u.derived->components, ctor = e->value.constructor;\n+       c; c = c->next, ctor = ctor->next)\n+    {\n+      if (c->attr.allocatable\n+          && ctor->expr->expr_type != EXPR_NULL)\n+        {\n+\t  gfc_error(\"Invalid initialization expression for ALLOCATABLE \"\n+\t            \"component '%s' in structure constructor at %L\",\n+\t            c->name, &ctor->expr->where);\n+\t  return FAILURE;\n+\t}\n+    }\n+\n+  return SUCCESS;\n+}\n \n static match\n check_init_expr_arguments (gfc_expr *e)\n@@ -2383,10 +2409,18 @@ check_init_expr (gfc_expr *e)\n       break;\n \n     case EXPR_STRUCTURE:\n-      if (e->ts.is_iso_c)\n-\tt = SUCCESS;\n-      else\n-\tt = gfc_check_constructor (e, check_init_expr);\n+      t = e->ts.is_iso_c ? SUCCESS : FAILURE;\n+      if (t == SUCCESS)\n+\tbreak;\n+\n+      t = check_alloc_comp_init (e);\n+      if (t == FAILURE)\n+\tbreak;\n+\n+      t = gfc_check_constructor (e, check_init_expr);\n+      if (t == FAILURE)\n+\tbreak;\n+\n       break;\n \n     case EXPR_ARRAY:"}, {"sha": "b28f1da27679604d9670c597ad824fab01e78f74", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/604df1167c464da3710e28270e6561d427df0444/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/604df1167c464da3710e28270e6561d427df0444/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=604df1167c464da3710e28270e6561d427df0444", "patch": "@@ -1,3 +1,8 @@\n+2009-12-10  Daniel Franke  <franke.daniel@gmail.com>\n+\n+        PR fortran/34402\n+\t* gfortran.dg/alloc_comp_init_expr.f03: New.\n+\n 2009-12-09  David Edelsohn  <edelsohn@gnu.org>\n \n \t* gcc.target/powerpc/bswap64-4.c: Disable on AIX."}, {"sha": "5e399ac7114b2e6cf4d1b7a0f8dcb86a79bc0916", "filename": "gcc/testsuite/gfortran.dg/alloc_comp_init_expr.f03", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/604df1167c464da3710e28270e6561d427df0444/gcc%2Ftestsuite%2Fgfortran.dg%2Falloc_comp_init_expr.f03", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/604df1167c464da3710e28270e6561d427df0444/gcc%2Ftestsuite%2Fgfortran.dg%2Falloc_comp_init_expr.f03", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Falloc_comp_init_expr.f03?ref=604df1167c464da3710e28270e6561d427df0444", "patch": "@@ -0,0 +1,14 @@\n+! { dg-do \"compile\" }\n+! PR fortran/34402 - allocatable components shall not be\n+! data-initialized in init expr\n+\n+  type t\n+    real, allocatable :: x(:)\n+  end type\n+\n+  ! The following is illegal!\n+  type (t) :: bad = t ( (/ 1., 3., 5., 7., 9. /) )     ! { dg-error \"Invalid initialization expression\" }\n+\n+  ! This is ok\n+  type (t) :: ok = t ( NULL() )\n+end"}]}