{"sha": "9d4099343ab2eec82ddb4faff48b6e04fed5519c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWQ0MDk5MzQzYWIyZWVjODJkZGI0ZmFmZjQ4YjZlMDRmZWQ1NTE5Yw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2016-04-13T14:33:53Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2016-04-13T14:33:53Z"}, "message": "re PR c++/70615 (ICE on valid code at -O1 and above on x86_64-linux-gnu in add_expr, at tree.c:7870)\n\n\tPR c++/70615\n\t* cp-gimplify.c (cp_genericize_r): Expand PTRMEM_CST here.\n\t(cp_gimplify_expr): Not here.\n\nFrom-SVN: r234940", "tree": {"sha": "a9a0753642ddcbc20a4440f09087f54ed2af141c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a9a0753642ddcbc20a4440f09087f54ed2af141c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9d4099343ab2eec82ddb4faff48b6e04fed5519c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9d4099343ab2eec82ddb4faff48b6e04fed5519c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9d4099343ab2eec82ddb4faff48b6e04fed5519c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9d4099343ab2eec82ddb4faff48b6e04fed5519c/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "75ca93ec9a9889766beae43555a4efbe73ddf52b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/75ca93ec9a9889766beae43555a4efbe73ddf52b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/75ca93ec9a9889766beae43555a4efbe73ddf52b"}], "stats": {"total": 49, "additions": 44, "deletions": 5}, "files": [{"sha": "71538ab64f1bf6d97026086c5145142326cb39c2", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9d4099343ab2eec82ddb4faff48b6e04fed5519c/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9d4099343ab2eec82ddb4faff48b6e04fed5519c/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=9d4099343ab2eec82ddb4faff48b6e04fed5519c", "patch": "@@ -1,3 +1,9 @@\n+2016-04-13  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/70615\n+\t* cp-gimplify.c (cp_genericize_r): Expand PTRMEM_CST here.\n+\t(cp_gimplify_expr): Not here.\n+\n 2016-04-12  Patrick Palka  <ppalka@gcc.gnu.org>\n \n \tPR c++/70610"}, {"sha": "30ac660906d259a59e77a38a0b157184e1a3233a", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9d4099343ab2eec82ddb4faff48b6e04fed5519c/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9d4099343ab2eec82ddb4faff48b6e04fed5519c/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=9d4099343ab2eec82ddb4faff48b6e04fed5519c", "patch": "@@ -576,11 +576,6 @@ cp_gimplify_expr (tree *expr_p, gimple_seq *pre_p, gimple_seq *post_p)\n \n   switch (code)\n     {\n-    case PTRMEM_CST:\n-      *expr_p = cplus_expand_constant (*expr_p);\n-      ret = GS_OK;\n-      break;\n-\n     case AGGR_INIT_EXPR:\n       simplify_aggr_init_expr (expr_p);\n       ret = GS_OK;\n@@ -1388,6 +1383,13 @@ cp_genericize_r (tree *stmt_p, int *walk_subtrees, void *data)\n \t   || TREE_CODE (stmt) == OMP_SIMD\n \t   || TREE_CODE (stmt) == OMP_DISTRIBUTE)\n     genericize_omp_for_stmt (stmt_p, walk_subtrees, data);\n+  else if (TREE_CODE (stmt) == PTRMEM_CST)\n+    {\n+      /* By the time we get here we're handing off to the back end, so we don't\n+\t need or want to preserve PTRMEM_CST anymore.  */\n+      *stmt_p = cplus_expand_constant (stmt);\n+      *walk_subtrees = 0;\n+    }\n   else if ((flag_sanitize\n \t    & (SANITIZE_NULL | SANITIZE_ALIGNMENT | SANITIZE_VPTR))\n \t   && !wtd->no_sanitize_p)"}, {"sha": "7d9e9b17d3d3b86276af51c4f22773576d77ecb2", "filename": "gcc/testsuite/g++.dg/opt/ptrmem7.C", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9d4099343ab2eec82ddb4faff48b6e04fed5519c/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fptrmem7.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9d4099343ab2eec82ddb4faff48b6e04fed5519c/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fptrmem7.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fopt%2Fptrmem7.C?ref=9d4099343ab2eec82ddb4faff48b6e04fed5519c", "patch": "@@ -0,0 +1,31 @@\n+// PR c++/70615\n+// { dg-options -O }\n+\n+struct C\n+{\n+  virtual void f () {}\n+};\n+\n+struct B\n+{\n+  virtual ~B () {}\n+};\n+\n+class D : public B, public C\n+{\n+public:\n+  D () {}\n+};\n+\n+typedef void (C::*FP) ();\n+typedef void (D::*D_f) ();\n+\n+int\n+main ()\n+{\n+  D *d = new D ();\n+  C *c = d;\n+  const FP fptr = (FP) & D::f;\n+  (d->*(D_f) fptr) ();\n+  return 0;\n+}"}]}