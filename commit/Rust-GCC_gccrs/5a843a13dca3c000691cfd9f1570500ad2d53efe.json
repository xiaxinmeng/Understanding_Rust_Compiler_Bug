{"sha": "5a843a13dca3c000691cfd9f1570500ad2d53efe", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWE4NDNhMTNkY2EzYzAwMDY5MWNmZDlmMTU3MDUwMGFkMmQ1M2VmZQ==", "commit": {"author": {"name": "Richard Henderson", "email": "rth@redhat.com", "date": "2012-01-26T22:04:54Z"}, "committer": {"name": "Richard Henderson", "email": "rth@gcc.gnu.org", "date": "2012-01-26T22:04:54Z"}, "message": "sparc: Fix atomic_test_and_set definition.\n\n        * config/sparc/sparc.c (TARGET_ATOMIC_TEST_AND_SET_TRUEVAL): New.\n        * config/sparc/sync.md (atomic_test_and_set): Only handle QImode.\n        (ldstub): Rename from ldstubqi.\n        (ldstub<I24MODE>): Remove.\n\nFrom-SVN: r183584", "tree": {"sha": "8569dd89808813466188f10220f75214bc31da2e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8569dd89808813466188f10220f75214bc31da2e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5a843a13dca3c000691cfd9f1570500ad2d53efe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a843a13dca3c000691cfd9f1570500ad2d53efe", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5a843a13dca3c000691cfd9f1570500ad2d53efe", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a843a13dca3c000691cfd9f1570500ad2d53efe/comments", "author": null, "committer": null, "parents": [{"sha": "f10f4968960c57a349467e833a29e3a52b4fff41", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f10f4968960c57a349467e833a29e3a52b4fff41", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f10f4968960c57a349467e833a29e3a52b4fff41"}], "stats": {"total": 42, "additions": 24, "deletions": 18}, "files": [{"sha": "32a21d28e800e84c8bbd1389889e7e4cccc89b8a", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a843a13dca3c000691cfd9f1570500ad2d53efe/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a843a13dca3c000691cfd9f1570500ad2d53efe/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=5a843a13dca3c000691cfd9f1570500ad2d53efe", "patch": "@@ -1,3 +1,10 @@\n+2012-01-27  Richard Henderson  <rth@redhat.com>\n+\n+\t* config/sparc/sparc.c (TARGET_ATOMIC_TEST_AND_SET_TRUEVAL): New.\n+\t* config/sparc/sync.md (atomic_test_and_set): Only handle QImode.\n+\t(ldstub): Rename from ldstubqi.\n+\t(ldstub<I24MODE>): Remove.\n+\n 2012-01-27  Richard Henderson  <rth@redhat.com>\n \n \t* target.def (TARGET_ATOMIC_TEST_AND_SET_TRUEVAL): New."}, {"sha": "1b3b4c8764c13efb93d33d9dfcbf5298da659454", "filename": "gcc/config/sparc/sparc.c", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a843a13dca3c000691cfd9f1570500ad2d53efe/gcc%2Fconfig%2Fsparc%2Fsparc.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a843a13dca3c000691cfd9f1570500ad2d53efe/gcc%2Fconfig%2Fsparc%2Fsparc.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fsparc%2Fsparc.c?ref=5a843a13dca3c000691cfd9f1570500ad2d53efe", "patch": "@@ -779,6 +779,10 @@ char sparc_hard_reg_printed[8];\n #undef TARGET_PRINT_OPERAND_ADDRESS\n #define TARGET_PRINT_OPERAND_ADDRESS sparc_print_operand_address\n \n+/* The value stored by LDSTUB.  */\n+#undef TARGET_ATOMIC_TEST_AND_SET_TRUEVAL\n+#define TARGET_ATOMIC_TEST_AND_SET_TRUEVAL 0xff\n+\n struct gcc_target targetm = TARGET_INITIALIZER;\n \n static void"}, {"sha": "d07d572c61499ffa204fc910be0d2fd36c0fd5e2", "filename": "gcc/config/sparc/sync.md", "status": "modified", "additions": 13, "deletions": 18, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5a843a13dca3c000691cfd9f1570500ad2d53efe/gcc%2Fconfig%2Fsparc%2Fsync.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5a843a13dca3c000691cfd9f1570500ad2d53efe/gcc%2Fconfig%2Fsparc%2Fsync.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fsparc%2Fsync.md?ref=5a843a13dca3c000691cfd9f1570500ad2d53efe", "patch": "@@ -242,39 +242,34 @@\n   \"swap\\t%1, %0\"\n   [(set_attr \"type\" \"multi\")])\n \n-(define_expand \"atomic_test_and_set<mode>\"\n-  [(match_operand:I124MODE 0 \"register_operand\" \"\")\n-   (match_operand:I124MODE 1 \"memory_operand\" \"\")\n+(define_expand \"atomic_test_and_set\"\n+  [(match_operand:QI 0 \"register_operand\" \"\")\n+   (match_operand:QI 1 \"memory_operand\" \"\")\n    (match_operand:SI 2 \"const_int_operand\" \"\")]\n   \"\"\n {\n   enum memmodel model = (enum memmodel) INTVAL (operands[2]);\n+  rtx ret;\n \n   sparc_emit_membar_for_model (model, 3, 1);\n+  emit_insn (gen_ldstub (operands[0], operands[1]));\n+  sparc_emit_membar_for_model (model, 3, 2);\n \n-  if (<MODE>mode != QImode)\n-    operands[1] = adjust_address (operands[1], QImode, 0);\n-  emit_insn (gen_ldstub<mode> (operands[0], operands[1]));\n+  /* Convert the 0/0xff result we would otherwise have to a boolean.\n+     I.e. ignore all but bit 0.  */\n+  ret = expand_simple_binop (QImode, AND, operands[0], const1_rtx,\n+\t\t\t     operands[0], true, OPTAB_LIB_WIDEN);\n+  if (ret != operands[0])\n+    emit_move_insn (operands[0], ret);\n \n-  sparc_emit_membar_for_model (model, 3, 2);\n   DONE;\n })\n \n-(define_insn \"ldstubqi\"\n+(define_insn \"ldstub\"\n   [(set (match_operand:QI 0 \"register_operand\" \"=r\")\n \t(unspec_volatile:QI [(match_operand:QI 1 \"memory_operand\" \"+m\")]\n \t\t\t    UNSPECV_LDSTUB))\n    (set (match_dup 1) (const_int -1))]\n   \"\"\n   \"ldstub\\t%1, %0\"\n   [(set_attr \"type\" \"multi\")])\n-\n-(define_insn \"ldstub<mode>\"\n-  [(set (match_operand:I24MODE 0 \"register_operand\" \"=r\")\n-\t(zero_extend:I24MODE\n-\t  (unspec_volatile:QI [(match_operand:QI 1 \"memory_operand\" \"+m\")]\n-\t\t\t      UNSPECV_LDSTUB)))\n-   (set (match_dup 1) (const_int -1))]\n-  \"\"\n-  \"ldstub\\t%1, %0\"\n-  [(set_attr \"type\" \"multi\")])"}]}