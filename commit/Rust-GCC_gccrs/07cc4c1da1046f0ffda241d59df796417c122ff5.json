{"sha": "07cc4c1da1046f0ffda241d59df796417c122ff5", "node_id": "C_kwDOANBUbNoAKDA3Y2M0YzFkYTEwNDZmMGZmZGEyNDFkNTlkZjc5NjQxN2MxMjJmZjU", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-10-19T09:28:42Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-10-19T09:28:42Z"}, "message": "match.pd: Add 2 TYPE_OVERFLOW_SANITIZED checks [PR106990]\n\nAs requested in the PR, this adds 2 TYPE_OVERFLOW_SANITIZED checks\nand corresponding testcase.\n\n2022-10-19  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR tree-optimization/106990\n\t* match.pd ((~X - ~Y) -> Y - X, -x & 1 -> x & 1): Guard with\n\t!TYPE_OVERFLOW_SANITIZED (type).\n\n\t* c-c++-common/ubsan/pr106990.c: New test.", "tree": {"sha": "f7b7a3344104fcc6fee5defb8058dfb014ed351e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f7b7a3344104fcc6fee5defb8058dfb014ed351e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/07cc4c1da1046f0ffda241d59df796417c122ff5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07cc4c1da1046f0ffda241d59df796417c122ff5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/07cc4c1da1046f0ffda241d59df796417c122ff5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/07cc4c1da1046f0ffda241d59df796417c122ff5/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba281da28d34f9a78a07f6ee56ad2c754447966e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ba281da28d34f9a78a07f6ee56ad2c754447966e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ba281da28d34f9a78a07f6ee56ad2c754447966e"}], "stats": {"total": 39, "additions": 35, "deletions": 4}, "files": [{"sha": "d07c0e4296e50442df4f26ceb147394da7cf8d5e", "filename": "gcc/match.pd", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07cc4c1da1046f0ffda241d59df796417c122ff5/gcc%2Fmatch.pd", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07cc4c1da1046f0ffda241d59df796417c122ff5/gcc%2Fmatch.pd", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fmatch.pd?ref=07cc4c1da1046f0ffda241d59df796417c122ff5", "patch": "@@ -1331,8 +1331,9 @@ DEFINE_INT_AND_FLOAT_ROUND_FN (RINT)\n /* (~X - ~Y) -> Y - X.  */\n (simplify\n  (minus (bit_not @0) (bit_not @1))\n-  (with { tree utype = unsigned_type_for (type); }\n-   (convert (minus (convert:utype @1) (convert:utype @0)))))\n+  (if (!TYPE_OVERFLOW_SANITIZED (type))\n+   (with { tree utype = unsigned_type_for (type); }\n+    (convert (minus (convert:utype @1) (convert:utype @0))))))\n \n /* ~(X - Y) -> ~X + Y.  */\n (simplify\n@@ -8176,5 +8177,6 @@ and,\n \n /* -x & 1 -> x & 1.  */\n (simplify \n-  (bit_and (negate @0) integer_onep@1)\n-  (bit_and @0 @1))\n+ (bit_and (negate @0) integer_onep@1)\n+ (if (!TYPE_OVERFLOW_SANITIZED (type))\n+  (bit_and @0 @1)))"}, {"sha": "5bd46af57e06710c3f75ff2ecb06aeb30cb6a823", "filename": "gcc/testsuite/c-c++-common/ubsan/pr106990.c", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/07cc4c1da1046f0ffda241d59df796417c122ff5/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fubsan%2Fpr106990.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/07cc4c1da1046f0ffda241d59df796417c122ff5/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fubsan%2Fpr106990.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fubsan%2Fpr106990.c?ref=07cc4c1da1046f0ffda241d59df796417c122ff5", "patch": "@@ -0,0 +1,29 @@\n+/* PR tree-optimization/106990 */\n+/* { dg-do run { target int32 } } */\n+/* { dg-options \"-fsanitize=signed-integer-overflow\" } */\n+\n+__attribute__((noipa)) int\n+foo (void)\n+{\n+  int x = -1956816001;\n+  int y = 1999200512;\n+  return ~x - ~y;\n+}\n+\n+__attribute__((noipa)) int\n+bar (void)\n+{\n+  int x = -__INT_MAX__ - 1;\n+  return -x & 1;\n+}\n+\n+int\n+main ()\n+{\n+  foo ();\n+  bar ();\n+  return 0;\n+}\n+\n+/* { dg-output \"signed integer overflow: 1956816000 - -1999200513 cannot be represented in type 'int'\\[^\\n\\r]*(\\n|\\r\\n|\\r)\" } */\n+/* { dg-output \"\\[^\\n\\r]*negation of -2147483648 cannot be represented in type 'int'; cast to an unsigned type to negate this value to itself\" } */"}]}