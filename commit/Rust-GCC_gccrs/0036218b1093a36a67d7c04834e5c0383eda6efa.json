{"sha": "0036218b1093a36a67d7c04834e5c0383eda6efa", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDAzNjIxOGIxMDkzYTM2YTY3ZDdjMDQ4MzRlNWMwMzgzZWRhNmVmYQ==", "commit": {"author": {"name": "Marc Glisse", "email": "marc.glisse@inria.fr", "date": "2018-10-02T15:02:13Z"}, "committer": {"name": "Marc Glisse", "email": "glisse@gcc.gnu.org", "date": "2018-10-02T15:02:13Z"}, "message": "((X /[ex] A) +- B) * A --> X +- A * B\n\n2018-10-02  Marc Glisse  <marc.glisse@inria.fr>\n\ngcc/\n\t* match.pd (((X /[ex] A) +- B) * A): New transformation.\n\ngcc/testsuite/\n\t* gcc.dg/tree-ssa/muldiv-1.c: New file.\n\t* gcc.dg/tree-ssa/muldiv-2.c: Likewise.\n\nFrom-SVN: r264792", "tree": {"sha": "9fe2a35a3fd203591cde457d80b75079e7e0e492", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9fe2a35a3fd203591cde457d80b75079e7e0e492"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0036218b1093a36a67d7c04834e5c0383eda6efa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0036218b1093a36a67d7c04834e5c0383eda6efa", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0036218b1093a36a67d7c04834e5c0383eda6efa", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0036218b1093a36a67d7c04834e5c0383eda6efa/comments", "author": {"login": "mglisse", "id": 10097863, "node_id": "MDQ6VXNlcjEwMDk3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/10097863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mglisse", "html_url": "https://github.com/mglisse", "followers_url": "https://api.github.com/users/mglisse/followers", "following_url": "https://api.github.com/users/mglisse/following{/other_user}", "gists_url": "https://api.github.com/users/mglisse/gists{/gist_id}", "starred_url": "https://api.github.com/users/mglisse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mglisse/subscriptions", "organizations_url": "https://api.github.com/users/mglisse/orgs", "repos_url": "https://api.github.com/users/mglisse/repos", "events_url": "https://api.github.com/users/mglisse/events{/privacy}", "received_events_url": "https://api.github.com/users/mglisse/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "86920074bfc4f6319edce71b7a11e49417599f0c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/86920074bfc4f6319edce71b7a11e49417599f0c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/86920074bfc4f6319edce71b7a11e49417599f0c"}], "stats": {"total": 53, "additions": 53, "deletions": 0}, "files": [{"sha": "0b67fa62bbf79dd6d2106803ef736080a60bf7fc", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=0036218b1093a36a67d7c04834e5c0383eda6efa", "patch": "@@ -1,3 +1,7 @@\n+2018-10-02  Marc Glisse  <marc.glisse@inria.fr>\n+\n+\t* match.pd (((X /[ex] A) +- B) * A): New transformation.\n+\n 2018-10-02  Marc Glisse  <marc.glisse@inria.fr>\n \n \tPR middle-end/87319"}, {"sha": "7cc2374ffeb2c87d30cd3957ce1f65c3680b3cfd", "filename": "gcc/match.pd", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Fmatch.pd", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Fmatch.pd", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fmatch.pd?ref=0036218b1093a36a67d7c04834e5c0383eda6efa", "patch": "@@ -2669,6 +2669,25 @@ DEFINE_INT_AND_FLOAT_ROUND_FN (RINT)\n   (mult (convert1? (exact_div @0 @@1)) (convert2? @1))\n   (convert @0))\n \n+/* ((X /[ex] A) +- B) * A  -->  X +- A * B.  */\n+(for op (plus minus)\n+ (simplify\n+  (mult (convert1? (op (convert2? (exact_div @0 INTEGER_CST@@1)) INTEGER_CST@2)) @1)\n+  (if (tree_nop_conversion_p (type, TREE_TYPE (@2))\n+       && tree_nop_conversion_p (TREE_TYPE (@0), TREE_TYPE (@2)))\n+   (with\n+     {\n+       wi::overflow_type overflow;\n+       wide_int mul = wi::mul (wi::to_wide (@1), wi::to_wide (@2),\n+\t\t\t       TYPE_SIGN (type), &overflow);\n+     }\n+     (if (types_match (type, TREE_TYPE (@2))\n+ \t && types_match (TREE_TYPE (@0), TREE_TYPE (@2)) && !overflow)\n+      (op @0 { wide_int_to_tree (type, mul); })\n+      (with { tree utype = unsigned_type_for (type); }\n+       (convert (op (convert:utype @0)\n+\t\t    (mult (convert:utype @1) (convert:utype @2))))))))))\n+\n /* Canonicalization of binary operations.  */\n \n /* Convert X + -C into X - C.  */"}, {"sha": "ce3b03b01a2c11643727e3eeed287aeed48727a1", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=0036218b1093a36a67d7c04834e5c0383eda6efa", "patch": "@@ -1,3 +1,8 @@\n+2018-10-02  Marc Glisse  <marc.glisse@inria.fr>\n+\n+\t* gcc.dg/tree-ssa/muldiv-1.c: New file.\n+\t* gcc.dg/tree-ssa/muldiv-2.c: Likewise.\n+\n 2018-10-02  Segher Boessenkool  <segher@kernel.crashing.org>\n \n \tPR target/87081"}, {"sha": "91612dc9de46b702ad6b73d291d9c3b5c69e06af", "filename": "gcc/testsuite/gcc.dg/tree-ssa/muldiv-1.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fmuldiv-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fmuldiv-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fmuldiv-1.c?ref=0036218b1093a36a67d7c04834e5c0383eda6efa", "patch": "@@ -0,0 +1,13 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O3 -fdump-tree-optimized-raw\" } */\n+\n+// ldist produces (((q-p-4)/4)&...+1)*4\n+// Make sure we remove at least the division\n+// Eventually this should just be n*4\n+\n+void foo(int*p, __SIZE_TYPE__ n){\n+  for(int*q=p+n;p!=q;++p)*p=0;\n+}\n+\n+/* { dg-final { scan-tree-dump \"builtin_memset\" \"optimized\" } } */\n+/* { dg-final { scan-tree-dump-not \"div\" \"optimized\" } } */"}, {"sha": "474741a248af6419436fb9ab63d03334d96631c7", "filename": "gcc/testsuite/gcc.dg/tree-ssa/muldiv-2.c", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fmuldiv-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0036218b1093a36a67d7c04834e5c0383eda6efa/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fmuldiv-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftree-ssa%2Fmuldiv-2.c?ref=0036218b1093a36a67d7c04834e5c0383eda6efa", "patch": "@@ -0,0 +1,12 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O1 -fdump-tree-optimized-raw\" } */\n+\n+// 'a' should disappear, but we are not there yet\n+\n+int* f(int* a, int* b, int* c){\n+    __PTRDIFF_TYPE__ d = b - a;\n+    d += 1;\n+    return a + d;\n+}\n+\n+/* { dg-final { scan-tree-dump-not \"div\" \"optimized\" } } */"}]}