{"sha": "b11cb5fd9eb07c4989081f533feca1bf262f0e81", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjExY2I1ZmQ5ZWIwN2M0OTg5MDgxZjUzM2ZlY2ExYmYyNjJmMGU4MQ==", "commit": {"author": {"name": "Emmanuel Briot", "email": "briot@adacore.com", "date": "2009-10-30T13:36:19Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2009-10-30T13:36:19Z"}, "message": "make.adb, [...] (Library_File_Stamp): Removed, since unused.\n\n2009-10-30  Emmanuel Briot  <briot@adacore.com>\n\n\t* make.adb, osint.adb, osint.ads (Library_File_Stamp): Removed, since\n\tunused.\n\t(Read_Library_Info_From_Full): New subprogram.\n\nFrom-SVN: r153746", "tree": {"sha": "ac9b5440b907b6e387b17022a9d5e9132c597231", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ac9b5440b907b6e387b17022a9d5e9132c597231"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b11cb5fd9eb07c4989081f533feca1bf262f0e81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b11cb5fd9eb07c4989081f533feca1bf262f0e81", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b11cb5fd9eb07c4989081f533feca1bf262f0e81", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b11cb5fd9eb07c4989081f533feca1bf262f0e81/comments", "author": {"login": "briot", "id": 42402, "node_id": "MDQ6VXNlcjQyNDAy", "avatar_url": "https://avatars.githubusercontent.com/u/42402?v=4", "gravatar_id": "", "url": "https://api.github.com/users/briot", "html_url": "https://github.com/briot", "followers_url": "https://api.github.com/users/briot/followers", "following_url": "https://api.github.com/users/briot/following{/other_user}", "gists_url": "https://api.github.com/users/briot/gists{/gist_id}", "starred_url": "https://api.github.com/users/briot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/briot/subscriptions", "organizations_url": "https://api.github.com/users/briot/orgs", "repos_url": "https://api.github.com/users/briot/repos", "events_url": "https://api.github.com/users/briot/events{/privacy}", "received_events_url": "https://api.github.com/users/briot/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1a163c46051b7d786aa3849cb870b0ae0597bc54", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1a163c46051b7d786aa3849cb870b0ae0597bc54", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1a163c46051b7d786aa3849cb870b0ae0597bc54"}], "stats": {"total": 129, "additions": 93, "deletions": 36}, "files": [{"sha": "ad2d9e201787ee1ac4dd8bb8f30fed66e80cdc4a", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=b11cb5fd9eb07c4989081f533feca1bf262f0e81", "patch": "@@ -1,3 +1,9 @@\n+2009-10-30  Emmanuel Briot  <briot@adacore.com>\n+\n+\t* make.adb, osint.adb, osint.ads (Library_File_Stamp): Removed, since\n+\tunused.\n+\t(Read_Library_Info_From_Full): New subprogram.\n+\n 2009-10-30  Robert Dewar  <dewar@adacore.com>\n \n \t* a-tideio.adb: Minor reformatting"}, {"sha": "eec486af260e453d9dd29fb4167d3242e97563c0", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 63, "deletions": 22, "changes": 85, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=b11cb5fd9eb07c4989081f533feca1bf262f0e81", "patch": "@@ -740,6 +740,7 @@ package body Make is\n       Is_Main_Source : Boolean;\n       The_Args       : Argument_List;\n       Lib_File       : File_Name_Type;\n+      Full_Lib_File  : File_Name_Type;\n       Read_Only      : Boolean;\n       ALI            : out ALI_Id;\n       O_File         : out File_Name_Type;\n@@ -750,6 +751,8 @@ package body Make is\n    --  ALI is the ALI_Id corresponding to Lib_File. If Lib_File in not\n    --  up-to-date, then the corresponding source file needs to be recompiled.\n    --  In this case ALI = No_ALI_Id.\n+   --  Full_Lib_File must be the result of calling Osint.Full_Lib_File_Name on\n+   --  Lib_File. Precomputing it saves system calls.\n \n    procedure Check_Linker_Options\n      (E_Stamp : Time_Stamp_Type;\n@@ -1414,6 +1417,7 @@ package body Make is\n       Is_Main_Source : Boolean;\n       The_Args       : Argument_List;\n       Lib_File       : File_Name_Type;\n+      Full_Lib_File  : File_Name_Type;\n       Read_Only      : Boolean;\n       ALI            : out ALI_Id;\n       O_File         : out File_Name_Type;\n@@ -1523,9 +1527,6 @@ package body Make is\n       -- Data declarations for Check --\n       ---------------------------------\n \n-      Full_Lib_File : File_Name_Type;\n-      --  Full name of current library file\n-\n       Full_Obj_File : File_Name_Type;\n       --  Full name of the object file corresponding to Lib_File\n \n@@ -1576,15 +1577,14 @@ package body Make is\n                                                Check_Object_Consistency;\n          begin\n             Check_Object_Consistency := False;\n-            Text := Read_Library_Info (Lib_File);\n+            Text := Read_Library_Info_From_Full (Full_Lib_File);\n             Check_Object_Consistency := Saved_Check_Object_Consistency;\n          end;\n \n       else\n-         Text := Read_Library_Info (Lib_File);\n+         Text := Read_Library_Info_From_Full (Full_Lib_File);\n       end if;\n \n-      Full_Lib_File := Full_Library_Info_Name;\n       Full_Obj_File := Full_Object_File_Name;\n       Lib_Stamp     := Current_Library_File_Stamp;\n       Obj_Stamp     := Current_Object_File_Stamp;\n@@ -3144,6 +3144,8 @@ package body Make is\n \n          if not Empty_Q and then Outstanding_Compiles < Max_Process then\n             declare\n+               In_Lib_Dir   : Boolean;\n+\n                Source_Index : Int;\n                --  Index of the current unit in the current source file\n \n@@ -3152,6 +3154,12 @@ package body Make is\n                Full_Source_File := Osint.Full_Source_Name (Source_File);\n                Lib_File         := Osint.Lib_File_Name\n                  (Source_File, Source_Index);\n+\n+               --  Compute the location of Lib_File (involves system calls)\n+               --  ??? Can we compute at the same time if the file is\n+               --  writable, which would save a system call on some systems\n+               --  (when calling Is_Readonly_Library below)\n+\n                Full_Lib_File    := Osint.Full_Lib_File_Name (Lib_File);\n \n                --  If this source has already been compiled, the executable is\n@@ -3161,11 +3169,22 @@ package body Make is\n                   Executable_Obsolete := True;\n                end if;\n \n+               In_Lib_Dir := Full_Lib_File /= No_File\n+                 and then In_Ada_Lib_Dir (Full_Lib_File);\n+\n+               --  Since the following requires a system call, we precompute it\n+               --  when needed\n+\n+               if not In_Lib_Dir then\n+                  Read_Only :=\n+                    Full_Lib_File /= No_File\n+                    and then not Check_Readonly_Files\n+                    and then Is_Readonly_Library (Full_Lib_File);\n+               end if;\n+\n                --  If the library file is an Ada library skip it\n \n-               if Full_Lib_File /= No_File\n-                 and then In_Ada_Lib_Dir (Full_Lib_File)\n-               then\n+               if In_Lib_Dir then\n                   Verbose_Msg\n                     (Lib_File,\n                      \"is in an Ada library\",\n@@ -3178,9 +3197,7 @@ package body Make is\n                   --  in the object directory of a project being extended\n                   --  should not be skipped).\n \n-               elsif Full_Lib_File /= No_File\n-                 and then not Check_Readonly_Files\n-                 and then Is_Readonly_Library (Full_Lib_File)\n+               elsif Read_Only\n                  and then Is_In_Object_Directory (Source_File, Full_Lib_File)\n                then\n                   Verbose_Msg\n@@ -3232,13 +3249,16 @@ package body Make is\n                      Need_To_Compile := Force_Compilations;\n \n                      if not Force_Compilations then\n-                        Read_Only :=\n-                          Full_Lib_File /= No_File\n-                          and then not Check_Readonly_Files\n-                          and then Is_Readonly_Library (Full_Lib_File);\n-                        Check (Source_File, Source_Index,\n-                               Source_File = Main_Source, Args, Lib_File,\n-                               Read_Only, ALI, Obj_File, Obj_Stamp);\n+                        Check (Source_File    => Source_File,\n+                               Source_Index   => Source_Index,\n+                               Is_Main_Source => Source_File = Main_Source,\n+                               The_Args       => Args,\n+                               Lib_File       => Lib_File,\n+                               Full_Lib_File  => Full_Lib_File,\n+                               Read_Only      => Read_Only,\n+                               ALI            => ALI,\n+                               O_File         => Obj_File,\n+                               O_Stamp        => Obj_Stamp);\n                         Need_To_Compile := (ALI = No_ALI_Id);\n                      end if;\n \n@@ -3285,21 +3305,20 @@ package body Make is\n                         end if;\n \n                         if In_Place_Mode then\n-\n                            --  If the library file was not found, then save\n                            --  the library file near the source file.\n \n                            if Full_Lib_File = No_File then\n                               Lib_File := Osint.Lib_File_Name\n                                 (Full_Source_File, Source_Index);\n+                              Full_Lib_File := Lib_File;\n \n                               --  If the library file was found, then save the\n                               --  library file in the same place.\n \n                            else\n                               Lib_File := Full_Lib_File;\n                            end if;\n-\n                         end if;\n \n                         --  Start the compilation and record it. We can do\n@@ -3362,7 +3381,29 @@ package body Make is\n                     Check_Object_Consistency\n                     and Compilation_OK\n                     and (Output_Is_Object or Do_Bind_Step);\n-                  Text := Read_Library_Info (Lib_File);\n+\n+                  if Full_Lib_File = No_File then\n+                     --  Compute the expected location of the ALI file. This\n+                     --  can be from several places:\n+                     --    -i => in place mode. In such a case, Full_Lib_File\n+                     --          has already been set above\n+                     --    -D => if specified\n+                     --    or defaults in current dir\n+                     --  We could simply use a call similar to\n+                     --     Osint.Full_Lib_File_Name (Lib_File)\n+                     --  but that involves system calls and is thus slower\n+\n+                     if Object_Directory_Path /= null then\n+                        Name_Len := 0;\n+                        Add_Str_To_Name_Buffer (Object_Directory_Path.all);\n+                        Add_Str_To_Name_Buffer (Get_Name_String (Lib_File));\n+                        Full_Lib_File := Name_Find;\n+                     else\n+                        Full_Lib_File := Lib_File;\n+                     end if;\n+                  end if;\n+\n+                  Text := Read_Library_Info_From_Full (Full_Lib_File);\n \n                   --  Restore Check_Object_Consistency to its initial value\n "}, {"sha": "11197f42c2293060974e80977284252dcb7f2710", "filename": "gcc/ada/osint.adb", "status": "modified", "additions": 16, "deletions": 12, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2Fosint.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2Fosint.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.adb?ref=b11cb5fd9eb07c4989081f533feca1bf262f0e81", "patch": "@@ -1529,15 +1529,6 @@ package body Osint is\n       return Name_Find;\n    end Lib_File_Name;\n \n-   ------------------------\n-   -- Library_File_Stamp --\n-   ------------------------\n-\n-   function Library_File_Stamp (N : File_Name_Type) return Time_Stamp_Type is\n-   begin\n-      return File_Stamp (Find_File (N, Library));\n-   end Library_File_Stamp;\n-\n    -----------------\n    -- Locate_File --\n    -----------------\n@@ -2119,7 +2110,20 @@ package body Osint is\n \n    function Read_Library_Info\n      (Lib_File  : File_Name_Type;\n-      Fatal_Err : Boolean := False) return Text_Buffer_Ptr\n+      Fatal_Err : Boolean := False) return Text_Buffer_Ptr is\n+   begin\n+      return Read_Library_Info_From_Full\n+        (Full_Lib_File => Find_File (Lib_File, Library),\n+         Fatal_Err     => Fatal_Err);\n+   end Read_Library_Info;\n+\n+   ---------------------------------\n+   -- Read_Library_Info_From_Full --\n+   ---------------------------------\n+\n+   function Read_Library_Info_From_Full\n+     (Full_Lib_File : File_Name_Type;\n+      Fatal_Err     : Boolean := False) return Text_Buffer_Ptr\n    is\n       Lib_FD : File_Descriptor;\n       --  The file descriptor for the current library file. A negative value\n@@ -2133,7 +2137,7 @@ package body Osint is\n       --  For the calls to Close\n \n    begin\n-      Current_Full_Lib_Name := Find_File (Lib_File, Library);\n+      Current_Full_Lib_Name := Full_Lib_File;\n       Current_Full_Obj_Name := Object_File_Name (Current_Full_Lib_Name);\n \n       if Current_Full_Lib_Name = No_File then\n@@ -2239,7 +2243,7 @@ package body Osint is\n \n       return Text;\n \n-   end Read_Library_Info;\n+   end Read_Library_Info_From_Full;\n \n    ----------------------\n    -- Read_Source_File --"}, {"sha": "b129addaa085e3bf5fb366df6b63921755b87f9f", "filename": "gcc/ada/osint.ads", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2Fosint.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b11cb5fd9eb07c4989081f533feca1bf262f0e81/gcc%2Fada%2Fosint.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fosint.ads?ref=b11cb5fd9eb07c4989081f533feca1bf262f0e81", "patch": "@@ -486,6 +486,13 @@ package Osint is\n    --  behaves as if it did not find Lib_File (namely if Fatal_Err is\n    --  False, null is returned).\n \n+   function Read_Library_Info_From_Full\n+     (Full_Lib_File : File_Name_Type;\n+      Fatal_Err     : Boolean := False) return Text_Buffer_Ptr;\n+   --  Same as Read_Library_Info, except Full_Lib_File must contains the full\n+   --  path to the library file (instead of having Read_Library_Info recompute\n+   --  it)\n+\n    function Full_Library_Info_Name return File_Name_Type;\n    function Full_Object_File_Name return File_Name_Type;\n    --  Returns the full name of the library/object file most recently read\n@@ -502,8 +509,7 @@ package Osint is\n    --  Opt.Check_Object_Consistency is set to False.\n \n    function Full_Lib_File_Name (N : File_Name_Type) return File_Name_Type;\n-   function Library_File_Stamp (N : File_Name_Type) return Time_Stamp_Type;\n-   --  Returns the full name/time stamp of library file N. N should not include\n+   --  Returns the full name of library file N. N should not include\n    --  path information. Note that if the file cannot be located No_File is\n    --  returned for the first routine and an all blank time stamp is returned\n    --  for the second (this is not an error situation). The full name includes"}]}