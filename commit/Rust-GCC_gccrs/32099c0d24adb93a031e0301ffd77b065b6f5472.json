{"sha": "32099c0d24adb93a031e0301ffd77b065b6f5472", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzIwOTljMGQyNGFkYjkzYTAzMWUwMzAxZmZkNzdiMDY1YjZmNTQ3Mg==", "commit": {"author": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2021-06-04T13:31:53Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2021-06-08T09:41:52Z"}, "message": "Fix 'libgomp.oacc-fortran/parallel-dims.f90' for 'acc_device_radeon'\n\n..., by simplifying 'libgomp.oacc-c-c++-common/parallel-dims.c', and updating\nthe former correspondingly.  '__builtin_goacc_parlevel_id' does the right thing\nfor all 'acc_device_*'.\n\nFollow-up to commit 09e0ad6253f4330977e1b2f116b5e289dc2c2a02 \"Update OpenACC\ntests for amdgcn\".\n\n\tlibgomp/\n\t* testsuite/libgomp.oacc-c-c++-common/parallel-dims.c: Simplify.\n\t* testsuite/libgomp.oacc-fortran/parallel-dims-aux.c: Update.", "tree": {"sha": "9e8973aaa84d89ecae58dc7cc4545cdc9bd6dc3a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9e8973aaa84d89ecae58dc7cc4545cdc9bd6dc3a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/32099c0d24adb93a031e0301ffd77b065b6f5472", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32099c0d24adb93a031e0301ffd77b065b6f5472", "html_url": "https://github.com/Rust-GCC/gccrs/commit/32099c0d24adb93a031e0301ffd77b065b6f5472", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32099c0d24adb93a031e0301ffd77b065b6f5472/comments", "author": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "984df1e1630f262d782c00cefad2643b8e8469f8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/984df1e1630f262d782c00cefad2643b8e8469f8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/984df1e1630f262d782c00cefad2643b8e8469f8"}], "stats": {"total": 63, "additions": 12, "deletions": 51}, "files": [{"sha": "974e15045341adc30cc973fdf9375609140b2280", "filename": "libgomp/testsuite/libgomp.oacc-c-c++-common/parallel-dims.c", "status": "modified", "additions": 6, "deletions": 26, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32099c0d24adb93a031e0301ffd77b065b6f5472/libgomp%2Ftestsuite%2Flibgomp.oacc-c-c%2B%2B-common%2Fparallel-dims.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32099c0d24adb93a031e0301ffd77b065b6f5472/libgomp%2Ftestsuite%2Flibgomp.oacc-c-c%2B%2B-common%2Fparallel-dims.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.oacc-c-c%2B%2B-common%2Fparallel-dims.c?ref=32099c0d24adb93a031e0301ffd77b065b6f5472", "patch": "@@ -10,42 +10,22 @@\n #include <openacc.h>\n #include <gomp-constants.h>\n \n-/* TODO: \"(int) acc_device_*\" casts because of the C++ acc_on_device wrapper\n-   not behaving as expected for -O0.  */\n #pragma acc routine seq\n-static unsigned int __attribute__ ((optimize (\"O2\"))) acc_gang ()\n+static int acc_gang ()\n {\n-  if (acc_on_device ((int) acc_device_host))\n-    return 0;\n-  else if (acc_on_device ((int) acc_device_nvidia)\n-\t   || acc_on_device ((int) acc_device_radeon))\n-    return __builtin_goacc_parlevel_id (GOMP_DIM_GANG);\n-  else\n-    __builtin_abort ();\n+  return __builtin_goacc_parlevel_id (GOMP_DIM_GANG);\n }\n \n #pragma acc routine seq\n-static unsigned int __attribute__ ((optimize (\"O2\"))) acc_worker ()\n+static int acc_worker ()\n {\n-  if (acc_on_device ((int) acc_device_host))\n-    return 0;\n-  else if (acc_on_device ((int) acc_device_nvidia)\n-\t   || acc_on_device ((int) acc_device_radeon))\n-    return __builtin_goacc_parlevel_id (GOMP_DIM_WORKER);\n-  else\n-    __builtin_abort ();\n+  return __builtin_goacc_parlevel_id (GOMP_DIM_WORKER);\n }\n \n #pragma acc routine seq\n-static unsigned int __attribute__ ((optimize (\"O2\"))) acc_vector ()\n+static int acc_vector ()\n {\n-  if (acc_on_device ((int) acc_device_host))\n-    return 0;\n-  else if (acc_on_device ((int) acc_device_nvidia)\n-\t   || acc_on_device ((int) acc_device_radeon))\n-    return __builtin_goacc_parlevel_id (GOMP_DIM_VECTOR);\n-  else\n-    __builtin_abort ();\n+  return __builtin_goacc_parlevel_id (GOMP_DIM_VECTOR);\n }\n \n "}, {"sha": "cdece32d147478c2d2cd4843fd6c01b285b84e08", "filename": "libgomp/testsuite/libgomp.oacc-fortran/parallel-dims-aux.c", "status": "modified", "additions": 6, "deletions": 25, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32099c0d24adb93a031e0301ffd77b065b6f5472/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fparallel-dims-aux.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32099c0d24adb93a031e0301ffd77b065b6f5472/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fparallel-dims-aux.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fparallel-dims-aux.c?ref=32099c0d24adb93a031e0301ffd77b065b6f5472", "patch": "@@ -5,41 +5,22 @@\n \n /* Used by 'parallel-dims.f90'.  */\n \n-#include <limits.h>\n-#include <openacc.h>\n #include <gomp-constants.h>\n \n-/* TODO: \"(int) acc_device_*\" casts because of the C++ acc_on_device wrapper\n-   not behaving as expected for -O0.  */\n #pragma acc routine seq\n-/* static */ unsigned int __attribute__ ((optimize (\"O2\"))) acc_gang ()\n+/* static */ int acc_gang ()\n {\n-  if (acc_on_device ((int) acc_device_host))\n-    return 0;\n-  else if (acc_on_device ((int) acc_device_nvidia))\n-    return __builtin_goacc_parlevel_id (GOMP_DIM_GANG);\n-  else\n-    __builtin_abort ();\n+  return __builtin_goacc_parlevel_id (GOMP_DIM_GANG);\n }\n \n #pragma acc routine seq\n-/* static */ unsigned int __attribute__ ((optimize (\"O2\"))) acc_worker ()\n+/* static */ int acc_worker ()\n {\n-  if (acc_on_device ((int) acc_device_host))\n-    return 0;\n-  else if (acc_on_device ((int) acc_device_nvidia))\n-    return __builtin_goacc_parlevel_id (GOMP_DIM_WORKER);\n-  else\n-    __builtin_abort ();\n+  return __builtin_goacc_parlevel_id (GOMP_DIM_WORKER);\n }\n \n #pragma acc routine seq\n-/* static */ unsigned int __attribute__ ((optimize (\"O2\"))) acc_vector ()\n+/* static */ int acc_vector ()\n {\n-  if (acc_on_device ((int) acc_device_host))\n-    return 0;\n-  else if (acc_on_device ((int) acc_device_nvidia))\n-    return __builtin_goacc_parlevel_id (GOMP_DIM_VECTOR);\n-  else\n-    __builtin_abort ();\n+  return __builtin_goacc_parlevel_id (GOMP_DIM_VECTOR);\n }"}]}