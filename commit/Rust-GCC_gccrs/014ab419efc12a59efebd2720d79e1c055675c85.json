{"sha": "014ab419efc12a59efebd2720d79e1c055675c85", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDE0YWI0MTllZmMxMmE1OWVmZWJkMjcyMGQ3OWUxYzA1NTY3NWM4NQ==", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely.gcc@gmail.com", "date": "2011-06-04T16:18:36Z"}, "committer": {"name": "Jonathan Wakely", "email": "redi@gcc.gnu.org", "date": "2011-06-04T16:18:36Z"}, "message": "invoke.texi: Document -Wdelete-non-virtual-dtor.\n\n\t* doc/invoke.texi: Document -Wdelete-non-virtual-dtor.\n\nc-family:\n\t* c.opt: Add -Wdelete-non-virtual-dtor.\n\t* c-opts.c (c_common_handle_option): Include it in -Wall.\n\ncp:\n\t* init.c (build_delete): Warn when deleting type with non-virtual\n\tdestructor.\n\ntestsuite:\n\t* testsuite/g++.dg/warn/delete-non-virtual-dtor.C: New.\n\nFrom-SVN: r174643", "tree": {"sha": "4ce2195c12b8ddb26d94b2802f6dbe2017ee0eee", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4ce2195c12b8ddb26d94b2802f6dbe2017ee0eee"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/014ab419efc12a59efebd2720d79e1c055675c85", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/014ab419efc12a59efebd2720d79e1c055675c85", "html_url": "https://github.com/Rust-GCC/gccrs/commit/014ab419efc12a59efebd2720d79e1c055675c85", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/014ab419efc12a59efebd2720d79e1c055675c85/comments", "author": null, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f90d37ec0c1fbac6a987b546167ba9a26d399c5f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f90d37ec0c1fbac6a987b546167ba9a26d399c5f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f90d37ec0c1fbac6a987b546167ba9a26d399c5f"}], "stats": {"total": 95, "additions": 95, "deletions": 0}, "files": [{"sha": "ddfb4f95a1a0e93d5a0806b3f6cd408a657a05e9", "filename": "gcc/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -1,3 +1,7 @@\n+2011-06-04  Jonathan Wakely  <jwakely.gcc@gmail.com>\n+\n+\t* doc/invoke.texi: Document -Wdelete-non-virtual-dtor.\n+\n 2011-06-04  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR target/49281"}, {"sha": "38a6d5560bae4a6d3d61f63f1695e62356df93d6", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -1,3 +1,8 @@\n+2011-06-02  Jonathan Wakely  <jwakely.gcc@gmail.com>\n+\n+\t* c.opt: Add -Wdelete-non-virtual-dtor.\n+\t* c-opts.c (c_common_handle_option): Include it in -Wall.\n+\n 2011-05-30  Nathan Froyd  <froydnj@gcc.gnu.org>\n \n \tPR bootstrap/49190"}, {"sha": "5cf58acd62dbf9273716599382adfc0a1f4da6c1", "filename": "gcc/c-family/c-opts.c", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fc-family%2Fc-opts.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fc-family%2Fc-opts.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-opts.c?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -405,6 +405,7 @@ c_common_handle_option (size_t scode, const char *arg, int value,\n           warn_sign_compare = value;\n \t  warn_reorder = value;\n           warn_cxx0x_compat = value;\n+          warn_delnonvdtor = value;\n \t}\n \n       cpp_opts->warn_trigraphs = value;"}, {"sha": "c4cf4d083d266a669cb7361459b0f3e2cb0f8239", "filename": "gcc/c-family/c.opt", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fc-family%2Fc.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fc-family%2Fc.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc.opt?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -331,6 +331,10 @@ Wdeclaration-after-statement\n C ObjC Var(warn_declaration_after_statement) Warning\n Warn when a declaration is found after a statement\n \n+Wdelete-non-virtual-dtor\n+C++ ObjC++ Var(warn_delnonvdtor) Warning\n+Warn about deleting polymorphic objects with non-virtual destructors\n+\n Wdeprecated\n C C++ ObjC ObjC++ Var(warn_deprecated) Init(1) Warning\n Warn if a deprecated compiler feature, class, method, or field is used"}, {"sha": "48f39f4da21fc83e1a5e7d3f4e292f5f1bc99994", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -1,3 +1,8 @@\n+2011-06-04  Jonathan Wakely  <jwakely.gcc@gmail.com>\n+\n+\t* init.c (build_delete): Warn when deleting type with non-virtual\n+\tdestructor.\n+\n 2011-06-03  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/49276"}, {"sha": "3b926657c5e7259759aaca29fa0bf2d2eec75151", "filename": "gcc/cp/init.c", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fcp%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fcp%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.c?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -3421,6 +3421,25 @@ build_delete (tree type, tree addr, special_function_kind auto_delete,\n \t\t}\n \t      complete_p = false;\n \t    }\n+\t  else if (warn_delnonvdtor && MAYBE_CLASS_TYPE_P (type)\n+\t\t   && !CLASSTYPE_FINAL (type) && TYPE_POLYMORPHIC_P (type))\n+\t    {\n+\t      tree dtor;\n+\t      dtor = CLASSTYPE_DESTRUCTORS (type);\n+\t      if (!dtor || !DECL_VINDEX (dtor))\n+\t\t{\n+\t\t  if (CLASSTYPE_PURE_VIRTUALS (type))\n+\t\t    warning (OPT_Wdelete_non_virtual_dtor,\n+\t\t\t     \"deleting object of abstract class type %qT\"\n+\t\t\t     \" which has non-virtual destructor\"\n+\t\t\t     \" will cause undefined behaviour\", type);\n+\t\t  else\n+\t\t    warning (OPT_Wdelete_non_virtual_dtor,\n+\t\t\t     \"deleting object of polymorphic class type %qT\"\n+\t\t\t     \" which has non-virtual destructor\"\n+\t\t\t     \" might cause undefined behaviour\", type);\n+\t\t}\n+\t    }\n \t}\n       if (VOID_TYPE_P (type) || !complete_p || !MAYBE_CLASS_TYPE_P (type))\n \t/* Call the builtin operator delete.  */"}, {"sha": "a0690426fd15b54f8a558a0a200b72f244ff544b", "filename": "gcc/doc/invoke.texi", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fdoc%2Finvoke.texi", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Fdoc%2Finvoke.texi", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdoc%2Finvoke.texi?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -2331,6 +2331,15 @@ Warn when a class seems unusable because all the constructors or\n destructors in that class are private, and it has neither friends nor\n public static member functions.\n \n+@item -Wdelete-non-virtual-dtor @r{(C++ and Objective-C++ only)}\n+@opindex Wdelete-non-virtual-dtor\n+@opindex Wno-delete-non-virtual-dtor\n+Warn when @samp{delete} is used to destroy an instance of a class which\n+has virtual functions and non-virtual destructor. It is unsafe to delete\n+an instance of a derived class through a pointer to a base class if the\n+base class does not have a virtual destructor.  This warning is enabled\n+by @option{-Wall}.\n+\n @item -Wnoexcept @r{(C++ and Objective-C++ only)}\n @opindex Wnoexcept\n @opindex Wno-noexcept"}, {"sha": "30639929fb69d1bad8680f1ba3fdb235526cb8c7", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -1,3 +1,7 @@\n+2011-06-04  Jonathan Wakely  <jwakely.gcc@gmail.com>\n+\n+\t* testsuite/g++.dg/warn/delete-non-virtual-dtor.C: New.\n+\n 2011-06-04  Jonathan Wakely  <jwakely.gcc@gmail.com>\n \n \tPR c++/33840"}, {"sha": "9849b1edfa8e662238685c6cc51b9a635d9705f8", "filename": "gcc/testsuite/g++.dg/warn/delete-non-virtual-dtor.C", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fdelete-non-virtual-dtor.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/014ab419efc12a59efebd2720d79e1c055675c85/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fdelete-non-virtual-dtor.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fdelete-non-virtual-dtor.C?ref=014ab419efc12a59efebd2720d79e1c055675c85", "patch": "@@ -0,0 +1,44 @@\n+// { dg-options \"-std=gnu++0x -Wdelete-non-virtual-dtor\" }\n+// { dg-do compile }\n+\n+struct polyBase { virtual void f(); };\n+\n+void f(polyBase* p, polyBase* arr)\n+{\n+  delete p;      // { dg-warning \"non-virtual destructor might\" }\n+  delete [] arr;\n+}\n+\n+struct polyDerived : polyBase { };\n+\n+void f(polyDerived* p, polyDerived* arr)\n+{\n+  delete p;      // { dg-warning \"non-virtual destructor might\" }\n+  delete [] arr;\n+}\n+\n+struct absDerived : polyBase { virtual void g() = 0; };\n+\n+void f(absDerived* p, absDerived* arr)\n+{\n+  delete p;      // { dg-warning \"non-virtual destructor will\" }\n+  delete [] arr;\n+}\n+\n+struct finalDerived final : polyBase { };\n+\n+void f(finalDerived* p, finalDerived* arr)\n+{\n+  delete p;      // no error for final classes\n+  delete [] arr;\n+}\n+\n+struct safeBase { virtual ~safeBase(); };\n+struct safeDerived : safeBase { virtual void f(); };\n+\n+void f(safeDerived* p, safeDerived* arr)\n+{\n+  delete p;      // no error because base has virtual dtor\n+  delete [] arr;\n+}\n+"}]}