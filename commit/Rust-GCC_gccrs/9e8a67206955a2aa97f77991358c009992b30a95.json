{"sha": "9e8a67206955a2aa97f77991358c009992b30a95", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWU4YTY3MjA2OTU1YTJhYTk3Zjc3OTkxMzU4YzAwOTk5MmIzMGE5NQ==", "commit": {"author": {"name": "Francois-Xavier Coudert", "email": "fxcoudert@gcc.gnu.org", "date": "2007-10-04T15:04:09Z"}, "committer": {"name": "Fran\u00e7ois-Xavier Coudert", "email": "fxcoudert@gcc.gnu.org", "date": "2007-10-04T15:04:09Z"}, "message": "re PR fortran/33502 (gfortran with .F suffix and -g3 option chokes on preprocessor syntax)\n\n\tPR fortran/33502\n\t* scanner.c (gfc_advance_line): Call debug_hooks->end_source_file\n\tand debug_hooks->start_source_file when appropriate, and set\n\tdbg_emitted.\n\t(gfc_define_undef_line): New function.\n\t(load_file): Don't error out on #define and #undef lines.\n\t* parse.c (next_statement): Call gfc_define_undef_line.\n\t(gfc_parse_file): Call debug_hooks->start_source_file and\n\tdebug_hooks->end_source_file for the main source file if\n\trequired.\n\t* gfortran.h (gfc_linebuf): Add dbg_emitted field.\n\t(gfc_define_undef_line): New prototype.\n\nFrom-SVN: r129011", "tree": {"sha": "84713ee9ee2363bfb664ffc3692e457e1493f1ed", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/84713ee9ee2363bfb664ffc3692e457e1493f1ed"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9e8a67206955a2aa97f77991358c009992b30a95", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9e8a67206955a2aa97f77991358c009992b30a95", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9e8a67206955a2aa97f77991358c009992b30a95", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9e8a67206955a2aa97f77991358c009992b30a95/comments", "author": {"login": "fxcoudert", "id": 1980544, "node_id": "MDQ6VXNlcjE5ODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1980544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fxcoudert", "html_url": "https://github.com/fxcoudert", "followers_url": "https://api.github.com/users/fxcoudert/followers", "following_url": "https://api.github.com/users/fxcoudert/following{/other_user}", "gists_url": "https://api.github.com/users/fxcoudert/gists{/gist_id}", "starred_url": "https://api.github.com/users/fxcoudert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fxcoudert/subscriptions", "organizations_url": "https://api.github.com/users/fxcoudert/orgs", "repos_url": "https://api.github.com/users/fxcoudert/repos", "events_url": "https://api.github.com/users/fxcoudert/events{/privacy}", "received_events_url": "https://api.github.com/users/fxcoudert/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fxcoudert", "id": 1980544, "node_id": "MDQ6VXNlcjE5ODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1980544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fxcoudert", "html_url": "https://github.com/fxcoudert", "followers_url": "https://api.github.com/users/fxcoudert/followers", "following_url": "https://api.github.com/users/fxcoudert/following{/other_user}", "gists_url": "https://api.github.com/users/fxcoudert/gists{/gist_id}", "starred_url": "https://api.github.com/users/fxcoudert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fxcoudert/subscriptions", "organizations_url": "https://api.github.com/users/fxcoudert/orgs", "repos_url": "https://api.github.com/users/fxcoudert/repos", "events_url": "https://api.github.com/users/fxcoudert/events{/privacy}", "received_events_url": "https://api.github.com/users/fxcoudert/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7dc83ebc4a15beeba41e01a0e1a9d3981bc6182c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7dc83ebc4a15beeba41e01a0e1a9d3981bc6182c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7dc83ebc4a15beeba41e01a0e1a9d3981bc6182c"}], "stats": {"total": 90, "additions": 88, "deletions": 2}, "files": [{"sha": "d9e368b6848dcf98ced75b0fed3fc9942ee213d8", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=9e8a67206955a2aa97f77991358c009992b30a95", "patch": "@@ -1,3 +1,18 @@\n+2007-10-04  Francois-Xavier Coudert  <fxcoudert@gcc.gnu.org>\n+\n+\tPR fortran/33502\n+\t* scanner.c (gfc_advance_line): Call debug_hooks->end_source_file\n+\tand debug_hooks->start_source_file when appropriate, and set\n+\tdbg_emitted.\n+\t(gfc_define_undef_line): New function.\n+\t(load_file): Don't error out on #define and #undef lines.\n+\t* parse.c (next_statement): Call gfc_define_undef_line.\n+\t(gfc_parse_file): Call debug_hooks->start_source_file and\n+\tdebug_hooks->end_source_file for the main source file if\n+\trequired.\n+\t* gfortran.h (gfc_linebuf): Add dbg_emitted field.\n+\t(gfc_define_undef_line): New prototype.\n+\n 2007-10-04  Tobias Schl\ufffdter  <tobi@gcc.gnu.org>\n \n \tPR fortran/33626"}, {"sha": "5495ae79a296a03f6ba579d0c829021a58e84e7a", "filename": "gcc/fortran/gfortran.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2Fgfortran.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2Fgfortran.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fgfortran.h?ref=9e8a67206955a2aa97f77991358c009992b30a95", "patch": "@@ -723,6 +723,7 @@ typedef struct gfc_linebuf\n   struct gfc_linebuf *next;\n \n   int truncated;\n+  bool dbg_emitted;\n \n   char line[1];\n } gfc_linebuf;\n@@ -1935,6 +1936,7 @@ int gfc_at_bol (void);\n int gfc_at_eol (void);\n void gfc_advance_line (void);\n int gfc_check_include (void);\n+int gfc_define_undef_line (void);\n \n void gfc_skip_comments (void);\n int gfc_next_char_literal (int);"}, {"sha": "14acb862144072a9dacd6677ca9ec5fd83dad4eb", "filename": "gcc/fortran/parse.c", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2Fparse.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2Fparse.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fparse.c?ref=9e8a67206955a2aa97f77991358c009992b30a95", "patch": "@@ -25,6 +25,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"gfortran.h\"\n #include \"match.h\"\n #include \"parse.h\"\n+#include \"debug.h\"\n \n /* Current statement label.  Zero means no statement label.  Because new_st\n    can get wiped during statement matching, we have to keep it separate.  */\n@@ -673,6 +674,9 @@ next_statement (void)\n \t  break;\n \t}\n \n+      if (gfc_define_undef_line ())\n+\tcontinue;\n+\n       st = (gfc_current_form == FORM_FIXED) ? next_fixed () : next_free ();\n \n       if (st != ST_NONE)\n@@ -3270,6 +3274,11 @@ gfc_parse_file (void)\n   gfc_statement st;\n   locus prog_locus;\n \n+  /* If the debugger wants the name of the main source file,\n+     we give it.  */\n+  if (debug_hooks->start_end_main_source_file)\n+    (*debug_hooks->start_source_file) (0, gfc_source_file);\n+\n   top.state = COMP_NONE;\n   top.sym = NULL;\n   top.previous = NULL;\n@@ -3380,6 +3389,9 @@ gfc_parse_file (void)\n   goto loop;\n \n done:\n+  if (debug_hooks->start_end_main_source_file)\n+    (*debug_hooks->end_source_file) (0);\n+\n   return SUCCESS;\n \n duplicate_main:"}, {"sha": "b9e7114911005e2ec44cd54aa928a5e60a6f16ee", "filename": "gcc/fortran/scanner.c", "status": "modified", "additions": 59, "deletions": 2, "changes": 61, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2Fscanner.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9e8a67206955a2aa97f77991358c009992b30a95/gcc%2Ffortran%2Fscanner.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fscanner.c?ref=9e8a67206955a2aa97f77991358c009992b30a95", "patch": "@@ -45,6 +45,8 @@ along with GCC; see the file COPYING3.  If not see\n #include \"system.h\"\n #include \"gfortran.h\"\n #include \"toplev.h\"\n+#include \"debug.h\"\n+#include \"flags.h\"\n \n /* Structure for holding module and include file search path.  */\n typedef struct gfc_directorylist\n@@ -312,6 +314,29 @@ gfc_advance_line (void)\n       return;\n     } \n \n+  if (gfc_current_locus.lb->next\n+      && gfc_current_locus.lb->next->file != gfc_current_locus.lb->file)\n+    {\n+      if (gfc_current_locus.lb->next->file\n+\t  && !gfc_current_locus.lb->next->dbg_emitted\n+\t  && gfc_current_locus.lb->file->up == gfc_current_locus.lb->next->file)\n+\t{\n+\t  /* We exit from an included file. */\n+\t  (*debug_hooks->end_source_file)\n+\t\t(gfc_linebuf_linenum (gfc_current_locus.lb->next));\n+\t  gfc_current_locus.lb->next->dbg_emitted = true;\n+\t}\n+      else if (gfc_current_locus.lb->next->file != gfc_current_locus.lb->file\n+\t       && !gfc_current_locus.lb->next->dbg_emitted)\n+\t{\n+\t  /* We enter into a new file.  */\n+\t  (*debug_hooks->start_source_file)\n+\t\t(gfc_linebuf_linenum (gfc_current_locus.lb),\n+\t\t gfc_current_locus.lb->next->file->filename);\n+\t  gfc_current_locus.lb->next->dbg_emitted = true;\n+\t}\n+    }\n+\n   gfc_current_locus.lb = gfc_current_locus.lb->next;\n \n   if (gfc_current_locus.lb != NULL)\t \n@@ -372,6 +397,28 @@ skip_comment_line (void)\n }\n \n \n+int\n+gfc_define_undef_line (void)\n+{\n+  /* All lines beginning with '#' are either #define or #undef.  */\n+  if (debug_info_level != DINFO_LEVEL_VERBOSE || gfc_peek_char () != '#')\n+    return 0;\n+\n+  if (strncmp (gfc_current_locus.nextc, \"#define \", 8) == 0)\n+    (*debug_hooks->define) (gfc_linebuf_linenum (gfc_current_locus.lb),\n+\t\t\t    &(gfc_current_locus.nextc[8]));\n+\n+  if (strncmp (gfc_current_locus.nextc, \"#undef \", 7) == 0)\n+    (*debug_hooks->undef) (gfc_linebuf_linenum (gfc_current_locus.lb),\n+\t\t\t   &(gfc_current_locus.nextc[7]));\n+\n+  /* Skip the rest of the line.  */\n+  skip_comment_line ();\n+\n+  return 1;\n+}\n+\n+\n /* Comment lines are null lines, lines containing only blanks or lines\n    on which the first nonblank line is a '!'.\n    Return true if !$ openmp conditional compilation sentinel was\n@@ -1505,8 +1552,18 @@ load_file (const char *filename, bool initial)\n \n       if (line[0] == '#')\n \t{\n-\t  preprocessor_line (line);\n-\t  continue;\n+\t  /* When -g3 is specified, it's possible that we emit #define\n+\t     and #undef lines, which we need to pass to the middle-end\n+\t     so that it can emit correct debug info.  */\n+\t  if (debug_info_level == DINFO_LEVEL_VERBOSE\n+\t      && (strncmp (line, \"#define \", 8) == 0\n+\t\t  || strncmp (line, \"#undef \", 7) == 0))\n+\t    ;\n+\t  else\n+\t    {\n+\t      preprocessor_line (line);\n+\t      continue;\n+\t    }\n \t}\n \n       /* Preprocessed files have preprocessor lines added before the byte"}]}