{"sha": "03c9c274624a94356dffd1cd62ff9669a8a1039a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDNjOWMyNzQ2MjRhOTQzNTZkZmZkMWNkNjJmZjk2NjlhOGExMDM5YQ==", "commit": {"author": {"name": "Nathan Sidwell", "email": "nathan@codesourcery.com", "date": "2001-12-29T17:10:10Z"}, "committer": {"name": "Nathan Sidwell", "email": "nathan@gcc.gnu.org", "date": "2001-12-29T17:10:10Z"}, "message": "re PR c++/335 (gcc accepts assignment in read-only structures)\n\ncp:\n\tPR c++/335\n\t* init.c (resolve_offset_ref): Copy cv qualifiers of this pointer\n\tfor non-reference fields.\n\t* typeck.c (require_complete_type): Use resolve_offset_ref).\ntestsuite:\n\t* g++.dg/other/const1.C: New test.\n\nFrom-SVN: r48369", "tree": {"sha": "d6c3ce64a187a221e478142f0138060f138530c8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d6c3ce64a187a221e478142f0138060f138530c8"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/03c9c274624a94356dffd1cd62ff9669a8a1039a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/03c9c274624a94356dffd1cd62ff9669a8a1039a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/03c9c274624a94356dffd1cd62ff9669a8a1039a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/03c9c274624a94356dffd1cd62ff9669a8a1039a/comments", "author": null, "committer": null, "parents": [{"sha": "1bf0567179b2828650b21eced842742526039651", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1bf0567179b2828650b21eced842742526039651", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1bf0567179b2828650b21eced842742526039651"}], "stats": {"total": 54, "additions": 42, "deletions": 12}, "files": [{"sha": "77d4c5dcff3688e2f2e732f81bcf3ccc17870f91", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=03c9c274624a94356dffd1cd62ff9669a8a1039a", "patch": "@@ -1,7 +1,14 @@\n+2001-12-29  Nathan Sidwell  <nathan@codesourcery.com>\n+\n+\tPR c++/335\n+\t* init.c (resolve_offset_ref): Copy cv qualifiers of this pointer\n+\tfor non-reference fields.\n+\t* typeck.c (require_complete_type): Use resolve_offset_ref).\n+\n 2001-12-26  Nathan Sidwell  <nathan@codesourcery.com>\n \n \tPR c++/196\n-\t* cp/parse.y (bad_parm): Better diagnostic when given a SCOPE_REF.\n+\t* parse.y (bad_parm): Better diagnostic when given a SCOPE_REF.\n \n 2001-12-24  Nathan Sidwell  <nathan@codesourcery.com>\n "}, {"sha": "f159f446e36519678e02bf939d22841f510d59b5", "filename": "gcc/cp/init.c", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Fcp%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Fcp%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.c?ref=03c9c274624a94356dffd1cd62ff9669a8a1039a", "patch": "@@ -1840,8 +1840,18 @@ resolve_offset_ref (exp)\n       if (expr == error_mark_node)\n \treturn error_mark_node;\n \n-      expr = build (COMPONENT_REF, TREE_TYPE (member),\n-\t\t    expr, member);\n+      type = TREE_TYPE (member);\n+      if (TREE_CODE (type) != REFERENCE_TYPE)\n+\t{\n+\t  int quals = cp_type_quals (type) | cp_type_quals (TREE_TYPE (expr));\n+\n+\t  if (DECL_MUTABLE_P (member))\n+\t    quals &= ~TYPE_QUAL_CONST;\n+\t  \n+\t  type = cp_build_qualified_type (type, quals);\n+\t}\n+      \n+      expr = build (COMPONENT_REF, type, expr, member);\n       return convert_from_reference (expr);\n     }\n "}, {"sha": "1ad9de21136310973f790806baa6b99a69483867", "filename": "gcc/cp/typeck.c", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Fcp%2Ftypeck.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Fcp%2Ftypeck.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck.c?ref=03c9c274624a94356dffd1cd62ff9669a8a1039a", "patch": "@@ -114,15 +114,7 @@ require_complete_type (value)\n       && current_class_ref != 0\n       && TREE_OPERAND (value, 0) == current_class_ref)\n     {\n-      tree base, member = TREE_OPERAND (value, 1);\n-      tree basetype = TYPE_OFFSET_BASETYPE (type);\n-      \n-      my_friendly_assert (TREE_CODE (member) == FIELD_DECL, 305);\n-      basetype = lookup_base (current_class_type, basetype, ba_check, NULL);\n-      base = build_base_path (PLUS_EXPR, current_class_ptr, basetype, 1);\n-      \n-      value = build (COMPONENT_REF, TREE_TYPE (member),\n-\t\t     build_indirect_ref (base, NULL), member);\n+      value = resolve_offset_ref (value);\n       return require_complete_type (value);\n     }\n "}, {"sha": "89cf0251068cdf24a15ac1d4e2388843b47027b3", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=03c9c274624a94356dffd1cd62ff9669a8a1039a", "patch": "@@ -1,3 +1,7 @@\n+2001-12-29  Nathan Sidwell  <nathan@codesourcery.com>\n+\n+\t* g++.dg/other/const1.C: New test.\n+\n 2001-12-29  Hans-Peter Nilsson  <hp@bitrange.com>\n \n \t* gcc.c-torture/compile/20011229-1.c: New test."}, {"sha": "1d5450a2cc068a956af21bae412c3e17fcd0e487", "filename": "gcc/testsuite/g++.dg/other/const1.C", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Fconst1.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/03c9c274624a94356dffd1cd62ff9669a8a1039a/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Fconst1.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fother%2Fconst1.C?ref=03c9c274624a94356dffd1cd62ff9669a8a1039a", "patch": "@@ -0,0 +1,17 @@\n+// { dg-do compile }\n+\n+// Copyright (C) 2001 Free Software Foundation, Inc.\n+// Contributed by Nathan Sidwell 26 Dec 2001 <nathan@nathan@codesourcery.com>\n+\n+// PR 335. Missed diagnostic\n+\n+struct Foo\n+{\n+  unsigned i;\n+  void Modify(unsigned j) const;\n+};\n+\n+void Foo::Modify(unsigned j) const\n+{\n+  Foo::i = j;  // { dg-error \"assignment of data-member\" \"\" }\n+}"}]}