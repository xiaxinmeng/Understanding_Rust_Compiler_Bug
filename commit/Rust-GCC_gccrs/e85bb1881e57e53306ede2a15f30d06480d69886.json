{"sha": "e85bb1881e57e53306ede2a15f30d06480d69886", "node_id": "C_kwDOANBUbNoAKGU4NWJiMTg4MWU1N2U1MzMwNmVkZTJhMTVmMzBkMDY0ODBkNjk4ODY", "commit": {"author": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-08-23T14:46:16Z"}, "committer": {"name": "Jonathan Wakely", "email": "jwakely@redhat.com", "date": "2022-08-23T15:35:07Z"}, "message": "libstdc++: Fix visit<void>(v) for non-void visitors [PR106589]\n\nThe optimization for the common case of std::visit forgot to handle the\nedge case of passing zero variants to a non-void visitor and converting\nthe result to void.\n\nlibstdc++-v3/ChangeLog:\n\n\tPR libstdc++/106589\n\t* include/std/variant (__do_visit): Handle is_void<R> for zero\n\targument case.\n\t* testsuite/20_util/variant/visit_r.cc: Check std::visit<void>(v).", "tree": {"sha": "c014f13ccd8023fd1c0d05780fdc5a3ba0fb53f7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c014f13ccd8023fd1c0d05780fdc5a3ba0fb53f7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e85bb1881e57e53306ede2a15f30d06480d69886", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e85bb1881e57e53306ede2a15f30d06480d69886", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e85bb1881e57e53306ede2a15f30d06480d69886", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e85bb1881e57e53306ede2a15f30d06480d69886/comments", "author": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jwakely", "id": 1254480, "node_id": "MDQ6VXNlcjEyNTQ0ODA=", "avatar_url": "https://avatars.githubusercontent.com/u/1254480?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jwakely", "html_url": "https://github.com/jwakely", "followers_url": "https://api.github.com/users/jwakely/followers", "following_url": "https://api.github.com/users/jwakely/following{/other_user}", "gists_url": "https://api.github.com/users/jwakely/gists{/gist_id}", "starred_url": "https://api.github.com/users/jwakely/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jwakely/subscriptions", "organizations_url": "https://api.github.com/users/jwakely/orgs", "repos_url": "https://api.github.com/users/jwakely/repos", "events_url": "https://api.github.com/users/jwakely/events{/privacy}", "received_events_url": "https://api.github.com/users/jwakely/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aeb9b58225916bc84a0cd02c6fc77bbb92167e53", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/aeb9b58225916bc84a0cd02c6fc77bbb92167e53", "html_url": "https://github.com/Rust-GCC/gccrs/commit/aeb9b58225916bc84a0cd02c6fc77bbb92167e53"}], "stats": {"total": 15, "additions": 14, "deletions": 1}, "files": [{"sha": "c234b54421e497b7920834096e3d00a45afc6e40", "filename": "libstdc++-v3/include/std/variant", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e85bb1881e57e53306ede2a15f30d06480d69886/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fvariant", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e85bb1881e57e53306ede2a15f30d06480d69886/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fvariant", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fstd%2Fvariant?ref=e85bb1881e57e53306ede2a15f30d06480d69886", "patch": "@@ -1728,7 +1728,12 @@ namespace __variant\n     {\n       // Get the silly case of visiting no variants out of the way first.\n       if constexpr (sizeof...(_Variants) == 0)\n-\treturn std::forward<_Visitor>(__visitor)();\n+\t{\n+\t  if constexpr (is_void_v<_Result_type>)\n+\t    return (void) std::forward<_Visitor>(__visitor)();\n+\t  else\n+\t    return std::forward<_Visitor>(__visitor)();\n+\t}\n       else\n \t{\n \t  constexpr size_t __max = 11; // \"These go to eleven.\""}, {"sha": "c77b259c386b55fe443286ba32e70ae4c81cfc3e", "filename": "libstdc++-v3/testsuite/20_util/variant/visit_r.cc", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e85bb1881e57e53306ede2a15f30d06480d69886/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fvariant%2Fvisit_r.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e85bb1881e57e53306ede2a15f30d06480d69886/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fvariant%2Fvisit_r.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F20_util%2Fvariant%2Fvisit_r.cc?ref=e85bb1881e57e53306ede2a15f30d06480d69886", "patch": "@@ -54,10 +54,18 @@ void test02()\n   std::visit<const void>(Visitor(), v);\n }\n \n+void test03()\n+{\n+  // PR libstdc++/106589 - visit<void> rejects lambdas that do not return void\n+  auto visitor = []{ return 0; };\n+  std::visit<void>(visitor);\n+  std::visit<void>(static_cast<int(*)()>(visitor));\n+}\n \n int\n main()\n {\n   test01();\n   test02();\n+  test03();\n }"}]}