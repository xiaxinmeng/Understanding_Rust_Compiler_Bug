{"sha": "02f03c5c826d0cb7c32398af0c4282921e6e072a", "node_id": "C_kwDOANBUbNoAKDAyZjAzYzVjODI2ZDBjYjdjMzIzOThhZjBjNDI4MjkyMWU2ZTA3MmE", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-05-02T09:30:58Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-05-02T09:30:58Z"}, "message": "expand: Throw away non-external decls without varpool nodes [PR105415]\n\nThe following testcase fails -fcompare-debug on aarch64-linux.  The problem\nis that for the n variable we create a varpool node, then remove it again\nbecause the var isn't really used, but it keeps being referenced in debug\nstmts/insns with -g.  Later during sched1 pass we ask whether the n var\ncan be modified through some store to an anchored variable and with -g\nwe create a new varpool node for it again just so that we can find its\nultimate alias target.  Even later on we create some cgraph node for the\nloop parallelization, but as there has been an extra varpool node creation\nin between, we get higher node->order with -g than without.\n\nThe patch fixes that by throwing variables without varpool nodes away\nduring expansion time, they are very unlikely to actually end up with\nuseful debug info anyway.\n\nI've bootstrapped/regtested the following on x86_64-linux and i686-linux,\nthen bootstrapped with the patch reverted, reapplied the patch and did make\ncc1plus in stage3.  The debug section sizes are identical, .debug_info and\n.debug_loc is identical too, so I think we don't lose any debug info through\nit.\nSo at least on cc1plus it makes no difference.\n\n2022-05-02  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR debug/105415\n\t* cfgexpand.cc (expand_debug_expr): Don't make_decl_rtl_for_debug\n\tif there is no symtab node for the VAR_DECL.\n\n\t* gcc.dg/pr105415.c: New test.", "tree": {"sha": "3db475878e5720078854028530829ad33afc4640", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3db475878e5720078854028530829ad33afc4640"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/02f03c5c826d0cb7c32398af0c4282921e6e072a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/02f03c5c826d0cb7c32398af0c4282921e6e072a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/02f03c5c826d0cb7c32398af0c4282921e6e072a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/02f03c5c826d0cb7c32398af0c4282921e6e072a/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "880a9845dc126e10ceb07b846d5a4c5b167b5185", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/880a9845dc126e10ceb07b846d5a4c5b167b5185", "html_url": "https://github.com/Rust-GCC/gccrs/commit/880a9845dc126e10ceb07b846d5a4c5b167b5185"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "49b91827e83fc8d0baceaba769d2d746f01c5d0e", "filename": "gcc/cfgexpand.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/02f03c5c826d0cb7c32398af0c4282921e6e072a/gcc%2Fcfgexpand.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/02f03c5c826d0cb7c32398af0c4282921e6e072a/gcc%2Fcfgexpand.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfgexpand.cc?ref=02f03c5c826d0cb7c32398af0c4282921e6e072a", "patch": "@@ -4565,7 +4565,8 @@ expand_debug_expr (tree exp)\n \t      || !DECL_NAME (exp)\n \t      || DECL_HARD_REGISTER (exp)\n \t      || DECL_IN_CONSTANT_POOL (exp)\n-\t      || mode == VOIDmode)\n+\t      || mode == VOIDmode\n+\t      || symtab_node::get (exp) == NULL)\n \t    return NULL;\n \n \t  op0 = make_decl_rtl_for_debug (exp);"}, {"sha": "4603c0cb6e12f7c296e40dec0f1209b34a4c21ff", "filename": "gcc/testsuite/gcc.dg/pr105415.c", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/02f03c5c826d0cb7c32398af0c4282921e6e072a/gcc%2Ftestsuite%2Fgcc.dg%2Fpr105415.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/02f03c5c826d0cb7c32398af0c4282921e6e072a/gcc%2Ftestsuite%2Fgcc.dg%2Fpr105415.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fpr105415.c?ref=02f03c5c826d0cb7c32398af0c4282921e6e072a", "patch": "@@ -0,0 +1,26 @@\n+/* PR debug/105415 */\n+/* { dg-do compile } */\n+/* { dg-require-effective-target pthread } */\n+/* { dg-options \"-O2 -ftree-parallelize-loops=2 -fcompare-debug\" } */\n+\n+int m;\n+static int n;\n+\n+void\n+foo (void)\n+{\n+  int s = 0;\n+\n+  while (m < 1)\n+    {\n+      s += n;\n+      ++m;\n+    }\n+}\n+\n+void\n+bar (int *arr, int i)\n+{\n+  while (i < 1)\n+    arr[i++] = 1;\n+}"}]}