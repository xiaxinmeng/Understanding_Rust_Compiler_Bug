{"sha": "f1a58ab0db20c0862e8b5039bd448fc8c9799cac", "node_id": "C_kwDOANBUbNoAKGYxYTU4YWIwZGIyMGMwODYyZThiNTAzOWJkNDQ4ZmM4Yzk3OTljYWM", "commit": {"author": {"name": "Kwok Cheung Yeung", "email": "kcy@codesourcery.com", "date": "2020-03-13T18:13:49Z"}, "committer": {"name": "Thomas Schwinge", "email": "thomas@codesourcery.com", "date": "2021-11-30T11:58:53Z"}, "message": "[OpenACC] Allow gang reductions inside serial constructs\n\n... fixing a regression introduced in the preceding\ncommit 2b7dac2c0dcb087da9e4018943c023c0678234a3\n\"Make OpenACC orphan gang reductions errors\".\n\n\tgcc/fortran/\n\t* openmp.c (oacc_is_serial, oacc_is_parallel_or_serial): New.\n\t(resolve_oacc_loop_blocks): Use oacc_is_parallel_or_serial instead of\n\toacc_is_parallel.\n\tlibgomp/\n\t* testsuite/libgomp.oacc-fortran/parallel-dims.f90: Remove\n\ttemporary skip.\n\nCo-Authored-By: Thomas Schwinge <thomas@codesourcery.com>", "tree": {"sha": "3f246461e72da66268f850e8a4a09aaa831ef6aa", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3f246461e72da66268f850e8a4a09aaa831ef6aa"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f1a58ab0db20c0862e8b5039bd448fc8c9799cac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f1a58ab0db20c0862e8b5039bd448fc8c9799cac", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f1a58ab0db20c0862e8b5039bd448fc8c9799cac", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f1a58ab0db20c0862e8b5039bd448fc8c9799cac/comments", "author": {"login": "k-yeung", "id": 16960193, "node_id": "MDQ6VXNlcjE2OTYwMTkz", "avatar_url": "https://avatars.githubusercontent.com/u/16960193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/k-yeung", "html_url": "https://github.com/k-yeung", "followers_url": "https://api.github.com/users/k-yeung/followers", "following_url": "https://api.github.com/users/k-yeung/following{/other_user}", "gists_url": "https://api.github.com/users/k-yeung/gists{/gist_id}", "starred_url": "https://api.github.com/users/k-yeung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/k-yeung/subscriptions", "organizations_url": "https://api.github.com/users/k-yeung/orgs", "repos_url": "https://api.github.com/users/k-yeung/repos", "events_url": "https://api.github.com/users/k-yeung/events{/privacy}", "received_events_url": "https://api.github.com/users/k-yeung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tschwinge", "id": 21753, "node_id": "MDQ6VXNlcjIxNzUz", "avatar_url": "https://avatars.githubusercontent.com/u/21753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tschwinge", "html_url": "https://github.com/tschwinge", "followers_url": "https://api.github.com/users/tschwinge/followers", "following_url": "https://api.github.com/users/tschwinge/following{/other_user}", "gists_url": "https://api.github.com/users/tschwinge/gists{/gist_id}", "starred_url": "https://api.github.com/users/tschwinge/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tschwinge/subscriptions", "organizations_url": "https://api.github.com/users/tschwinge/orgs", "repos_url": "https://api.github.com/users/tschwinge/repos", "events_url": "https://api.github.com/users/tschwinge/events{/privacy}", "received_events_url": "https://api.github.com/users/tschwinge/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b7dac2c0dcb087da9e4018943c023c0678234a3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2b7dac2c0dcb087da9e4018943c023c0678234a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2b7dac2c0dcb087da9e4018943c023c0678234a3"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "b4100577e51ec8bdd96aca56d5bfaacce7e9a939", "filename": "gcc/fortran/openmp.c", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f1a58ab0db20c0862e8b5039bd448fc8c9799cac/gcc%2Ffortran%2Fopenmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f1a58ab0db20c0862e8b5039bd448fc8c9799cac/gcc%2Ffortran%2Fopenmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fopenmp.c?ref=f1a58ab0db20c0862e8b5039bd448fc8c9799cac", "patch": "@@ -8334,6 +8334,18 @@ oacc_is_kernels (gfc_code *code)\n   return code->op == EXEC_OACC_KERNELS || code->op == EXEC_OACC_KERNELS_LOOP;\n }\n \n+static bool\n+oacc_is_serial (gfc_code *code)\n+{\n+  return code->op == EXEC_OACC_SERIAL || code->op == EXEC_OACC_SERIAL_LOOP;\n+}\n+\n+static bool\n+oacc_is_parallel_or_serial (gfc_code *code)\n+{\n+  return oacc_is_parallel (code) || oacc_is_serial (code);\n+}\n+\n static gfc_statement\n omp_code_to_statement (gfc_code *code)\n {\n@@ -8644,7 +8656,7 @@ resolve_oacc_loop_blocks (gfc_code *code)\n       for (c = omp_current_ctx; c; c = c->previous)\n \tif (!oacc_is_loop (c->code))\n \t  break;\n-      if (c == NULL || !(oacc_is_parallel (c->code)\n+      if (c == NULL || !(oacc_is_parallel_or_serial (c->code)\n \t\t\t || oacc_is_kernels (c->code)))\n \tgfc_error (\"gang reduction on an orphan loop at %L\", &code->loc);\n     }"}, {"sha": "fad3d9d6a80764112b3de6e2e0cdffaa3cd6f3db", "filename": "libgomp/testsuite/libgomp.oacc-fortran/parallel-dims.f90", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f1a58ab0db20c0862e8b5039bd448fc8c9799cac/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fparallel-dims.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f1a58ab0db20c0862e8b5039bd448fc8c9799cac/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fparallel-dims.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fparallel-dims.f90?ref=f1a58ab0db20c0862e8b5039bd448fc8c9799cac", "patch": "@@ -3,7 +3,6 @@\n \n ! { dg-additional-sources parallel-dims-aux.c }\n ! { dg-do run }\n-  ! { dg-skip-if TODO { *-*-* } }\n ! { dg-prune-output \"command-line option '-fintrinsic-modules-path=.*' is valid for Fortran but not for C\" }\n \n ! { dg-additional-options \"-fopt-info-note-omp\" }"}]}