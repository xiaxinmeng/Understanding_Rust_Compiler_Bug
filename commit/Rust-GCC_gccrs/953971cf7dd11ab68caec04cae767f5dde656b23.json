{"sha": "953971cf7dd11ab68caec04cae767f5dde656b23", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTUzOTcxY2Y3ZGQxMWFiNjhjYWVjMDRjYWU3NjdmNWRkZTY1NmIyMw==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2014-12-04T21:11:04Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2014-12-04T21:11:04Z"}, "message": "PR jit/63854: Fix leak of ipa hooks\n\ngcc/ChangeLog:\n\tPR jit/63854\n\t* ipa-prop.c (ipa_register_cgraph_hooks): Guard insertion of\n\tipa_add_new_function on function_insertion_hook_holder being\n\tnon-NULL.\n\t* ipa-reference.c (ipa_reference_c_finalize): Remove\n\tnode_removal_hook_holder and node_duplication_hook_holder if\n\tthey've been added to symtab.\n\t* toplev.c (toplev::finalize): Call ipa_reference_c_finalize\n\tbefore cgraph_c_finalize so that the former can access \"symtab\".\n\nFrom-SVN: r218403", "tree": {"sha": "66c55eb5136f95f1adbef64e69d922fc0b3b6a35", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/66c55eb5136f95f1adbef64e69d922fc0b3b6a35"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/953971cf7dd11ab68caec04cae767f5dde656b23", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/953971cf7dd11ab68caec04cae767f5dde656b23", "html_url": "https://github.com/Rust-GCC/gccrs/commit/953971cf7dd11ab68caec04cae767f5dde656b23", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/953971cf7dd11ab68caec04cae767f5dde656b23/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "ef9f382ca52a80bb8575d73d7cc8d3ddbf5f7ad7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ef9f382ca52a80bb8575d73d7cc8d3ddbf5f7ad7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ef9f382ca52a80bb8575d73d7cc8d3ddbf5f7ad7"}], "stats": {"total": 30, "additions": 28, "deletions": 2}, "files": [{"sha": "3efe39e9f8c94dab4aa977ed8b6e48f1de769d28", "filename": "gcc/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=953971cf7dd11ab68caec04cae767f5dde656b23", "patch": "@@ -1,3 +1,15 @@\n+2014-12-04  David Malcolm  <dmalcolm@redhat.com>\n+\n+\tPR jit/63854\n+\t* ipa-prop.c (ipa_register_cgraph_hooks): Guard insertion of\n+\tipa_add_new_function on function_insertion_hook_holder being\n+\tnon-NULL.\n+\t* ipa-reference.c (ipa_reference_c_finalize): Remove\n+\tnode_removal_hook_holder and node_duplication_hook_holder if\n+\tthey've been added to symtab.\n+\t* toplev.c (toplev::finalize): Call ipa_reference_c_finalize\n+\tbefore cgraph_c_finalize so that the former can access \"symtab\".\n+\n 2014-12-04  David Malcolm  <dmalcolm@redhat.com>\n \n \t* doc/cfg.texi (GIMPLE statement iterators): Add note about"}, {"sha": "eb83ae00baa4421833b15877bc027b219429dcee", "filename": "gcc/ipa-prop.c", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2Fipa-prop.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2Fipa-prop.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-prop.c?ref=953971cf7dd11ab68caec04cae767f5dde656b23", "patch": "@@ -3613,7 +3613,8 @@ ipa_register_cgraph_hooks (void)\n   if (!node_duplication_hook_holder)\n     node_duplication_hook_holder =\n       symtab->add_cgraph_duplication_hook (&ipa_node_duplication_hook, NULL);\n-  function_insertion_hook_holder =\n+  if (!function_insertion_hook_holder)\n+    function_insertion_hook_holder =\n       symtab->add_cgraph_insertion_hook (&ipa_add_new_function, NULL);\n }\n "}, {"sha": "b046f9ee1d0645ecc41804dbd5eed74bf21453bb", "filename": "gcc/ipa-reference.c", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2Fipa-reference.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2Fipa-reference.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-reference.c?ref=953971cf7dd11ab68caec04cae767f5dde656b23", "patch": "@@ -1198,4 +1198,15 @@ ipa_reference_c_finalize (void)\n       bitmap_obstack_release (&optimization_summary_obstack);\n       ipa_init_p = false;\n     }\n+\n+  if (node_removal_hook_holder)\n+    {\n+      symtab->remove_cgraph_removal_hook (node_removal_hook_holder);\n+      node_removal_hook_holder = NULL;\n+    }\n+  if (node_duplication_hook_holder)\n+    {\n+      symtab->remove_cgraph_duplication_hook (node_duplication_hook_holder);\n+      node_duplication_hook_holder = NULL;\n+    }\n }"}, {"sha": "911084db375cf24343f992dc2f1b793af3d93c67", "filename": "gcc/toplev.c", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2Ftoplev.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/953971cf7dd11ab68caec04cae767f5dde656b23/gcc%2Ftoplev.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftoplev.c?ref=953971cf7dd11ab68caec04cae767f5dde656b23", "patch": "@@ -2163,12 +2163,14 @@ toplev::finalize (void)\n   rtl_initialized = false;\n   this_target_rtl->target_specific_initialized = false;\n \n+  /* Needs to be called before cgraph_c_finalize since it uses symtab.  */\n+  ipa_reference_c_finalize ();\n+\n   cgraph_c_finalize ();\n   cgraphunit_c_finalize ();\n   dwarf2out_c_finalize ();\n   gcse_c_finalize ();\n   ipa_cp_c_finalize ();\n-  ipa_reference_c_finalize ();\n   ira_costs_c_finalize ();\n   params_c_finalize ();\n "}]}