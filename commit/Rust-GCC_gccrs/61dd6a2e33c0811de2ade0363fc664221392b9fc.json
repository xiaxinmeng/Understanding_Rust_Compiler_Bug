{"sha": "61dd6a2e33c0811de2ade0363fc664221392b9fc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjFkZDZhMmUzM2MwODExZGUyYWRlMDM2M2ZjNjY0MjIxMzkyYjlmYw==", "commit": {"author": {"name": "Jan Hubicka", "email": "hubicka@ucw.cz", "date": "2013-12-17T10:26:59Z"}, "committer": {"name": "Jan Hubicka", "email": "hubicka@gcc.gnu.org", "date": "2013-12-17T10:26:59Z"}, "message": "devirt-13.C: Update template.\n\n\t* g++.dg/ipa/devirt-13.C: Update template.\n\t* ipa-utils.h (possible_polymorphic_call_targets): Determine context of\n\tthe call.\n\t* gimple-fold.c (gimple_fold_call): Use ipa-devirt to devirtualize.\n\nFrom-SVN: r206042", "tree": {"sha": "4d856e80811b852c42ef9f8f19bba037088ea175", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4d856e80811b852c42ef9f8f19bba037088ea175"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/61dd6a2e33c0811de2ade0363fc664221392b9fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/61dd6a2e33c0811de2ade0363fc664221392b9fc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/61dd6a2e33c0811de2ade0363fc664221392b9fc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/61dd6a2e33c0811de2ade0363fc664221392b9fc/comments", "author": null, "committer": null, "parents": [{"sha": "2477c234e2d89f875e19d4b6d112b7c321b46a55", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2477c234e2d89f875e19d4b6d112b7c321b46a55", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2477c234e2d89f875e19d4b6d112b7c321b46a55"}], "stats": {"total": 49, "additions": 30, "deletions": 19}, "files": [{"sha": "7da6fc478cb629842bd00be0755fc4e5d97ddb4f", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=61dd6a2e33c0811de2ade0363fc664221392b9fc", "patch": "@@ -1,3 +1,9 @@\n+2013-12-17  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* ipa-utils.h (possible_polymorphic_call_targets): Determine context of\n+\tthe call.\n+\t* gimple-fold.c (gimple_fold_call): Use ipa-devirt to devirtualize.\n+\n 2013-12-17  Jakub Jelinek  <jakub@redhat.com>\n \n \t* expr.c (convert_modes): For SUBREG_PROMOTED_VAR_P use SUBREG_REG (x)"}, {"sha": "767c869a476eb9b76cb3fbbbec25ec3491a01788", "filename": "gcc/gimple-fold.c", "status": "modified", "additions": 12, "deletions": 18, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2Fgimple-fold.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2Fgimple-fold.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-fold.c?ref=61dd6a2e33c0811de2ade0363fc664221392b9fc", "patch": "@@ -1153,26 +1153,20 @@ gimple_fold_call (gimple_stmt_iterator *gsi, bool inplace)\n \t  gimple_call_set_fn (stmt, OBJ_TYPE_REF_EXPR (callee));\n \t  changed = true;\n \t}\n-      else if (virtual_method_call_p (callee))\n+      else if (flag_devirtualize && virtual_method_call_p (callee))\n \t{\n-\t  tree obj = OBJ_TYPE_REF_OBJECT (callee);\n-\t  tree binfo = gimple_extract_devirt_binfo_from_cst\n-\t\t (obj, obj_type_ref_class (callee));\n-\t  if (binfo)\n+\t  bool final;\n+\t  vec <cgraph_node *>targets\n+\t    = possible_polymorphic_call_targets (callee, &final);\n+\t  if (final && targets.length () <= 1)\n \t    {\n-\t      HOST_WIDE_INT token\n-\t\t= TREE_INT_CST_LOW (OBJ_TYPE_REF_TOKEN (callee));\n-\t      tree fndecl = gimple_get_virt_method_for_binfo (token, binfo);\n-\t      if (fndecl)\n-\t\t{\n-#ifdef ENABLE_CHECKING\n-\t\t  gcc_assert (possible_polymorphic_call_target_p\n-\t\t\t\t (callee, cgraph_get_node (fndecl)));\n-\n-#endif\n-\t\t  gimple_call_set_fndecl (stmt, fndecl);\n-\t\t  changed = true;\n-\t\t}\n+\t      tree fndecl;\n+\t      if (targets.length () == 1)\n+\t\tfndecl = targets[0]->decl;\n+\t      else\n+\t\tfndecl = builtin_decl_implicit (BUILT_IN_UNREACHABLE);\n+\t      gimple_call_set_fndecl (stmt, fndecl);\n+\t      changed = true;\n \t    }\n \t}\n     }"}, {"sha": "480b7529bedc4b9e43f10f3f66c44214368e57b2", "filename": "gcc/ipa-utils.h", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2Fipa-utils.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2Fipa-utils.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fipa-utils.h?ref=61dd6a2e33c0811de2ade0363fc664221392b9fc", "patch": "@@ -121,10 +121,17 @@ possible_polymorphic_call_targets (tree call,\n \t\t\t\t   bool *final = NULL,\n \t\t\t\t   void **cache_token = NULL)\n {\n+  tree otr_type;\n+  HOST_WIDE_INT otr_token;\n+  ipa_polymorphic_call_context context;\n+\n+  get_polymorphic_call_info (current_function_decl,\n+\t\t\t     call,\n+\t\t\t     &otr_type, &otr_token, &context);\n   return possible_polymorphic_call_targets (obj_type_ref_class (call),\n \t\t\t\t\t    tree_to_uhwi\n \t\t\t\t\t      (OBJ_TYPE_REF_TOKEN (call)),\n-\t\t\t\t\t    ipa_dummy_polymorphic_call_context,\n+\t\t\t\t\t    context,\n \t\t\t\t\t    final, cache_token);\n }\n "}, {"sha": "ec35aeafa7dbeca1168ef47d63307d68e4eadde6", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/61dd6a2e33c0811de2ade0363fc664221392b9fc/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=61dd6a2e33c0811de2ade0363fc664221392b9fc", "patch": "@@ -1,3 +1,7 @@\n+2013-12-17  Jan Hubicka  <hubicka@ucw.cz>\n+\n+\t* g++.dg/ipa/devirt-13.C: Update template.\n+\n 2013-12-16  Janus Weil  <janus@gcc.gnu.org>\n \n \tPR fortran/54949"}]}