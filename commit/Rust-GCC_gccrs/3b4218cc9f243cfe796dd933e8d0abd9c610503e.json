{"sha": "3b4218cc9f243cfe796dd933e8d0abd9c610503e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6M2I0MjE4Y2M5ZjI0M2NmZTc5NmRkOTMzZThkMGFiZDljNjEwNTAzZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2019-01-24T19:17:13Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2019-01-24T19:17:13Z"}, "message": "re PR middle-end/89015 (ICE in lookup_decl_in_outer_ctx, at omp-low.c:3480)\n\n\tPR middle-end/89015\n\t* tree-nested.c (convert_nonlocal_reference_stmt,\n\tconvert_local_reference_stmt, convert_tramp_reference_stmt,\n\tconvert_gimple_call) <case GIMPLE_OMP_TEAMS>: Treat\n\tgimple_omp_teams_host teams stmts like GIMPLE_OMP_PARALLEL\n\tor GIMPLE_OMP_TASK.\n\n\t* gcc.dg/gomp/pr89015.c: New test.\n\nFrom-SVN: r268246", "tree": {"sha": "baa0aa52cb31982ee276ae970e04d25830cec389", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/baa0aa52cb31982ee276ae970e04d25830cec389"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3b4218cc9f243cfe796dd933e8d0abd9c610503e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b4218cc9f243cfe796dd933e8d0abd9c610503e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3b4218cc9f243cfe796dd933e8d0abd9c610503e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3b4218cc9f243cfe796dd933e8d0abd9c610503e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "e21c4491293763b5dc61664b6a2292c3a8fc8ae1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e21c4491293763b5dc61664b6a2292c3a8fc8ae1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e21c4491293763b5dc61664b6a2292c3a8fc8ae1"}], "stats": {"total": 96, "additions": 79, "deletions": 17}, "files": [{"sha": "7087ef1a4f5c79e77ae74be102eb68d52ac58c3e", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=3b4218cc9f243cfe796dd933e8d0abd9c610503e", "patch": "@@ -1,5 +1,12 @@\n 2019-01-24  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR middle-end/89015\n+\t* tree-nested.c (convert_nonlocal_reference_stmt,\n+\tconvert_local_reference_stmt, convert_tramp_reference_stmt,\n+\tconvert_gimple_call) <case GIMPLE_OMP_TEAMS>: Treat\n+\tgimple_omp_teams_host teams stmts like GIMPLE_OMP_PARALLEL\n+\tor GIMPLE_OMP_TASK.\n+\n \tPR tree-optimization/89027\n \t* tree-inline.c (add_clobbers_to_eh_landing_pad): Don't add clobbers\n \tfor \"omp simd array\" variables."}, {"sha": "f7423fe9b382d1a8ae8020df3a9eae560a291da2", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=3b4218cc9f243cfe796dd933e8d0abd9c610503e", "patch": "@@ -1,5 +1,8 @@\n 2019-01-24  Jakub Jelinek  <jakub@redhat.com>\n \n+\tPR middle-end/89015\n+\t* gcc.dg/gomp/pr89015.c: New test.\n+\n \tPR c++/88976\n \t* c-c++-common/gomp/cancel-2.c: New test.\n \t* gcc.dg/gomp/cancel-1.c: New test."}, {"sha": "90363517172fe741089b81647bca8611e6448946", "filename": "gcc/testsuite/gcc.dg/gomp/pr89015.c", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr89015.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr89015.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fgomp%2Fpr89015.c?ref=3b4218cc9f243cfe796dd933e8d0abd9c610503e", "patch": "@@ -0,0 +1,25 @@\n+/* PR middle-end/89015 */\n+/* { dg-do compile } */\n+\n+int\n+foo (int n, float *x, float *y)\n+{\n+  int i;\n+  int bar (void) { return i; }\n+#pragma omp teams distribute parallel for simd\n+  for (i = 0; i < n; i++)\n+    y[i] = x[i];\n+  return bar ();\n+}\n+\n+int\n+baz (int n, float *x, float *y)\n+{\n+  int i;\n+  int qux (void) {\n+#pragma omp teams distribute parallel for simd\n+    for (i = 0; i < n; i++)\n+      y[i] = x[i];\n+  }\n+  return qux ();\n+}"}, {"sha": "3fe23cc2b22a00ff629c9da0a13456bbccf14f4e", "filename": "gcc/tree-nested.c", "status": "modified", "additions": 44, "deletions": 17, "changes": 61, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2Ftree-nested.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3b4218cc9f243cfe796dd933e8d0abd9c610503e/gcc%2Ftree-nested.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-nested.c?ref=3b4218cc9f243cfe796dd933e8d0abd9c610503e", "patch": "@@ -1497,6 +1497,20 @@ convert_nonlocal_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n \t}\n       break;\n \n+    case GIMPLE_OMP_TEAMS:\n+      if (!gimple_omp_teams_host (as_a <gomp_teams *> (stmt)))\n+\t{\n+\t  save_suppress = info->suppress_expansion;\n+\t  convert_nonlocal_omp_clauses (gimple_omp_teams_clauses_ptr (stmt),\n+\t\t\t\t\twi);\n+\t  walk_body (convert_nonlocal_reference_stmt,\n+\t\t     convert_nonlocal_reference_op, info,\n+\t\t     gimple_omp_body_ptr (stmt));\n+\t  info->suppress_expansion = save_suppress;\n+\t  break;\n+\t}\n+      /* FALLTHRU */\n+\n     case GIMPLE_OMP_PARALLEL:\n     case GIMPLE_OMP_TASK:\n       save_suppress = info->suppress_expansion;\n@@ -1601,14 +1615,6 @@ convert_nonlocal_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n       info->suppress_expansion = save_suppress;\n       break;\n \n-    case GIMPLE_OMP_TEAMS:\n-      save_suppress = info->suppress_expansion;\n-      convert_nonlocal_omp_clauses (gimple_omp_teams_clauses_ptr (stmt), wi);\n-      walk_body (convert_nonlocal_reference_stmt, convert_nonlocal_reference_op,\n-\t\t info, gimple_omp_body_ptr (stmt));\n-      info->suppress_expansion = save_suppress;\n-      break;\n-\n     case GIMPLE_OMP_SECTION:\n     case GIMPLE_OMP_MASTER:\n     case GIMPLE_OMP_ORDERED:\n@@ -2168,6 +2174,18 @@ convert_local_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n \n   switch (gimple_code (stmt))\n     {\n+    case GIMPLE_OMP_TEAMS:\n+      if (!gimple_omp_teams_host (as_a <gomp_teams *> (stmt)))\n+\t{\n+\t  save_suppress = info->suppress_expansion;\n+\t  convert_local_omp_clauses (gimple_omp_teams_clauses_ptr (stmt), wi);\n+\t  walk_body (convert_local_reference_stmt, convert_local_reference_op,\n+\t\t     info, gimple_omp_body_ptr (stmt));\n+\t  info->suppress_expansion = save_suppress;\n+\t  break;\n+\t}\n+      /* FALLTHRU */\n+\n     case GIMPLE_OMP_PARALLEL:\n     case GIMPLE_OMP_TASK:\n       save_suppress = info->suppress_expansion;\n@@ -2299,14 +2317,6 @@ convert_local_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n       info->static_chain_added |= save_static_chain_added;\n       break;\n \n-    case GIMPLE_OMP_TEAMS:\n-      save_suppress = info->suppress_expansion;\n-      convert_local_omp_clauses (gimple_omp_teams_clauses_ptr (stmt), wi);\n-      walk_body (convert_local_reference_stmt, convert_local_reference_op,\n-\t\t info, gimple_omp_body_ptr (stmt));\n-      info->suppress_expansion = save_suppress;\n-      break;\n-\n     case GIMPLE_OMP_SECTION:\n     case GIMPLE_OMP_MASTER:\n     case GIMPLE_OMP_ORDERED:\n@@ -2607,6 +2617,14 @@ convert_tramp_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n \tbreak;\n       }\n \n+    case GIMPLE_OMP_TEAMS:\n+      if (!gimple_omp_teams_host (as_a <gomp_teams *> (stmt)))\n+\t{\n+\t  *handled_ops_p = false;\n+\t  return NULL_TREE;\n+\t}\n+      goto do_parallel;\n+\n     case GIMPLE_OMP_TARGET:\n       if (!is_gimple_omp_offloaded (stmt))\n \t{\n@@ -2616,6 +2634,7 @@ convert_tramp_reference_stmt (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n       /* FALLTHRU */\n     case GIMPLE_OMP_PARALLEL:\n     case GIMPLE_OMP_TASK:\n+    do_parallel:\n       {\n \ttree save_local_var_chain = info->new_local_var_chain;\n         walk_gimple_op (stmt, convert_tramp_reference_op, wi);\n@@ -2723,6 +2742,15 @@ convert_gimple_call (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n \t}\n       break;\n \n+    case GIMPLE_OMP_TEAMS:\n+      if (!gimple_omp_teams_host (as_a <gomp_teams *> (stmt)))\n+\t{\n+\t  walk_body (convert_gimple_call, NULL, info,\n+\t\t     gimple_omp_body_ptr (stmt));\n+\t  break;\n+\t}\n+      /* FALLTHRU */\n+\n     case GIMPLE_OMP_PARALLEL:\n     case GIMPLE_OMP_TASK:\n       save_static_chain_added = info->static_chain_added;\n@@ -2798,7 +2826,6 @@ convert_gimple_call (gimple_stmt_iterator *gsi, bool *handled_ops_p,\n     case GIMPLE_OMP_SECTIONS:\n     case GIMPLE_OMP_SECTION:\n     case GIMPLE_OMP_SINGLE:\n-    case GIMPLE_OMP_TEAMS:\n     case GIMPLE_OMP_MASTER:\n     case GIMPLE_OMP_TASKGROUP:\n     case GIMPLE_OMP_ORDERED:"}]}