{"sha": "ec1db9017939bb8289c9bd63aace66c0f3957ecd", "node_id": "C_kwDOANBUbNoAKGVjMWRiOTAxNzkzOWJiODI4OWM5YmQ2M2FhY2U2NmMwZjM5NTdlY2Q", "commit": {"author": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2022-12-09T17:47:55Z"}, "committer": {"name": "Alexander Monakov", "email": "amonakov@ispras.ru", "date": "2023-01-02T16:38:56Z"}, "message": "i386: correct division modeling in lujiazui.md\n\nModel the divider in Lujiazui processors as a separate automaton to\nsignificantly reduce the overall model size. This should also result\nin improved accuracy, as pipe 0 should be able to accept new\ninstructions while the divider is occupied.\n\nIt is unclear why integer divisions are modeled as if pipes 0-3 are all\noccupied. I've opted to keep a single-cycle reservation of all four\npipes together, so GCC should continue trying to pack instructions\naround a division accordingly.\n\nCurrently top three symbols in insn-automata.o are:\n\n106102 r lujiazui_core_check\n106102 r lujiazui_core_transitions\n196123 r lujiazui_core_min_issue_delay\n\nThis patch shrinks all lujiazui tables to:\n\n3 r lujiazui_decoder_min_issue_delay\n20 r lujiazui_decoder_transitions\n32 r lujiazui_agu_min_issue_delay\n126 r lujiazui_agu_transitions\n304 r lujiazui_div_base\n352 r lujiazui_div_check\n352 r lujiazui_div_transitions\n1152 r lujiazui_core_min_issue_delay\n1592 r lujiazui_agu_translate\n1592 r lujiazui_core_translate\n1592 r lujiazui_decoder_translate\n1592 r lujiazui_div_translate\n3952 r lujiazui_div_min_issue_delay\n9216 r lujiazui_core_transitions\n\nThis continues the work on reducing i386 insn-automata.o size started\nwith similar fixes for division and multiplication instructions in\nznver.md.\n\ngcc/ChangeLog:\n\n\tPR target/87832\n\t* config/i386/lujiazui.md (lujiazui_div): New automaton.\n\t(lua_div): New unit.\n\t(lua_idiv_qi): Correct unit in the reservation.\n\t(lua_idiv_qi_load): Ditto.\n\t(lua_idiv_hi): Ditto.\n\t(lua_idiv_hi_load): Ditto.\n\t(lua_idiv_si): Ditto.\n\t(lua_idiv_si_load): Ditto.\n\t(lua_idiv_di): Ditto.\n\t(lua_idiv_di_load): Ditto.\n\t(lua_fdiv_SF): Ditto.\n\t(lua_fdiv_SF_load): Ditto.\n\t(lua_fdiv_DF): Ditto.\n\t(lua_fdiv_DF_load): Ditto.\n\t(lua_fdiv_XF): Ditto.\n\t(lua_fdiv_XF_load): Ditto.\n\t(lua_ssediv_SF): Ditto.\n\t(lua_ssediv_load_SF): Ditto.\n\t(lua_ssediv_V4SF): Ditto.\n\t(lua_ssediv_load_V4SF): Ditto.\n\t(lua_ssediv_V8SF): Ditto.\n\t(lua_ssediv_load_V8SF): Ditto.\n\t(lua_ssediv_SD): Ditto.\n\t(lua_ssediv_load_SD): Ditto.\n\t(lua_ssediv_V2DF): Ditto.\n\t(lua_ssediv_load_V2DF): Ditto.\n\t(lua_ssediv_V4DF): Ditto.\n\t(lua_ssediv_load_V4DF): Ditto.", "tree": {"sha": "aefae9b127ebcaf0084efb2d316bad5081b811db", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/aefae9b127ebcaf0084efb2d316bad5081b811db"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/ec1db9017939bb8289c9bd63aace66c0f3957ecd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec1db9017939bb8289c9bd63aace66c0f3957ecd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/ec1db9017939bb8289c9bd63aace66c0f3957ecd", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/ec1db9017939bb8289c9bd63aace66c0f3957ecd/comments", "author": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "amonakov", "id": 1997391, "node_id": "MDQ6VXNlcjE5OTczOTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1997391?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amonakov", "html_url": "https://github.com/amonakov", "followers_url": "https://api.github.com/users/amonakov/followers", "following_url": "https://api.github.com/users/amonakov/following{/other_user}", "gists_url": "https://api.github.com/users/amonakov/gists{/gist_id}", "starred_url": "https://api.github.com/users/amonakov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amonakov/subscriptions", "organizations_url": "https://api.github.com/users/amonakov/orgs", "repos_url": "https://api.github.com/users/amonakov/repos", "events_url": "https://api.github.com/users/amonakov/events{/privacy}", "received_events_url": "https://api.github.com/users/amonakov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb775ecd6e437de8fdba9a3f173f3787e90e98f2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb775ecd6e437de8fdba9a3f173f3787e90e98f2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cb775ecd6e437de8fdba9a3f173f3787e90e98f2"}], "stats": {"total": 58, "additions": 30, "deletions": 28}, "files": [{"sha": "58a230c70f4b56827996ba3ee10ed52c856264f5", "filename": "gcc/config/i386/lujiazui.md", "status": "modified", "additions": 30, "deletions": 28, "changes": 58, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/ec1db9017939bb8289c9bd63aace66c0f3957ecd/gcc%2Fconfig%2Fi386%2Flujiazui.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/ec1db9017939bb8289c9bd63aace66c0f3957ecd/gcc%2Fconfig%2Fi386%2Flujiazui.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fi386%2Flujiazui.md?ref=ec1db9017939bb8289c9bd63aace66c0f3957ecd", "patch": "@@ -19,8 +19,8 @@\n \n ;; Scheduling for ZHAOXIN lujiazui processor.\n \n-;; Modeling automatons for decoders, execution pipes and AGU pipes.\n-(define_automaton \"lujiazui_decoder,lujiazui_core,lujiazui_agu\")\n+;; Modeling automatons for decoders, execution pipes, AGU pipes, and divider.\n+(define_automaton \"lujiazui_decoder,lujiazui_core,lujiazui_agu,lujiazui_div\")\n \n ;; The rules for the decoder are simple:\n ;;  - an instruction with 1 uop can be decoded by any of the three\n@@ -55,6 +55,8 @@\n (define_cpu_unit \"lua_p0,lua_p1,lua_p2,lua_p3\" \"lujiazui_core\")\n (define_cpu_unit \"lua_p4,lua_p5\" \"lujiazui_agu\")\n \n+(define_cpu_unit \"lua_div\" \"lujiazui_div\")\n+\n (define_reservation \"lua_p03\" \"lua_p0|lua_p3\")\n (define_reservation \"lua_p12\" \"lua_p1|lua_p2\")\n (define_reservation \"lua_p1p2\" \"lua_p1+lua_p2\")\n@@ -229,56 +231,56 @@\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"QI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p0p1p2p3*21\")\n+\t\t\t \"lua_decoder0,lua_p0p1p2p3,lua_div*21\")\n \n (define_insn_reservation \"lua_idiv_qi_load\" 25\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"QI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3*21\")\n+\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3,lua_div*21\")\n \n (define_insn_reservation \"lua_idiv_hi\" 22\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"HI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p0p1p2p3*22\")\n+\t\t\t \"lua_decoder0,lua_p0p1p2p3,lua_div*22\")\n \n (define_insn_reservation \"lua_idiv_hi_load\" 26\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"HI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3*22\")\n+\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3,lua_div*22\")\n \n (define_insn_reservation \"lua_idiv_si\" 20\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p0p1p2p3*20\")\n+\t\t\t \"lua_decoder0,lua_p0p1p2p3,lua_div*20\")\n \n (define_insn_reservation \"lua_idiv_si_load\" 24\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3*20\")\n+\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3,lua_div*20\")\n \n (define_insn_reservation \"lua_idiv_di\" 150\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p0p1p2p3*150\")\n+\t\t\t \"lua_decoder0,lua_p0p1p2p3,lua_div*150\")\n \n (define_insn_reservation \"lua_idiv_di_load\" 154\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DI\")\n \t\t\t\t\t(eq_attr \"type\" \"idiv\"))))\n-\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3*150\")\n+\t\t\t \"lua_decoder0,lua_p45,lua_p0p1p2p3,lua_div*150\")\n \n ;; x87 floating point operations.\n \n@@ -406,42 +408,42 @@\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SF\")\n \t\t\t\t    (eq_attr \"type\" \"fdiv,fpspc\"))))\n-\t\t\t \"lua_decodern,lua_p0*15\")\n+\t\t\t \"lua_decodern,lua_p0,lua_div*15\")\n \n (define_insn_reservation \"lua_fdiv_SF_load\" 19\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SF\")\n \t\t\t\t    (eq_attr \"type\" \"fdiv,fpspc\"))))\n-\t\t\t \"lua_decoder01,lua_p45,lua_p0*15\")\n+\t\t\t \"lua_decoder01,lua_p45,lua_p0,lua_div*15\")\n \n (define_insn_reservation \"lua_fdiv_DF\" 18\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DF\")\n \t\t\t\t    (eq_attr \"type\" \"fdiv,fpspc\"))))\n-\t\t\t \"lua_decodern,lua_p0*18\")\n+\t\t\t \"lua_decodern,lua_p0,lua_div*18\")\n \n (define_insn_reservation \"lua_fdiv_DF_load\" 22\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DF\")\n \t\t\t\t    (eq_attr \"type\" \"fdiv,fpspc\"))))\n-\t\t\t \"lua_decoder01,lua_p45,lua_p0*18\")\n+\t\t\t \"lua_decoder01,lua_p45,lua_p0,lua_div*18\")\n \n (define_insn_reservation \"lua_fdiv_XF\" 22\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"XF\")\n \t\t\t\t    (eq_attr \"type\" \"fdiv,fpspc\"))))\n-\t\t\t \"lua_decoder0,lua_p0*22\")\n+\t\t\t \"lua_decoder0,lua_p0,lua_div*22\")\n \n (define_insn_reservation \"lua_fdiv_XF_load\" 26\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"XF\")\n \t\t\t\t    (eq_attr \"type\" \"fdiv,fpspc\"))))\n-\t\t\t \"lua_decoder0,lua_p45,lua_p0*22\")\n+\t\t\t \"lua_decoder0,lua_p45,lua_p0,lua_div*22\")\n \n ;; MMX instructions.\n \n@@ -593,84 +595,84 @@\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decodern,lua_p0*13\")\n+\t\t\t \"lua_decodern,lua_p0,lua_div*13\")\n \n (define_insn_reservation \"lua_ssediv_load_SF\" 17\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"SF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder01,lua_p45,lua_p0*13\")\n+\t\t\t \"lua_decoder01,lua_p45,lua_p0,lua_div*13\")\n \n (define_insn_reservation \"lua_ssediv_V4SF\" 23\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V4SF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decodern,lua_p0*23\")\n+\t\t\t \"lua_decodern,lua_p0,lua_div*23\")\n \n (define_insn_reservation \"lua_ssediv_load_V4SF\" 27\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V4SF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder01,lua_p45,lua_p0*23\")\n+\t\t\t \"lua_decoder01,lua_p45,lua_p0,lua_div*23\")\n \n (define_insn_reservation \"lua_ssediv_V8SF\" 47\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V8SF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder0,lua_p0*47\")\n+\t\t\t \"lua_decoder0,lua_p0,lua_div*47\")\n \n (define_insn_reservation \"lua_ssediv_load_V8SF\" 51\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V8SF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder0,lua_p45,lua_p0*47\")\n+\t\t\t \"lua_decoder0,lua_p45,lua_p0,lua_div*47\")\n \n (define_insn_reservation \"lua_ssediv_SD\" 17\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decodern,lua_p0*17\")\n+\t\t\t \"lua_decodern,lua_p0,lua_div*17\")\n \n (define_insn_reservation \"lua_ssediv_load_SD\" 21\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"DF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder01,lua_p45,lua_p0*17\")\n+\t\t\t \"lua_decoder01,lua_p45,lua_p0,lua_div*17\")\n \n (define_insn_reservation \"lua_ssediv_V2DF\" 30\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V2DF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decodern,lua_p0*30\")\n+\t\t\t \"lua_decodern,lua_p0,lua_div*30\")\n \n (define_insn_reservation \"lua_ssediv_load_V2DF\" 34\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V2DF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder01,lua_p45,lua_p0*30\")\n+\t\t\t \"lua_decoder01,lua_p45,lua_p0,lua_div*30\")\n \n (define_insn_reservation \"lua_ssediv_V4DF\" 56\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"none\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V4DF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder0,lua_p0*56\")\n+\t\t\t \"lua_decoder0,lua_p0,lua_div*56\")\n \n (define_insn_reservation \"lua_ssediv_load_V4DF\" 60\n \t\t\t (and (eq_attr \"cpu\" \"lujiazui\")\n \t\t\t      (and (eq_attr \"memory\" \"load\")\n \t\t\t\t   (and (eq_attr \"mode\" \"V4DF\")\n \t\t\t\t\t(eq_attr \"type\" \"ssediv\"))))\n-\t\t\t \"lua_decoder0,lua_p4p5,lua_p0*56\")\n+\t\t\t \"lua_decoder0,lua_p4p5,lua_p0,lua_div*56\")\n \n \n (define_insn_reservation \"lua_sseicvt_si\" 2"}]}