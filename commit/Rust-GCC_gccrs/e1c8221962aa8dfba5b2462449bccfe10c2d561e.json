{"sha": "e1c8221962aa8dfba5b2462449bccfe10c2d561e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTFjODIyMTk2MmFhOGRmYmE1YjI0NjI0NDliY2NmZTEwYzJkNTYxZQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2007-07-12T12:16:54Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2007-07-12T12:16:54Z"}, "message": "re PR fortran/32550 (openmp: COPYPRIVATE of pointer variables fails)\n\n\tPR fortran/32550\n\t* trans.h (GFC_POINTER_TYPE_P): Define.\n\t* trans-types.c (gfc_sym_type): Set it for types on attr->sym.pointer.\n\t* trans-openmp.c (gfc_omp_privatize_by_reference): Return false\n\tif GFC_POINTER_TYPE_P is set on the type.\n\n\t* testsuite/libgomp.fortran/pr32550.f90: New test.\n\t* testsuite/libgomp.fortran/crayptr2.f90: New test.\n\nFrom-SVN: r126583", "tree": {"sha": "393a1c7458b43284abbfb7883e8b69cce2548c5f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/393a1c7458b43284abbfb7883e8b69cce2548c5f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e1c8221962aa8dfba5b2462449bccfe10c2d561e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e1c8221962aa8dfba5b2462449bccfe10c2d561e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e1c8221962aa8dfba5b2462449bccfe10c2d561e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e1c8221962aa8dfba5b2462449bccfe10c2d561e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "99c1f1ceed0d85eb785cb6f49ef23cad965922d2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/99c1f1ceed0d85eb785cb6f49ef23cad965922d2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/99c1f1ceed0d85eb785cb6f49ef23cad965922d2"}], "stats": {"total": 77, "additions": 74, "deletions": 3}, "files": [{"sha": "ef75186ae03051f126f2cc3c185e6defd74a4c3f", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -1,3 +1,11 @@\n+2007-07-12  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/32550\n+\t* trans.h (GFC_POINTER_TYPE_P): Define.\n+\t* trans-types.c (gfc_sym_type): Set it for types on attr->sym.pointer.\n+\t* trans-openmp.c (gfc_omp_privatize_by_reference): Return false\n+\tif GFC_POINTER_TYPE_P is set on the type.\n+\n 2007-07-12  Richard Guenther  <rguenther@suse.de>\n \n \t* trans-intrinsic.c (gfc_conv_intrinsic_repeat): Convert"}, {"sha": "b0683308f755dc12094b3345b4d92cf5b77046c5", "filename": "gcc/fortran/trans-openmp.c", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2Ftrans-openmp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2Ftrans-openmp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-openmp.c?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -50,9 +50,12 @@ gfc_omp_privatize_by_reference (tree decl)\n \n   if (TREE_CODE (type) == POINTER_TYPE)\n     {\n-      /* POINTER/ALLOCATABLE have aggregate types, all user variables\n-\t that have POINTER_TYPE type are supposed to be privatized\n-\t by reference.  */\n+      /* Array POINTER/ALLOCATABLE have aggregate types, all user variables\n+\t that have POINTER_TYPE type and don't have GFC_POINTER_TYPE_P\n+\t set are supposed to be privatized by reference.  */\n+      if (GFC_POINTER_TYPE_P (type))\n+\treturn false;\n+\n       if (!DECL_ARTIFICIAL (decl))\n \treturn true;\n "}, {"sha": "5af85f194c7b73bec3afdc378ed94b420f88e9b0", "filename": "gcc/fortran/trans-types.c", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2Ftrans-types.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2Ftrans-types.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-types.c?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -1538,6 +1538,8 @@ gfc_sym_type (gfc_symbol * sym)\n     {\n       if (sym->attr.allocatable || sym->attr.pointer)\n \ttype = gfc_build_pointer_type (sym, type);\n+      if (sym->attr.pointer)\n+\tGFC_POINTER_TYPE_P (type) = 1;\n     }\n \n   /* We currently pass all parameters by reference."}, {"sha": "02fe413be03681d02224ef52cc5f4527d6e094a4", "filename": "gcc/fortran/trans.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2Ftrans.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/gcc%2Ffortran%2Ftrans.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans.h?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -600,6 +600,8 @@ struct lang_decl\t\tGTY(())\n #define GFC_DESCRIPTOR_TYPE_P(node) TYPE_LANG_FLAG_1(node)\n /* An array without a descriptor.  */\n #define GFC_ARRAY_TYPE_P(node) TYPE_LANG_FLAG_2(node)\n+/* Fortran POINTER type.  */\n+#define GFC_POINTER_TYPE_P(node) TYPE_LANG_FLAG_3(node)\n /* The GFC_TYPE_ARRAY_* members are present in both descriptor and\n    descriptorless array types.  */\n #define GFC_TYPE_ARRAY_LBOUND(node, dim) \\"}, {"sha": "20be557df947e7d834ddc583bb372af7133475f3", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -1,3 +1,9 @@\n+2007-07-12  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR fortran/32550\n+\t* testsuite/libgomp.fortran/pr32550.f90: New test.\n+\t* testsuite/libgomp.fortran/crayptr2.f90: New test.\n+\n 2007-07-05  H.J. Lu  <hongjiu.lu@intel.com>\n \n \t* aclocal.m4: Regenerated."}, {"sha": "f8fce6b476053b94b042c7221e34b776322c5d53", "filename": "libgomp/testsuite/libgomp.fortran/crayptr2.f90", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fcrayptr2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fcrayptr2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fcrayptr2.f90?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -0,0 +1,30 @@\n+! { dg-do run }\n+! { dg-options \"-fopenmp -fcray-pointer\" }\n+\n+  use omp_lib\n+  integer :: a, b, c, d, p\n+  logical :: l\n+  pointer (ip, p)\n+  save ip\n+!$omp threadprivate (ip)\n+  a = 1\n+  b = 2\n+  c = 3\n+  l = .false.\n+!$omp parallel num_threads (3) reduction (.or.:l)\n+  if (omp_get_thread_num () .eq. 0) then\n+    ip = loc (a)\n+  elseif (omp_get_thread_num () .eq. 1) then\n+    ip = loc (b)\n+  else\n+    ip = loc (c)\n+  end if\n+  l = p .ne. omp_get_thread_num () + 1\n+!$omp single\n+  d = omp_get_thread_num ()\n+!$omp end single copyprivate (d, ip)\n+  l = l .or. (p .ne. d + 1)\n+!$omp end parallel\n+\n+  if (l) call abort\n+end"}, {"sha": "907a768e6d56e7f549ca42327232efa55a4db037", "filename": "libgomp/testsuite/libgomp.fortran/pr32550.f90", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e1c8221962aa8dfba5b2462449bccfe10c2d561e/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr32550.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e1c8221962aa8dfba5b2462449bccfe10c2d561e/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr32550.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.fortran%2Fpr32550.f90?ref=e1c8221962aa8dfba5b2462449bccfe10c2d561e", "patch": "@@ -0,0 +1,20 @@\n+! PR fortran/32550\n+! { dg-do run }\n+\n+      integer, pointer, save :: ptr\n+      integer, target :: targ\n+      integer :: e\n+!$omp threadprivate(ptr)\n+      e = 0\n+      targ = 42\n+!$omp parallel shared(targ)\n+!$omp single\n+      ptr => targ\n+!$omp end single copyprivate(ptr)\n+      if (ptr.ne.42) then\n+!$omp atomic\n+\te = e + 1\n+      end if\n+!$omp end parallel\n+      if (e.ne.0) call abort\n+      end"}]}