{"sha": "b9d8ad7175359f7a6dfd803fcc3b3f619301e734", "node_id": "C_kwDOANBUbNoAKGI5ZDhhZDcxNzUzNTlmN2E2ZGZkODAzZmNjM2IzZjYxOTMwMWU3MzQ", "commit": {"author": {"name": "Javier Miranda", "email": "miranda@adacore.com", "date": "2022-10-15T16:29:38Z"}, "committer": {"name": "Marc Poulhi\u00e8s", "email": "poulhies@adacore.com", "date": "2022-11-08T08:34:57Z"}, "message": "ada: Missing master of task causing assertion failure\n\ngcc/ada/\n\n\t* exp_ch9.adb\n\t(Build_Master_Entity): Handle missing case: when the context of\n\tthe master is a BIP function whose result type has tasks.", "tree": {"sha": "e6786afc2351eb1994c6e569d32305fffed1067a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e6786afc2351eb1994c6e569d32305fffed1067a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b9d8ad7175359f7a6dfd803fcc3b3f619301e734", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b9d8ad7175359f7a6dfd803fcc3b3f619301e734", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b9d8ad7175359f7a6dfd803fcc3b3f619301e734", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b9d8ad7175359f7a6dfd803fcc3b3f619301e734/comments", "author": {"login": "miranda-adacore", "id": 54413934, "node_id": "MDQ6VXNlcjU0NDEzOTM0", "avatar_url": "https://avatars.githubusercontent.com/u/54413934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miranda-adacore", "html_url": "https://github.com/miranda-adacore", "followers_url": "https://api.github.com/users/miranda-adacore/followers", "following_url": "https://api.github.com/users/miranda-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/miranda-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/miranda-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miranda-adacore/subscriptions", "organizations_url": "https://api.github.com/users/miranda-adacore/orgs", "repos_url": "https://api.github.com/users/miranda-adacore/repos", "events_url": "https://api.github.com/users/miranda-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/miranda-adacore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dkm", "id": 87603, "node_id": "MDQ6VXNlcjg3NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/87603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dkm", "html_url": "https://github.com/dkm", "followers_url": "https://api.github.com/users/dkm/followers", "following_url": "https://api.github.com/users/dkm/following{/other_user}", "gists_url": "https://api.github.com/users/dkm/gists{/gist_id}", "starred_url": "https://api.github.com/users/dkm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dkm/subscriptions", "organizations_url": "https://api.github.com/users/dkm/orgs", "repos_url": "https://api.github.com/users/dkm/repos", "events_url": "https://api.github.com/users/dkm/events{/privacy}", "received_events_url": "https://api.github.com/users/dkm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "59dd07ef2534c00f0144431bf54d8219ebb91218", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/59dd07ef2534c00f0144431bf54d8219ebb91218", "html_url": "https://github.com/Rust-GCC/gccrs/commit/59dd07ef2534c00f0144431bf54d8219ebb91218"}], "stats": {"total": 37, "additions": 36, "deletions": 1}, "files": [{"sha": "70ede15901ed379f4ca3676d7c48c94a04fa4509", "filename": "gcc/ada/exp_ch9.adb", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b9d8ad7175359f7a6dfd803fcc3b3f619301e734/gcc%2Fada%2Fexp_ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b9d8ad7175359f7a6dfd803fcc3b3f619301e734/gcc%2Fada%2Fexp_ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch9.adb?ref=b9d8ad7175359f7a6dfd803fcc3b3f619301e734", "patch": "@@ -3207,10 +3207,45 @@ package body Exp_Ch9 is\n          Find_Enclosing_Context (Par, Context, Context_Id, Decls);\n       end if;\n \n+      --  When the enclosing context is a BIP function whose result type has\n+      --  tasks, the function has an extra formal that is the master of the\n+      --  tasks to be created by its returned object (that is, when its\n+      --  enclosing context is a return statement). However, if the body of\n+      --  the function creates tasks before its return statements, such tasks\n+      --  need their own master.\n+\n+      if Has_Master_Entity (Context_Id)\n+        and then Ekind (Context_Id) = E_Function\n+        and then Is_Build_In_Place_Function (Context_Id)\n+        and then Needs_BIP_Task_Actuals (Context_Id)\n+      then\n+         --  No need to add it again if previously added\n+\n+         declare\n+            Master_Present : Boolean;\n+\n+         begin\n+            --  Handle transient scopes\n+\n+            if Context_Id /= Current_Scope then\n+               Push_Scope (Context_Id);\n+               Master_Present :=\n+                 Present (Current_Entity_In_Scope (Name_uMaster));\n+               Pop_Scope;\n+            else\n+               Master_Present :=\n+                 Present (Current_Entity_In_Scope (Name_uMaster));\n+            end if;\n+\n+            if Master_Present then\n+               return;\n+            end if;\n+         end;\n+\n       --  Nothing to do if the context already has a master; internally built\n       --  finalizers don't need a master.\n \n-      if Has_Master_Entity (Context_Id)\n+      elsif Has_Master_Entity (Context_Id)\n         or else Is_Finalizer (Context_Id)\n       then\n          return;"}]}