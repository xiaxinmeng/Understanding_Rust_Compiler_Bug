{"sha": "fc748d47e95dd612f4a0ef408851df0293173fd8", "node_id": "C_kwDOANBUbNoAKGZjNzQ4ZDQ3ZTk1ZGQ2MTJmNGEwZWY0MDg4NTFkZjAyOTMxNzNmZDg", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2022-10-13T13:39:08Z"}, "committer": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2022-10-13T15:47:15Z"}, "message": "use proper DECL_INITIAL for VTV\n\ngcc/cp/ChangeLog:\n\n\t* vtable-class-hierarchy.cc (vtv_generate_init_routine): Emit\n\tan artificial variable that would be put into .preinit_array\n\tsection.\n\ngcc/ChangeLog:\n\n\t* output.h (assemble_vtv_preinit_initializer): Remove.\n\t* varasm.cc (assemble_vtv_preinit_initializer): Remove.", "tree": {"sha": "d26131c1c96777b09c9c0e7e53dea8c103e56c95", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d26131c1c96777b09c9c0e7e53dea8c103e56c95"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/fc748d47e95dd612f4a0ef408851df0293173fd8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fc748d47e95dd612f4a0ef408851df0293173fd8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/fc748d47e95dd612f4a0ef408851df0293173fd8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/fc748d47e95dd612f4a0ef408851df0293173fd8/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6cc3394507a2303a18891d34222c53f679256c37", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6cc3394507a2303a18891d34222c53f679256c37", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6cc3394507a2303a18891d34222c53f679256c37"}], "stats": {"total": 35, "additions": 12, "deletions": 23}, "files": [{"sha": "cc1df1ebdb23f00f6caacf55b03fb36ebd830c33", "filename": "gcc/cp/vtable-class-hierarchy.cc", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fc748d47e95dd612f4a0ef408851df0293173fd8/gcc%2Fcp%2Fvtable-class-hierarchy.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fc748d47e95dd612f4a0ef408851df0293173fd8/gcc%2Fcp%2Fvtable-class-hierarchy.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fvtable-class-hierarchy.cc?ref=fc748d47e95dd612f4a0ef408851df0293173fd8", "patch": "@@ -1192,8 +1192,18 @@ vtv_generate_init_routine (void)\n       cgraph_node::add_new_function (vtv_fndecl, false);\n \n       if (flag_vtable_verify == VTV_PREINIT_PRIORITY && !TARGET_PECOFF)\n-        assemble_vtv_preinit_initializer (vtv_fndecl);\n-\n+\t{\n+\t  tree vtv_var\n+\t    = build_decl (BUILTINS_LOCATION, VAR_DECL,\n+\t\t\t  get_identifier (\"__vtv_preinit\"),\n+\t\t\t  build_pointer_type (TREE_TYPE (vtv_fndecl)));\n+\t  TREE_STATIC (vtv_var) = 1;\n+\t  DECL_ARTIFICIAL (vtv_var) = 1;\n+\t  DECL_INITIAL (vtv_var) = build_fold_addr_expr (vtv_fndecl);\n+\t  set_decl_section_name (vtv_var, \".preinit_array\");\n+\n+\t  varpool_node::add (vtv_var);\n+\t}\n     }\n   pop_lang_context ();\n }"}, {"sha": "6936bdeeb6ca8e2bfc071edb8686fa27bd7a9876", "filename": "gcc/output.h", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fc748d47e95dd612f4a0ef408851df0293173fd8/gcc%2Foutput.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fc748d47e95dd612f4a0ef408851df0293173fd8/gcc%2Foutput.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Foutput.h?ref=fc748d47e95dd612f4a0ef408851df0293173fd8", "patch": "@@ -199,10 +199,6 @@ extern void assemble_end_function (tree, const char *);\n    initial value (that will be done by the caller).  */\n extern void assemble_variable (tree, int, int, int);\n \n-/* Put the vtable verification constructor initialization function\n-   into the preinit array.  */\n-extern void assemble_vtv_preinit_initializer (tree);\n-\n /* Assemble everything that is needed for a variable declaration that has\n    no definition in the current translation unit.  */\n extern void assemble_undefined_decl (tree);"}, {"sha": "a11184584a21b44174e66c97a126c64f9e130294", "filename": "gcc/varasm.cc", "status": "modified", "additions": 0, "deletions": 17, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/fc748d47e95dd612f4a0ef408851df0293173fd8/gcc%2Fvarasm.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/fc748d47e95dd612f4a0ef408851df0293173fd8/gcc%2Fvarasm.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fvarasm.cc?ref=fc748d47e95dd612f4a0ef408851df0293173fd8", "patch": "@@ -2419,23 +2419,6 @@ assemble_variable (tree decl, int top_level ATTRIBUTE_UNUSED,\n     }\n }\n \n-\n-/* Given a function declaration (FN_DECL), this function assembles the\n-   function into the .preinit_array section.  */\n-\n-void\n-assemble_vtv_preinit_initializer (tree fn_decl)\n-{\n-  section *sect;\n-  unsigned flags = SECTION_WRITE;\n-  rtx symbol = XEXP (DECL_RTL (fn_decl), 0);\n-\n-  flags |= SECTION_NOTYPE;\n-  sect = get_section (\".preinit_array\", flags, fn_decl);\n-  switch_to_section (sect);\n-  assemble_addr_to_section (symbol, sect);\n-}\n-\n /* Return 1 if type TYPE contains any pointers.  */\n \n static int"}]}