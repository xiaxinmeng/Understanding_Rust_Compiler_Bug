{"sha": "22977337faf0c1a80af36b00249aed30fa586f2d", "node_id": "C_kwDOANBUbNoAKDIyOTc3MzM3ZmFmMGMxYTgwYWYzNmIwMDI0OWFlZDMwZmE1ODZmMmQ", "commit": {"author": {"name": "Jakub Dupak", "email": "dev@jakubdupak.com", "date": "2022-11-04T22:48:12Z"}, "committer": {"name": "Jakub Dupak", "email": "dev@jakubdupak.com", "date": "2022-11-15T10:52:05Z"}, "message": "ast: Dump where clause and recursively needed nodes\n\nThis is currently needed for lifetimes to use the existing infrastructure.\n\nSigned-off-by: Jakub Dupak <dev@jakubdupak.com>", "tree": {"sha": "292bb3744e1908b39e0bfbfdb1e54aab3e2d2760", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/292bb3744e1908b39e0bfbfdb1e54aab3e2d2760"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/22977337faf0c1a80af36b00249aed30fa586f2d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/22977337faf0c1a80af36b00249aed30fa586f2d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/22977337faf0c1a80af36b00249aed30fa586f2d", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/22977337faf0c1a80af36b00249aed30fa586f2d/comments", "author": {"login": "jdupak", "id": 22683640, "node_id": "MDQ6VXNlcjIyNjgzNjQw", "avatar_url": "https://avatars.githubusercontent.com/u/22683640?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jdupak", "html_url": "https://github.com/jdupak", "followers_url": "https://api.github.com/users/jdupak/followers", "following_url": "https://api.github.com/users/jdupak/following{/other_user}", "gists_url": "https://api.github.com/users/jdupak/gists{/gist_id}", "starred_url": "https://api.github.com/users/jdupak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jdupak/subscriptions", "organizations_url": "https://api.github.com/users/jdupak/orgs", "repos_url": "https://api.github.com/users/jdupak/repos", "events_url": "https://api.github.com/users/jdupak/events{/privacy}", "received_events_url": "https://api.github.com/users/jdupak/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jdupak", "id": 22683640, "node_id": "MDQ6VXNlcjIyNjgzNjQw", "avatar_url": "https://avatars.githubusercontent.com/u/22683640?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jdupak", "html_url": "https://github.com/jdupak", "followers_url": "https://api.github.com/users/jdupak/followers", "following_url": "https://api.github.com/users/jdupak/following{/other_user}", "gists_url": "https://api.github.com/users/jdupak/gists{/gist_id}", "starred_url": "https://api.github.com/users/jdupak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jdupak/subscriptions", "organizations_url": "https://api.github.com/users/jdupak/orgs", "repos_url": "https://api.github.com/users/jdupak/repos", "events_url": "https://api.github.com/users/jdupak/events{/privacy}", "received_events_url": "https://api.github.com/users/jdupak/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7264aac826e5bec3861331af736cadeef123b277", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7264aac826e5bec3861331af736cadeef123b277", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7264aac826e5bec3861331af736cadeef123b277"}], "stats": {"total": 148, "additions": 131, "deletions": 17}, "files": [{"sha": "e5e051a46d883c692f30721389946a850b496bf8", "filename": "gcc/rust/ast/rust-ast-dump.cc", "status": "modified", "additions": 123, "deletions": 17, "changes": 140, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-ast-dump.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-ast-dump.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-ast-dump.cc?ref=22977337faf0c1a80af36b00249aed30fa586f2d", "patch": "@@ -227,6 +227,28 @@ Dump::visit (StructField &field)\n   visit (field.get_field_type ());\n }\n \n+// TODO is this unique by type?\n+void\n+Dump::visit (std::vector<LifetimeParam> &for_lifetimes)\n+{\n+  // ForLifetimes :\n+  //     for GenericParams\n+  //\n+  // GenericParams :\n+  //      < >\n+  //   | < (GenericParam ,)* GenericParam ,? >\n+  //\n+  // GenericParam :\n+  //   OuterAttribute* ( LifetimeParam | TypeParam | ConstParam )\n+  //\n+  // LifetimeParam :\n+  //   LIFETIME_OR_LABEL ( : LifetimeBounds )?\n+\n+  stream << \"for <\";\n+  visit_items_joined_by_separator (for_lifetimes, \" + \");\n+  stream << \"> \";\n+}\n+\n void\n Dump::visit (Token &tok)\n {\n@@ -258,11 +280,35 @@ Dump::visit (IdentifierExpr &ident_expr)\n \n void\n Dump::visit (Lifetime &lifetime)\n-{}\n+{\n+  // Syntax:\n+  // Lifetime :\n+  // \tLIFETIME_OR_LABEL\n+  // \t| 'static\n+  // \t| '_\n+  stream << lifetime.as_string ();\n+}\n \n void\n Dump::visit (LifetimeParam &lifetime_param)\n-{}\n+{\n+  // Syntax:\n+  //   LIFETIME_OR_LABEL ( : LifetimeBounds )?\n+  // LifetimeBounds :\n+  //   ( Lifetime + )* Lifetime?\n+\n+  // TODO what to do with outer attr? They are not mentioned in the reference.\n+\n+  auto lifetime = lifetime_param.get_lifetime ();\n+  visit (lifetime);\n+\n+  if (lifetime_param.has_lifetime_bounds ())\n+    {\n+      stream << \": \";\n+      visit_items_joined_by_separator (lifetime_param.get_lifetime_bounds (),\n+\t\t\t\t       \" + \");\n+    }\n+}\n \n void\n Dump::visit (ConstGenericParam &lifetime_param)\n@@ -804,13 +850,52 @@ Dump::visit (TypeParam &param)\n     }\n }\n \n+void\n+Dump::visit (WhereClause &rule)\n+{\n+  // Syntax:\n+  // \twhere ( WhereClauseItem , )* WhereClauseItem ?\n+  // WhereClauseItem :\n+  // \tLifetimeWhereClauseItem\n+  //  \t| TypeBoundWhereClauseItem\n+\n+  stream << \" where\\n\";\n+  indentation.increment ();\n+  visit_items_as_lines (rule.get_items (), \",\");\n+  indentation.decrement ();\n+}\n+\n void\n Dump::visit (LifetimeWhereClauseItem &item)\n-{}\n+{\n+  // Syntax:\n+  // \tLifetime : LifetimeBounds\n+  // LifetimeBounds :\n+  //   ( Lifetime + )* Lifetime?\n+\n+  visit (item.get_lifetime ());\n+  stream << \": \";\n+  visit_items_joined_by_separator (item.get_lifetime_bounds (), \" + \");\n+}\n \n void\n Dump::visit (TypeBoundWhereClauseItem &item)\n-{}\n+{\n+  // Syntax:\n+  // \tForLifetimes? Type : TypeParamBounds?\n+  // TypeParamBounds :\n+  // \tTypeParamBound ( + TypeParamBound )* +?\n+  // TypeParamBound :\n+  //    Lifetime | TraitBound\n+\n+  if (item.has_for_lifetimes ())\n+    visit (item.get_for_lifetimes ());\n+\n+  visit (item.get_type ());\n+  stream << \": \";\n+\n+  visit_items_joined_by_separator (item.get_type_param_bounds (), \" + \");\n+}\n \n void\n Dump::visit (Method &method)\n@@ -896,6 +981,12 @@ Dump::visit (UseDeclaration &use_decl)\n void\n Dump::visit (Function &function)\n {\n+  // Syntax:\n+  //   FunctionQualifiers fn IDENTIFIER GenericParams?\n+  //      ( FunctionParameters? )\n+  //      FunctionReturnType? WhereClause?\n+  //      ( BlockExpression | ; )\n+\n   visit (function.get_visibility ());\n \n   stream << \"fn \" << function.get_function_name ();\n@@ -913,6 +1004,9 @@ Dump::visit (Function &function)\n       stream << \" \";\n     }\n \n+  if (function.has_where_clause ())\n+    visit (function.get_where_clause ());\n+\n   auto &block = function.get_definition ();\n   if (!block)\n     stream << ';';\n@@ -936,8 +1030,7 @@ Dump::visit (TypeAlias &type_alias)\n   if (type_alias.has_generics ())\n     visit (type_alias.get_generic_params ());\n   if (type_alias.has_where_clause ())\n-    {\n-    } // FIXME: WhereClause\n+    visit (type_alias.get_where_clause ());\n   stream << \" = \";\n   visit (type_alias.get_type_aliased ());\n   stream << \";\\n\";\n@@ -949,9 +1042,8 @@ Dump::visit (StructStruct &struct_item)\n   stream << \"struct \" << struct_item.get_identifier ();\n   if (struct_item.has_generics ())\n     visit (struct_item.get_generic_params ());\n-\n-  // FIXME: where-clause\n-\n+  if (struct_item.has_where_clause ())\n+    visit (struct_item.get_where_clause ());\n   if (struct_item.is_unit_struct ())\n     stream << \";\\n\";\n   else\n@@ -964,8 +1056,8 @@ Dump::visit (TupleStruct &tuple_struct)\n   stream << \"struct \" << tuple_struct.get_identifier ();\n   if (tuple_struct.has_generics ())\n     visit (tuple_struct.get_generic_params ());\n-\n-  // FIXME: where-clause\n+  if (tuple_struct.has_where_clause ())\n+    visit (tuple_struct.get_where_clause ());\n \n   stream << '(';\n   visit_items_joined_by_separator (tuple_struct.get_fields (), \", \");\n@@ -1006,8 +1098,8 @@ Dump::visit (Enum &enum_item)\n   stream << \"enum \" << enum_item.get_identifier ();\n   if (enum_item.has_generics ())\n     visit (enum_item.get_generic_params ());\n-\n-  // FIXME: where-clause\n+  if (enum_item.has_where_clause ())\n+    visit (enum_item.get_where_clause ());\n \n   visit_items_as_block (enum_item.get_variants (), \",\");\n }\n@@ -1018,8 +1110,8 @@ Dump::visit (Union &union_item)\n   stream << \"union \" << union_item.get_identifier ();\n   if (union_item.has_generics ())\n     visit (union_item.get_generic_params ());\n-\n-  // FIXME: where-clause\n+  if (union_item.has_where_clause ())\n+    visit (union_item.get_where_clause ());\n \n   visit_items_as_block (union_item.get_variants (), \",\");\n }\n@@ -1137,7 +1229,9 @@ Dump::visit (InherentImpl &impl)\n \n   visit (impl.get_type ());\n \n-  // FIXME: Handle where-clause\n+  if (impl.has_where_clause ())\n+    visit (impl.get_where_clause ());\n+\n   // FIXME: Handle inner attributes\n \n   visit_items_as_block (impl.get_impl_items (), \"\");\n@@ -1451,7 +1545,19 @@ Dump::visit (ExprStmtWithBlock &stmt)\n // rust-type.h\n void\n Dump::visit (TraitBound &bound)\n-{}\n+{\n+  // Syntax:\n+  //      ?? ForLifetimes? TypePath\n+  //   | ( ?? ForLifetimes? TypePath )\n+\n+  if (bound.has_opening_question_mark ())\n+    stream << \"? \";\n+\n+  if (bound.has_for_lifetimes ())\n+    visit (bound.get_for_lifetimes ());\n+\n+  visit (bound.get_type_path ());\n+}\n \n void\n Dump::visit (ImplTraitType &type)"}, {"sha": "2bd3b31d09aff973994df030b8628f2f1b6e9b43", "filename": "gcc/rust/ast/rust-ast-dump.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-ast-dump.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-ast-dump.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-ast-dump.h?ref=22977337faf0c1a80af36b00249aed30fa586f2d", "patch": "@@ -135,6 +135,8 @@ class Dump : public ASTVisitor\n   void visit (SimplePathSegment &segment);\n   void visit (NamedFunctionParam &param);\n   void visit (MacroRule &rule);\n+  void visit (WhereClause &rule);\n+  void visit (std::vector<LifetimeParam> &for_lifetimes);\n \n   // rust-ast.h\n   void visit (Token &tok);"}, {"sha": "fc7af58eed5aa18b927ca48e4ff791e8475f07e5", "filename": "gcc/rust/ast/rust-ast.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-ast.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-ast.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-ast.h?ref=22977337faf0c1a80af36b00249aed30fa586f2d", "patch": "@@ -1310,6 +1310,8 @@ class LifetimeParam : public GenericParam\n   // Returns whether the lifetime param has any lifetime bounds.\n   bool has_lifetime_bounds () const { return !lifetime_bounds.empty (); }\n \n+  std::vector<Lifetime> &get_lifetime_bounds () { return lifetime_bounds; }\n+\n   // Returns whether the lifetime param has an outer attribute.\n   bool has_outer_attribute () const { return !outer_attr.is_empty (); }\n "}, {"sha": "09fad819c458dfcc304e6613e9203977402749e4", "filename": "gcc/rust/ast/rust-item.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-item.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-item.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-item.h?ref=22977337faf0c1a80af36b00249aed30fa586f2d", "patch": "@@ -236,6 +236,8 @@ class TypeBoundWhereClauseItem : public WhereClauseItem\n   // Returns whether the item has ForLifetimes\n   bool has_for_lifetimes () const { return !for_lifetimes.empty (); }\n \n+  std::vector<LifetimeParam> &get_for_lifetimes () { return for_lifetimes; }\n+\n   // Returns whether the item has type param bounds\n   bool has_type_param_bounds () const { return !type_param_bounds.empty (); }\n "}, {"sha": "8fc3d31b45b1d7bab4a1fb9bebb163b1dd40693e", "filename": "gcc/rust/ast/rust-type.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-type.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/22977337faf0c1a80af36b00249aed30fa586f2d/gcc%2Frust%2Fast%2Frust-type.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fast%2Frust-type.h?ref=22977337faf0c1a80af36b00249aed30fa586f2d", "patch": "@@ -46,6 +46,8 @@ class TraitBound : public TypeParamBound\n   // Returns whether trait bound has \"for\" lifetimes\n   bool has_for_lifetimes () const { return !for_lifetimes.empty (); }\n \n+  std::vector<LifetimeParam> &get_for_lifetimes () { return for_lifetimes; }\n+\n   TraitBound (TypePath type_path, Location locus, bool in_parens = false,\n \t      bool opening_question_mark = false,\n \t      std::vector<LifetimeParam> for_lifetimes"}]}