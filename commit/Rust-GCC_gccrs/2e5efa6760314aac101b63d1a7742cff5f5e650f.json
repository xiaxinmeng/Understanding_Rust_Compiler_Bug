{"sha": "2e5efa6760314aac101b63d1a7742cff5f5e650f", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmU1ZWZhNjc2MDMxNGFhYzEwMWI2M2QxYTc3NDJjZmY1ZjVlNjUwZg==", "commit": {"author": {"name": "Cesar Philippidis", "email": "cesar@codesourcery.com", "date": "2018-04-12T13:15:45Z"}, "committer": {"name": "Cesar Philippidis", "email": "cesar@gcc.gnu.org", "date": "2018-04-12T13:15:45Z"}, "message": "re PR middle-end/84955 (Incorrect OpenACC tile expansion)\n\nPR middle-end/84955\n\n\tgcc/\n\t* lto-streamer-out.c (output_function): Fix CFG loop state before\n\tstreaming out.\n\t* omp-expand.c (expand_oacc_for): Handle calls to internal\n\tfunctions like regular functions.\n\n\tlibgomp/\n\t* testsuite/libgomp.oacc-c-c++-common/pr84955.c: New test.\n\t* testsuite/libgomp.oacc-fortran/pr84955.f90: New test.\n\nCo-Authored-By: Richard Biener <rguenther@suse.de>\n\nFrom-SVN: r259346", "tree": {"sha": "b8576600c7c102a8375ae41777eabe324a6b4f07", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b8576600c7c102a8375ae41777eabe324a6b4f07"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2e5efa6760314aac101b63d1a7742cff5f5e650f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5efa6760314aac101b63d1a7742cff5f5e650f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2e5efa6760314aac101b63d1a7742cff5f5e650f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5efa6760314aac101b63d1a7742cff5f5e650f/comments", "author": {"login": "cesarjp", "id": 4576177, "node_id": "MDQ6VXNlcjQ1NzYxNzc=", "avatar_url": "https://avatars.githubusercontent.com/u/4576177?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cesarjp", "html_url": "https://github.com/cesarjp", "followers_url": "https://api.github.com/users/cesarjp/followers", "following_url": "https://api.github.com/users/cesarjp/following{/other_user}", "gists_url": "https://api.github.com/users/cesarjp/gists{/gist_id}", "starred_url": "https://api.github.com/users/cesarjp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cesarjp/subscriptions", "organizations_url": "https://api.github.com/users/cesarjp/orgs", "repos_url": "https://api.github.com/users/cesarjp/repos", "events_url": "https://api.github.com/users/cesarjp/events{/privacy}", "received_events_url": "https://api.github.com/users/cesarjp/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c1566f8942f107774fbe0d41cc5de641175043e7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c1566f8942f107774fbe0d41cc5de641175043e7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c1566f8942f107774fbe0d41cc5de641175043e7"}], "stats": {"total": 71, "additions": 69, "deletions": 2}, "files": [{"sha": "798469f28a4004483eb4255b8e6f727306a52791", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=2e5efa6760314aac101b63d1a7742cff5f5e650f", "patch": "@@ -1,3 +1,12 @@\n+2018-04-12  Cesar Philippidis  <cesar@codesourcery.com>\n+\t    Richard Biener  <rguenther@suse.de>\n+\n+\tPR middle-end/84955\n+\t* lto-streamer-out.c (output_function): Fix CFG loop state before\n+\tstreaming out.\n+\t* omp-expand.c (expand_oacc_for): Handle calls to internal\n+\tfunctions like regular functions.\n+\n 2018-04-12  Richard Biener  <rguenther@suse.de>\n \n \tPR lto/85371"}, {"sha": "fd6788a69b050c8357a9a8ab83319c659d590b24", "filename": "gcc/lto-streamer-out.c", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2Flto-streamer-out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2Flto-streamer-out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Flto-streamer-out.c?ref=2e5efa6760314aac101b63d1a7742cff5f5e650f", "patch": "@@ -2084,6 +2084,9 @@ output_function (struct cgraph_node *node)\n   /* Set current_function_decl and cfun.  */\n   push_cfun (fn);\n \n+  /* Fixup loops if required to match discovery done in the reader.  */\n+  loop_optimizer_init (AVOID_CFG_MODIFICATIONS);\n+\n   /* Make string 0 be a NULL string.  */\n   streamer_write_char_stream (ob->string_stream, 0);\n \n@@ -2176,12 +2179,13 @@ output_function (struct cgraph_node *node)\n       streamer_write_record_start (ob, LTO_null);\n \n       output_cfg (ob, fn);\n-\n-      pop_cfun ();\n    }\n   else\n     streamer_write_uhwi (ob, 0);\n \n+  loop_optimizer_finalize ();\n+  pop_cfun ();\n+\n   /* Create a section to hold the pickled output of this function.   */\n   produce_asm (ob, function);\n "}, {"sha": "c7d30ea39641e24bc618de6c186862aaf74c2841", "filename": "gcc/omp-expand.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2Fomp-expand.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2Fomp-expand.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-expand.c?ref=2e5efa6760314aac101b63d1a7742cff5f5e650f", "patch": "@@ -5439,6 +5439,14 @@ expand_oacc_for (struct omp_region *region, struct omp_for_data *fd)\n \n \t  split->flags ^= EDGE_FALLTHRU | EDGE_TRUE_VALUE;\n \n+\t  /* Add a dummy exit for the tiled block when cont_bb is missing.  */\n+\t  if (cont_bb == NULL)\n+\t    {\n+\t      edge e = make_edge (body_bb, exit_bb, EDGE_FALSE_VALUE);\n+\t      e->probability = profile_probability::even ();\n+\t      split->probability = profile_probability::even ();\n+\t    }\n+\n \t  /* Initialize the user's loop vars.  */\n \t  gsi = gsi_start_bb (elem_body_bb);\n \t  expand_oacc_collapse_vars (fd, true, &gsi, counts, e_offset);"}, {"sha": "9011b656a523e2e5ed4065f1caa0e5829f94e238", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5efa6760314aac101b63d1a7742cff5f5e650f/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=2e5efa6760314aac101b63d1a7742cff5f5e650f", "patch": "@@ -1,3 +1,9 @@\n+2018-04-12  Cesar Philippidis  <cesar@codesourcery.com>\n+\n+\tPR middle-end/84955\n+\t* testsuite/libgomp.oacc-c-c++-common/pr84955.c: New test.\n+\t* testsuite/libgomp.oacc-fortran/pr84955.f90: New test.\n+\n 2018-04-12  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR target/85328"}, {"sha": "5910b57b68ddddcaefb1941e0fca442826c6fc07", "filename": "libgomp/testsuite/libgomp.oacc-c-c++-common/pr84955.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5efa6760314aac101b63d1a7742cff5f5e650f/libgomp%2Ftestsuite%2Flibgomp.oacc-c-c%2B%2B-common%2Fpr84955.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5efa6760314aac101b63d1a7742cff5f5e650f/libgomp%2Ftestsuite%2Flibgomp.oacc-c-c%2B%2B-common%2Fpr84955.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.oacc-c-c%2B%2B-common%2Fpr84955.c?ref=2e5efa6760314aac101b63d1a7742cff5f5e650f", "patch": "@@ -0,0 +1,20 @@\n+/* { dg-do compile }  */\n+\n+int\n+main ()\n+{\n+  int i, j;\n+\n+#pragma acc parallel loop tile(2,3)\n+  for (i = 1; i < 10; i++)\n+    for (j = 1; j < 10; j++)\n+      for (;;)\n+\t;\n+\n+#pragma acc parallel loop\n+  for (i = 1; i < 10; i++)\n+    for (;;)\n+      ;\n+\n+  return i + j;\n+}"}, {"sha": "878d8a89f41a2d1cd8fe07027525c52ba542f466", "filename": "libgomp/testsuite/libgomp.oacc-fortran/pr84955.f90", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5efa6760314aac101b63d1a7742cff5f5e650f/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fpr84955.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5efa6760314aac101b63d1a7742cff5f5e650f/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fpr84955.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.oacc-fortran%2Fpr84955.f90?ref=2e5efa6760314aac101b63d1a7742cff5f5e650f", "patch": "@@ -0,0 +1,20 @@\n+! { dg-do compile }\n+\n+subroutine s\n+   integer :: i, j\n+   !$acc parallel loop tile(2,3)\n+   do i = 1, 10\n+      do j = 1, 10\n+         do\n+         end do\n+      end do\n+   end do\n+  !$acc end parallel loop\n+\n+  !$acc parallel loop\n+   do i = 1, 10\n+      do\n+      end do\n+   end do\n+  !$acc end parallel loop\n+end subroutine s"}]}