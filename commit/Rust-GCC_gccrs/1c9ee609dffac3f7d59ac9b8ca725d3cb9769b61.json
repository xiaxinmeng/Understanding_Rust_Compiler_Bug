{"sha": "1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWM5ZWU2MDlkZmZhYzNmN2Q1OWFjOWI4Y2E3MjVkM2NiOTc2OWI2MQ==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2018-05-11T07:42:50Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2018-05-11T07:42:50Z"}, "message": "re PR c/85696 (OpenMP with variably modified and default(none) won't compile)\n\n\tPR c/85696\n\t* c-omp.c (c_omp_predetermined_sharing): Return\n\tOMP_CLAUSE_DEFAULT_SHARED for artificial vars with integral type.\n\n\t* cp-tree.h (cxx_omp_predetermined_sharing_1): New prototype.\n\t* cp-gimplify.c (cxx_omp_predetermined_sharing): New wrapper around\n\tcxx_omp_predetermined_sharing_1.  Rename old function to ...\n\t(cxx_omp_predetermined_sharing_1): ... this.\n\t* semantics.c (finish_omp_clauses): Use cxx_omp_predetermined_sharing_1\n\tinstead of cxx_omp_predetermined_sharing.\n\n\t* c-c++-common/gomp/pr85696.c: New test.\n\nFrom-SVN: r260156", "tree": {"sha": "e7db792cd4f69d5d1a77de3bd61c59c065d8b2c7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e7db792cd4f69d5d1a77de3bd61c59c065d8b2c7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5a599c460e3846df80aaabd2b4629544337167ba", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5a599c460e3846df80aaabd2b4629544337167ba", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5a599c460e3846df80aaabd2b4629544337167ba"}], "stats": {"total": 80, "additions": 78, "deletions": 2}, "files": [{"sha": "c38d5ecac898a0bf52e5308e2e5330f4c4ff7865", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -1,3 +1,9 @@\n+2018-05-11  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/85696\n+\t* c-omp.c (c_omp_predetermined_sharing): Return\n+\tOMP_CLAUSE_DEFAULT_SHARED for artificial vars with integral type.\n+\n 2018-05-11  Martin Liska  <mliska@suse.cz>\n \n         PR sanitizer/85556"}, {"sha": "d8695f517af078201aecbc6e04db27edec5bcb3c", "filename": "gcc/c-family/c-omp.c", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fc-family%2Fc-omp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fc-family%2Fc-omp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-omp.c?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -1611,5 +1611,13 @@ c_omp_predetermined_sharing (tree decl)\n   if (TREE_READONLY (decl))\n     return OMP_CLAUSE_DEFAULT_SHARED;\n \n+  /* Predetermine artificial variables holding integral values, those\n+     are usually result of gimplify_one_sizepos or SAVE_EXPR\n+     gimplification.  */\n+  if (VAR_P (decl)\n+      && DECL_ARTIFICIAL (decl)\n+      && INTEGRAL_TYPE_P (TREE_TYPE (decl)))\n+    return OMP_CLAUSE_DEFAULT_SHARED;\n+\n   return OMP_CLAUSE_DEFAULT_UNSPECIFIED;\n }"}, {"sha": "08cd81ffcee3fe8237128cf2aa5a3aff6e4ee4d5", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -1,3 +1,13 @@\n+2018-05-11  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/85696\n+\t* cp-tree.h (cxx_omp_predetermined_sharing_1): New prototype.\n+\t* cp-gimplify.c (cxx_omp_predetermined_sharing): New wrapper around\n+\tcxx_omp_predetermined_sharing_1.  Rename old function to ...\n+\t(cxx_omp_predetermined_sharing_1): ... this.\n+\t* semantics.c (finish_omp_clauses): Use cxx_omp_predetermined_sharing_1\n+\tinstead of cxx_omp_predetermined_sharing.\n+\n 2018-05-10  Jason Merrill  <jason@redhat.com>\n \n \t* decl.c (cp_finish_decl): Don't instantiate auto variable."}, {"sha": "317ba455a59d7b2649680bca52ae5cb7e92ce5ec", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -1957,7 +1957,7 @@ cxx_omp_const_qual_no_mutable (tree decl)\n /* True if OpenMP sharing attribute of DECL is predetermined.  */\n \n enum omp_clause_default_kind\n-cxx_omp_predetermined_sharing (tree decl)\n+cxx_omp_predetermined_sharing_1 (tree decl)\n {\n   /* Static data members are predetermined shared.  */\n   if (TREE_STATIC (decl))\n@@ -1975,6 +1975,32 @@ cxx_omp_predetermined_sharing (tree decl)\n   return OMP_CLAUSE_DEFAULT_UNSPECIFIED;\n }\n \n+/* Likewise, but also include the artificial vars.  We don't want to\n+   disallow the artificial vars being mentioned in explicit clauses,\n+   as we use artificial vars e.g. for loop constructs with random\n+   access iterators other than pointers, but during gimplification\n+   we want to treat them as predetermined.  */\n+\n+enum omp_clause_default_kind\n+cxx_omp_predetermined_sharing (tree decl)\n+{\n+  enum omp_clause_default_kind ret = cxx_omp_predetermined_sharing_1 (decl);\n+  if (ret != OMP_CLAUSE_DEFAULT_UNSPECIFIED)\n+    return ret;\n+\n+  /* Predetermine artificial variables holding integral values, those\n+     are usually result of gimplify_one_sizepos or SAVE_EXPR\n+     gimplification.  */\n+  if (VAR_P (decl)\n+      && DECL_ARTIFICIAL (decl)\n+      && INTEGRAL_TYPE_P (TREE_TYPE (decl))\n+      && !(DECL_LANG_SPECIFIC (decl)\n+\t   && DECL_OMP_PRIVATIZED_MEMBER (decl)))\n+    return OMP_CLAUSE_DEFAULT_SHARED;\n+\n+  return OMP_CLAUSE_DEFAULT_UNSPECIFIED;\n+}\n+\n /* Finalize an implicitly determined clause.  */\n \n void"}, {"sha": "353bc6abde3e4a38859d287c74ac8d4d95a5b570", "filename": "gcc/cp/cp-tree.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2Fcp-tree.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2Fcp-tree.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-tree.h?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -7383,6 +7383,7 @@ extern int cp_gimplify_expr\t\t\t(tree *, gimple_seq *,\n \t\t\t\t\t\t gimple_seq *);\n extern void cp_genericize\t\t\t(tree);\n extern bool cxx_omp_const_qual_no_mutable\t(tree);\n+extern enum omp_clause_default_kind cxx_omp_predetermined_sharing_1 (tree);\n extern enum omp_clause_default_kind cxx_omp_predetermined_sharing (tree);\n extern tree cxx_omp_clause_default_ctor\t\t(tree, tree, tree);\n extern tree cxx_omp_clause_copy_ctor\t\t(tree, tree, tree);"}, {"sha": "655781710c95ca2b91045ad12ed1c7ad80427b20", "filename": "gcc/cp/semantics.c", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2Fsemantics.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Fcp%2Fsemantics.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fsemantics.c?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -7297,7 +7297,7 @@ finish_omp_clauses (tree clauses, enum c_omp_region_type ort)\n \n \t  if (VAR_P (t) && CP_DECL_THREAD_LOCAL_P (t))\n \t    share_name = \"threadprivate\";\n-\t  else switch (cxx_omp_predetermined_sharing (t))\n+\t  else switch (cxx_omp_predetermined_sharing_1 (t))\n \t    {\n \t    case OMP_CLAUSE_DEFAULT_UNSPECIFIED:\n \t      break;"}, {"sha": "ca16f5cc5a16fae10aef1daf62f82e0cf71c85ec", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -1,3 +1,8 @@\n+2018-05-11  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR c/85696\n+\t* c-c++-common/gomp/pr85696.c: New test.\n+\n 2018-05-11  Allan Sandfeld Jensen  <allan.jensen@qt.io>\n \t    Jakub Jelinek  <jakub@redhat.com>\n "}, {"sha": "798718b563d46e35ba8835ae8efa976be6aceb82", "filename": "gcc/testsuite/c-c++-common/gomp/pr85696.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr85696.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr85696.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr85696.c?ref=1c9ee609dffac3f7d59ac9b8ca725d3cb9769b61", "patch": "@@ -0,0 +1,20 @@\n+/* PR c/85696 */\n+\n+#ifndef __cplusplus\n+void\n+foo (int n, int a[][n])\n+{\n+  #pragma omp parallel shared(a) default(none)\n+  #pragma omp master\n+    a[23][0] = 42;\n+}\n+#endif\n+\n+void\n+bar (int n, void *p)\n+{\n+  int (*a)[n] = (int (*)[n]) p;\n+  #pragma omp parallel shared(a) default(none)\n+  #pragma omp master\n+    a[23][0] = 42;\n+}"}]}