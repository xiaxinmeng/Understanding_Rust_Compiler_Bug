{"sha": "65c5b1eb85f8f0f3078f614d549f107ee9a001af", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NjVjNWIxZWI4NWY4ZjBmMzA3OGY2MTRkNTQ5ZjEwN2VlOWEwMDFhZg==", "commit": {"author": {"name": "Joseph Myers", "email": "joseph@codesourcery.com", "date": "2019-01-07T22:39:43Z"}, "committer": {"name": "Joseph Myers", "email": "jsm28@gcc.gnu.org", "date": "2019-01-07T22:39:43Z"}, "message": "Fix diagnostics for never-defined inline and nested functions (PR c/88720, PR c/88726).\n\nBugs 88720 and 88726 report issues where a function is declared inline\nin an inner scope, resulting in spurious diagnostics about it being\ndeclared but never defined when that scope is left (possibly in some\ncases also wrongly referring to the function as a nested function).\nThese are regressions that were introduced with the support for C99\ninline semantics in 4.3 (they don't appear with 4.2; it's possible\nsome aspects of the bugs might have been introduced later than 4.3).\n\nFor the case of functions being wrongly referred to as nested,\nDECL_EXTERNAL was not the right condition for a function being\nnon-nested; TREE_PUBLIC is appropriate for the case of non-nested\nfunctions with external linkage, while !b->nested means this is the\noutermost scope in which the function was declared and so avoids\ncatching the case of a file-scope static being redeclared inline\ninside a function.\n\nFor the non-nested, external-linkage case, the code attempts to avoid\nduplicate diagnostics by diagnosing only when scope != external_scope,\nbut actually scope == external_scope is more appropriate, as it's only\nwhen the file and external scopes are popped that the code can\nactually tell whether a function ended up being defined, and all such\nfunctions will appear in the (GCC-internal) external scope.\n\nBootstrapped with no regressions on x86_64-pc-linux-gnu.\n\n\tPR c/88720\n\tPR c/88726\ngcc/c:\n\t* c-decl.c (pop_scope): Use TREE_PUBLIC and b->nested to determine\n\twhether a function is nested, not DECL_EXTERNAL.  Diagnose inline\n\tfunctions declared but never defined only for external scope, not\n\tfor other scopes.\n\ngcc/testsuite:\n\t* gcc.dg/inline-40.c, gcc.dg/inline-41.c: New tests.\n\nFrom-SVN: r267665", "tree": {"sha": "cbf34fb65f0b99d3b3ec4e876e9682f6e50554da", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cbf34fb65f0b99d3b3ec4e876e9682f6e50554da"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/65c5b1eb85f8f0f3078f614d549f107ee9a001af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/65c5b1eb85f8f0f3078f614d549f107ee9a001af", "html_url": "https://github.com/Rust-GCC/gccrs/commit/65c5b1eb85f8f0f3078f614d549f107ee9a001af", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/65c5b1eb85f8f0f3078f614d549f107ee9a001af/comments", "author": {"login": "jsm28", "id": 10537793, "node_id": "MDQ6VXNlcjEwNTM3Nzkz", "avatar_url": "https://avatars.githubusercontent.com/u/10537793?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsm28", "html_url": "https://github.com/jsm28", "followers_url": "https://api.github.com/users/jsm28/followers", "following_url": "https://api.github.com/users/jsm28/following{/other_user}", "gists_url": "https://api.github.com/users/jsm28/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsm28/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsm28/subscriptions", "organizations_url": "https://api.github.com/users/jsm28/orgs", "repos_url": "https://api.github.com/users/jsm28/repos", "events_url": "https://api.github.com/users/jsm28/events{/privacy}", "received_events_url": "https://api.github.com/users/jsm28/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsm28", "id": 10537793, "node_id": "MDQ6VXNlcjEwNTM3Nzkz", "avatar_url": "https://avatars.githubusercontent.com/u/10537793?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsm28", "html_url": "https://github.com/jsm28", "followers_url": "https://api.github.com/users/jsm28/followers", "following_url": "https://api.github.com/users/jsm28/following{/other_user}", "gists_url": "https://api.github.com/users/jsm28/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsm28/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsm28/subscriptions", "organizations_url": "https://api.github.com/users/jsm28/orgs", "repos_url": "https://api.github.com/users/jsm28/repos", "events_url": "https://api.github.com/users/jsm28/events{/privacy}", "received_events_url": "https://api.github.com/users/jsm28/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c3336d9b13da022973c9097edcdb5ff9ad57fac0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c3336d9b13da022973c9097edcdb5ff9ad57fac0", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c3336d9b13da022973c9097edcdb5ff9ad57fac0"}], "stats": {"total": 118, "additions": 116, "deletions": 2}, "files": [{"sha": "5ee4b66c51363bc969d06b1b3435df85322a27be", "filename": "gcc/c/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Fc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Fc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2FChangeLog?ref=65c5b1eb85f8f0f3078f614d549f107ee9a001af", "patch": "@@ -1,3 +1,12 @@\n+2019-01-07  Joseph Myers  <joseph@codesourcery.com>\n+\n+\tPR c/88720\n+\tPR c/88726\n+\t* c-decl.c (pop_scope): Use TREE_PUBLIC and b->nested to determine\n+\twhether a function is nested, not DECL_EXTERNAL.  Diagnose inline\n+\tfunctions declared but never defined only for external scope, not\n+\tfor other scopes.\n+\n 2019-01-07  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR c++/85052"}, {"sha": "5c7232f3657a6edf99de753d9e1de22ec68f3ff4", "filename": "gcc/c/c-decl.c", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Fc%2Fc-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Fc%2Fc-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc%2Fc-decl.c?ref=65c5b1eb85f8f0f3078f614d549f107ee9a001af", "patch": "@@ -1251,8 +1251,9 @@ pop_scope (void)\n \t      && DECL_ABSTRACT_ORIGIN (p) != NULL_TREE\n \t      && DECL_ABSTRACT_ORIGIN (p) != p)\n \t    TREE_ADDRESSABLE (DECL_ABSTRACT_ORIGIN (p)) = 1;\n-\t  if (!DECL_EXTERNAL (p)\n+\t  if (!TREE_PUBLIC (p)\n \t      && !DECL_INITIAL (p)\n+\t      && !b->nested\n \t      && scope != file_scope\n \t      && scope != external_scope)\n \t    {\n@@ -1268,7 +1269,7 @@ pop_scope (void)\n \t\t in the same translation unit.\"  */\n \t      if (!flag_gnu89_inline\n \t\t  && !lookup_attribute (\"gnu_inline\", DECL_ATTRIBUTES (p))\n-\t\t  && scope != external_scope)\n+\t\t  && scope == external_scope)\n \t\tpedwarn (input_location, 0,\n \t\t\t \"inline function %q+D declared but never defined\", p);\n \t      DECL_EXTERNAL (p) = 1;"}, {"sha": "ebc96a331bc47e86f3a87ca3e64a22de6bd5e68b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=65c5b1eb85f8f0f3078f614d549f107ee9a001af", "patch": "@@ -1,3 +1,9 @@\n+2019-01-07  Joseph Myers  <joseph@codesourcery.com>\n+\n+\tPR c/88720\n+\tPR c/88726\n+\t* gcc.dg/inline-40.c, gcc.dg/inline-41.c: New tests.\n+\n 2019-01-07  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \t* g++.dg/diagnostic/constexpr1.C: New."}, {"sha": "d0fdaeef34a3d4af717e24c54787d96364c66db7", "filename": "gcc/testsuite/gcc.dg/inline-40.c", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Ftestsuite%2Fgcc.dg%2Finline-40.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Ftestsuite%2Fgcc.dg%2Finline-40.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Finline-40.c?ref=65c5b1eb85f8f0f3078f614d549f107ee9a001af", "patch": "@@ -0,0 +1,49 @@\n+/* Test inline functions declared in inner scopes.  Bugs 88720 and 88726.  */\n+/* { dg-do compile } */\n+/* { dg-options \"\" } */\n+\n+void\n+inline_1 (void)\n+{\n+}\n+\n+void\n+inline_2 (void)\n+{\n+}\n+\n+static void\n+inline_static_1 (void)\n+{\n+}\n+\n+static void\n+inline_static_2 (void)\n+{\n+}\n+\n+static void inline_static_3 (void);\n+static void inline_static_4 (void);\n+\n+static void\n+test (void)\n+{\n+  inline void inline_1 (void);\n+  extern inline void inline_2 (void);\n+  inline void inline_3 (void);\n+  extern inline void inline_4 (void);\n+  inline void inline_static_1 (void);\n+  extern inline void inline_static_2 (void);\n+  inline void inline_static_3 (void);\n+  extern inline void inline_static_4 (void);\n+}\n+\n+void\n+inline_3 (void)\n+{\n+}\n+\n+void\n+inline_4 (void)\n+{\n+}"}, {"sha": "1511aeebd582f3e4288f66266c888616722769e5", "filename": "gcc/testsuite/gcc.dg/inline-41.c", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Ftestsuite%2Fgcc.dg%2Finline-41.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/65c5b1eb85f8f0f3078f614d549f107ee9a001af/gcc%2Ftestsuite%2Fgcc.dg%2Finline-41.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Finline-41.c?ref=65c5b1eb85f8f0f3078f614d549f107ee9a001af", "patch": "@@ -0,0 +1,49 @@\n+/* Test inline functions declared in inner scopes.  Bugs 88720 and 88726.  */\n+/* { dg-do compile } */\n+/* { dg-options \"-fgnu89-inline\" } */\n+\n+void\n+inline_1 (void)\n+{\n+}\n+\n+void\n+inline_2 (void)\n+{\n+}\n+\n+static void\n+inline_static_1 (void)\n+{\n+}\n+\n+static void\n+inline_static_2 (void)\n+{\n+}\n+\n+static void inline_static_3 (void);\n+static void inline_static_4 (void);\n+\n+static void\n+test (void)\n+{\n+  inline void inline_1 (void);\n+  extern inline void inline_2 (void);\n+  inline void inline_3 (void);\n+  extern inline void inline_4 (void);\n+  inline void inline_static_1 (void);\n+  extern inline void inline_static_2 (void);\n+  inline void inline_static_3 (void);\n+  extern inline void inline_static_4 (void);\n+}\n+\n+void\n+inline_3 (void)\n+{\n+}\n+\n+void\n+inline_4 (void)\n+{\n+}"}]}