{"sha": "8afcd148103b0467126483151b6fb5ac68920e72", "node_id": "C_kwDOANBUbNoAKDhhZmNkMTQ4MTAzYjA0NjcxMjY0ODMxNTFiNmZiNWFjNjg5MjBlNzI", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-05-04T10:01:56Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-05-04T10:02:57Z"}, "message": "genconditions: Add support for targets without non-trivial insn conditions\n\nSomebody complained on IRC that when writing a new backend one can get\nan error while compiling build/gencondmd.cc.\nThe problem is that when host compiler is g++ 3 or later (or when\nbootstrapping), we compile it with g++ -std=c++11 -pedantic and\nthe generated insn_conditions array contains pairs\n{ \"cond\", __builtin_constant_p (cond) ? (int) (cond) : -1 },\nwhere cond is some non-trivial instruction condition.  Now if a target\nuses \"\" for all the conditions (admittedly unlikely for non-trivial\ntarget), the initializer for insn_conditions[] is {} and that is\npedantically rejected because C++ doesn't support zero-sized arrays.\n\nThe following patch fixes that by adding an artificial termination\nelement and skips that during the walk.\n\n2022-05-04  Jakub Jelinek  <jakub@redhat.com>\n\n\t* genconditions.cc (write_conditions): Append a { nullptr, -1 }\n\telement at the end of insn_conditions.\n\t(write_writer): Use ARRAY_SIZE (insn_conditions) - 1 instead of\n\tARRAY_SIZE (insn_conditions).", "tree": {"sha": "3fac7cbbe6d12c0047d4212d5d3e0441901fc8a0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3fac7cbbe6d12c0047d4212d5d3e0441901fc8a0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8afcd148103b0467126483151b6fb5ac68920e72", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8afcd148103b0467126483151b6fb5ac68920e72", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8afcd148103b0467126483151b6fb5ac68920e72", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8afcd148103b0467126483151b6fb5ac68920e72/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7499c13ce3bf510a6244c1840348f305b66a2513", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7499c13ce3bf510a6244c1840348f305b66a2513", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7499c13ce3bf510a6244c1840348f305b66a2513"}], "stats": {"total": 4, "additions": 2, "deletions": 2}, "files": [{"sha": "f63a3f495c5dccb426bd9b261dec9b7f0d500842", "filename": "gcc/genconditions.cc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8afcd148103b0467126483151b6fb5ac68920e72/gcc%2Fgenconditions.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8afcd148103b0467126483151b6fb5ac68920e72/gcc%2Fgenconditions.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgenconditions.cc?ref=8afcd148103b0467126483151b6fb5ac68920e72", "patch": "@@ -175,7 +175,7 @@ static const struct c_test insn_conditions[] = {\\n\");\n \n   traverse_c_tests (write_one_condition, 0);\n \n-  puts (\"\\n};\\n#endif /* gcc >= 3.0.1 */\\n\");\n+  puts (\"  { nullptr, -1 }\\n};\\n#endif /* gcc >= 3.0.1 */\\n\");\n }\n \n /* Emit code which will convert the C-format table to a\n@@ -192,7 +192,7 @@ write_writer (void)\n         \"  const char *p;\\n\"\n         \"  puts (\\\"(define_conditions [\\\");\\n\"\n \t\"#if GCC_VERSION >= 3001\\n\"\n-\t\"  for (i = 0; i < ARRAY_SIZE (insn_conditions); i++)\\n\"\n+\t\"  for (i = 0; i < ARRAY_SIZE (insn_conditions) - 1; i++)\\n\"\n \t\"    {\\n\"\n \t\"      printf (\\\"  (%d \\\\\\\"\\\", insn_conditions[i].value);\\n\"\n \t\"      for (p = insn_conditions[i].expr; *p; p++)\\n\""}]}