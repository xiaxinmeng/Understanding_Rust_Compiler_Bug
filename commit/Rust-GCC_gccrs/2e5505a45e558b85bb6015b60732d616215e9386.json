{"sha": "2e5505a45e558b85bb6015b60732d616215e9386", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MmU1NTA1YTQ1ZTU1OGI4NWJiNjAxNWI2MDczMmQ2MTYyMTVlOTM4Ng==", "commit": {"author": {"name": "Richard Earnshaw", "email": "rearnsha@arm.com", "date": "2010-04-02T08:32:00Z"}, "committer": {"name": "Richard Earnshaw", "email": "rearnsha@gcc.gnu.org", "date": "2010-04-02T08:32:00Z"}, "message": "re PR target/43469 (ICE trying to compile glibc for ARM thumb2)\n\n\tPR target/43469\n\t* arm.c (legitimize_tls_address): Adjust call to \n\tgen_tls_load_dot_plus_four.\n\t(arm_note_pic_base): New function.\n\t(arm_cannot_copy_insn_p): Use it.\n\t* thumb2.md (tls_load_dot_plus_four): Rework to avoid use of '+' in\n\tconstraint.\n\nFrom-SVN: r157942", "tree": {"sha": "627c04fd24b96d2b49985e7ae66db1cb9314296f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/627c04fd24b96d2b49985e7ae66db1cb9314296f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/2e5505a45e558b85bb6015b60732d616215e9386", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5505a45e558b85bb6015b60732d616215e9386", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2e5505a45e558b85bb6015b60732d616215e9386", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2e5505a45e558b85bb6015b60732d616215e9386/comments", "author": null, "committer": null, "parents": [{"sha": "bdfbd9df4f85e4feba9e2ef30a3c93fac2902fc6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bdfbd9df4f85e4feba9e2ef30a3c93fac2902fc6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bdfbd9df4f85e4feba9e2ef30a3c93fac2902fc6"}], "stats": {"total": 56, "additions": 30, "deletions": 26}, "files": [{"sha": "c9e4a39a9006421380a049b0fa37f57ea3ecffa0", "filename": "gcc/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5505a45e558b85bb6015b60732d616215e9386/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5505a45e558b85bb6015b60732d616215e9386/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=2e5505a45e558b85bb6015b60732d616215e9386", "patch": "@@ -1,3 +1,13 @@\n+2010-04-02  Richard Earnshaw  <rearnsha@arm.com>\n+\n+\tPR target/43469\n+\t* arm.c (legitimize_tls_address): Adjust call to \n+\tgen_tls_load_dot_plus_four.\n+\t(arm_note_pic_base): New function.\n+\t(arm_cannot_copy_insn_p): Use it.\n+\t* thumb2.md (tls_load_dot_plus_four): Rework to avoid use of '+' in\n+\tconstraint.\n+\n 2010-04-02  Ralf Wildenhues  <Ralf.Wildenhues@gmx.de>\n \n \tPR bootstrap/43531"}, {"sha": "84dd8fa972b8b045657ee51b355bb4909edacf66", "filename": "gcc/config/arm/arm.c", "status": "modified", "additions": 12, "deletions": 19, "changes": 31, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5505a45e558b85bb6015b60732d616215e9386/gcc%2Fconfig%2Farm%2Farm.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5505a45e558b85bb6015b60732d616215e9386/gcc%2Fconfig%2Farm%2Farm.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Farm%2Farm.c?ref=2e5505a45e558b85bb6015b60732d616215e9386", "patch": "@@ -5843,7 +5843,7 @@ legitimize_tls_address (rtx x, rtx reg)\n       if (TARGET_ARM)\n \temit_insn (gen_tls_load_dot_plus_eight (reg, reg, labelno));\n       else if (TARGET_THUMB2)\n-\temit_insn (gen_tls_load_dot_plus_four (reg, reg, labelno));\n+\temit_insn (gen_tls_load_dot_plus_four (reg, NULL, reg, labelno));\n       else\n \t{\n \t  emit_insn (gen_pic_add_dot_plus_four (reg, reg, labelno));\n@@ -8801,28 +8801,21 @@ tls_mentioned_p (rtx x)\n     }\n }\n \n-/* Must not copy a SET whose source operand is PC-relative.  */\n+/* Must not copy any rtx that uses a pc-relative address.  */\n+\n+static int\n+arm_note_pic_base (rtx *x, void *date ATTRIBUTE_UNUSED)\n+{\n+  if (GET_CODE (*x) == UNSPEC\n+      && XINT (*x, 1) == UNSPEC_PIC_BASE)\n+    return 1;\n+  return 0;\n+}\n \n static bool\n arm_cannot_copy_insn_p (rtx insn)\n {\n-  rtx pat = PATTERN (insn);\n-\n-  if (GET_CODE (pat) == SET)\n-    {\n-      rtx rhs = SET_SRC (pat);\n-\n-      if (GET_CODE (rhs) == UNSPEC\n-\t  && XINT (rhs, 1) == UNSPEC_PIC_BASE)\n-\treturn TRUE;\n-\n-      if (GET_CODE (rhs) == MEM\n-\t  && GET_CODE (XEXP (rhs, 0)) == UNSPEC\n-\t  && XINT (XEXP (rhs, 0), 1) == UNSPEC_PIC_BASE)\n-\treturn TRUE;\n-    }\n-\n-  return FALSE;\n+  return for_each_rtx (&PATTERN (insn), arm_note_pic_base, NULL);\n }\n \n enum rtx_code"}, {"sha": "69a5e0683b488ea08440de8c685a88dcd1c45699", "filename": "gcc/config/arm/thumb2.md", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/2e5505a45e558b85bb6015b60732d616215e9386/gcc%2Fconfig%2Farm%2Fthumb2.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/2e5505a45e558b85bb6015b60732d616215e9386/gcc%2Fconfig%2Farm%2Fthumb2.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Farm%2Fthumb2.md?ref=2e5505a45e558b85bb6015b60732d616215e9386", "patch": "@@ -244,18 +244,19 @@\n )\n \n (define_insn \"tls_load_dot_plus_four\"\n-  [(set (match_operand:SI 0 \"register_operand\" \"=l,r\")\n-\t(mem:SI (unspec:SI [(match_operand:SI 1 \"register_operand\" \"+l,r\")\n+  [(set (match_operand:SI 0 \"register_operand\" \"=l,l,r,r\")\n+\t(mem:SI (unspec:SI [(match_operand:SI 2 \"register_operand\" \"0,1,0,1\")\n \t\t\t    (const_int 4)\n-\t\t\t    (match_operand 2 \"\" \"\")]\n-\t\t\t   UNSPEC_PIC_BASE)))]\n+\t\t\t    (match_operand 3 \"\" \"\")]\n+\t\t\t   UNSPEC_PIC_BASE)))\n+   (clobber (match_scratch:SI 1 \"=X,l,X,r\"))]\n   \"TARGET_THUMB2\"\n   \"*\n   (*targetm.asm_out.internal_label) (asm_out_file, \\\"LPIC\\\",\n-\t\t\t     INTVAL (operands[2]));\n-  return \\\"add\\\\t%1, %|pc\\;ldr%?\\\\t%0, [%1]\\\";\n+\t\t\t     INTVAL (operands[3]));\n+  return \\\"add\\\\t%2, %|pc\\;ldr%?\\\\t%0, [%2]\\\";\n   \"\n-  [(set_attr \"length\" \"4,6\")]\n+  [(set_attr \"length\" \"4,4,6,6\")]\n )\n \n ;; Thumb-2 always has load/store halfword instructions, so we can avoid a lot"}]}