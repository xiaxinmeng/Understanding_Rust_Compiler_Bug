{"sha": "afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YWZiMmRlYzUyNjllZDFjYzcyOGFlZDBhMmNiMTY5ZWVmNGVkNjZmMw==", "commit": {"author": {"name": "Bryce McKinlay", "email": "bryce@waitaki.otago.ac.nz", "date": "2001-10-23T05:42:03Z"}, "committer": {"name": "Bryce McKinlay", "email": "bryce@gcc.gnu.org", "date": "2001-10-23T05:42:03Z"}, "message": "prims.cc (_Jv_Abort): Always print error message using fprintf, don't try to allocate.\n\n        * prims.cc (_Jv_Abort): Always print error message using fprintf,\n        don't try to allocate.\n        (_Jv_CreateJavaVM): Set gcj::runTimeInitialized.\n        * include/jvm.h (gcj::runTimeInitialized): New variable declaration.\n        * java/lang/natClassLoader.cc (_Jv_RegisterClassHookDefault): Handle\n        duplicate class registration with JvFail if the runtime hasn't been\n        initialized yet.\n\nFrom-SVN: r46424", "tree": {"sha": "bf8ec1fbae17015b582311573e8b7f51bcecfd33", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/bf8ec1fbae17015b582311573e8b7f51bcecfd33"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/comments", "author": null, "committer": null, "parents": [{"sha": "187e37f9a62262da037e88c34d58557ce1fecc80", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/187e37f9a62262da037e88c34d58557ce1fecc80", "html_url": "https://github.com/Rust-GCC/gccrs/commit/187e37f9a62262da037e88c34d58557ce1fecc80"}], "stats": {"total": 39, "additions": 30, "deletions": 9}, "files": [{"sha": "8cb0dab502a3a4a19bbba0b13bcc594ebff7683f", "filename": "libjava/ChangeLog", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2FChangeLog?ref=afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "patch": "@@ -1,3 +1,13 @@\n+2001-10-23  Bryce McKinlay  <bryce@waitaki.otago.ac.nz>\n+\n+\t* prims.cc (_Jv_Abort): Always print error message using fprintf,\n+\tdon't try to allocate.\n+\t(_Jv_CreateJavaVM): Set gcj::runTimeInitialized.\n+\t* include/jvm.h (gcj::runTimeInitialized): New variable declaration.\n+\t* java/lang/natClassLoader.cc (_Jv_RegisterClassHookDefault): Handle\n+\tduplicate class registration with JvFail if the runtime hasn't been\n+\tinitialized yet.\n+\n 2001-10-22  Tom Tromey  <tromey@redhat.com>\n \n \t* java/util/GregorianCalendar.java (getGregorianChange): Removed"}, {"sha": "858d960bf201685a93112efc904cbddf519f05e5", "filename": "libjava/include/jvm.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2Finclude%2Fjvm.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2Finclude%2Fjvm.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Finclude%2Fjvm.h?ref=afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "patch": "@@ -131,6 +131,9 @@ namespace gcj\n   extern _Jv_Utf8Const *clinit_name;    /* \"<clinit>\" */\n   extern _Jv_Utf8Const *init_name;      /* \"<init>\" */\n   extern _Jv_Utf8Const *finit_name;     /* \"finit$\", */\n+  \n+  /* Set to true by _Jv_CreateJavaVM. */\n+  extern bool runtimeInitialized;\n };\n \n /* Type of pointer used as finalizer.  */"}, {"sha": "d92a90c8b8c618c02edc26c7a06d894f40c7830f", "filename": "libjava/java/lang/natClassLoader.cc", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2Fjava%2Flang%2FnatClassLoader.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2Fjava%2Flang%2FnatClassLoader.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fjava%2Flang%2FnatClassLoader.cc?ref=afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "patch": "@@ -14,6 +14,7 @@ details.  */\n \n #include <stdlib.h>\n #include <string.h>\n+#include <stdio.h>\n \n #include <gcj/cni.h>\n #include <jvm.h>\n@@ -452,7 +453,17 @@ _Jv_RegisterClassHookDefault (jclass klass)\n \t{\n \t  // If you get this, it means you have the same class in two\n \t  // different libraries.\n-\t  throw new java::lang::VirtualMachineError (JvNewStringLatin1 (\"class registered twice\"));\n+\t  char *message;\n+\t  asprintf (&message, \"Duplicate class registration: %s\", \n+\t\t    klass->name->data);\n+\t  if (! gcj::runtimeInitialized)\n+\t    JvFail (message);\n+\t  else\n+\t    {\n+\t      java::lang::String *str = JvNewStringLatin1 (message);\n+\t      free (message);\n+\t      throw new java::lang::VirtualMachineError (str);\n+\t    }\n \t}\n \n       check_class = check_class->next;"}, {"sha": "f2f2d6578a2378ecd5508a94306af030372a0982", "filename": "libjava/prims.cc", "status": "modified", "additions": 5, "deletions": 8, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2Fprims.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/afb2dec5269ed1cc728aed0a2cb169eef4ed66f3/libjava%2Fprims.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fprims.cc?ref=afb2dec5269ed1cc728aed0a2cb169eef4ed66f3", "patch": "@@ -299,10 +299,7 @@ _Jv_Abort (const char *, const char *, int, const char *message)\n \t   \"libgcj failure: %s\\n   in function %s, file %s, line %d\\n\",\n \t   message, function, file, line);\n #else\n-  java::io::PrintStream *err = java::lang::System::err;\n-  err->print(JvNewStringLatin1 (\"libgcj failure: \"));\n-  err->println(JvNewStringLatin1 (message));\n-  err->flush();\n+  fprintf (stderr, \"libgcj failure: %s\\n\", message);\n #endif\n   abort ();\n }\n@@ -872,19 +869,19 @@ namespace gcj\n   _Jv_Utf8Const *clinit_name;\n   _Jv_Utf8Const *init_name;\n   _Jv_Utf8Const *finit_name;\n+  \n+  bool runtimeInitialized = false;\n }\n \n jint\n _Jv_CreateJavaVM (void* /*vm_args*/)\n {\n   using namespace gcj;\n   \n-  static bool init = false;\n-\n-  if (init)\n+  if (runtimeInitialized)\n     return -1;\n \n-  init = true;\n+  runtimeInitialized = true;\n \n   PROCESS_GCJ_PROPERTIES;\n "}]}