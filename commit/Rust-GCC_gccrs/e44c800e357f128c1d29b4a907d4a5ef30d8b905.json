{"sha": "e44c800e357f128c1d29b4a907d4a5ef30d8b905", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZTQ0YzgwMGUzNTdmMTI4YzFkMjliNGE5MDdkNGE1ZWYzMGQ4YjkwNQ==", "commit": {"author": {"name": "Dodji Seketeli", "email": "dseketel@redhat.com", "date": "2008-07-30T13:07:50Z"}, "committer": {"name": "Dodji Seketeli", "email": "dodji@gcc.gnu.org", "date": "2008-07-30T13:07:50Z"}, "message": "re PR c++/36767 (Segmentation fault with -fprofile-arcs -O2)\n\n2008-07-30  Dodji Seketeli  <dseketel@redhat.com>\n\n\tPR c++/36767\n\t* decl2.c (fix_temporary_vars_context_r): New function.\n\t (one_static_initialization_or_destruction): Make sure temporary\n\t variables part of the initialiser have their DECL_CONTEXT()\n\t properly set.\n\nFrom-SVN: r138308", "tree": {"sha": "08bd2a718763530d56f5fa8037654dede3816472", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/08bd2a718763530d56f5fa8037654dede3816472"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/e44c800e357f128c1d29b4a907d4a5ef30d8b905", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e44c800e357f128c1d29b4a907d4a5ef30d8b905", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e44c800e357f128c1d29b4a907d4a5ef30d8b905", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e44c800e357f128c1d29b4a907d4a5ef30d8b905/comments", "author": null, "committer": null, "parents": [{"sha": "6ca2b0a0388c2944e222aab817db7f09bd2f96c4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6ca2b0a0388c2944e222aab817db7f09bd2f96c4", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6ca2b0a0388c2944e222aab817db7f09bd2f96c4"}], "stats": {"total": 67, "additions": 67, "deletions": 0}, "files": [{"sha": "e98283ad6ca00ee1cc26ccc93ec94f2eb573fb34", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=e44c800e357f128c1d29b4a907d4a5ef30d8b905", "patch": "@@ -1,3 +1,11 @@\n+2008-07-30  Dodji Seketeli  <dseketel@redhat.com>\n+\n+\tPR c++/36767\n+\t* decl2.c (fix_temporary_vars_context_r): New function.\n+\t (one_static_initialization_or_destruction): Make sure temporary\n+\t variables part of the initialiser have their DECL_CONTEXT()\n+\t properly set.\n+\n 2008-07-30  Manuel Lopez-Ibanez  <manu@gcc.gnu.org>\n \n \tPR 34389"}, {"sha": "eb92dfd68cf8589bd1dc8727a461cca599f8378c", "filename": "gcc/cp/decl2.c", "status": "modified", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Fcp%2Fdecl2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Fcp%2Fdecl2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl2.c?ref=e44c800e357f128c1d29b4a907d4a5ef30d8b905", "patch": "@@ -2811,6 +2811,38 @@ get_priority_info (int priority)\n \t\t\t\t\t\t    || DECL_ONE_ONLY (decl) \\\n \t\t\t\t\t\t    || DECL_WEAK (decl)))\n \n+/* Called from one_static_initialization_or_destruction(),\n+   via walk_tree.\n+   Walks the initializer list of a global variable and looks for\n+   temporary variables (DECL_NAME() == NULL and DECL_ARTIFICIAL != 0)\n+   and that have their DECL_CONTEXT() == NULL.\n+   For each such temporary variable, set their DECL_CONTEXT() to\n+   the current function. This is necessary because otherwise\n+   some optimizers (enabled by -O2 -fprofile-arcs) might crash\n+   when trying to refer to a temporary variable that does not have\n+   it's DECL_CONTECT() properly set.  */\n+static tree \n+fix_temporary_vars_context_r (tree *node,\n+\t\t\t      int  *unused ATTRIBUTE_UNUSED,\n+\t\t\t      void *unused1 ATTRIBUTE_UNUSED)\n+{\n+  gcc_assert (current_function_decl);\n+\n+  if (TREE_CODE (*node) == BIND_EXPR)\n+    {\n+      tree var;\n+\n+      for (var = BIND_EXPR_VARS (*node); var; var = TREE_CHAIN (var))\n+\tif (TREE_CODE (var) == VAR_DECL\n+\t  && !DECL_NAME (var)\n+\t  && DECL_ARTIFICIAL (var)\n+\t  && !DECL_CONTEXT (var))\n+\t  DECL_CONTEXT (var) = current_function_decl;\n+    }\n+\n+  return NULL_TREE;\n+}\n+\n /* Set up to handle the initialization or destruction of DECL.  If\n    INITP is nonzero, we are initializing the variable.  Otherwise, we\n    are destroying it.  */\n@@ -2833,6 +2865,19 @@ one_static_initialization_or_destruction (tree decl, tree init, bool initp)\n      information.  */\n   input_location = DECL_SOURCE_LOCATION (decl);\n \n+  /* Make sure temporary variables in the initialiser all have\n+     their DECL_CONTEXT() set to a value different from NULL_TREE.\n+     This can happen when global variables initialisers are built.\n+     In that case, the DECL_CONTEXT() of the global variables _AND_ of all \n+     the temporary variables that might have been generated in the\n+     accompagning initialisers is NULL_TREE, meaning the variables have been\n+     declared in the global namespace.\n+     What we want to do here is to fix that and make sure the DECL_CONTEXT()\n+     of the temporaries are set to the current function decl.  */\n+  cp_walk_tree_without_duplicates (&init,\n+\t\t\t\t   fix_temporary_vars_context_r,\n+\t\t\t\t   NULL);\n+\n   /* Because of:\n \n        [class.access.spec]"}, {"sha": "95f4d4e9bc7998f6546dec0a601e52ade7adb581", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=e44c800e357f128c1d29b4a907d4a5ef30d8b905", "patch": "@@ -1,3 +1,8 @@\n+2008-07-30  Dodji Seketeli  <dseketel@redhat.com>\n+\n+\tPR c++/36767\n+\t* g++.dg/parse/crash42.C: New test.\n+\n 2008-07-30  Manuel Lopez-Ibanez  <manu@gcc.gnu.org>\n \n \tPR 34389"}, {"sha": "9cb07d5148d5f5a680e88207499a358b8373cdef", "filename": "gcc/testsuite/g++.dg/parse/crash42.C", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fparse%2Fcrash42.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/e44c800e357f128c1d29b4a907d4a5ef30d8b905/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fparse%2Fcrash42.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fparse%2Fcrash42.C?ref=e44c800e357f128c1d29b4a907d4a5ef30d8b905", "patch": "@@ -0,0 +1,9 @@\n+// Created by: Dodji Seketeli <dseketel@redhat.com>\n+// { dg-do compile }\n+// { dg-options \"-O2 -fprofile-arcs\" }\n+// Origin: PR C++/36767\n+\n+struct A { A (); ~A (); };\n+A a[2];\n+\n+"}]}