{"sha": "c787deb0124b667802d8519bc285894bb6d771d7", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Yzc4N2RlYjAxMjRiNjY3ODAyZDg1MTliYzI4NTg5NGJiNmQ3NzFkNw==", "commit": {"author": {"name": "Alexandre Oliva", "email": "aoliva@gcc.gnu.org", "date": "2019-08-09T09:20:58Z"}, "committer": {"name": "Alexandre Oliva", "email": "aoliva@gcc.gnu.org", "date": "2019-08-09T09:20:58Z"}, "message": "skip Cholesky decomposition in is>>n_mv_dist\n\nnormal_mv_distribution maintains the variance-covariance matrix param\nin Cholesky-decomposed form.  Existing param_type constructors, when\ntaking a full or lower-triangle varcov matrix, perform Cholesky\ndecomposition to convert it to the internal representation.  This\ninternal representation is visible both in the varcov() result, and in\nthe streamed-out representation of a normal_mv_distribution object.\n\nThe problem is that when that representation is streamed back in, the\nread-back decomposed varcov matrix is used as a lower-triangle\nnon-decomposed varcov matrix, and it undergoes Cholesky decomposition\nagain.  So, each cycle of stream-out/stream-in changes the varcov\nmatrix to its \"square root\", instead of restoring the original\nparams.\n\nThis patch includes Corentin's changes that introduce verification in\ntestsuite/ext/random/normal_mv_distribution/operators/serialize.cc and\nother similar tests that the object read back in compares equal to the\nwritten-out object: the modified tests pass only if (u == v).\n\nThis patch also fixes the error exposed by his change, introducing an\nalternate private constructor for param_type, used only by operator>>.\n\n\nfor  libstdc++-v3/ChangeLog\n\n\t* include/ext/random\n\t(normal_mv_distribution::param_type::param_type): New private\n\tctor taking a decomposed varcov matrix, for use by...\n\t(operator>>): ... this, befriended.\n\t* include/ext/random.tcc (operator>>): Use it.\n\t(normal_mv_distribution::param_type::_M_init_lower): Adjust\n\tmember function name in exception message.\n\nfor  libstdc++-v3/ChangeLog\nfrom  Corentin Gay  <gay@adacore.com>\n\n\t* testsuite/ext/random/beta_distribution/operators/serialize.cc,\n\ttestsuite/ext/random/hypergeometric_distribution/operators/serialize.cc,\n\ttestsuite/ext/random/normal_mv_distribution/operators/serialize.cc,\n\ttestsuite/ext/random/triangular_distribution/operators/serialize.cc,\n\ttestsuite/ext/random/von_mises_distribution/operators/serialize.cc:\n\tAdd call to `VERIFY`.\n\nFrom-SVN: r274233", "tree": {"sha": "dcf471c17642d638b25a9502daa1265fac53201b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/dcf471c17642d638b25a9502daa1265fac53201b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c787deb0124b667802d8519bc285894bb6d771d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c787deb0124b667802d8519bc285894bb6d771d7", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c787deb0124b667802d8519bc285894bb6d771d7", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c787deb0124b667802d8519bc285894bb6d771d7/comments", "author": null, "committer": null, "parents": [{"sha": "279dc7a3624ff68e9bb4f44293877250a8097c14", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/279dc7a3624ff68e9bb4f44293877250a8097c14", "html_url": "https://github.com/Rust-GCC/gccrs/commit/279dc7a3624ff68e9bb4f44293877250a8097c14"}], "stats": {"total": 51, "additions": 48, "deletions": 3}, "files": [{"sha": "5c02cb36488ad65b4a5d7b0acdee0f5abe98543c", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -1,3 +1,22 @@\n+2019-08-09  Corentin Gay  <gay@adacore.com>\n+\n+\t* testsuite/ext/random/beta_distribution/operators/serialize.cc,\n+\ttestsuite/ext/random/hypergeometric_distribution/operators/serialize.cc,\n+\ttestsuite/ext/random/normal_mv_distribution/operators/serialize.cc,\n+\ttestsuite/ext/random/triangular_distribution/operators/serialize.cc,\n+\ttestsuite/ext/random/von_mises_distribution/operators/serialize.cc:\n+\tAdd call to `VERIFY`.\n+\n+2019-08-09  Alexandre Oliva <oliva@adacore.com>\n+\n+\t* include/ext/random\n+\t(normal_mv_distribution::param_type::param_type): New private\n+\tctor taking a decomposed varcov matrix, for use by...\n+\t(operator>>): ... this, befriended.\n+\t* include/ext/random.tcc (operator>>): Use it.\n+\t(normal_mv_distribution::param_type::_M_init_lower): Adjust\n+\tmember function name in exception message.\n+\n 2019-08-08  Jonathan Wakely  <jwakely@redhat.com>\n \n \tP0325R4 to_array from LFTS with updates"}, {"sha": "d5574e02ba02cc432da82de06f912b586c86f9c1", "filename": "libstdc++-v3/include/ext/random", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Finclude%2Fext%2Frandom", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Finclude%2Fext%2Frandom", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fext%2Frandom?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -752,6 +752,21 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \t\t\t\t_InputIterator2 __varbegin,\n \t\t\t\t_InputIterator2 __varend);\n \n+\t// param_type constructors apply Cholesky decomposition to the\n+\t// varcov matrix in _M_init_full and _M_init_lower, but the\n+\t// varcov matrix output ot a stream is already decomposed, so\n+\t// we need means to restore it as-is when reading it back in.\n+\ttemplate<size_t _Dimen1, typename _RealType1,\n+\t\t typename _CharT, typename _Traits>\n+\tfriend std::basic_istream<_CharT, _Traits>&\n+\toperator>>(std::basic_istream<_CharT, _Traits>& __is,\n+\t\t   __gnu_cxx::normal_mv_distribution<_Dimen1, _RealType1>&\n+\t\t   __x);\n+\tparam_type(std::array<_RealType, _Dimen> const &__mean,\n+\t\t   std::array<_RealType, _M_t_size> const &__varcov)\n+\t  : _M_mean (__mean), _M_t (__varcov)\n+\t{}\n+\n \tstd::array<_RealType, _Dimen> _M_mean;\n \tstd::array<_RealType, _M_t_size> _M_t;\n       };"}, {"sha": "a8a49a3a9fa6a48a2911da122565aeded03d3f03", "filename": "libstdc++-v3/include/ext/random.tcc", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Finclude%2Fext%2Frandom.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Finclude%2Fext%2Frandom.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fext%2Frandom.tcc?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -581,7 +581,7 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \t    __sum = *__varcovbegin++ - __sum;\n \t    if (__builtin_expect(__sum <= _RealType(0), 0))\n \t      std::__throw_runtime_error(__N(\"normal_mv_distribution::\"\n-\t\t\t\t\t     \"param_type::_M_init_full\"));\n+\t\t\t\t\t     \"param_type::_M_init_lower\"));\n \t    *__w++ = std::sqrt(__sum);\n \t  }\n       }\n@@ -709,9 +709,11 @@ _GLIBCXX_BEGIN_NAMESPACE_VERSION\n \n       __is >> __x._M_nd;\n \n+      // The param_type temporary is built with a private constructor,\n+      // to skip the Cholesky decomposition that would be performed\n+      // otherwise.\n       __x.param(typename normal_mv_distribution<_Dimen, _RealType>::\n-\t\tparam_type(__mean.begin(), __mean.end(),\n-\t\t\t   __varcov.begin(), __varcov.end()));\n+\t\tparam_type(__mean, __varcov));\n \n       __is.flags(__flags);\n       return __is;"}, {"sha": "a4925fc1c41be34d88f71d578145db6d4c7e950b", "filename": "libstdc++-v3/testsuite/ext/random/beta_distribution/operators/serialize.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fbeta_distribution%2Foperators%2Fserialize.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fbeta_distribution%2Foperators%2Fserialize.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fbeta_distribution%2Foperators%2Fserialize.cc?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -23,6 +23,7 @@\n \n #include <ext/random>\n #include <sstream>\n+#include <testsuite_hooks.h>\n \n void\n test01()\n@@ -35,6 +36,7 @@ test01()\n   str << u;\n \n   str >> v;\n+  VERIFY( u == v );\n }\n \n int main()"}, {"sha": "e9077b2c58d6513ffff3fc04cea8a6ce39f7dfed", "filename": "libstdc++-v3/testsuite/ext/random/hypergeometric_distribution/operators/serialize.cc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fhypergeometric_distribution%2Foperators%2Fserialize.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fhypergeometric_distribution%2Foperators%2Fserialize.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fhypergeometric_distribution%2Foperators%2Fserialize.cc?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -38,6 +38,7 @@ test01()\n   str << u;\n \n   str >> v;\n+  VERIFY( u == v );\n }\n \n int"}, {"sha": "f5fbc42a686f09f66833f8d06be05c8b3b215b2d", "filename": "libstdc++-v3/testsuite/ext/random/normal_mv_distribution/operators/serialize.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fnormal_mv_distribution%2Foperators%2Fserialize.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fnormal_mv_distribution%2Foperators%2Fserialize.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fnormal_mv_distribution%2Foperators%2Fserialize.cc?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -23,6 +23,7 @@\n \n #include <ext/random>\n #include <sstream>\n+#include <testsuite_hooks.h>\n \n void\n test01()\n@@ -35,6 +36,7 @@ test01()\n   str << u;\n \n   str >> v;\n+  VERIFY( u == v );\n }\n \n int main()"}, {"sha": "75e16cf0437cbd8e4b77c0c505e93825f55cfc2e", "filename": "libstdc++-v3/testsuite/ext/random/triangular_distribution/operators/serialize.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Ftriangular_distribution%2Foperators%2Fserialize.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Ftriangular_distribution%2Foperators%2Fserialize.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Ftriangular_distribution%2Foperators%2Fserialize.cc?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -23,6 +23,7 @@\n \n #include <ext/random>\n #include <sstream>\n+#include <testsuite_hooks.h>\n \n void\n test01()\n@@ -35,6 +36,7 @@ test01()\n   str << u;\n \n   str >> v;\n+  VERIFY( u == v );\n }\n \n int main()"}, {"sha": "b32a31dee64212ba342e4e005c14dd4642675144", "filename": "libstdc++-v3/testsuite/ext/random/von_mises_distribution/operators/serialize.cc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fvon_mises_distribution%2Foperators%2Fserialize.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c787deb0124b667802d8519bc285894bb6d771d7/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fvon_mises_distribution%2Foperators%2Fserialize.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2Fext%2Frandom%2Fvon_mises_distribution%2Foperators%2Fserialize.cc?ref=c787deb0124b667802d8519bc285894bb6d771d7", "patch": "@@ -23,6 +23,7 @@\n \n #include <ext/random>\n #include <sstream>\n+#include <testsuite_hooks.h>\n \n void\n test01()\n@@ -35,6 +36,7 @@ test01()\n   str << u;\n \n   str >> v;\n+  VERIFY( u == v );\n }\n \n int main()"}]}