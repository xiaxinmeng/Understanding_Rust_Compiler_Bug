{"sha": "37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzdjZDhkOTdmM2FhNzc5MTk3ZWIxMDNkMWU0YjRkMGFjNjNhZGM0YQ==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@adacore.com", "date": "2021-02-28T13:25:42Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2021-06-16T08:43:02Z"}, "message": "[Ada] Wrong reference to System.Tasking in expanded code\n\ngcc/ada/\n\n\t* rtsfind.ads, libgnarl/s-taskin.ads, exp_ch3.adb, exp_ch4.adb,\n\texp_ch6.adb, exp_ch9.adb, sem_ch6.adb: Move master related\n\tentities to the expander directly.", "tree": {"sha": "2d80e2570e4c4e2ea7c448561ff38a1225f6ee42", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2d80e2570e4c4e2ea7c448561ff38a1225f6ee42"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/comments", "author": {"login": "ArnaudCharlet", "id": 30291825, "node_id": "MDQ6VXNlcjMwMjkxODI1", "avatar_url": "https://avatars.githubusercontent.com/u/30291825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ArnaudCharlet", "html_url": "https://github.com/ArnaudCharlet", "followers_url": "https://api.github.com/users/ArnaudCharlet/followers", "following_url": "https://api.github.com/users/ArnaudCharlet/following{/other_user}", "gists_url": "https://api.github.com/users/ArnaudCharlet/gists{/gist_id}", "starred_url": "https://api.github.com/users/ArnaudCharlet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ArnaudCharlet/subscriptions", "organizations_url": "https://api.github.com/users/ArnaudCharlet/orgs", "repos_url": "https://api.github.com/users/ArnaudCharlet/repos", "events_url": "https://api.github.com/users/ArnaudCharlet/events{/privacy}", "received_events_url": "https://api.github.com/users/ArnaudCharlet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7f37ed649417925dee12e099dbb3227a3be30c2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7f37ed649417925dee12e099dbb3227a3be30c2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f7f37ed649417925dee12e099dbb3227a3be30c2"}], "stats": {"total": 75, "additions": 28, "deletions": 47}, "files": [{"sha": "23b5b348a506d6c268f4520a098f651f1f8d9096", "filename": "gcc/ada/exp_ch3.adb", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch3.adb?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -1696,8 +1696,7 @@ package body Exp_Ch3 is\n \n       if Has_Task (Full_Type) then\n          if Restriction_Active (No_Task_Hierarchy) then\n-            Append_To (Args,\n-              New_Occurrence_Of (RTE (RE_Library_Task_Level), Loc));\n+            Append_To (Args, Make_Integer_Literal (Loc, Library_Task_Level));\n          else\n             Append_To (Args, Make_Identifier (Loc, Name_uMaster));\n          end if;\n@@ -2218,8 +2217,8 @@ package body Exp_Ch3 is\n \n          if Has_Task (Rec_Type) then\n             if Restriction_Active (No_Task_Hierarchy) then\n-               Append_To (Args,\n-                 New_Occurrence_Of (RTE (RE_Library_Task_Level), Loc));\n+               Append_To\n+                 (Args, Make_Integer_Literal (Loc, Library_Task_Level));\n             else\n                Append_To (Args, Make_Identifier (Loc, Name_uMaster));\n             end if;\n@@ -9071,7 +9070,7 @@ package body Exp_Ch3 is\n              Defining_Identifier =>\n                Make_Defining_Identifier (Loc, Name_uMaster),\n              Parameter_Type      =>\n-               New_Occurrence_Of (RTE (RE_Master_Id), Loc)));\n+               New_Occurrence_Of (Standard_Integer, Loc)));\n \n          Set_Has_Master_Entity (Proc_Id);\n "}, {"sha": "5b3a11677db684fd8d25f51d3057baede7a785dd", "filename": "gcc/ada/exp_ch4.adb", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch4.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch4.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch4.adb?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -5193,8 +5193,8 @@ package body Exp_Ch4 is\n                   end if;\n \n                   if Restriction_Active (No_Task_Hierarchy) then\n-                     Append_To (Args,\n-                       New_Occurrence_Of (RTE (RE_Library_Task_Level), Loc));\n+                     Append_To\n+                       (Args, Make_Integer_Literal (Loc, Library_Task_Level));\n                   else\n                      Append_To (Args,\n                        New_Occurrence_Of"}, {"sha": "b5d77bdcf7cf4ffeb3415770a05d7de4756678fe", "filename": "gcc/ada/exp_ch6.adb", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch6.adb?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -602,7 +602,7 @@ package body Exp_Ch6 is\n       --  Use a dummy _master actual in case of No_Task_Hierarchy\n \n       if Restriction_Active (No_Task_Hierarchy) then\n-         Actual := New_Occurrence_Of (RTE (RE_Library_Task_Level), Loc);\n+         Actual := Make_Integer_Literal (Loc, Library_Task_Level);\n \n       --  In the case where we use the master associated with an access type,\n       --  the actual is an entity and requires an explicit reference."}, {"sha": "3948b6a51a3c9fa0d9875eea061c7e5c6bc612e1", "filename": "gcc/ada/exp_ch9.adb", "status": "modified", "additions": 13, "deletions": 26, "changes": 39, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fexp_ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch9.adb?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -1756,34 +1756,21 @@ package body Exp_Ch9 is\n       --  Generate a dummy master if tasks or tasking hierarchies are\n       --  prohibited.\n \n-      --    _Master : constant Master_Id := 3;\n+      --    _Master : constant Integer := Library_Task_Level;\n \n       if not Tasking_Allowed\n         or else Restrictions.Set (No_Task_Hierarchy)\n         or else not RTE_Available (RE_Current_Master)\n       then\n-         declare\n-            Expr : Node_Id;\n-\n-         begin\n-            --  RE_Library_Task_Level is not always available in configurable\n-            --  RunTime\n-\n-            if not RTE_Available (RE_Library_Task_Level) then\n-               Expr := Make_Integer_Literal (Loc, Uint_3);\n-            else\n-               Expr := New_Occurrence_Of (RTE (RE_Library_Task_Level), Loc);\n-            end if;\n-\n-            Master_Decl :=\n-              Make_Object_Declaration (Loc,\n-                Defining_Identifier =>\n-                  Make_Defining_Identifier (Loc, Name_uMaster),\n-                Constant_Present    => True,\n-                Object_Definition   =>\n-                  New_Occurrence_Of (Standard_Integer, Loc),\n-                Expression          => Expr);\n-         end;\n+         Master_Decl :=\n+           Make_Object_Declaration (Loc,\n+             Defining_Identifier =>\n+               Make_Defining_Identifier (Loc, Name_uMaster),\n+             Constant_Present    => True,\n+             Object_Definition   =>\n+               New_Occurrence_Of (Standard_Integer, Loc),\n+             Expression          =>\n+               Make_Integer_Literal (Loc, Library_Task_Level));\n \n       --  Generate:\n       --    _master : constant Integer := Current_Master.all;\n@@ -3628,7 +3615,8 @@ package body Exp_Ch9 is\n       Master_Decl :=\n         Make_Object_Renaming_Declaration (Loc,\n           Defining_Identifier => Master_Id,\n-          Subtype_Mark        => New_Occurrence_Of (RTE (RE_Master_Id), Loc),\n+          Subtype_Mark        =>\n+            New_Occurrence_Of (Standard_Integer, Loc),\n           Name                => Make_Identifier (Loc, Name_uMaster));\n \n       Insert_Action (Context, Master_Decl);\n@@ -14710,8 +14698,7 @@ package body Exp_Ch9 is\n          if Restriction_Active (No_Task_Hierarchy) = False then\n             Append_To (Args, Make_Identifier (Loc, Name_uMaster));\n          else\n-            Append_To (Args,\n-              New_Occurrence_Of (RTE (RE_Library_Task_Level), Loc));\n+            Append_To (Args, Make_Integer_Literal (Loc, Library_Task_Level));\n          end if;\n       end if;\n "}, {"sha": "5c03829f1e9d93a96eac649c9c82d8c7a56c425c", "filename": "gcc/ada/libgnarl/s-taskin.ads", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Flibgnarl%2Fs-taskin.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Flibgnarl%2Fs-taskin.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnarl%2Fs-taskin.ads?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -773,6 +773,9 @@ package System.Tasking is\n    Environment_Task_Level : constant Master_Level := 1;\n    Independent_Task_Level : constant Master_Level := 2;\n    Library_Task_Level     : constant Master_Level := 3;\n+   --  Note that the value of Library_Task_Level is also hard coded in the\n+   --  compiler, see Rtsfind.Library_Task_Level. The two should be kept in\n+   --  sync.\n \n    -------------------\n    -- Priority info --"}, {"sha": "ef17cf253015bc5116bd2301b66904bebb3ff055", "filename": "gcc/ada/rtsfind.ads", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Frtsfind.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Frtsfind.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Frtsfind.ads?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -29,6 +29,7 @@\n --  not been explicitly With'ed.\n \n with Types; use Types;\n+with Uintp; use Uintp;\n \n package Rtsfind is\n \n@@ -1975,11 +1976,6 @@ package Rtsfind is\n      RE_Conditional_Call,                -- System.Tasking\n      RE_Asynchronous_Call,               -- System.Tasking\n \n-     RE_Foreign_Task_Level,              -- System.Tasking\n-     RE_Environment_Task_Level,          -- System.Tasking\n-     RE_Independent_Task_Level,          -- System.Tasking\n-     RE_Library_Task_Level,              -- System.Tasking\n-\n      RE_Ada_Task_Control_Block,          -- System.Tasking\n \n      RE_Task_List,                       -- System.Tasking\n@@ -1996,7 +1992,6 @@ package Rtsfind is\n      RE_Task_Entry_Index,                -- System.Tasking\n      RE_Self,                            -- System.Tasking\n \n-     RE_Master_Id,                       -- System.Tasking\n      RE_Unspecified_Priority,            -- System.Tasking\n \n      RE_Activation_Chain,                -- System.Tasking\n@@ -3665,11 +3660,6 @@ package Rtsfind is\n      RE_Conditional_Call                 => System_Tasking,\n      RE_Asynchronous_Call                => System_Tasking,\n \n-     RE_Foreign_Task_Level               => System_Tasking,\n-     RE_Environment_Task_Level           => System_Tasking,\n-     RE_Independent_Task_Level           => System_Tasking,\n-     RE_Library_Task_Level               => System_Tasking,\n-\n      RE_Ada_Task_Control_Block           => System_Tasking,\n \n      RE_Task_List                        => System_Tasking,\n@@ -3686,7 +3676,6 @@ package Rtsfind is\n      RE_Task_Entry_Index                 => System_Tasking,\n      RE_Self                             => System_Tasking,\n \n-     RE_Master_Id                        => System_Tasking,\n      RE_Unspecified_Priority             => System_Tasking,\n \n      RE_Activation_Chain                 => System_Tasking,\n@@ -3994,6 +3983,9 @@ package Rtsfind is\n       System_Unsigned_Types   => True,\n       others                  => False);\n \n+   Library_Task_Level : constant Uint := Uint_3;\n+   --  Corresponds to System.Tasking.Library_Task_Level\n+\n    -----------------\n    -- Subprograms --\n    -----------------"}, {"sha": "d707b0e15d8a0c71e11db5094e0fda1310ce2ffc", "filename": "gcc/ada/sem_ch6.adb", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fsem_ch6.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a/gcc%2Fada%2Fsem_ch6.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch6.adb?ref=37cd8d97f3aa779197eb103d1e4b4d0ac63adc4a", "patch": "@@ -9042,7 +9042,7 @@ package body Sem_Ch6 is\n             if Needs_BIP_Task_Actuals (E) then\n                Discard :=\n                  Add_Extra_Formal\n-                   (E, RTE (RE_Master_Id),\n+                   (E, Standard_Integer,\n                     E, BIP_Formal_Suffix (BIP_Task_Master));\n \n                Set_Has_Master_Entity (E);"}]}