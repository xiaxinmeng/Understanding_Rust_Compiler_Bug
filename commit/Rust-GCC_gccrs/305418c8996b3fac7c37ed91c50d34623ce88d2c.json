{"sha": "305418c8996b3fac7c37ed91c50d34623ce88d2c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzA1NDE4Yzg5OTZiM2ZhYzdjMzdlZDkxYzUwZDM0NjIzY2U4OGQyYw==", "commit": {"author": {"name": "Laurent GUERBY", "email": "laurent@guerby.net", "date": "2009-08-10T10:52:37Z"}, "committer": {"name": "Laurent Guerby", "email": "guerby@gcc.gnu.org", "date": "2009-08-10T10:52:37Z"}, "message": "make.adb: Handle multilib\n\n2009-08-10  Laurent GUERBY  <laurent@guerby.net>\n\n        * make.adb: Handle multilib\n\nFrom-SVN: r150623", "tree": {"sha": "0de1844527c62b2fb6077c082f6267e04656b102", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0de1844527c62b2fb6077c082f6267e04656b102"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/305418c8996b3fac7c37ed91c50d34623ce88d2c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/305418c8996b3fac7c37ed91c50d34623ce88d2c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/305418c8996b3fac7c37ed91c50d34623ce88d2c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/305418c8996b3fac7c37ed91c50d34623ce88d2c/comments", "author": {"login": "guerby", "id": 6659329, "node_id": "MDQ6VXNlcjY2NTkzMjk=", "avatar_url": "https://avatars.githubusercontent.com/u/6659329?v=4", "gravatar_id": "", "url": "https://api.github.com/users/guerby", "html_url": "https://github.com/guerby", "followers_url": "https://api.github.com/users/guerby/followers", "following_url": "https://api.github.com/users/guerby/following{/other_user}", "gists_url": "https://api.github.com/users/guerby/gists{/gist_id}", "starred_url": "https://api.github.com/users/guerby/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/guerby/subscriptions", "organizations_url": "https://api.github.com/users/guerby/orgs", "repos_url": "https://api.github.com/users/guerby/repos", "events_url": "https://api.github.com/users/guerby/events{/privacy}", "received_events_url": "https://api.github.com/users/guerby/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "94747289e95b397d364d5fe39ee871a5ee8b65ae", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94747289e95b397d364d5fe39ee871a5ee8b65ae", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94747289e95b397d364d5fe39ee871a5ee8b65ae"}], "stats": {"total": 107, "additions": 107, "deletions": 0}, "files": [{"sha": "f345b5d2379a6d01c52dbab93894eba21089edd9", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/305418c8996b3fac7c37ed91c50d34623ce88d2c/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/305418c8996b3fac7c37ed91c50d34623ce88d2c/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=305418c8996b3fac7c37ed91c50d34623ce88d2c", "patch": "@@ -1,3 +1,7 @@\n+2009-08-10  Laurent GUERBY  <laurent@guerby.net>\n+\n+        * make.adb: Handle multilib\n+\t\n 2009-08-10  Vincent Celier  <celier@adacore.com>\n \n \t* prj-env.adb (Create_Config_Pragmas_File.Write_Temp_File): Do not use"}, {"sha": "8b5bb0022f9bcfb756bf303dd14720e743862646", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 103, "deletions": 0, "changes": 103, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/305418c8996b3fac7c37ed91c50d34623ce88d2c/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/305418c8996b3fac7c37ed91c50d34623ce88d2c/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=305418c8996b3fac7c37ed91c50d34623ce88d2c", "patch": "@@ -197,6 +197,9 @@ package body Make is\n    RTS_Specified : String_Access := null;\n    --  Used to detect multiple --RTS= switches\n \n+   N_M_Switch : Natural := 0;\n+   --  Used to count -mxxx switches that can affect multilib\n+\n    type Q_Record is record\n       File  : File_Name_Type;\n       Unit  : Unit_Name_Type;\n@@ -641,6 +644,9 @@ package body Make is\n    --  directory of the ultimate extending project. If it is not, we ignore\n    --  the fact that this ALI file is read-only.\n \n+   procedure Process_Multilib;\n+   --  Add appropriate --RTS argument to handle multilib.\n+\n    ----------------------------------------------------\n    -- Compiler, Binder & Linker Data and Subprograms --\n    ----------------------------------------------------\n@@ -6570,6 +6576,7 @@ package body Make is\n       Dependencies.Init;\n \n       RTS_Specified := null;\n+      N_M_Switch := 0;\n \n       Mains.Delete;\n \n@@ -6629,6 +6636,10 @@ package body Make is\n          Scan_Make_Arg (Argument (Next_Arg), And_Save => True);\n       end loop Scan_Args;\n \n+      if N_M_Switch > 0 and RTS_Specified = null then\n+         Process_Multilib;\n+      end if;\n+\n       if Commands_To_Stdout then\n          Set_Standard_Output;\n       end if;\n@@ -7288,6 +7299,94 @@ package body Make is\n       Set_Name_Table_Byte (N, B or Mark);\n    end Mark_Directory;\n \n+   ----------------------\n+   -- Process_Multilib --\n+   ----------------------\n+\n+   procedure Process_Multilib is\n+\n+      Output_FD         : File_Descriptor;\n+      Output_Name       : String_Access;\n+      Arg_Index         : Natural := 0;\n+      Success           : Boolean := False;\n+      Return_Code       : Integer := 0;\n+      Multilib_Gcc_Path : String_Access;\n+      Multilib_Gcc      : String_Access;\n+      N_Read            : Integer := 0;\n+      Line              : String (1 .. 1000);\n+      Args              : Argument_List (1 .. N_M_Switch + 1);\n+\n+   begin\n+      pragma Assert (N_M_Switch > 0 and RTS_Specified = null);\n+\n+      for Next_Arg in 1 .. Argument_Count loop\n+         declare\n+            Argv : constant String := Argument (Next_Arg);\n+         begin\n+            if Argv'Length > 2\n+              and then Argv (1) = '-'\n+              and then Argv (2) = 'm'\n+              and then Argv /= \"-margs\"\n+            then\n+               Arg_Index := Arg_Index + 1;\n+               Args (Arg_Index) := new String'(Argv);\n+            end if;\n+\n+         end;\n+      end loop;\n+\n+      pragma Assert (Arg_Index = N_M_Switch);\n+\n+      Args (Args'Last) := new String'(\"-print-multi-directory\");\n+\n+      if Saved_Gcc /= null then\n+         Multilib_Gcc := Saved_Gcc;\n+      else\n+         Multilib_Gcc := Gcc;\n+      end if;\n+\n+      Multilib_Gcc_Path :=\n+        GNAT.OS_Lib.Locate_Exec_On_Path (Multilib_Gcc.all);\n+\n+      Create_Temp_File (Output_FD, Output_Name);\n+      if Output_FD = Invalid_FD then\n+         return;\n+      end if;\n+\n+      GNAT.OS_Lib.Spawn (Multilib_Gcc_Path.all, Args, Output_FD,\n+                         Return_Code, False);\n+      Close (Output_FD);\n+      if Return_Code /= 0 then\n+         return;\n+      end if;\n+\n+      Output_FD := Open_Read (Output_Name.all, Binary);\n+      if Output_FD = Invalid_FD then\n+         return;\n+      end if;\n+\n+      N_Read := Read (Output_FD, Line (1)'Address, Line'Length);\n+      Close (Output_FD);\n+      Delete_File (Output_Name.all, Success);\n+\n+      for I in reverse 1 .. N_Read loop\n+         if Line (I) = ASCII.CR or Line (I) = ASCII.LF then\n+            N_Read := N_Read - 1;\n+         else\n+            exit;\n+         end if;\n+      end loop;\n+\n+      if N_Read = 0 or else Line (1 .. N_Read) = \".\" then\n+         return;\n+      end if;\n+\n+      Scan_Make_Arg (\"-margs\", And_Save => True);\n+      Scan_Make_Arg (\"--RTS=\" & Line (1 .. N_Read),\n+                     And_Save => True);\n+\n+   end Process_Multilib;\n+\n    -----------------------------\n    -- Recursive_Compute_Depth --\n    -----------------------------\n@@ -7762,6 +7861,10 @@ package body Make is\n             Add_Switch (Argv, Compiler, And_Save => And_Save);\n             Add_Switch (Argv, Linker, And_Save => And_Save);\n \n+            if Argv (2) = 'm' then\n+               N_M_Switch := N_M_Switch + 1;\n+            end if;\n+\n          --  -C=<mapping file>\n \n          elsif Argv'Last > 2 and then Argv (2) = 'C' then"}]}