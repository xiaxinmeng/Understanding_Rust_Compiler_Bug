{"sha": "102fcf94e625a2016a65829c73a42bd6c2420376", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTAyZmNmOTRlNjI1YTIwMTZhNjU4MjljNzNhNDJiZDZjMjQyMDM3Ng==", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2018-07-31T10:33:21Z"}, "committer": {"name": "Martin Liska", "email": "marxin@gcc.gnu.org", "date": "2018-07-31T10:33:21Z"}, "message": "Fix GCOV CFG related issues.\n\n2018-07-31  Martin Liska  <mliska@suse.cz>\n\n        PR gcov-profile/83813\n        PR gcov-profile/84758\n        PR gcov-profile/85217\n        PR gcov-profile/85332\n\t* profile.c (branch_prob): Do not record GOTO expressions\n        for GIMPLE statements which locations are already streamed.\n2018-07-31  Martin Liska  <mliska@suse.cz>\n\n        PR gcov-profile/83813\n        PR gcov-profile/84758\n        PR gcov-profile/85217\n        PR gcov-profile/85332\n\t* gcc.misc-tests/gcov-pr83813.c: New test.\n\t* gcc.misc-tests/gcov-pr84758.c: New test.\n\t* gcc.misc-tests/gcov-pr85217.c: New test.\n\t* gcc.misc-tests/gcov-pr85332.c: New test.\n\nFrom-SVN: r263111", "tree": {"sha": "adbc04540f28f40a8827907f4f6b9b8e4883323a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/adbc04540f28f40a8827907f4f6b9b8e4883323a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/102fcf94e625a2016a65829c73a42bd6c2420376", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/102fcf94e625a2016a65829c73a42bd6c2420376", "html_url": "https://github.com/Rust-GCC/gccrs/commit/102fcf94e625a2016a65829c73a42bd6c2420376", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/102fcf94e625a2016a65829c73a42bd6c2420376/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5dbc3940fcd15ff477eb556630734017dd2b0cff", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5dbc3940fcd15ff477eb556630734017dd2b0cff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5dbc3940fcd15ff477eb556630734017dd2b0cff"}], "stats": {"total": 146, "additions": 137, "deletions": 9}, "files": [{"sha": "97bc2fd6e5154e351a7c3966f03e2654f1827606", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -1,3 +1,12 @@\n+2018-07-31  Martin Liska  <mliska@suse.cz>\n+\n+        PR gcov-profile/83813\n+        PR gcov-profile/84758\n+        PR gcov-profile/85217\n+        PR gcov-profile/85332\n+\t* profile.c (branch_prob): Do not record GOTO expressions\n+        for GIMPLE statements which locations are already streamed.\n+\n 2018-07-31  Olivier Hainque  <hainque@adacore.com>\n \n \t* gcc.c (handle_spec_function): Accept a soft_matched_part"}, {"sha": "00f37b657a4d988341ff80708921b1c8486ec8bc", "filename": "gcc/profile.c", "status": "modified", "additions": 20, "deletions": 9, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Fprofile.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Fprofile.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fprofile.c?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -1256,33 +1256,44 @@ branch_prob (void)\n       /* Initialize the output.  */\n       output_location (NULL, 0, NULL, NULL);\n \n+      hash_set<int_hash <location_t, 0, 2> > seen_locations;\n+\n       FOR_EACH_BB_FN (bb, cfun)\n \t{\n \t  gimple_stmt_iterator gsi;\n \t  gcov_position_t offset = 0;\n \n \t  if (bb == ENTRY_BLOCK_PTR_FOR_FN (cfun)->next_bb)\n \t    {\n-\t      expanded_location curr_location =\n-\t\texpand_location (DECL_SOURCE_LOCATION (current_function_decl));\n+\t      location_t loc = DECL_SOURCE_LOCATION (current_function_decl);\n+\t      seen_locations.add (loc);\n+\t      expanded_location curr_location = expand_location (loc);\n \t      output_location (curr_location.file, curr_location.line,\n \t\t\t       &offset, bb);\n \t    }\n \n \t  for (gsi = gsi_start_bb (bb); !gsi_end_p (gsi); gsi_next (&gsi))\n \t    {\n \t      gimple *stmt = gsi_stmt (gsi);\n-\t      if (!RESERVED_LOCATION_P (gimple_location (stmt)))\n-\t\toutput_location (gimple_filename (stmt), gimple_lineno (stmt),\n-\t\t\t\t &offset, bb);\n+\t      location_t loc = gimple_location (stmt);\n+\t      if (!RESERVED_LOCATION_P (loc))\n+\t\t{\n+\t\t  seen_locations.add (loc);\n+\t\t  output_location (gimple_filename (stmt), gimple_lineno (stmt),\n+\t\t\t\t   &offset, bb);\n+\t\t}\n \t    }\n \n-\t  /* Notice GOTO expressions eliminated while constructing the CFG.  */\n+\t  /* Notice GOTO expressions eliminated while constructing the CFG.\n+\t     It's hard to distinguish such expression, but goto_locus should\n+\t     not be any of already seen location.  */\n+\t  location_t loc;\n \t  if (single_succ_p (bb)\n-\t      && !RESERVED_LOCATION_P (single_succ_edge (bb)->goto_locus))\n+\t      && (loc = single_succ_edge (bb)->goto_locus)\n+\t      && !RESERVED_LOCATION_P (loc)\n+\t      && !seen_locations.contains (loc))\n \t    {\n-\t      expanded_location curr_location\n-\t\t= expand_location (single_succ_edge (bb)->goto_locus);\n+\t      expanded_location curr_location = expand_location (loc);\n \t      output_location (curr_location.file, curr_location.line,\n \t\t\t       &offset, bb);\n \t    }"}, {"sha": "f726e24f3afb652c47bb817e317159ee401ec415", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -1,3 +1,14 @@\n+2018-07-31  Martin Liska  <mliska@suse.cz>\n+\n+        PR gcov-profile/83813\n+        PR gcov-profile/84758\n+        PR gcov-profile/85217\n+        PR gcov-profile/85332\n+\t* gcc.misc-tests/gcov-pr83813.c: New test.\n+\t* gcc.misc-tests/gcov-pr84758.c: New test.\n+\t* gcc.misc-tests/gcov-pr85217.c: New test.\n+\t* gcc.misc-tests/gcov-pr85332.c: New test.\n+\n 2018-07-31  Ed Schonberg  <schonberg@adacore.com>\n \n \t* gnat.dg/prot5.adb, gnat.dg/prot5_pkg.adb,"}, {"sha": "ac935b969f841e413e38d22b0e0860204b22290d", "filename": "gcc/testsuite/gcc.misc-tests/gcov-pr83813.c", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr83813.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr83813.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr83813.c?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -0,0 +1,23 @@\n+/* { dg-options \"-fprofile-arcs -ftest-coverage\" } */\n+/* { dg-do run { target native } } */\n+\n+union U\n+{\n+    int f0;\n+    unsigned char f1;\n+};\n+\n+int main()\n+{\n+    int i = 0;\n+    union U u = {0};  /* count(1) */\n+    for (u.f1 = 0; u.f1 != -2; ++u.f1) {\n+        i ^= u.f1;  /* count(1) */\n+        if (i < 1)  /* count(1) */\n+            return 0;  /* count(1) */\n+    }\n+\n+    return 1;\n+}\n+\n+/* { dg-final { run-gcov gcov-pr83813.c } } */"}, {"sha": "2ae6900375fa45523db7bd5d35ef3d3e2cb1b936", "filename": "gcc/testsuite/gcc.misc-tests/gcov-pr84758.c", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr84758.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr84758.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr84758.c?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -0,0 +1,28 @@\n+/* { dg-options \"-fprofile-arcs -ftest-coverage\" } */\n+/* { dg-do run { target native } } */\n+\n+int x, y;\n+\n+static void\n+foo (int a, int b)\n+{\n+  {\n+    if (a == 1 || a == 2)  /* count(1) */\n+      {\n+\tx = 4;  /* count(1) */\n+\tif (b == 3)  /* count(1) */\n+\t  x = 6;  /* count(1) */\n+      }\n+    else\n+      x = 15;  /* count(#####) */\n+  }\n+}\n+\n+int\n+main (void)\n+{\n+  foo (2, 3);\n+  return 0;\n+}\n+\n+/* { dg-final { run-gcov gcov-pr84758.c } } */"}, {"sha": "86a3c4b5a129d88f8606df53254520acdd1e30d2", "filename": "gcc/testsuite/gcc.misc-tests/gcov-pr85217.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr85217.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr85217.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr85217.c?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -0,0 +1,20 @@\n+/* { dg-options \"-fprofile-arcs -ftest-coverage\" } */\n+/* { dg-do run { target native } } */\n+\n+int a=0;\n+\n+int main() {\n+  for (;; a++) {\n+    int c[1];\n+    if (a) {\n+      break;\n+      a;\n+      continue; /* count(1) */\n+    }\n+    continue; /* count(1) */\n+  }\n+\n+  return 0;\n+}\n+\n+/* { dg-final { run-gcov gcov-pr85217.c } } */"}, {"sha": "73e50b19fc709d85f6b80b29ae3a5f2b9ef0b835", "filename": "gcc/testsuite/gcc.misc-tests/gcov-pr85332.c", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr85332.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/102fcf94e625a2016a65829c73a42bd6c2420376/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr85332.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.misc-tests%2Fgcov-pr85332.c?ref=102fcf94e625a2016a65829c73a42bd6c2420376", "patch": "@@ -0,0 +1,26 @@\n+/* { dg-options \"-fprofile-arcs -ftest-coverage\" } */\n+/* { dg-do run { target native } } */\n+\n+int doit(int sel, int n, void *p)\n+{\n+  int * const p0 = p;\n+\n+  switch (sel)\n+  {\n+    case 0: /* count(3) */\n+      do {*p0 += *p0;} while (--n); /* count(3) */\n+      return *p0 == 0; /* count(1) */\n+\n+    default:\n+      __builtin_abort ();\n+  }\n+}\n+\n+int main()\n+{\n+  int v0;\n+  v0 = 1; doit(0, 3, &v0);\n+  __builtin_exit (0);\n+}\n+\n+/* { dg-final { run-gcov gcov-pr85332.c } } */"}]}