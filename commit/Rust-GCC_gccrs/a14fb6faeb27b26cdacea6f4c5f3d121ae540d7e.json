{"sha": "a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YTE0ZmI2ZmFlYjI3YjI2Y2RhY2VhNmY0YzVmM2QxMjFhZTU0MGQ3ZQ==", "commit": {"author": {"name": "Francois-Xavier Coudert", "email": "coudert@clipper.ens.fr", "date": "2007-02-04T21:33:10Z"}, "committer": {"name": "Fran\u00e7ois-Xavier Coudert", "email": "fxcoudert@gcc.gnu.org", "date": "2007-02-04T21:33:10Z"}, "message": "re PR fortran/30611 ([4.1 only] Confusing error message for negative ncopies in REPEAT)\n\n\tPR fortran/30611\n\n\t* trans-intrinsic.c (gfc_conv_intrinsic_repeat): Evaluate\n\targuments only once. Generate check that NCOPIES argument is not\n\tnegative.\n\n\t* intrinsics/string_intrinsics.c (string_repeat): Don't check\n\tif ncopies is negative.\n\n\t* gcc/testsuite/gfortran.dg/repeat_1.f90: New test.\n\nFrom-SVN: r121581", "tree": {"sha": "fd54893bee97669ebd4effe1e61628b8994d390c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/fd54893bee97669ebd4effe1e61628b8994d390c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/comments", "author": null, "committer": {"login": "fxcoudert", "id": 1980544, "node_id": "MDQ6VXNlcjE5ODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1980544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fxcoudert", "html_url": "https://github.com/fxcoudert", "followers_url": "https://api.github.com/users/fxcoudert/followers", "following_url": "https://api.github.com/users/fxcoudert/following{/other_user}", "gists_url": "https://api.github.com/users/fxcoudert/gists{/gist_id}", "starred_url": "https://api.github.com/users/fxcoudert/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fxcoudert/subscriptions", "organizations_url": "https://api.github.com/users/fxcoudert/orgs", "repos_url": "https://api.github.com/users/fxcoudert/repos", "events_url": "https://api.github.com/users/fxcoudert/events{/privacy}", "received_events_url": "https://api.github.com/users/fxcoudert/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8135cfa844ab2f7a33fc300eff2917f6fbb51e8c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8135cfa844ab2f7a33fc300eff2917f6fbb51e8c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8135cfa844ab2f7a33fc300eff2917f6fbb51e8c"}], "stats": {"total": 64, "additions": 55, "deletions": 9}, "files": [{"sha": "a78ca2ac127d783f1d80d61ad6487e1c52c321fb", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "patch": "@@ -1,3 +1,10 @@\n+2007-02-04  Francois-Xavier Coudert  <coudert@clipper.ens.fr>\n+\n+\tPR fortran/30611\n+\t* trans-intrinsic.c (gfc_conv_intrinsic_repeat): Evaluate\n+\targuments only once. Generate check that NCOPIES argument is not\n+\tnegative.\n+\n 2007-02-04  Steven G. Kargl <kargl@gcc.gnu.org>\n \n \t* fortran/invoke.texi: Update documentation."}, {"sha": "aa8008bec80cf28667f429bffe675dfeccfdfba9", "filename": "gcc/fortran/trans-intrinsic.c", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ffortran%2Ftrans-intrinsic.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ffortran%2Ftrans-intrinsic.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-intrinsic.c?ref=a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "patch": "@@ -3357,18 +3357,32 @@ gfc_conv_intrinsic_repeat (gfc_se * se, gfc_expr * expr)\n   tree ncopies;\n   tree var;\n   tree type;\n+  tree cond;\n \n   args = gfc_conv_intrinsic_function_args (se, expr);\n   len = TREE_VALUE (args);\n   tmp = gfc_advance_chain (args, 2);\n   ncopies = TREE_VALUE (tmp);\n+\n+  /* Check that ncopies is not negative.  */\n+  ncopies = gfc_evaluate_now (ncopies, &se->pre);\n+  cond = fold_build2 (LT_EXPR, boolean_type_node, ncopies,\n+\t\t      build_int_cst (TREE_TYPE (ncopies), 0));\n+  gfc_trans_runtime_check (cond,\n+\t\t\t   \"Argument NCOPIES of REPEAT intrinsic is negative\",\n+\t\t\t   &se->pre, &expr->where);\n+\n+  /* Compute the destination length.  */\n   len = fold_build2 (MULT_EXPR, gfc_int4_type_node, len, ncopies);\n   type = gfc_get_character_type (expr->ts.kind, expr->ts.cl);\n   var = gfc_conv_string_tmp (se, build_pointer_type (type), len);\n \n+  /* Create the argument list and generate the function call.  */\n   arglist = NULL_TREE;\n   arglist = gfc_chainon_list (arglist, var);\n-  arglist = chainon (arglist, args);\n+  arglist = gfc_chainon_list (arglist, TREE_VALUE (args));\n+  arglist = gfc_chainon_list (arglist, TREE_VALUE (TREE_CHAIN (args)));\n+  arglist = gfc_chainon_list (arglist, ncopies);\n   tmp = build_function_call_expr (gfor_fndecl_string_repeat, arglist);\n   gfc_add_expr_to_block (&se->pre, tmp);\n "}, {"sha": "da8fdb061233295bdc3f273d843b5db25528976c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "patch": "@@ -1,3 +1,8 @@\n+2007-02-04  Francois-Xavier Coudert  <coudert@clipper.ens.fr>\n+\n+\tPR fortran/30611\n+\t* gcc/testsuite/gfortran.dg/repeat_1.f90: New test.\n+\n 2007-02-04  Steven G. Kargl <kargl@gcc.gnu.org>\n \n \t* gfortran.dg/spread_shape_1.f90: Remove tabs."}, {"sha": "7a1d6f9294c5486f3169099e0aa1df75ba550589", "filename": "gcc/testsuite/gfortran.dg/repeat_1.f90", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ftestsuite%2Fgfortran.dg%2Frepeat_1.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/gcc%2Ftestsuite%2Fgfortran.dg%2Frepeat_1.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Frepeat_1.f90?ref=a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "patch": "@@ -0,0 +1,20 @@\n+! { dg-do run }\n+! { dg-shouldfail \"negative NCOPIES argument to REPEAT intrinsic\" }\n+  character(len=80) :: str\n+  integer :: i\n+  i = -1\n+  write(str,\"(a)\") repeat (\"a\", f())\n+  if (trim(str) /= \"aaaa\") call abort\n+  write(str,\"(a)\") repeat (\"a\", i)\n+\n+contains\n+\n+  integer function f()\n+    integer :: x = 5\n+    save x\n+\n+    x = x - 1\n+    f = x\n+  end function f\n+end\n+! { dg-output \"Fortran runtime error: Argument NCOPIES of REPEAT intrinsic is negative .* line 6)\""}, {"sha": "428d49a4d377f5cd91bdde19575f3c1e332c465a", "filename": "libgfortran/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/libgfortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/libgfortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2FChangeLog?ref=a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "patch": "@@ -1,3 +1,9 @@\n+2007-02-04  Francois-Xavier Coudert  <coudert@clipper.ens.fr>\n+\n+\tPR fortran/30611\n+\t* intrinsics/string_intrinsics.c (string_repeat): Don't check\n+\tif ncopies is negative.\n+\n 2007-02-04  Francois-Xavier Coudert  <coudert@clipper.ens.fr>\n \n \tPR libfortran/30007"}, {"sha": "86ef9d42604abe7ff0c887c4940b28556c84258c", "filename": "libgfortran/intrinsics/string_intrinsics.c", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/libgfortran%2Fintrinsics%2Fstring_intrinsics.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e/libgfortran%2Fintrinsics%2Fstring_intrinsics.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgfortran%2Fintrinsics%2Fstring_intrinsics.c?ref=a14fb6faeb27b26cdacea6f4c5f3d121ae540d7e", "patch": "@@ -362,14 +362,8 @@ string_repeat (char * dest, GFC_INTEGER_4 slen,\n {\n   int i;\n \n-  /* See if ncopies is valid.  */\n-  if (ncopies < 0)\n-    {\n-      /* The error is already reported.  */\n-      runtime_error (\"Augument NCOPIES is negative.\");\n-    }\n-\n-  /* Copy characters.  */\n+  /* We don't need to check that ncopies is non-negative here, because\n+     the front-end already generates code for that check.  */\n   for (i = 0; i < ncopies; i++) \n     {\n       memmove (dest + (i * slen), src, slen);"}]}