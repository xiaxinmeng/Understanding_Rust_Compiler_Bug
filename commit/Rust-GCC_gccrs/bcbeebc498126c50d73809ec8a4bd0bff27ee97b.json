{"sha": "bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "node_id": "C_kwDOANBUbNoAKGJjYmVlYmM0OTgxMjZjNTBkNzM4MDllYzhhNGJkMGJmZjI3ZWU5N2I", "commit": {"author": {"name": "Rimvydas Jasinskas", "email": "rimvydas.jas@gmail.com", "date": "2023-02-24T04:41:00Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2023-02-24T21:53:37Z"}, "message": "Fortran: Add support for WEAK attribute for variables\n\nAdd the rest of the weak-*.f90 testcases.\n\ngcc/fortran/ChangeLog:\n\n\t* trans-decl.cc (gfc_finish_var_decl): Apply attribute.\n\t(generate_local_decl): Add diagnostic for dummy and local variables.\n\ngcc/testsuite/ChangeLog:\n\n\t* gfortran.dg/weak-2.f90: New test.\n\t* gfortran.dg/weak-3.f90: New test.\n\nSigned-off-by: Rimvydas Jasinskas <rimvydas.jas@gmail.com>", "tree": {"sha": "5341117b0fd4bf284f35f22481e7532dc57aaa56", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5341117b0fd4bf284f35f22481e7532dc57aaa56"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/comments", "author": null, "committer": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24c9edfa73632276d7698c103f35833f29804d98", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/24c9edfa73632276d7698c103f35833f29804d98", "html_url": "https://github.com/Rust-GCC/gccrs/commit/24c9edfa73632276d7698c103f35833f29804d98"}], "stats": {"total": 70, "additions": 70, "deletions": 0}, "files": [{"sha": "474920966ec0b6c02eb3bfd99fdceb21c352c1b3", "filename": "gcc/fortran/trans-decl.cc", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/gcc%2Ffortran%2Ftrans-decl.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/gcc%2Ffortran%2Ftrans-decl.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.cc?ref=bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "patch": "@@ -814,6 +814,10 @@ gfc_finish_var_decl (tree decl, gfc_symbol * sym)\n       && (TREE_STATIC (decl) || DECL_EXTERNAL (decl)))\n     set_decl_tls_model (decl, decl_default_tls_model (decl));\n \n+  /* Mark weak variables.  */\n+  if (sym->attr.ext_attr & (1 << EXT_ATTR_WEAK))\n+    declare_weak (decl);\n+\n   gfc_finish_decl_attrs (decl, &sym->attr);\n }\n \n@@ -5885,6 +5889,16 @@ generate_local_decl (gfc_symbol * sym)\n       if (!sym->attr.dummy && !sym->ns->proc_name->attr.entry_master)\n \tgenerate_dependency_declarations (sym);\n \n+      if (sym->attr.ext_attr & (1 << EXT_ATTR_WEAK))\n+\t{\n+\t  if (sym->attr.dummy)\n+\t    gfc_error (\"Symbol %qs at %L has the WEAK attribute but is a \"\n+\t\t       \"dummy argument\", sym->name, &sym->declared_at);\n+\t  else\n+\t    gfc_error (\"Symbol %qs at %L has the WEAK attribute but is a \"\n+\t\t       \"local variable\", sym->name, &sym->declared_at);\n+\t}\n+\n       if (sym->attr.referenced)\n \tgfc_get_symbol_decl (sym);\n "}, {"sha": "3e0e877e90317189c75d9da3c9f2adb7cae54732", "filename": "gcc/testsuite/gfortran.dg/weak-2.f90", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/gcc%2Ftestsuite%2Fgfortran.dg%2Fweak-2.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/gcc%2Ftestsuite%2Fgfortran.dg%2Fweak-2.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fweak-2.f90?ref=bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "patch": "@@ -0,0 +1,26 @@\n+! { dg-do compile }\n+! { dg-require-weak \"\" }\n+! { dg-skip-if \"\" { x86_64-*-mingw* } }\n+! { dg-skip-if \"\" { nvptx-*-* } }\n+\n+! 1.\n+! { dg-final { scan-assembler \"weak\\[^ \\t\\]*\\[ \\t\\]_?__foo_MOD_abc\" } }\n+module foo\n+implicit none\n+!GCC$ ATTRIBUTES weak :: abc\n+real :: abc(7)\n+end module\n+\n+! 2.\n+! { dg-final { scan-assembler \"weak\\[^ \\t\\]*\\[ \\t\\]_?impl1\" } }\n+integer function impl1()\n+implicit none\n+!GCC$ ATTRIBUTES weak :: impl1\n+end function\n+\n+! 3.\n+! { dg-final { scan-assembler \"weak\\[^ \\t\\]*\\[ \\t\\]_?bar__\" } }\n+integer function impl2() bind(c,name='bar__')\n+implicit none\n+!GCC$ ATTRIBUTES weak :: impl2\n+end function"}, {"sha": "cfa845921ffe3be1c3e1db616f150b5fa3d28730", "filename": "gcc/testsuite/gfortran.dg/weak-3.f90", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/gcc%2Ftestsuite%2Fgfortran.dg%2Fweak-3.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/bcbeebc498126c50d73809ec8a4bd0bff27ee97b/gcc%2Ftestsuite%2Fgfortran.dg%2Fweak-3.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fweak-3.f90?ref=bcbeebc498126c50d73809ec8a4bd0bff27ee97b", "patch": "@@ -0,0 +1,30 @@\n+! { dg-do compile }\n+! { dg-require-weak \"\" }\n+\n+! 1.\n+program foo1  ! { dg-error \"weak declaration of 'foo1' must be public\" \"\" }\n+implicit none\n+!GCC$ ATTRIBUTES weak :: foo1\n+end program\n+\n+! 2.\n+subroutine foo2\n+implicit none\n+contains\n+ function dar() ! { dg-error \"weak declaration of 'dar' must be public\" \"\" }\n+ integer :: dar\n+!GCC$ ATTRIBUTES weak :: dar\n+ end function\n+ subroutine bar ! { dg-error \"weak declaration of 'bar' must be public\" \"\" }\n+!GCC$ ATTRIBUTES weak :: bar\n+ end subroutine\n+end subroutine\n+\n+! 3.\n+subroutine foo3(n) ! { dg-error \"has the WEAK attribute but is a dummy argument\" \"\" }\n+implicit none\n+integer :: n\n+!GCC$ ATTRIBUTES weak :: n\n+real :: abc       ! { dg-error \"has the WEAK attribute but is a local variable\" \"\" }\n+!GCC$ ATTRIBUTES weak :: abc\n+end subroutine"}]}