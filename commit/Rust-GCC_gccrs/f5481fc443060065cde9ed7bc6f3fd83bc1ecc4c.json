{"sha": "f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjU0ODFmYzQ0MzA2MDA2NWNkZTllZDdiYzZmM2ZkODNiYzFlY2M0Yw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2015-01-08T21:27:22Z"}, "committer": {"name": "Jason Merrill", "email": "jason@gcc.gnu.org", "date": "2015-01-08T21:27:22Z"}, "message": "ubsan.c (do_ubsan_in_current_function): New.\n\ngcc/\n\t* ubsan.c (do_ubsan_in_current_function): New.\n\t(pass_ubsan::gate): Use it.\n\t* ubsan.h: Declare it.\n\t* convert.c (convert_to_integer): Use it.\ngcc/c-family/\n\t* c-ubsan.c (ubsan_maybe_instrument_array_ref): Use\n\tdo_ubsan_in_current_function.\n\t(ubsan_maybe_instrument_reference_or_call): Likewise.\n\t* c-ubsan.h: Declare it.\ngcc/cp/\n\t* cp-gimplify.c (cp_genericize): Use do_ubsan_in_current_function.\n\t* decl.c (compute_array_index_type): Likewise.\n\t* init.c (build_vec_init): Likewise.\n\t* typeck.c (cp_build_binary_op): Likewise.\n\nFrom-SVN: r219360", "tree": {"sha": "cbafc576a2a3a432c0727f066088eb9aa5369156", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cbafc576a2a3a432c0727f066088eb9aa5369156"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "46621807e9bf7bc94302cda27852e33a3c766112", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/46621807e9bf7bc94302cda27852e33a3c766112", "html_url": "https://github.com/Rust-GCC/gccrs/commit/46621807e9bf7bc94302cda27852e33a3c766112"}], "stats": {"total": 69, "additions": 43, "deletions": 26}, "files": [{"sha": "f3db7fdfb3c79f9d0c6935933475582c052620f2", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -1,3 +1,10 @@\n+2015-01-08  Jason Merrill  <jason@redhat.com>\n+\n+\t* ubsan.c (do_ubsan_in_current_function): New.\n+\t(pass_ubsan::gate): Use it.\n+\t* ubsan.h: Declare it.\n+\t* convert.c (convert_to_integer): Use it.\n+\n 2015-01-08  Jakub Jelinek  <jakub@redhat.com>\n \n \tPR target/64338"}, {"sha": "acbe684ada14c20c5b7bab4ad0047d6b0d5c334a", "filename": "gcc/c-family/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fc-family%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fc-family%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2FChangeLog?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -1,3 +1,10 @@\n+2015-01-08  Jason Merrill  <jason@redhat.com>\n+\n+\t* c-ubsan.c (ubsan_maybe_instrument_array_ref): Use\n+\tdo_ubsan_in_current_function.\n+\t(ubsan_maybe_instrument_reference_or_call): Likewise.\n+\t* c-ubsan.h: Declare it.\n+\n 2015-01-08  Mike Stump  <mikestump@comcast.net>\n \n \t* c-common.c (c_common_attribute_table): Add no_sanitize_thread."}, {"sha": "c195c7ff763bed43beb26037d96c23cf390f7639", "filename": "gcc/c-family/c-ubsan.c", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fc-family%2Fc-ubsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fc-family%2Fc-ubsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-ubsan.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -364,9 +364,7 @@ void\n ubsan_maybe_instrument_array_ref (tree *expr_p, bool ignore_off_by_one)\n {\n   if (!ubsan_array_ref_instrumented_p (*expr_p)\n-      && current_function_decl != NULL_TREE\n-      && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t    DECL_ATTRIBUTES (current_function_decl)))\n+      && do_ubsan_in_current_function ())\n     {\n       tree op0 = TREE_OPERAND (*expr_p, 0);\n       tree op1 = TREE_OPERAND (*expr_p, 1);\n@@ -386,9 +384,7 @@ static tree\n ubsan_maybe_instrument_reference_or_call (location_t loc, tree op, tree ptype,\n \t\t\t\t\t  enum ubsan_null_ckind ckind)\n {\n-  if (current_function_decl == NULL_TREE\n-      || lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t   DECL_ATTRIBUTES (current_function_decl)))\n+  if (!do_ubsan_in_current_function ())\n     return NULL_TREE;\n \n   tree type = TREE_TYPE (ptype);"}, {"sha": "fb379c83c1564ef31cb44d327a17fdff470905c3", "filename": "gcc/c-family/c-ubsan.h", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fc-family%2Fc-ubsan.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fc-family%2Fc-ubsan.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fc-family%2Fc-ubsan.h?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -31,4 +31,7 @@ extern void ubsan_maybe_instrument_array_ref (tree *, bool);\n extern void ubsan_maybe_instrument_reference (tree);\n extern void ubsan_maybe_instrument_member_call (tree, bool);\n \n+/* Declare this here as well as in ubsan.h. */\n+extern bool do_ubsan_in_current_function (void);\n+\n #endif  /* GCC_C_UBSAN_H  */"}, {"sha": "fc1b93c225b62e297db77cfd19633f69fa97581d", "filename": "gcc/convert.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fconvert.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fconvert.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconvert.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -885,9 +885,7 @@ convert_to_integer (tree type, tree expr)\n \n     case REAL_TYPE:\n       if (flag_sanitize & SANITIZE_FLOAT_CAST\n-\t  && current_function_decl != NULL_TREE\n-\t  && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t\tDECL_ATTRIBUTES (current_function_decl)))\n+\t  && do_ubsan_in_current_function ())\n \t{\n \t  expr = save_expr (expr);\n \t  tree check = ubsan_instrument_float_cast (loc, type, expr, expr);"}, {"sha": "8afaafa6b840b3b674d3d2e7528c18229fdaff76", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -1,3 +1,10 @@\n+2015-01-08  Jason Merrill  <jason@redhat.com>\n+\n+\t* cp-gimplify.c (cp_genericize): Use do_ubsan_in_current_function.\n+\t* decl.c (compute_array_index_type): Likewise.\n+\t* init.c (build_vec_init): Likewise.\n+\t* typeck.c (cp_build_binary_op): Likewise.\n+\n 2015-01-08  Jason Merrill  <jason@redhat.com>\n \n \t* init.c (build_vec_init): Call ubsan_instrument_bounds to check"}, {"sha": "33dce296433d8f5eaac6c3ec471dcef53956a307", "filename": "gcc/cp/cp-gimplify.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Fcp-gimplify.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Fcp-gimplify.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcp-gimplify.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -1350,9 +1350,7 @@ cp_genericize (tree fndecl)\n   cp_genericize_tree (&DECL_SAVED_TREE (fndecl));\n \n   if (flag_sanitize & SANITIZE_RETURN\n-      && current_function_decl != NULL_TREE\n-      && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t    DECL_ATTRIBUTES (current_function_decl)))\n+      && do_ubsan_in_current_function ())\n     cp_ubsan_maybe_instrument_return (fndecl);\n \n   /* Do everything else.  */"}, {"sha": "dd000c39cb11582c8c4e6d4f8666469c93be7c90", "filename": "gcc/cp/decl.c", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Fdecl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Fdecl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fdecl.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -8595,10 +8595,7 @@ compute_array_index_type (tree name, tree size, tsubst_flags_t complain)\n \t  stabilize_vla_size (itype);\n \n \t  if (flag_sanitize & SANITIZE_VLA\n-\t      && current_function_decl != NULL_TREE\n-\t      && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t\t    DECL_ATTRIBUTES\n-\t\t\t\t    (current_function_decl)))\n+\t      && do_ubsan_in_current_function ())\n \t    {\n \t      /* We have to add 1 -- in the ubsan routine we generate\n \t\t LE_EXPR rather than LT_EXPR.  */"}, {"sha": "3bd470b986a1bcf8451d51cb62cce866b6fd5146", "filename": "gcc/cp/init.c", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -3575,10 +3575,7 @@ build_vec_init (tree base, tree maxindex, tree init,\n \t      /* Don't check an array new when -fno-exceptions.  */\n \t    }\n \t  else if (flag_sanitize & SANITIZE_BOUNDS\n-\t\t   && current_function_decl\n-\t\t   && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t\t\t DECL_ATTRIBUTES\n-\t\t\t\t\t (current_function_decl)))\n+\t\t   && do_ubsan_in_current_function ())\n \t    {\n \t      /* Make sure the last element of the initializer is in bounds. */\n \t      finish_expr_stmt"}, {"sha": "fb0ffd1438d151c5cdffe3a700298d197bb93165", "filename": "gcc/cp/typeck.c", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Ftypeck.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fcp%2Ftypeck.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Ftypeck.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -4973,9 +4973,7 @@ cp_build_binary_op (location_t location,\n   if ((flag_sanitize & (SANITIZE_SHIFT | SANITIZE_DIVIDE\n \t\t\t| SANITIZE_FLOAT_DIVIDE))\n       && !processing_template_decl\n-      && current_function_decl != 0\n-      && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t    DECL_ATTRIBUTES (current_function_decl))\n+      && do_ubsan_in_current_function ()\n       && (doing_div_or_mod || doing_shift))\n     {\n       /* OP0 and/or OP1 might have side-effects.  */"}, {"sha": "7dae9670338d5577d996d9c9e99b933ad42b9185", "filename": "gcc/ubsan.c", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fubsan.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fubsan.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fubsan.c?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -1648,6 +1648,16 @@ instrument_object_size (gimple_stmt_iterator *gsi, bool is_lhs)\n   gsi_insert_before (gsi, g, GSI_SAME_STMT);\n }\n \n+/* True if we want to play UBSan games in the current function.  */\n+\n+bool\n+do_ubsan_in_current_function ()\n+{\n+  return (current_function_decl != NULL_TREE\n+\t  && !lookup_attribute (\"no_sanitize_undefined\",\n+\t\t\t\tDECL_ATTRIBUTES (current_function_decl)));\n+}\n+\n namespace {\n \n const pass_data pass_data_ubsan =\n@@ -1679,9 +1689,7 @@ class pass_ubsan : public gimple_opt_pass\n \t\t\t      | SANITIZE_NONNULL_ATTRIBUTE\n \t\t\t      | SANITIZE_RETURNS_NONNULL_ATTRIBUTE\n \t\t\t      | SANITIZE_OBJECT_SIZE)\n-\t     && current_function_decl != NULL_TREE\n-\t     && !lookup_attribute (\"no_sanitize_undefined\",\n-\t\t\t\t   DECL_ATTRIBUTES (current_function_decl));\n+\t&& do_ubsan_in_current_function ();\n     }\n \n   virtual unsigned int execute (function *);"}, {"sha": "9b8a59b6c84d84096113afb5a260ed50b8a8fd24", "filename": "gcc/ubsan.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fubsan.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c/gcc%2Fubsan.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fubsan.h?ref=f5481fc443060065cde9ed7bc6f3fd83bc1ecc4c", "patch": "@@ -38,6 +38,7 @@ enum ubsan_print_style {\n   UBSAN_PRINT_ARRAY\n };\n \n+extern bool do_ubsan_in_current_function (void);\n extern bool ubsan_expand_bounds_ifn (gimple_stmt_iterator *);\n extern bool ubsan_expand_null_ifn (gimple_stmt_iterator *);\n extern bool ubsan_expand_objsize_ifn (gimple_stmt_iterator *);"}]}