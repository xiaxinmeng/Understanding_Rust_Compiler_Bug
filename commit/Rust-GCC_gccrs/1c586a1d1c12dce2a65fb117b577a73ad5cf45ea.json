{"sha": "1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "node_id": "C_kwDOANBUbNoAKDFjNTg2YTFkMWMxMmRjZTJhNjVmYjExN2I1NzdhNzNhZDVjZjQ1ZWE", "commit": {"author": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2022-10-26T13:57:54Z"}, "committer": {"name": "Arthur Cohen", "email": "arthur.cohen@embecosm.com", "date": "2023-02-21T11:36:42Z"}, "message": "gccrs: intrinsics: Add unchecked operation intrinsics\n\ngcc/rust/ChangeLog:\n\n\t* backend/rust-compile-intrinsic.cc (is_basic_integer_type): New function.\n\t(unchecked_op_inner): New handler.\n\t(unchecked_op_handler): New handler.\n\ngcc/testsuite/ChangeLog:\n\n\t* rust/compile/torture/intrinsics-6.rs: New test.\n\t* rust/compile/torture/intrinsics-7.rs: New test.", "tree": {"sha": "e17a7e330a6e97e19f5506bcb54128f31be3306d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e17a7e330a6e97e19f5506bcb54128f31be3306d"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/comments", "author": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CohenArthur", "id": 43524065, "node_id": "MDQ6VXNlcjQzNTI0MDY1", "avatar_url": "https://avatars.githubusercontent.com/u/43524065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CohenArthur", "html_url": "https://github.com/CohenArthur", "followers_url": "https://api.github.com/users/CohenArthur/followers", "following_url": "https://api.github.com/users/CohenArthur/following{/other_user}", "gists_url": "https://api.github.com/users/CohenArthur/gists{/gist_id}", "starred_url": "https://api.github.com/users/CohenArthur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CohenArthur/subscriptions", "organizations_url": "https://api.github.com/users/CohenArthur/orgs", "repos_url": "https://api.github.com/users/CohenArthur/repos", "events_url": "https://api.github.com/users/CohenArthur/events{/privacy}", "received_events_url": "https://api.github.com/users/CohenArthur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7c8f7ee34334edec4b57db547de1c8b5d0ad31d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a7c8f7ee34334edec4b57db547de1c8b5d0ad31d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a7c8f7ee34334edec4b57db547de1c8b5d0ad31d"}], "stats": {"total": 111, "additions": 111, "deletions": 0}, "files": [{"sha": "46ea5b3f7959bc27d4489288005cd96d9a8df6b4", "filename": "gcc/rust/backend/rust-compile-intrinsic.cc", "status": "modified", "additions": 80, "deletions": 0, "changes": 80, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/gcc%2Frust%2Fbackend%2Frust-compile-intrinsic.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/gcc%2Frust%2Fbackend%2Frust-compile-intrinsic.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fbackend%2Frust-compile-intrinsic.cc?ref=1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "patch": "@@ -34,6 +34,22 @@\n namespace Rust {\n namespace Compile {\n \n+static bool\n+is_basic_integer_type (TyTy::BaseType *type)\n+{\n+  switch (type->get_kind ())\n+    {\n+    case TyTy::INT:\n+    case TyTy::UINT:\n+    case TyTy::USIZE:\n+    case TyTy::ISIZE:\n+      return true;\n+    default:\n+      return false;\n+      break;\n+    }\n+}\n+\n static tree\n offset_handler (Context *ctx, TyTy::FnType *fntype);\n static tree\n@@ -104,6 +120,17 @@ atomic_store_handler (int ordering)\n   };\n }\n \n+static inline tree\n+unchecked_op_inner (Context *ctx, TyTy::FnType *fntype, tree_code op);\n+\n+const static std::function<tree (Context *, TyTy::FnType *)>\n+unchecked_op_handler (tree_code op)\n+{\n+  return [op] (Context *ctx, TyTy::FnType *fntype) {\n+    return unchecked_op_inner (ctx, fntype, op);\n+  };\n+}\n+\n static inline tree\n sorry_handler (Context *ctx, TyTy::FnType *fntype)\n {\n@@ -132,6 +159,13 @@ static const std::map<std::string,\n     {\"atomic_store_release\", atomic_store_handler (__ATOMIC_RELEASE)},\n     {\"atomic_store_relaxed\", atomic_store_handler (__ATOMIC_RELAXED)},\n     {\"atomic_store_unordered\", atomic_store_handler (__ATOMIC_RELAXED)},\n+    {\"unchecked_add\", unchecked_op_handler (PLUS_EXPR)},\n+    {\"unchecked_sub\", unchecked_op_handler (MINUS_EXPR)},\n+    {\"unchecked_mul\", unchecked_op_handler (MULT_EXPR)},\n+    {\"unchecked_div\", unchecked_op_handler (TRUNC_DIV_EXPR)},\n+    {\"unchecked_rem\", unchecked_op_handler (TRUNC_MOD_EXPR)},\n+    {\"unchecked_shl\", unchecked_op_handler (LSHIFT_EXPR)},\n+    {\"unchecked_shr\", unchecked_op_handler (RSHIFT_EXPR)},\n };\n \n Intrinsics::Intrinsics (Context *ctx) : ctx (ctx) {}\n@@ -721,6 +755,52 @@ atomic_store_handler_inner (Context *ctx, TyTy::FnType *fntype, int ordering)\n   TREE_SIDE_EFFECTS (store_call) = 1;\n \n   ctx->add_statement (store_call);\n+  finalize_intrinsic_block (ctx, fndecl);\n+\n+  return fndecl;\n+}\n+\n+static inline tree\n+unchecked_op_inner (Context *ctx, TyTy::FnType *fntype, tree_code op)\n+{\n+  rust_assert (fntype->get_params ().size () == 2);\n+  rust_assert (fntype->get_num_substitutions () == 1);\n+\n+  tree lookup = NULL_TREE;\n+  if (check_for_cached_intrinsic (ctx, fntype, &lookup))\n+    return lookup;\n+\n+  auto fndecl = compile_intrinsic_function (ctx, fntype);\n+\n+  // setup the params\n+  std::vector<Bvariable *> param_vars;\n+  compile_fn_params (ctx, fntype, fndecl, &param_vars);\n+\n+  if (!ctx->get_backend ()->function_set_parameters (fndecl, param_vars))\n+    return error_mark_node;\n+\n+  enter_intrinsic_block (ctx, fndecl);\n+\n+  // BUILTIN unchecked_<op> BODY BEGIN\n+\n+  auto x = ctx->get_backend ()->var_expression (param_vars[0], Location ());\n+  auto y = ctx->get_backend ()->var_expression (param_vars[1], Location ());\n+\n+  auto *monomorphized_type\n+    = fntype->get_substs ().at (0).get_param_ty ()->resolve ();\n+  if (!is_basic_integer_type (monomorphized_type))\n+    rust_error_at (fntype->get_locus (),\n+\t\t   \"unchecked operation intrinsics can only be used with \"\n+\t\t   \"basic integer types (got %qs)\",\n+\t\t   monomorphized_type->get_name ().c_str ());\n+\n+  auto expr = build2 (op, TREE_TYPE (x), x, y);\n+  auto return_statement\n+    = ctx->get_backend ()->return_statement (fndecl, {expr}, Location ());\n+\n+  ctx->add_statement (return_statement);\n+\n+  // BUILTIN unchecked_<op> BODY END\n \n   finalize_intrinsic_block (ctx, fndecl);\n "}, {"sha": "143b62a2b27e2ffe42e3bdb58c660edd3c2cf46b", "filename": "gcc/testsuite/rust/compile/torture/intrinsics-6.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fintrinsics-6.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fintrinsics-6.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fintrinsics-6.rs?ref=1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "patch": "@@ -0,0 +1,21 @@\n+extern \"rust-intrinsic\" {\n+    pub fn unchecked_add<T>(x: T, y: T) -> T;\n+    pub fn unchecked_sub<T>(x: T, y: T) -> T;\n+    pub fn unchecked_mul<T>(x: T, y: T) -> T;\n+    pub fn unchecked_div<T>(x: T, y: T) -> T;\n+    pub fn unchecked_rem<T>(x: T, y: T) -> T;\n+    pub fn unchecked_shl<T>(x: T, y: T) -> T;\n+    pub fn unchecked_shr<T>(x: T, y: T) -> T;\n+}\n+\n+fn main() -> i32 {\n+    let zero0 = unsafe { (1 + 5) - unchecked_add(1, 5) };\n+    let zero1 = unsafe { (1 - 5) - unchecked_sub(1, 5) };\n+    let zero2 = unsafe { (1 * 5) - unchecked_mul(1, 5) };\n+    let zero3 = unsafe { (1 / 5) - unchecked_div(1, 5) };\n+    let zero4 = unsafe { (1 % 5) - unchecked_rem(1, 5) };\n+    let zero5 = unsafe { (1 << 5) - unchecked_shl(1, 5) };\n+    let zero6 = unsafe { (1 >> 5) - unchecked_shr(1, 5) };\n+\n+    zero0 + zero1 + zero2 + zero3 + zero4 + zero5 + zero6\n+}"}, {"sha": "8e8c5fe0cdf8da76b157352964ecfa16fbb745b3", "filename": "gcc/testsuite/rust/compile/torture/intrinsics-7.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fintrinsics-7.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1c586a1d1c12dce2a65fb117b577a73ad5cf45ea/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fintrinsics-7.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fintrinsics-7.rs?ref=1c586a1d1c12dce2a65fb117b577a73ad5cf45ea", "patch": "@@ -0,0 +1,10 @@\n+extern \"rust-intrinsic\" {\n+    pub fn unchecked_add<T>(x: T, y: T) -> T;\n+    // { dg-error \"unchecked operation intrinsics can only be used with basic integer types .got .NotAdd..\" \"\" { target *-*-* } .-1 }\n+}\n+\n+fn main() {\n+    struct NotAdd;\n+\n+    unsafe { unchecked_add(NotAdd, NotAdd) };\n+}"}]}