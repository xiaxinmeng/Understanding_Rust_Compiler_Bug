{"sha": "b457b779427b0f7b3fbac447811c9c52db5bc79e", "node_id": "C_kwDOANBUbNoAKGI0NTdiNzc5NDI3YjBmN2IzZmJhYzQ0NzgxMWM5YzUyZGI1YmM3OWU", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-11-07T23:35:09Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2022-11-07T23:35:09Z"}, "message": "libstdc++: Fix up libstdc++ build against glibc 2.25 or older [PR107562]\n\nOn Mon, Nov 07, 2022 at 05:48:42PM +0000, Jonathan Wakely wrote:\n> On Mon, 7 Nov 2022 at 16:11, Joseph Myers <joseph@codesourcery.com> wrote:\n> >\n> > On Wed, 2 Nov 2022, Jakub Jelinek via Gcc-patches wrote:\n> >\n> > > APIs.  So that one can build gcc against older glibc and then compile\n> > > user programs on newer glibc, the patch uses weak references unless\n> > > gcc is compiled against glibc 2.26+.  strfromf128 unfortunately can't\n> >\n> > This support for older glibc doesn't actually seem to be working, on an\n> > older system with glibc 2.19 I'm seeing\n> >\n> > /scratch/jmyers/fsf/gcc-mainline/libstdc++-v3/src/c++17/floating_to_chars.cc:52:3: error: expected initializer before '__asm'\n> >    52 |   __asm (\"strfromf128\");\n> >       |   ^~~~~\n> >\n> > and a series of subsequent errors.\n>\n> This seems to \"fix\" it (not sure if it's right though):\n>\n> #ifndef _GLIBCXX_HAVE_FLOAT128_MATH\n> extern \"C\" _Float128 __strtof128(const char*, char**)\n>  __attribute__((__weak__));\n> #endif\n> extern \"C\" _Float128 __strtof128(const char*, char**)\n>  __asm (\"strtof128\");\n\nIt is, but floating_from_chars.cc has the same problem,\nand I think we can avoid the duplication, like this:\n\n2022-11-08  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR libstdc++/107562\n\t* src/c++17/floating_from_chars.cc (__strtof128): Put __asm before\n\t__attribute__.\n\t* src/c++17/floating_to_chars.cc (__strfromf128): Likewise.", "tree": {"sha": "368fc5b5330363ee3f170a021f34fd349027ccce", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/368fc5b5330363ee3f170a021f34fd349027ccce"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b457b779427b0f7b3fbac447811c9c52db5bc79e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b457b779427b0f7b3fbac447811c9c52db5bc79e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b457b779427b0f7b3fbac447811c9c52db5bc79e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b457b779427b0f7b3fbac447811c9c52db5bc79e/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "93ab7d03dfbdd096c1d3c83e92d794bf4eed18df", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/93ab7d03dfbdd096c1d3c83e92d794bf4eed18df", "html_url": "https://github.com/Rust-GCC/gccrs/commit/93ab7d03dfbdd096c1d3c83e92d794bf4eed18df"}], "stats": {"total": 6, "additions": 4, "deletions": 2}, "files": [{"sha": "29eb4634e9d181f3ee2e5acc2712bda79af93f5c", "filename": "libstdc++-v3/src/c++17/floating_from_chars.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b457b779427b0f7b3fbac447811c9c52db5bc79e/libstdc%2B%2B-v3%2Fsrc%2Fc%2B%2B17%2Ffloating_from_chars.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b457b779427b0f7b3fbac447811c9c52db5bc79e/libstdc%2B%2B-v3%2Fsrc%2Fc%2B%2B17%2Ffloating_from_chars.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Fc%2B%2B17%2Ffloating_from_chars.cc?ref=b457b779427b0f7b3fbac447811c9c52db5bc79e", "patch": "@@ -63,10 +63,11 @@ extern \"C\" __ieee128 __strtoieee128(const char*, char**);\n       && defined(__GLIBC_PREREQ)\n #define USE_STRTOF128_FOR_FROM_CHARS 1\n extern \"C\" _Float128 __strtof128(const char*, char**)\n+  __asm (\"strtof128\")\n #ifndef _GLIBCXX_HAVE_FLOAT128_MATH\n   __attribute__((__weak__))\n #endif\n-  __asm (\"strtof128\");\n+  ;\n #endif\n \n #if _GLIBCXX_FLOAT_IS_IEEE_BINARY32 && _GLIBCXX_DOUBLE_IS_IEEE_BINARY64 \\"}, {"sha": "afce8d74c1299f3b8aa34df3c160feb8b5e801ac", "filename": "libstdc++-v3/src/c++17/floating_to_chars.cc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b457b779427b0f7b3fbac447811c9c52db5bc79e/libstdc%2B%2B-v3%2Fsrc%2Fc%2B%2B17%2Ffloating_to_chars.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b457b779427b0f7b3fbac447811c9c52db5bc79e/libstdc%2B%2B-v3%2Fsrc%2Fc%2B%2B17%2Ffloating_to_chars.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Fc%2B%2B17%2Ffloating_to_chars.cc?ref=b457b779427b0f7b3fbac447811c9c52db5bc79e", "patch": "@@ -46,10 +46,11 @@ extern \"C\" int __sprintfieee128(char*, const char*, ...);\n #elif __FLT128_MANT_DIG__ == 113 && __LDBL_MANT_DIG__ != 113 \\\n       && defined(__GLIBC_PREREQ)\n extern \"C\" int __strfromf128(char*, size_t, const char*, _Float128)\n+  __asm (\"strfromf128\")\n #ifndef _GLIBCXX_HAVE_FLOAT128_MATH\n   __attribute__((__weak__))\n #endif\n-  __asm (\"strfromf128\");\n+  ;\n #endif\n \n // This implementation crucially assumes float/double have the"}]}