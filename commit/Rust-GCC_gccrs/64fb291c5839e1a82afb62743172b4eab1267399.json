{"sha": "64fb291c5839e1a82afb62743172b4eab1267399", "node_id": "C_kwDOANBUbNoAKDY0ZmIyOTFjNTgzOWUxYTgyYWZiNjI3NDMxNzJiNGVhYjEyNjczOTk", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2022-11-22T22:29:21Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2022-11-22T22:29:21Z"}, "message": "analyzer: fix ICE on 'bind(INT_CST, ...)' [PR107783]\n\nThis was crashing inside fd_phase_mismatch's ctor with assertion\nfailure when the state was \"fd-constant\".\n\nFix the ICE by not complaining about constants passed to these APIs.\n\ngcc/analyzer/ChangeLog:\n\tPR analyzer/107783\n\t* sm-fd.cc (fd_state_machine::check_for_new_socket_fd): Don't\n\tcomplain when old state is \"fd-constant\".\n\t(fd_state_machine::on_listen): Likewise.\n\t(fd_state_machine::on_accept): Likewise.\n\ngcc/testsuite/ChangeLog:\n\tPR analyzer/107783\n\t* gcc.dg/analyzer/fd-accept.c (test_accept_on_constant): New.\n\t* gcc.dg/analyzer/fd-bind.c (test_bind_on_constant): New.\n\t* gcc.dg/analyzer/fd-connect.c (test_connect_on_constant): New.\n\t* gcc.dg/analyzer/fd-listen.c (test_listen_on_connected_socket):\n\tFix typo.\n\t(test_listen_on_constant): New.\n\nSigned-off-by: David Malcolm <dmalcolm@redhat.com>", "tree": {"sha": "4c9163bc9a0fc24d6a0278fe1434ec998dae57b7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4c9163bc9a0fc24d6a0278fe1434ec998dae57b7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/64fb291c5839e1a82afb62743172b4eab1267399", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/64fb291c5839e1a82afb62743172b4eab1267399", "html_url": "https://github.com/Rust-GCC/gccrs/commit/64fb291c5839e1a82afb62743172b4eab1267399", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/64fb291c5839e1a82afb62743172b4eab1267399/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7c9717fcb5cf94ce1e7ef5c903058adf9980ff28", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7c9717fcb5cf94ce1e7ef5c903058adf9980ff28", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7c9717fcb5cf94ce1e7ef5c903058adf9980ff28"}], "stats": {"total": 31, "additions": 27, "deletions": 4}, "files": [{"sha": "f7779be7d262be292bca1d28b4a88f2661f717dc", "filename": "gcc/analyzer/sm-fd.cc", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Fanalyzer%2Fsm-fd.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Fanalyzer%2Fsm-fd.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fanalyzer%2Fsm-fd.cc?ref=64fb291c5839e1a82afb62743172b4eab1267399", "patch": "@@ -1798,7 +1798,8 @@ fd_state_machine::check_for_new_socket_fd (const call_details &cd,\n \t\t|| old_state == m_new_datagram_socket\n \t\t|| old_state == m_new_unknown_socket\n \t\t|| old_state == m_start\n-\t\t|| old_state == m_stop))\n+\t\t|| old_state == m_stop\n+\t\t|| old_state == m_constant_fd))\n     {\n       /* Complain about \"bind\" or \"connect\" in wrong phase.  */\n       tree diag_arg = sm_ctxt->get_diagnostic_tree (fd_sval);\n@@ -1900,6 +1901,7 @@ fd_state_machine::on_listen (const call_details &cd,\n   if (!check_for_socket_fd (cd, successful, sm_ctxt, fd_sval, node, old_state))\n     return false;\n   if (!(old_state == m_start\n+\t|| old_state == m_constant_fd\n \t|| old_state == m_stop\n \t|| old_state == m_bound_stream_socket\n \t|| old_state == m_bound_unknown_socket\n@@ -2015,8 +2017,9 @@ fd_state_machine::on_accept (const call_details &cd,\n   if (!check_for_socket_fd (cd, successful, sm_ctxt, fd_sval, node, old_state))\n     return false;\n \n-  if (old_state == m_start)\n-    /* If we were in the start state, assume we had the expected state.  */\n+  if (old_state == m_start || old_state == m_constant_fd)\n+    /* If we were in the start state (or a constant), assume we had the\n+       expected state.  */\n     sm_ctxt->set_next_state (cd.get_call_stmt (), fd_sval,\n \t\t\t     m_listening_stream_socket);\n   else if (old_state == m_stop)"}, {"sha": "1b25012624b61a793b2c53a01295ae6ab0a04085", "filename": "gcc/testsuite/gcc.dg/analyzer/fd-accept.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-accept.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-accept.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-accept.c?ref=64fb291c5839e1a82afb62743172b4eab1267399", "patch": "@@ -69,3 +69,8 @@ int test_accept_on_accept (int fd_a)\n \n   return fd_b;\n }\n+\n+int test_accept_on_constant ()\n+{\n+  return accept (0, NULL, 0);\n+}"}, {"sha": "d027b1a6b51e9c145de36b9a43946dcb3e066432", "filename": "gcc/testsuite/gcc.dg/analyzer/fd-bind.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-bind.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-bind.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-bind.c?ref=64fb291c5839e1a82afb62743172b4eab1267399", "patch": "@@ -74,3 +74,8 @@ void test_bind_after_accept (int fd, const char *sockname)\n \n   close (afd);\n }\n+\n+int test_bind_on_constant ()\n+{\n+  return bind (0, NULL, 0);\n+}"}, {"sha": "ad837c93f4bcaf171bef2b9561c00ac387fef02d", "filename": "gcc/testsuite/gcc.dg/analyzer/fd-connect.c", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-connect.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-connect.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-connect.c?ref=64fb291c5839e1a82afb62743172b4eab1267399", "patch": "@@ -46,3 +46,8 @@ void test_connect_after_bind (const char *sockname,\n \n   close (fd);      \n }\n+\n+int test_connect_on_constant ()\n+{\n+  return connect (0, NULL, 0);\n+}"}, {"sha": "a241113e3f0948220f00bc7888ae502479950956", "filename": "gcc/testsuite/gcc.dg/analyzer/fd-listen.c", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-listen.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/64fb291c5839e1a82afb62743172b4eab1267399/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-listen.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fanalyzer%2Ffd-listen.c?ref=64fb291c5839e1a82afb62743172b4eab1267399", "patch": "@@ -54,7 +54,7 @@ void test_listen_on_new_datagram_socket (void)\n   close (fd);\n }\n \n-void test_listed_on_connected_socket (int fd)\n+void test_listen_on_connected_socket (int fd)\n {\n   int afd = accept (fd, NULL, 0);\n   if (afd == -1)\n@@ -63,3 +63,8 @@ void test_listed_on_connected_socket (int fd)\n   /* { dg-message \"'listen' expects a bound stream socket file descriptor but 'afd' is connected\" \"final event\" { target *-*-* } .-1 } */\n   close (afd);\n }\n+\n+int test_listen_on_constant ()\n+{\n+  return listen (0, 10);\n+}"}]}