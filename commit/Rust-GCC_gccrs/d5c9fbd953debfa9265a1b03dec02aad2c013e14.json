{"sha": "d5c9fbd953debfa9265a1b03dec02aad2c013e14", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDVjOWZiZDk1M2RlYmZhOTI2NWExYjAzZGVjMDJhYWQyYzAxM2UxNA==", "commit": {"author": {"name": "Thomas Fitzsimmons", "email": "fitzsim@redhat.com", "date": "2005-02-22T06:13:04Z"}, "committer": {"name": "Thomas Fitzsimmons", "email": "fitzsim@gcc.gnu.org", "date": "2005-02-22T06:13:04Z"}, "message": "re PR awt/17952 (Windows don't show with window manager that supports _NET_REQUEST_FRAME_EXTENTS)\n\n2005-02-22  Thomas Fitzsimmons  <fitzsim@redhat.com>\n\n\tPR libgcj/17952:\n\t* gnu/java/awt/peer/gtk/GtkWindowPeer.java,\n\tjni/gtk-peer/gnu_java_awt_peer_gtk_GtkWindowPeer.c\n\t(getWidth): New method.\n\t(getHeight): Likewise.\n\t(create): Remove width, height and insets parameters.  Move size\n\tsetup ...\n\t(realize_cb): ... here.  New function.\n\t(connectSignals): Connect realize_cb.\n\t(request_frame_extents): Remove FIXME.  Move\n\tpostInsetsChangedEvent lookup ...\n\t* jni/gtk-peer/gnu_java_awt_peer_gtk_GtkToolkit.c (gtkInit):\n\t... here.  Look up GtkWindowPeer getWidth and getHeight methods.\n\t* jni/gtk-peer/gtkpeer.h (postInsetsChangedEventID): Declare\n\tjmethodID.\n\t(windowGetWidthID): Likewise.\n\t(windowGetHeightID): Likewise.\n\nFrom-SVN: r95383", "tree": {"sha": "d3aea0a3bc302b097583adb38c7236d17b0d81bc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d3aea0a3bc302b097583adb38c7236d17b0d81bc"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d5c9fbd953debfa9265a1b03dec02aad2c013e14", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d5c9fbd953debfa9265a1b03dec02aad2c013e14", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d5c9fbd953debfa9265a1b03dec02aad2c013e14", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d5c9fbd953debfa9265a1b03dec02aad2c013e14/comments", "author": null, "committer": null, "parents": [{"sha": "cb635293c7defc3babab65388569f909452808da", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb635293c7defc3babab65388569f909452808da", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cb635293c7defc3babab65388569f909452808da"}], "stats": {"total": 154, "additions": 88, "deletions": 66}, "files": [{"sha": "904e5b828abf04204620cdcbf6e5711140fde08e", "filename": "libjava/ChangeLog", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2FChangeLog?ref=d5c9fbd953debfa9265a1b03dec02aad2c013e14", "patch": "@@ -1,3 +1,23 @@\n+2005-02-22  Thomas Fitzsimmons  <fitzsim@redhat.com>\n+\n+\tPR libgcj/17952:\n+\t* gnu/java/awt/peer/gtk/GtkWindowPeer.java,\n+\tjni/gtk-peer/gnu_java_awt_peer_gtk_GtkWindowPeer.c\n+\t(getWidth): New method.\n+\t(getHeight): Likewise.\n+\t(create): Remove width, height and insets parameters.  Move size\n+\tsetup ...\n+\t(realize_cb): ... here.  New function.\n+\t(connectSignals): Connect realize_cb.\n+\t(request_frame_extents): Remove FIXME.  Move\n+\tpostInsetsChangedEvent lookup ...\n+\t* jni/gtk-peer/gnu_java_awt_peer_gtk_GtkToolkit.c (gtkInit):\n+\t... here.  Look up GtkWindowPeer getWidth and getHeight methods.\n+\t* jni/gtk-peer/gtkpeer.h (postInsetsChangedEventID): Declare\n+\tjmethodID.\n+\t(windowGetWidthID): Likewise.\n+\t(windowGetHeightID): Likewise.\n+\n 2005-02-21  Thomas Fitzsimmons  <fitzsim@redhat.com>\n \n \tPR libgcj/19842"}, {"sha": "eabe59140a6d66a43859876ab4f14cffb125a494", "filename": "libjava/gnu/java/awt/peer/gtk/GtkWindowPeer.java", "status": "modified", "additions": 12, "deletions": 15, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fgnu%2Fjava%2Fawt%2Fpeer%2Fgtk%2FGtkWindowPeer.java", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fgnu%2Fjava%2Fawt%2Fpeer%2Fgtk%2FGtkWindowPeer.java", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fgnu%2Fjava%2Fawt%2Fpeer%2Fgtk%2FGtkWindowPeer.java?ref=d5c9fbd953debfa9265a1b03dec02aad2c013e14", "patch": "@@ -63,30 +63,27 @@ public class GtkWindowPeer extends GtkContainerPeer\n   native void gtkWindowSetResizable (boolean resizable);\n   native void gtkWindowSetModal (boolean modal);\n \n-  native void create (int type, boolean decorated,\n-\t\t      int width, int height,\n-\t\t      GtkWindowPeer parent,\n-\t\t      int[] insets);\n+  int getWidth ()\n+  {\n+    return awtComponent.getWidth();\n+  }\n+\n+  int getHeight ()\n+  {\n+    return awtComponent.getHeight();\n+  }\n+\n+  native void create (int type, boolean decorated, GtkWindowPeer parent);\n \n   void create (int type, boolean decorated)\n   {\n     GtkWindowPeer parent_peer = null;\n     Component parent = awtComponent.getParent();\n-    int[] insets = new int [] { 0, 0, 0, 0 };\n \n     if (parent != null)\n       parent_peer = (GtkWindowPeer) awtComponent.getParent().getPeer();\n \n-    create (type, decorated,\n-\t    awtComponent.getWidth(),\n-\t    awtComponent.getHeight(),\n-\t    parent_peer,\n-\t    insets);\n-\n-    this.insets.top = insets [0];\n-    this.insets.left = insets [1];\n-    this.insets.bottom = insets [2];\n-    this.insets.right = insets [3];\n+    create (type, decorated, parent_peer);\n   }\n \n   void create ()"}, {"sha": "8cb9e2f5d68c31cb2ed53b92e6775f9ab409fad3", "filename": "libjava/jni/gtk-peer/gnu_java_awt_peer_gtk_GtkToolkit.c", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fjni%2Fgtk-peer%2Fgnu_java_awt_peer_gtk_GtkToolkit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fjni%2Fgtk-peer%2Fgnu_java_awt_peer_gtk_GtkToolkit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fjni%2Fgtk-peer%2Fgnu_java_awt_peer_gtk_GtkToolkit.c?ref=d5c9fbd953debfa9265a1b03dec02aad2c013e14", "patch": "@@ -62,6 +62,9 @@ jmethodID choicePostItemEventID;\n jmethodID postListItemEventID;\n jmethodID postTextEventID;\n jmethodID postWindowEventID;\n+jmethodID postInsetsChangedEventID;\n+jmethodID windowGetWidthID;\n+jmethodID windowGetHeightID;\n \n jmethodID beginNativeRepaintID;\n jmethodID endNativeRepaintID;\n@@ -212,6 +215,14 @@ Java_gnu_java_awt_peer_gtk_GtkToolkit_gtkInit (JNIEnv *env,\n   postWindowEventID = (*env)->GetMethodID (env, gtkwindowpeer,\n \t\t\t\t\t   \"postWindowEvent\",\n \t\t\t\t\t   \"(ILjava/awt/Window;I)V\");\n+  postInsetsChangedEventID = (*env)->GetMethodID (env, gtkwindowpeer,\n+\t\t\t\t\t\t  \"postInsetsChangedEvent\",\n+\t\t\t\t\t\t  \"(IIII)V\");\n+  windowGetWidthID = (*env)->GetMethodID (env, gtkwindowpeer,\n+\t\t\t\t\t  \"getWidth\", \"()I\");\n+  windowGetHeightID = (*env)->GetMethodID (env, gtkwindowpeer,\n+\t\t\t\t\t  \"getHeight\", \"()I\");\n+\n   postExposeEventID = (*env)->GetMethodID (env, gtkcomponentpeer, \n \t\t\t\t\t  \"postExposeEvent\", \"(IIII)V\");\n   postKeyEventID = (*env)->GetMethodID (env, gtkcomponentpeer,"}, {"sha": "b0177c90a47bed0195428bc706a783fa23181545", "filename": "libjava/jni/gtk-peer/gnu_java_awt_peer_gtk_GtkWindowPeer.c", "status": "modified", "additions": 41, "deletions": 51, "changes": 92, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fjni%2Fgtk-peer%2Fgnu_java_awt_peer_gtk_GtkWindowPeer.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fjni%2Fgtk-peer%2Fgnu_java_awt_peer_gtk_GtkWindowPeer.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fjni%2Fgtk-peer%2Fgnu_java_awt_peer_gtk_GtkWindowPeer.c?ref=d5c9fbd953debfa9265a1b03dec02aad2c013e14", "patch": "@@ -80,6 +80,7 @@ static jint window_get_new_state (GtkWidget *widget);\n static gboolean window_property_changed_cb (GtkWidget *widget,\n \t\t\t\t\t    GdkEventProperty *event,\n \t\t\t\t\t    jobject peer);\n+static void realize_cb (GtkWidget *widget, jobject peer);\n \n /* Union used for type punning. */\n union extents_union\n@@ -94,23 +95,14 @@ union atom_list_union\n   Atom **atom_list;\n };\n \n-JNIEXPORT void JNICALL \n-Java_gnu_java_awt_peer_gtk_GtkWindowPeer_create \n-  (JNIEnv *env, jobject obj, jint type, jboolean decorated,\n-   jint width, jint height, jobject parent, jintArray jinsets)\n+JNIEXPORT void JNICALL\n+Java_gnu_java_awt_peer_gtk_GtkWindowPeer_create\n+  (JNIEnv *env, jobject obj, jint type, jboolean decorated, jobject parent)\n {\n   GtkWidget *window_widget;\n   GtkWindow *window;\n   void *window_parent;\n   GtkWidget *fixed;\n-  int top = 0;\n-  int left = 0;\n-  int bottom = 0;\n-  int right = 0;\n-  jint *insets;\n-\n-  insets = (*env)->GetIntArrayElements (env, jinsets, 0);\n-  insets[0] = insets[1] = insets[2] = insets[3] = 0;\n \n   NSA_SET_GLOBAL_REF (env, obj);\n \n@@ -137,31 +129,8 @@ Java_gnu_java_awt_peer_gtk_GtkWindowPeer_create\n \n   gtk_widget_show (fixed);\n \n-  if (decorated)\n-    window_get_frame_extents (window_widget, &top, &left, &bottom, &right);\n-\n-  gtk_window_set_default_size (window,\n-\t\t\t       MAX (1, width - left - right),\n-\t\t\t       MAX (1, height - top - bottom));\n-\n-  /* We must set this window's size requisition.  Otherwise when a\n-     resize is queued (when gtk_widget_queue_resize is called) the\n-     window will snap to its default requisition of 0x0.  If we omit\n-     this call, Frames and Dialogs shrink to degenerate 1x1 windows\n-     when their resizable property changes. */\n-  gtk_widget_set_size_request (window_widget,\n-\t\t\t       MAX (1, width - left - right),\n-\t\t\t       MAX (1, height - top - bottom));\n-\n-  insets[0] = top;\n-  insets[1] = left;\n-  insets[2] = bottom;\n-  insets[3] = right;\n-\n   gdk_threads_leave ();\n \n-  (*env)->ReleaseIntArrayElements (env, jinsets, insets, 0);\n-\n   NSA_SET_PTR (env, obj, window_widget);\n }\n \n@@ -277,6 +246,9 @@ Java_gnu_java_awt_peer_gtk_GtkWindowPeer_connectSignals\n   g_signal_connect (G_OBJECT (ptr), \"property-notify-event\",\n \t\t    G_CALLBACK (window_property_changed_cb), *gref);\n \n+  g_signal_connect_after (G_OBJECT (ptr), \"realize\",\n+                          G_CALLBACK (realize_cb), *gref);\n+\n   g_signal_connect_after (G_OBJECT (ptr), \"realize\",\n                           G_CALLBACK (connect_awt_hook_cb), *gref);\n \n@@ -428,9 +400,7 @@ request_frame_extents (GtkWidget *window)\n \n   /* Check if the current window manager supports\n      _NET_REQUEST_FRAME_EXTENTS. */\n-  /* FIXME: The window->window != NULL check is a workaround for bug\n-     http://bugzilla.gnome.org/show_bug.cgi?id=17952. */\n-  if (gdk_net_wm_supports (request_extents) && window->window != NULL)\n+  if (gdk_net_wm_supports (request_extents))\n     {\n       GdkDisplay *display = gtk_widget_get_display (window);\n       Display *xdisplay = GDK_DISPLAY_XDISPLAY (display);\n@@ -700,19 +670,6 @@ window_property_changed_cb (GtkWidget *widget __attribute__((unused)),\n   unsigned long *extents;\n   union extents_union gu_ex;\n \n-  static int id_set = 0;\n-  static jmethodID postInsetsChangedEventID;\n-\n-  if (!id_set)\n-    {\n-      jclass gtkwindowpeer = (*gdk_env())->FindClass (gdk_env(),\n-\t\t\t\t \"gnu/java/awt/peer/gtk/GtkWindowPeer\");\n-      postInsetsChangedEventID = (*gdk_env())->GetMethodID (gdk_env(),\n-\t\t\t\t\t\t      gtkwindowpeer,\n-\t\t\t\t\t\t      \"postInsetsChangedEvent\",\n-\t\t\t\t\t\t      \"(IIII)V\");\n-      id_set = 1;\n-    }\n   gu_ex.extents = &extents;\n   if (gdk_atom_intern (\"_NET_FRAME_EXTENTS\", FALSE) == event->atom\n       && gdk_property_get (event->window,\n@@ -739,3 +696,36 @@ window_property_changed_cb (GtkWidget *widget __attribute__((unused)),\n \n   return FALSE;\n }\n+\n+static void\n+realize_cb (GtkWidget *widget, jobject peer)\n+{\n+  jint top = 0;\n+  jint left = 0;\n+  jint bottom = 0;\n+  jint right = 0;\n+  jint width = 0;\n+  jint height = 0;\n+\n+  width = (*gdk_env())->CallIntMethod (gdk_env(), peer, windowGetWidthID);\n+  height = (*gdk_env())->CallIntMethod (gdk_env(), peer, windowGetHeightID);\n+\n+  window_get_frame_extents (widget, &top, &left, &bottom, &right);\n+\n+  (*gdk_env())->CallVoidMethod (gdk_env(), peer,\n+\t\t\t\tpostInsetsChangedEventID,\n+\t\t\t\ttop, left, bottom, right);\n+\n+  gtk_window_set_default_size (GTK_WINDOW (widget),\n+\t\t\t       MAX (1, width - left - right),\n+\t\t\t       MAX (1, height - top - bottom));\n+\n+  /* set the size like we do in nativeSetBounds */\n+  gtk_widget_set_size_request (widget,\n+\t\t\t       MAX (1, width - left - right),\n+\t\t\t       MAX (1, height - top - bottom));\n+\n+  gtk_window_resize (GTK_WINDOW (widget),\n+\t\t     MAX (1, width - left - right),\n+\t\t     MAX (1, height - top - bottom));\n+}"}, {"sha": "02613c4e3c2a6cc33b026daa7f4fafdf84b79290", "filename": "libjava/jni/gtk-peer/gtkpeer.h", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fjni%2Fgtk-peer%2Fgtkpeer.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d5c9fbd953debfa9265a1b03dec02aad2c013e14/libjava%2Fjni%2Fgtk-peer%2Fgtkpeer.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libjava%2Fjni%2Fgtk-peer%2Fgtkpeer.h?ref=d5c9fbd953debfa9265a1b03dec02aad2c013e14", "patch": "@@ -465,6 +465,10 @@ extern jmethodID syncAttrsID;\n extern jclass gdkColor;\n extern jmethodID gdkColorID;\n \n+extern jmethodID postInsetsChangedEventID;\n+extern jmethodID windowGetWidthID;\n+extern jmethodID windowGetHeightID;\n+\n JNIEnv *gdk_env(void);\n \n extern double dpi_conversion_factor;"}]}