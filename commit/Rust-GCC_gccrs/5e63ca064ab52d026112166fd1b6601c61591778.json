{"sha": "5e63ca064ab52d026112166fd1b6601c61591778", "node_id": "C_kwDOANBUbNoAKDVlNjNjYTA2NGFiNTJkMDI2MTEyMTY2ZmQxYjY2MDFjNjE1OTE3Nzg", "commit": {"author": {"name": "liushuyu", "email": "liushuyu011@gmail.com", "date": "2022-07-28T07:37:07Z"}, "committer": {"name": "liushuyu", "email": "liushuyu011@gmail.com", "date": "2022-07-29T05:29:31Z"}, "message": "expand: further improves the handling of recursive macros ...\n\n... now all the attribute visitor that expands the\nmacro fragment will recursively expand the macro\nusing the unified expanding function\n`expand_macro_fragment_recursive` instead of expanding\nthe fragment only once.\n\nSigned-off-by: Zixing Liu <liushuyu011@gmail.com>", "tree": {"sha": "40f444e06a384957d533ad10363ec0752858a9f9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/40f444e06a384957d533ad10363ec0752858a9f9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5e63ca064ab52d026112166fd1b6601c61591778", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE6x/rcKrl3aOwzUVJI9HORTRBlDcFAmLjcD0ACgkQI9HORTRB\nlDet/RAAlR8+OQcHjayVkcQ3daNlbNDLOfCqzmZrcTjRcEZFTaZQtBCS8+y/v1IE\nMcLeEv5TqsGVwjQvyUb1ymMY8tNfpMLYSFGCWUlbZAQc4pqV6j/SOZ8tl2ZzZrxU\nJUva9yxprQGqXSSVLNwgqZwTo82GsZAGdjdr7b8vnFgkqnohVsVZKsZM/0uEfbGe\nH9Hc05o1TcUsUAYFcbT1plggQE1lxF598NrwVLRZX9U3Vk7S3PwQ1MINMaj0hn0Q\nw3qhyHKxzpflvz4RyQHaJ9jNUd1ljhYCb2JCCxA2GpA9kFj0lpNnmCSr4rQV2MZ4\n2M3w57zHJ2Ylg95hBUYMhiIz4Jhzxa6hnQPypr3kVpbWhTxss2DF1QibqObLAe0m\n9m4nTBmYrXYpjGj+5uK+ieePknFu7kYPCWoRj8YQWRFTTrsXka5zKRCoCAgpDWA/\n19ZaOmazT945sGYfZ4pQI1QIf7gcRgMR2hcWRUe8CGX9og9ly1ya9671jkWijj3d\ncDpHc1Wq7PfkaLqg5dC/THHHiEa11n3d/BujlCK4LuuD194hKe7XZEOONvWcYe3m\newQFrOzMHrT7sd6Q5Tgz9r/2siuNKTCIYYYtRJMj1yhJ+OFLty+8XBoY6bYLDuO7\ntN01yA6wXG8fjCNKMtfqrh0Gz9f0nD7oeND17EdZxy71zCQxQtM=\n=7Ss+\n-----END PGP SIGNATURE-----", "payload": "tree 40f444e06a384957d533ad10363ec0752858a9f9\nparent 0632b1aa5f0ea1d0c9c4411e9ff3d05336736fbb\nauthor liushuyu <liushuyu011@gmail.com> 1658993827 -0600\ncommitter liushuyu <liushuyu011@gmail.com> 1659072571 -0600\n\nexpand: further improves the handling of recursive macros ...\n\n... now all the attribute visitor that expands the\nmacro fragment will recursively expand the macro\nusing the unified expanding function\n`expand_macro_fragment_recursive` instead of expanding\nthe fragment only once.\n\nSigned-off-by: Zixing Liu <liushuyu011@gmail.com>\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5e63ca064ab52d026112166fd1b6601c61591778", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5e63ca064ab52d026112166fd1b6601c61591778", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5e63ca064ab52d026112166fd1b6601c61591778/comments", "author": {"login": "liushuyu", "id": 6829345, "node_id": "MDQ6VXNlcjY4MjkzNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/6829345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/liushuyu", "html_url": "https://github.com/liushuyu", "followers_url": "https://api.github.com/users/liushuyu/followers", "following_url": "https://api.github.com/users/liushuyu/following{/other_user}", "gists_url": "https://api.github.com/users/liushuyu/gists{/gist_id}", "starred_url": "https://api.github.com/users/liushuyu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/liushuyu/subscriptions", "organizations_url": "https://api.github.com/users/liushuyu/orgs", "repos_url": "https://api.github.com/users/liushuyu/repos", "events_url": "https://api.github.com/users/liushuyu/events{/privacy}", "received_events_url": "https://api.github.com/users/liushuyu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "liushuyu", "id": 6829345, "node_id": "MDQ6VXNlcjY4MjkzNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/6829345?v=4", "gravatar_id": "", "url": "https://api.github.com/users/liushuyu", "html_url": "https://github.com/liushuyu", "followers_url": "https://api.github.com/users/liushuyu/followers", "following_url": "https://api.github.com/users/liushuyu/following{/other_user}", "gists_url": "https://api.github.com/users/liushuyu/gists{/gist_id}", "starred_url": "https://api.github.com/users/liushuyu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/liushuyu/subscriptions", "organizations_url": "https://api.github.com/users/liushuyu/orgs", "repos_url": "https://api.github.com/users/liushuyu/repos", "events_url": "https://api.github.com/users/liushuyu/events{/privacy}", "received_events_url": "https://api.github.com/users/liushuyu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0632b1aa5f0ea1d0c9c4411e9ff3d05336736fbb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0632b1aa5f0ea1d0c9c4411e9ff3d05336736fbb", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0632b1aa5f0ea1d0c9c4411e9ff3d05336736fbb"}], "stats": {"total": 92, "additions": 71, "deletions": 21}, "files": [{"sha": "8016f9430eb54ed5dc69abc42e2f55bc23645f35", "filename": "gcc/rust/expand/rust-attribute-visitor.cc", "status": "modified", "additions": 9, "deletions": 18, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5e63ca064ab52d026112166fd1b6601c61591778/gcc%2Frust%2Fexpand%2Frust-attribute-visitor.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5e63ca064ab52d026112166fd1b6601c61591778/gcc%2Frust%2Fexpand%2Frust-attribute-visitor.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fexpand%2Frust-attribute-visitor.cc?ref=5e63ca064ab52d026112166fd1b6601c61591778", "patch": "@@ -1122,12 +1122,12 @@ AttrVisitor::visit (AST::CallExpr &expr)\n \n       stmt->accept_vis (*this);\n \n-      auto fragment = expander.take_expanded_fragment (*this);\n-      if (fragment.should_expand ())\n+      auto final_fragment = expand_macro_fragment_recursive ();\n+      if (final_fragment.should_expand ())\n \t{\n \t  // Remove the current expanded invocation\n \t  it = params.erase (it);\n-\t  for (auto &node : fragment.get_nodes ())\n+\t  for (auto &node : final_fragment.get_nodes ())\n \t    {\n \t      it = params.insert (it, node.take_expr ());\n \t      it++;\n@@ -3430,25 +3430,16 @@ AttrVisitor::visit (AST::BareFunctionType &type)\n void\n AttrVisitor::maybe_expand_expr (std::unique_ptr<AST::Expr> &expr)\n {\n-  auto fragment = expander.take_expanded_fragment (*this);\n-  unsigned int original_depth = expander.expansion_depth;\n-  while (fragment.should_expand ())\n-    {\n-      expr = fragment.take_expression_fragment ();\n-      expander.expansion_depth++;\n-      auto new_fragment = expander.take_expanded_fragment (*this);\n-      if (new_fragment.is_error ())\n-\tbreak;\n-      fragment = std::move (new_fragment);\n-    }\n-  expander.expansion_depth = original_depth;\n+  auto final_fragment = expand_macro_fragment_recursive ();\n+  if (final_fragment.should_expand ())\n+    expr = final_fragment.take_expression_fragment ();\n }\n \n void\n AttrVisitor::maybe_expand_type (std::unique_ptr<AST::Type> &type)\n {\n-  auto fragment = expander.take_expanded_fragment (*this);\n-  if (fragment.should_expand ())\n-    type = fragment.take_type_fragment ();\n+  auto final_fragment = expand_macro_fragment_recursive ();\n+  if (final_fragment.should_expand ())\n+    type = final_fragment.take_type_fragment ();\n }\n } // namespace Rust"}, {"sha": "0f9d1065334c858c1c67c4f24e6f5ac9ddc719f6", "filename": "gcc/rust/expand/rust-attribute-visitor.h", "status": "modified", "additions": 39, "deletions": 3, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5e63ca064ab52d026112166fd1b6601c61591778/gcc%2Frust%2Fexpand%2Frust-attribute-visitor.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5e63ca064ab52d026112166fd1b6601c61591778/gcc%2Frust%2Fexpand%2Frust-attribute-visitor.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Frust%2Fexpand%2Frust-attribute-visitor.h?ref=5e63ca064ab52d026112166fd1b6601c61591778", "patch": "@@ -17,6 +17,7 @@\n // <http://www.gnu.org/licenses/>.\n \n #include \"rust-ast-visitor.h\"\n+#include \"rust-ast.h\"\n #include \"rust-macro-expand.h\"\n \n namespace Rust {\n@@ -42,6 +43,39 @@ class AttrVisitor : public AST::ASTVisitor\n   void expand_trait_function_decl (AST::TraitFunctionDecl &decl);\n   void expand_trait_method_decl (AST::TraitMethodDecl &decl);\n \n+  /**\n+   * Expand The current macro fragment recursively until it could not be\n+   * expanded further.\n+   *\n+   * The return value checking works because correctly\n+   * expanded fragment can never be an error (if the fragment can not be\n+   * expanded, a stand-in error fragment will be returned; for fragments that\n+   * could not be further expanded: the fragment prior to the expansion failure\n+   * will be returned).\n+   *\n+   * @return Either the expanded fragment or an empty errored-out fragment\n+   * indicating an expansion failure.\n+   */\n+  AST::ASTFragment expand_macro_fragment_recursive ()\n+  {\n+    auto fragment = expander.take_expanded_fragment (*this);\n+    unsigned int original_depth = expander.expansion_depth;\n+    auto final_fragment = AST::ASTFragment ({}, true);\n+\n+    while (fragment.should_expand ())\n+      {\n+\tfinal_fragment = std::move (fragment);\n+\texpander.expansion_depth++;\n+\t// further expand the previously expanded macro fragment\n+\tauto new_fragment = expander.take_expanded_fragment (*this);\n+\tif (new_fragment.is_error ())\n+\t  break;\n+\tfragment = std::move (new_fragment);\n+      }\n+    expander.expansion_depth = original_depth;\n+    return final_fragment;\n+  }\n+\n   /**\n    * Expand a set of values, erasing them if they are marked for strip, and\n    * replacing them with expanded macro nodes if necessary.\n@@ -67,11 +101,13 @@ class AttrVisitor : public AST::ASTVisitor\n \t// mark for stripping if required\n \tvalue->accept_vis (*this);\n \n-\tauto fragment = expander.take_expanded_fragment (*this);\n-\tif (fragment.should_expand ())\n+\t// recursively expand the children\n+\tauto final_fragment = expand_macro_fragment_recursive ();\n+\n+\tif (final_fragment.should_expand ())\n \t  {\n \t    it = values.erase (it);\n-\t    for (auto &node : fragment.get_nodes ())\n+\t    for (auto &node : final_fragment.get_nodes ())\n \t      {\n \t\tauto new_node = extractor (node);\n \t\tif (new_node != nullptr && !new_node->is_marked_for_strip ())"}, {"sha": "7fe6c51053cb02b7ad5ef1814a9ed2a8a61a07e1", "filename": "gcc/testsuite/rust/compile/torture/macro-issue1403.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5e63ca064ab52d026112166fd1b6601c61591778/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fmacro-issue1403.rs", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5e63ca064ab52d026112166fd1b6601c61591778/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fmacro-issue1403.rs", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Frust%2Fcompile%2Ftorture%2Fmacro-issue1403.rs?ref=5e63ca064ab52d026112166fd1b6601c61591778", "patch": "@@ -0,0 +1,23 @@\n+macro_rules! stmt {\n+    ($s:stmt) => {\n+        $s\n+    };\n+    ($s:stmt, $($ss:stmt),*) => {\n+        $s;\n+        stmt!($($ss),*);\n+    };\n+}\n+\n+fn main() {\n+    stmt!(\n+        struct S;\n+    );\n+    stmt!(\n+        struct A;,\n+        struct B;,\n+        struct C;,\n+        struct D;,\n+        struct E;\n+    );\n+}\n+"}]}