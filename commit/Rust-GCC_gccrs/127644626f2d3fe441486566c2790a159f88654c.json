{"sha": "127644626f2d3fe441486566c2790a159f88654c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTI3NjQ0NjI2ZjJkM2ZlNDQxNDg2NTY2YzI3OTBhMTU5Zjg4NjU0Yw==", "commit": {"author": {"name": "Benjamin Kosnik", "email": "bkoz@redhat.com", "date": "2001-04-04T01:02:26Z"}, "committer": {"name": "Benjamin Kosnik", "email": "bkoz@gcc.gnu.org", "date": "2001-04-04T01:02:26Z"}, "message": "fstream.tcc: Add bool parameter to filebuf ctor.\n\n\n2001-04-03  Benjamin Kosnik  <bkoz@redhat.com>\n\n\t* include/bits/fstream.tcc: Add bool parameter to filebuf ctor.\n\t* include/bits/ios_base.h(ios_base::Init): Remove _M_cout, _M_cin,\n\t_M_cerr, _M_wcout, _M_wcin, _M_wcerr.\n\t(ios_base::Init::_S_ios_create): New.\n\t(ios_base::Init::_S_ios_destroy): New.\n\t* include/bits/std_fstream.h: Change ctor args.\n\t* src/ios.cc (ios_base::Init::Init): Use _S_ios_create.\n\t(ios_base::Init::~Init): Use _S_ios_destroy.\n\t(ios_base::sync_with_stdio): Use new members.\n\t* testsuite/27_io/filebuf_members.cc: Fix calling conventions for\n\tfilebuf ctor.\n\nFrom-SVN: r41072", "tree": {"sha": "4edcf7a1442e75e1c8423db7adc2956cc77f6e87", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4edcf7a1442e75e1c8423db7adc2956cc77f6e87"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/127644626f2d3fe441486566c2790a159f88654c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/127644626f2d3fe441486566c2790a159f88654c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/127644626f2d3fe441486566c2790a159f88654c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/127644626f2d3fe441486566c2790a159f88654c/comments", "author": null, "committer": null, "parents": [{"sha": "56713d55f778623e3b67ff6335ea3015c6da98ef", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/56713d55f778623e3b67ff6335ea3015c6da98ef", "html_url": "https://github.com/Rust-GCC/gccrs/commit/56713d55f778623e3b67ff6335ea3015c6da98ef"}], "stats": {"total": 158, "additions": 78, "deletions": 80}, "files": [{"sha": "09906daac90672cc8f29d59ca4d62373f47b3049", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=127644626f2d3fe441486566c2790a159f88654c", "patch": "@@ -1,3 +1,17 @@\n+2001-04-03  Benjamin Kosnik  <bkoz@redhat.com>\n+\n+\t* include/bits/fstream.tcc: Add bool parameter to filebuf ctor.\n+\t* include/bits/ios_base.h(ios_base::Init): Remove _M_cout, _M_cin,\n+\t_M_cerr, _M_wcout, _M_wcin, _M_wcerr.\n+\t(ios_base::Init::_S_ios_create): New.\n+\t(ios_base::Init::_S_ios_destroy): New.\t\n+\t* include/bits/std_fstream.h: Change ctor args.\n+\t* src/ios.cc (ios_base::Init::Init): Use _S_ios_create.\n+\t(ios_base::Init::~Init): Use _S_ios_destroy.\n+\t(ios_base::sync_with_stdio): Use new members.\n+\t* testsuite/27_io/filebuf_members.cc: Fix calling conventions for\n+\tfilebuf ctor.\n+\n 2001-04-03  Peter Schmid  <schmid@snake.iap.physik.tu-darmstadt.de>\n \n         * include/backward/fstream.h:  Expose streampos to global"}, {"sha": "c1311e9f573f49c4f0038d5555468fc51c1040e8", "filename": "libstdc++-v3/include/bits/fstream.tcc", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Finclude%2Fbits%2Ffstream.tcc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Finclude%2Fbits%2Ffstream.tcc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Ffstream.tcc?ref=127644626f2d3fe441486566c2790a159f88654c", "patch": "@@ -90,15 +90,22 @@ namespace std\n \n   template<typename _CharT, typename _Traits>\n     basic_filebuf<_CharT, _Traits>::\n-    basic_filebuf(__c_file_type* __f, ios_base::openmode __mode)\n+    basic_filebuf(__c_file_type* __f, bool __s, ios_base::openmode __mode)\n     : __streambuf_type(),  _M_file(NULL), _M_state_cur(__state_type()), \n     _M_state_beg(__state_type()), _M_last_overflowed(false)\n     {\n       _M_filebuf_init();\n       _M_file->sys_open(__f, __mode);\n       if (this->is_open())\n-\t_M_mode = __mode;\n-   }\n+\t{\n+\t  _M_mode = __mode;\n+\t  if (!__s)\n+\t    {\n+\t      _M_allocate_buffers();\n+\t      _M_set_indeterminate();\n+\t    }\n+\t}\n+    }\n \n   template<typename _CharT, typename _Traits>\n     basic_filebuf<_CharT, _Traits>::__filebuf_type* "}, {"sha": "31b8d3a917d351667decf67debed7d3640b4120f", "filename": "libstdc++-v3/include/bits/ios_base.h", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fios_base.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fios_base.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fios_base.h?ref=127644626f2d3fe441486566c2790a159f88654c", "patch": "@@ -295,17 +295,16 @@ namespace std\n     public:\n       Init();\n       ~Init();\n+      \n+      static void\n+      _S_ios_create(bool __sync);\n+      \n+      static void\n+      _S_ios_destroy();\n+\n     private:\n       static int \t_S_ios_base_init;\n       static bool\t_S_synced_with_stdio;\n-      filebuf* \t\t_M_cout;\n-      filebuf* \t\t_M_cin;\n-      filebuf* \t\t_M_cerr;\n-#ifdef _GLIBCPP_USE_WCHAR_T\n-      wfilebuf* \t_M_wcout;\n-      wfilebuf*        \t_M_wcin;\n-      wfilebuf* \t_M_wcerr;\n-#endif\n     };\n \n     // Fmtflags state:"}, {"sha": "63a86b9a5814d86a93d8762ab2aa5d4de20884a7", "filename": "libstdc++-v3/include/bits/std_fstream.h", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstd_fstream.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstd_fstream.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Finclude%2Fbits%2Fstd_fstream.h?ref=127644626f2d3fe441486566c2790a159f88654c", "patch": "@@ -86,7 +86,7 @@ namespace std\n       basic_filebuf();\n \n       // Non-standard ctor:\n-      basic_filebuf(__c_file_type* __f, ios_base::openmode __mode);\n+      basic_filebuf(__c_file_type* __f, bool __s, ios_base::openmode __mode);\n  \n       virtual \n       ~basic_filebuf() "}, {"sha": "de577d66c16cf9f2a947594853457029ac7defcc", "filename": "libstdc++-v3/src/ios.cc", "status": "modified", "additions": 45, "deletions": 67, "changes": 112, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Fsrc%2Fios.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Fsrc%2Fios.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fsrc%2Fios.cc?ref=127644626f2d3fe441486566c2790a159f88654c", "patch": "@@ -133,63 +133,61 @@ namespace std\n   ios_base::failure::what() const throw()\n   { return _M_name; }\n \n+  void\n+  ios_base::Init::_S_ios_create(bool __sync)\n+  {\n+    // NB: The file std_iostream.h creates the four standard files\n+    // with NULL buffers. At this point, we swap out these\n+    new (&cout) ostream(new filebuf(stdout, __sync, ios_base::out));\n+    new (&cin) istream(new filebuf(stdin, __sync, ios_base::in));\n+    new (&cerr) ostream(new filebuf(stderr, __sync, ios_base::out));\n+    new (&clog) ostream(cerr.rdbuf());\n+    cin.tie(&cout);\n+    cerr.flags(ios_base::unitbuf);\n+    \n+#ifdef _GLIBCPP_USE_WCHAR_T\n+    new (&wcout) wostream( new wfilebuf(stdout, __sync, ios_base::out));\n+    new (&wcin) wistream(new wfilebuf(stdin, __sync, ios_base::in));\n+    new (&wcerr) wostream(new wfilebuf(stderr, __sync, ios_base::out));\n+    new (&wclog) wostream(wcerr.rdbuf());\n+    wcin.tie(&wcout);\n+    wcerr.flags(ios_base::unitbuf);\n+#endif\n+  }\n+\n   ios_base::Init::Init()\n   {\n     if (++_S_ios_base_init == 1)\n       {\n-\t// NB: std_iostream.h creates the four standard files with\n-\t// NULL buffers. At this point, we swap out these placeholder\n-\t// objects for the properly-constructed ones\n-       \t_M_cout = new filebuf(stdout, ios_base::out);\n-\t_M_cin = new filebuf(stdin, ios_base::in);\n-\t_M_cerr = new filebuf(stderr, ios_base::out);\n-\tnew (&cout) ostream(_M_cout);\n-\tnew (&cin) istream(_M_cin);\n-\tnew (&cerr) ostream(_M_cerr);\n-\tnew (&clog) ostream(_M_cerr);\n-\tcin.tie(&cout);\n-\tcerr.flags(ios_base::unitbuf);\n+\t// Standard streams default to synced with \"C\" operations.\n+\tios_base::Init::_S_synced_with_stdio = true;\n+\t_S_ios_create(ios_base::Init::_S_synced_with_stdio);\n+      }\n+  }\n \n+  void\n+  ios_base::Init::_S_ios_destroy()\n+  {\n+    cout.flush();\n+    cerr.flush();\n+    clog.flush();\n+    delete cout.rdbuf();\n+    delete cin.rdbuf();\n+    delete cerr.rdbuf();\n #ifdef _GLIBCPP_USE_WCHAR_T\n-\t_M_wcout = new wfilebuf(stdout, ios_base::out);\n-\t_M_wcin = new wfilebuf(stdin, ios_base::in);\n-\t_M_wcerr = new wfilebuf(stderr, ios_base::out);\n-\tnew (&wcout) wostream(_M_wcout);\n-\tnew (&wcin) wistream(_M_wcin);\n-\tnew (&wcerr) wostream(_M_wcerr);\n-\tnew (&wclog) wostream(_M_wcerr);\n-\twcin.tie(&wcout);\n-\twcerr.flags(ios_base::unitbuf);\n+    wcout.flush();\n+    wcerr.flush();\n+    wclog.flush();\n+    delete wcout.rdbuf();\n+    delete wcin.rdbuf();\n+    delete wcerr.rdbuf();\n #endif\n-\tios_base::Init::_S_synced_with_stdio = true;\n-      }\n   }\n \n   ios_base::Init::~Init()\n   {\n     if (--_S_ios_base_init == 0)\n-      {\n-\tcout.flush();\n-\tcerr.flush();\n-\tclog.flush();\n-\tdelete _M_cout;\n-\tdelete _M_cin;\n-\tdelete _M_cerr;\n-\t_M_cout = NULL;\n-\t_M_cin = NULL;\n-\t_M_cerr = NULL;\n-#ifdef _GLIBCPP_USE_WCHAR_T\n-\twcout.flush();\n-\twcerr.flush();\n-\twclog.flush();\n-\tdelete _M_wcout;\n-\tdelete _M_wcin;\n-\tdelete _M_wcerr;\n-\t_M_wcout = NULL;\n-\t_M_wcin = NULL;\n-\t_M_wcerr = NULL;\n-#endif\n-      }\n+      _S_ios_destroy();\n   } \n \n   // 27.4.2.5  ios_base storage functions\n@@ -323,31 +321,11 @@ namespace std\n     // currently synchronized.\n     if (!__sync && __ret)\n       {\n-#if 0\n-\t// no longer need to do this\n-\t// Need to dispose of the buffers created at initialization.\n-\t__ioinit._M_cout->~filebuf();\n-\t__ioinit._M_cin->~filebuf();\n-\t__ioinit._M_cerr->~filebuf();\n-\t__ioinit._M_cout = new filebuf();\n-\t__ioinit._M_cin = new filebuf();\n-\t__ioinit._M_cerr = new filebuf();\n-\t__ioinit._M_cout->open(\"stdout\", ios_base::out);\n-\t__ioinit._M_cin->open(\"stdin\", ios_base::in);\n-\t__ioinit._M_cerr->open(\"stderr\", ios_base::out);\n-\tcout.rdbuf(__ioinit._M_cout);\n-\tcin.rdbuf(__ioinit._M_cin);\n-\tcerr.rdbuf(__ioinit._M_cerr);\n-\tcerr.flags(ios_base::unitbuf);\n-\tclog.rdbuf(__ioinit._M_cerr);\n-#endif\n-#ifdef _GLIBCPP_USE_WCHAR_T\n-#endif\n \tios_base::Init::_S_synced_with_stdio = false;\n+\tios_base::Init::_S_ios_destroy();\n+\tios_base::Init::_S_ios_create(ios_base::Init::_S_synced_with_stdio);\n       }\n-    \n     return __ret; \n   }\n-\n }  // namespace std\n "}, {"sha": "3eda6f579e17b1440db409111f8a6f279db52b71", "filename": "libstdc++-v3/testsuite/27_io/filebuf_members.cc", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_members.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/127644626f2d3fe441486566c2790a159f88654c/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_members.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Ftestsuite%2F27_io%2Ffilebuf_members.cc?ref=127644626f2d3fe441486566c2790a159f88654c", "patch": "@@ -52,7 +52,7 @@ test_01()\n   FILE* f2 = fopen(name_01, \"r\");\n   VERIFY( f2 != NULL );\n   {\n-    std::filebuf fb(f2, std::ios_base::in);\n+    std::filebuf fb(f2, false, std::ios_base::in);\n   }\n   close_num = fclose(f2);\n   VERIFY( close_num == 0 );"}]}