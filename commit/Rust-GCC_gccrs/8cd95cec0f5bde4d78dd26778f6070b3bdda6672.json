{"sha": "8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OGNkOTVjZWMwZjViZGU0ZDc4ZGQyNjc3OGY2MDcwYjNiZGRhNjY3Mg==", "commit": {"author": {"name": "Martin Sebor", "email": "msebor@redhat.com", "date": "2018-04-20T23:43:51Z"}, "committer": {"name": "Martin Sebor", "email": "msebor@gcc.gnu.org", "date": "2018-04-20T23:43:51Z"}, "message": "PR c/85365 -  -Wrestrict false positives with -fsanitize=undefined\n\ngcc/ChangeLog:\n\n\tPR c/85365\n\t* gimple-fold.c (gimple_fold_builtin_strcpy): Suppress -Wrestrict\n\tfor null pointers.\n\t(gimple_fold_builtin_stxcpy_chk): Same.\n\t* gimple-ssa-warn-restrict.c (check_bounds_or_overlap): Same.\n\ngcc/testsuite/ChangeLog:\n\n\tPR c/85365\n\t* gcc.dg/Wrestrict-15.c: New test.\n\nFrom-SVN: r259535", "tree": {"sha": "e2c3ae88ecc8a5de23f062a8f185c0f70860ae17", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/e2c3ae88ecc8a5de23f062a8f185c0f70860ae17"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "html_url": "https://github.com/Rust-GCC/gccrs/commit/8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/comments", "author": {"login": "msebor", "id": 381149, "node_id": "MDQ6VXNlcjM4MTE0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/381149?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msebor", "html_url": "https://github.com/msebor", "followers_url": "https://api.github.com/users/msebor/followers", "following_url": "https://api.github.com/users/msebor/following{/other_user}", "gists_url": "https://api.github.com/users/msebor/gists{/gist_id}", "starred_url": "https://api.github.com/users/msebor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msebor/subscriptions", "organizations_url": "https://api.github.com/users/msebor/orgs", "repos_url": "https://api.github.com/users/msebor/repos", "events_url": "https://api.github.com/users/msebor/events{/privacy}", "received_events_url": "https://api.github.com/users/msebor/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "661eb8f9e5270df79c21601273219e2a8e282204", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/661eb8f9e5270df79c21601273219e2a8e282204", "html_url": "https://github.com/Rust-GCC/gccrs/commit/661eb8f9e5270df79c21601273219e2a8e282204"}], "stats": {"total": 82, "additions": 75, "deletions": 7}, "files": [{"sha": "750958465f9655f947d9b3d15522b4ab867acc06", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "patch": "@@ -1,3 +1,11 @@\n+2018-04-20  Martin Sebor  <msebor@redhat.com>\n+\n+\tPR c/85365\n+\t* gimple-fold.c (gimple_fold_builtin_strcpy): Suppress -Wrestrict\n+\tfor null pointers.\n+\t(gimple_fold_builtin_stxcpy_chk): Same.\n+\t* gimple-ssa-warn-restrict.c (check_bounds_or_overlap): Same.\n+\n 2018-04-20  Michael Meissner  <meissner@linux.ibm.com>\n \n \tPR target/85456"}, {"sha": "bd8c44a6a607287eb47fa3bb996765ec546aba14", "filename": "gcc/gimple-fold.c", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Fgimple-fold.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Fgimple-fold.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-fold.c?ref=8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "patch": "@@ -1612,7 +1612,11 @@ gimple_fold_builtin_strcpy (gimple_stmt_iterator *gsi,\n   /* If SRC and DEST are the same (and not volatile), return DEST.  */\n   if (operand_equal_p (src, dest, 0))\n     {\n-      if (!gimple_no_warning_p (stmt))\n+      /* Issue -Wrestrict unless the pointers are null (those do\n+\t not point to objects and so do not indicate an overlap;\n+\t such calls could be the result of sanitization and jump\n+\t threading).  */\n+      if (!integer_zerop (dest) && !gimple_no_warning_p (stmt))\n \t{\n \t  tree func = gimple_call_fndecl (stmt);\n \n@@ -2593,7 +2597,11 @@ gimple_fold_builtin_stxcpy_chk (gimple_stmt_iterator *gsi,\n   /* If SRC and DEST are the same (and not volatile), return DEST.  */\n   if (fcode == BUILT_IN_STRCPY_CHK && operand_equal_p (src, dest, 0))\n     {\n-      if (!gimple_no_warning_p (stmt))\n+      /* Issue -Wrestrict unless the pointers are null (those do\n+\t not point to objects and so do not indicate an overlap;\n+\t such calls could be the result of sanitization and jump\n+\t threading).  */\n+      if (!integer_zerop (dest) && !gimple_no_warning_p (stmt))\n \t{\n \t  tree func = gimple_call_fndecl (stmt);\n "}, {"sha": "3d0664da028a400cc01b239239e9ccb3e4c23826", "filename": "gcc/gimple-ssa-warn-restrict.c", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Fgimple-ssa-warn-restrict.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Fgimple-ssa-warn-restrict.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fgimple-ssa-warn-restrict.c?ref=8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "patch": "@@ -1880,11 +1880,20 @@ check_bounds_or_overlap (gcall *call, tree dst, tree src, tree dstsize,\n \n   if (operand_equal_p (dst, src, 0))\n     {\n-      warning_at (loc, OPT_Wrestrict,\n-\t\t  \"%G%qD source argument is the same as destination\",\n-\t\t  call, func);\n-      gimple_set_no_warning (call, true);\n-      return false;\n+      /* Issue -Wrestrict unless the pointers are null (those do\n+\t not point to objects and so do not indicate an overlap;\n+\t such calls could be the result of sanitization and jump\n+\t threading).  */\n+      if (!integer_zerop (dst) && !gimple_no_warning_p (call))\n+\t{\n+\t  warning_at (loc, OPT_Wrestrict,\n+\t\t      \"%G%qD source argument is the same as destination\",\n+\t\t      call, func);\n+\t  gimple_set_no_warning (call, true);\n+\t  return false;\n+\t}\n+\n+      return true;\n     }\n \n   /* Return false when overlap has been detected.  */"}, {"sha": "947b974cab1f8707796f21d2fc3ae1df2e0ae99c", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "patch": "@@ -1,3 +1,8 @@\n+2018-04-20  Martin Sebor  <msebor@redhat.com>\n+\n+\tPR c/85365\n+\t* gcc.dg/Wrestrict-15.c: New test.\n+\n 2018-04-20  Michael Meissner  <meissner@linux.ibm.com>\n \n \tPR target/85456"}, {"sha": "b0b30a2baece9891da8786e50631586ff78b345f", "filename": "gcc/testsuite/gcc.dg/Wrestrict-15.c", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Ftestsuite%2Fgcc.dg%2FWrestrict-15.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/8cd95cec0f5bde4d78dd26778f6070b3bdda6672/gcc%2Ftestsuite%2Fgcc.dg%2FWrestrict-15.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2FWrestrict-15.c?ref=8cd95cec0f5bde4d78dd26778f6070b3bdda6672", "patch": "@@ -0,0 +1,38 @@\n+/* PR 85365 - -Wrestrict false positives with -fsanitize=undefined\n+   { dg-do compile }\n+   { dg-options \"-O2 -Wrestrict -fsanitize=undefined\" } */\n+\n+typedef __SIZE_TYPE__ size_t;\n+\n+char *strcpy (char *, const char *);\n+char *strcat (char *, const char *);\n+\n+size_t strlen (char *);\n+\n+extern char a[], b[], d[];\n+\n+size_t t1 (char *g, int i)\n+{\n+  /* The following exercises the handling in gimple-fold.c.  */\n+  strcpy (g + 4, i ? b : a);    /* { dg-bogus \"\\\\\\[-Wrestrict]\" } */\n+  return strlen (g + 4);\n+}\n+\n+void t2 (char *g, int i)\n+{\n+  strcpy (g + 4, i ? b : a);    /* { dg-bogus \"\\\\\\[-Wrestrict]\" } */\n+  strcat (g + 4, d);\n+}\n+\n+void t3 (char *g, int i)\n+{\n+  /* The following exercises the handling in gimple-ssa-warn-restrict.c.  */\n+  strcat (g + 4, i ? b : a);    /* { dg-bogus \"\\\\\\[-Wrestrict]\" } */\n+  strcat (g + 4, d);\n+}\n+\n+void t4 (char *p, char *q)\n+{\n+  strcpy (p, q);                /* { dg-bogus \"\\\\\\[-Wrestrict]\" } */\n+  strcat (p, q + 32);\n+}"}]}