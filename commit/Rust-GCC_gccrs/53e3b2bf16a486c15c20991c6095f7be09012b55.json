{"sha": "53e3b2bf16a486c15c20991c6095f7be09012b55", "node_id": "C_kwDOANBUbNoAKDUzZTNiMmJmMTZhNDg2YzE1YzIwOTkxYzYwOTVmN2JlMDkwMTJiNTU", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2022-08-09T11:59:36Z"}, "committer": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2022-08-10T11:12:23Z"}, "message": "lto: support --jobserver-style=fifo for recent GNU make\n\ngcc/ChangeLog:\n\n\t* opts-jobserver.h: Add one member.\n\t* opts-common.cc (jobserver_info::jobserver_info): Parse FIFO\n\tformat of --jobserver-auth.", "tree": {"sha": "0cee0eea3b24ffd003f90559d788411079a5439e", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/0cee0eea3b24ffd003f90559d788411079a5439e"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/53e3b2bf16a486c15c20991c6095f7be09012b55", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/53e3b2bf16a486c15c20991c6095f7be09012b55", "html_url": "https://github.com/Rust-GCC/gccrs/commit/53e3b2bf16a486c15c20991c6095f7be09012b55", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/53e3b2bf16a486c15c20991c6095f7be09012b55/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1270ccda70ca09f7d4fe76b5156dca8992bd77a6", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1270ccda70ca09f7d4fe76b5156dca8992bd77a6", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1270ccda70ca09f7d4fe76b5156dca8992bd77a6"}], "stats": {"total": 19, "additions": 17, "deletions": 2}, "files": [{"sha": "c2993f9140a8808cb271fe6900637841f3445b0a", "filename": "gcc/opts-common.cc", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/53e3b2bf16a486c15c20991c6095f7be09012b55/gcc%2Fopts-common.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/53e3b2bf16a486c15c20991c6095f7be09012b55/gcc%2Fopts-common.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fopts-common.cc?ref=53e3b2bf16a486c15c20991c6095f7be09012b55", "patch": "@@ -2010,8 +2010,14 @@ void prepend_xassembler_to_collect_as_options (const char *collect_as_options,\n \n jobserver_info::jobserver_info ()\n {\n+  /* Traditionally, GNU make uses opened pipes for jobserver-auth,\n+    e.g. --jobserver-auth=3,4.\n+    Starting with GNU make 4.4, one can use --jobserver-style=fifo\n+    and then named pipe is used: --jobserver-auth=fifo:/tmp/hcsparta.  */\n+\n   /* Detect jobserver and drop it if it's not working.  */\n   string js_needle = \"--jobserver-auth=\";\n+  string fifo_prefix = \"fifo:\";\n \n   const char *envval = getenv (\"MAKEFLAGS\");\n   if (envval != NULL)\n@@ -2020,8 +2026,15 @@ jobserver_info::jobserver_info ()\n       size_t n = makeflags.rfind (js_needle);\n       if (n != string::npos)\n \t{\n-\t  if (sscanf (makeflags.c_str () + n + js_needle.size (),\n-\t\t      \"%d,%d\", &rfd, &wfd) == 2\n+\t  string ending = makeflags.substr (n + js_needle.size ());\n+\t  if (ending.find (fifo_prefix) == 0)\n+\t    {\n+\t      ending = ending.substr (fifo_prefix.size ());\n+\t      pipe_path = ending.substr (0, ending.find (' '));\n+\t      is_active = true;\n+\t    }\n+\t  else if (sscanf (makeflags.c_str () + n + js_needle.size (),\n+\t\t\t   \"%d,%d\", &rfd, &wfd) == 2\n \t      && rfd > 0\n \t      && wfd > 0\n \t      && is_valid_fd (rfd)"}, {"sha": "98ea2579962643aee512b410fc9161ff201a45e0", "filename": "gcc/opts-jobserver.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/53e3b2bf16a486c15c20991c6095f7be09012b55/gcc%2Fopts-jobserver.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/53e3b2bf16a486c15c20991c6095f7be09012b55/gcc%2Fopts-jobserver.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fopts-jobserver.h?ref=53e3b2bf16a486c15c20991c6095f7be09012b55", "patch": "@@ -37,6 +37,8 @@ struct jobserver_info\n   int rfd = -1;\n   /* File descriptor for writing used for jobserver communication.  */\n   int wfd = -1;\n+  /* Named pipe path.  */\n+  string pipe_path = \"\";\n   /* Return true if jobserver is active.  */\n   bool is_active = false;\n };"}]}