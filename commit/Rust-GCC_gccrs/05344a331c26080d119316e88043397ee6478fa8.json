{"sha": "05344a331c26080d119316e88043397ee6478fa8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MDUzNDRhMzMxYzI2MDgwZDExOTMxNmU4ODA0MzM5N2VlNjQ3OGZhOA==", "commit": {"author": {"name": "Hristian Kirtchev", "email": "kirtchev@adacore.com", "date": "2018-01-11T08:50:34Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-01-11T08:50:34Z"}, "message": "[Ada] Missing finalization in case expression\n\nThis patch modifies the processing of controlled transient objects within case\nexpressions represented by an Expression_With_Actions node. The inspection of\nan individual action must continue in case it denotes a complex expression,\nsuch as a case statement, which in turn may contain additional transients.\n\n------------\n-- Source --\n------------\n\n--  pack.ads\n\nwith Ada.Finalization; use Ada.Finalization;\n\npackage Pack is\n   function Next_Id return Natural;\n\n   type Ctrl is new Controlled with record\n      Id : Natural := 0;\n   end record;\n\n   procedure Adjust (Obj : in out Ctrl);\n   procedure Finalize (Obj : in out Ctrl);\n   procedure Initialize (Obj : in out Ctrl);\n\n   function New_Ctrl return Ctrl;\n\n   Empty : constant Ctrl := (Controlled with Id => 1);\n\n   type Enum is (One, Two, Three);\n\n   type Ctrl_Rec is record\n      Comp : Ctrl;\n      Kind : Enum;\n   end record;\n\n   procedure Proc (Obj : Ctrl_Rec);\nend Pack;\n\n--  pack.adb\n\nwith Ada.Text_IO; use Ada.Text_IO;\n\npackage body Pack is\n   Id_Gen : Natural := 1;\n\n   procedure Adjust (Obj : in out Ctrl) is\n      Old_Id : constant Natural := Obj.Id;\n      New_Id : Natural;\n\n   begin\n      if Old_Id = 0 then\n         Put_Line (\"  adj: ERROR already finalized\");\n      else\n         New_Id := Old_Id * 100;\n         Put_Line (\"  adj: \" & Old_Id'Img & \" ->\" & New_Id'Img);\n         Obj.Id := New_Id;\n      end if;\n   end Adjust;\n\n   procedure Finalize (Obj : in out Ctrl) is\n      Old_Id : constant Natural := Obj.Id;\n\n   begin\n      if Old_Id = 0 then\n         Put_Line (\"  fin: ERROR already finalized\");\n      else\n         Put_Line (\"  fin: \" & Old_Id'Img);\n         Obj.Id := 0;\n      end if;\n   end Finalize;\n\n   procedure Initialize (Obj : in out Ctrl) is\n      New_Id : constant Natural := Next_Id;\n   begin\n      Put_Line (\"  ini: \" & New_Id'Img);\n      Obj.Id := New_Id;\n   end Initialize;\n\n   procedure Proc (Obj : Ctrl_Rec) is\n   begin\n      Put_Line (\"proc : \" & Obj.Comp.Id'Img);\n   end Proc;\n\n   function Next_Id return Natural is\n   begin\n      Id_Gen := Id_Gen + 1;\n      return Id_Gen;\n   end Next_Id;\n\n   function New_Ctrl return Ctrl is\n      Obj : Ctrl;\n   begin\n      return Obj;\n   end New_Ctrl;\nend Pack;\n\n--  main.adb\n\nwith Ada.Text_IO; use Ada.Text_IO;\nwith Pack;        use Pack;\n\nprocedure Main is\n   procedure Proc_Case_Expr (Mode : Enum) is\n   begin\n      Put_Line (\"proc_case_expr: \" & Mode'Img);\n      Proc (case Mode is\n               when One   => (Kind => Two,   Comp => Empty),\n               when Two   => (Kind => Three, Comp => Empty),\n               when Three => (Kind => One,   Comp => New_Ctrl));\n   end Proc_Case_Expr;\n\n   procedure Proc_If_Expr (Mode : Enum) is\n   begin\n      Put_Line (\"proc_if_expr: \" & Mode'Img);\n      Proc ((if    Mode = One then (Kind => Two,   Comp => Empty)\n             elsif Mode = Two then (Kind => Three, Comp => Empty)\n             else                  (Kind => One,   Comp => New_Ctrl)));\n   end Proc_If_Expr;\n\nbegin\n   Proc_Case_Expr (One);\n   Proc_Case_Expr (Two);\n   Proc_Case_Expr (Three);\n\n   Proc_If_Expr (One);\n   Proc_If_Expr (Two);\n   Proc_If_Expr (Three);\nend Main;\n\n----------------------------\n-- Compilation and output --\n----------------------------\n\n$ gnatmake -q main.adb\n$ ./main\nproc_case_expr: ONE\n  adj:  1 -> 100\nproc :  100\n  fin:  100\nproc_case_expr: TWO\n  adj:  1 -> 100\nproc :  100\n  fin:  100\nproc_case_expr: THREE\n  ini:  2\n  adj:  2 -> 200\n  fin:  2\n  adj:  200 -> 20000\nproc :  20000\n  fin:  20000\n  fin:  200\nproc_if_expr: ONE\n  adj:  1 -> 100\nproc :  100\n  fin:  100\nproc_if_expr: TWO\n  adj:  1 -> 100\nproc :  100\n  fin:  100\nproc_if_expr: THREE\n  ini:  3\n  adj:  3 -> 300\n  fin:  3\n  adj:  300 -> 30000\nproc :  30000\n  fin:  30000\n  fin:  300\n  fin:  1\n\n2018-01-11  Hristian Kirtchev  <kirtchev@adacore.com>\n\ngcc/ada/\n\n\t* exp_ch4.adb (Process_Action): Do not abandon the inspection of an\n\tindividual action because the action may denote a complex expression,\n\tsuch as a case statement, which in turn may contain additional\n\ttransient objects.\n\nFrom-SVN: r256486", "tree": {"sha": "2c2093459f72b6145d01a182d52cfad3dea983a0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2c2093459f72b6145d01a182d52cfad3dea983a0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/05344a331c26080d119316e88043397ee6478fa8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/05344a331c26080d119316e88043397ee6478fa8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/05344a331c26080d119316e88043397ee6478fa8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/05344a331c26080d119316e88043397ee6478fa8/comments", "author": {"login": "kirtchev-adacore", "id": 60669983, "node_id": "MDQ6VXNlcjYwNjY5OTgz", "avatar_url": "https://avatars.githubusercontent.com/u/60669983?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kirtchev-adacore", "html_url": "https://github.com/kirtchev-adacore", "followers_url": "https://api.github.com/users/kirtchev-adacore/followers", "following_url": "https://api.github.com/users/kirtchev-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/kirtchev-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/kirtchev-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kirtchev-adacore/subscriptions", "organizations_url": "https://api.github.com/users/kirtchev-adacore/orgs", "repos_url": "https://api.github.com/users/kirtchev-adacore/repos", "events_url": "https://api.github.com/users/kirtchev-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/kirtchev-adacore/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d940c627e077379a534d69025f6a962f8caf4b39", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d940c627e077379a534d69025f6a962f8caf4b39", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d940c627e077379a534d69025f6a962f8caf4b39"}], "stats": {"total": 9, "additions": 8, "deletions": 1}, "files": [{"sha": "07705c5991bd33f21c4ad9b47cd877e2708eb44f", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05344a331c26080d119316e88043397ee6478fa8/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05344a331c26080d119316e88043397ee6478fa8/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=05344a331c26080d119316e88043397ee6478fa8", "patch": "@@ -1,3 +1,10 @@\n+2018-01-11  Hristian Kirtchev  <kirtchev@adacore.com>\n+\n+\t* exp_ch4.adb (Process_Action): Do not abandon the inspection of an\n+\tindividual action because the action may denote a complex expression,\n+\tsuch as a case statement, which in turn may contain additional\n+\ttransient objects.\n+\n 2018-01-11  Ed Schonberg  <schonberg@adacore.com>\n \n \t* sem_aggr.adb (Resolve_Iterated_Component_Association): Perform"}, {"sha": "42cac26679cc6ca4a52252a7557d573ab616bb3c", "filename": "gcc/ada/exp_ch4.adb", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/05344a331c26080d119316e88043397ee6478fa8/gcc%2Fada%2Fexp_ch4.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/05344a331c26080d119316e88043397ee6478fa8/gcc%2Fada%2Fexp_ch4.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch4.adb?ref=05344a331c26080d119316e88043397ee6478fa8", "patch": "@@ -5340,7 +5340,7 @@ package body Exp_Ch4 is\n            and then Is_Finalizable_Transient (Act, N)\n          then\n             Process_Transient_In_Expression (Act, N, Acts);\n-            return Abandon;\n+            return Skip;\n \n          --  Avoid processing temporary function results multiple times when\n          --  dealing with nested expression_with_actions."}]}