{"sha": "71140fc6ca792f3666e126b5eec4640193741ae2", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzExNDBmYzZjYTc5MmYzNjY2ZTEyNmI1ZWVjNDY0MDE5Mzc0MWFlMg==", "commit": {"author": {"name": "Yannick Moy", "email": "moy@adacore.com", "date": "2015-02-05T11:13:41Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2015-02-05T11:13:41Z"}, "message": "opt.ads (Warn_On_Suspicious_Contract): Update comment describing use.\n\n2015-02-05  Yannick Moy  <moy@adacore.com>\n\n\t* opt.ads (Warn_On_Suspicious_Contract): Update comment\n\tdescribing use.\n\t* sem_attr.adb (Analyze_Attribute/Attribute_Update): Warn on\n\tsuspicious uses of 'Update.\n\t* sem_warn.adb, sem_warn.ads (Warn_On_Suspicious_Update): New\n\tfunction issues warning on suspicious uses of 'Update.\n\t* g-rannum.adb, g-rannum.ads, s-rannum.adb, s-rannum.ads: Mark\n\tpackage spec and body as SPARK_Mode Off.\n\nFrom-SVN: r220444", "tree": {"sha": "b79045467ca5b8321023c258eb4ade468927b1d0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b79045467ca5b8321023c258eb4ade468927b1d0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/71140fc6ca792f3666e126b5eec4640193741ae2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/71140fc6ca792f3666e126b5eec4640193741ae2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/71140fc6ca792f3666e126b5eec4640193741ae2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/71140fc6ca792f3666e126b5eec4640193741ae2/comments", "author": {"login": "yannickmoy", "id": 859440, "node_id": "MDQ6VXNlcjg1OTQ0MA==", "avatar_url": "https://avatars.githubusercontent.com/u/859440?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yannickmoy", "html_url": "https://github.com/yannickmoy", "followers_url": "https://api.github.com/users/yannickmoy/followers", "following_url": "https://api.github.com/users/yannickmoy/following{/other_user}", "gists_url": "https://api.github.com/users/yannickmoy/gists{/gist_id}", "starred_url": "https://api.github.com/users/yannickmoy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yannickmoy/subscriptions", "organizations_url": "https://api.github.com/users/yannickmoy/orgs", "repos_url": "https://api.github.com/users/yannickmoy/repos", "events_url": "https://api.github.com/users/yannickmoy/events{/privacy}", "received_events_url": "https://api.github.com/users/yannickmoy/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "e0709184ee6a39837b909cfe57675d46fd8d4ba5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/e0709184ee6a39837b909cfe57675d46fd8d4ba5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/e0709184ee6a39837b909cfe57675d46fd8d4ba5"}], "stats": {"total": 96, "additions": 85, "deletions": 11}, "files": [{"sha": "7ad5878c342dbb500bf4019c1ce21c21029ad7ff", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -1,3 +1,14 @@\n+2015-02-05  Yannick Moy  <moy@adacore.com>\n+\n+\t* opt.ads (Warn_On_Suspicious_Contract): Update comment\n+\tdescribing use.\n+\t* sem_attr.adb (Analyze_Attribute/Attribute_Update): Warn on\n+\tsuspicious uses of 'Update.\n+\t* sem_warn.adb, sem_warn.ads (Warn_On_Suspicious_Update): New\n+\tfunction issues warning on suspicious uses of 'Update.\n+\t* g-rannum.adb, g-rannum.ads, s-rannum.adb, s-rannum.ads: Mark\n+\tpackage spec and body as SPARK_Mode Off.\n+\n 2015-02-05  Robert Dewar  <dewar@adacore.com>\n \n \t* sem_prag.adb (Set_Elab_Unit_Name): New name for Set_Unit_Name"}, {"sha": "39e92e19a31f6dc79a3c55bfd7c8f1120fff7e3c", "filename": "gcc/ada/g-rannum.adb", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fg-rannum.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fg-rannum.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fg-rannum.adb?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 2007-2013, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2007-2015, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -35,7 +35,9 @@ with Ada.Unchecked_Conversion;\n \n with System.Random_Numbers; use System.Random_Numbers;\n \n-package body GNAT.Random_Numbers is\n+package body GNAT.Random_Numbers with\n+  SPARK_Mode => Off\n+is\n \n    Sys_Max_Image_Width : constant := System.Random_Numbers.Max_Image_Width;\n "}, {"sha": "8eadf669a2bad77556fd52b88b5d65670c66b84c", "filename": "gcc/ada/g-rannum.ads", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fg-rannum.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fg-rannum.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fg-rannum.ads?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 2007-2013, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2007-2015, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -47,10 +47,16 @@\n --  Generator type itself suffices for this purpose. The parameter modes on\n --  Reset procedures better reflect the effect of these routines.\n \n+--  Note: this package is marked SPARK_Mode Off, because functions Random work\n+--  by side-effect to change the value of the generator, hence they should not\n+--  be called from SPARK code.\n+\n with System.Random_Numbers;\n with Interfaces; use Interfaces;\n \n-package GNAT.Random_Numbers is\n+package GNAT.Random_Numbers with\n+  SPARK_Mode => Off\n+is\n \n    type Generator is limited private;\n    subtype Initialization_Vector is"}, {"sha": "ceaefd91d32b930235a03b39bc8cacb7f34a8fba", "filename": "gcc/ada/opt.ads", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fopt.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fopt.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fopt.ads?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 1992-2014, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2015, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -1759,7 +1759,9 @@ package Opt is\n    Warn_On_Suspicious_Contract : Boolean := True;\n    --  GNAT\n    --  Set to True to generate warnings for suspicious contracts expressed as\n-   --  pragmas or aspects precondition and postcondition. The default is that\n+   --  pragmas or aspects precondition and postcondition, as well as other\n+   --  suspicious cases of expressions typically found in contracts like\n+   --  quantified expressions and uses of Update attribute. The default is that\n    --  this warning is enabled. Modified by use of -gnatw.t/.T.\n \n    Warn_On_Suspicious_Modulus_Value : Boolean := True;"}, {"sha": "e31a2dca36ed2ad7c6801cb6309fced2df6ffe02", "filename": "gcc/ada/s-rannum.adb", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fs-rannum.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fs-rannum.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-rannum.adb?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 2007-2014, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2007-2015, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -94,7 +94,9 @@ with Interfaces; use Interfaces;\n \n use Ada;\n \n-package body System.Random_Numbers is\n+package body System.Random_Numbers with\n+  SPARK_Mode => Off\n+is\n \n    Image_Numeral_Length : constant := Max_Image_Width / N;\n    subtype Image_String is String (1 .. Max_Image_Width);"}, {"sha": "8331c039c5c027dc8575d8e8d3d016d9f13b575b", "filename": "gcc/ada/s-rannum.ads", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fs-rannum.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fs-rannum.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fs-rannum.ads?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 2007-2013, Free Software Foundation, Inc.         --\n+--          Copyright (C) 2007-2015, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -51,9 +51,15 @@\n --  standard random-number packages Ada.Numerics.Float_Random and\n --  Ada.Numerics.Discrete_Random.\n \n+--  Note: this package is marked SPARK_Mode Off, because functions Random work\n+--  by side-effect to change the value of the generator, hence they should not\n+--  be called from SPARK code.\n+\n with Interfaces;\n \n-package System.Random_Numbers is\n+package System.Random_Numbers with\n+  SPARK_Mode => Off\n+is\n \n    type Generator is limited private;\n    --  Generator encodes the current state of a random number stream, it is"}, {"sha": "3ec6e73003e8553ee6adf2d252c39a6e0b045208", "filename": "gcc/ada/sem_attr.adb", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fsem_attr.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fsem_attr.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_attr.adb?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -62,6 +62,7 @@ with Sem_Eval; use Sem_Eval;\n with Sem_Res;  use Sem_Res;\n with Sem_Type; use Sem_Type;\n with Sem_Util; use Sem_Util;\n+with Sem_Warn;\n with Stand;    use Stand;\n with Sinfo;    use Sinfo;\n with Sinput;   use Sinput;\n@@ -6441,6 +6442,8 @@ package body Sem_Attr is\n          --  The type of attribute 'Update is that of the prefix\n \n          Set_Etype (N, P_Type);\n+\n+         Sem_Warn.Warn_On_Suspicious_Update (N);\n       end Update;\n \n       ---------"}, {"sha": "4cbea2a6ba89f01042a515c2b31c16cd8f69ad26", "filename": "gcc/ada/sem_warn.adb", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fsem_warn.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fsem_warn.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_warn.adb?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -3930,6 +3930,40 @@ package body Sem_Warn is\n       end if;\n    end Warn_On_Suspicious_Index;\n \n+   -------------------------------\n+   -- Warn_On_Suspicious_Update --\n+   -------------------------------\n+\n+   procedure Warn_On_Suspicious_Update (N : Node_Id) is\n+      Par : constant Node_Id := Parent (N);\n+      Arg : Node_Id;\n+\n+   begin\n+      --  Only process if warnings activated\n+\n+      if Warn_On_Suspicious_Contract then\n+         if Nkind_In (Par, N_Op_Eq, N_Op_Ne) then\n+            if N = Left_Opnd (Par) then\n+               Arg := Right_Opnd (Par);\n+            else\n+               Arg := Left_Opnd (Par);\n+            end if;\n+\n+            if Same_Object (Prefix (N), Arg) then\n+               if Nkind (Par) = N_Op_Eq then\n+                  Error_Msg_N\n+                    (\"suspicious equality test with modified version of \"\n+                     & \"same object?T?\", Par);\n+               else\n+                  Error_Msg_N\n+                    (\"suspicious inequality test with modified version of \"\n+                     & \"same object?T?\", Par);\n+               end if;\n+            end if;\n+         end if;\n+      end if;\n+   end Warn_On_Suspicious_Update;\n+\n    --------------------------------------\n    -- Warn_On_Unassigned_Out_Parameter --\n    --------------------------------------"}, {"sha": "c441f28b88953fd0acf2660dc16d7219440e1f31", "filename": "gcc/ada/sem_warn.ads", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fsem_warn.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/71140fc6ca792f3666e126b5eec4640193741ae2/gcc%2Fada%2Fsem_warn.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_warn.ads?ref=71140fc6ca792f3666e126b5eec4640193741ae2", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 S p e c                                  --\n --                                                                          --\n---          Copyright (C) 1999-2014, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1999-2015, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -214,6 +214,14 @@ package Sem_Warn is\n    --  a warning is generated that the subscripting operation is possibly\n    --  incorrectly assuming a lower bound of 1.\n \n+   procedure Warn_On_Suspicious_Update (N : Node_Id);\n+   --  N is a semantically analyzed attribute reference Prefix'Update. Issue\n+   --  a warning if Warn_On_Suspicious_Contract is set, and N is the left-hand\n+   --  side or right-hand side of an equality or disequality of the form:\n+   --    Prefix = Prefix'Update(...)\n+   --  or\n+   --    Prefix'Update(...) = Prefix\n+\n    procedure Warn_On_Unassigned_Out_Parameter\n      (Return_Node : Node_Id;\n       Scope_Id    : Entity_Id);"}]}