{"sha": "160826fefd78b57a02adb87f9977b7fb31095084", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MTYwODI2ZmVmZDc4YjU3YTAyYWRiODdmOTk3N2I3ZmIzMTA5NTA4NA==", "commit": {"author": {"name": "Alan Modra", "email": "amodra@gmail.com", "date": "2017-10-24T12:45:01Z"}, "committer": {"name": "Alan Modra", "email": "amodra@gcc.gnu.org", "date": "2017-10-24T12:45:01Z"}, "message": "PR82687, g++.dg/asan/default-options-1.C fails with PR82575 fix\n\nThe problem with making discarded symbols hidden is that the\nnon-default visibility is sticky.  When symbols other than the\n__gnu_lto ones are discarded that turns out to be a bad idea.\n\n\tPR lto/82687\n\tPR lto/82575\n\t* simple-object-elf.c (simple_object_elf_copy_lto_debug_sections):\n\tOnly make __gnu_lto symbols hidden.  Delete outdated comment.\n\tSilence ISO C warning.\n\nFrom-SVN: r254042", "tree": {"sha": "c72d263dff68680ad25620e43d5d51f190ada7b0", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/c72d263dff68680ad25620e43d5d51f190ada7b0"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/160826fefd78b57a02adb87f9977b7fb31095084", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/160826fefd78b57a02adb87f9977b7fb31095084", "html_url": "https://github.com/Rust-GCC/gccrs/commit/160826fefd78b57a02adb87f9977b7fb31095084", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/160826fefd78b57a02adb87f9977b7fb31095084/comments", "author": {"login": "amodra", "id": 6006325, "node_id": "MDQ6VXNlcjYwMDYzMjU=", "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amodra", "html_url": "https://github.com/amodra", "followers_url": "https://api.github.com/users/amodra/followers", "following_url": "https://api.github.com/users/amodra/following{/other_user}", "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}", "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amodra/subscriptions", "organizations_url": "https://api.github.com/users/amodra/orgs", "repos_url": "https://api.github.com/users/amodra/repos", "events_url": "https://api.github.com/users/amodra/events{/privacy}", "received_events_url": "https://api.github.com/users/amodra/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "6a19d2a2ee10ae74b77e3f2c0d85be2cda38cd54", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a19d2a2ee10ae74b77e3f2c0d85be2cda38cd54", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6a19d2a2ee10ae74b77e3f2c0d85be2cda38cd54"}], "stats": {"total": 36, "additions": 26, "deletions": 10}, "files": [{"sha": "eb3cbc1819dfc940c02b886e05e389e57d8c806a", "filename": "libiberty/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/160826fefd78b57a02adb87f9977b7fb31095084/libiberty%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/160826fefd78b57a02adb87f9977b7fb31095084/libiberty%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libiberty%2FChangeLog?ref=160826fefd78b57a02adb87f9977b7fb31095084", "patch": "@@ -1,3 +1,10 @@\n+2017-10-24  Alan Modra  <amodra@gmail.com>\n+\n+\tPR lto/82687\n+\tPR lto/82575\n+\t* simple-object-elf.c (simple_object_elf_copy_lto_debug_sections):\n+\tOnly make __gnu_lto symbols hidden.\n+\n 2017-10-20  Alan Modra  <amodra@gmail.com>\n \n \tPR lto/82575"}, {"sha": "14f71053150890aecc8d500ac0e8f1f493bbe71b", "filename": "libiberty/simple-object-elf.c", "status": "modified", "additions": 19, "deletions": 10, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/160826fefd78b57a02adb87f9977b7fb31095084/libiberty%2Fsimple-object-elf.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/160826fefd78b57a02adb87f9977b7fb31095084/libiberty%2Fsimple-object-elf.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libiberty%2Fsimple-object-elf.c?ref=160826fefd78b57a02adb87f9977b7fb31095084", "patch": "@@ -1088,6 +1088,7 @@ simple_object_elf_copy_lto_debug_sections (simple_object_read *sobj,\n   off_t shstroff;\n   unsigned char *names;\n   unsigned int i;\n+  int changed;\n   int *pfnret;\n   const char **pfnname;\n \n@@ -1161,7 +1162,6 @@ simple_object_elf_copy_lto_debug_sections (simple_object_read *sobj,\n \n   /* Mark sections as preserved that are required by to be preserved\n      sections.  */\n-  int changed;\n   do\n     {\n       changed = 0;\n@@ -1349,9 +1349,6 @@ simple_object_elf_copy_lto_debug_sections (simple_object_read *sobj,\n \t\t     and __gnu_lto_slim which otherwise cause endless\n \t\t     LTO plugin invocation.  */\n \t\t  if (st_shndx == SHN_COMMON)\n-\t\t    /* Setting st_name to \"\" seems to work to purge\n-\t\t       COMMON symbols (in addition to setting their\n-\t\t       size to zero).  */\n \t\t    discard = 1;\n \t\t  /* We also need to remove symbols refering to sections\n \t\t     we'll eventually remove as with fat LTO objects\n@@ -1368,17 +1365,29 @@ simple_object_elf_copy_lto_debug_sections (simple_object_read *sobj,\n \t\t      /* Make discarded symbols undefined and unnamed\n \t\t         in case it is local.  */\n \t\t      int bind = ELF_ST_BIND (*st_info);\n+\t\t      int other = STV_DEFAULT;\n+\t\t      size_t st_name;\n+\n \t\t      if (bind == STB_LOCAL)\n-\t\t\t{\n-\t\t\t  ELF_SET_FIELD (type_functions, ei_class, Sym,\n-\t\t\t\t\t ent, st_name, Elf_Word, 0);\n-\t\t\t  *st_other = STV_DEFAULT;\n-\t\t\t}\n+\t\t\tELF_SET_FIELD (type_functions, ei_class, Sym,\n+\t\t\t\t       ent, st_name, Elf_Word, 0);\n \t\t      else\n \t\t\t{\n \t\t\t  bind = STB_WEAK;\n-\t\t\t  *st_other = STV_HIDDEN;\n+\t\t\t  st_name = ELF_FETCH_FIELD (type_functions, ei_class,\n+\t\t\t\t\t\t     Sym, ent, st_name,\n+\t\t\t\t\t\t     Elf_Word);\n+\t\t\t  if (st_name < strsz)\n+\t\t\t    {\n+\t\t\t      char *p = strings + st_name;\n+\t\t\t      if (p[0] == '_'\n+\t\t\t\t  && p[1] == '_'\n+\t\t\t\t  && strncmp (p + (p[2] == '_'),\n+\t\t\t\t\t      \"__gnu_lto_\", 10) == 0)\n+\t\t\t\tother = STV_HIDDEN;\n+\t\t\t    }\n \t\t\t}\n+\t\t      *st_other = other;\n \t\t      *st_info = ELF_ST_INFO (bind, STT_NOTYPE);\n \t\t      ELF_SET_FIELD (type_functions, ei_class, Sym,\n \t\t\t\t     ent, st_value, Elf_Addr, 0);"}]}