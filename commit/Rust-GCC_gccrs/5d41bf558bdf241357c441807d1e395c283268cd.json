{"sha": "5d41bf558bdf241357c441807d1e395c283268cd", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWQ0MWJmNTU4YmRmMjQxMzU3YzQ0MTgwN2QxZTM5NWMyODMyNjhjZA==", "commit": {"author": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2008-08-22T08:54:46Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2008-08-22T08:54:46Z"}, "message": "make.adb (Check.File_Not_A_Source_Of): New Boolean function\n\n2008-08-22  Vincent Celier  <celier@adacore.com>\n\n\t* make.adb (Check.File_Not_A_Source_Of): New Boolean function\n\t(Check): Check if the file names registered in the ALI file for the\n\tspec, the body and each of the subunits are the ones expected.\n\nFrom-SVN: r139429", "tree": {"sha": "62fddf33fc332f577791b05b0031337a8a0497c4", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/62fddf33fc332f577791b05b0031337a8a0497c4"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5d41bf558bdf241357c441807d1e395c283268cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5d41bf558bdf241357c441807d1e395c283268cd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5d41bf558bdf241357c441807d1e395c283268cd", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5d41bf558bdf241357c441807d1e395c283268cd/comments", "author": null, "committer": null, "parents": [{"sha": "2147ba0cd965d06602063f305afb6102e00f884d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/2147ba0cd965d06602063f305afb6102e00f884d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/2147ba0cd965d06602063f305afb6102e00f884d"}], "stats": {"total": 112, "additions": 88, "deletions": 24}, "files": [{"sha": "ae303656560d3944f426d0822a860ae024d3f2d8", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5d41bf558bdf241357c441807d1e395c283268cd/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5d41bf558bdf241357c441807d1e395c283268cd/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=5d41bf558bdf241357c441807d1e395c283268cd", "patch": "@@ -1,3 +1,18 @@\n+2008-08-22  Sergey Rybin  <rybin@adacore.com>\n+\n+\t* gnat_ugn.texi: Update the gnatcheck subsection for metric rules\n+\tacoording to the latest changes in the metric rule interface\n+\n+2008-08-22  Vincent Celier  <celier@adacore.com>\n+\n+\t* make.adb (Check.File_Not_A_Source_Of): New Boolean function\n+\t(Check): Check if the file names registered in the ALI file for the\n+\tspec, the body and each of the subunits are the ones expected.\n+\n+2008-08-22  Robert Dewar  <dewar@adacore.com>\n+\n+\t* g-catiio.adb: Code cleanup.\n+\n 2008-08-20  Vincent Celier  <celier@adacore.com>\n \n \t* make.adb (Gnatmake): Remove extra space in version line"}, {"sha": "c85e7ff13b2b4e1f524e442b92a85f473f6be273", "filename": "gcc/ada/make.adb", "status": "modified", "additions": 73, "deletions": 24, "changes": 97, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5d41bf558bdf241357c441807d1e395c283268cd/gcc%2Fada%2Fmake.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5d41bf558bdf241357c441807d1e395c283268cd/gcc%2Fada%2Fmake.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fmake.adb?ref=5d41bf558bdf241357c441807d1e395c283268cd", "patch": "@@ -1440,6 +1440,10 @@ package body Make is\n       O_File         : out File_Name_Type;\n       O_Stamp        : out Time_Stamp_Type)\n    is\n+      function File_Not_A_Source_Of\n+        (Uname : Name_Id;\n+         Sfile : File_Name_Type) return Boolean;\n+\n       function First_New_Spec (A : ALI_Id) return File_Name_Type;\n       --  Looks in the with table entries of A and returns the spec file name\n       --  of the first withed unit (subprogram) for which no spec existed when\n@@ -1454,6 +1458,34 @@ package body Make is\n       --  services, but this causes the whole compiler to be dragged along\n       --  for gnatbind and gnatmake.\n \n+      --------------------------\n+      -- File_Not_A_Source_Of --\n+      --------------------------\n+\n+      function File_Not_A_Source_Of\n+        (Uname : Name_Id;\n+         Sfile : File_Name_Type) return Boolean\n+      is\n+         UID    : Prj.Unit_Index;\n+         U_Data : Unit_Data;\n+\n+      begin\n+         UID := Units_Htable.Get (Project_Tree.Units_HT, Uname);\n+\n+         if UID /= Prj.No_Unit_Index then\n+            U_Data := Project_Tree.Units.Table (UID);\n+\n+            if U_Data.File_Names (Body_Part).Name /= Sfile\n+              and then U_Data.File_Names (Specification).Name /= Sfile\n+            then\n+               Verbose_Msg (Uname, \"sources do not include \", Name_Id (Sfile));\n+               return True;\n+            end if;\n+         end if;\n+\n+         return False;\n+      end File_Not_A_Source_Of;\n+\n       --------------------\n       -- First_New_Spec --\n       --------------------\n@@ -1827,22 +1859,37 @@ package body Make is\n                   end if;\n                end if;\n \n-            elsif Main_Project /= No_Project then\n+            elsif not Read_Only and then Main_Project /= No_Project then\n \n                --  Check if a file name does not correspond to the mapping of\n                --  units to file names.\n \n                declare\n+                  SD        : Sdep_Record;\n                   WR        : With_Record;\n                   Unit_Name : Name_Id;\n-                  UID       : Prj.Unit_Index;\n-                  U_Data    : Unit_Data;\n \n                begin\n                   U_Chk :\n                   for U in ALIs.Table (ALI).First_Unit ..\n                            ALIs.Table (ALI).Last_Unit\n                   loop\n+                     --  Check if the file name is one of the source of the\n+                     --  unit.\n+\n+                     Get_Name_String (Units.Table (U).Uname);\n+                     Name_Len := Name_Len - 2;\n+                     Unit_Name := Name_Find;\n+\n+                     if File_Not_A_Source_Of\n+                          (Unit_Name, Units.Table (U).Sfile)\n+                     then\n+                        ALI := No_ALI_Id;\n+                        return;\n+                     end if;\n+\n+                     --  Do the same check for each of the withed units.\n+\n                      W_Check :\n                      for W in Units.Table (U).First_With\n                           ..\n@@ -1855,29 +1902,30 @@ package body Make is\n                            Name_Len := Name_Len - 2;\n                            Unit_Name := Name_Find;\n \n-                           UID := Units_Htable.Get\n-                                   (Project_Tree.Units_HT, Unit_Name);\n-\n-                           if UID /= Prj.No_Unit_Index then\n-                              U_Data := Project_Tree.Units.Table (UID);\n-\n-                              if U_Data.File_Names (Body_Part).Name /= WR.Sfile\n-                                and then\n-                                  U_Data.File_Names (Specification).Name /=\n-                                                                       WR.Sfile\n-                              then\n-                                 ALI := No_ALI_Id;\n-\n-                                 Verbose_Msg\n-                                   (Unit_Name, \" sources do not include \",\n-                                    Name_Id (WR.Sfile));\n-\n-                                 return;\n-                              end if;\n+                           if File_Not_A_Source_Of (Unit_Name, WR.Sfile) then\n+                              ALI := No_ALI_Id;\n+                              return;\n                            end if;\n                         end if;\n                      end loop W_Check;\n                   end loop U_Chk;\n+\n+                  --  Check also the subunits\n+\n+                  D_Check :\n+                  for D in ALIs.Table (ALI).First_Sdep ..\n+                           ALIs.Table (ALI).Last_Sdep\n+                  loop\n+                     SD := Sdep.Table (D);\n+                     Unit_Name := SD.Subunit_Name;\n+\n+                     if Unit_Name /= No_Name then\n+                        if File_Not_A_Source_Of (Unit_Name, SD.Sfile) then\n+                           ALI := No_ALI_Id;\n+                           return;\n+                        end if;\n+                     end if;\n+                  end loop D_Check;\n                end;\n \n                --  Check that the ALI file is in the correct object directory.\n@@ -1931,8 +1979,9 @@ package body Make is\n                   Add_Str_To_Name_Buffer (Res_Obj_Dir);\n \n                   if Name_Len > 1 and then\n-                    (Name_Buffer (Name_Len) = '/' or else\n-                       Name_Buffer (Name_Len) = Directory_Separator)\n+                    (Name_Buffer (Name_Len) = '/'\n+                       or else\n+                     Name_Buffer (Name_Len) = Directory_Separator)\n                   then\n                      Name_Len := Name_Len - 1;\n                   end if;"}]}