{"sha": "6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmM0MmUyN2MxNjViM2VkMWYyYTM4OGVkNzQwOTFjZDVhMThiYmE4NQ==", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2020-01-28T13:09:12Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2020-01-28T13:10:16Z"}, "message": "tree-optimization/93439 move clique bookkeeping to OMP expansion\n\nAutopar was doing clique bookkeeping too early when creating destination\nfunctions but then later introducing new cliques via versioning loops.\nThe following moves the bookkeeping to the actual outlining process.\n\n2020-01-28  Richard Biener  <rguenther@suse.de>\n\n\tPR tree-optimization/93439\n\t* tree-parloops.c (create_loop_fn): Move clique bookkeeping...\n\t* tree-cfg.c (move_sese_region_to_fn): ... here.\n\t(verify_types_in_gimple_reference): Verify used cliques are\n\ttracked.\n\n\t* gfortran.dg/graphite/pr93439.f90: New testcase.", "tree": {"sha": "cd4266a0c8044c650c23ce80eca32662c9c52e4c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/cd4266a0c8044c650c23ce80eca32662c9c52e4c"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e964774aec65472d7a0741d7faa6a884295fc81", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1e964774aec65472d7a0741d7faa6a884295fc81", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1e964774aec65472d7a0741d7faa6a884295fc81"}], "stats": {"total": 52, "additions": 51, "deletions": 1}, "files": [{"sha": "ed3db3e003e5fd6302d3516ead51380ebc7ee5d3", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "patch": "@@ -1,3 +1,11 @@\n+2020-01-28  Richard Biener  <rguenther@suse.de>\n+\n+\tPR tree-optimization/93439\n+\t* tree-parloops.c (create_loop_fn): Move clique bookkeeping...\n+\t* tree-cfg.c (move_sese_region_to_fn): ... here.\n+\t(verify_types_in_gimple_reference): Verify used cliques are\n+\ttracked.\n+\n 2020-01-28  H.J. Lu  <hongjiu.lu@intel.com>\n \n \tPR target/91399"}, {"sha": "dfb7a0fb5b4e72a7b72b471237f59d76f9779a83", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "patch": "@@ -1,3 +1,8 @@\n+2020-01-28  Richard Biener  <rguenther@suse.de>\n+\n+\tPR tree-optimization/93439\n+\t* gfortran.dg/graphite/pr93439.f90: New testcase.\n+\n 2020-01-28  Sahahb Vahedi  <shahab@synopsys.com>\n \n \t* gcc.target/arc/code-density-flag.c: New test"}, {"sha": "e815ab929e15a62acd7e0b99a4733eedf322597e", "filename": "gcc/testsuite/gfortran.dg/graphite/pr93439.f90", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftestsuite%2Fgfortran.dg%2Fgraphite%2Fpr93439.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftestsuite%2Fgfortran.dg%2Fgraphite%2Fpr93439.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgraphite%2Fpr93439.f90?ref=6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "patch": "@@ -0,0 +1,21 @@\n+! { dg-additional-options \"-O2 -floop-parallelize-all -floop-unroll-and-jam -ftree-parallelize-loops=2\" }\n+\n+module ai\n+  integer, parameter :: dp = 8\n+contains\n+  subroutine qu(ja, nq, en, p5)\n+    real(kind = dp) :: nq(ja), en(ja), p5(ja)\n+    call tl(ja, nq, en, p5)\n+  end subroutine qu\n+\n+  subroutine tl(ja, nq, en, p5)\n+    real(kind = dp) :: nq(9), en(9 * ja), p5(3 * ja)\n+    do mc = 1, ja\n+       do mb = 1, 9\n+          do ma = 1, 3\n+             p5((mc - 1) * 3 + ma) = p5((mc - 1) * 3 + ma) - 1\n+          end do\n+       end do\n+    end do\n+  end subroutine tl\n+end module ai"}, {"sha": "f7b817d94e64dfcb943789db3f91ea96cb0b6574", "filename": "gcc/tree-cfg.c", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftree-cfg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftree-cfg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-cfg.c?ref=6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "patch": "@@ -3226,6 +3226,13 @@ verify_types_in_gimple_reference (tree expr, bool require_lvalue)\n \t  debug_generic_stmt (expr);\n \t  return true;\n \t}\n+      if (MR_DEPENDENCE_CLIQUE (expr) != 0\n+\t  && MR_DEPENDENCE_CLIQUE (expr) > cfun->last_clique)\n+\t{\n+\t  error (\"invalid clique in %qs\", code_name);\n+\t  debug_generic_stmt (expr);\n+\t  return true;\n+\t}\n     }\n   else if (TREE_CODE (expr) == TARGET_MEM_REF)\n     {\n@@ -3245,6 +3252,13 @@ verify_types_in_gimple_reference (tree expr, bool require_lvalue)\n \t  debug_generic_stmt (expr);\n \t  return true;\n \t}\n+      if (MR_DEPENDENCE_CLIQUE (expr) != 0\n+\t  && MR_DEPENDENCE_CLIQUE (expr) > cfun->last_clique)\n+\t{\n+\t  error (\"invalid clique in %qs\", code_name);\n+\t  debug_generic_stmt (expr);\n+\t  return true;\n+\t}\n     }\n   else if (TREE_CODE (expr) == INDIRECT_REF)\n     {\n@@ -7744,6 +7758,9 @@ move_sese_region_to_fn (struct function *dest_cfun, basic_block entry_bb,\n       after = bb;\n     }\n \n+  /* Adjust the maximum clique used.  */\n+  dest_cfun->last_clique = saved_cfun->last_clique;\n+\n   loop->aux = NULL;\n   loop0->aux = NULL;\n   /* Loop sizes are no longer correct, fix them up.  */"}, {"sha": "d9250d36c72bdf42204b86277988debcdc7e2b8e", "filename": "gcc/tree-parloops.c", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftree-parloops.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6c42e27c165b3ed1f2a388ed74091cd5a18bba85/gcc%2Ftree-parloops.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-parloops.c?ref=6c42e27c165b3ed1f2a388ed74091cd5a18bba85", "patch": "@@ -2202,7 +2202,6 @@ create_loop_fn (location_t loc)\n   DECL_ARGUMENTS (decl) = t;\n \n   allocate_struct_function (decl, false);\n-  DECL_STRUCT_FUNCTION (decl)->last_clique = act_cfun->last_clique;\n \n   /* The call to allocate_struct_function clobbers CFUN, so we need to restore\n      it.  */"}]}