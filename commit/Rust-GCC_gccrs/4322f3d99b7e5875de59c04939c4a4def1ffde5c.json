{"sha": "4322f3d99b7e5875de59c04939c4a4def1ffde5c", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDMyMmYzZDk5YjdlNTg3NWRlNTljMDQ5MzljNGE0ZGVmMWZmZGU1Yw==", "commit": {"author": {"name": "Javier Miranda", "email": "miranda@adacore.com", "date": "2020-03-03T19:27:18Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2020-06-10T13:34:58Z"}, "message": "[Ada] Classwide controlled obj not dispatching\n\n2020-06-10  Javier Miranda  <miranda@adacore.com>\n\ngcc/ada/\n\n\t* sem_ch3.adb (Analyze_Declarations): Adjust the machinery that\n\ttakes care of late body overriding of initialize, adjust,\n\tfinalize.  Remove ASIS mode code.", "tree": {"sha": "d7c21b2ebb813495d78fc1429ff7667471777f31", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/d7c21b2ebb813495d78fc1429ff7667471777f31"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/4322f3d99b7e5875de59c04939c4a4def1ffde5c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4322f3d99b7e5875de59c04939c4a4def1ffde5c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/4322f3d99b7e5875de59c04939c4a4def1ffde5c", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/4322f3d99b7e5875de59c04939c4a4def1ffde5c/comments", "author": {"login": "miranda-adacore", "id": 54413934, "node_id": "MDQ6VXNlcjU0NDEzOTM0", "avatar_url": "https://avatars.githubusercontent.com/u/54413934?v=4", "gravatar_id": "", "url": "https://api.github.com/users/miranda-adacore", "html_url": "https://github.com/miranda-adacore", "followers_url": "https://api.github.com/users/miranda-adacore/followers", "following_url": "https://api.github.com/users/miranda-adacore/following{/other_user}", "gists_url": "https://api.github.com/users/miranda-adacore/gists{/gist_id}", "starred_url": "https://api.github.com/users/miranda-adacore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/miranda-adacore/subscriptions", "organizations_url": "https://api.github.com/users/miranda-adacore/orgs", "repos_url": "https://api.github.com/users/miranda-adacore/repos", "events_url": "https://api.github.com/users/miranda-adacore/events{/privacy}", "received_events_url": "https://api.github.com/users/miranda-adacore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc419b9f8d6f998186706aa1afa50db1ca7efae5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dc419b9f8d6f998186706aa1afa50db1ca7efae5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dc419b9f8d6f998186706aa1afa50db1ca7efae5"}], "stats": {"total": 32, "additions": 19, "deletions": 13}, "files": [{"sha": "4cddbbe97dbe93d56b2d6414dd1926d289f043b2", "filename": "gcc/ada/sem_ch3.adb", "status": "modified", "additions": 19, "deletions": 13, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/4322f3d99b7e5875de59c04939c4a4def1ffde5c/gcc%2Fada%2Fsem_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/4322f3d99b7e5875de59c04939c4a4def1ffde5c/gcc%2Fada%2Fsem_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fsem_ch3.adb?ref=4322f3d99b7e5875de59c04939c4a4def1ffde5c", "patch": "@@ -2592,12 +2592,10 @@ package body Sem_Ch3 is\n       --  Local variables\n \n       Context     : Node_Id   := Empty;\n+      Ctrl_Typ    : Entity_Id := Empty;\n       Freeze_From : Entity_Id := Empty;\n       Next_Decl   : Node_Id;\n \n-      Body_Seen : Boolean := False;\n-      --  Flag set when the first body [stub] is encountered\n-\n    --  Start of processing for Analyze_Declarations\n \n    begin\n@@ -2613,6 +2611,16 @@ package body Sem_Ch3 is\n             Freeze_From := First_Entity (Current_Scope);\n          end if;\n \n+         --  Remember if the declaration we just processed is the full type\n+         --  declaration of a controlled type (to handle late overriding of\n+         --  initialize, adjust or finalize).\n+\n+         if Nkind (Decl) = N_Full_Type_Declaration\n+           and then Is_Controlled (Defining_Identifier (Decl))\n+         then\n+            Ctrl_Typ := Defining_Identifier (Decl);\n+         end if;\n+\n          --  At the end of a declarative part, freeze remaining entities\n          --  declared in it. The end of the visible declarations of package\n          --  specification is not the end of a declarative part if private\n@@ -2758,19 +2766,17 @@ package body Sem_Ch3 is\n             --  ??? A cleaner approach may be possible and/or this solution\n             --  could be extended to general-purpose late primitives, TBD.\n \n-            if not Body_Seen and then not Is_Body (Decl) then\n-               Body_Seen := True;\n+            if Present (Ctrl_Typ) then\n \n-               if Nkind (Next_Decl) = N_Subprogram_Body then\n-                  Handle_Late_Controlled_Primitive (Next_Decl);\n-               end if;\n+               --  No need to continue searching for late body overriding if\n+               --  the controlled type is already frozen.\n \n-            else\n-               --  In ASIS mode, if the next declaration is a body, complete\n-               --  the analysis of declarations so far.\n-               --  Is this still needed???\n+               if Is_Frozen (Ctrl_Typ) then\n+                  Ctrl_Typ := Empty;\n \n-               Resolve_Aspects;\n+               elsif Nkind (Next_Decl) = N_Subprogram_Body then\n+                  Handle_Late_Controlled_Primitive (Next_Decl);\n+               end if;\n             end if;\n \n             Adjust_Decl;"}]}