{"sha": "715e3349b08decc26a5590a017e85dcf761b0de8", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzE1ZTMzNDliMDhkZWNjMjZhNTU5MGEwMTdlODVkY2Y3NjFiMGRlOA==", "commit": {"author": {"name": "Johan Karlsson", "email": "johan.karlsson@enea.com", "date": "2019-03-25T21:19:09Z"}, "committer": {"name": "Jeff Law", "email": "law@gcc.gnu.org", "date": "2019-03-25T21:19:09Z"}, "message": "re PR debug/86964 (Too many debug symbols included, especially for extern globals)\n\n\tPR debug/86964\n\t* dwarf2out.c (premark_used_variables): New function.\n\t(prune_unused_types_walk): Do not mark not premarked external\n\tvariables.\n\t(prune_unused_types): Call premark_used_variables.\n\n\t* gcc.dg/debug/dwarf2/pr86964.c: New testcase.\n\nFrom-SVN: r269925", "tree": {"sha": "8adb95f6f51f4871997545830de9c9c7f9243b51", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8adb95f6f51f4871997545830de9c9c7f9243b51"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/715e3349b08decc26a5590a017e85dcf761b0de8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/715e3349b08decc26a5590a017e85dcf761b0de8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/715e3349b08decc26a5590a017e85dcf761b0de8", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/715e3349b08decc26a5590a017e85dcf761b0de8/comments", "author": null, "committer": null, "parents": [{"sha": "33163a622d9f334e862078419782e3d967bb3db3", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/33163a622d9f334e862078419782e3d967bb3db3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/33163a622d9f334e862078419782e3d967bb3db3"}], "stats": {"total": 59, "additions": 59, "deletions": 0}, "files": [{"sha": "cdce539ac6f4234ccb80ac50244cf4d14995db07", "filename": "gcc/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=715e3349b08decc26a5590a017e85dcf761b0de8", "patch": "@@ -1,3 +1,11 @@\n+2019-03-25  Johan Karlsson <johan.karlsson@enea.com>\n+\n+\tPR debug/86964\n+\t* dwarf2out.c (premark_used_variables): New function.\n+\t(prune_unused_types_walk): Do not mark not premarked external\n+\tvariables.\n+\t(prune_unused_types): Call premark_used_variables.\n+\n 2019-03-25  Vladimir Makarov  <vmakarov@redhat.com>\n \n \tPR rtl-optimization/89676"}, {"sha": "b9a624e1ac7fadffbdd82c12d18a3785b6483e20", "filename": "gcc/dwarf2out.c", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2Fdwarf2out.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2Fdwarf2out.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdwarf2out.c?ref=715e3349b08decc26a5590a017e85dcf761b0de8", "patch": "@@ -22732,6 +22732,21 @@ premark_types_used_by_global_vars (void)\n       ->traverse<void *, premark_types_used_by_global_vars_helper> (NULL);\n }\n \n+/* Mark all variables used by the symtab as perennial.  */\n+\n+static void\n+premark_used_variables (void)\n+{\n+  /* Mark DIEs in the symtab as used.  */\n+  varpool_node *var;\n+  FOR_EACH_VARIABLE (var)\n+    {\n+      dw_die_ref die = lookup_decl_die (var->decl);\n+      if (die)\n+\tdie->die_perennial_p = 1;\n+    }\n+}\n+\n /* Generate a DW_TAG_call_site DIE in function DECL under SUBR_DIE\n    for CA_LOC call arg loc node.  */\n \n@@ -29394,6 +29409,19 @@ prune_unused_types_walk (dw_die_ref die)\n \n       return;\n \n+    case DW_TAG_variable:\n+      if (flag_debug_only_used_symbols)\n+\t{\n+\t  if (die->die_perennial_p)\n+\t    break;\n+\n+\t  /* premark_used_variables marks external variables --- don't mark\n+\t     them here.  */\n+\t  if (get_AT (die, DW_AT_external))\n+\t    return;\n+\t}\n+      /* FALLTHROUGH */\n+\n     default:\n       /* Mark everything else.  */\n       break;\n@@ -29520,6 +29548,10 @@ prune_unused_types (void)\n   /* Mark types that are used in global variables.  */\n   premark_types_used_by_global_vars ();\n \n+  /* Mark variables used in the symtab.  */\n+  if (flag_debug_only_used_symbols)\n+    premark_used_variables ();\n+\n   /* Set the mark on nodes that are actually used.  */\n   prune_unused_types_walk (comp_unit_die ());\n   for (node = limbo_die_list; node; node = node->next)"}, {"sha": "7a0c4bc5edc35e1019ea55ca37f304ad3cb2351b", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=715e3349b08decc26a5590a017e85dcf761b0de8", "patch": "@@ -1,3 +1,8 @@\n+2019-03-25  Johan Karlsson <johan.karlsson@enea.com>\n+\n+\tPR debug/86964\n+\t* gcc.dg/debug/dwarf2/pr86964.c: New testcase.\n+\n 2019-03-25  Paolo Carlini  <paolo.carlini@oracle.com>\n \n \tPR c++/84661"}, {"sha": "b52a06ee126c7782f3bc1cc3d42b856ddd4ca65c", "filename": "gcc/testsuite/gcc.dg/debug/dwarf2/pr86964.c", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2Ftestsuite%2Fgcc.dg%2Fdebug%2Fdwarf2%2Fpr86964.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/715e3349b08decc26a5590a017e85dcf761b0de8/gcc%2Ftestsuite%2Fgcc.dg%2Fdebug%2Fdwarf2%2Fpr86964.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fdebug%2Fdwarf2%2Fpr86964.c?ref=715e3349b08decc26a5590a017e85dcf761b0de8", "patch": "@@ -0,0 +1,14 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2 -gdwarf -feliminate-unused-debug-symbols -dA\" } */\n+\n+struct S { int i; };\n+extern struct S x;\n+int y;\n+int main()\n+{\n+  return y;\n+}\n+\n+/* We should elide the DIEs for x and S but not y.  */\n+/* { dg-final { scan-assembler-times \"DW_TAG_variable\" 2 } } */\n+/* { dg-final { scan-assembler-not \"DW_TAG_structure_type\" } } */"}]}