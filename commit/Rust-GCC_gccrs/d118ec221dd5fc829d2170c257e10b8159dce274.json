{"sha": "d118ec221dd5fc829d2170c257e10b8159dce274", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZDExOGVjMjIxZGQ1ZmM4MjlkMjE3MGMyNTdlMTBiODE1OWRjZTI3NA==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-04-08T16:31:04Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2021-04-10T13:02:07Z"}, "message": "libphobos: Build runtime library with -ffunction-sections -fdata-sections\n\nTests for `-ffunction-sections -fdata-sections' and sets SECTION_FLAGS\naccordingly.  If there is no warning when using it, take advantage of\nthe smaller executables that can be had with `--gc-sections'.\n\nlibphobos/ChangeLog:\n\n\t* Makefile.in: Regenerate.\n\t* configure: Regenerate.\n\t* configure.ac: Call DRUNTIME_SECTION_FLAGS.\n\t* libdruntime/Makefile.am: Add SECTION_FLAGS to AM_DFLAGS.\n\t* libdruntime/Makefile.in: Regenerate.\n\t* m4/druntime.m4 (DRUNTIME_SECTION_FLAGS): New macro.\n\t* src/Makefile.am: Add SECTION_FLAGS to AM_DFLAGS.\n\t* src/Makefile.in: Regenerate.\n\t* testsuite/Makefile.in: Regenerate.", "tree": {"sha": "8ff5b8c0b68632ea682e8765ed30f7b93a5e8581", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8ff5b8c0b68632ea682e8765ed30f7b93a5e8581"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/d118ec221dd5fc829d2170c257e10b8159dce274", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d118ec221dd5fc829d2170c257e10b8159dce274", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d118ec221dd5fc829d2170c257e10b8159dce274", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d118ec221dd5fc829d2170c257e10b8159dce274/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "32703b80f66f7ca504eb79bee7e745f22cf096a8", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32703b80f66f7ca504eb79bee7e745f22cf096a8", "html_url": "https://github.com/Rust-GCC/gccrs/commit/32703b80f66f7ca504eb79bee7e745f22cf096a8"}], "stats": {"total": 79, "additions": 73, "deletions": 6}, "files": [{"sha": "a8f7e1607429c58d3a4a15fda709f279f783cdce", "filename": "libphobos/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2FMakefile.in?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -271,6 +271,7 @@ PACKAGE_URL = @PACKAGE_URL@\n PACKAGE_VERSION = @PACKAGE_VERSION@\n PATH_SEPARATOR = @PATH_SEPARATOR@\n RANLIB = @RANLIB@\n+SECTION_FLAGS = @SECTION_FLAGS@\n SED = @SED@\n SET_MAKE = @SET_MAKE@\n SHELL = @SHELL@"}, {"sha": "fe7cd9c11ff5357c937d354d9e087e6c74c5694f", "filename": "libphobos/configure", "status": "modified", "additions": 45, "deletions": 2, "changes": 47, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fconfigure", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fconfigure", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fconfigure?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -700,6 +700,7 @@ DRUNTIME_CPU_ARM_FALSE\n DRUNTIME_CPU_ARM_TRUE\n DRUNTIME_CPU_AARCH64_FALSE\n DRUNTIME_CPU_AARCH64_TRUE\n+SECTION_FLAGS\n libphobos_srcdir\n libphobos_builddir\n get_gcc_base_ver\n@@ -11749,7 +11750,7 @@ else\n   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2\n   lt_status=$lt_dlunknown\n   cat > conftest.$ac_ext <<_LT_EOF\n-#line 11752 \"configure\"\n+#line 11753 \"configure\"\n #include \"confdefs.h\"\n \n #if HAVE_DLFCN_H\n@@ -11855,7 +11856,7 @@ else\n   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2\n   lt_status=$lt_dlunknown\n   cat > conftest.$ac_ext <<_LT_EOF\n-#line 11858 \"configure\"\n+#line 11859 \"configure\"\n #include \"confdefs.h\"\n \n #if HAVE_DLFCN_H\n@@ -14085,6 +14086,48 @@ fi\n   fi\n \n \n+\n+\n+  gdc_save_DFLAGS=$GDCFLAGS\n+  GDCFLAGS=\"-fno-moduleinfo -nostdinc -I $phobos_cv_abs_srcdir/libdruntime -nophoboslib $GDCFLAGS\"\n+\n+    ac_ext=d\n+ac_compile='$GDC -c $GDCFLAGS conftest.$ac_ext >&5'\n+ac_link='$GDC -o conftest$ac_exeext $GDCFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'\n+ac_compiler_gnu=yes\n+\n+    GDCFLAGS=\"$GDCFLAGS -g -Werror -ffunction-sections -fdata-sections\"\n+    cat > conftest.$ac_ext <<_ACEOF\n+module mod;\n+int foo; void bar() { }\n+\n+extern(C) int main() {\n+  return 0;\n+}\n+_ACEOF\n+if ac_fn_d_try_compile \"$LINENO\"; then :\n+  ac_fdsections=yes\n+else\n+  ac_fdsections=no\n+fi\n+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext\n+    if test \"x$ac_fdsections\" = \"xyes\"; then\n+      SECTION_FLAGS='-ffunction-sections -fdata-sections'\n+    fi\n+    { $as_echo \"$as_me:${as_lineno-$LINENO}: result: $ac_fdsections\" >&5\n+$as_echo \"$ac_fdsections\" >&6; }\n+    ac_ext=c\n+ac_cpp='$CPP $CPPFLAGS'\n+ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'\n+ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'\n+ac_compiler_gnu=$ac_cv_c_compiler_gnu\n+\n+\n+  GDCFLAGS=$gdc_save_DFLAGS\n+\n+\n+\n+\n   druntime_target_cpu_parsed=\"\"\n   case \"$target_cpu\" in\n       aarch64*)"}, {"sha": "3b5a830cccfaca11750e797502c7c0188ac6a215", "filename": "libphobos/configure.ac", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fconfigure.ac", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fconfigure.ac", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fconfigure.ac?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -137,6 +137,7 @@ GCC_BASE_VER\n DRUNTIME_CONFIGURE\n DRUNTIME_MULTILIB\n DRUNTIME_WERROR\n+DRUNTIME_SECTION_FLAGS\n DRUNTIME_CPU_SOURCES\n DRUNTIME_OS_SOURCES\n DRUNTIME_OS_THREAD_MODEL"}, {"sha": "02a68b1042486bb17eab46c584b96fe7e6f418b6", "filename": "libphobos/libdruntime/Makefile.am", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Flibdruntime%2FMakefile.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Flibdruntime%2FMakefile.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2FMakefile.am?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -24,7 +24,7 @@ D_EXTRA_DFLAGS=-nostdinc -I $(srcdir) -I .\n # D flags for compilation\n AM_DFLAGS= \\\n \t$(phobos_lt_pic_flag) $(phobos_compiler_shared_flag) \\\n-\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(CET_DFLAGS)\n+\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(SECTION_FLAGS) $(CET_DFLAGS)\n \n # Flags for other kinds of sources\n AM_CFLAGS=$(CET_FLAGS)"}, {"sha": "853a7fc1981b4b0973c1cb0397285e506410cedb", "filename": "libphobos/libdruntime/Makefile.in", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Flibdruntime%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Flibdruntime%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Flibdruntime%2FMakefile.in?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -635,6 +635,7 @@ PACKAGE_URL = @PACKAGE_URL@\n PACKAGE_VERSION = @PACKAGE_VERSION@\n PATH_SEPARATOR = @PATH_SEPARATOR@\n RANLIB = @RANLIB@\n+SECTION_FLAGS = @SECTION_FLAGS@\n SED = @SED@\n SET_MAKE = @SET_MAKE@\n SHELL = @SHELL@\n@@ -727,7 +728,7 @@ D_EXTRA_DFLAGS = -nostdinc -I $(srcdir) -I .\n # D flags for compilation\n AM_DFLAGS = \\\n \t$(phobos_lt_pic_flag) $(phobos_compiler_shared_flag) \\\n-\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(CET_DFLAGS)\n+\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(SECTION_FLAGS) $(CET_DFLAGS)\n \n \n # Flags for other kinds of sources"}, {"sha": "2a7a689dd18e2c79f48b1748f703676502a6cbbd", "filename": "libphobos/m4/druntime.m4", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fm4%2Fdruntime.m4", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fm4%2Fdruntime.m4", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fm4%2Fdruntime.m4?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -116,3 +116,22 @@ AC_DEFUN([DRUNTIME_INSTALL_DIRECTORIES],\n   gdc_include_dir='$(libdir)/gcc/${target_alias}/${gcc_version}/include/d'\n   AC_SUBST(gdc_include_dir)\n ])\n+\n+# DRUNTIME_SECTION_FLAGS\n+# ----------------------\n+# Check for -ffunction-sections nad -fdata-sections.\n+AC_DEFUN([DRUNTIME_SECTION_FLAGS],\n+[\n+  WITH_LOCAL_DRUNTIME([\n+    AC_LANG_PUSH([D])\n+    GDCFLAGS=\"$GDCFLAGS -g -Werror -ffunction-sections -fdata-sections\"\n+    AC_TRY_COMPILE([int foo; void bar() { }],[return 0;],\n+\t\t   [ac_fdsections=yes], [ac_fdsections=no])\n+    if test \"x$ac_fdsections\" = \"xyes\"; then\n+      SECTION_FLAGS='-ffunction-sections -fdata-sections'\n+    fi\n+    AC_MSG_RESULT($ac_fdsections)\n+    AC_LANG_POP([D])\n+  ], [-nophoboslib])\n+  AC_SUBST(SECTION_FLAGS)\n+])"}, {"sha": "f97ddccaca84e4998b9dd7314ae2221bf9883162", "filename": "libphobos/src/Makefile.am", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fsrc%2FMakefile.am", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fsrc%2FMakefile.am", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fsrc%2FMakefile.am?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -25,7 +25,7 @@ D_EXTRA_DFLAGS=-nostdinc -I $(srcdir) \\\n # D flags for compilation\n AM_DFLAGS= \\\n \t$(phobos_lt_pic_flag) $(phobos_compiler_shared_flag) \\\n-\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(CET_DFLAGS)\n+\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(SECTION_FLAGS) $(CET_DFLAGS)\n \n # Flags for other kinds of sources\n AM_CFLAGS=$(CET_FLAGS)"}, {"sha": "4f76e1077d5e0f2fc2d514d5e4b449e1e2cc321d", "filename": "libphobos/src/Makefile.in", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fsrc%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Fsrc%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Fsrc%2FMakefile.in?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -388,6 +388,7 @@ PACKAGE_URL = @PACKAGE_URL@\n PACKAGE_VERSION = @PACKAGE_VERSION@\n PATH_SEPARATOR = @PATH_SEPARATOR@\n RANLIB = @RANLIB@\n+SECTION_FLAGS = @SECTION_FLAGS@\n SED = @SED@\n SET_MAKE = @SET_MAKE@\n SHELL = @SHELL@\n@@ -482,7 +483,7 @@ D_EXTRA_DFLAGS = -nostdinc -I $(srcdir) \\\n # D flags for compilation\n AM_DFLAGS = \\\n \t$(phobos_lt_pic_flag) $(phobos_compiler_shared_flag) \\\n-\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(CET_DFLAGS)\n+\t$(WARN_DFLAGS) $(CHECKING_DFLAGS) $(SECTION_FLAGS) $(CET_DFLAGS)\n \n \n # Flags for other kinds of sources"}, {"sha": "885548018baeea8997471889c9c9c12d60c486ee", "filename": "libphobos/testsuite/Makefile.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Ftestsuite%2FMakefile.in", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/d118ec221dd5fc829d2170c257e10b8159dce274/libphobos%2Ftestsuite%2FMakefile.in", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libphobos%2Ftestsuite%2FMakefile.in?ref=d118ec221dd5fc829d2170c257e10b8159dce274", "patch": "@@ -215,6 +215,7 @@ PACKAGE_URL = @PACKAGE_URL@\n PACKAGE_VERSION = @PACKAGE_VERSION@\n PATH_SEPARATOR = @PATH_SEPARATOR@\n RANLIB = @RANLIB@\n+SECTION_FLAGS = @SECTION_FLAGS@\n SED = @SED@\n SET_MAKE = @SET_MAKE@\n SHELL = @SHELL@"}]}