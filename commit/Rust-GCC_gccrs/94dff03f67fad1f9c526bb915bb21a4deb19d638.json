{"sha": "94dff03f67fad1f9c526bb915bb21a4deb19d638", "node_id": "C_kwDOANBUbNoAKDk0ZGZmMDNmNjdmYWQxZjljNTI2YmI5MTViYjIxYTRkZWIxOWQ2Mzg", "commit": {"author": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2021-10-18T10:51:07Z"}, "committer": {"name": "Roger Sayle", "email": "roger@nextmovesoftware.com", "date": "2021-10-18T10:51:07Z"}, "message": "Constant fold SS_NEG and SS_ABS in simplify-rtx.c\n\nThis simple patch performs compile-time constant folding of\nsigned saturating negation and signed saturating absolute value\nin the RTL optimizers.  Normally in two's complement arithmetic\nthe lowest representable signed value overflows on negation,\nWith these saturating operators they \"saturate\" to the maximum\nrepresentable signed value, so SS_NEG:QI -128 is 127, and\nSS_ABS:HI -32768 is 32767.\n\nOn bfin-elf, the following two short functions:\n\nshort foo()\n{\n  short t = -32768;\n  short r = __builtin_bfin_negate_fr1x16(t);\n  return r;\n}\n\nint bar()\n{\n  int t = -2147483648;\n  int r = __builtin_bfin_abs_fr1x32(t);\n  return r;\n}\n\ncurrently compile to:\n_foo:\tnop;\n        nop;\n        R0 = -32768 (X);\n        R0 = -R0 (V);\n        rts;\n\n_bar:\tnop;\n        R0 = -1 (X);\n        R0 <<= 31;\n        R0 = abs R0;\n        rts;\n\nbut with this middle-end patch now compile to:\n\n_foo:\tnop;\n        nop;\n        nop;\n        R0 = 32767 (X);\n        rts;\n\n_bar:\tnop;\n        nop;\n        R0 = -1 (X);\n        R0.H = 32767;\n        rts;\n\n2021-10-18  Roger Sayle  <roger@nextmovesoftware.com>\n\ngcc/ChangeLog\n\t* simplify-rtx.c (simplify_const_unary_operation) [SS_NEG, SS_ABS]:\n\tEvalute SS_NEG and SS_ABS of a constant argument.\n\ngcc/testsuite/ChangeLog\n\t* gcc.target/bfin/ssabs.c: New test case.\n\t* gcc.target/bfin/ssneg.c: New test case.", "tree": {"sha": "b361074e8a0de14d32b26f2e164e862486039137", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b361074e8a0de14d32b26f2e164e862486039137"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/94dff03f67fad1f9c526bb915bb21a4deb19d638", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94dff03f67fad1f9c526bb915bb21a4deb19d638", "html_url": "https://github.com/Rust-GCC/gccrs/commit/94dff03f67fad1f9c526bb915bb21a4deb19d638", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/94dff03f67fad1f9c526bb915bb21a4deb19d638/comments", "author": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rogersayle", "id": 13512313, "node_id": "MDQ6VXNlcjEzNTEyMzEz", "avatar_url": "https://avatars.githubusercontent.com/u/13512313?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rogersayle", "html_url": "https://github.com/rogersayle", "followers_url": "https://api.github.com/users/rogersayle/followers", "following_url": "https://api.github.com/users/rogersayle/following{/other_user}", "gists_url": "https://api.github.com/users/rogersayle/gists{/gist_id}", "starred_url": "https://api.github.com/users/rogersayle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rogersayle/subscriptions", "organizations_url": "https://api.github.com/users/rogersayle/orgs", "repos_url": "https://api.github.com/users/rogersayle/repos", "events_url": "https://api.github.com/users/rogersayle/events{/privacy}", "received_events_url": "https://api.github.com/users/rogersayle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "20dcda98ed376cb61c74b2c71656f99c671ec9ce", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/20dcda98ed376cb61c74b2c71656f99c671ec9ce", "html_url": "https://github.com/Rust-GCC/gccrs/commit/20dcda98ed376cb61c74b2c71656f99c671ec9ce"}], "stats": {"total": 36, "additions": 36, "deletions": 0}, "files": [{"sha": "2bb18fb506547698df158bdb5123268aa96ae261", "filename": "gcc/simplify-rtx.c", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94dff03f67fad1f9c526bb915bb21a4deb19d638/gcc%2Fsimplify-rtx.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94dff03f67fad1f9c526bb915bb21a4deb19d638/gcc%2Fsimplify-rtx.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fsimplify-rtx.c?ref=94dff03f67fad1f9c526bb915bb21a4deb19d638", "patch": "@@ -2026,6 +2026,20 @@ simplify_const_unary_operation (enum rtx_code code, machine_mode mode,\n \t  result = wide_int::from (op0, width, SIGNED);\n \t  break;\n \n+\tcase SS_NEG:\n+\t  if (wi::only_sign_bit_p (op0))\n+\t    result = wi::max_value (GET_MODE_PRECISION (imode), SIGNED);\n+\t  else\n+\t    result = wi::neg (op0);\n+\t  break;\n+\n+\tcase SS_ABS:\n+\t  if (wi::only_sign_bit_p (op0))\n+\t    result = wi::max_value (GET_MODE_PRECISION (imode), SIGNED);\n+\t  else\n+\t    result = wi::abs (op0);\n+\t  break;\n+\n \tcase SQRT:\n \tdefault:\n \t  return 0;"}, {"sha": "e9d8bae62fdb8f75e62af8c0df8da7cf889f328d", "filename": "gcc/testsuite/gcc.target/bfin/ssabs.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94dff03f67fad1f9c526bb915bb21a4deb19d638/gcc%2Ftestsuite%2Fgcc.target%2Fbfin%2Fssabs.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94dff03f67fad1f9c526bb915bb21a4deb19d638/gcc%2Ftestsuite%2Fgcc.target%2Fbfin%2Fssabs.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fbfin%2Fssabs.c?ref=94dff03f67fad1f9c526bb915bb21a4deb19d638", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2\" } */\n+\n+int foo()\n+{\n+  int t = -2147483648;\n+  int r = __builtin_bfin_abs_fr1x32(t);\n+  return r;\n+}\n+\n+/* { dg-final { scan-assembler \"32767\" } } */"}, {"sha": "44ad7edbba469c9c8df3c8b31c97240dac355a67", "filename": "gcc/testsuite/gcc.target/bfin/ssneg.c", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/94dff03f67fad1f9c526bb915bb21a4deb19d638/gcc%2Ftestsuite%2Fgcc.target%2Fbfin%2Fssneg.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/94dff03f67fad1f9c526bb915bb21a4deb19d638/gcc%2Ftestsuite%2Fgcc.target%2Fbfin%2Fssneg.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fbfin%2Fssneg.c?ref=94dff03f67fad1f9c526bb915bb21a4deb19d638", "patch": "@@ -0,0 +1,11 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O2\" } */\n+\n+short foo()\n+{\n+  short t = -32768;\n+  short r = __builtin_bfin_negate_fr1x16(t);\n+  return r;\n+}\n+\n+/* { dg-final { scan-assembler \"32767\" } } */"}]}