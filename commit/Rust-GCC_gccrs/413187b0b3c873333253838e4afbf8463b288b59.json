{"sha": "413187b0b3c873333253838e4afbf8463b288b59", "node_id": "C_kwDOANBUbNoAKDQxMzE4N2IwYjNjODczMzMzMjUzODM4ZTRhZmJmODQ2M2IyODhiNTk", "commit": {"author": {"name": "Xi Ruoyao", "email": "xry111@mengyan1223.wang", "date": "2022-03-31T15:40:23Z"}, "committer": {"name": "Xi Ruoyao", "email": "xry111@mengyan1223.wang", "date": "2022-04-01T14:37:58Z"}, "message": "mips: Ignore zero width fields in arguments and issue -Wpsabi warning about C zero-width field ABI changes [PR102024]\n\ngcc/\n\tPR target/102024\n\t* config/mips/mips.cc (mips_function_arg): Ignore zero-width\n\tfields, and inform if it causes a psABI change.\n\ngcc/testsuite/\n\tPR target/102024\n\t* gcc.target/mips/pr102024-1.c: New test.\n\t* gcc.target/mips/pr102024-2.c: New test.\n\t* gcc.target/mips/pr102024-3.c: New test.", "tree": {"sha": "3ff968d0fdb8bbb22496c55fe2a5a7a003dad205", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3ff968d0fdb8bbb22496c55fe2a5a7a003dad205"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/413187b0b3c873333253838e4afbf8463b288b59", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIyBAABCAAdFiEEEunTLnZqV9wGnXaw2V5HFsy7NNwFAmJHDnEACgkQ2V5HFsy7\nNNwTDQ/48lSK0co7K5PETFs3cyMlAZsucBKQMtcSjgBc/J8tZ6/Pc3Q9bY+6TapO\npkbgScG+b19gwvXxseVyEt3fKhHMWvWsNO/RstE3dB0dobIM7bXpVIz6zFR0G/rm\nsrZajHmdwO3JhtMC9YOn/mRYkn3iHEU4aGz/cg6gZIOOeL3fzWlFJRdJYSBMvmNd\n1p16tva4TdOlbxX7FiSHzpTEzv5Mx8ICJEYMtTShE5jblXuiLILwg6QY8x4A7RZT\nAiLYmGinXkhHxhaSXkx8UtC3wktKyA9Cve+/8CteHcKLA3KxJWMvWWVKG4uEwsYU\nPZpIxj6Trhn/Mxr11HG0w826Jsd3Yl54OsI0MApxnb93wfAKeN5/Gtb89y4aHn3N\nIVf/lcNqy2GkViA0WEzqRds31WS/QEqCARsX0SCCovzXad4JmV2NNHXwJn5t3KVK\nWof9sSJqDBB/Ff686P7w0WK6/dNB31+dOWWpkJWj53BZ1ywpv7LhQ4lM7j0SP/IP\ntkRJqZqlEOgyc9xZZ1K+DVP1xdAOhBOyEr0QfoNWbteRkik+lpkNwGj/nbjSiP3M\n0frUXfV1uiG/kWF0tXt6LAicE74HCHCu3RH5W+dP4oj1Jtt4mpPwnl7EE4YZbHNI\ncYgaGzcmdLdeeM9Y4y390/VkiuDQ4zyJ+l4yWPjtKWZi20/wUA==\n=GOa8\n-----END PGP SIGNATURE-----", "payload": "tree 3ff968d0fdb8bbb22496c55fe2a5a7a003dad205\nparent 0d4b97f1ee5213dffce107bc9f260a22fb23b4b1\nauthor Xi Ruoyao <xry111@mengyan1223.wang> 1648741223 +0800\ncommitter Xi Ruoyao <xry111@mengyan1223.wang> 1648823878 +0800\n\nmips: Ignore zero width fields in arguments and issue -Wpsabi warning about C zero-width field ABI changes [PR102024]\n\ngcc/\n\tPR target/102024\n\t* config/mips/mips.cc (mips_function_arg): Ignore zero-width\n\tfields, and inform if it causes a psABI change.\n\ngcc/testsuite/\n\tPR target/102024\n\t* gcc.target/mips/pr102024-1.c: New test.\n\t* gcc.target/mips/pr102024-2.c: New test.\n\t* gcc.target/mips/pr102024-3.c: New test.\n"}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/413187b0b3c873333253838e4afbf8463b288b59", "html_url": "https://github.com/Rust-GCC/gccrs/commit/413187b0b3c873333253838e4afbf8463b288b59", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/413187b0b3c873333253838e4afbf8463b288b59/comments", "author": {"login": "xry111", "id": 8733039, "node_id": "MDQ6VXNlcjg3MzMwMzk=", "avatar_url": "https://avatars.githubusercontent.com/u/8733039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xry111", "html_url": "https://github.com/xry111", "followers_url": "https://api.github.com/users/xry111/followers", "following_url": "https://api.github.com/users/xry111/following{/other_user}", "gists_url": "https://api.github.com/users/xry111/gists{/gist_id}", "starred_url": "https://api.github.com/users/xry111/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xry111/subscriptions", "organizations_url": "https://api.github.com/users/xry111/orgs", "repos_url": "https://api.github.com/users/xry111/repos", "events_url": "https://api.github.com/users/xry111/events{/privacy}", "received_events_url": "https://api.github.com/users/xry111/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xry111", "id": 8733039, "node_id": "MDQ6VXNlcjg3MzMwMzk=", "avatar_url": "https://avatars.githubusercontent.com/u/8733039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xry111", "html_url": "https://github.com/xry111", "followers_url": "https://api.github.com/users/xry111/followers", "following_url": "https://api.github.com/users/xry111/following{/other_user}", "gists_url": "https://api.github.com/users/xry111/gists{/gist_id}", "starred_url": "https://api.github.com/users/xry111/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xry111/subscriptions", "organizations_url": "https://api.github.com/users/xry111/orgs", "repos_url": "https://api.github.com/users/xry111/repos", "events_url": "https://api.github.com/users/xry111/events{/privacy}", "received_events_url": "https://api.github.com/users/xry111/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d4b97f1ee5213dffce107bc9f260a22fb23b4b1", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0d4b97f1ee5213dffce107bc9f260a22fb23b4b1", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0d4b97f1ee5213dffce107bc9f260a22fb23b4b1"}], "stats": {"total": 106, "additions": 102, "deletions": 4}, "files": [{"sha": "7681983186c124c0d51267adeee2ec3785d9d137", "filename": "gcc/config/mips/mips.cc", "status": "modified", "additions": 42, "deletions": 4, "changes": 46, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Fconfig%2Fmips%2Fmips.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Fconfig%2Fmips%2Fmips.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Fmips%2Fmips.cc?ref=413187b0b3c873333253838e4afbf8463b288b59", "patch": "@@ -6042,19 +6042,57 @@ mips_function_arg (cumulative_args_t cum_v, const function_arg_info &arg)\n \t  for (i = 0; i < info.reg_words; i++)\n \t    {\n \t      rtx reg;\n+\t      bool zero_width_field_abi_change = false;\n \n \t      for (; field; field = DECL_CHAIN (field))\n-\t\tif (TREE_CODE (field) == FIELD_DECL\n-\t\t    && int_bit_position (field) >= bitpos)\n-\t\t  break;\n+\t\t{\n+\t\t  if (TREE_CODE (field) != FIELD_DECL)\n+\t\t    continue;\n+\n+\t\t  /* Ignore zero-width fields.  And, if the ignored\n+\t\t     field is not a C++ zero-width bit-field, it may be\n+\t\t     an ABI change.  */\n+\t\t  if (DECL_FIELD_CXX_ZERO_WIDTH_BIT_FIELD (field))\n+\t\t    continue;\n+\t\t  if (integer_zerop (DECL_SIZE (field)))\n+\t\t    {\n+\t\t      zero_width_field_abi_change = true;\n+\t\t      continue;\n+\t\t    }\n+\n+\t\t  if (int_bit_position (field) >= bitpos)\n+\t\t    break;\n+\t\t}\n \n \t      if (field\n \t\t  && int_bit_position (field) == bitpos\n \t\t  && SCALAR_FLOAT_TYPE_P (TREE_TYPE (field))\n \t\t  && TYPE_PRECISION (TREE_TYPE (field)) == BITS_PER_WORD)\n \t\treg = gen_rtx_REG (DFmode, FP_ARG_FIRST + info.reg_offset + i);\n \t      else\n-\t\treg = gen_rtx_REG (DImode, GP_ARG_FIRST + info.reg_offset + i);\n+\t\t{\n+\t\t  reg = gen_rtx_REG (DImode,\n+\t\t\t\t     GP_ARG_FIRST + info.reg_offset + i);\n+\t\t  zero_width_field_abi_change = false;\n+\t\t}\n+\n+\t      if (zero_width_field_abi_change && warn_psabi)\n+\t\t{\n+\t\t  static unsigned last_reported_type_uid;\n+\t\t  unsigned uid = TYPE_UID (TYPE_MAIN_VARIANT (arg.type));\n+\t\t  if (uid != last_reported_type_uid)\n+\t\t    {\n+\t\t      static const char *url\n+\t\t\t= CHANGES_ROOT_URL\n+\t\t\t  \"gcc-12/changes.html#mips_zero_width_fields\";\n+\t\t      inform (input_location,\n+\t\t\t      \"the ABI for passing a value containing \"\n+\t\t\t      \"zero-width fields before an adjacent \"\n+\t\t\t      \"64-bit floating-point field was changed \"\n+\t\t\t      \"in GCC %{12.1%}\", url);\n+\t\t      last_reported_type_uid = uid;\n+\t\t    }\n+\t\t}\n \n \t      XVECEXP (ret, 0, i)\n \t\t= gen_rtx_EXPR_LIST (VOIDmode, reg,"}, {"sha": "cf442863fc232ace9296f1d83d9d61a70d8a584a", "filename": "gcc/testsuite/gcc.target/mips/pr102024-1.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-1.c?ref=413187b0b3c873333253838e4afbf8463b288b59", "patch": "@@ -0,0 +1,20 @@\n+// PR target/102024\n+// { dg-do compile }\n+// { dg-options \"-mabi=64 -mhard-float\" }\n+// { dg-final { scan-assembler \"\\\\\\$f12\" } }\n+\n+struct foo\n+{\n+  int : 0;\n+  double a;\n+};\n+\n+extern void func(struct foo);\n+\n+void\n+pass_foo(void)\n+{\n+  struct foo test;\n+  test.a = 114;\n+  func(test); // { dg-message \"the ABI for passing a value containing zero-width fields before an adjacent 64-bit floating-point field was changed in GCC 12.1\" }\n+}"}, {"sha": "89b26f86038baa6d686664f95f31fd2e2ee1f848", "filename": "gcc/testsuite/gcc.target/mips/pr102024-2.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-2.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-2.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-2.c?ref=413187b0b3c873333253838e4afbf8463b288b59", "patch": "@@ -0,0 +1,20 @@\n+// PR target/102024\n+// { dg-do compile }\n+// { dg-options \"-mabi=64 -mhard-float\" }\n+// { dg-final { scan-assembler \"\\\\\\$f12\" } }\n+\n+struct foo\n+{\n+  char empty[0];\n+  double a;\n+};\n+\n+extern void func(struct foo);\n+\n+void\n+pass_foo(void)\n+{\n+  struct foo test;\n+  test.a = 114;\n+  func(test); // { dg-message \"the ABI for passing a value containing zero-width fields before an adjacent 64-bit floating-point field was changed in GCC 12.1\" }\n+}"}, {"sha": "477f07055a111a4403ef59c26d108f131b529fee", "filename": "gcc/testsuite/gcc.target/mips/pr102024-3.c", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/413187b0b3c873333253838e4afbf8463b288b59/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fmips%2Fpr102024-3.c?ref=413187b0b3c873333253838e4afbf8463b288b59", "patch": "@@ -0,0 +1,20 @@\n+// PR target/102024\n+// { dg-do compile }\n+// { dg-options \"-mabi=64 -mhard-float\" }\n+// { dg-final { scan-assembler \"\\\\\\$f12\" } }\n+\n+struct foo\n+{\n+  struct {} empty;\n+  double a;\n+};\n+\n+extern void func(struct foo);\n+\n+void\n+pass_foo(void)\n+{\n+  struct foo test;\n+  test.a = 114;\n+  func(test); // { dg-message \"the ABI for passing a value containing zero-width fields before an adjacent 64-bit floating-point field was changed in GCC 12.1\" }\n+}"}]}