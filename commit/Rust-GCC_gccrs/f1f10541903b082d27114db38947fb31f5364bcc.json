{"sha": "f1f10541903b082d27114db38947fb31f5364bcc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjFmMTA1NDE5MDNiMDgyZDI3MTE0ZGIzODk0N2ZiMzFmNTM2NGJjYw==", "commit": {"author": {"name": "Richard Sandiford", "email": "richard.sandiford@arm.com", "date": "2019-07-18T08:24:16Z"}, "committer": {"name": "Richard Sandiford", "email": "rsandifo@gcc.gnu.org", "date": "2019-07-18T08:24:16Z"}, "message": "Make ifcvt clean up dead comparisons\n\nThis change is needed to avoid a regression in gcc.dg/ifcvt-3.c\nfor a later patch.  Without it, we enter CSE with a dead comparison left\nby if-conversion and then eliminate the second (live) comparison in\nfavour of the dead one.  That's functionally correct in itself, but it\nmeant that we'd combine the subtraction and comparison into a SUBS\nbefore we have a chance to fold away the subtraction.\n\n2019-07-18  Richard Sandiford  <richard.sandiford@arm.com>\n\ngcc/\n\t* basic-block.h (CLEANUP_FORCE_FAST_DCE): New macro.\n\t* cfgcleanup.c (cleanup_cfg): Call run_fast_dce if\n\tCLEANUP_FORCE_FAST_DCE is set.\n\t* ifcvt.c (rest_of_handle_if_conversion): Pass\n\tCLEANUP_FORCE_FAST_DCE to the final cleanup_cfg call if\n\tif-conversion succeeded.\n\nFrom-SVN: r273569", "tree": {"sha": "81b40e730cc48482b0a65592b9ea5e4372ae654b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/81b40e730cc48482b0a65592b9ea5e4372ae654b"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f1f10541903b082d27114db38947fb31f5364bcc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f1f10541903b082d27114db38947fb31f5364bcc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f1f10541903b082d27114db38947fb31f5364bcc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f1f10541903b082d27114db38947fb31f5364bcc/comments", "author": {"login": "rsandifo-arm", "id": 28043039, "node_id": "MDQ6VXNlcjI4MDQzMDM5", "avatar_url": "https://avatars.githubusercontent.com/u/28043039?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rsandifo-arm", "html_url": "https://github.com/rsandifo-arm", "followers_url": "https://api.github.com/users/rsandifo-arm/followers", "following_url": "https://api.github.com/users/rsandifo-arm/following{/other_user}", "gists_url": "https://api.github.com/users/rsandifo-arm/gists{/gist_id}", "starred_url": "https://api.github.com/users/rsandifo-arm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rsandifo-arm/subscriptions", "organizations_url": "https://api.github.com/users/rsandifo-arm/orgs", "repos_url": "https://api.github.com/users/rsandifo-arm/repos", "events_url": "https://api.github.com/users/rsandifo-arm/events{/privacy}", "received_events_url": "https://api.github.com/users/rsandifo-arm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "d119bf79862015d4ba3c7f8774835c216c9a26ed", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/d119bf79862015d4ba3c7f8774835c216c9a26ed", "html_url": "https://github.com/Rust-GCC/gccrs/commit/d119bf79862015d4ba3c7f8774835c216c9a26ed"}], "stats": {"total": 26, "additions": 24, "deletions": 2}, "files": [{"sha": "b545a034e57db48c68935ea0568704643561b5d2", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=f1f10541903b082d27114db38947fb31f5364bcc", "patch": "@@ -1,3 +1,12 @@\n+2019-07-18  Richard Sandiford  <richard.sandiford@arm.com>\n+\n+\t* basic-block.h (CLEANUP_FORCE_FAST_DCE): New macro.\n+\t* cfgcleanup.c (cleanup_cfg): Call run_fast_dce if\n+\tCLEANUP_FORCE_FAST_DCE is set.\n+\t* ifcvt.c (rest_of_handle_if_conversion): Pass\n+\tCLEANUP_FORCE_FAST_DCE to the final cleanup_cfg call if\n+\tif-conversion succeeded.\n+\n 2019-07-18  Richard Biener  <rguenther@suse.de>\n \n \t* tree-ssa-sccvn.c (vn_walk_cb_data::push_partial_def): Refactor"}, {"sha": "2a0e8261537602898e72034000516e6ec10c2975", "filename": "gcc/basic-block.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2Fbasic-block.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2Fbasic-block.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fbasic-block.h?ref=f1f10541903b082d27114db38947fb31f5364bcc", "patch": "@@ -508,6 +508,8 @@ ei_cond (edge_iterator ei, edge *p)\n #define CLEANUP_CFGLAYOUT\t32\t/* Do cleanup in cfglayout mode.  */\n #define CLEANUP_CFG_CHANGED\t64      /* The caller changed the CFG.  */\n #define CLEANUP_NO_PARTITIONING\t128     /* Do not try to fix partitions.  */\n+#define CLEANUP_FORCE_FAST_DCE\t0x100\t/* Force run_fast_dce to be called\n+\t\t\t\t\t   at least once.  */\n \n /* Return true if BB is in a transaction.  */\n "}, {"sha": "b9307631e1cdd2ef88b3c24dfb57295fd540887c", "filename": "gcc/cfgcleanup.c", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2Fcfgcleanup.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2Fcfgcleanup.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcfgcleanup.c?ref=f1f10541903b082d27114db38947fb31f5364bcc", "patch": "@@ -3193,7 +3193,10 @@ cleanup_cfg (int mode)\n \t      && !delete_trivially_dead_insns (get_insns (), max_reg_num ()))\n \t    break;\n \t  if ((mode & CLEANUP_CROSSJUMP) && crossjumps_occurred)\n-\t    run_fast_dce ();\n+\t    {\n+\t      run_fast_dce ();\n+\t      mode &= ~CLEANUP_FORCE_FAST_DCE;\n+\t    }\n \t}\n       else\n \tbreak;\n@@ -3202,6 +3205,9 @@ cleanup_cfg (int mode)\n   if (mode & CLEANUP_CROSSJUMP)\n     remove_fake_exit_edges ();\n \n+  if (mode & CLEANUP_FORCE_FAST_DCE)\n+    run_fast_dce ();\n+\n   /* Don't call delete_dead_jumptables in cfglayout mode, because\n      that function assumes that jump tables are in the insns stream.\n      But we also don't _have_ to delete dead jumptables in cfglayout"}, {"sha": "e0c9522057a13371dd77aa52b7b60be3504b94e9", "filename": "gcc/ifcvt.c", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2Fifcvt.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f1f10541903b082d27114db38947fb31f5364bcc/gcc%2Fifcvt.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fifcvt.c?ref=f1f10541903b082d27114db38947fb31f5364bcc", "patch": "@@ -5457,6 +5457,8 @@ if_convert (bool after_combine)\n static unsigned int\n rest_of_handle_if_conversion (void)\n {\n+  int flags = 0;\n+\n   if (flag_if_conversion)\n     {\n       if (dump_file)\n@@ -5466,9 +5468,12 @@ rest_of_handle_if_conversion (void)\n \t}\n       cleanup_cfg (CLEANUP_EXPENSIVE);\n       if_convert (false);\n+      if (num_updated_if_blocks)\n+\t/* Get rid of any dead CC-related instructions.  */\n+\tflags |= CLEANUP_FORCE_FAST_DCE;\n     }\n \n-  cleanup_cfg (0);\n+  cleanup_cfg (flags);\n   return 0;\n }\n "}]}