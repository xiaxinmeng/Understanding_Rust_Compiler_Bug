{"sha": "b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjQ3NGQ2YzNmMWVhMDM0ZGExNGQyMGE1MmYxODNlNGExYTBlN2I4Nw==", "commit": {"author": {"name": "Ed Schonberg", "email": "schonberg@adacore.com", "date": "2011-08-03T07:37:15Z"}, "committer": {"name": "Arnaud Charlet", "email": "charlet@gcc.gnu.org", "date": "2011-08-03T07:37:15Z"}, "message": "exp_ch9.adb (Build_Renamed_Formal_Declaration): common procedure for protected entries and task entries...\n\n2011-08-03  Ed Schonberg  <schonberg@adacore.com>\n\n\t* exp_ch9.adb (Build_Renamed_Formal_Declaration): common procedure for\n\tprotected entries and task entries, to build the proper renaming\n\tdeclaration for entry formals, used in debugging.\n\t* exp_ch2.adb (Expand_Entry_Parameter): handle task and entry\n\tparameters in the same way.\n\nFrom-SVN: r177232", "tree": {"sha": "b3817f7166af6b172c4935632d7cddc5f0de01ca", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/b3817f7166af6b172c4935632d7cddc5f0de01ca"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/comments", "author": {"login": "Edschonberg", "id": 6352375, "node_id": "MDQ6VXNlcjYzNTIzNzU=", "avatar_url": "https://avatars.githubusercontent.com/u/6352375?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Edschonberg", "html_url": "https://github.com/Edschonberg", "followers_url": "https://api.github.com/users/Edschonberg/followers", "following_url": "https://api.github.com/users/Edschonberg/following{/other_user}", "gists_url": "https://api.github.com/users/Edschonberg/gists{/gist_id}", "starred_url": "https://api.github.com/users/Edschonberg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Edschonberg/subscriptions", "organizations_url": "https://api.github.com/users/Edschonberg/orgs", "repos_url": "https://api.github.com/users/Edschonberg/repos", "events_url": "https://api.github.com/users/Edschonberg/events{/privacy}", "received_events_url": "https://api.github.com/users/Edschonberg/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "40f2f11f1f38c4346b843d94a0d8a68a2e7bcd87", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/40f2f11f1f38c4346b843d94a0d8a68a2e7bcd87", "html_url": "https://github.com/Rust-GCC/gccrs/commit/40f2f11f1f38c4346b843d94a0d8a68a2e7bcd87"}], "stats": {"total": 132, "additions": 95, "deletions": 37}, "files": [{"sha": "2612b177fc815161fb7e4004cf216db1bfc12745", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "patch": "@@ -1,3 +1,11 @@\n+2011-08-03  Ed Schonberg  <schonberg@adacore.com>\n+\n+\t* exp_ch9.adb (Build_Renamed_Formal_Declaration): common procedure for\n+\tprotected entries and task entries, to build the proper renaming\n+\tdeclaration for entry formals, used in debugging.\n+\t* exp_ch2.adb (Expand_Entry_Parameter): handle task and entry\n+\tparameters in the same way.\n+\n 2011-08-02  Robert Dewar  <dewar@adacore.com>\n \n \t* a-direct.adb, sinfo.ads, exp_ch9.adb, scng.adb, sem_util.adb,"}, {"sha": "68483ffb39381a630467792b60f8208d2ae6dae8", "filename": "gcc/ada/exp_ch2.adb", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/gcc%2Fada%2Fexp_ch2.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/gcc%2Fada%2Fexp_ch2.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch2.adb?ref=b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "patch": "@@ -6,7 +6,7 @@\n --                                                                          --\n --                                 B o d y                                  --\n --                                                                          --\n---          Copyright (C) 1992-2009, Free Software Foundation, Inc.         --\n+--          Copyright (C) 1992-2011, Free Software Foundation, Inc.         --\n --                                                                          --\n -- GNAT is free software;  you can  redistribute it  and/or modify it under --\n -- terms of the  GNU General Public License as published  by the Free Soft- --\n@@ -520,9 +520,6 @@ package body Exp_Ch2 is\n          then\n             Note_Possible_Modification (N, Sure => True);\n          end if;\n-\n-         Rewrite (N, New_Occurrence_Of (Renamed_Object (Entity (N)), Loc));\n-         return;\n       end if;\n \n       --  What we need is a reference to the corresponding component of the\n@@ -532,6 +529,9 @@ package body Exp_Ch2 is\n       --  to turn this into a pointer to the parameter record and then we\n       --  select the required parameter field.\n \n+      --  The same processing applies to protected entries, where the Accept_\n+      --  Address is also the address of the Parameters record.\n+\n       P_Comp_Ref :=\n         Make_Selected_Component (Loc,\n           Prefix =>"}, {"sha": "0a0a28a1ee2113412a53e374f9f2d47d2e783ad2", "filename": "gcc/ada/exp_ch9.adb", "status": "modified", "additions": 83, "deletions": 33, "changes": 116, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/gcc%2Fada%2Fexp_ch9.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b474d6c3f1ea034da14d20a52f183e4a1a0e7b87/gcc%2Fada%2Fexp_ch9.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch9.adb?ref=b474d6c3f1ea034da14d20a52f183e4a1a0e7b87", "patch": "@@ -170,6 +170,19 @@ package body Exp_Ch9 is\n    --  and Decl is the enclosing synchronized type declaration at whose\n    --  freeze point the generated body is analyzed.\n \n+   function Build_Renamed_Formal_Declaration\n+     (New_F          : Entity_Id;\n+      Formal         : Entity_Id;\n+      Comp           : Entity_Id;\n+      Renamed_Formal : Node_Id) return Node_Id;\n+   --  Create a renaming declaration for a formal, within a protected entry\n+   --  body or an accept body. The renamed object is a component of the\n+   --  parameter block that is a parameter in the entry call.\n+\n+   --  In Ada2012,  If the formal is an incomplete tagged type, the renaming\n+   --  does not dereference the corresponding component to prevent an illegal\n+   --  use of the incomplete type (AI05-0151).\n+\n    procedure Build_Wrapper_Bodies\n      (Loc : Source_Ptr;\n       Typ : Entity_Id;\n@@ -637,10 +650,11 @@ package body Exp_Ch9 is\n       --  The name of the formal that holds the address of the parameter block\n       --  for the call.\n \n-      Comp   : Entity_Id;\n-      Decl   : Node_Id;\n-      Formal : Entity_Id;\n-      New_F  : Entity_Id;\n+      Comp            : Entity_Id;\n+      Decl            : Node_Id;\n+      Formal          : Entity_Id;\n+      New_F           : Entity_Id;\n+      Renamed_Formal  : Node_Id;\n \n    begin\n       Formal := First_Formal (Ent);\n@@ -667,18 +681,16 @@ package body Exp_Ch9 is\n \n          Set_Actual_Subtype (New_F, Actual_Subtype (Formal));\n \n+         Renamed_Formal :=\n+           Make_Selected_Component (Loc,\n+             Prefix        =>\n+               Unchecked_Convert_To (Entry_Parameters_Type (Ent),\n+                 Make_Identifier (Loc, Chars (Ptr))),\n+             Selector_Name => New_Reference_To (Comp, Loc));\n+\n          Decl :=\n-           Make_Object_Renaming_Declaration (Loc,\n-           Defining_Identifier => New_F,\n-           Subtype_Mark =>\n-             New_Reference_To (Etype (Formal), Loc),\n-           Name =>\n-             Make_Explicit_Dereference (Loc,\n-               Make_Selected_Component (Loc,\n-                 Prefix        =>\n-                   Unchecked_Convert_To (Entry_Parameters_Type (Ent),\n-                     Make_Identifier (Loc, Chars (Ptr))),\n-                 Selector_Name => New_Reference_To (Comp, Loc))));\n+           Build_Renamed_Formal_Declaration\n+             (New_F, Formal, Comp, Renamed_Formal);\n \n          Append (Decl, Decls);\n          Set_Renamed_Object (Formal, New_F);\n@@ -1576,6 +1588,46 @@ package body Exp_Ch9 is\n       return Rec_Nam;\n    end Build_Parameter_Block;\n \n+   --------------------------------------\n+   -- Build_Renamed_Formal_Declaration --\n+   --------------------------------------\n+\n+   function Build_Renamed_Formal_Declaration\n+     (New_F          : Entity_Id;\n+      Formal         : Entity_Id;\n+      Comp           : Entity_Id;\n+      Renamed_Formal : Node_Id) return Node_Id\n+   is\n+      Loc  : constant Source_Ptr := Sloc (New_F);\n+      Decl : Node_Id;\n+\n+   begin\n+      --  If the formal is a tagged incomplete type, it is already passed\n+      --  by reference, so it is sufficient to rename the pointer component\n+      --  that corresponds to the actual. Otherwise we need to dereference\n+      --  the pointer component to obtain the actual.\n+\n+      if Is_Incomplete_Type (Etype (Formal))\n+        and then Is_Tagged_Type (Etype (Formal))\n+      then\n+         Decl :=\n+           Make_Object_Renaming_Declaration (Loc,\n+             Defining_Identifier => New_F,\n+             Subtype_Mark        => New_Reference_To (Etype (Comp), Loc),\n+             Name                => Renamed_Formal);\n+\n+      else\n+         Decl :=\n+           Make_Object_Renaming_Declaration (Loc,\n+             Defining_Identifier => New_F,\n+             Subtype_Mark        => New_Reference_To (Etype (Formal), Loc),\n+             Name                =>\n+               Make_Explicit_Dereference (Loc, Renamed_Formal));\n+      end if;\n+\n+      return Decl;\n+   end Build_Renamed_Formal_Declaration;\n+\n    -----------------------\n    -- Build_PPC_Wrapper --\n    -----------------------\n@@ -4965,10 +5017,11 @@ package body Exp_Ch9 is\n            and then Present (Handled_Statement_Sequence (N))\n          then\n             declare\n-               Comp   : Entity_Id;\n-               Decl   : Node_Id;\n-               Formal : Entity_Id;\n-               New_F  : Entity_Id;\n+               Comp           : Entity_Id;\n+               Decl           : Node_Id;\n+               Formal         : Entity_Id;\n+               New_F          : Entity_Id;\n+               Renamed_Formal : Node_Id;\n \n             begin\n                Push_Scope (Ent);\n@@ -4997,21 +5050,18 @@ package body Exp_Ch9 is\n \n                   Set_Actual_Subtype (New_F, Actual_Subtype (Formal));\n \n+                  Renamed_Formal :=\n+                     Make_Selected_Component (Loc,\n+                       Prefix        =>\n+                         Unchecked_Convert_To (\n+                           Entry_Parameters_Type (Ent),\n+                           New_Reference_To (Ann, Loc)),\n+                       Selector_Name =>\n+                         New_Reference_To (Comp, Loc));\n+\n                   Decl :=\n-                    Make_Object_Renaming_Declaration (Loc,\n-                      Defining_Identifier =>\n-                        New_F,\n-                      Subtype_Mark =>\n-                        New_Reference_To (Etype (Formal), Loc),\n-                      Name =>\n-                        Make_Explicit_Dereference (Loc,\n-                          Make_Selected_Component (Loc,\n-                            Prefix =>\n-                              Unchecked_Convert_To (\n-                                Entry_Parameters_Type (Ent),\n-                                New_Reference_To (Ann, Loc)),\n-                            Selector_Name =>\n-                              New_Reference_To (Comp, Loc))));\n+                    Build_Renamed_Formal_Declaration\n+                      (New_F, Formal, Comp, Renamed_Formal);\n \n                   if No (Declarations (N)) then\n                      Set_Declarations (N, New_List);"}]}