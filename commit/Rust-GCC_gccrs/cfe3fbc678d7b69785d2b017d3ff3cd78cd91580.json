{"sha": "cfe3fbc678d7b69785d2b017d3ff3cd78cd91580", "node_id": "C_kwDOANBUbNoAKGNmZTNmYmM2NzhkN2I2OTc4NWQyYjAxN2QzZmYzY2Q3OGNkOTE1ODA", "commit": {"author": {"name": "Ju-Zhe Zhong", "email": "juzhe.zhong@rivai.ai", "date": "2023-01-09T22:33:07Z"}, "committer": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2023-01-26T19:10:15Z"}, "message": "RISC-V: Cleanup the codes of bitmap create and free [NFC]\n\nThis patch is a NFC patch to move the codes into a wrapper function so that\nthey can be reused. I will reuse them in the following patches.\n\ngcc/ChangeLog:\n\n\t* config/riscv/riscv-vsetvl.cc (vector_infos_manager::create_bitmap_vectors): New function.\n\t(vector_infos_manager::free_bitmap_vectors): Ditto.\n\t(pass_vsetvl::pre_vsetvl): Adjust codes.\n\t* config/riscv/riscv-vsetvl.h: New function declaration.", "tree": {"sha": "5d6c321946cea07aaeb7007aedf22b1b6b86a25f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/5d6c321946cea07aaeb7007aedf22b1b6b86a25f"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580/comments", "author": {"login": "zhongjuzhe", "id": 66454988, "node_id": "MDQ6VXNlcjY2NDU0OTg4", "avatar_url": "https://avatars.githubusercontent.com/u/66454988?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zhongjuzhe", "html_url": "https://github.com/zhongjuzhe", "followers_url": "https://api.github.com/users/zhongjuzhe/followers", "following_url": "https://api.github.com/users/zhongjuzhe/following{/other_user}", "gists_url": "https://api.github.com/users/zhongjuzhe/gists{/gist_id}", "starred_url": "https://api.github.com/users/zhongjuzhe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zhongjuzhe/subscriptions", "organizations_url": "https://api.github.com/users/zhongjuzhe/orgs", "repos_url": "https://api.github.com/users/zhongjuzhe/repos", "events_url": "https://api.github.com/users/zhongjuzhe/events{/privacy}", "received_events_url": "https://api.github.com/users/zhongjuzhe/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "387cd9d37950a93225f19bc4054e45638dd7d29a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/387cd9d37950a93225f19bc4054e45638dd7d29a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/387cd9d37950a93225f19bc4054e45638dd7d29a"}], "stats": {"total": 97, "additions": 59, "deletions": 38}, "files": [{"sha": "f67459ca8ca36390e2978217d3695eb0140df7ae", "filename": "gcc/config/riscv/riscv-vsetvl.cc", "status": "modified", "additions": 57, "deletions": 38, "changes": 95, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580/gcc%2Fconfig%2Friscv%2Friscv-vsetvl.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580/gcc%2Fconfig%2Friscv%2Friscv-vsetvl.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-vsetvl.cc?ref=cfe3fbc678d7b69785d2b017d3ff3cd78cd91580", "patch": "@@ -1570,18 +1570,62 @@ vector_infos_manager::release (void)\n     vector_exprs.release ();\n \n   if (optimize > 0)\n-    {\n-      /* Finished. Free up all the things we've allocated.  */\n-      free_edge_list (vector_edge_list);\n-      sbitmap_vector_free (vector_del);\n-      sbitmap_vector_free (vector_insert);\n-      sbitmap_vector_free (vector_kill);\n-      sbitmap_vector_free (vector_antic);\n-      sbitmap_vector_free (vector_transp);\n-      sbitmap_vector_free (vector_comp);\n-      sbitmap_vector_free (vector_avin);\n-      sbitmap_vector_free (vector_avout);\n-    }\n+    free_bitmap_vectors ();\n+}\n+\n+void\n+vector_infos_manager::create_bitmap_vectors (void)\n+{\n+  /* Create the bitmap vectors.  */\n+  vector_antic = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n+\t\t\t\t       vector_exprs.length ());\n+  vector_transp = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n+\t\t\t\t\tvector_exprs.length ());\n+  vector_comp = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n+\t\t\t\t      vector_exprs.length ());\n+  vector_avin = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n+\t\t\t\t      vector_exprs.length ());\n+  vector_avout = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n+\t\t\t\t       vector_exprs.length ());\n+  vector_kill = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n+\t\t\t\t      vector_exprs.length ());\n+\n+  bitmap_vector_ones (vector_transp, last_basic_block_for_fn (cfun));\n+  bitmap_vector_clear (vector_antic, last_basic_block_for_fn (cfun));\n+  bitmap_vector_clear (vector_comp, last_basic_block_for_fn (cfun));\n+}\n+\n+void\n+vector_infos_manager::free_bitmap_vectors (void)\n+{\n+  /* Finished. Free up all the things we've allocated.  */\n+  free_edge_list (vector_edge_list);\n+  if (vector_del)\n+    sbitmap_vector_free (vector_del);\n+  if (vector_insert)\n+    sbitmap_vector_free (vector_insert);\n+  if (vector_kill)\n+    sbitmap_vector_free (vector_kill);\n+  if (vector_antic)\n+    sbitmap_vector_free (vector_antic);\n+  if (vector_transp)\n+    sbitmap_vector_free (vector_transp);\n+  if (vector_comp)\n+    sbitmap_vector_free (vector_comp);\n+  if (vector_avin)\n+    sbitmap_vector_free (vector_avin);\n+  if (vector_avout)\n+    sbitmap_vector_free (vector_avout);\n+\n+  vector_edge_list = nullptr;\n+  vector_kill = nullptr;\n+  vector_del = nullptr;\n+  vector_insert = nullptr;\n+  vector_antic = nullptr;\n+  vector_transp = nullptr;\n+  vector_comp = nullptr;\n+  vector_avin = nullptr;\n+  vector_avout = nullptr;\n }\n \n void\n@@ -2479,32 +2523,7 @@ pass_vsetvl::pre_vsetvl (void)\n   /* Compute entity list.  */\n   prune_expressions ();\n \n-  /* Create the bitmap vectors.  */\n-  m_vector_manager->vector_antic\n-    = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n-\t\t\t    m_vector_manager->vector_exprs.length ());\n-  m_vector_manager->vector_transp\n-    = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n-\t\t\t    m_vector_manager->vector_exprs.length ());\n-  m_vector_manager->vector_comp\n-    = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n-\t\t\t    m_vector_manager->vector_exprs.length ());\n-  m_vector_manager->vector_avin\n-    = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n-\t\t\t    m_vector_manager->vector_exprs.length ());\n-  m_vector_manager->vector_avout\n-    = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n-\t\t\t    m_vector_manager->vector_exprs.length ());\n-  m_vector_manager->vector_kill\n-    = sbitmap_vector_alloc (last_basic_block_for_fn (cfun),\n-\t\t\t    m_vector_manager->vector_exprs.length ());\n-\n-  bitmap_vector_ones (m_vector_manager->vector_transp,\n-\t\t      last_basic_block_for_fn (cfun));\n-  bitmap_vector_clear (m_vector_manager->vector_antic,\n-\t\t       last_basic_block_for_fn (cfun));\n-  bitmap_vector_clear (m_vector_manager->vector_comp,\n-\t\t       last_basic_block_for_fn (cfun));\n+  m_vector_manager->create_bitmap_vectors ();\n   compute_local_properties ();\n   m_vector_manager->vector_edge_list = pre_edge_lcm_avs (\n     m_vector_manager->vector_exprs.length (), m_vector_manager->vector_transp,"}, {"sha": "1038f35523ea1f89139f3b4fc8223056b6f186a0", "filename": "gcc/config/riscv/riscv-vsetvl.h", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580/gcc%2Fconfig%2Friscv%2Friscv-vsetvl.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cfe3fbc678d7b69785d2b017d3ff3cd78cd91580/gcc%2Fconfig%2Friscv%2Friscv-vsetvl.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-vsetvl.h?ref=cfe3fbc678d7b69785d2b017d3ff3cd78cd91580", "patch": "@@ -341,6 +341,8 @@ class vector_infos_manager\n   bool all_same_ratio_p (sbitmap) const;\n \n   void release (void);\n+  void create_bitmap_vectors (void);\n+  void free_bitmap_vectors (void);\n \n   void dump (FILE *) const;\n };"}]}