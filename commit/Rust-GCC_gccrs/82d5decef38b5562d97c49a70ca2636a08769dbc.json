{"sha": "82d5decef38b5562d97c49a70ca2636a08769dbc", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ODJkNWRlY2VmMzhiNTU2MmQ5N2M0OWE3MGNhMjYzNmEwODc2OWRiYw==", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-05-01T17:53:32Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2020-05-01T17:53:34Z"}, "message": "c++: Local class DMI using local static [PR90479]\n\nFor default member initializers in templates it's important to push into the\nright context during get_nsdmi.  But for a local class that's not possible,\nand trying leaves the function context we need to be in, so don't try.\n\ngcc/cp/ChangeLog\n2020-05-01  Jason Merrill  <jason@redhat.com>\n\n\tPR c++/90479\n\t* init.c (get_nsdmi): Don't push_to_top_level for a local class.", "tree": {"sha": "f6657a5d9b232db5e40d3cadf203972e495f6914", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f6657a5d9b232db5e40d3cadf203972e495f6914"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/82d5decef38b5562d97c49a70ca2636a08769dbc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82d5decef38b5562d97c49a70ca2636a08769dbc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/82d5decef38b5562d97c49a70ca2636a08769dbc", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/82d5decef38b5562d97c49a70ca2636a08769dbc/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a2f32550a085984fbaaec962bf7723514ac71dff", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/a2f32550a085984fbaaec962bf7723514ac71dff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/a2f32550a085984fbaaec962bf7723514ac71dff"}], "stats": {"total": 26, "additions": 23, "deletions": 3}, "files": [{"sha": "0675f9826773a53cf3ded81605aa681ef35cd2ec", "filename": "gcc/cp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82d5decef38b5562d97c49a70ca2636a08769dbc/gcc%2Fcp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82d5decef38b5562d97c49a70ca2636a08769dbc/gcc%2Fcp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2FChangeLog?ref=82d5decef38b5562d97c49a70ca2636a08769dbc", "patch": "@@ -1,3 +1,8 @@\n+2020-05-01  Jason Merrill  <jason@redhat.com>\n+\n+\tPR c++/90479\n+\t* init.c (get_nsdmi): Don't push_to_top_level for a local class.\n+\n 2020-05-01  Jason Merrill  <jason@redhat.com>\n \n \tPR c++/91529"}, {"sha": "c7ae9404e0486f12e4aed10b92526b86bab30ea0", "filename": "gcc/cp/init.c", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82d5decef38b5562d97c49a70ca2636a08769dbc/gcc%2Fcp%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82d5decef38b5562d97c49a70ca2636a08769dbc/gcc%2Fcp%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Finit.c?ref=82d5decef38b5562d97c49a70ca2636a08769dbc", "patch": "@@ -585,16 +585,18 @@ get_nsdmi (tree member, bool in_ctor, tsubst_flags_t complain)\n \t  DECL_INSTANTIATING_NSDMI_P (member) = 1;\n \n \t  bool pushed = false;\n-\t  if (!currently_open_class (DECL_CONTEXT (member)))\n+\t  tree ctx = DECL_CONTEXT (member);\n+\t  if (!currently_open_class (ctx)\n+\t      && !LOCAL_CLASS_P (ctx))\n \t    {\n \t      push_to_top_level ();\n-\t      push_nested_class (DECL_CONTEXT (member));\n+\t      push_nested_class (ctx);\n \t      pushed = true;\n \t    }\n \n \t  gcc_checking_assert (!processing_template_decl);\n \n-\t  inject_this_parameter (DECL_CONTEXT (member), TYPE_UNQUALIFIED);\n+\t  inject_this_parameter (ctx, TYPE_UNQUALIFIED);\n \n \t  start_lambda_scope (member);\n "}, {"sha": "06448d92f1241de48f3e2b346918f3a08a37802b", "filename": "gcc/testsuite/g++.dg/cpp0x/nsdmi-template20.C", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/82d5decef38b5562d97c49a70ca2636a08769dbc/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fnsdmi-template20.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/82d5decef38b5562d97c49a70ca2636a08769dbc/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fnsdmi-template20.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp0x%2Fnsdmi-template20.C?ref=82d5decef38b5562d97c49a70ca2636a08769dbc", "patch": "@@ -0,0 +1,13 @@\n+// PR c++/90479\n+// { dg-do compile { target c++11 } }\n+\n+template <int n>\n+void foo ()\n+{\n+  static int i {100};\n+  struct { int a {i++}; } b {};\n+}\n+int main ()\n+{\n+  foo<0> ();\n+}"}]}