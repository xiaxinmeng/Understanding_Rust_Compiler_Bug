{"sha": "5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NWM2YTJiZjI3MjBmZDY0MTJhMmQ2M2EzYTgyZGE1YWYwYzE4ZjgyNA==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2018-08-16T22:33:00Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2018-08-16T22:33:00Z"}, "message": "diagnostics: fix bad interaction between line spans and line numbers\n\nWithout this patch, the \"line span\" markers and the line numbering\ninteracted badly, leading to stray copies of the line-span markers\nappearing as prefixes on the first source line in a span:\n\nmissing-header-fixit-3.c: In function 'test':\nmissing-header-fixit-3.c:9:3: warning: implicit declaration of function 'printf' [-Wimplicit-function-declaration]\n9 |   printf (\"%i of %i\\n\", i, j);\n  |   ^~~~~~\nmissing-header-fixit-3.c:9:3: warning: incompatible implicit declaration of built-in function 'printf'\nmissing-header-fixit-3.c:9:3: note: include '<stdio.h>' or provide a declaration of 'printf'\nmissing-header-fixit-3.c:1:1:\n  |+#include <stdio.h>\nmissing-header-fixit-3.c:1:1:1 | /* Example of a fix-it hint that adds a #include directive,\nmissing-header-fixit-3.c:9:3:\nmissing-header-fixit-3.c:9:3:9 |   printf (\"%i of %i\\n\", i, j);\n  |   ^~~~~~\n\nWith this patch, we now correctly print:\n\nmissing-header-fixit-3.c: In function 'test':\nmissing-header-fixit-3.c:9:3: warning: implicit declaration of function 'printf' [-Wimplicit-function-declaration]\n9 |   printf (\"%i of %i\\n\", i, j);\n  |   ^~~~~~\nmissing-header-fixit-3.c:9:3: warning: incompatible implicit declaration of built-in function 'printf'\nmissing-header-fixit-3.c:9:3: note: include '<stdio.h>' or provide a declaration of 'printf'\nmissing-header-fixit-3.c:1:1:\n+ |+#include <stdio.h>\n1 | /* Example of a fix-it hint that adds a #include directive,\nmissing-header-fixit-3.c:9:3:\n9 |   printf (\"%i of %i\\n\", i, j);\n  |   ^~~~~~\n\ngcc/ChangeLog:\n\t* diagnostic.c (default_diagnostic_start_span_fn): Call pp_string\n\tto emit the span, rather than setting it as the prefix.\n\ngcc/testsuite/ChangeLog:\n\t* gcc.dg/missing-header-fixit-3.c: New test.\n\nFrom-SVN: r263606", "tree": {"sha": "8288ba2c095a7579fae973b7e47977f8190e81d2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8288ba2c095a7579fae973b7e47977f8190e81d2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5218dafdc219eb49a0b8d776b99fd7a7afb5be0b", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5218dafdc219eb49a0b8d776b99fd7a7afb5be0b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5218dafdc219eb49a0b8d776b99fd7a7afb5be0b"}], "stats": {"total": 42, "additions": 39, "deletions": 3}, "files": [{"sha": "146e4e37c3a63b525e089724fbcf43d093a8cad9", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "patch": "@@ -1,3 +1,8 @@\n+2018-08-16  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* diagnostic.c (default_diagnostic_start_span_fn): Call pp_string\n+\tto emit the span, rather than setting it as the prefix.\n+\n 2018-08-16  David Malcolm  <dmalcolm@redhat.com>\n \n \t* diagnostic-show-locus.c (layout::start_annotation_line): Add"}, {"sha": "7e8bcf52dc1e533a62b853cd438afcb65fff2c06", "filename": "gcc/diagnostic.c", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2Fdiagnostic.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2Fdiagnostic.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fdiagnostic.c?ref=5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "patch": "@@ -629,9 +629,9 @@ void\n default_diagnostic_start_span_fn (diagnostic_context *context,\n \t\t\t\t  expanded_location exploc)\n {\n-  pp_set_prefix (context->printer,\n-\t\t diagnostic_get_location_text (context, exploc));\n-  pp_string (context->printer, \"\");\n+  char *text = diagnostic_get_location_text (context, exploc);\n+  pp_string (context->printer, text);\n+  free (text);\n   pp_newline (context->printer);\n }\n "}, {"sha": "ad2de8468ec1736acd541ed47f70fc65457c5cbe", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "patch": "@@ -1,3 +1,7 @@\n+2018-08-16  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* gcc.dg/missing-header-fixit-3.c: New test.\n+\n 2018-08-16  David Malcolm  <dmalcolm@redhat.com>\n \n \t* gcc.dg/plugin/diagnostic-test-show-locus-bw-line-numbers.c"}, {"sha": "8f2fb5b044a3d7cac61988259ceb6f07608b7de4", "filename": "gcc/testsuite/gcc.dg/missing-header-fixit-3.c", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2Ftestsuite%2Fgcc.dg%2Fmissing-header-fixit-3.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/5c6a2bf2720fd6412a2d63a3a82da5af0c18f824/gcc%2Ftestsuite%2Fgcc.dg%2Fmissing-header-fixit-3.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fmissing-header-fixit-3.c?ref=5c6a2bf2720fd6412a2d63a3a82da5af0c18f824", "patch": "@@ -0,0 +1,27 @@\n+/* Example of a fix-it hint that adds a #include directive,\n+   adding them to the top of the file, given that there is no\n+   pre-existing #include.  */\n+\n+/* { dg-options \"-fdiagnostics-show-caret -fdiagnostics-show-line-numbers\" } */\n+\n+void test (int i, int j)\n+{\n+  printf (\"%i of %i\\n\", i, j); /* { dg-warning \"implicit declaration\" } */\n+  /* { dg-message \"include '<stdio.h>' or provide a declaration of 'printf'\" \"\" { target *-*-* } .-1 } */\n+#if 0\n+/* { dg-begin-multiline-output \"\" }\n+9 |   printf (\"%i of %i\\n\", i, j);\n+  |   ^~~~~~\n+   { dg-end-multiline-output \"\" } */\n+/* { dg-regexp \".*missing-header-fixit-3.c:1:1:\" } */\n+/* { dg-begin-multiline-output \"\" }\n++ |+#include <stdio.h>\n+1 | /* Example of a fix-it hint that adds a #include directive,\n+   { dg-end-multiline-output \"\" } */\n+/* { dg-regexp \".*missing-header-fixit-3.c:9:3:\" } */\n+/* { dg-begin-multiline-output \"\" }\n+9 |   printf (\"%i of %i\\n\", i, j);\n+  |   ^~~~~~\n+   { dg-end-multiline-output \"\" } */\n+#endif\n+}"}]}