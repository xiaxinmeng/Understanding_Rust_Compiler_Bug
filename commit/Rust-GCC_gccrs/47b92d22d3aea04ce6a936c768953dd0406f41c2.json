{"sha": "47b92d22d3aea04ce6a936c768953dd0406f41c2", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NDdiOTJkMjJkM2FlYTA0Y2U2YTkzNmM3Njg5NTNkZDA0MDZmNDFjMg==", "commit": {"author": {"name": "Tobias Burnus", "email": "burnus@net-b.de", "date": "2018-10-12T18:18:13Z"}, "committer": {"name": "Tobias Burnus", "email": "burnus@gcc.gnu.org", "date": "2018-10-12T18:18:13Z"}, "message": "Fix off-by-one issue with inline matmul\n\n        PR fortran/87597\n        * expr.c (gfc_simplify_expr): Avoid simplifying\n        the 'array' argument to lbound/ubound/lcobound/\n        ucobound.\n\n        PR fortran/87597\n        * gfortran.dg/inline_matmul_24.f90: New.\n\nFrom-SVN: r265126", "tree": {"sha": "3aa254da8f50163132eac6447ce9497870ab06cb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/3aa254da8f50163132eac6447ce9497870ab06cb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/47b92d22d3aea04ce6a936c768953dd0406f41c2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47b92d22d3aea04ce6a936c768953dd0406f41c2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/47b92d22d3aea04ce6a936c768953dd0406f41c2", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/47b92d22d3aea04ce6a936c768953dd0406f41c2/comments", "author": {"login": "tob2", "id": 264461, "node_id": "MDQ6VXNlcjI2NDQ2MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/264461?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tob2", "html_url": "https://github.com/tob2", "followers_url": "https://api.github.com/users/tob2/followers", "following_url": "https://api.github.com/users/tob2/following{/other_user}", "gists_url": "https://api.github.com/users/tob2/gists{/gist_id}", "starred_url": "https://api.github.com/users/tob2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tob2/subscriptions", "organizations_url": "https://api.github.com/users/tob2/orgs", "repos_url": "https://api.github.com/users/tob2/repos", "events_url": "https://api.github.com/users/tob2/events{/privacy}", "received_events_url": "https://api.github.com/users/tob2/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "b4439561c4019cf3bc4c59cc6260d7464917f1e5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b4439561c4019cf3bc4c59cc6260d7464917f1e5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b4439561c4019cf3bc4c59cc6260d7464917f1e5"}], "stats": {"total": 69, "additions": 68, "deletions": 1}, "files": [{"sha": "4ee065a19a0b74a89009edb994f4e5f10ce75926", "filename": "gcc/fortran/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ffortran%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ffortran%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2FChangeLog?ref=47b92d22d3aea04ce6a936c768953dd0406f41c2", "patch": "@@ -1,3 +1,10 @@\n+2018-10-12  Tobias Burnus  <burnus@net-b.de>\n+\n+\tPR fortran/87597\n+\t* expr.c (gfc_simplify_expr): Avoid simplifying\n+\tthe 'array' argument to lbound/ubound/lcobound/\n+\tucobound.\n+\n 2018-10-12  Tobias Burnus <burnus@net-b.de>\n \n \tPR fortran/58787"}, {"sha": "ca6f95d9d8ef02f1006f1d28f81a3c4c7d41151b", "filename": "gcc/fortran/expr.c", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ffortran%2Fexpr.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ffortran%2Fexpr.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Fexpr.c?ref=47b92d22d3aea04ce6a936c768953dd0406f41c2", "patch": "@@ -1937,7 +1937,20 @@ gfc_simplify_expr (gfc_expr *p, int type)\n       break;\n \n     case EXPR_FUNCTION:\n-      for (ap = p->value.function.actual; ap; ap = ap->next)\n+      // For array-bound functions, we don't need to optimize\n+      // the 'array' argument. In particular, if the argument\n+      // is a PARAMETER, simplifying might convert an EXPR_VARIABLE\n+      // into an EXPR_ARRAY; the latter has lbound = 1, the former\n+      // can have any lbound.\n+      ap = p->value.function.actual;\n+      if (p->value.function.isym &&\n+\t  (p->value.function.isym->id == GFC_ISYM_LBOUND\n+\t   || p->value.function.isym->id == GFC_ISYM_UBOUND\n+\t   || p->value.function.isym->id == GFC_ISYM_LCOBOUND\n+\t   || p->value.function.isym->id == GFC_ISYM_UCOBOUND))\n+\tap = ap->next;\n+\n+      for ( ; ap; ap = ap->next)\n \tif (!gfc_simplify_expr (ap->expr, type))\n \t  return false;\n "}, {"sha": "3604fe631374bd551fd69925ed3548d2953d17c4", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=47b92d22d3aea04ce6a936c768953dd0406f41c2", "patch": "@@ -1,3 +1,8 @@\n+2018-10-12  Tobias Burnus  <burnus@net-b.de>\n+\n+\tPR fortran/87597\n+\t* gfortran.dg/inline_matmul_24.f90: New.\n+\n 2018-10-12  Tobias Burnus <burnus@net-b.de>\n \n \tPR fortran/58787"}, {"sha": "067f6daf20011cfa76c374ca69501ecc8f4640be", "filename": "gcc/testsuite/gfortran.dg/inline_matmul_24.f90", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ftestsuite%2Fgfortran.dg%2Finline_matmul_24.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/47b92d22d3aea04ce6a936c768953dd0406f41c2/gcc%2Ftestsuite%2Fgfortran.dg%2Finline_matmul_24.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Finline_matmul_24.f90?ref=47b92d22d3aea04ce6a936c768953dd0406f41c2", "patch": "@@ -0,0 +1,42 @@\n+! { dg-do run }\n+! { dg-options \"-ffrontend-optimize -fdump-tree-original\" }\n+!\n+! PR fortran/87597\n+!\n+! Contributed by gallmeister\n+!\n+! Before, for the inlined matmul,\n+! gamma5 was converted to an EXPR_ARRAY with lbound = 1\n+! instead of the lbound = 0 as declared; leading to\n+! an off-by-one problem.\n+!\n+program testMATMUL\n+  implicit none\n+    complex, dimension(0:3,0:3), parameter :: gamma5 = reshape((/ 0., 0., 1., 0., &\n+                                                                  0., 0., 0., 1., &\n+                                                                  1., 0., 0., 0., &\n+                                                                  0., 1., 0., 0. /),(/4,4/))\n+    complex, dimension(0:3,0:3) :: A, B, D\n+    integer :: i\n+\n+    A = 0.0\n+    do i=0,3\n+       A(i,i) = i*1.0\n+    end do\n+\n+    B = cmplx(7,-9)\n+    B = matmul(A,gamma5)\n+\n+    D = reshape([0, 0, 2, 0, &\n+                 0, 0, 0, 3, &\n+                 0, 0, 0, 0, &\n+                 0, 1, 0, 0], [4, 4])\n+    write(*,*) B(0,:)\n+    write(*,*) B(1,:)\n+    write(*,*) B(2,:)\n+    write(*,*) B(3,:)\n+    if (any(B /= D)) then\n+      call abort()\n+    end if\n+end program testMATMUL\n+! { dg-final { scan-tree-dump-times \"gamma5\\[__var_1_do \\\\* 4 \\\\+ __var_2_do\\]\" 1 \"optimized\" } }"}]}