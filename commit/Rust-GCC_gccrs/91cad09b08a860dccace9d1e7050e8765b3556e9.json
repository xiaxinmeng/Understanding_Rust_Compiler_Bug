{"sha": "91cad09b08a860dccace9d1e7050e8765b3556e9", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OTFjYWQwOWIwOGE4NjBkY2NhY2U5ZDFlNzA1MGU4NzY1YjM1NTZlOQ==", "commit": {"author": {"name": "Aldy Hernandez", "email": "aldyh@redhat.com", "date": "2012-09-25T18:47:35Z"}, "committer": {"name": "Aldy Hernandez", "email": "aldyh@gcc.gnu.org", "date": "2012-09-25T18:47:35Z"}, "message": "re PR middle-end/53850 (ICE: in expand_call_tm, at trans-mem.c:2289 with -fgnu-tm -O3)\n\n\tPR middle-end/53850\n\t* trans-mem.c (expand_call_tm): Handle late built built-ins.\n\nFrom-SVN: r191742", "tree": {"sha": "43a9f5373199441ba337103f0ee877ac4265d3c5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/43a9f5373199441ba337103f0ee877ac4265d3c5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/91cad09b08a860dccace9d1e7050e8765b3556e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/91cad09b08a860dccace9d1e7050e8765b3556e9", "html_url": "https://github.com/Rust-GCC/gccrs/commit/91cad09b08a860dccace9d1e7050e8765b3556e9", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/91cad09b08a860dccace9d1e7050e8765b3556e9/comments", "author": {"login": "aldyh", "id": 12937877, "node_id": "MDQ6VXNlcjEyOTM3ODc3", "avatar_url": "https://avatars.githubusercontent.com/u/12937877?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aldyh", "html_url": "https://github.com/aldyh", "followers_url": "https://api.github.com/users/aldyh/followers", "following_url": "https://api.github.com/users/aldyh/following{/other_user}", "gists_url": "https://api.github.com/users/aldyh/gists{/gist_id}", "starred_url": "https://api.github.com/users/aldyh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aldyh/subscriptions", "organizations_url": "https://api.github.com/users/aldyh/orgs", "repos_url": "https://api.github.com/users/aldyh/repos", "events_url": "https://api.github.com/users/aldyh/events{/privacy}", "received_events_url": "https://api.github.com/users/aldyh/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5139232eef79c85e9dccb1c04cc5f01f6af12a6f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5139232eef79c85e9dccb1c04cc5f01f6af12a6f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5139232eef79c85e9dccb1c04cc5f01f6af12a6f"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "f09f1c84f220583822810a691319140e1b5a196c", "filename": "gcc/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/91cad09b08a860dccace9d1e7050e8765b3556e9/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/91cad09b08a860dccace9d1e7050e8765b3556e9/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=91cad09b08a860dccace9d1e7050e8765b3556e9", "patch": "@@ -1,3 +1,8 @@\n+2012-09-25  Aldy Hernandez  <aldyh@redhat.com>\n+\n+\tPR middle-end/53850\n+\t* trans-mem.c (expand_call_tm): Handle late built built-ins.\n+\n 2012-09-25  Georg-Johann Lay  <avr@gjlay.de>\n \n \tPR other/54701"}, {"sha": "ca2c6043bbbe7c594bfd89a3559f027f4336fc8f", "filename": "gcc/testsuite/gcc.dg/tm/pr53850.c", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/91cad09b08a860dccace9d1e7050e8765b3556e9/gcc%2Ftestsuite%2Fgcc.dg%2Ftm%2Fpr53850.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/91cad09b08a860dccace9d1e7050e8765b3556e9/gcc%2Ftestsuite%2Fgcc.dg%2Ftm%2Fpr53850.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Ftm%2Fpr53850.c?ref=91cad09b08a860dccace9d1e7050e8765b3556e9", "patch": "@@ -0,0 +1,15 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-fgnu-tm -O3\" } */\n+\n+unsigned char pp[100];\n+\n+void\n+foo (void)\n+{\n+  int i;\n+  __transaction_atomic\n+  {\n+    for (i = 0; i < 100; ++i)\n+      pp[i] = 0x33;\n+  }\n+}"}, {"sha": "ef384acd7dc5784e4f0dde5794ec29b01df99819", "filename": "gcc/trans-mem.c", "status": "modified", "additions": 25, "deletions": 2, "changes": 27, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/91cad09b08a860dccace9d1e7050e8765b3556e9/gcc%2Ftrans-mem.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/91cad09b08a860dccace9d1e7050e8765b3556e9/gcc%2Ftrans-mem.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftrans-mem.c?ref=91cad09b08a860dccace9d1e7050e8765b3556e9", "patch": "@@ -2296,8 +2296,31 @@ expand_call_tm (struct tm_region *region,\n     }\n \n   node = cgraph_get_node (fn_decl);\n-  /* All calls should have cgraph here. */\n-  gcc_assert (node);\n+  /* All calls should have cgraph here.  */\n+  if (!node)\n+    {\n+      /* We can have a nodeless call here if some pass after IPA-tm\n+\t added uninstrumented calls.  For example, loop distribution\n+\t can transform certain loop constructs into __builtin_mem*\n+\t calls.  In this case, see if we have a suitable TM\n+\t replacement and fill in the gaps.  */\n+      gcc_assert (DECL_BUILT_IN_CLASS (fn_decl) == BUILT_IN_NORMAL);\n+      enum built_in_function code = DECL_FUNCTION_CODE (fn_decl);\n+      gcc_assert (code == BUILT_IN_MEMCPY\n+\t\t  || code == BUILT_IN_MEMMOVE\n+\t\t  || code == BUILT_IN_MEMSET);\n+\n+      tree repl = find_tm_replacement_function (fn_decl);\n+      if (repl)\n+\t{\n+\t  gimple_call_set_fndecl (stmt, repl);\n+\t  update_stmt (stmt);\n+\t  node = cgraph_create_node (repl);\n+\t  node->local.tm_may_enter_irr = false;\n+\t  return expand_call_tm (region, gsi);\n+\t}\n+      gcc_unreachable ();\n+    }\n   if (node->local.tm_may_enter_irr)\n     transaction_subcode_ior (region, GTMA_MAY_ENTER_IRREVOCABLE);\n "}]}