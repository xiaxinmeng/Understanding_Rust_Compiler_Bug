{"sha": "73d9b0e5947e162386f7e25d3851097cee1bb366", "node_id": "C_kwDOANBUbNoAKDczZDliMGU1OTQ3ZTE2MjM4NmY3ZTI1ZDM4NTEwOTdjZWUxYmIzNjY", "commit": {"author": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2022-09-20T21:12:29Z"}, "committer": {"name": "Jason Merrill", "email": "jason@redhat.com", "date": "2022-09-29T17:50:54Z"}, "message": "c++: check DECL_INITIAL for constexpr\n\nWe were overlooking non-potentially-constant bits in variable initializer\nbecause we didn't walk into DECL_INITIAL.\n\ngcc/cp/ChangeLog:\n\n\t* constexpr.cc (potential_constant_expression_1): Look into\n\tDECL_INITIAL.  Use location wrappers.\n\ngcc/testsuite/ChangeLog:\n\n\t* g++.dg/cpp1y/constexpr-local4.C: Expect error sooner.\n\t* g++.dg/cpp2a/consteval24.C: Likewise.\n\t* g++.dg/cpp2a/consteval7.C: Likewise.\n\t* g++.dg/cpp2a/inline-asm3.C: Likewise.", "tree": {"sha": "4ba1a5ad4680256996b60ca0e0f58fa8e965656a", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4ba1a5ad4680256996b60ca0e0f58fa8e965656a"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/73d9b0e5947e162386f7e25d3851097cee1bb366", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/73d9b0e5947e162386f7e25d3851097cee1bb366", "html_url": "https://github.com/Rust-GCC/gccrs/commit/73d9b0e5947e162386f7e25d3851097cee1bb366", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/73d9b0e5947e162386f7e25d3851097cee1bb366/comments", "author": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jicama", "id": 266146, "node_id": "MDQ6VXNlcjI2NjE0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/266146?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jicama", "html_url": "https://github.com/jicama", "followers_url": "https://api.github.com/users/jicama/followers", "following_url": "https://api.github.com/users/jicama/following{/other_user}", "gists_url": "https://api.github.com/users/jicama/gists{/gist_id}", "starred_url": "https://api.github.com/users/jicama/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jicama/subscriptions", "organizations_url": "https://api.github.com/users/jicama/orgs", "repos_url": "https://api.github.com/users/jicama/repos", "events_url": "https://api.github.com/users/jicama/events{/privacy}", "received_events_url": "https://api.github.com/users/jicama/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bbdb5612f6661f2c64b0c0f1d2291cb59fde2b40", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/bbdb5612f6661f2c64b0c0f1d2291cb59fde2b40", "html_url": "https://github.com/Rust-GCC/gccrs/commit/bbdb5612f6661f2c64b0c0f1d2291cb59fde2b40"}], "stats": {"total": 17, "additions": 10, "deletions": 7}, "files": [{"sha": "ed41d7552696ab137db13098de4c46b7f56b5d40", "filename": "gcc/cp/constexpr.cc", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Fcp%2Fconstexpr.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Fcp%2Fconstexpr.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fconstexpr.cc?ref=73d9b0e5947e162386f7e25d3851097cee1bb366", "patch": "@@ -8892,7 +8892,10 @@ potential_constant_expression_1 (tree t, bool want_rval, bool strict, bool now,\n       {\n         tree from = TREE_OPERAND (t, 0);\n \tif (location_wrapper_p (t))\n-\t  return (RECUR (from, want_rval));\n+\t  {\n+\t    iloc_sentinel ils = loc;\n+\t    return (RECUR (from, want_rval));\n+\t  }\n \tif (INDIRECT_TYPE_P (TREE_TYPE (t)))\n \t  {\n \t    STRIP_ANY_LOCATION_WRAPPER (from);\n@@ -9348,7 +9351,7 @@ potential_constant_expression_1 (tree t, bool want_rval, bool strict, bool now,\n \t\t   (tmp, /*constexpr_context_p=*/true, flags))\n \t    return false;\n \t}\n-      return RECUR (tmp, want_rval);\n+      return RECUR (DECL_INITIAL (tmp), want_rval);\n \n     case TRY_FINALLY_EXPR:\n       return (RECUR (TREE_OPERAND (t, 0), want_rval)"}, {"sha": "647b5dcd7cd5a8beaec5077ad2eba900238f8d8a", "filename": "gcc/testsuite/g++.dg/cpp1y/constexpr-local4.C", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fconstexpr-local4.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fconstexpr-local4.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp1y%2Fconstexpr-local4.C?ref=73d9b0e5947e162386f7e25d3851097cee1bb366", "patch": "@@ -10,8 +10,8 @@ const A a = 42;\n \n constexpr int f()\n {\n-  const int j = a.i;\t\t// { dg-message \"'a'\" }\n+  const int j = a.i;\t\t// { dg-error \"'a'\" }\n   return j;\n }\n \n-static_assert (f() == 42,\"\");\t// { dg-error \"non-constant\" }\n+static_assert (f() == 42,\"\");\t// { dg-error \"\" }"}, {"sha": "6d7034c5515e322c5a4ac102cace4da80434d3cd", "filename": "gcc/testsuite/g++.dg/cpp2a/consteval24.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fconsteval24.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fconsteval24.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fconsteval24.C?ref=73d9b0e5947e162386f7e25d3851097cee1bb366", "patch": "@@ -27,4 +27,4 @@ bar ()\n   return fn1 () + fn2 () + (s.*fn3) () + (s.*fn4) () + fn5 () + (s.*fn6) () + (s.*fn7) ();\n }\n \n-auto a = bar ();\n+auto a = bar ();\t\t// { dg-error \"bar\" }"}, {"sha": "74996d31a82e7b0bedca15512b360039feecde6b", "filename": "gcc/testsuite/g++.dg/cpp2a/consteval7.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fconsteval7.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fconsteval7.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Fconsteval7.C?ref=73d9b0e5947e162386f7e25d3851097cee1bb366", "patch": "@@ -10,4 +10,4 @@ consteval int qux () { S s = baz (); return s.b + s.c (); }\n consteval int quux () { constexpr S s = baz (); return s.b + s.c (); }\t// { dg-error \"immediate evaluation returns address of immediate function 'consteval int foo\\\\(\\\\)'\" }\n constexpr auto d = baz ();\t// { dg-error \"immediate evaluation returns address of immediate function 'consteval int foo\\\\(\\\\)'\" }\n constexpr auto e = qux ();\n-constexpr auto f = quux ();\n+constexpr auto f = quux ();\t// { dg-error \"quux\" }"}, {"sha": "a6f612e2447eceaba5a2a20f113ecddcf8337705", "filename": "gcc/testsuite/g++.dg/cpp2a/inline-asm3.C", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Finline-asm3.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73d9b0e5947e162386f7e25d3851097cee1bb366/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Finline-asm3.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fcpp2a%2Finline-asm3.C?ref=73d9b0e5947e162386f7e25d3851097cee1bb366", "patch": "@@ -9,4 +9,4 @@ foo ()\n  return i;\n }\n \n-constexpr int i = foo ();\n+constexpr int i = foo ();\t// { dg-error \"foo\" }"}]}