{"sha": "dbf96d49454d608b5cb9e39e341e13b60ec7965e", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZGJmOTZkNDk0NTRkNjA4YjVjYjllMzllMzQxZTEzYjYwZWM3OTY1ZQ==", "commit": {"author": {"name": "David Malcolm", "email": "dmalcolm@redhat.com", "date": "2018-07-02T20:05:21Z"}, "committer": {"name": "David Malcolm", "email": "dmalcolm@gcc.gnu.org", "date": "2018-07-02T20:05:21Z"}, "message": "selftest: introduce class auto_fix_quotes\n\nThis patch moves a workaround for locale differences from a\nselftest in pretty-print.c to selftest.h/c to make it reusable; I need\nthis for a selftest in a followup patch.\n\ngcc/ChangeLog:\n\t* pretty-print.c (selftest::test_pp_format): Move save and restore\n\tof quotes to class auto_fix_quotes, and add an instance.\n\t* selftest.c: Include \"intl.h\".\n\t(selftest::auto_fix_quotes::auto_fix_quotes): New ctor.\n\t(selftest::auto_fix_quotes::~auto_fix_quotes): New dtor.\n\t* selftest.h (selftest::auto_fix_quotes): New class.\n\nFrom-SVN: r262317", "tree": {"sha": "2cefe7783c5b50896e82533f6e80f65347c8ef70", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/2cefe7783c5b50896e82533f6e80f65347c8ef70"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/dbf96d49454d608b5cb9e39e341e13b60ec7965e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbf96d49454d608b5cb9e39e341e13b60ec7965e", "html_url": "https://github.com/Rust-GCC/gccrs/commit/dbf96d49454d608b5cb9e39e341e13b60ec7965e", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/dbf96d49454d608b5cb9e39e341e13b60ec7965e/comments", "author": {"login": "davidmalcolm", "id": 1553248, "node_id": "MDQ6VXNlcjE1NTMyNDg=", "avatar_url": "https://avatars.githubusercontent.com/u/1553248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidmalcolm", "html_url": "https://github.com/davidmalcolm", "followers_url": "https://api.github.com/users/davidmalcolm/followers", "following_url": "https://api.github.com/users/davidmalcolm/following{/other_user}", "gists_url": "https://api.github.com/users/davidmalcolm/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidmalcolm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidmalcolm/subscriptions", "organizations_url": "https://api.github.com/users/davidmalcolm/orgs", "repos_url": "https://api.github.com/users/davidmalcolm/repos", "events_url": "https://api.github.com/users/davidmalcolm/events{/privacy}", "received_events_url": "https://api.github.com/users/davidmalcolm/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7edd4c1885f4ecc31b80f157f7aa96ccd40d1075", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/7edd4c1885f4ecc31b80f157f7aa96ccd40d1075", "html_url": "https://github.com/Rust-GCC/gccrs/commit/7edd4c1885f4ecc31b80f157f7aa96ccd40d1075"}], "stats": {"total": 58, "additions": 50, "deletions": 8}, "files": [{"sha": "e0b5c65062aa29edb619723f2e97477e48709dbf", "filename": "gcc/ChangeLog", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=dbf96d49454d608b5cb9e39e341e13b60ec7965e", "patch": "@@ -1,3 +1,12 @@\n+2018-07-02  David Malcolm  <dmalcolm@redhat.com>\n+\n+\t* pretty-print.c (selftest::test_pp_format): Move save and restore\n+\tof quotes to class auto_fix_quotes, and add an instance.\n+\t* selftest.c: Include \"intl.h\".\n+\t(selftest::auto_fix_quotes::auto_fix_quotes): New ctor.\n+\t(selftest::auto_fix_quotes::~auto_fix_quotes): New dtor.\n+\t* selftest.h (selftest::auto_fix_quotes): New class.\n+\n 2018-07-02  Richard Henderson  <richard.henderson@linaro.org>\n \n \t* config/aarch64/aarch64-protos.h, config/aarch64/aarch64.c"}, {"sha": "df3ee811fd591065d20b3599550acb26d4eca658", "filename": "gcc/pretty-print.c", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2Fpretty-print.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2Fpretty-print.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fpretty-print.c?ref=dbf96d49454d608b5cb9e39e341e13b60ec7965e", "patch": "@@ -2102,10 +2102,7 @@ test_pp_format ()\n {\n   /* Avoid introducing locale-specific differences in the results\n      by hardcoding open_quote and close_quote.  */\n-  const char *old_open_quote = open_quote;\n-  const char *old_close_quote = close_quote;\n-  open_quote = \"`\";\n-  close_quote = \"'\";\n+  auto_fix_quotes fix_quotes;\n \n   /* Verify that plain text is passed through unchanged.  */\n   assert_pp_format (SELFTEST_LOCATION, \"unformatted\", \"unformatted\");\n@@ -2187,10 +2184,6 @@ test_pp_format ()\n   assert_pp_format (SELFTEST_LOCATION, \"item 3 of 7\", \"item %i of %i\", 3, 7);\n   assert_pp_format (SELFTEST_LOCATION, \"problem with `bar' at line 10\",\n \t\t    \"problem with %qs at line %i\", \"bar\", 10);\n-\n-  /* Restore old values of open_quote and close_quote.  */\n-  open_quote = old_open_quote;\n-  close_quote = old_close_quote;\n }\n \n /* Run all of the selftests within this file.  */"}, {"sha": "dc90557d79d3bda05d2cffade88071fbcb7a25c0", "filename": "gcc/selftest.c", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2Fselftest.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2Fselftest.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fselftest.c?ref=dbf96d49454d608b5cb9e39e341e13b60ec7965e", "patch": "@@ -21,6 +21,7 @@ along with GCC; see the file COPYING3.  If not see\n #include \"system.h\"\n #include \"coretypes.h\"\n #include \"selftest.h\"\n+#include \"intl.h\"\n \n #if CHECKING_P\n \n@@ -192,6 +193,25 @@ temp_source_file::temp_source_file (const location &loc,\n   fclose (out);\n }\n \n+/* Avoid introducing locale-specific differences in the results\n+   by hardcoding open_quote and close_quote.  */\n+\n+auto_fix_quotes::auto_fix_quotes ()\n+{\n+  m_saved_open_quote = open_quote;\n+  m_saved_close_quote = close_quote;\n+  open_quote = \"`\";\n+  close_quote = \"'\";\n+}\n+\n+/* Restore old values of open_quote and close_quote.  */\n+\n+auto_fix_quotes::~auto_fix_quotes ()\n+{\n+  open_quote = m_saved_open_quote;\n+  close_quote = m_saved_close_quote;\n+}\n+\n /* Read the contents of PATH into memory, returning a 0-terminated buffer\n    that must be freed by the caller.\n    Fail (and abort) if there are any problems, with LOC as the reported"}, {"sha": "54fc488d8459cfd046652ffd59be58877cd34eef", "filename": "gcc/selftest.h", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2Fselftest.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/dbf96d49454d608b5cb9e39e341e13b60ec7965e/gcc%2Fselftest.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fselftest.h?ref=dbf96d49454d608b5cb9e39e341e13b60ec7965e", "patch": "@@ -113,6 +113,26 @@ class temp_source_file : public named_temp_file\n \t\t    const char *content);\n };\n \n+/* RAII-style class for avoiding introducing locale-specific differences\n+   in strings containing localized quote marks, by temporarily overriding\n+   the \"open_quote\" and \"close_quote\" globals to something hardcoded.\n+\n+   Specifically, the C locale's values are used:\n+   - open_quote becomes \"`\"\n+   - close_quote becomes \"'\"\n+   for the lifetime of the object.  */\n+\n+class auto_fix_quotes\n+{\n+ public:\n+  auto_fix_quotes ();\n+  ~auto_fix_quotes ();\n+\n+ private:\n+  const char *m_saved_open_quote;\n+  const char *m_saved_close_quote;\n+};\n+\n /* Various selftests involving location-handling require constructing a\n    line table and one or more line maps within it.\n "}]}