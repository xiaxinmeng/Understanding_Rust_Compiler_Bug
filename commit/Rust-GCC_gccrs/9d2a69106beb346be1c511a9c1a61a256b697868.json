{"sha": "9d2a69106beb346be1c511a9c1a61a256b697868", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6OWQyYTY5MTA2YmViMzQ2YmUxYzUxMWE5YzFhNjFhMjU2YjY5Nzg2OA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-02-24T19:11:11Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2021-02-24T19:11:11Z"}, "message": "openmp: Diagnose invalid teams nested in target construct [PR99226]\n\nThe OpenMP standard says:\n\"A teams region can only be strictly nested within the implicit parallel region\nor a target region. If a teams construct is nested within a target construct,\nthat target construct must contain no statements, declarations or directives\noutside of the teams construct.\"\nWe weren't diagnosing that restriction, because we need to allow e.g.\n #pragma omp target\n {{{{{{\n   #pragma omp teams\n   ;\n }}}}}}\nand as target doesn't need to have teams nested in it, using some special\nparser of the target body didn't feel right.  And after the parsing,\nthe question is if e.g. already parsing of the clauses doesn't add some\nstatements before the teams statement (gimplification certainly will).\n\nAs we now have a bugreport where we ICE on the invalid code, this just\ndiagnoses a subset of the invalid programs, in particular those where\nnest to the teams strictly nested in targets the target region contains\nsome other OpenMP construct.\n\n2021-02-24  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR fortran/99226\n\t* omp-low.c (struct omp_context): Add teams_nested_p and\n\tnonteams_nested_p members.\n\t(scan_omp_target): Diagnose teams nested inside of target with other\n\tdirectives strictly nested inside of the same target.\n\t(check_omp_nesting_restrictions): Set ctx->teams_nested_p or\n\tctx->nonteams_nested_p as needed.\n\n\t* c-c++-common/gomp/pr99226.c: New test.\n\t* gfortran.dg/gomp/pr99226.f90: New test.", "tree": {"sha": "9a4a8cfa512a426e8d92eecada77af812c842663", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/9a4a8cfa512a426e8d92eecada77af812c842663"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/9d2a69106beb346be1c511a9c1a61a256b697868", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9d2a69106beb346be1c511a9c1a61a256b697868", "html_url": "https://github.com/Rust-GCC/gccrs/commit/9d2a69106beb346be1c511a9c1a61a256b697868", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/9d2a69106beb346be1c511a9c1a61a256b697868/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "35da095d7e0614235cb0e241685c5e1a240dc882", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/35da095d7e0614235cb0e241685c5e1a240dc882", "html_url": "https://github.com/Rust-GCC/gccrs/commit/35da095d7e0614235cb0e241685c5e1a240dc882"}], "stats": {"total": 54, "additions": 54, "deletions": 0}, "files": [{"sha": "7b122059c6e83033b7277e714ebe2e407390f401", "filename": "gcc/omp-low.c", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9d2a69106beb346be1c511a9c1a61a256b697868/gcc%2Fomp-low.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9d2a69106beb346be1c511a9c1a61a256b697868/gcc%2Fomp-low.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.c?ref=9d2a69106beb346be1c511a9c1a61a256b697868", "patch": "@@ -171,6 +171,14 @@ struct omp_context\n \n   /* True if there is bind clause on the construct (i.e. a loop construct).  */\n   bool loop_p;\n+\n+  /* Only used for omp target contexts.  True if a teams construct is\n+     strictly nested in it.  */\n+  bool teams_nested_p;\n+\n+  /* Only used for omp target contexts.  True if an OpenMP construct other\n+     than teams is strictly nested in it.  */\n+  bool nonteams_nested_p;\n };\n \n static splay_tree all_contexts;\n@@ -2956,6 +2964,14 @@ scan_omp_target (gomp_target *stmt, omp_context *outer_ctx)\n       if (offloaded)\n \tfixup_child_record_type (ctx);\n     }\n+\n+  if (ctx->teams_nested_p && ctx->nonteams_nested_p)\n+    {\n+      error_at (gimple_location (stmt),\n+\t\t\"%<target%> construct with nested %<teams%> construct \"\n+\t\t\"contains directives outside of the %<teams%> construct\");\n+      gimple_omp_set_body (stmt, gimple_build_bind (NULL, NULL, NULL));\n+    }\n }\n \n /* Scan an OpenMP teams directive.  */\n@@ -3025,6 +3041,14 @@ check_omp_nesting_restrictions (gimple *stmt, omp_context *ctx)\n \n   if (ctx != NULL)\n     {\n+      if (gimple_code (ctx->stmt) == GIMPLE_OMP_TARGET\n+\t  && gimple_omp_target_kind (ctx->stmt) == GF_OMP_TARGET_KIND_REGION)\n+\t{\n+\t  if (gimple_code (stmt) == GIMPLE_OMP_TEAMS && !ctx->teams_nested_p)\n+\t    ctx->teams_nested_p = true;\n+\t  else\n+\t    ctx->nonteams_nested_p = true;\n+\t}\n       if (gimple_code (ctx->stmt) == GIMPLE_OMP_SCAN\n \t  && ctx->outer\n \t  && gimple_code (ctx->outer->stmt) == GIMPLE_OMP_FOR)"}, {"sha": "cc9db62d02947afc95d1aa162241f0f2e13ce2a4", "filename": "gcc/testsuite/c-c++-common/gomp/pr99226.c", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9d2a69106beb346be1c511a9c1a61a256b697868/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99226.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9d2a69106beb346be1c511a9c1a61a256b697868/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99226.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fc-c%2B%2B-common%2Fgomp%2Fpr99226.c?ref=9d2a69106beb346be1c511a9c1a61a256b697868", "patch": "@@ -0,0 +1,17 @@\n+/* PR fortran/99226 */\n+/* { dg-do compile } */\n+\n+void\n+foo (int n)\n+{\n+  int i;\n+  #pragma omp target\t/* { dg-error \"construct with nested 'teams' construct contains directives outside of the 'teams' construct\" } */\n+  {\n+    #pragma omp teams distribute dist_schedule (static, n + 4)\n+    for (i = 0; i < 8; i++)\n+      ;\n+    #pragma omp teams distribute dist_schedule (static, n + 4)\n+    for (i = 0; i < 8; i++)\n+      ;\n+  }\n+}"}, {"sha": "72dbdde2e280f11bab6bd8b7238523acd1507541", "filename": "gcc/testsuite/gfortran.dg/gomp/pr99226.f90", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/9d2a69106beb346be1c511a9c1a61a256b697868/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr99226.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/9d2a69106beb346be1c511a9c1a61a256b697868/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr99226.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fgomp%2Fpr99226.f90?ref=9d2a69106beb346be1c511a9c1a61a256b697868", "patch": "@@ -0,0 +1,13 @@\n+! PR fortran/99226\n+\n+subroutine sub (n)\n+   integer :: n, i\n+   !$omp target\t! { dg-error \"construct with nested 'teams' construct contains directives outside of the 'teams' construct\" }\n+   !$omp teams distribute dist_schedule (static,n+4)\n+   do i = 1, 8\n+   end do\n+   !$omp teams distribute dist_schedule (static,n+4)\n+   do i = 1, 8\n+   end do\n+   !$omp end target\n+end"}]}