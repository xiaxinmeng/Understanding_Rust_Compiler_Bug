{"sha": "f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6ZjdhMDdmNWE1ZDgwNjVlN2YxMTEzM2RkMWY0YWQzNTEwYWIyMTk1Yg==", "commit": {"author": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2021-05-28T12:26:06Z"}, "committer": {"name": "Richard Biener", "email": "rguenther@suse.de", "date": "2021-05-28T13:18:27Z"}, "message": "tree-optimization/100778 - avoid cross-BB vectorization of trapping op\n\nThis avoids vectorizing a possibly trapping operation when lanes\nare handled in different BBs.  I spotted this when working on the\noriginally reported issue in PR100778.\n\n2021-05-28  Richard Biener  <rguenther@suse.de>\n\n\tPR tree-optimization/100778\n\t* tree-vect-slp.c (vect_build_slp_tree_1): Prevent possibly\n\ttrapping ops in different BBs.\n\n\t* gcc.dg/vect/bb-slp-pr100778-1.c: New testcase.", "tree": {"sha": "07149196d312e7880dfd71f84e0e87d6c66cec78", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/07149196d312e7880dfd71f84e0e87d6c66cec78"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b/comments", "author": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rguenth", "id": 2046526, "node_id": "MDQ6VXNlcjIwNDY1MjY=", "avatar_url": "https://avatars.githubusercontent.com/u/2046526?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rguenth", "html_url": "https://github.com/rguenth", "followers_url": "https://api.github.com/users/rguenth/followers", "following_url": "https://api.github.com/users/rguenth/following{/other_user}", "gists_url": "https://api.github.com/users/rguenth/gists{/gist_id}", "starred_url": "https://api.github.com/users/rguenth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rguenth/subscriptions", "organizations_url": "https://api.github.com/users/rguenth/orgs", "repos_url": "https://api.github.com/users/rguenth/repos", "events_url": "https://api.github.com/users/rguenth/events{/privacy}", "received_events_url": "https://api.github.com/users/rguenth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f838e3ccf8d2849980e9d0f70aa60ecd2eb5772c", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f838e3ccf8d2849980e9d0f70aa60ecd2eb5772c", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f838e3ccf8d2849980e9d0f70aa60ecd2eb5772c"}], "stats": {"total": 22, "additions": 20, "deletions": 2}, "files": [{"sha": "9f8b7eecef1572eb8b404d49ad48ed81508f0428", "filename": "gcc/testsuite/gcc.dg/vect/bb-slp-pr100778-1.c", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b/gcc%2Ftestsuite%2Fgcc.dg%2Fvect%2Fbb-slp-pr100778-1.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b/gcc%2Ftestsuite%2Fgcc.dg%2Fvect%2Fbb-slp-pr100778-1.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.dg%2Fvect%2Fbb-slp-pr100778-1.c?ref=f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b", "patch": "@@ -0,0 +1,18 @@\n+/* { dg-do compile } */\n+/* { dg-require-effective-target vect_double } */\n+\n+double foo (int x, double *p)\n+{\n+  double res = p[0] + p[1];\n+  double tem = p[0] / x;\n+  if (x)\n+    {\n+      p[0] = tem;\n+      p[1] /= x;\n+    }\n+  return res + tem;\n+}\n+\n+/* We may not SLP vectorize the FP division because it can trap and it\n+   is distributed between two basic-blocks.  */\n+/* { dg-final { scan-tree-dump \"Build SLP failed: different BB for PHI or possibly trapping operation in _\\[0-9\\]+ = _\\[0-9\\]+ / _\\[0-9\\]+;\" \"slp2\" } } */"}, {"sha": "ca1539e63f20db5de88b05a1da92ba54992b3764", "filename": "gcc/tree-vect-slp.c", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b/gcc%2Ftree-vect-slp.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b/gcc%2Ftree-vect-slp.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftree-vect-slp.c?ref=f7a07f5a5d8065e7f11133dd1f4ad3510ab2195b", "patch": "@@ -1214,14 +1214,14 @@ vect_build_slp_tree_1 (vec_info *vinfo, unsigned char *swap,\n \t\t}\n \t    }\n \n-\t  if (phi_p\n+\t  if ((phi_p || gimple_could_trap_p (stmt_info->stmt))\n \t      && (gimple_bb (first_stmt_info->stmt)\n \t\t  != gimple_bb (stmt_info->stmt)))\n \t    {\n \t      if (dump_enabled_p ())\n \t\tdump_printf_loc (MSG_MISSED_OPTIMIZATION, vect_location,\n \t\t\t\t \"Build SLP failed: different BB for PHI \"\n-\t\t\t\t \"in %G\", stmt);\n+\t\t\t\t \"or possibly trapping operation in %G\", stmt);\n \t      /* Mismatch.  */\n \t      continue;\n \t    }"}]}