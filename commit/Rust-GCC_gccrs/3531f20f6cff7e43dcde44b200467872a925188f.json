{"sha": "3531f20f6cff7e43dcde44b200467872a925188f", "node_id": "C_kwDOANBUbNoAKDM1MzFmMjBmNmNmZjdlNDNkY2RlNDRiMjAwNDY3ODcyYTkyNTE4OGY", "commit": {"author": {"name": "Piotr Trojanek", "email": "trojanek@adacore.com", "date": "2021-11-24T22:21:07Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "derodat@adacore.com", "date": "2022-01-05T11:32:37Z"}, "message": "[Ada] Expand controlling functions wrappers in GNATprove mode\n\ngcc/ada/\n\n\t* exp_ch3.ads (Make_Controlling_Function_Wrappers): Move\n\tdeclaration from body to spec, so it can be called by\n\tSPARK-specific expansion.\n\t* exp_ch3.adb (Make_Controlling_Function_Wrappers): Likewise.\n\t* exp_spark.adb (SPARK_Freeze_Type): Enable expansion of\n\twrappers for function with controlling result types.", "tree": {"sha": "f3bf8a89d0eb7a63e034bd31930339f45357d6b9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f3bf8a89d0eb7a63e034bd31930339f45357d6b9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3531f20f6cff7e43dcde44b200467872a925188f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3531f20f6cff7e43dcde44b200467872a925188f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3531f20f6cff7e43dcde44b200467872a925188f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3531f20f6cff7e43dcde44b200467872a925188f/comments", "author": {"login": "ptroja", "id": 161602, "node_id": "MDQ6VXNlcjE2MTYwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/161602?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptroja", "html_url": "https://github.com/ptroja", "followers_url": "https://api.github.com/users/ptroja/followers", "following_url": "https://api.github.com/users/ptroja/following{/other_user}", "gists_url": "https://api.github.com/users/ptroja/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptroja/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptroja/subscriptions", "organizations_url": "https://api.github.com/users/ptroja/orgs", "repos_url": "https://api.github.com/users/ptroja/repos", "events_url": "https://api.github.com/users/ptroja/events{/privacy}", "received_events_url": "https://api.github.com/users/ptroja/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pmderodat", "id": 758452, "node_id": "MDQ6VXNlcjc1ODQ1Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/758452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pmderodat", "html_url": "https://github.com/pmderodat", "followers_url": "https://api.github.com/users/pmderodat/followers", "following_url": "https://api.github.com/users/pmderodat/following{/other_user}", "gists_url": "https://api.github.com/users/pmderodat/gists{/gist_id}", "starred_url": "https://api.github.com/users/pmderodat/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pmderodat/subscriptions", "organizations_url": "https://api.github.com/users/pmderodat/orgs", "repos_url": "https://api.github.com/users/pmderodat/repos", "events_url": "https://api.github.com/users/pmderodat/events{/privacy}", "received_events_url": "https://api.github.com/users/pmderodat/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "48b8a564c9565635db0a93b9b1e6a31d38547981", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/48b8a564c9565635db0a93b9b1e6a31d38547981", "html_url": "https://github.com/Rust-GCC/gccrs/commit/48b8a564c9565635db0a93b9b1e6a31d38547981"}], "stats": {"total": 54, "additions": 43, "deletions": 11}, "files": [{"sha": "20a1da831cffa812a6aeb82196930f9b8f9d6df3", "filename": "gcc/ada/exp_ch3.adb", "status": "modified", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3531f20f6cff7e43dcde44b200467872a925188f/gcc%2Fada%2Fexp_ch3.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3531f20f6cff7e43dcde44b200467872a925188f/gcc%2Fada%2Fexp_ch3.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch3.adb?ref=3531f20f6cff7e43dcde44b200467872a925188f", "patch": "@@ -294,17 +294,6 @@ package body Exp_Ch3 is\n    --  inherited. If the result is false, the init_proc and the discriminant\n    --  checking functions of the parent can be reused by a derived type.\n \n-   procedure Make_Controlling_Function_Wrappers\n-     (Tag_Typ   : Entity_Id;\n-      Decl_List : out List_Id;\n-      Body_List : out List_Id);\n-   --  Ada 2005 (AI-391): Makes specs and bodies for the wrapper functions\n-   --  associated with inherited functions with controlling results which\n-   --  are not overridden. The body of each wrapper function consists solely\n-   --  of a return statement whose expression is an extension aggregate\n-   --  invoking the inherited subprogram's parent subprogram and extended\n-   --  with a null association list.\n-\n    function Make_Null_Procedure_Specs (Tag_Typ : Entity_Id) return List_Id;\n    --  Ada 2005 (AI-251): Makes specs for null procedures associated with any\n    --  null procedures inherited from an interface type that have not been"}, {"sha": "db78ee9bef8a39e0c0a2d60d7ee4b54800bba0f9", "filename": "gcc/ada/exp_ch3.ads", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3531f20f6cff7e43dcde44b200467872a925188f/gcc%2Fada%2Fexp_ch3.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3531f20f6cff7e43dcde44b200467872a925188f/gcc%2Fada%2Fexp_ch3.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_ch3.ads?ref=3531f20f6cff7e43dcde44b200467872a925188f", "patch": "@@ -158,6 +158,17 @@ package Exp_Ch3 is\n    --  initialized; if Variable_Comps is True then tags components located at\n    --  variable positions of Target are initialized.\n \n+   procedure Make_Controlling_Function_Wrappers\n+     (Tag_Typ   : Entity_Id;\n+      Decl_List : out List_Id;\n+      Body_List : out List_Id);\n+   --  Ada 2005 (AI-391): Makes specs and bodies for the wrapper functions\n+   --  associated with inherited functions with controlling results which\n+   --  are not overridden. The body of each wrapper function consists solely\n+   --  of a return statement whose expression is an extension aggregate\n+   --  invoking the inherited subprogram's parent subprogram and extended\n+   --  with a null association list.\n+\n    procedure Make_Predefined_Primitive_Eq_Spec\n      (Tag_Typ     : Entity_Id;\n       Predef_List : List_Id;"}, {"sha": "62b85ccf21a9a8deeb4775c789013788223de235", "filename": "gcc/ada/exp_spark.adb", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3531f20f6cff7e43dcde44b200467872a925188f/gcc%2Fada%2Fexp_spark.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3531f20f6cff7e43dcde44b200467872a925188f/gcc%2Fada%2Fexp_spark.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fexp_spark.adb?ref=3531f20f6cff7e43dcde44b200467872a925188f", "patch": "@@ -903,6 +903,9 @@ package body Exp_SPARK is\n       Eq_Spec     : Node_Id := Empty;\n       Predef_List : List_Id;\n \n+      Wrapper_Decl_List : List_Id;\n+      Wrapper_Body_List : List_Id := No_List;\n+\n       Saved_GM  : constant Ghost_Mode_Type := Ghost_Mode;\n       Saved_IGR : constant Node_Id         := Ignored_Ghost_Region;\n       --  Save the Ghost-related attributes to restore on exit\n@@ -961,6 +964,35 @@ package body Exp_SPARK is\n          end if;\n       end if;\n \n+      if Ekind (Typ) = E_Record_Type\n+        and then Is_Tagged_Type (Typ)\n+        and then not Is_CPP_Class (Typ)\n+      then\n+         --  Ada 2005 (AI-391): For a nonabstract null extension, create\n+         --  wrapper functions for each nonoverridden inherited function\n+         --  with a controlling result of the type. The wrapper for such\n+         --  a function returns an extension aggregate that invokes the\n+         --  parent function.\n+\n+         if Ada_Version >= Ada_2005\n+           and then not Is_Abstract_Type (Typ)\n+           and then Is_Null_Extension (Typ)\n+         then\n+            Exp_Ch3.Make_Controlling_Function_Wrappers\n+              (Typ, Wrapper_Decl_List, Wrapper_Body_List);\n+            Insert_List_Before_And_Analyze (N, Wrapper_Decl_List);\n+         end if;\n+\n+         --  Ada 2005 (AI-391): If any wrappers were created for nonoverridden\n+         --  inherited functions, then add their bodies to the AST, so they\n+         --  will be processed like ordinary subprogram bodies (even though the\n+         --  compiler adds them into the freezing action).\n+\n+         if not Is_Interface (Typ) then\n+            Insert_List_Before_And_Analyze (N, Wrapper_Body_List);\n+         end if;\n+      end if;\n+\n       Restore_Ghost_Region (Saved_GM, Saved_IGR);\n    end SPARK_Freeze_Type;\n "}]}