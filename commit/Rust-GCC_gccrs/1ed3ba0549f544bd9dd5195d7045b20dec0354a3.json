{"sha": "1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MWVkM2JhMDU0OWY1NDRiZDlkZDUxOTVkNzA0NWIyMGRlYzAzNTRhMw==", "commit": {"author": {"name": "Yaakov Selkowitz", "email": "yselkowi@redhat.com", "date": "2014-08-19T15:25:12Z"}, "committer": {"name": "Kai Tietz", "email": "ktietz@gcc.gnu.org", "date": "2014-08-19T15:25:12Z"}, "message": "os_defines.h (_GLIBCXX_THREAD_ATEXIT_WIN32): Define.\n\n2014-08-19  Yaakov Selkowitz  <yselkowi@redhat.com>\n\tKai Tietz  <ktietz@redhat.com>\n\n\t* config/os/mingw32-w64/os_defines.h (_GLIBCXX_THREAD_ATEXIT_WIN32):\n\tDefine.\n\t* config/os/newlib/os_defines.h (_GLIBCXX_THREAD_ATEXIT_WIN32):\n\tDitto.\n\t* libsupc++/atexit_thread.cc [_GLIBCXX_THREAD_ATEXIT_WIN32]:\n\t#include <windows.h>.\n\t(struct elt): Add dll member.\n\t(run): Decrement dll refcount.\n\t(__cxxabiv1::__cxa_thread_atexit): Increment dll refcount.\n\n\nCo-Authored-By: Kai Tietz <ktietz@redhat.com>\n\nFrom-SVN: r214163", "tree": {"sha": "4ebc6dcde228f02fbdfffc3c62c33700b0653771", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/4ebc6dcde228f02fbdfffc3c62c33700b0653771"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/comments", "author": {"login": "yselkowitz", "id": 13408495, "node_id": "MDQ6VXNlcjEzNDA4NDk1", "avatar_url": "https://avatars.githubusercontent.com/u/13408495?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yselkowitz", "html_url": "https://github.com/yselkowitz", "followers_url": "https://api.github.com/users/yselkowitz/followers", "following_url": "https://api.github.com/users/yselkowitz/following{/other_user}", "gists_url": "https://api.github.com/users/yselkowitz/gists{/gist_id}", "starred_url": "https://api.github.com/users/yselkowitz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yselkowitz/subscriptions", "organizations_url": "https://api.github.com/users/yselkowitz/orgs", "repos_url": "https://api.github.com/users/yselkowitz/repos", "events_url": "https://api.github.com/users/yselkowitz/events{/privacy}", "received_events_url": "https://api.github.com/users/yselkowitz/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "25efdb9f926ae203b89168293e38bc48b85fc20f", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/25efdb9f926ae203b89168293e38bc48b85fc20f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/25efdb9f926ae203b89168293e38bc48b85fc20f"}], "stats": {"total": 44, "additions": 44, "deletions": 0}, "files": [{"sha": "c76492722556dea219c2d12e969daff3c4cff7a9", "filename": "libstdc++-v3/ChangeLog", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2FChangeLog?ref=1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "patch": "@@ -1,3 +1,16 @@\n+2014-08-19  Yaakov Selkowitz  <yselkowi@redhat.com>\n+\tKai Tietz  <ktietz@redhat.com>\n+\n+\t* config/os/mingw32-w64/os_defines.h (_GLIBCXX_THREAD_ATEXIT_WIN32):\n+\tDefine.\n+\t* config/os/newlib/os_defines.h (_GLIBCXX_THREAD_ATEXIT_WIN32):\n+\tDitto.\n+\t* libsupc++/atexit_thread.cc [_GLIBCXX_THREAD_ATEXIT_WIN32]:\n+\t#include <windows.h>.\n+\t(struct elt): Add dll member.\n+\t(run): Decrement dll refcount.\n+\t(__cxxabiv1::__cxa_thread_atexit): Increment dll refcount.\n+\n 2014-08-15  Jonathan Wakely  <jwakely@redhat.com>\n \n \tPR libstdc++/62154"}, {"sha": "5e7aec8e458d4fc4bc9506dbfc387bf8ed021d2a", "filename": "libstdc++-v3/config/os/mingw32-w64/os_defines.h", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2Fconfig%2Fos%2Fmingw32-w64%2Fos_defines.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2Fconfig%2Fos%2Fmingw32-w64%2Fos_defines.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfig%2Fos%2Fmingw32-w64%2Fos_defines.h?ref=1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "patch": "@@ -78,4 +78,9 @@\n #define _GLIBCXX_LLP64 1\n #endif\n \n+// Enable use of GetModuleHandleEx (requires Windows XP/2003) in\n+// __cxa_thread_atexit to prevent modules from being unloaded before\n+// their dtors are called\n+#define _GLIBCXX_THREAD_ATEXIT_WIN32 1\n+\n #endif"}, {"sha": "2e01d3bdf7d62e00f7a8c2ee9e0a57ed2d16683e", "filename": "libstdc++-v3/config/os/newlib/os_defines.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2Fconfig%2Fos%2Fnewlib%2Fos_defines.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2Fconfig%2Fos%2Fnewlib%2Fos_defines.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Fconfig%2Fos%2Fnewlib%2Fos_defines.h?ref=1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "patch": "@@ -47,6 +47,12 @@\n \n // See libstdc++/20806.\n #define _GLIBCXX_HAVE_DOS_BASED_FILESYSTEM 1\n+\n+// Enable use of GetModuleHandleEx (requires Windows XP/2003) in\n+// __cxa_thread_atexit to prevent modules from being unloaded before\n+// their dtors are called\n+#define _GLIBCXX_THREAD_ATEXIT_WIN32 1\n+\n #endif\n \n #endif"}, {"sha": "d7d84d2c626b0b9775e9eba5e27d45b461511261", "filename": "libstdc++-v3/libsupc++/atexit_thread.cc", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2Flibsupc%2B%2B%2Fatexit_thread.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/1ed3ba0549f544bd9dd5195d7045b20dec0354a3/libstdc%2B%2B-v3%2Flibsupc%2B%2B%2Fatexit_thread.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libstdc%2B%2B-v3%2Flibsupc%2B%2B%2Fatexit_thread.cc?ref=1ed3ba0549f544bd9dd5195d7045b20dec0354a3", "patch": "@@ -25,6 +25,10 @@\n #include <cstdlib>\n #include <new>\n #include \"bits/gthr.h\"\n+#ifdef _GLIBCXX_THREAD_ATEXIT_WIN32\n+#define WIN32_LEAN_AND_MEAN\n+#include <windows.h>\n+#endif\n \n #if _GLIBCXX_HAVE___CXA_THREAD_ATEXIT_IMPL\n \n@@ -47,6 +51,9 @@ namespace {\n     void (*destructor)(void *);\n     void *object;\n     elt *next;\n+#ifdef _GLIBCXX_THREAD_ATEXIT_WIN32\n+    HMODULE dll;\n+#endif\n   };\n \n   // Keep a per-thread list of cleanups in gthread_key storage.\n@@ -62,6 +69,11 @@ namespace {\n       {\n \telt *old_e = e;\n \te->destructor (e->object);\n+#ifdef _GLIBCXX_THREAD_ATEXIT_WIN32\n+\t/* Decrement DLL count */\n+\tif (e->dll)\n+\t  FreeLibrary (e->dll);\n+#endif\n \te = e->next;\n \tdelete (old_e);\n       }\n@@ -133,6 +145,14 @@ __cxxabiv1::__cxa_thread_atexit (void (*dtor)(void *), void *obj, void */*dso_ha\n   new_elt->destructor = dtor;\n   new_elt->object = obj;\n   new_elt->next = first;\n+#ifdef _GLIBCXX_THREAD_ATEXIT_WIN32\n+  /* Store the DLL address for a later call to FreeLibrary in new_elt and\n+     increment DLL load count.  This blocks the unloading of the DLL\n+     before the thread-local dtors have been called.  This does NOT help\n+     if FreeLibrary/dlclose is called in excess. */\n+  GetModuleHandleExW (GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS,\n+\t\t      (LPCWSTR) dtor, &new_elt->dll);\n+#endif\n \n   if (__gthread_active_p ())\n     __gthread_setspecific (key, new_elt);"}]}