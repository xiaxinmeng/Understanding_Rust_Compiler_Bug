{"sha": "b03be74bad08c382da47e048007a78fa3fb4ef49", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YjAzYmU3NGJhZDA4YzM4MmRhNDdlMDQ4MDA3YTc4ZmEzZmI0ZWY0OQ==", "commit": {"author": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2020-11-11T06:04:34Z"}, "committer": {"name": "Kito Cheng", "email": "kito.cheng@sifive.com", "date": "2020-11-18T07:02:22Z"}, "message": "RISC-V: Support zicsr and zifencei extension for -march.\n\n - CSR related instructions and fence instructions has to be splitted from\n   baseline ISA, zicsr and zifencei are corresponding sub-extension.\n\ngcc/ChangeLog:\n\n\t* common/config/riscv/riscv-common.c (riscv_implied_info):\n\td and f implied zicsr.\n\t(riscv_ext_flag_table): Handle zicsr and zifencei.\n\t* config/riscv/riscv-opts.h (MASK_ZICSR): New.\n\t(MASK_ZIFENCEI): Ditto.\n\t(TARGET_ZICSR): Ditto.\n\t(TARGET_ZIFENCEI): Ditto.\n\t* config/riscv/riscv.md (clear_cache): Check TARGET_ZIFENCEI.\n\t(fence_i): Ditto.\n\t* config/riscv/riscv.opt (riscv_zi_subext): New.\n\ngcc/testsuite/ChangeLog:\n\n\t* gcc.target/riscv/arch-8.c: New.\n\t* gcc.target/riscv/attribute-14.c: Ditto.", "tree": {"sha": "80fe3a8af8a760238fb992f7859bbc643f428feb", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/80fe3a8af8a760238fb992f7859bbc643f428feb"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/b03be74bad08c382da47e048007a78fa3fb4ef49", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b03be74bad08c382da47e048007a78fa3fb4ef49", "html_url": "https://github.com/Rust-GCC/gccrs/commit/b03be74bad08c382da47e048007a78fa3fb4ef49", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/b03be74bad08c382da47e048007a78fa3fb4ef49/comments", "author": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kito-cheng", "id": 2723185, "node_id": "MDQ6VXNlcjI3MjMxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kito-cheng", "html_url": "https://github.com/kito-cheng", "followers_url": "https://api.github.com/users/kito-cheng/followers", "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}", "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions", "organizations_url": "https://api.github.com/users/kito-cheng/orgs", "repos_url": "https://api.github.com/users/kito-cheng/repos", "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/kito-cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a5bb4705fb75fd3afdde938193c59938cc7bfde", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a5bb4705fb75fd3afdde938193c59938cc7bfde", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6a5bb4705fb75fd3afdde938193c59938cc7bfde"}], "stats": {"total": 31, "additions": 29, "deletions": 2}, "files": [{"sha": "ca88ca1dacd1fb035109525a70fcff67ec539db1", "filename": "gcc/common/config/riscv/riscv-common.c", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fcommon%2Fconfig%2Friscv%2Friscv-common.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fcommon%2Fconfig%2Friscv%2Friscv-common.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcommon%2Fconfig%2Friscv%2Friscv-common.c?ref=b03be74bad08c382da47e048007a78fa3fb4ef49", "patch": "@@ -57,6 +57,8 @@ struct riscv_implied_info_t\n static const riscv_implied_info_t riscv_implied_info[] =\n {\n   {\"d\", \"f\"},\n+  {\"f\", \"zicsr\"},\n+  {\"d\", \"zicsr\"},\n   {NULL, NULL}\n };\n \n@@ -812,6 +814,10 @@ static const riscv_ext_flag_table_t riscv_ext_flag_table[] =\n   {\"f\", &gcc_options::x_target_flags, MASK_HARD_FLOAT},\n   {\"d\", &gcc_options::x_target_flags, MASK_DOUBLE_FLOAT},\n   {\"c\", &gcc_options::x_target_flags, MASK_RVC},\n+\n+  {\"zicsr\",    &gcc_options::x_riscv_zi_subext, MASK_ZICSR},\n+  {\"zifencei\", &gcc_options::x_riscv_zi_subext, MASK_ZIFENCEI},\n+\n   {NULL, NULL, 0}\n };\n "}, {"sha": "de8ac0e038d94c194c394b9a7494c4129d078a4c", "filename": "gcc/config/riscv/riscv-opts.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fconfig%2Friscv%2Friscv-opts.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fconfig%2Friscv%2Friscv-opts.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv-opts.h?ref=b03be74bad08c382da47e048007a78fa3fb4ef49", "patch": "@@ -57,4 +57,10 @@ enum stack_protector_guard {\n   SSP_GLOBAL\t\t\t/* global canary */\n };\n \n+#define MASK_ZICSR    (1 << 0)\n+#define MASK_ZIFENCEI (1 << 1)\n+\n+#define TARGET_ZICSR    ((riscv_zi_subext & MASK_ZICSR) != 0)\n+#define TARGET_ZIFENCEI ((riscv_zi_subext & MASK_ZIFENCEI) != 0)\n+\n #endif /* ! GCC_RISCV_OPTS_H */"}, {"sha": "254147c112a34ae810e53bffaa788b66f208102b", "filename": "gcc/config/riscv/riscv.md", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fconfig%2Friscv%2Friscv.md", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fconfig%2Friscv%2Friscv.md", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv.md?ref=b03be74bad08c382da47e048007a78fa3fb4ef49", "patch": "@@ -1543,7 +1543,8 @@\n \t\t     LCT_NORMAL, VOIDmode, operands[0], Pmode,\n \t\t     operands[1], Pmode, const0_rtx, Pmode);\n #else\n-  emit_insn (gen_fence_i ());\n+  if (TARGET_ZIFENCEI)\n+    emit_insn (gen_fence_i ());\n #endif\n   DONE;\n })\n@@ -1555,7 +1556,7 @@\n \n (define_insn \"fence_i\"\n   [(unspec_volatile [(const_int 0)] UNSPECV_FENCE_I)]\n-  \"\"\n+  \"TARGET_ZIFENCEI\"\n   \"fence.i\")\n \n ;;"}, {"sha": "ca2fc7c80219d411808b4f9d78a1e90cea5d497d", "filename": "gcc/config/riscv/riscv.opt", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fconfig%2Friscv%2Friscv.opt", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Fconfig%2Friscv%2Friscv.opt", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Friscv%2Friscv.opt?ref=b03be74bad08c382da47e048007a78fa3fb4ef49", "patch": "@@ -183,3 +183,6 @@ Use the given offset for addressing the stack-protector guard.\n \n TargetVariable\n long riscv_stack_protector_guard_offset = 0\n+\n+TargetVariable\n+int riscv_zi_subext"}, {"sha": "d7760fc576f3d800dee00a864dd4e67611306286", "filename": "gcc/testsuite/gcc.target/riscv/arch-8.c", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Farch-8.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Farch-8.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Farch-8.c?ref=b03be74bad08c382da47e048007a78fa3fb4ef49", "patch": "@@ -0,0 +1,5 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O -march=rv32id_zicsr_zifence -mabi=ilp32\" } */\n+int foo()\n+{\n+}"}, {"sha": "4845627715238a9b2ab1242febc03c7b0c86d65f", "filename": "gcc/testsuite/gcc.target/riscv/attribute-14.c", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fattribute-14.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/b03be74bad08c382da47e048007a78fa3fb4ef49/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fattribute-14.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Friscv%2Fattribute-14.c?ref=b03be74bad08c382da47e048007a78fa3fb4ef49", "patch": "@@ -0,0 +1,6 @@\n+/* { dg-do compile } */\n+/* { dg-options \"-O -mriscv-attribute -march=rv32if -mabi=ilp32\" } */\n+int foo()\n+{\n+}\n+/* { dg-final { scan-assembler \".attribute arch, \\\"rv32i2p0_f2p0_zicsr2p0\\\"\" } } */"}]}