{"sha": "0a98123c7a6570b4a00b3fa01e3883224e5e8e69", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MGE5ODEyM2M3YTY1NzBiNGEwMGIzZmEwMWUzODgzMjI0ZTVlOGU2OQ==", "commit": {"author": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-06-16T08:27:52Z"}, "committer": {"name": "Iain Buclaw", "email": "ibuclaw@gdcproject.org", "date": "2020-06-16T21:36:29Z"}, "message": "d: Remove dependency on front-end File type for json and deps file generation.\n\ngcc/d/ChangeLog:\n\n\t* d-lang.cc (d_parse_file): Replace uses of File with FILE.", "tree": {"sha": "a9ab1393f84863a3962033c21ff6e8781dae8ac9", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/a9ab1393f84863a3962033c21ff6e8781dae8ac9"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/0a98123c7a6570b4a00b3fa01e3883224e5e8e69", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0a98123c7a6570b4a00b3fa01e3883224e5e8e69", "html_url": "https://github.com/Rust-GCC/gccrs/commit/0a98123c7a6570b4a00b3fa01e3883224e5e8e69", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/0a98123c7a6570b4a00b3fa01e3883224e5e8e69/comments", "author": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ibuclaw", "id": 397929, "node_id": "MDQ6VXNlcjM5NzkyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/397929?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ibuclaw", "html_url": "https://github.com/ibuclaw", "followers_url": "https://api.github.com/users/ibuclaw/followers", "following_url": "https://api.github.com/users/ibuclaw/following{/other_user}", "gists_url": "https://api.github.com/users/ibuclaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/ibuclaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ibuclaw/subscriptions", "organizations_url": "https://api.github.com/users/ibuclaw/orgs", "repos_url": "https://api.github.com/users/ibuclaw/repos", "events_url": "https://api.github.com/users/ibuclaw/events{/privacy}", "received_events_url": "https://api.github.com/users/ibuclaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f267a3109884c6b623b72f20cbc208561efaf5ff", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f267a3109884c6b623b72f20cbc208561efaf5ff", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f267a3109884c6b623b72f20cbc208561efaf5ff"}], "stats": {"total": 42, "additions": 32, "deletions": 10}, "files": [{"sha": "fe59abe93a85a6359674d14d579a579b693ad3e4", "filename": "gcc/d/d-lang.cc", "status": "modified", "additions": 32, "deletions": 10, "changes": 42, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/0a98123c7a6570b4a00b3fa01e3883224e5e8e69/gcc%2Fd%2Fd-lang.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/0a98123c7a6570b4a00b3fa01e3883224e5e8e69/gcc%2Fd%2Fd-lang.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fd%2Fd-lang.cc?ref=0a98123c7a6570b4a00b3fa01e3883224e5e8e69", "patch": "@@ -1271,6 +1271,7 @@ d_parse_file (void)\n   if (d_option.deps)\n     {\n       OutBuffer buf;\n+      FILE *deps_stream;\n \n       for (size_t i = 0; i < modules.length; i++)\n \tdeps_write (modules[i], &buf);\n@@ -1281,13 +1282,25 @@ d_parse_file (void)\n \n       if (d_option.deps_filename)\n \t{\n-\t  File *fdeps = File::create (d_option.deps_filename);\n-\t  fdeps->setbuffer ((void *) buf.data, buf.offset);\n-\t  fdeps->ref = 1;\n-\t  writeFile (Loc (), fdeps);\n+\t  deps_stream = fopen (d_option.deps_filename, \"w\");\n+\t  if (!deps_stream)\n+\t    {\n+\t      fatal_error (input_location, \"opening dependency file %s: %m\",\n+\t\t\t   d_option.deps_filename);\n+\t      goto had_errors;\n+\t    }\n \t}\n       else\n-\tmessage (\"%.*s\", (int) buf.offset, (char *) buf.data);\n+\tdeps_stream = stdout;\n+\n+      fprintf (deps_stream, \"%s\", buf.peekChars ());\n+\n+      if (deps_stream != stdout\n+\t  && (ferror (deps_stream) || fclose (deps_stream)))\n+\t{\n+\t  fatal_error (input_location, \"closing dependency file %s: %m\",\n+\t\t       d_option.deps_filename);\n+\t}\n     }\n \n   /* Generate JSON files.  */\n@@ -1297,18 +1310,27 @@ d_parse_file (void)\n       json_generate (&buf, &modules);\n \n       const char *name = global.params.jsonfilename.ptr;\n+      FILE *json_stream;\n \n       if (name && (name[0] != '-' || name[1] != '\\0'))\n \t{\n \t  const char *nameext\n \t    = FileName::defaultExt (name, global.json_ext.ptr);\n-\t  File *fjson = File::create (nameext);\n-\t  fjson->setbuffer ((void *) buf.data, buf.offset);\n-\t  fjson->ref = 1;\n-\t  writeFile (Loc (), fjson);\n+\t  json_stream = fopen (nameext, \"w\");\n+\t  if (!json_stream)\n+\t    {\n+\t      fatal_error (input_location, \"opening json file %s: %m\", nameext);\n+\t      goto had_errors;\n+\t    }\n \t}\n       else\n-\tmessage (\"%.*s\", (int) buf.offset, (char *) buf.data);\n+\tjson_stream = stdout;\n+\n+      fprintf (json_stream, \"%s\", buf.peekChars ());\n+\n+      if (json_stream != stdout\n+\t  && (ferror (json_stream) || fclose (json_stream)))\n+\tfatal_error (input_location, \"closing json file %s: %m\", name);\n     }\n \n   /* Generate Ddoc files.  */"}]}