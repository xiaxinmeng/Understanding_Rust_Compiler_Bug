{"sha": "32e0627f99f4212695ec13b6d50ca48d1c29ded3", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6MzJlMDYyN2Y5OWY0MjEyNjk1ZWMxM2I2ZDUwY2E0OGQxYzI5ZGVkMw==", "commit": {"author": {"name": "Doug Rupp", "email": "rupp@adacore.com", "date": "2019-07-10T09:01:13Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2019-07-10T09:01:13Z"}, "message": "[Ada] The environ macro is broken on vxworks7r2 SR0610\n\nIn SR0610, the TCB is made private, so the task environ field used by\nthe environ macro is no longer visible.  Arguably this is a bug, however\na more correct approach is to use accessor functions to retrieve this\nfield and not use the environ macro, thus avoiding the problem.\n\n2019-07-10  Doug Rupp  <rupp@adacore.com>\n\ngcc/ada/\n\n\t* env.c (__gnat_environ): Reformulate to also work for\n\tvxworks7r2 SR0610.\n\nFrom-SVN: r273332", "tree": {"sha": "6a89b9d7da5262bb14586a342bb423d17748b6c7", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/6a89b9d7da5262bb14586a342bb423d17748b6c7"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/32e0627f99f4212695ec13b6d50ca48d1c29ded3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32e0627f99f4212695ec13b6d50ca48d1c29ded3", "html_url": "https://github.com/Rust-GCC/gccrs/commit/32e0627f99f4212695ec13b6d50ca48d1c29ded3", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/32e0627f99f4212695ec13b6d50ca48d1c29ded3/comments", "author": {"login": "Cementitious", "id": 115579865, "node_id": "U_kgDOBuOb2Q", "avatar_url": "https://avatars.githubusercontent.com/u/115579865?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Cementitious", "html_url": "https://github.com/Cementitious", "followers_url": "https://api.github.com/users/Cementitious/followers", "following_url": "https://api.github.com/users/Cementitious/following{/other_user}", "gists_url": "https://api.github.com/users/Cementitious/gists{/gist_id}", "starred_url": "https://api.github.com/users/Cementitious/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Cementitious/subscriptions", "organizations_url": "https://api.github.com/users/Cementitious/orgs", "repos_url": "https://api.github.com/users/Cementitious/repos", "events_url": "https://api.github.com/users/Cementitious/events{/privacy}", "received_events_url": "https://api.github.com/users/Cementitious/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "c03c026753c3cfb102435842e53c0a4773aedc75", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c03c026753c3cfb102435842e53c0a4773aedc75", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c03c026753c3cfb102435842e53c0a4773aedc75"}], "stats": {"total": 37, "additions": 30, "deletions": 7}, "files": [{"sha": "e4034e42f6ac5002100219be3ad2c74e9f8d4d40", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32e0627f99f4212695ec13b6d50ca48d1c29ded3/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32e0627f99f4212695ec13b6d50ca48d1c29ded3/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=32e0627f99f4212695ec13b6d50ca48d1c29ded3", "patch": "@@ -1,3 +1,8 @@\n+2019-07-10  Doug Rupp  <rupp@adacore.com>\n+\n+\t* env.c (__gnat_environ): Reformulate to also work for\n+\tvxworks7r2 SR0610.\n+\n 2019-07-10  Patrick Bernardi  <bernardi@adacore.com>\n \n \t* Makefile.rtl: Handle vxworks7r2 ppc target"}, {"sha": "04e861e19e9d26d550a08469450fd477cf40e85e", "filename": "gcc/ada/env.c", "status": "modified", "additions": 25, "deletions": 7, "changes": 32, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/32e0627f99f4212695ec13b6d50ca48d1c29ded3/gcc%2Fada%2Fenv.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/32e0627f99f4212695ec13b6d50ca48d1c29ded3/gcc%2Fada%2Fenv.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Fenv.c?ref=32e0627f99f4212695ec13b6d50ca48d1c29ded3", "patch": "@@ -60,6 +60,9 @@\n #endif\n \n #if defined (__vxworks)\n+  #include <vxWorks.h>\n+  #include <version.h>\n+\n   #if defined (__RTP__)\n     /* On VxWorks 6 Real-Time process mode, environ is defined in unistd.h.  */\n     #include <unistd.h>\n@@ -69,14 +72,18 @@\n        envLib.h on VxWorks MILS and VxWorks 653.  */\n     #include <vThreadsData.h>\n     #include <envLib.h>\n-  #else\n-    /* This should work for kernel mode on both VxWorks 5 and VxWorks 6.  */\n+  #elif (_WRS_VXWORKS_MAJOR <= 6)\n     #include <envLib.h>\n-\n-    /* In that mode environ is a macro which reference the following symbol.\n-       As the symbol is not defined in any VxWorks include files we declare\n-       it as extern.  */\n+    /* In that mode the following symbol is not defined in any VxWorks\n+       include files, prior to vxWorks 7, so we declare it as extern.  */\n     extern char** ppGlobalEnviron;\n+  #elif (_WRS_VXWORKS_MAJOR >= 7)\n+    /* This should work for kernel mode on VxWorks 7.x.  In 7.2 the tcb\n+       is made private, so accessor functions must be used, in 7.0 it\n+       is optional but there is no way to distinguish between 7.2\n+       and 7.0 since the version.h header file was never updated.  */\n+    #include <envLib.h>\n+    #include <taskLibCommon.h>\n   #endif\n #endif\n \n@@ -223,7 +230,18 @@ __gnat_environ (void)\n   extern char **environ;\n   return environ;\n #else\n-  return environ;\n+  #if defined (__RTP__) || defined (VTHREADS) || (_WRS_VXWORKS_MAJOR <= 6)\n+    return environ;\n+  #elif (_WRS_VXWORKS_MAJOR >= 7)\n+    char **task_environ;\n+\n+    task_environ = envGet (taskIdSelf ());\n+\n+    if (task_environ == NULL)\n+       return ppGlobalEnviron;\n+    else\n+       return task_environ;\n+  #endif\n #endif\n }\n "}]}