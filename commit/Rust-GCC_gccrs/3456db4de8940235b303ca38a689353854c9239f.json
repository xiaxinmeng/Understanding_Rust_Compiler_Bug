{"sha": "3456db4de8940235b303ca38a689353854c9239f", "node_id": "C_kwDOANBUbNoAKDM0NTZkYjRkZTg5NDAyMzViMzAzY2EzOGE2ODkzNTM4NTRjOTIzOWY", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-01-13T17:23:57Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2023-01-13T17:23:57Z"}, "message": "c++: Avoid some false positive -Wfloat-conversion warnings with extended precision [PR108285]\n\nOn the following testcase trunk emits a false positive warning on ia32.\nconvert_like_internal is there called with type of double and\nexpr EXCESS_PRECISION_EXPR with float type with long double operand\n2.L * (long double) x.\nNow, for the code generation we do the right thing, cp_convert\nto double from that 2.L * (long double) x, but we call even\ncp_convert_and_check with that and that emits the -Wfloat-conversion\nwarning.  Looking at what the C FE does in this case, it calls\nconvert_and_check with the EXCESS_PRECISION_EXPR expression rather\nthan its operand, and essentially uses the operand for code generation\nand EXCESS_PRECISION_EXPR itself for warnings.\n\nThe following patch does that too for the C++ FE.\n\n2023-01-13  Jakub Jelinek  <jakub@redhat.com>\n\n\tPR c++/108285\n\t* cvt.cc (cp_convert_and_check): For EXCESS_PRECISION_EXPR\n\tuse its operand except that for warning purposes use the original\n\tEXCESS_PRECISION_EXPR.\n\t* call.cc (convert_like_internal): Only look through\n\tEXCESS_PRECISION_EXPR when calling cp_convert, not when calling\n\tcp_convert_and_check.\n\n\t* g++.dg/warn/pr108285.C: New test.", "tree": {"sha": "8ed8ca4781c33441f22e56dd743915016e9520c5", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/8ed8ca4781c33441f22e56dd743915016e9520c5"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/3456db4de8940235b303ca38a689353854c9239f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3456db4de8940235b303ca38a689353854c9239f", "html_url": "https://github.com/Rust-GCC/gccrs/commit/3456db4de8940235b303ca38a689353854c9239f", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/3456db4de8940235b303ca38a689353854c9239f/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "325a79b2c629bb7a2271dfebd678a27afcef4d01", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/325a79b2c629bb7a2271dfebd678a27afcef4d01", "html_url": "https://github.com/Rust-GCC/gccrs/commit/325a79b2c629bb7a2271dfebd678a27afcef4d01"}], "stats": {"total": 25, "additions": 20, "deletions": 5}, "files": [{"sha": "2cad1c059d8064f5ad7eb8a7479dcf3e8e0504fa", "filename": "gcc/cp/call.cc", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3456db4de8940235b303ca38a689353854c9239f/gcc%2Fcp%2Fcall.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3456db4de8940235b303ca38a689353854c9239f/gcc%2Fcp%2Fcall.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcall.cc?ref=3456db4de8940235b303ca38a689353854c9239f", "patch": "@@ -8863,12 +8863,14 @@ convert_like_internal (conversion *convs, tree expr, tree fn, int argnum,\n     return error_mark_node;\n \n   warning_sentinel w (warn_zero_as_null_pointer_constant);\n-  if (TREE_CODE (expr) == EXCESS_PRECISION_EXPR)\n-    expr = TREE_OPERAND (expr, 0);\n   if (issue_conversion_warnings)\n     expr = cp_convert_and_check (totype, expr, complain);\n   else\n-    expr = cp_convert (totype, expr, complain);\n+    {\n+      if (TREE_CODE (expr) == EXCESS_PRECISION_EXPR)\n+\texpr = TREE_OPERAND (expr, 0);\n+      expr = cp_convert (totype, expr, complain);\n+    }\n \n   return expr;\n }"}, {"sha": "1cd2b4ad9e110723ce752ee6af6cd90435be6413", "filename": "gcc/cp/cvt.cc", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3456db4de8940235b303ca38a689353854c9239f/gcc%2Fcp%2Fcvt.cc", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3456db4de8940235b303ca38a689353854c9239f/gcc%2Fcp%2Fcvt.cc", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fcp%2Fcvt.cc?ref=3456db4de8940235b303ca38a689353854c9239f", "patch": "@@ -652,8 +652,10 @@ cp_convert (tree type, tree expr, tsubst_flags_t complain)\n tree\n cp_convert_and_check (tree type, tree expr, tsubst_flags_t complain)\n {\n-  tree result;\n+  tree result, expr_for_warning = expr;\n \n+  if (TREE_CODE (expr) == EXCESS_PRECISION_EXPR)\n+    expr = TREE_OPERAND (expr, 0);\n   if (TREE_TYPE (expr) == type)\n     return expr;\n   if (expr == error_mark_node)\n@@ -663,7 +665,7 @@ cp_convert_and_check (tree type, tree expr, tsubst_flags_t complain)\n   if ((complain & tf_warning)\n       && c_inhibit_evaluation_warnings == 0)\n     {\n-      tree folded = cp_fully_fold (expr);\n+      tree folded = cp_fully_fold (expr_for_warning);\n       tree folded_result;\n       if (folded == expr)\n \tfolded_result = result;"}, {"sha": "74cb234a7cae8df56f9a108c308d30595e356b77", "filename": "gcc/testsuite/g++.dg/warn/pr108285.C", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/3456db4de8940235b303ca38a689353854c9239f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fpr108285.C", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/3456db4de8940235b303ca38a689353854c9239f/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fpr108285.C", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fg%2B%2B.dg%2Fwarn%2Fpr108285.C?ref=3456db4de8940235b303ca38a689353854c9239f", "patch": "@@ -0,0 +1,11 @@\n+// PR c++/108285\n+// { dg-do compile }\n+// { dg-options \"-fexcess-precision=standard -Wfloat-conversion\" }\n+\n+void bar (double);\n+\n+void\n+foo (float x)\n+{\n+  bar (2 * x);\t// { dg-bogus \"conversion from '\\[^\\n\\r]\\*' to 'double' may change value\" }\n+}"}]}