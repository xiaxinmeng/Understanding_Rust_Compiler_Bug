{"sha": "cb3c90cc4253cc236a4d5669a893562b202570e5", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Y2IzYzkwY2M0MjUzY2MyMzZhNGQ1NjY5YTg5MzU2MmIyMDI1NzBlNQ==", "commit": {"author": {"name": "Florian Weimer", "email": "fweimer@redhat.com", "date": "2018-05-23T11:13:05Z"}, "committer": {"name": "Florian Weimer", "email": "fw@gcc.gnu.org", "date": "2018-05-23T11:13:05Z"}, "message": "x86: libatomic: Do not assume ELF constructors run before IFUNC resolvers\n\n\tPR libgcc/60790\n\tx86: Do not assume ELF constructors run before IFUNC resolvers.\n\t* config/x86/host-config.h (libat_feat1_ecx, libat_feat1_edx):\n\tRemove declarations.\n\t(__libat_feat1, __libat_feat1_init): Declare.\n\t(FEAT1_REGISTER): Define.\n\t(load_feat1): New function.\n\t(IFUNC_COND_1): Adjust.\n\t* config/x86/init.c (libat_feat1_ecx, libat_feat1_edx)\n\t(init_cpuid): Remove definitions.\n\t(__libat_feat1): New variable.\n\t(__libat_feat1_init): New function.\n\nFrom-SVN: r260603", "tree": {"sha": "f949dbb7958ca1eeed9204b05d8ea39418b7ac22", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/f949dbb7958ca1eeed9204b05d8ea39418b7ac22"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/cb3c90cc4253cc236a4d5669a893562b202570e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb3c90cc4253cc236a4d5669a893562b202570e5", "html_url": "https://github.com/Rust-GCC/gccrs/commit/cb3c90cc4253cc236a4d5669a893562b202570e5", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/cb3c90cc4253cc236a4d5669a893562b202570e5/comments", "author": {"login": "fweimer-rh", "id": 75532728, "node_id": "MDQ6VXNlcjc1NTMyNzI4", "avatar_url": "https://avatars.githubusercontent.com/u/75532728?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fweimer-rh", "html_url": "https://github.com/fweimer-rh", "followers_url": "https://api.github.com/users/fweimer-rh/followers", "following_url": "https://api.github.com/users/fweimer-rh/following{/other_user}", "gists_url": "https://api.github.com/users/fweimer-rh/gists{/gist_id}", "starred_url": "https://api.github.com/users/fweimer-rh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fweimer-rh/subscriptions", "organizations_url": "https://api.github.com/users/fweimer-rh/orgs", "repos_url": "https://api.github.com/users/fweimer-rh/repos", "events_url": "https://api.github.com/users/fweimer-rh/events{/privacy}", "received_events_url": "https://api.github.com/users/fweimer-rh/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "159440699bf6f97dccc94377d9d69e540a1904dc", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/159440699bf6f97dccc94377d9d69e540a1904dc", "html_url": "https://github.com/Rust-GCC/gccrs/commit/159440699bf6f97dccc94377d9d69e540a1904dc"}], "stats": {"total": 63, "additions": 54, "deletions": 9}, "files": [{"sha": "dcb1bae089a6818d1ac35c73ef244cc6dc5e52a7", "filename": "libatomic/ChangeLog", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb3c90cc4253cc236a4d5669a893562b202570e5/libatomic%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb3c90cc4253cc236a4d5669a893562b202570e5/libatomic%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libatomic%2FChangeLog?ref=cb3c90cc4253cc236a4d5669a893562b202570e5", "patch": "@@ -1,3 +1,18 @@\n+2018-05-23  Florian Weimer  <fweimer@redhat.com>\n+\n+\tPR libgcc/60790\n+\tx86: Do not assume ELF constructors run before IFUNC resolvers.\n+\t* config/x86/host-config.h (libat_feat1_ecx, libat_feat1_edx):\n+\tRemove declarations.\n+\t(__libat_feat1, __libat_feat1_init): Declare.\n+\t(FEAT1_REGISTER): Define.\n+\t(load_feat1): New function.\n+\t(IFUNC_COND_1): Adjust.\n+\t* config/x86/init.c (libat_feat1_ecx, libat_feat1_edx)\n+\t(init_cpuid): Remove definitions.\n+\t(__libat_feat1): New variable.\n+\t(__libat_feat1_init): New function.\n+\n 2018-05-02  Tom de Vries  <tom@codesourcery.com>\n \n \tPR testsuite/85106"}, {"sha": "0b6c33862ec12c7947be041a49b8137f15631c78", "filename": "libatomic/config/x86/host-config.h", "status": "modified", "additions": 30, "deletions": 4, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb3c90cc4253cc236a4d5669a893562b202570e5/libatomic%2Fconfig%2Fx86%2Fhost-config.h", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb3c90cc4253cc236a4d5669a893562b202570e5/libatomic%2Fconfig%2Fx86%2Fhost-config.h", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libatomic%2Fconfig%2Fx86%2Fhost-config.h?ref=cb3c90cc4253cc236a4d5669a893562b202570e5", "patch": "@@ -25,13 +25,39 @@\n #if HAVE_IFUNC\n #include <cpuid.h>\n \n-extern unsigned int libat_feat1_ecx HIDDEN;\n-extern unsigned int libat_feat1_edx HIDDEN;\n+#ifdef __x86_64__\n+# define FEAT1_REGISTER ecx\n+#else\n+# define FEAT1_REGISTER edx\n+#endif\n+\n+/* Value of the CPUID feature register FEAT1_REGISTER for the cmpxchg\n+   bit for IFUNC_COND1 below.  */\n+extern unsigned int __libat_feat1 HIDDEN;\n+\n+/* Initialize libat_feat1 and return its value.  */\n+unsigned int __libat_feat1_init (void) HIDDEN;\n+\n+/* Return the value of the relevant feature register for the relevant\n+   cmpxchg bit, or 0 if there is no CPUID support.  */\n+static inline unsigned int\n+__attribute__ ((const))\n+load_feat1 (void)\n+{\n+  /* See the store in __libat_feat1_init.  */\n+  unsigned int feat1 = __atomic_load_n (&__libat_feat1, __ATOMIC_RELAXED);\n+  if (feat1 == 0)\n+    /* Assume that initialization has not happened yet.  This may get\n+       called repeatedly if the CPU does not have any feature bits at\n+       all.  */\n+    feat1 = __libat_feat1_init ();\n+  return feat1;\n+}\n \n #ifdef __x86_64__\n-# define IFUNC_COND_1\t(libat_feat1_ecx & bit_CMPXCHG16B)\n+# define IFUNC_COND_1\t(load_feat1 () & bit_CMPXCHG16B)\n #else\n-# define IFUNC_COND_1\t(libat_feat1_edx & bit_CMPXCHG8B)\n+# define IFUNC_COND_1\t(load_feat1 () & bit_CMPXCHG8B)\n #endif\n \n #ifdef __x86_64__"}, {"sha": "5a4cf8b04567bf533a7e8c22b780c3f6f13901ad", "filename": "libatomic/config/x86/init.c", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/cb3c90cc4253cc236a4d5669a893562b202570e5/libatomic%2Fconfig%2Fx86%2Finit.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/cb3c90cc4253cc236a4d5669a893562b202570e5/libatomic%2Fconfig%2Fx86%2Finit.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libatomic%2Fconfig%2Fx86%2Finit.c?ref=cb3c90cc4253cc236a4d5669a893562b202570e5", "patch": "@@ -26,13 +26,17 @@\n \n #if HAVE_IFUNC\n \n-unsigned int libat_feat1_ecx, libat_feat1_edx;\n+unsigned int __libat_feat1;\n \n-static void __attribute__((constructor))\n-init_cpuid (void)\n+unsigned int\n+__libat_feat1_init (void)\n {\n-  unsigned int eax, ebx;\n-  __get_cpuid (1, &eax, &ebx, &libat_feat1_ecx, &libat_feat1_edx);\n+  unsigned int eax, ebx, ecx, edx;\n+  FEAT1_REGISTER = 0;\n+  __get_cpuid (1, &eax, &ebx, &ecx, &edx);\n+  /* See the load in load_feat1.  */\n+  __atomic_store_n (&__libat_feat1, FEAT1_REGISTER, __ATOMIC_RELAXED);\n+  return FEAT1_REGISTER;\n }\n \n #endif /* HAVE_IFUNC */"}]}