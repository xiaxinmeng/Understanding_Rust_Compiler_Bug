{"sha": "f95946afd160e2a1f4beac4ee5e6d5633307f39a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6Zjk1OTQ2YWZkMTYwZTJhMWY0YmVhYzRlZTVlNmQ1NjMzMzA3ZjM5YQ==", "commit": {"author": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2021-08-24T19:07:50Z"}, "committer": {"name": "Harald Anlauf", "email": "anlauf@gmx.de", "date": "2021-08-24T19:07:50Z"}, "message": "Fortran: fix pointless warning for static variables\n\ngcc/fortran/ChangeLog:\n\n\tPR fortran/98411\n\t* trans-decl.c (gfc_finish_var_decl): Adjust check to handle\n\timplicit SAVE as well as variables in the main program.  Improve\n\twarning message text.\n\ngcc/testsuite/ChangeLog:\n\n\tPR fortran/98411\n\t* gfortran.dg/pr98411.f90: Adjust testcase options to restrict to\n\tF2008, and verify case of implicit SAVE.", "tree": {"sha": "267cd3acf5b23e7411bccfd3d5529061b94de683", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/267cd3acf5b23e7411bccfd3d5529061b94de683"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/f95946afd160e2a1f4beac4ee5e6d5633307f39a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f95946afd160e2a1f4beac4ee5e6d5633307f39a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/f95946afd160e2a1f4beac4ee5e6d5633307f39a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/f95946afd160e2a1f4beac4ee5e6d5633307f39a/comments", "author": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "harald-anlauf", "id": 90786862, "node_id": "MDQ6VXNlcjkwNzg2ODYy", "avatar_url": "https://avatars.githubusercontent.com/u/90786862?v=4", "gravatar_id": "", "url": "https://api.github.com/users/harald-anlauf", "html_url": "https://github.com/harald-anlauf", "followers_url": "https://api.github.com/users/harald-anlauf/followers", "following_url": "https://api.github.com/users/harald-anlauf/following{/other_user}", "gists_url": "https://api.github.com/users/harald-anlauf/gists{/gist_id}", "starred_url": "https://api.github.com/users/harald-anlauf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/harald-anlauf/subscriptions", "organizations_url": "https://api.github.com/users/harald-anlauf/orgs", "repos_url": "https://api.github.com/users/harald-anlauf/repos", "events_url": "https://api.github.com/users/harald-anlauf/events{/privacy}", "received_events_url": "https://api.github.com/users/harald-anlauf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "50cb8300d3bf0b487063784fbbe394301b6c79b2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/50cb8300d3bf0b487063784fbbe394301b6c79b2", "html_url": "https://github.com/Rust-GCC/gccrs/commit/50cb8300d3bf0b487063784fbbe394301b6c79b2"}], "stats": {"total": 24, "additions": 16, "deletions": 8}, "files": [{"sha": "bed61e2325dbb1a44de61120d1f3b362a6af4cea", "filename": "gcc/fortran/trans-decl.c", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f95946afd160e2a1f4beac4ee5e6d5633307f39a/gcc%2Ffortran%2Ftrans-decl.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f95946afd160e2a1f4beac4ee5e6d5633307f39a/gcc%2Ffortran%2Ftrans-decl.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ffortran%2Ftrans-decl.c?ref=f95946afd160e2a1f4beac4ee5e6d5633307f39a", "patch": "@@ -743,8 +743,10 @@ gfc_finish_var_decl (tree decl, gfc_symbol * sym)\n \n   /* Keep variables larger than max-stack-var-size off stack.  */\n   if (!(sym->ns->proc_name && sym->ns->proc_name->attr.recursive)\n+      && !(sym->ns->proc_name && sym->ns->proc_name->attr.is_main_program)\n       && !sym->attr.automatic\n       && sym->attr.save != SAVE_EXPLICIT\n+      && sym->attr.save != SAVE_IMPLICIT\n       && INTEGER_CST_P (DECL_SIZE_UNIT (decl))\n       && !gfc_can_put_var_on_stack (DECL_SIZE_UNIT (decl))\n \t /* Put variable length auto array pointers always into stack.  */\n@@ -757,13 +759,17 @@ gfc_finish_var_decl (tree decl, gfc_symbol * sym)\n     {\n       if (flag_max_stack_var_size > 0)\n \tgfc_warning (OPT_Wsurprising,\n-\t\t     \"Array %qs at %L is larger than limit set by\"\n-\t\t     \" %<-fmax-stack-var-size=%>, moved from stack to static\"\n-\t\t     \" storage. This makes the procedure unsafe when called\"\n-\t\t     \" recursively, or concurrently from multiple threads.\"\n-\t\t     \" Consider using %<-frecursive%>, or increase the\"\n-\t\t     \" %<-fmax-stack-var-size=%> limit, or change the code to\"\n-\t\t     \" use an ALLOCATABLE array.\",\n+\t\t     \"Array %qs at %L is larger than limit set by \"\n+\t\t     \"%<-fmax-stack-var-size=%>, moved from stack to static \"\n+\t\t     \"storage. This makes the procedure unsafe when called \"\n+\t\t     \"recursively, or concurrently from multiple threads. \"\n+\t\t     \"Consider increasing the %<-fmax-stack-var-size=%> \"\n+\t\t     \"limit (or use %<-frecursive%>, which implies \"\n+\t\t     \"unlimited %<-fmax-stack-var-size%>) - or change the \"\n+\t\t     \"code to use an ALLOCATABLE array. If the variable is \"\n+\t\t     \"never accessed concurrently, this warning can be \"\n+\t\t     \"ignored, and the variable could also be declared with \"\n+\t\t     \"the SAVE attribute.\",\n \t\t     sym->name, &sym->declared_at);\n \n       TREE_STATIC (decl) = 1;"}, {"sha": "7c906a96f602ea5f9d5611c93c4d0e05d29b015a", "filename": "gcc/testsuite/gfortran.dg/pr98411.f90", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/f95946afd160e2a1f4beac4ee5e6d5633307f39a/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr98411.f90", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/f95946afd160e2a1f4beac4ee5e6d5633307f39a/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr98411.f90", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgfortran.dg%2Fpr98411.f90?ref=f95946afd160e2a1f4beac4ee5e6d5633307f39a", "patch": "@@ -1,5 +1,5 @@\n ! { dg-do compile }\n-! { dg-options \"-Wall -fautomatic -fmax-stack-var-size=100\" }\n+! { dg-options \"-std=f2008 -Wall -fautomatic -fmax-stack-var-size=100\" }\n ! PR fortran/98411 - Pointless warning for static variables \n \n module try\n@@ -9,8 +9,10 @@ module try\n   subroutine initmodule\n     real, save :: b(1000)\n     logical    :: c(1000) ! { dg-warning \"moved from stack to static storage\" }\n+    integer    :: e(1000) = 1\n     a(1) = 42\n     b(2) = 3.14\n     c(3) = .true.\n+    e(5) = -1\n   end subroutine initmodule\n end module try"}]}