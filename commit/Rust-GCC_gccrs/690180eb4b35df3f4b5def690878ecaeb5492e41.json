{"sha": "690180eb4b35df3f4b5def690878ecaeb5492e41", "node_id": "C_kwDOANBUbNoAKDY5MDE4MGViNGIzNWRmM2Y0YjVkZWY2OTA4NzhlY2FlYjU0OTJlNDE", "commit": {"author": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2021-10-22T08:12:56Z"}, "committer": {"name": "Martin Liska", "email": "mliska@suse.cz", "date": "2021-10-22T19:11:51Z"}, "message": "Handle jobserver file descriptors in btest.\n\n\tPR testsuite/102742\n\nlibbacktrace/ChangeLog:\n\n\t* btest.c (MIN_DESCRIPTOR): New.\n\t(MAX_DESCRIPTOR): Likewise.\n\t(check_available_files): Likewise.\n\t(check_open_files): Check only file descriptors that\n\twere not available at the entry.\n\t(main): Call check_available_files.", "tree": {"sha": "819d8328f5e896259bf963533ffd72565abb8778", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/819d8328f5e896259bf963533ffd72565abb8778"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/690180eb4b35df3f4b5def690878ecaeb5492e41", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/690180eb4b35df3f4b5def690878ecaeb5492e41", "html_url": "https://github.com/Rust-GCC/gccrs/commit/690180eb4b35df3f4b5def690878ecaeb5492e41", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/690180eb4b35df3f4b5def690878ecaeb5492e41/comments", "author": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marxin", "id": 2658545, "node_id": "MDQ6VXNlcjI2NTg1NDU=", "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marxin", "html_url": "https://github.com/marxin", "followers_url": "https://api.github.com/users/marxin/followers", "following_url": "https://api.github.com/users/marxin/following{/other_user}", "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}", "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marxin/subscriptions", "organizations_url": "https://api.github.com/users/marxin/orgs", "repos_url": "https://api.github.com/users/marxin/repos", "events_url": "https://api.github.com/users/marxin/events{/privacy}", "received_events_url": "https://api.github.com/users/marxin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c31d2d14f798dc7ca9cc078200d37113749ec3bd", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c31d2d14f798dc7ca9cc078200d37113749ec3bd", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c31d2d14f798dc7ca9cc078200d37113749ec3bd"}], "stats": {"total": 24, "additions": 20, "deletions": 4}, "files": [{"sha": "7ef6d320497cbe1e3875a75f48970797658b773c", "filename": "libbacktrace/btest.c", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/690180eb4b35df3f4b5def690878ecaeb5492e41/libbacktrace%2Fbtest.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/690180eb4b35df3f4b5def690878ecaeb5492e41/libbacktrace%2Fbtest.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libbacktrace%2Fbtest.c?ref=690180eb4b35df3f4b5def690878ecaeb5492e41", "patch": "@@ -38,6 +38,7 @@ POSSIBILITY OF SUCH DAMAGE.  */\n #include <stdlib.h>\n #include <string.h>\n #include <unistd.h>\n+#include <sys/stat.h>\n \n #include \"filenames.h\"\n \n@@ -458,16 +459,29 @@ test5 (void)\n   return failures;\n }\n \n+#define MIN_DESCRIPTOR 3\n+#define MAX_DESCRIPTOR 10\n+\n+static int fstat_status[MAX_DESCRIPTOR];\n+\n+/* Check files that are available.  */\n+\n+static void\n+check_available_files (void)\n+{\n+  struct stat s;\n+  for (unsigned i = MIN_DESCRIPTOR; i < MAX_DESCRIPTOR; i++)\n+    fstat_status[i] = fstat (i, &s);\n+}\n+\n /* Check that are no files left open.  */\n \n static void\n check_open_files (void)\n {\n-  int i;\n-\n-  for (i = 3; i < 10; i++)\n+  for (unsigned i = MIN_DESCRIPTOR; i < MAX_DESCRIPTOR; i++)\n     {\n-      if (close (i) == 0)\n+      if (fstat_status[i] != 0 && close (i) == 0)\n \t{\n \t  fprintf (stderr,\n \t\t   \"ERROR: descriptor %d still open after tests complete\\n\",\n@@ -482,6 +496,8 @@ check_open_files (void)\n int\n main (int argc ATTRIBUTE_UNUSED, char **argv)\n {\n+  check_available_files ();\n+\n   state = backtrace_create_state (argv[0], BACKTRACE_SUPPORTS_THREADS,\n \t\t\t\t  error_callback_create, NULL);\n "}]}