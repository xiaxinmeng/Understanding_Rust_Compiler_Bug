{"sha": "c24783c49924474f54feb0c6038cba4719125634", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6YzI0NzgzYzQ5OTI0NDc0ZjU0ZmViMGM2MDM4Y2JhNDcxOTEyNTYzNA==", "commit": {"author": {"name": "Jakub Jelinek", "email": "jakub@redhat.com", "date": "2017-05-22T18:51:54Z"}, "committer": {"name": "Jakub Jelinek", "email": "jakub@gcc.gnu.org", "date": "2017-05-22T18:51:54Z"}, "message": "re PR middle-end/80853 (OpenMP ICE in build_outer_var_ref with array reduction)\n\n\tPR middle-end/80853\n\t* omp-low.c (lower_reduction_clauses): Pass OMP_CLAUSE_PRIVATE\n\tas last argument to build_outer_var_ref for pointer bases of array\n\tsection reductions.\n\n\t* testsuite/libgomp.c/pr80853.c: New test.\n\nFrom-SVN: r248344", "tree": {"sha": "ac190183444200175ba69ab2d6aaf216d6806398", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/ac190183444200175ba69ab2d6aaf216d6806398"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/c24783c49924474f54feb0c6038cba4719125634", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c24783c49924474f54feb0c6038cba4719125634", "html_url": "https://github.com/Rust-GCC/gccrs/commit/c24783c49924474f54feb0c6038cba4719125634", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/c24783c49924474f54feb0c6038cba4719125634/comments", "author": {"login": "jakubjelinek", "id": 9370665, "node_id": "MDQ6VXNlcjkzNzA2NjU=", "avatar_url": "https://avatars.githubusercontent.com/u/9370665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakubjelinek", "html_url": "https://github.com/jakubjelinek", "followers_url": "https://api.github.com/users/jakubjelinek/followers", "following_url": "https://api.github.com/users/jakubjelinek/following{/other_user}", "gists_url": "https://api.github.com/users/jakubjelinek/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakubjelinek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakubjelinek/subscriptions", "organizations_url": "https://api.github.com/users/jakubjelinek/orgs", "repos_url": "https://api.github.com/users/jakubjelinek/repos", "events_url": "https://api.github.com/users/jakubjelinek/events{/privacy}", "received_events_url": "https://api.github.com/users/jakubjelinek/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "051e40e0cb151d3fd7a773213ee00f84043e2a25", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/051e40e0cb151d3fd7a773213ee00f84043e2a25", "html_url": "https://github.com/Rust-GCC/gccrs/commit/051e40e0cb151d3fd7a773213ee00f84043e2a25"}], "stats": {"total": 57, "additions": 54, "deletions": 3}, "files": [{"sha": "b69ffc0d527e444683bd02a7fdde4b6939343abf", "filename": "gcc/ChangeLog", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c24783c49924474f54feb0c6038cba4719125634/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c24783c49924474f54feb0c6038cba4719125634/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=c24783c49924474f54feb0c6038cba4719125634", "patch": "@@ -1,3 +1,10 @@\n+2017-05-22  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR middle-end/80853\n+\t* omp-low.c (lower_reduction_clauses): Pass OMP_CLAUSE_PRIVATE\n+\tas last argument to build_outer_var_ref for pointer bases of array\n+\tsection reductions.\n+\n 2017-05-19  Martin Sebor  <msebor@redhat.com>\n \n \t* print-tree.c (print_node): Print DECL_READ_P flag."}, {"sha": "26e6586a0706d362bca19825534e9cf598bae14b", "filename": "gcc/omp-low.c", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c24783c49924474f54feb0c6038cba4719125634/gcc%2Fomp-low.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c24783c49924474f54feb0c6038cba4719125634/gcc%2Fomp-low.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fomp-low.c?ref=c24783c49924474f54feb0c6038cba4719125634", "patch": "@@ -5140,15 +5140,25 @@ lower_reduction_clauses (tree clauses, gimple_seq *stmt_seqp, omp_context *ctx)\n       if (OMP_CLAUSE_CODE (c) != OMP_CLAUSE_REDUCTION)\n \tcontinue;\n \n+      enum omp_clause_code ccode = OMP_CLAUSE_REDUCTION;\n       orig_var = var = OMP_CLAUSE_DECL (c);\n       if (TREE_CODE (var) == MEM_REF)\n \t{\n \t  var = TREE_OPERAND (var, 0);\n \t  if (TREE_CODE (var) == POINTER_PLUS_EXPR)\n \t    var = TREE_OPERAND (var, 0);\n-\t  if (TREE_CODE (var) == INDIRECT_REF\n-\t      || TREE_CODE (var) == ADDR_EXPR)\n+\t  if (TREE_CODE (var) == ADDR_EXPR)\n \t    var = TREE_OPERAND (var, 0);\n+\t  else\n+\t    {\n+\t      /* If this is a pointer or referenced based array\n+\t\t section, the var could be private in the outer\n+\t\t context e.g. on orphaned loop construct.  Pretend this\n+\t\t is private variable's outer reference.  */\n+\t      ccode = OMP_CLAUSE_PRIVATE;\n+\t      if (TREE_CODE (var) == INDIRECT_REF)\n+\t\tvar = TREE_OPERAND (var, 0);\n+\t    }\n \t  orig_var = var;\n \t  if (is_variable_sized (var))\n \t    {\n@@ -5162,7 +5172,7 @@ lower_reduction_clauses (tree clauses, gimple_seq *stmt_seqp, omp_context *ctx)\n       new_var = lookup_decl (var, ctx);\n       if (var == OMP_CLAUSE_DECL (c) && omp_is_reference (var))\n \tnew_var = build_simple_mem_ref_loc (clause_loc, new_var);\n-      ref = build_outer_var_ref (var, ctx);\n+      ref = build_outer_var_ref (var, ctx, ccode);\n       code = OMP_CLAUSE_REDUCTION_CODE (c);\n \n       /* reduction(-:var) sums up the partial results, so it acts"}, {"sha": "d49420aa90e06567eec90e27175fb504eaba2aa4", "filename": "libgomp/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c24783c49924474f54feb0c6038cba4719125634/libgomp%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c24783c49924474f54feb0c6038cba4719125634/libgomp%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2FChangeLog?ref=c24783c49924474f54feb0c6038cba4719125634", "patch": "@@ -1,3 +1,8 @@\n+2017-05-22  Jakub Jelinek  <jakub@redhat.com>\n+\n+\tPR middle-end/80853\n+\t* testsuite/libgomp.c/pr80853.c: New test.\n+\n 2017-05-19  Thomas Schwinge  <thomas@codesourcery.com>\n \n \t* testsuite/libgomp.oacc-c++/template-reduction.C: Update."}, {"sha": "3c0ff10c875538f1b7225e9f9edb01cc84dbef15", "filename": "libgomp/testsuite/libgomp.c/pr80853.c", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/c24783c49924474f54feb0c6038cba4719125634/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr80853.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/c24783c49924474f54feb0c6038cba4719125634/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr80853.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/libgomp%2Ftestsuite%2Flibgomp.c%2Fpr80853.c?ref=c24783c49924474f54feb0c6038cba4719125634", "patch": "@@ -0,0 +1,29 @@\n+/* PR middle-end/80853 */\n+/* { dg-do run } */\n+\n+__attribute__((noinline, noclone)) void\n+foo (int *p)\n+{\n+  #pragma omp for reduction(+:p[:4])\n+  for (int i = 0; i < 64; i++)\n+    {\n+      p[0] += i;\n+      p[1] += i / 2;\n+      p[2] += 2 * i;\n+      p[3] += 3 * i;\n+    }\n+}\n+\n+int\n+main ()\n+{\n+  int p[4] = { 0, 0, 0, 0 };\n+  #pragma omp parallel\n+  foo (p);\n+  if (p[0] != 63 * 64 / 2\n+      || p[1] != 31 * 32\n+      || p[2] != 63 * 64\n+      || p[3] != 3 * 63 * 64 / 2)\n+    __builtin_abort ();\n+  return 0;\n+}"}]}