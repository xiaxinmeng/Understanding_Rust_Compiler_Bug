{"sha": "73598b3330377a9970f4489f5c5d517f62b51386", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NzM1OThiMzMzMDM3N2E5OTcwZjQ0ODlmNWM1ZDUxN2Y2MmI1MTM4Ng==", "commit": {"author": {"name": "Alan Modra", "email": "amodra@gmail.com", "date": "2018-01-25T23:57:18Z"}, "committer": {"name": "Alan Modra", "email": "amodra@gcc.gnu.org", "date": "2018-01-25T23:57:18Z"}, "message": "PR84033, powerpc64le -moptimize-swaps bad code with vec_vbpermq\n\nvbpermq produces its output in bits 48..63 of the target vector reg,\nso the output cannot be lane swapped.\n\ngcc/\n\tPR target/84033\n\t* config/rs6000/rs6000-p8swap.c (rtx_is_swappable_p): Exclude\n\tUNSPEC_VBPERMQ.  Sort other unspecs.\ngcc/testsuite/\n\tPR target/84033\n\t* gcc.target/powerpc/swaps-p8-46.c: New.\n\nFrom-SVN: r257070", "tree": {"sha": "359af78554346f366a1c1b304b5d5009c12ba6b2", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/359af78554346f366a1c1b304b5d5009c12ba6b2"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/73598b3330377a9970f4489f5c5d517f62b51386", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/73598b3330377a9970f4489f5c5d517f62b51386", "html_url": "https://github.com/Rust-GCC/gccrs/commit/73598b3330377a9970f4489f5c5d517f62b51386", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/73598b3330377a9970f4489f5c5d517f62b51386/comments", "author": {"login": "amodra", "id": 6006325, "node_id": "MDQ6VXNlcjYwMDYzMjU=", "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4", "gravatar_id": "", "url": "https://api.github.com/users/amodra", "html_url": "https://github.com/amodra", "followers_url": "https://api.github.com/users/amodra/followers", "following_url": "https://api.github.com/users/amodra/following{/other_user}", "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}", "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/amodra/subscriptions", "organizations_url": "https://api.github.com/users/amodra/orgs", "repos_url": "https://api.github.com/users/amodra/repos", "events_url": "https://api.github.com/users/amodra/events{/privacy}", "received_events_url": "https://api.github.com/users/amodra/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "1bfbe9adbc554930163eb551f9904cf4fe096696", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/1bfbe9adbc554930163eb551f9904cf4fe096696", "html_url": "https://github.com/Rust-GCC/gccrs/commit/1bfbe9adbc554930163eb551f9904cf4fe096696"}], "stats": {"total": 58, "additions": 52, "deletions": 6}, "files": [{"sha": "62dbe56ba80af076b76136e9ee773a1f7d27b3ba", "filename": "gcc/ChangeLog", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2FChangeLog?ref=73598b3330377a9970f4489f5c5d517f62b51386", "patch": "@@ -1,3 +1,9 @@\n+2018-01-26  Alan Modra  <amodra@gmail.com>\n+\n+\tPR target/84033\n+\t* config/rs6000/rs6000-p8swap.c (rtx_is_swappable_p): Exclude\n+\tUNSPEC_VBPERMQ.  Sort other unspecs.\n+\n 2018-01-25  David Edelsohn  <dje.gcc@gmail.com>\n \n \t* doc/invoke.texi (PowerPC Options): Document 'native' cpu type."}, {"sha": "ffcbba9741315e994bdf3edbb3fba3ba881ea0aa", "filename": "gcc/config/rs6000/rs6000-p8swap.c", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2Fconfig%2Frs6000%2Frs6000-p8swap.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2Fconfig%2Frs6000%2Frs6000-p8swap.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fconfig%2Frs6000%2Frs6000-p8swap.c?ref=73598b3330377a9970f4489f5c5d517f62b51386", "patch": "@@ -741,6 +741,7 @@ rtx_is_swappable_p (rtx op, unsigned int *special)\n \t  {\n \t  default:\n \t    break;\n+\t  case UNSPEC_VBPERMQ:\n \t  case UNSPEC_VMRGH_DIRECT:\n \t  case UNSPEC_VMRGL_DIRECT:\n \t  case UNSPEC_VPACK_SIGN_SIGN_SAT:\n@@ -762,8 +763,14 @@ rtx_is_swappable_p (rtx op, unsigned int *special)\n \t  case UNSPEC_VSUMSWS:\n \t  case UNSPEC_VSUMSWS_DIRECT:\n \t  case UNSPEC_VSX_CONCAT:\n+\t  case UNSPEC_VSX_CVDPSPN:\n+\t  case UNSPEC_VSX_CVSPDP:\n+\t  case UNSPEC_VSX_CVSPDPN:\n+\t  case UNSPEC_VSX_EXTRACT:\n \t  case UNSPEC_VSX_SET:\n \t  case UNSPEC_VSX_SLDWI:\n+\t  case UNSPEC_VSX_VEC_INIT:\n+\t  case UNSPEC_VSX_VSLO:\n \t  case UNSPEC_VUNPACK_HI_SIGN:\n \t  case UNSPEC_VUNPACK_HI_SIGN_DIRECT:\n \t  case UNSPEC_VUNPACK_LO_SIGN:\n@@ -774,12 +781,6 @@ rtx_is_swappable_p (rtx op, unsigned int *special)\n \t  case UNSPEC_VUPKLPX:\n \t  case UNSPEC_VUPKLS_V4SF:\n \t  case UNSPEC_VUPKLU_V4SF:\n-\t  case UNSPEC_VSX_CVDPSPN:\n-\t  case UNSPEC_VSX_CVSPDP:\n-\t  case UNSPEC_VSX_CVSPDPN:\n-\t  case UNSPEC_VSX_EXTRACT:\n-\t  case UNSPEC_VSX_VSLO:\n-\t  case UNSPEC_VSX_VEC_INIT:\n \t    return 0;\n \t  case UNSPEC_VSPLT_DIRECT:\n \t  case UNSPEC_VSX_XXSPLTD:"}, {"sha": "6b3c743bb346678d4c1b7d626d8a074303d54f84", "filename": "gcc/testsuite/ChangeLog", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2Ftestsuite%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2Ftestsuite%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2FChangeLog?ref=73598b3330377a9970f4489f5c5d517f62b51386", "patch": "@@ -1,3 +1,8 @@\n+2018-01-26  Alan Modra  <amodra@gmail.com>\n+\n+\tPR target/84033\n+\t* gcc.target/powerpc/swaps-p8-46.c: New.\n+\n 2018-25-01  Paul Thomas  <pault@gcc.gnu.org>\n \n \tPR fortran/37577"}, {"sha": "23494b695a5ac3635e4111bb3dde2c2822be9b1b", "filename": "gcc/testsuite/gcc.target/powerpc/swaps-p8-46.c", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fswaps-p8-46.c", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/73598b3330377a9970f4489f5c5d517f62b51386/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fswaps-p8-46.c", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Ftestsuite%2Fgcc.target%2Fpowerpc%2Fswaps-p8-46.c?ref=73598b3330377a9970f4489f5c5d517f62b51386", "patch": "@@ -0,0 +1,34 @@\n+/* { dg-do run { target { powerpc64le-*-* } } } */\n+/* { dg-require-effective-target powerpc_p8vector_ok } */\n+/* { dg-skip-if \"do not override -mcpu\" { powerpc*-*-* } { \"-mcpu=*\" } { \"-mcpu=power8\" } } */\n+/* { dg-options \"-mcpu=power8 -O2 \" } */\n+\n+typedef __attribute__ ((__aligned__ (8))) unsigned long long __m64;\n+typedef float __m128 __attribute__ ((__vector_size__ (16), __may_alias__));\n+\n+/* PR84033.  Extracted from xmmintrin.h but with a pointer param to\n+   allow swaps to happen when not inline.  */\n+int __attribute__ ((__noinline__))\n+_mm_movemask_ps (__m128 *__A)\n+{\n+  __vector __m64 result;\n+  static const __vector unsigned int perm_mask =\n+    {\n+      0x00204060, 0x80808080, 0x80808080, 0x80808080\n+    };\n+\n+  result = (__vector __m64)\n+    __builtin_vec_vbpermq ((__vector unsigned char) (*__A),\n+\t\t\t   (__vector unsigned char) perm_mask);\n+  return result[1];\n+}\n+\n+int\n+main (void)\n+{\n+  union { unsigned int i[4]; __m128 m; } x\n+    = { 0x80000000, 0x80000000, 0x7fffffff, 0x7fffffff };\n+  if (_mm_movemask_ps (&x.m) != 3)\n+    __builtin_abort ();\n+  return 0;\n+}"}]}