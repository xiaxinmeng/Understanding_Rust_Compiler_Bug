{"sha": "6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "node_id": "MDY6Q29tbWl0MTM2NTMxMDA6NmE1ZTc5YjQ0ZjBkMGQwNmM3OTNlYzIwMGVmM2I1OTdiMDdlYmMxYQ==", "commit": {"author": {"name": "Patrick Bernardi", "email": "bernardi@adacore.com", "date": "2018-01-11T08:51:23Z"}, "committer": {"name": "Pierre-Marie de Rodat", "email": "pmderodat@gcc.gnu.org", "date": "2018-01-11T08:51:23Z"}, "message": "[Ada] Integer overflow in SS_Allocate\n\nThis patch imposes a new check and rewrites existing ones to ensure operations\ninvolving SS_Ptr do not cause an Integer overflow. The Default_Sec_Stack_Size\nfunction was removed in the process to simplify System.Parameter.\n\nSS_Ptr was derived from the integer System.Parameters.Size_Type to ease the\ncreation of objects of type SS_Stack by the binder and imposes a maximum\nsecondary stack size of 2GB. In most cases, the user will not hit this limit as\nthey cannot specify task stack sizes of more than 2GB via the Storage_Size and\nSecondary_Stack_Size pragmas. Additionally, most operating systems limit the\nprimary stack size to less than 2GB, with defaults under 10MB. Linux is the\nrare exception where the user can unbound the primary stack.\n\nExecuting the following:\ngnatmake -q overflow\n./overflow\n\nmust yield:\n\nraised STORAGE_ERROR : s-secsta.adb:140 explicit raise\n\n--  overflow.adb:\n\nwith String_Pack;\n\nprocedure Overflow is\nbegin\n   null;\nend Overflow;\n\n-- string_pack.ads:\n\npackage String_Pack is\n   function Return_Big_String return String;\nend String_Pack;\n\n-- string_pack.adb:\n\nwith Ada.Strings.Fixed; use Ada.Strings.Fixed;\n\npackage body String_Pack is\n   function Return_Big_String return String is\n   begin\n      return Integer'Last * \"P\";\n   end Return_Big_String;\n\n   S : String := Return_Big_String;\n\nend String_Pack;\n\n2018-01-11  Patrick Bernardi  <bernardi@adacore.com>\n\ngcc/ada/\n\n\t* libgnat/s-parame*.adb, libgnat/s-parame*.ads: Remove unneeded\n\tDefault_Sec_Stack_Size.\n\t* libgnat/s-secsta.adb (SS_Allocate): Handle the fixed secondary stack\n\tlimit check so that the integer index does not overflow. Check the\n\tdynamic stack allocation does not cause the secondary stack pointer to\n\toverflow.\n\t(SS_Info): Align colons.\n\t(SS_Init): Cover the case when bootstraping with an old compiler that\n\tdoes not set Default_SS_Size.\n\nFrom-SVN: r256492", "tree": {"sha": "185d602b38c3d191f86bf896a9e94a0207426bad", "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/trees/185d602b38c3d191f86bf896a9e94a0207426bad"}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/git/commits/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "html_url": "https://github.com/Rust-GCC/gccrs/commit/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "comments_url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/comments", "author": {"login": "burratoo", "id": 23646118, "node_id": "MDQ6VXNlcjIzNjQ2MTE4", "avatar_url": "https://avatars.githubusercontent.com/u/23646118?v=4", "gravatar_id": "", "url": "https://api.github.com/users/burratoo", "html_url": "https://github.com/burratoo", "followers_url": "https://api.github.com/users/burratoo/followers", "following_url": "https://api.github.com/users/burratoo/following{/other_user}", "gists_url": "https://api.github.com/users/burratoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/burratoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/burratoo/subscriptions", "organizations_url": "https://api.github.com/users/burratoo/orgs", "repos_url": "https://api.github.com/users/burratoo/repos", "events_url": "https://api.github.com/users/burratoo/events{/privacy}", "received_events_url": "https://api.github.com/users/burratoo/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "5cb78fb862e7eb963c0c6d0ce2deae5b8112858d", "url": "https://api.github.com/repos/Rust-GCC/gccrs/commits/5cb78fb862e7eb963c0c6d0ce2deae5b8112858d", "html_url": "https://github.com/Rust-GCC/gccrs/commit/5cb78fb862e7eb963c0c6d0ce2deae5b8112858d"}], "stats": {"total": 159, "additions": 64, "deletions": 95}, "files": [{"sha": "8ff1a1364a4ce5ff041d80a6665e03826d6918a7", "filename": "gcc/ada/ChangeLog", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2FChangeLog", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2FChangeLog", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2FChangeLog?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -1,3 +1,15 @@\n+2018-01-11  Patrick Bernardi  <bernardi@adacore.com>\n+\n+\t* libgnat/s-parame*.adb, libgnat/s-parame*.ads: Remove unneeded\n+\tDefault_Sec_Stack_Size.\n+\t* libgnat/s-secsta.adb (SS_Allocate): Handle the fixed secondary stack\n+\tlimit check so that the integer index does not overflow. Check the\n+\tdynamic stack allocation does not cause the secondary stack pointer to\n+\toverflow.\n+\t(SS_Info): Align colons.\n+\t(SS_Init): Cover the case when bootstraping with an old compiler that\n+\tdoes not set Default_SS_Size.\n+\n 2018-01-11  Ed Schonberg  <schonberg@adacore.com>\n \n \t* sem_ch3.adb (Add_Internal_Interface_Entities): When checking the"}, {"sha": "0f4d45f2da8f7c2bf4f131f3d5133e660b4e9a87", "filename": "gcc/ada/libgnat/s-parame.adb", "status": "modified", "additions": 0, "deletions": 28, "changes": 28, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame.adb?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -50,34 +50,6 @@ package body System.Parameters is\n       end if;\n    end Adjust_Storage_Size;\n \n-   ----------------------------\n-   -- Default_Sec_Stack_Size --\n-   ----------------------------\n-\n-   function Default_Sec_Stack_Size return Size_Type is\n-      Default_SS_Size : Integer;\n-      pragma Import (C, Default_SS_Size,\n-                     \"__gnat_default_ss_size\");\n-   begin\n-      --  There are two situations where the default secondary stack size is\n-      --  set to zero:\n-      --\n-      --    * The user sets it to zero erroneously thinking it will disable\n-      --      the secondary stack.\n-      --\n-      --    * Or more likely, we are building with an old compiler and\n-      --      Default_SS_Size is never set.\n-      --\n-      --  In both case set the default secondary stack size to the run-time\n-      --  default.\n-\n-      if Default_SS_Size > 0 then\n-         return Size_Type (Default_SS_Size);\n-      else\n-         return Runtime_Default_Sec_Stack_Size;\n-      end if;\n-   end Default_Sec_Stack_Size;\n-\n    ------------------------\n    -- Default_Stack_Size --\n    ------------------------"}, {"sha": "6cad3e7268e977c8363a251b2f8bb6a5c8c06581", "filename": "gcc/ada/libgnat/s-parame.ads", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame.ads?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -93,10 +93,6 @@ package System.Parameters is\n    --  The run-time chosen default size for secondary stacks that may be\n    --  overriden by the user with the use of binder -D switch.\n \n-   function Default_Sec_Stack_Size return Size_Type;\n-   --  The default initial size for secondary stacks that reflects any user\n-   --  specified default via the binder -D switch.\n-\n    Sec_Stack_Dynamic : constant Boolean := True;\n    --  Indicates if secondary stacks can grow and shrink at run-time. If False,\n    --  the size of a secondary stack is fixed at the point of its creation."}, {"sha": "68da0c96479fd3fa448b27562daf29265c8df1d2", "filename": "gcc/ada/libgnat/s-parame__ae653.ads", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__ae653.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__ae653.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame__ae653.ads?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -93,10 +93,6 @@ package System.Parameters is\n    --  The run-time chosen default size for secondary stacks that may be\n    --  overriden by the user with the use of binder -D switch.\n \n-   function Default_Sec_Stack_Size return Size_Type;\n-   --  The default size for secondary stacks that reflects any user specified\n-   --  default via the binder -D switch.\n-\n    Sec_Stack_Dynamic : constant Boolean := False;\n    --  Indicates if secondary stacks can grow and shrink at run-time. If False,\n    --  the size of a secondary stack is fixed at the point of its creation."}, {"sha": "e8ced87d660d2105481d6cb290f24d6c617e4f5b", "filename": "gcc/ada/libgnat/s-parame__hpux.ads", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__hpux.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__hpux.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame__hpux.ads?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -91,10 +91,6 @@ package System.Parameters is\n    --  The run-time chosen default size for secondary stacks that may be\n    --  overriden by the user with the use of binder -D switch.\n \n-   function Default_Sec_Stack_Size return Size_Type;\n-   --  The default initial size for secondary stacks that reflects any user\n-   --  specified default via the binder -D switch.\n-\n    Sec_Stack_Dynamic : constant Boolean := True;\n    --  Indicates if secondary stacks can grow and shrink at run-time. If False,\n    --  the size of a secondary stack is fixed at the point of its creation."}, {"sha": "551eb36c67fde603b8b409ad7b7d1193185d14b6", "filename": "gcc/ada/libgnat/s-parame__rtems.adb", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__rtems.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__rtems.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame__rtems.adb?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -56,18 +56,6 @@ package body System.Parameters is\n       end if;\n    end Adjust_Storage_Size;\n \n-   ----------------------------\n-   -- Default_Sec_Stack_Size --\n-   ----------------------------\n-\n-   function Default_Sec_Stack_Size return Size_Type is\n-      Default_SS_Size : Integer;\n-      pragma Import (C, Default_SS_Size,\n-                     \"__gnat_default_ss_size\");\n-   begin\n-      return Size_Type (Default_SS_Size);\n-   end Default_Sec_Stack_Size;\n-\n    ------------------------\n    -- Default_Stack_Size --\n    ------------------------"}, {"sha": "325aa2e4f08e0fa31a06e9758e4edc454dc4719d", "filename": "gcc/ada/libgnat/s-parame__vxworks.adb", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__vxworks.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__vxworks.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame__vxworks.adb?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -48,18 +48,6 @@ package body System.Parameters is\n       end if;\n    end Adjust_Storage_Size;\n \n-   ----------------------------\n-   -- Default_Sec_Stack_Size --\n-   ----------------------------\n-\n-   function Default_Sec_Stack_Size return Size_Type is\n-      Default_SS_Size : Integer;\n-      pragma Import (C, Default_SS_Size,\n-                     \"__gnat_default_ss_size\");\n-   begin\n-      return Size_Type (Default_SS_Size);\n-   end Default_Sec_Stack_Size;\n-\n    ------------------------\n    -- Default_Stack_Size --\n    ------------------------"}, {"sha": "ab5a085c240a77fd398b21378c8f7a031accd8a8", "filename": "gcc/ada/libgnat/s-parame__vxworks.ads", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__vxworks.ads", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-parame__vxworks.ads", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-parame__vxworks.ads?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -93,10 +93,6 @@ package System.Parameters is\n    --  The run-time chosen default size for secondary stacks that may be\n    --  overriden by the user with the use of binder -D switch.\n \n-   function Default_Sec_Stack_Size return Size_Type;\n-   --  The default initial size for secondary stacks that reflects any user\n-   --  specified default via the binder -D switch.\n-\n    Sec_Stack_Dynamic : constant Boolean := True;\n    --  Indicates if secondary stacks can grow and shrink at run-time. If False,\n    --  the size of a secondary stack is fixed at the point of its creation."}, {"sha": "84d6095c3562045d0885e6647c47e19c807c06d9", "filename": "gcc/ada/libgnat/s-secsta.adb", "status": "modified", "additions": 52, "deletions": 27, "changes": 79, "blob_url": "https://github.com/Rust-GCC/gccrs/blob/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-secsta.adb", "raw_url": "https://github.com/Rust-GCC/gccrs/raw/6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a/gcc%2Fada%2Flibgnat%2Fs-secsta.adb", "contents_url": "https://api.github.com/repos/Rust-GCC/gccrs/contents/gcc%2Fada%2Flibgnat%2Fs-secsta.adb?ref=6a5e79b44f0d0d06c793ec200ef3b597b07ebc1a", "patch": "@@ -52,27 +52,40 @@ package body System.Secondary_Stack is\n      (Addr         : out Address;\n       Storage_Size : SSE.Storage_Count)\n    is\n+      use type System.Storage_Elements.Storage_Count;\n+\n       Max_Align   : constant SS_Ptr := SS_Ptr (Standard'Maximum_Alignment);\n-      Mem_Request : constant SS_Ptr :=\n-                      ((SS_Ptr (Storage_Size) + Max_Align - 1) / Max_Align) *\n-                        Max_Align;\n-      --  Round up Storage_Size to the nearest multiple of the max alignment\n-      --  value for the target. This ensures efficient stack access.\n+      Mem_Request : SS_Ptr;\n \n-      Stack : constant SS_Stack_Ptr := SSL.Get_Sec_Stack.all;\n+      Stack       : constant SS_Stack_Ptr := SSL.Get_Sec_Stack.all;\n    begin\n+      --  Round up Storage_Size to the nearest multiple of the max alignment\n+      --  value for the target. This ensures efficient stack access. First\n+      --  perform a check to ensure that the rounding operation does not\n+      --  overflow SS_Ptr.\n+\n+      if SSE.Storage_Count (SS_Ptr'Last) - Standard'Maximum_Alignment <\n+        Storage_Size\n+      then\n+         raise Storage_Error;\n+      end if;\n+\n+      Mem_Request := ((SS_Ptr (Storage_Size) + Max_Align - 1) / Max_Align) *\n+                       Max_Align;\n+\n       --  Case of fixed secondary stack\n \n       if not SP.Sec_Stack_Dynamic then\n          --  Check if max stack usage is increasing\n \n-         if Stack.Top + Mem_Request > Stack.Max then\n+         if Stack.Max - Stack.Top - Mem_Request < 0 then\n \n             --  If so, check if the stack is exceeded, noting Stack.Top points\n             --  to the first free byte (so the value of Stack.Top on a fully\n-            --  allocated stack will be Stack.Size + 1).\n+            --  allocated stack will be Stack.Size + 1). The comparison is\n+            --  formed to prevent integer overflows.\n \n-            if Stack.Top + Mem_Request > Stack.Size + 1 then\n+            if Stack.Size - Stack.Top - Mem_Request < -1 then\n                raise Storage_Error;\n             end if;\n \n@@ -90,8 +103,8 @@ package body System.Secondary_Stack is\n \n       else\n          declare\n-            Chunk : Chunk_Ptr;\n-\n+            Chunk                : Chunk_Ptr;\n+            Chunk_Size           : SS_Ptr;\n             To_Be_Released_Chunk : Chunk_Ptr;\n \n          begin\n@@ -108,9 +121,8 @@ package body System.Secondary_Stack is\n             --  sufficient, if not, go to the next one and eventually create\n             --  the necessary room.\n \n-            while Chunk.Last - Stack.Top + 1 < Mem_Request loop\n+            while Chunk.Last - Stack.Top - Mem_Request < -1 loop\n                if Chunk.Next /= null then\n-\n                   --  Release unused non-first empty chunk\n \n                   if Chunk.Prev /= null and then Chunk.First = Stack.Top then\n@@ -121,24 +133,29 @@ package body System.Secondary_Stack is\n                      Free (To_Be_Released_Chunk);\n                   end if;\n \n-               --  Create new chunk of default size unless it is not sufficient\n-               --  to satisfy the current request.\n+               --  Create a new chunk\n \n-               elsif Mem_Request <= Stack.Size then\n-                  Chunk.Next :=\n-                    new Chunk_Id\n-                      (First => Chunk.Last + 1,\n-                       Last  => Chunk.Last + SS_Ptr (Stack.Size));\n+               else\n+                  --  The new chunk should be no smaller than the default\n+                  --  chunk size to minimize the amount of secondary stack\n+                  --  management.\n+\n+                  if Mem_Request <= Stack.Size then\n+                     Chunk_Size := Stack.Size;\n+                  else\n+                     Chunk_Size := Mem_Request;\n+                  end if;\n \n-                  Chunk.Next.Prev := Chunk;\n+                  --  Check that the indexing limits are not exceeded\n \n-               --  Otherwise create new chunk of requested size\n+                  if SS_Ptr'Last - Chunk.Last - Chunk_Size < 0 then\n+                     raise Storage_Error;\n+                  end if;\n \n-               else\n                   Chunk.Next :=\n                     new Chunk_Id\n                       (First => Chunk.Last + 1,\n-                       Last  => Chunk.Last + Mem_Request);\n+                       Last  => Chunk.Last + Chunk_Size);\n \n                   Chunk.Next.Prev := Chunk;\n                end if;\n@@ -267,10 +284,10 @@ package body System.Secondary_Stack is\n                       & SS_Ptr'Image (Stack.Top - 1)\n                       & \" bytes\");\n \n-            Put_Line (\"  Number of Chunks       : \"\n+            Put_Line (\"  Number of Chunks        : \"\n                       & Integer'Image (Nb_Chunks));\n \n-            Put_Line (\"  Default size of Chunks : \"\n+            Put_Line (\"  Default size of Chunks  : \"\n                       & SP.Size_Type'Image (Stack.Size));\n          end;\n       end if;\n@@ -300,7 +317,15 @@ package body System.Secondary_Stack is\n \n       if Stack = null then\n          if Size = Unspecified_Size then\n-            Stack_Size := Default_Sec_Stack_Size;\n+            --  Cover the case when bootstraping with an old compiler that does\n+            --  not set Default_SS_Size.\n+\n+            if Default_SS_Size > 0 then\n+               Stack_Size := Default_SS_Size;\n+            else\n+               Stack_Size := Runtime_Default_Sec_Stack_Size;\n+            end if;\n+\n          else\n             Stack_Size := Size;\n          end if;"}]}