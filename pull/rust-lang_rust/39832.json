{"url": "https://api.github.com/repos/rust-lang/rust/pulls/39832", "id": 106211715, "node_id": "MDExOlB1bGxSZXF1ZXN0MTA2MjExNzE1", "html_url": "https://github.com/rust-lang/rust/pull/39832", "diff_url": "https://github.com/rust-lang/rust/pull/39832.diff", "patch_url": "https://github.com/rust-lang/rust/pull/39832.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/39832", "number": 39832, "state": "closed", "locked": false, "title": "Add support for the x86-interrupt calling convention", "user": {"login": "phil-opp", "id": 1131315, "node_id": "MDQ6VXNlcjExMzEzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1131315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phil-opp", "html_url": "https://github.com/phil-opp", "followers_url": "https://api.github.com/users/phil-opp/followers", "following_url": "https://api.github.com/users/phil-opp/following{/other_user}", "gists_url": "https://api.github.com/users/phil-opp/gists{/gist_id}", "starred_url": "https://api.github.com/users/phil-opp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phil-opp/subscriptions", "organizations_url": "https://api.github.com/users/phil-opp/orgs", "repos_url": "https://api.github.com/users/phil-opp/repos", "events_url": "https://api.github.com/users/phil-opp/events{/privacy}", "received_events_url": "https://api.github.com/users/phil-opp/received_events", "type": "User", "site_admin": false}, "body": "## Overview\r\n\r\nThis calling convention can be used for definining interrupt handlers on 32-bit and 64-bit x86 targets. The compiler then uses `iret` instead of `ret` for returning and ensures that all registers are restored to their\r\noriginal values.\r\n\r\nUsage:\r\n\r\n```rust\r\nextern \"x86-interrupt\" fn handler(stack_frame: &ExceptionStackFrame) {\u2026}\r\n```\r\n\r\nfor interrupts and exceptions without error code and\r\n\r\n```rust\r\nextern \"x86-interrupt\" fn handler_with_err_code(stack_frame: &ExceptionStackFrame,\r\n                                                error_code: u64) {\u2026}\r\n```\r\n\r\nfor exceptions that push an error code (e.g., page faults or general protection faults). The programmer must ensure that the correct version is used for each interrupt.\r\n\r\nFor more details see the [LLVM PR][1] and the corresponding [proposal][2].\r\n\r\n[1]: https://reviews.llvm.org/D15567\r\n[2]: http://lists.llvm.org/pipermail/cfe-dev/2015-September/045171.html\r\n\r\n## Compared to naked functions\r\n\r\nIt is also possible to implement interrupt handlers on x86 through [naked functions](https://github.com/rust-lang/rfcs/blob/master/text/1201-naked-fns.md). In fact, almost all existing Rust OS projects for x86 use naked functions for this, including [Redox](https://github.com/redox-os/kernel/blob/b9793deb59c7650f0805dea96adb6b773ad99336/arch/x86_64/src/lib.rs#L109-L147), [IntermezzOS](https://github.com/intermezzOS/kernel/blob/f959cc18c78b1ba153f3ff7039d9ecc07f397628/interrupts/src/lib.rs#L28-L72), and [blog_os](https://github.com/phil-opp/blog_os/blob/844d739379ffdea6a7ede88365ec6e21a725bbf5/src/interrupts/mod.rs#L49-L64). So support for the `x86-interrupt` calling convention isn't absolutely needed.\r\n\r\nHowever, it has a number of benefits to naked functions:\r\n\r\n- **No inline assembly needed**: [Inline assembly](https://doc.rust-lang.org/book/inline-assembly.html) is highly unstable and dangerous. It's pretty easy to mess things up. Also, it uses an arcane syntax and requires that the programmer knows x86 assembly.\r\n- **Higher performance**: A naked wrapper function always saves _all_ registers before calling the Rust function. This isn't needed for a compiler supported calling convention, since the compiler knows which registers are clobbered by the interrupt handler. Thus, only these registers need to be saved and restored.\r\n- **Safer interfaces**: We can write a `set_handler` function that takes a `extern \"x86-interrupt\" fn(&ExceptionStackFrame)` and the compiler ensures that we always use the right function type for all handler functions. This isn't possible with the `#[naked]` attribute.\r\n- **More convenient**: Instead of writing [tons of assembly boilerplate](https://github.com/redox-os/kernel/blob/b9793deb59c7650f0805dea96adb6b773ad99336/arch/x86_64/src/lib.rs#L109-L147) and desperately trying to improve things [through macros](https://github.com/phil-opp/blog_os/blob/844d739379ffdea6a7ede88365ec6e21a725bbf5/src/interrupts/mod.rs#L17-L92), we can just write [code like this](https://github.com/phil-opp/blog_os/blob/e6a61f9507a4c4fef6fb4e3474bc596391bc97d2/src/interrupts/mod.rs#L85-L89).\r\n- **Naked functions are unreliable**: It is allowed to use Rust code inside a naked function, which sometimes works and sometimes not. For example, [calling a function](https://github.com/redox-os/kernel/blob/b9793deb59c7650f0805dea96adb6b773ad99336/arch/x86_64/src/lib.rs#L132) through Rust code seems to work fine without function prologue, but [code declaring a variable](https://is.gd/NQYXqE) silently adds a prologue even though the function is naked (look at the generated assembly, there is a `movl` instruction before the `nop`).\r\n\r\n## Known issues\r\n\r\n**Edit**: See the [tracking issue](https://github.com/rust-lang/rust/issues/40180) for an updated list of issues.\r\n\r\nUnfortunately, the implementation of the `x86-interrupt` calling convention in LLVM has some issues that make it unsuitable for 64-bit kernels at the moment:\r\n\r\n- LLVM always tries to backup the `xmm` registers on 64-bit platforms even if the target doesn't support SSE. This leads to invalid opcode exceptions whenever an interrupt handler is invoked. I submitted a fix to LLVM in [D29959](https://reviews.llvm.org/D29959). The fix is really small (<10 lines), so maybe we could backport it to [Rust's LLVM fork](https://github.com/rust-lang/llvm)?. **Edit**: The fix was merged to LLVM trunk in [rL295347](https://reviews.llvm.org/rL295347). Backported in https://github.com/rust-lang/llvm/pull/63.\r\n\r\n- On targets with SSE support, LLVM uses the `movaps` instruction for saving the `xmm` registers, which requires an alignment of 16. For handlers with error codes, however, the stack alignment is only 8, so a alignment exception occurs. This issue is tracked in [bug 26413](https://bugs.llvm.org/show_bug.cgi?id=26413). ~~Unfortunately, I don't know enough about LLVM to fix this.~~ **Edit**: Fix submitted in [D30049](https://reviews.llvm.org/D30049).\r\n\r\n## About this PR\r\n\r\nThis PR adds experimental support for this calling convention under the `abi_x86_interrupt` feature gate. The implementation is very similar to #38465 and was surprisingly simple :).\r\n\r\nThere is no accepted RFC for this change. In fact, the [RFC for interrupt calling convention](https://github.com/rust-lang/rfcs/pull/1275) from 2015 was closed in favor of naked functions. However, the reactions to the recent [PR](https://github.com/rust-lang/rust/pull/38465) for a MSP430 interrupt calling convention were [in favor of experimental interrupt ABIs](https://github.com/rust-lang/rust/pull/38465#issuecomment-270015470).\r\n\r\n## Todo\r\n\r\n- [x] Add compile-fail tests for the feature gate.\r\n- [x] Create tracking issue for the `abi_x86_interrupt` feature (and link it in code). **Edit**: Tracking issue: #40180\r\n- [x] Backport [rL295347](https://reviews.llvm.org/rL295347) to Rust's LLVM fork. **Edit**: Done in https://github.com/rust-lang/llvm/pull/63\r\n\r\n## CC\r\n\r\n@tari @steveklabnik @jackpot51 @ticki @hawkw @thepowersgang, you might be interested in this.", "created_at": "2017-02-14T23:06:08Z", "updated_at": "2017-09-21T08:42:40Z", "closed_at": "2017-03-02T22:15:44Z", "merged_at": "2017-03-02T22:15:44Z", "merge_commit_sha": "b44805875e3d2e7ac42052cf90d3d7dade90567c", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/39832/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/39832/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/39832/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/b44805875e3d2e7ac42052cf90d3d7dade90567c", "head": {"label": "phil-opp:x86-interrupt-calling-convention", "ref": "x86-interrupt-calling-convention", "sha": "b44805875e3d2e7ac42052cf90d3d7dade90567c", "user": {"login": "phil-opp", "id": 1131315, "node_id": "MDQ6VXNlcjExMzEzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1131315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phil-opp", "html_url": "https://github.com/phil-opp", "followers_url": "https://api.github.com/users/phil-opp/followers", "following_url": "https://api.github.com/users/phil-opp/following{/other_user}", "gists_url": "https://api.github.com/users/phil-opp/gists{/gist_id}", "starred_url": "https://api.github.com/users/phil-opp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phil-opp/subscriptions", "organizations_url": "https://api.github.com/users/phil-opp/orgs", "repos_url": "https://api.github.com/users/phil-opp/repos", "events_url": "https://api.github.com/users/phil-opp/events{/privacy}", "received_events_url": "https://api.github.com/users/phil-opp/received_events", "type": "User", "site_admin": false}, "repo": {"id": 34984128, "node_id": "MDEwOlJlcG9zaXRvcnkzNDk4NDEyOA==", "name": "rust", "full_name": "phil-opp/rust", "private": false, "owner": {"login": "phil-opp", "id": 1131315, "node_id": "MDQ6VXNlcjExMzEzMTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1131315?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phil-opp", "html_url": "https://github.com/phil-opp", "followers_url": "https://api.github.com/users/phil-opp/followers", "following_url": "https://api.github.com/users/phil-opp/following{/other_user}", "gists_url": "https://api.github.com/users/phil-opp/gists{/gist_id}", "starred_url": "https://api.github.com/users/phil-opp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phil-opp/subscriptions", "organizations_url": "https://api.github.com/users/phil-opp/orgs", "repos_url": "https://api.github.com/users/phil-opp/repos", "events_url": "https://api.github.com/users/phil-opp/events{/privacy}", "received_events_url": "https://api.github.com/users/phil-opp/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/phil-opp/rust", "description": "a safe, concurrent, practical language", "fork": true, "url": "https://api.github.com/repos/phil-opp/rust", "forks_url": "https://api.github.com/repos/phil-opp/rust/forks", "keys_url": "https://api.github.com/repos/phil-opp/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/phil-opp/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/phil-opp/rust/teams", "hooks_url": "https://api.github.com/repos/phil-opp/rust/hooks", "issue_events_url": "https://api.github.com/repos/phil-opp/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/phil-opp/rust/events", "assignees_url": "https://api.github.com/repos/phil-opp/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/phil-opp/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/phil-opp/rust/tags", "blobs_url": "https://api.github.com/repos/phil-opp/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/phil-opp/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/phil-opp/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/phil-opp/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/phil-opp/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/phil-opp/rust/languages", "stargazers_url": "https://api.github.com/repos/phil-opp/rust/stargazers", "contributors_url": "https://api.github.com/repos/phil-opp/rust/contributors", "subscribers_url": "https://api.github.com/repos/phil-opp/rust/subscribers", "subscription_url": "https://api.github.com/repos/phil-opp/rust/subscription", "commits_url": "https://api.github.com/repos/phil-opp/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/phil-opp/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/phil-opp/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/phil-opp/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/phil-opp/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/phil-opp/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/phil-opp/rust/merges", "archive_url": "https://api.github.com/repos/phil-opp/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/phil-opp/rust/downloads", "issues_url": "https://api.github.com/repos/phil-opp/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/phil-opp/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/phil-opp/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/phil-opp/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/phil-opp/rust/labels{/name}", "releases_url": "https://api.github.com/repos/phil-opp/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/phil-opp/rust/deployments", "created_at": "2015-05-03T11:46:07Z", "updated_at": "2020-11-14T11:18:53Z", "pushed_at": "2020-10-24T14:13:50Z", "git_url": "git://github.com/phil-opp/rust.git", "ssh_url": "git@github.com:phil-opp/rust.git", "clone_url": "https://github.com/phil-opp/rust.git", "svn_url": "https://github.com/phil-opp/rust", "homepage": "http://www.rust-lang.org", "size": 563457, "stargazers_count": 2, "watchers_count": 2, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 2, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "8ae411e1b342bb1756f620b0c97bfa9e4eef4e47", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T12:54:15Z", "pushed_at": "2023-06-19T12:54:45Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 920473, "stargazers_count": 82746, "watchers_count": 82746, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9632, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9632, "watchers": 82746, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/39832"}, "html": {"href": "https://github.com/rust-lang/rust/pull/39832"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/39832"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/39832/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/39832/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/39832/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/b44805875e3d2e7ac42052cf90d3d7dade90567c"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "comments": 37, "review_comments": 6, "maintainer_can_modify": false, "commits": 1, "additions": 48, "deletions": 1, "changed_files": 7}