{"url": "https://api.github.com/repos/rust-lang/rust/pulls/101551", "id": 1049321035, "node_id": "PR_kwDOAAsO6M4-i15L", "html_url": "https://github.com/rust-lang/rust/pull/101551", "diff_url": "https://github.com/rust-lang/rust/pull/101551.diff", "patch_url": "https://github.com/rust-lang/rust/pull/101551.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/101551", "number": 101551, "state": "open", "locked": false, "title": "[WIP] Add support for custom allocator for `String`", "user": {"login": "zachs18", "id": 8355914, "node_id": "MDQ6VXNlcjgzNTU5MTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/8355914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zachs18", "html_url": "https://github.com/zachs18", "followers_url": "https://api.github.com/users/zachs18/followers", "following_url": "https://api.github.com/users/zachs18/following{/other_user}", "gists_url": "https://api.github.com/users/zachs18/gists{/gist_id}", "starred_url": "https://api.github.com/users/zachs18/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zachs18/subscriptions", "organizations_url": "https://api.github.com/users/zachs18/orgs", "repos_url": "https://api.github.com/users/zachs18/repos", "events_url": "https://api.github.com/users/zachs18/events{/privacy}", "received_events_url": "https://api.github.com/users/zachs18/received_events", "type": "User", "site_admin": false}, "body": "[Roadmap](https://github.com/rust-lang/wg-allocators/issues/7) for allocator support.\r\n\r\nAPI Change Proposal: https://github.com/rust-lang/libs-team/issues/101\r\n\r\nA subset/bring-to-current of #79500 utilizing a [workaround](https://github.com/rust-lang/rust/issues/79499#issuecomment-1238578527)(?) to the issue (#79499) that was blocking it.\r\n(Note: I previously tried rebasing that (2 year old) PR onto current master, which was not my best idea).\r\n\r\n---\r\n\r\nBlocked on:\r\n- [x] https://github.com/rust-lang/libs-team/issues/101\r\n- [ ] https://github.com/rust-lang/rust/issues/27336 , \"defaults affect inference\" problem in general e.g. #101319\r\n- [ ] (diagnostics, maybe blocking) #101992\r\n\r\n## Todo/Unresolved Questions:\r\n- [x] ~~Fix UI tests.~~ Done? ~~(see my [question below](https://github.com/rust-lang/rust/pull/101551#discussion_r966409044))~~ (see #101992)\r\n- [x] Gdb/Lldb pretty-printing of `String<A>`.\r\n- [x] ~~Should `From<String<A>> for Rc<str>`/`Arc` be removed from this PR? (Corresponding impl does not exist for `Vec`/`Rc<[T]>`, and also it may preclude a future `From<String<A>> for Rc<str, A>`)~~ removed\r\n- [ ] Should `impl StructuralEq for String<_>` be re-added? This PR removes it (because it no longer `derive(Eq)`), but it may not be observable because `String: !StructuralPartialEq` \r\n  - [ ] Also for `FromUtf8Error<_>`, but that derived both `PartialEq` and `Eq` so it had both `StructuralPartialEq` and `StructuralEq`.\r\n  - (Future: This will also will apply to `CString`, which derives `PartialEq` and `Eq`.)\r\n- [ ] `impl<A: Allocator> From<String<A>> to Box<str, A>` breaks orphan rules? (because `Box` and `str` are fundamental?)\r\n- [ ] Add better ways to make a new non-empty `String<A>`?\r\n  - `fn String<A>::from_str_in(s: &str, alloc: A) -> String<A>`?\r\n  - Likewise `fn str::to_string_in(alloc: A) -> String<A>` (parallels `slice::to_vec_in`)\r\n  - Or maybe add `to_string_in` to `ToString`? (Probably a non-starter, since that would make ToString not object-safe, unless we put a `where Self: Sized`, which would preclude `str`)\r\n- ~~[ ] Other `FIXME`s (implement or remove comments)~~ (removed FIXME comments, APIs moved to future work)\r\n### Possible Future work\r\n* How to handle `from_utf8_lossy`, which returns a non-allocator-aware `Cow<str>`?\r\n* How to handle `from_utf16(_lossy)`, which return `String` and `Result<String, _>`?\r\n  * Could have them return `String<A> where A: Default`\r\n  * Could add` from_utf16(_lossy)_in`, (#79500 only added `from_utf16_in`, not the lossy version)\r\n* (If specialization like this is sound), `From<Cow<str>> for String<A> where A: Default` could be implemented as `from_str_in(&*cow, A::default())` , and specialized for `A = Global` to the current implementation `cow.into_owned()`.\r\n* `From<&String<A>> for String<A> where A: Clone` or `From<&String<A>> for String<B> where B: Default` (I don't think both can exist).\r\n* `FromIterator<_> for String`, `FromStr for String`, and `From<&str-like> for String` could be `for String<A> where A: Default`.\r\n* `impl const Default for String` could be `impl<A: _ + ~const Default> Default for String<A>`, except that `Global` doesn't implement `const Default` currently (but I don't see any reason it couldn't).", "created_at": "2022-09-07T23:33:32Z", "updated_at": "2023-05-18T15:19:21Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "eea523ec5502f063f8fdfedb79706f6234fbaede", "assignee": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 4351576587, "node_id": "LA_kwDOAAsO6M8AAAABA1_KCw", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-ACP", "name": "S-waiting-on-ACP", "color": "d3dddd", "default": false, "description": "Status: PR has an ACP and is waiting for the ACP to complete."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/101551/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/101551/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/101551/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/d69b94d5d141dbfbf7fe410db06237e6718bceca", "head": {"label": "zachs18:string_alloc", "ref": "string_alloc", "sha": "d69b94d5d141dbfbf7fe410db06237e6718bceca", "user": {"login": "zachs18", "id": 8355914, "node_id": "MDQ6VXNlcjgzNTU5MTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/8355914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zachs18", "html_url": "https://github.com/zachs18", "followers_url": "https://api.github.com/users/zachs18/followers", "following_url": "https://api.github.com/users/zachs18/following{/other_user}", "gists_url": "https://api.github.com/users/zachs18/gists{/gist_id}", "starred_url": "https://api.github.com/users/zachs18/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zachs18/subscriptions", "organizations_url": "https://api.github.com/users/zachs18/orgs", "repos_url": "https://api.github.com/users/zachs18/repos", "events_url": "https://api.github.com/users/zachs18/events{/privacy}", "received_events_url": "https://api.github.com/users/zachs18/received_events", "type": "User", "site_admin": false}, "repo": {"id": 470664774, "node_id": "R_kgDOHA3GRg", "name": "rust", "full_name": "zachs18/rust", "private": false, "owner": {"login": "zachs18", "id": 8355914, "node_id": "MDQ6VXNlcjgzNTU5MTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/8355914?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zachs18", "html_url": "https://github.com/zachs18", "followers_url": "https://api.github.com/users/zachs18/followers", "following_url": "https://api.github.com/users/zachs18/following{/other_user}", "gists_url": "https://api.github.com/users/zachs18/gists{/gist_id}", "starred_url": "https://api.github.com/users/zachs18/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zachs18/subscriptions", "organizations_url": "https://api.github.com/users/zachs18/orgs", "repos_url": "https://api.github.com/users/zachs18/repos", "events_url": "https://api.github.com/users/zachs18/events{/privacy}", "received_events_url": "https://api.github.com/users/zachs18/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/zachs18/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/zachs18/rust", "forks_url": "https://api.github.com/repos/zachs18/rust/forks", "keys_url": "https://api.github.com/repos/zachs18/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/zachs18/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/zachs18/rust/teams", "hooks_url": "https://api.github.com/repos/zachs18/rust/hooks", "issue_events_url": "https://api.github.com/repos/zachs18/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/zachs18/rust/events", "assignees_url": "https://api.github.com/repos/zachs18/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/zachs18/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/zachs18/rust/tags", "blobs_url": "https://api.github.com/repos/zachs18/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/zachs18/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/zachs18/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/zachs18/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/zachs18/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/zachs18/rust/languages", "stargazers_url": "https://api.github.com/repos/zachs18/rust/stargazers", "contributors_url": "https://api.github.com/repos/zachs18/rust/contributors", "subscribers_url": "https://api.github.com/repos/zachs18/rust/subscribers", "subscription_url": "https://api.github.com/repos/zachs18/rust/subscription", "commits_url": "https://api.github.com/repos/zachs18/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/zachs18/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/zachs18/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/zachs18/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/zachs18/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/zachs18/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/zachs18/rust/merges", "archive_url": "https://api.github.com/repos/zachs18/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/zachs18/rust/downloads", "issues_url": "https://api.github.com/repos/zachs18/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/zachs18/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/zachs18/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/zachs18/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/zachs18/rust/labels{/name}", "releases_url": "https://api.github.com/repos/zachs18/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/zachs18/rust/deployments", "created_at": "2022-03-16T16:28:23Z", "updated_at": "2022-05-02T18:37:00Z", "pushed_at": "2023-03-20T17:45:28Z", "git_url": "git://github.com/zachs18/rust.git", "ssh_url": "git@github.com:zachs18/rust.git", "clone_url": "https://github.com/zachs18/rust.git", "svn_url": "https://github.com/zachs18/rust", "homepage": "https://www.rust-lang.org", "size": 1094268, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "999ac5f7770bff68bd65f490990d32c3ec1faaa6", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T06:32:42Z", "pushed_at": "2023-06-20T06:29:14Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 930404, "stargazers_count": 82766, "watchers_count": 82766, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10963, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9622, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10963, "open_issues": 9622, "watchers": 82766, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/101551"}, "html": {"href": "https://github.com/rust-lang/rust/pull/101551"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/101551"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/101551/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/101551/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/101551/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/d69b94d5d141dbfbf7fe410db06237e6718bceca"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 17, "review_comments": 15, "maintainer_can_modify": true, "commits": 12, "additions": 552, "deletions": 152, "changed_files": 54}