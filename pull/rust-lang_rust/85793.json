{"url": "https://api.github.com/repos/rust-lang/rust/pulls/85793", "id": 657038707, "node_id": "MDExOlB1bGxSZXF1ZXN0NjU3MDM4NzA3", "html_url": "https://github.com/rust-lang/rust/pull/85793", "diff_url": "https://github.com/rust-lang/rust/pull/85793.diff", "patch_url": "https://github.com/rust-lang/rust/pull/85793.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/85793", "number": 85793, "state": "closed", "locked": false, "title": "metadata-link: add -Zmetadata-link flag", "user": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "body": "This adds the -Zmetadata-link flag, whose intent is to make the output\r\nof `--emit metadata` equivalent to `--emit metadata,link`. The goal is\r\nto allow pipelined builds with separate invocations of rustc. This is\r\ndesireable for two reasons:\r\n\r\n1. The \"artifact notification\" system that rustc and cargo use to\r\n  communicate is very cargo-specific - it doesn't fit well into other\r\n  builds systems such as Buck or Bazel. In general its incompatible with\r\n  any build system which only recognizes output artifacts once the\r\n  compiler process has terminated. This is a particular problem when\r\n  compilation is distributed.\r\n\r\n2. The rmeta file could be cached independently from the rlib. For\r\n  example, if one generates compilation-ready rmeta files as part\r\n  of \"check\" build, then those can be directly used for a full\r\n  compilation from cache, without having to regenerate them. This\r\n  means the build turns into a highly parallelizable invocation of\r\n  `rustc --emit link` commands using cached `rmeta` files as input.\r\n\r\nInitially this flag `-Zmetadata-link`, but ultimately I'd expect to\r\nstabilize it as `-Cmetadata-link` (or a better name).\r\n\r\nThere's some outstanding problems/questions:\r\n- ~~No tests. It's not clear to me that there are existing tests which cover the pipelined\r\n  build mode specifically; `src/tests/ui/rmeta` somewhat touches on it.~~ Added tests for\r\n  plain pipelined builds and with `-Zmetadata-link`.\r\n- ~~The generated rmetas from `--emit metadata -Zmetadata-link` are much larger\r\n  than those from `--emit metadata,link` and I don't know why. While they seem to work\r\n  in local ad-hoc testing, I'm concerned they may have different performance/compilation time/something else\r\n  problems.~~ I'm not sure what I was seeing before, but this looks fine - they're within a couple of bytes of each other.\r\n- This is very similar to `-Zalways-encode-mir` but I think they're logically distinct (eg I see\r\n  this new flag as being on stabilization track).\r\n  - @bjorn3 suggests this might be equivalent to `--emit metadata,link -Zno-codegen` which\r\n    sounds plausible but quite roundabout.\r\n- Another approach might be to make `--emit metadata` always work this way, and maybe\r\n  add `--emit check` which emits a subset of rmeta for check builds. This would either mean\r\n  that there could be a mixture of different kinds of rmeta files which are usable for different uses\r\n  (ie, the confusion of two different `--emit` options producing files with the same name but different\r\n  content. Alternatively `--emit check` could generate (say) `.rcheck` files, but that adds complexity\r\n  to locating files, since we'd end up with a 3 level heirarchy of rlib > rmeta > rcheck in terms of\r\n  what the files are useful for. I experimented with this briefly, but its effects ended up being overwhelmingly\r\n  sprawling and complex (eg affecting Cargo as well).\r\n  `-Zmetadata-link` is much more narrowly scoped and opt-in.", "created_at": "2021-05-28T20:18:36Z", "updated_at": "2021-06-07T18:50:14Z", "closed_at": "2021-06-07T18:50:14Z", "merged_at": null, "merge_commit_sha": "5740d424689c61a9702714bdbcfc3ccaf0ea97e6", "assignee": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/85793/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/85793/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85793/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/83b4d4da4597c38cc7a28b3f1d12a2cf40bc7c1d", "head": {"label": "jsgf:metadata-link", "ref": "metadata-link", "sha": "83b4d4da4597c38cc7a28b3f1d12a2cf40bc7c1d", "user": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "repo": {"id": 65047958, "node_id": "MDEwOlJlcG9zaXRvcnk2NTA0Nzk1OA==", "name": "rust", "full_name": "jsgf/rust", "private": false, "owner": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/jsgf/rust", "description": "A safe, concurrent, practical language.", "fork": true, "url": "https://api.github.com/repos/jsgf/rust", "forks_url": "https://api.github.com/repos/jsgf/rust/forks", "keys_url": "https://api.github.com/repos/jsgf/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/jsgf/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/jsgf/rust/teams", "hooks_url": "https://api.github.com/repos/jsgf/rust/hooks", "issue_events_url": "https://api.github.com/repos/jsgf/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/jsgf/rust/events", "assignees_url": "https://api.github.com/repos/jsgf/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/jsgf/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/jsgf/rust/tags", "blobs_url": "https://api.github.com/repos/jsgf/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/jsgf/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/jsgf/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/jsgf/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/jsgf/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/jsgf/rust/languages", "stargazers_url": "https://api.github.com/repos/jsgf/rust/stargazers", "contributors_url": "https://api.github.com/repos/jsgf/rust/contributors", "subscribers_url": "https://api.github.com/repos/jsgf/rust/subscribers", "subscription_url": "https://api.github.com/repos/jsgf/rust/subscription", "commits_url": "https://api.github.com/repos/jsgf/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/jsgf/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/jsgf/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/jsgf/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/jsgf/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/jsgf/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/jsgf/rust/merges", "archive_url": "https://api.github.com/repos/jsgf/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/jsgf/rust/downloads", "issues_url": "https://api.github.com/repos/jsgf/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/jsgf/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/jsgf/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/jsgf/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/jsgf/rust/labels{/name}", "releases_url": "https://api.github.com/repos/jsgf/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/jsgf/rust/deployments", "created_at": "2016-08-05T20:46:12Z", "updated_at": "2022-04-17T02:30:08Z", "pushed_at": "2023-02-22T18:35:27Z", "git_url": "git://github.com/jsgf/rust.git", "ssh_url": "git@github.com:jsgf/rust.git", "clone_url": "https://github.com/jsgf/rust.git", "svn_url": "https://github.com/jsgf/rust", "homepage": "https://www.rust-lang.org", "size": 1066318, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "758c00ea4088e1ca2714890f00c791c24f001536", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T06:07:21Z", "pushed_at": "2023-06-19T06:15:17Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 919635, "stargazers_count": 82734, "watchers_count": 82734, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10953, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9628, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10953, "open_issues": 9628, "watchers": 82734, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/85793"}, "html": {"href": "https://github.com/rust-lang/rust/pull/85793"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/85793"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/85793/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/85793/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/85793/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/83b4d4da4597c38cc7a28b3f1d12a2cf40bc7c1d"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 16, "review_comments": 1, "maintainer_can_modify": false, "commits": 3, "additions": 109, "deletions": 9, "changed_files": 8}