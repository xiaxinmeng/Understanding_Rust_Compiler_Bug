{"url": "https://api.github.com/repos/rust-lang/rust/pulls/93056", "id": 826002820, "node_id": "PR_kwDOAAsO6M4xO82E", "html_url": "https://github.com/rust-lang/rust/pull/93056", "diff_url": "https://github.com/rust-lang/rust/pull/93056.diff", "patch_url": "https://github.com/rust-lang/rust/pull/93056.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/93056", "number": 93056, "state": "closed", "locked": false, "title": "Fix stack overflows when compiling high-`recursion_limit` programs", "user": {"login": "LegionMammal978", "id": 7880963, "node_id": "MDQ6VXNlcjc4ODA5NjM=", "avatar_url": "https://avatars.githubusercontent.com/u/7880963?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LegionMammal978", "html_url": "https://github.com/LegionMammal978", "followers_url": "https://api.github.com/users/LegionMammal978/followers", "following_url": "https://api.github.com/users/LegionMammal978/following{/other_user}", "gists_url": "https://api.github.com/users/LegionMammal978/gists{/gist_id}", "starred_url": "https://api.github.com/users/LegionMammal978/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LegionMammal978/subscriptions", "organizations_url": "https://api.github.com/users/LegionMammal978/orgs", "repos_url": "https://api.github.com/users/LegionMammal978/repos", "events_url": "https://api.github.com/users/LegionMammal978/events{/privacy}", "received_events_url": "https://api.github.com/users/LegionMammal978/received_events", "type": "User", "site_admin": false}, "body": "This should close #75577; I've added `ensure_sufficient_stack` to all of the recursive paths used by the original dumb program, as well as more I've found while testing trivial variations. (Some of the variations are listed in [my comment](https://github.com/rust-lang/rust/issues/75577#issuecomment-888731966) there.) However, there are a few problems left with these fixes.\r\n\r\n1. While I tried to avoid modifying indentation of large blocks, this was not possible for all functions. In its current state, upstream changes are causing frequent merge conflicts with the modified functions. There might be no solution to this. It would be nice to have something like an `#[ensure_sufficient_stack]` attribute on functions that wraps their entire body, but rustc currently only seems to be using proc macros for deriving traits.\r\n2. The final commit is extremely unpolished; I mainly wanted to have it work at all. The `llvm::Verifier` class (defined in `src/llvm-project/llvm/lib/IR/Verifier.cpp`) finds all references to metadata nodes (mostly debuginfo) in the LLVM module, then traverses them in a recursive function. Fixing stack overflows here is necessary for all of the variations involving deeply nested types. Since the function is written in C++, I can't simply insert `ensure_sufficient_stack`; the only option is to allocate the entire additional stack space ahead of time. However, to do that, the compiler must compute the depth of the metadata node graph (which can contain loops), and then pass that down to the backend in the codegen thread for the module. There are several ways to achieve the first:\r\n    - Each time a possibly recursive metadata node is created, calculate its depth from its operands, and store that in a `HashMap` somewhere. This is what my commit does; I added a call to every invocation of a `DIBuilder` method.\r\n    - Instead of passing around raw `llvm::DIWhatever` references, always pass `(llvm::DIWhatever, usize)` pairs with the depth of the node and its operands.\r\n    - Use LLVM's APIs to traverse the entire `llvm::Module` after the fact to compute the depth. This would effectively involve replicating all of `Verifier.cpp`.\r\n    - Determine exactly what kinds of metadata the compiler generates, including which parts are recursive. Use known information about the crate's types and other items to derive the depth of the metadata generated from it.\r\n    - Use some multiple of the `recursion_limit`. This is the simplest possible solution, but it creates lots of memory overhead when the limit is not reached and would likely cause issues in currently existing crates.\r\n\r\n    After that, there's the issue of collecting the data and passing it to the backend. In my commit, I add a `RefCell<FxHashMap<&'ll llvm::Metadata, usize>>` to the `CrateDebugContext` (as well as a method to add to it), and a static `Mutex<FxHashMap<usize, usize>>` to associate `llvm::Module` pointers to their maximum depths. I'm not familiar with the compiler, and I simply have no idea how to idiomatically pass anything but the `llvm::Module` itself to the backend. Overall, I could really use some advice on this part of the fix.\r\n3. There are undoubtedly many recursive paths which my limited testing has not revealed. Eliminating all stack overflows would require inspecting the entire call graph of the compiler, including its backends. I recall seeing a couple tools offering call graph generation for regular crates, but I doubt they'd work well with rustc's custom build system.", "created_at": "2022-01-19T00:46:45Z", "updated_at": "2022-09-11T05:33:35Z", "closed_at": "2022-09-11T05:33:33Z", "merged_at": null, "merge_commit_sha": "acc517802473d1d92a6be91fd5c2387d0a489547", "assignee": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 583436937, "node_id": "MDU6TGFiZWw1ODM0MzY5Mzc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-author", "name": "S-waiting-on-author", "color": "d3dddd", "default": false, "description": "Status: This is awaiting some action (such as code changes or more information) from the author."}, {"id": 627350354, "node_id": "MDU6TGFiZWw2MjczNTAzNTQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-inactive", "name": "S-inactive", "color": "d3dddd", "default": false, "description": "Status: Inactive and waiting on the author. This is often applied to closed PRs."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/93056/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/93056/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/93056/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/a68b8947f8d0762f77362a4fc8c144b38e8751fb", "head": {"label": "LegionMammal978:fix-stack-overflows", "ref": "fix-stack-overflows", "sha": "a68b8947f8d0762f77362a4fc8c144b38e8751fb", "user": {"login": "LegionMammal978", "id": 7880963, "node_id": "MDQ6VXNlcjc4ODA5NjM=", "avatar_url": "https://avatars.githubusercontent.com/u/7880963?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LegionMammal978", "html_url": "https://github.com/LegionMammal978", "followers_url": "https://api.github.com/users/LegionMammal978/followers", "following_url": "https://api.github.com/users/LegionMammal978/following{/other_user}", "gists_url": "https://api.github.com/users/LegionMammal978/gists{/gist_id}", "starred_url": "https://api.github.com/users/LegionMammal978/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LegionMammal978/subscriptions", "organizations_url": "https://api.github.com/users/LegionMammal978/orgs", "repos_url": "https://api.github.com/users/LegionMammal978/repos", "events_url": "https://api.github.com/users/LegionMammal978/events{/privacy}", "received_events_url": "https://api.github.com/users/LegionMammal978/received_events", "type": "User", "site_admin": false}, "repo": {"id": 438034793, "node_id": "R_kgDOGhvhaQ", "name": "rust", "full_name": "LegionMammal978/rust", "private": false, "owner": {"login": "LegionMammal978", "id": 7880963, "node_id": "MDQ6VXNlcjc4ODA5NjM=", "avatar_url": "https://avatars.githubusercontent.com/u/7880963?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LegionMammal978", "html_url": "https://github.com/LegionMammal978", "followers_url": "https://api.github.com/users/LegionMammal978/followers", "following_url": "https://api.github.com/users/LegionMammal978/following{/other_user}", "gists_url": "https://api.github.com/users/LegionMammal978/gists{/gist_id}", "starred_url": "https://api.github.com/users/LegionMammal978/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LegionMammal978/subscriptions", "organizations_url": "https://api.github.com/users/LegionMammal978/orgs", "repos_url": "https://api.github.com/users/LegionMammal978/repos", "events_url": "https://api.github.com/users/LegionMammal978/events{/privacy}", "received_events_url": "https://api.github.com/users/LegionMammal978/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/LegionMammal978/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/LegionMammal978/rust", "forks_url": "https://api.github.com/repos/LegionMammal978/rust/forks", "keys_url": "https://api.github.com/repos/LegionMammal978/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/LegionMammal978/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/LegionMammal978/rust/teams", "hooks_url": "https://api.github.com/repos/LegionMammal978/rust/hooks", "issue_events_url": "https://api.github.com/repos/LegionMammal978/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/LegionMammal978/rust/events", "assignees_url": "https://api.github.com/repos/LegionMammal978/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/LegionMammal978/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/LegionMammal978/rust/tags", "blobs_url": "https://api.github.com/repos/LegionMammal978/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/LegionMammal978/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/LegionMammal978/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/LegionMammal978/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/LegionMammal978/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/LegionMammal978/rust/languages", "stargazers_url": "https://api.github.com/repos/LegionMammal978/rust/stargazers", "contributors_url": "https://api.github.com/repos/LegionMammal978/rust/contributors", "subscribers_url": "https://api.github.com/repos/LegionMammal978/rust/subscribers", "subscription_url": "https://api.github.com/repos/LegionMammal978/rust/subscription", "commits_url": "https://api.github.com/repos/LegionMammal978/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/LegionMammal978/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/LegionMammal978/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/LegionMammal978/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/LegionMammal978/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/LegionMammal978/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/LegionMammal978/rust/merges", "archive_url": "https://api.github.com/repos/LegionMammal978/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/LegionMammal978/rust/downloads", "issues_url": "https://api.github.com/repos/LegionMammal978/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/LegionMammal978/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/LegionMammal978/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/LegionMammal978/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/LegionMammal978/rust/labels{/name}", "releases_url": "https://api.github.com/repos/LegionMammal978/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/LegionMammal978/rust/deployments", "created_at": "2021-12-13T21:48:01Z", "updated_at": "2022-01-09T13:43:12Z", "pushed_at": "2023-05-15T18:31:07Z", "git_url": "git://github.com/LegionMammal978/rust.git", "ssh_url": "git@github.com:LegionMammal978/rust.git", "clone_url": "https://github.com/LegionMammal978/rust.git", "svn_url": "https://github.com/LegionMammal978/rust", "homepage": "https://www.rust-lang.org", "size": 918897, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "c95346b8ac8f10927b4aec31e61d45c75b10ba74", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T13:19:04Z", "pushed_at": "2023-06-19T12:54:45Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 920473, "stargazers_count": 82747, "watchers_count": 82747, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9632, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9632, "watchers": 82747, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/93056"}, "html": {"href": "https://github.com/rust-lang/rust/pull/93056"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/93056"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/93056/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/93056/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/93056/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/a68b8947f8d0762f77362a4fc8c144b38e8751fb"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 40, "review_comments": 0, "maintainer_can_modify": false, "commits": 3, "additions": 765, "deletions": 593, "changed_files": 32}