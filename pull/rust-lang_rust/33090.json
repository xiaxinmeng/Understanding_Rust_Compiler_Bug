{"url": "https://api.github.com/repos/rust-lang/rust/pulls/33090", "id": 67012180, "node_id": "MDExOlB1bGxSZXF1ZXN0NjcwMTIxODA=", "html_url": "https://github.com/rust-lang/rust/pull/33090", "diff_url": "https://github.com/rust-lang/rust/pull/33090.diff", "patch_url": "https://github.com/rust-lang/rust/pull/33090.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/33090", "number": 33090, "state": "closed", "locked": false, "title": "Specialize .zip() for efficient slice and slice iteration", "user": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "body": "The idea is to introduce a private trait TrustedRandomAccess and specialize .zip() for random access iterators into a counted loop.\n\nThe implementation in the PR is internal and has no visible effect in the API\n\nWhy a counted loop? To have each slice iterator compile to just a pointer, and both pointers are indexed with the same loop counter value in the generated code. When this succeeds, copying loops are readily recognized and replaced with memcpy and addition loops autovectorize well.\n### TrustedRandomAccess\n\nThe TrustedRandomAccess approach works very well on the surface. Microbenchmarks optimize well, following the ideas above, and that is a dramatic improvement of .zip()'s codegen.\n\n``` rust\n// old zip before this PR: bad, byte-for-byte loop\n// with specialized zip: memcpy\npub fn copy_zip(xs: &[u8], ys: &mut [u8]) {\n    for (a, b) in ys.iter_mut().zip(xs) {\n        *a = *b;\n    }\n}\n\n// old zip before this PR: single addition per iteration\n// with specialized zip: vectorized\npub fn add_zip(xs: &[f32], ys: &mut [f32]) {\n    for (a, b) in ys.iter_mut().zip(xs) { *a += *b; }\n}\n\n\n// old zip before this PR: single addition per iteration\n// with specialized zip: vectorized (!!)\npub fn add_zip3(xs: &[f32], ys: &[f32], zs: &mut [f32]) {\n    for ((a, b), c) in zs.iter_mut().zip(xs).zip(ys) { *a += *b * *c; }\n}\n```\n## Non-null issues\n\nYet in more complex situations, the .zip() loop can still fall back to its old behavior where phantom null checks throw in fake premature end of the loop conditionals. Remember that a NULL inside\nOption<(&T, &T)> makes it a `None` value and a premature (in this case)\nend of the loop.\n\nSo even if we have 1) an explicit `Some` in the code and 2) the types of the pointers are `&T` or `&mut T` which are nonnull, we can still get a phantom null check at that point.\n\nOne example that illustrates the difference is `copy_zip` with slice versus Vec arguments. The involved iterator types are exactly the same, but the Vec version doesn't compile down to memcpy. Investigating into this, the function argument metadata emitted to llvm plays the biggest role. As eddyb summarized, we need nonnull for the loop to autovectorize and noalias for it to replace with memcpy.\n\nThere was an experiment to use `assume` to add a non-null assumption on each of the two elements in the specialized zip iterator, but this only helped in some of the test cases and regressed others. Instead I think the nonnull/noalias metadata issue is something we need to solve separately anyway.\n### Adaptors\n\nThese have conditionally implemented TrustedRandomAccess\n- Enumerate\n- Zip\n\nThese have not implemented it\n- Map is sideeffectful. The forward case would be workable, but the double ended case is complicated.\n- Chain, exact length semantics unclear\n- Filter, FilterMap, FlatMap and many others don't offer random access and/or exact length\n", "created_at": "2016-04-19T12:48:37Z", "updated_at": "2016-09-16T20:50:38Z", "closed_at": "2016-06-17T14:58:34Z", "merged_at": "2016-06-17T14:58:34Z", "merge_commit_sha": "5df05c6e221b718e82c87003e8b078a9cdbefb70", "assignee": {"login": "aturon", "id": 709807, "node_id": "MDQ6VXNlcjcwOTgwNw==", "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aturon", "html_url": "https://github.com/aturon", "followers_url": "https://api.github.com/users/aturon/followers", "following_url": "https://api.github.com/users/aturon/following{/other_user}", "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}", "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aturon/subscriptions", "organizations_url": "https://api.github.com/users/aturon/orgs", "repos_url": "https://api.github.com/users/aturon/repos", "events_url": "https://api.github.com/users/aturon/events{/privacy}", "received_events_url": "https://api.github.com/users/aturon/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "aturon", "id": 709807, "node_id": "MDQ6VXNlcjcwOTgwNw==", "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aturon", "html_url": "https://github.com/aturon", "followers_url": "https://api.github.com/users/aturon/followers", "following_url": "https://api.github.com/users/aturon/following{/other_user}", "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}", "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aturon/subscriptions", "organizations_url": "https://api.github.com/users/aturon/orgs", "repos_url": "https://api.github.com/users/aturon/repos", "events_url": "https://api.github.com/users/aturon/events{/privacy}", "received_events_url": "https://api.github.com/users/aturon/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/33090/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/33090/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/33090/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/5df05c6e221b718e82c87003e8b078a9cdbefb70", "head": {"label": "bluss:special-zip-2", "ref": "special-zip-2", "sha": "5df05c6e221b718e82c87003e8b078a9cdbefb70", "user": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "repo": {"id": 27685739, "node_id": "MDEwOlJlcG9zaXRvcnkyNzY4NTczOQ==", "name": "rust", "full_name": "bluss/rust", "private": false, "owner": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/bluss/rust", "description": "a safe, concurrent, practical language", "fork": true, "url": "https://api.github.com/repos/bluss/rust", "forks_url": "https://api.github.com/repos/bluss/rust/forks", "keys_url": "https://api.github.com/repos/bluss/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/bluss/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/bluss/rust/teams", "hooks_url": "https://api.github.com/repos/bluss/rust/hooks", "issue_events_url": "https://api.github.com/repos/bluss/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/bluss/rust/events", "assignees_url": "https://api.github.com/repos/bluss/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/bluss/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/bluss/rust/tags", "blobs_url": "https://api.github.com/repos/bluss/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/bluss/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/bluss/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/bluss/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/bluss/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/bluss/rust/languages", "stargazers_url": "https://api.github.com/repos/bluss/rust/stargazers", "contributors_url": "https://api.github.com/repos/bluss/rust/contributors", "subscribers_url": "https://api.github.com/repos/bluss/rust/subscribers", "subscription_url": "https://api.github.com/repos/bluss/rust/subscription", "commits_url": "https://api.github.com/repos/bluss/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/bluss/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/bluss/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/bluss/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/bluss/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/bluss/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/bluss/rust/merges", "archive_url": "https://api.github.com/repos/bluss/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/bluss/rust/downloads", "issues_url": "https://api.github.com/repos/bluss/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/bluss/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/bluss/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/bluss/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/bluss/rust/labels{/name}", "releases_url": "https://api.github.com/repos/bluss/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/bluss/rust/deployments", "created_at": "2014-12-07T21:37:14Z", "updated_at": "2016-01-20T17:47:49Z", "pushed_at": "2020-05-01T06:24:50Z", "git_url": "git://github.com/bluss/rust.git", "ssh_url": "git@github.com:bluss/rust.git", "clone_url": "https://github.com/bluss/rust.git", "svn_url": "https://github.com/bluss/rust", "homepage": "http://www.rust-lang.org", "size": 342065, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "2940eb54bd805dfe45fbf3313688246427eccbc8", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T08:03:04Z", "pushed_at": "2023-06-19T08:09:46Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 919635, "stargazers_count": 82739, "watchers_count": 82739, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10954, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9628, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10954, "open_issues": 9628, "watchers": 82739, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/33090"}, "html": {"href": "https://github.com/rust-lang/rust/pull/33090"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/33090"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/33090/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/33090/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/33090/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/5df05c6e221b718e82c87003e8b078a9cdbefb70"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "comments": 38, "review_comments": 0, "maintainer_can_modify": false, "commits": 8, "additions": 263, "deletions": 21, "changed_files": 7}