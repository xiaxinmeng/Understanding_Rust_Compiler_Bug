{"url": "https://api.github.com/repos/rust-lang/rust/pulls/12029", "id": 12189601, "node_id": "MDExOlB1bGxSZXF1ZXN0MTIxODk2MDE=", "html_url": "https://github.com/rust-lang/rust/pull/12029", "diff_url": "https://github.com/rust-lang/rust/pull/12029.diff", "patch_url": "https://github.com/rust-lang/rust/pull/12029.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/12029", "number": 12029, "state": "closed", "locked": false, "title": "Reduced allocations in merge_sort for short vectors", "user": {"login": "zkamsler", "id": 944662, "node_id": "MDQ6VXNlcjk0NDY2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/944662?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zkamsler", "html_url": "https://github.com/zkamsler", "followers_url": "https://api.github.com/users/zkamsler/followers", "following_url": "https://api.github.com/users/zkamsler/following{/other_user}", "gists_url": "https://api.github.com/users/zkamsler/gists{/gist_id}", "starred_url": "https://api.github.com/users/zkamsler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zkamsler/subscriptions", "organizations_url": "https://api.github.com/users/zkamsler/orgs", "repos_url": "https://api.github.com/users/zkamsler/repos", "events_url": "https://api.github.com/users/zkamsler/events{/privacy}", "received_events_url": "https://api.github.com/users/zkamsler/received_events", "type": "User", "site_admin": false}, "body": "This pull request:\n1) Changes the initial insertion sort to be in-place, and defers allocation of working set until merge is needed.\n2) Increases the increases the maximum run length to use insertion sort for from 8 to 32 elements. This increases the size of vectors that will not allocate, and reduces the number of merge passes by two. It seemed to be the sweet spot in the benchmarks that I ran.\n\nHere are the results of some benchmarks. Note that they are sorting u64s, so types that are more expensive to compare or copy may have different behaviors.\nBefore changes:\n\n```\ntest vec::bench::sort_random_large      bench:    719753 ns/iter (+/- 130173) = 111 MB/s\ntest vec::bench::sort_random_medium     bench:      4726 ns/iter (+/- 742) = 169 MB/s\ntest vec::bench::sort_random_small      bench:       344 ns/iter (+/- 76) = 116 MB/s\ntest vec::bench::sort_sorted            bench:    437244 ns/iter (+/- 70043) = 182 MB/s\n```\n\nDeferred allocation (8 element insertion sort):\n\n```\ntest vec::bench::sort_random_large      bench:    702630 ns/iter (+/- 88158) = 113 MB/s\ntest vec::bench::sort_random_medium     bench:      4529 ns/iter (+/- 497) = 176 MB/s\ntest vec::bench::sort_random_small      bench:       185 ns/iter (+/- 49) = 216 MB/s\ntest vec::bench::sort_sorted            bench:    425853 ns/iter (+/- 60907) = 187 MB/s\n```\n\nDeferred allocation (16 element insertion sort):\n\n```\ntest vec::bench::sort_random_large      bench:    692783 ns/iter (+/- 165837) = 115 MB/s\ntest vec::bench::sort_random_medium     bench:      4434 ns/iter (+/- 722) = 180 MB/s\ntest vec::bench::sort_random_small      bench:       187 ns/iter (+/- 38) = 213 MB/s\ntest vec::bench::sort_sorted            bench:    393783 ns/iter (+/- 85548) = 203 MB/s\n```\n\nDeferred allocation (32 element insertion sort):\n\n```\ntest vec::bench::sort_random_large      bench:    682556 ns/iter (+/- 131008) = 117 MB/s\ntest vec::bench::sort_random_medium     bench:      4370 ns/iter (+/- 1369) = 183 MB/s\ntest vec::bench::sort_random_small      bench:       179 ns/iter (+/- 32) = 223 MB/s\ntest vec::bench::sort_sorted            bench:    358353 ns/iter (+/- 65423) = 223 MB/s\n```\n\nDeferred allocation (64 element insertion sort):\n\n```\ntest vec::bench::sort_random_large      bench:    712040 ns/iter (+/- 132454) = 112 MB/s\ntest vec::bench::sort_random_medium     bench:      4425 ns/iter (+/- 784) = 180 MB/s\ntest vec::bench::sort_random_small      bench:       179 ns/iter (+/- 81) = 223 MB/s\ntest vec::bench::sort_sorted            bench:    317812 ns/iter (+/- 62675) = 251 MB/s\n```\n\nThis is the best I could manage with the basic merge sort while keeping the invariant that the original vector must contain each element exactly once when the comparison function is called. If one is not married to a stable sort, an in-place n*log(n) sorting algorithm may have better performance in some cases.\n\nfor #12011\ncc @huonw\n", "created_at": "2014-02-04T18:22:52Z", "updated_at": "2014-06-23T12:58:45Z", "closed_at": "2014-02-07T23:31:31Z", "merged_at": "2014-02-07T23:31:33Z", "merge_commit_sha": "ec31d21c91ed8ac143592d4fad4bfaf7ec84b575", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/12029/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/12029/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/12029/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/cebe5e8e6baecd448f810f5960daab10fa2d089c", "head": {"label": "zkamsler:merge-sort-allocations", "ref": "merge-sort-allocations", "sha": "cebe5e8e6baecd448f810f5960daab10fa2d089c", "user": {"login": "zkamsler", "id": 944662, "node_id": "MDQ6VXNlcjk0NDY2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/944662?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zkamsler", "html_url": "https://github.com/zkamsler", "followers_url": "https://api.github.com/users/zkamsler/followers", "following_url": "https://api.github.com/users/zkamsler/following{/other_user}", "gists_url": "https://api.github.com/users/zkamsler/gists{/gist_id}", "starred_url": "https://api.github.com/users/zkamsler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zkamsler/subscriptions", "organizations_url": "https://api.github.com/users/zkamsler/orgs", "repos_url": "https://api.github.com/users/zkamsler/repos", "events_url": "https://api.github.com/users/zkamsler/events{/privacy}", "received_events_url": "https://api.github.com/users/zkamsler/received_events", "type": "User", "site_admin": false}, "repo": {"id": 14347203, "node_id": "MDEwOlJlcG9zaXRvcnkxNDM0NzIwMw==", "name": "rust", "full_name": "zkamsler/rust", "private": false, "owner": {"login": "zkamsler", "id": 944662, "node_id": "MDQ6VXNlcjk0NDY2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/944662?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zkamsler", "html_url": "https://github.com/zkamsler", "followers_url": "https://api.github.com/users/zkamsler/followers", "following_url": "https://api.github.com/users/zkamsler/following{/other_user}", "gists_url": "https://api.github.com/users/zkamsler/gists{/gist_id}", "starred_url": "https://api.github.com/users/zkamsler/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zkamsler/subscriptions", "organizations_url": "https://api.github.com/users/zkamsler/orgs", "repos_url": "https://api.github.com/users/zkamsler/repos", "events_url": "https://api.github.com/users/zkamsler/events{/privacy}", "received_events_url": "https://api.github.com/users/zkamsler/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/zkamsler/rust", "description": "a safe, concurrent, practical language", "fork": true, "url": "https://api.github.com/repos/zkamsler/rust", "forks_url": "https://api.github.com/repos/zkamsler/rust/forks", "keys_url": "https://api.github.com/repos/zkamsler/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/zkamsler/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/zkamsler/rust/teams", "hooks_url": "https://api.github.com/repos/zkamsler/rust/hooks", "issue_events_url": "https://api.github.com/repos/zkamsler/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/zkamsler/rust/events", "assignees_url": "https://api.github.com/repos/zkamsler/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/zkamsler/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/zkamsler/rust/tags", "blobs_url": "https://api.github.com/repos/zkamsler/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/zkamsler/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/zkamsler/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/zkamsler/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/zkamsler/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/zkamsler/rust/languages", "stargazers_url": "https://api.github.com/repos/zkamsler/rust/stargazers", "contributors_url": "https://api.github.com/repos/zkamsler/rust/contributors", "subscribers_url": "https://api.github.com/repos/zkamsler/rust/subscribers", "subscription_url": "https://api.github.com/repos/zkamsler/rust/subscription", "commits_url": "https://api.github.com/repos/zkamsler/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/zkamsler/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/zkamsler/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/zkamsler/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/zkamsler/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/zkamsler/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/zkamsler/rust/merges", "archive_url": "https://api.github.com/repos/zkamsler/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/zkamsler/rust/downloads", "issues_url": "https://api.github.com/repos/zkamsler/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/zkamsler/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/zkamsler/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/zkamsler/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/zkamsler/rust/labels{/name}", "releases_url": "https://api.github.com/repos/zkamsler/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/zkamsler/rust/deployments", "created_at": "2013-11-12T22:35:11Z", "updated_at": "2014-02-07T23:31:31Z", "pushed_at": "2014-02-07T22:12:36Z", "git_url": "git://github.com/zkamsler/rust.git", "ssh_url": "git@github.com:zkamsler/rust.git", "clone_url": "https://github.com/zkamsler/rust.git", "svn_url": "https://github.com/zkamsler/rust", "homepage": "http://www.rust-lang.org", "size": 88705, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "7d7a060f8d95ee43406560e69a12631e52c617a7", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T10:22:09Z", "pushed_at": "2023-06-19T11:44:46Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 920473, "stargazers_count": 82742, "watchers_count": 82742, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9630, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9630, "watchers": 82742, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/12029"}, "html": {"href": "https://github.com/rust-lang/rust/pull/12029"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/12029"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/12029/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/12029/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/12029/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/cebe5e8e6baecd448f810f5960daab10fa2d089c"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "comments": 10, "review_comments": 7, "maintainer_can_modify": false, "commits": 1, "additions": 104, "deletions": 5, "changed_files": 1}