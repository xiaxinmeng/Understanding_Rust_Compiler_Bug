{"url": "https://api.github.com/repos/rust-lang/rust/pulls/40561", "id": 110957398, "node_id": "MDExOlB1bGxSZXF1ZXN0MTEwOTU3Mzk4", "html_url": "https://github.com/rust-lang/rust/pull/40561", "diff_url": "https://github.com/rust-lang/rust/pull/40561.diff", "patch_url": "https://github.com/rust-lang/rust/pull/40561.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/40561", "number": 40561, "state": "closed", "locked": false, "title": "Simplify HashMap Bucket interface", "user": {"login": "arthurprs", "id": 715958, "node_id": "MDQ6VXNlcjcxNTk1OA==", "avatar_url": "https://avatars.githubusercontent.com/u/715958?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arthurprs", "html_url": "https://github.com/arthurprs", "followers_url": "https://api.github.com/users/arthurprs/followers", "following_url": "https://api.github.com/users/arthurprs/following{/other_user}", "gists_url": "https://api.github.com/users/arthurprs/gists{/gist_id}", "starred_url": "https://api.github.com/users/arthurprs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arthurprs/subscriptions", "organizations_url": "https://api.github.com/users/arthurprs/orgs", "repos_url": "https://api.github.com/users/arthurprs/repos", "events_url": "https://api.github.com/users/arthurprs/events{/privacy}", "received_events_url": "https://api.github.com/users/arthurprs/received_events", "type": "User", "site_admin": false}, "body": "> Simplify HashMap Bucket interface\r\n> \r\n> * Store capacity_mask instead of capacity\r\n> * Move bucket index into RawBucket\r\n> * Valid bucket index is now always within [0..table_capacity)\r\n> * Simplify iterators by moving logic into RawBuckets\r\n> * Clone RawTable using RawBucket\r\n> * Make retain aware of the number of elements\r\n\r\nThe idea was to put idx in RawBucket instead of the other Bucket types and simplify next() and prev() as much as possible. The rest was a side-effect of that change, except maybe the last 2.\r\n\r\nThis change makes iteration and other next/prev() heavy operations noticeably faster. Clone is way faster.\r\n\r\n```\r\n\u279c  hashmap2 git:(adapt) \u2717 cargo benchcmp pre:: adp:: bench.txt \r\n name                        pre:: ns/iter  adp:: ns/iter  diff ns/iter   diff % \r\n clone_10_000                74,364         39,736              -34,628  -46.57% \r\n grow_100_000                8,343,553      8,233,785          -109,768   -1.32% \r\n grow_10_000                 817,825        723,958             -93,867  -11.48% \r\n grow_big_value_100_000      18,418,979     17,906,186         -512,793   -2.78% \r\n grow_big_value_10_000       1,219,242      1,103,334          -115,908   -9.51% \r\n insert_1000                 74,546         58,343              -16,203  -21.74% \r\n insert_100_000              6,743,770      6,238,017          -505,753   -7.50% \r\n insert_10_000               798,079        719,123             -78,956   -9.89% \r\n insert_1_000_000            275,215,605    266,975,875      -8,239,730   -2.99% \r\n insert_int_bigvalue_10_000  1,517,387      1,419,838           -97,549   -6.43% \r\n insert_str_10_000           316,179        278,896             -37,283  -11.79% \r\n insert_string_10_000        770,927        747,449             -23,478   -3.05% \r\n iter_keys_100_000           386,099        333,104             -52,995  -13.73% \r\n iterate_100_000             387,320        355,707             -31,613   -8.16% \r\n lookup_100_000              206,757        193,063             -13,694   -6.62% \r\n lookup_100_000_unif         219,366        193,180             -26,186  -11.94% \r\n lookup_1_000_000            206,456        205,716                -740   -0.36% \r\n lookup_1_000_000_unif       659,934        629,659             -30,275   -4.59% \r\n lru_sim                     20,194,334     18,442,149       -1,752,185   -8.68% \r\n merge_shuffle               1,168,044      1,063,055          -104,989   -8.99%\r\n```\r\n\r\nNote 2: I may have messed up porting the diff, let's see what CI says.", "created_at": "2017-03-15T22:37:10Z", "updated_at": "2017-04-06T03:20:20Z", "closed_at": "2017-04-06T03:20:20Z", "merged_at": "2017-04-06T03:20:20Z", "merge_commit_sha": "f07ebd609796226e672737e502525fbbf5e27940", "assignee": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/40561/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/40561/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/40561/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/f07ebd609796226e672737e502525fbbf5e27940", "head": {"label": "arthurprs:hm-adapt2", "ref": "hm-adapt2", "sha": "f07ebd609796226e672737e502525fbbf5e27940", "user": {"login": "arthurprs", "id": 715958, "node_id": "MDQ6VXNlcjcxNTk1OA==", "avatar_url": "https://avatars.githubusercontent.com/u/715958?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arthurprs", "html_url": "https://github.com/arthurprs", "followers_url": "https://api.github.com/users/arthurprs/followers", "following_url": "https://api.github.com/users/arthurprs/following{/other_user}", "gists_url": "https://api.github.com/users/arthurprs/gists{/gist_id}", "starred_url": "https://api.github.com/users/arthurprs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arthurprs/subscriptions", "organizations_url": "https://api.github.com/users/arthurprs/orgs", "repos_url": "https://api.github.com/users/arthurprs/repos", "events_url": "https://api.github.com/users/arthurprs/events{/privacy}", "received_events_url": "https://api.github.com/users/arthurprs/received_events", "type": "User", "site_admin": false}, "repo": {"id": 39269609, "node_id": "MDEwOlJlcG9zaXRvcnkzOTI2OTYwOQ==", "name": "rust", "full_name": "arthurprs/rust", "private": false, "owner": {"login": "arthurprs", "id": 715958, "node_id": "MDQ6VXNlcjcxNTk1OA==", "avatar_url": "https://avatars.githubusercontent.com/u/715958?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arthurprs", "html_url": "https://github.com/arthurprs", "followers_url": "https://api.github.com/users/arthurprs/followers", "following_url": "https://api.github.com/users/arthurprs/following{/other_user}", "gists_url": "https://api.github.com/users/arthurprs/gists{/gist_id}", "starred_url": "https://api.github.com/users/arthurprs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arthurprs/subscriptions", "organizations_url": "https://api.github.com/users/arthurprs/orgs", "repos_url": "https://api.github.com/users/arthurprs/repos", "events_url": "https://api.github.com/users/arthurprs/events{/privacy}", "received_events_url": "https://api.github.com/users/arthurprs/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/arthurprs/rust", "description": "A safe, concurrent, practical language.", "fork": true, "url": "https://api.github.com/repos/arthurprs/rust", "forks_url": "https://api.github.com/repos/arthurprs/rust/forks", "keys_url": "https://api.github.com/repos/arthurprs/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/arthurprs/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/arthurprs/rust/teams", "hooks_url": "https://api.github.com/repos/arthurprs/rust/hooks", "issue_events_url": "https://api.github.com/repos/arthurprs/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/arthurprs/rust/events", "assignees_url": "https://api.github.com/repos/arthurprs/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/arthurprs/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/arthurprs/rust/tags", "blobs_url": "https://api.github.com/repos/arthurprs/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/arthurprs/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/arthurprs/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/arthurprs/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/arthurprs/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/arthurprs/rust/languages", "stargazers_url": "https://api.github.com/repos/arthurprs/rust/stargazers", "contributors_url": "https://api.github.com/repos/arthurprs/rust/contributors", "subscribers_url": "https://api.github.com/repos/arthurprs/rust/subscribers", "subscription_url": "https://api.github.com/repos/arthurprs/rust/subscription", "commits_url": "https://api.github.com/repos/arthurprs/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/arthurprs/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/arthurprs/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/arthurprs/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/arthurprs/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/arthurprs/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/arthurprs/rust/merges", "archive_url": "https://api.github.com/repos/arthurprs/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/arthurprs/rust/downloads", "issues_url": "https://api.github.com/repos/arthurprs/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/arthurprs/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/arthurprs/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/arthurprs/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/arthurprs/rust/labels{/name}", "releases_url": "https://api.github.com/repos/arthurprs/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/arthurprs/rust/deployments", "created_at": "2015-07-17T18:36:18Z", "updated_at": "2015-07-17T18:36:36Z", "pushed_at": "2018-01-26T11:49:26Z", "git_url": "git://github.com/arthurprs/rust.git", "ssh_url": "git@github.com:arthurprs/rust.git", "clone_url": "https://github.com/arthurprs/rust.git", "svn_url": "https://github.com/arthurprs/rust", "homepage": "http://www.rust-lang.org", "size": 339752, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "2564711e803f62e04bebf10408cc1c11297c0caf", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T13:54:58Z", "pushed_at": "2023-06-19T13:47:15Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 920473, "stargazers_count": 82748, "watchers_count": 82748, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9631, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9631, "watchers": 82748, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/40561"}, "html": {"href": "https://github.com/rust-lang/rust/pull/40561"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/40561"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/40561/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/40561/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/40561/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/f07ebd609796226e672737e502525fbbf5e27940"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "comments": 19, "review_comments": 14, "maintainer_can_modify": false, "commits": 1, "additions": 165, "deletions": 191, "changed_files": 2}