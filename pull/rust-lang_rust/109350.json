{"url": "https://api.github.com/repos/rust-lang/rust/pulls/109350", "id": 1281669226, "node_id": "PR_kwDOAAsO6M5MZLhq", "html_url": "https://github.com/rust-lang/rust/pull/109350", "diff_url": "https://github.com/rust-lang/rust/pull/109350.diff", "patch_url": "https://github.com/rust-lang/rust/pull/109350.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/109350", "number": 109350, "state": "open", "locked": false, "title": "Add pattern matching API to OsStr", "user": {"login": "mina86", "id": 32383, "node_id": "MDQ6VXNlcjMyMzgz", "avatar_url": "https://avatars.githubusercontent.com/u/32383?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mina86", "html_url": "https://github.com/mina86", "followers_url": "https://api.github.com/users/mina86/followers", "following_url": "https://api.github.com/users/mina86/following{/other_user}", "gists_url": "https://api.github.com/users/mina86/gists{/gist_id}", "starred_url": "https://api.github.com/users/mina86/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mina86/subscriptions", "organizations_url": "https://api.github.com/users/mina86/orgs", "repos_url": "https://api.github.com/users/mina86/repos", "events_url": "https://api.github.com/users/mina86/events{/privacy}", "received_events_url": "https://api.github.com/users/mina86/received_events", "type": "User", "site_admin": false}, "body": "cc @pitaj, @kennytm\r\n\r\nThis is a sizeable patchset so when reviewing looking at individual commits (rather than the whole changeset) is advisable.\r\n\r\nThe motivation for this PR is parsing command line arguments.  It adds {starts,ends}\\_with, strip\\_{prefix,suffix}, {,r}split\\_once and split methods to OsStr supporting char, &str and FnMut(char) -> bool patterns.  (Other methods can be easily added once general consensus for this PR is reached).\r\n\r\nNote that this PR doesn\u2019t implement [RFC 2295] and doesn\u2019t allow OsStr to be a pattern.  This is done because:\r\n\r\n- in **vast** majority of cases this is not necessary,\r\n- OSStr indexing proposed in the RFC is complex to implement and error-prone to use and\r\n- this PR is forwards compatible with the RFC so if someone really needs &OsStr as a pattern it can be added at later time.\r\n\r\nThis PR also sort of implements the new Pattern API.  As I understand it\u2019s no longer a thing, but I\u2019ve decided to keep the change in because it does allow common interface and code sharing.  (Though I have some doubts about the actual interface; for example I question existence of Searcher::next method).  Keep in mind this is just a means to an end so if messing about with core::str::pattern would be a blocker I can undo those changes.\r\n\r\nThe core idea with this PR is introduction of core::str_bytes::Bytes type which handles byte slices which are possibly invalid UTF-8.  str and OsStr are kind of Bytes.  With that, pattern matching has to be implemented only once for Bytes type so that the same matching code doesn\u2019t have to be duplicated for str and OsStr.  Bytes can have Flavours (UTF-8, WTF-8 or unstructured) which allow implementing optimisations based on str being valid UTF-8 or OsStr on Windows being valid WTF-8.\r\n\r\nCommits present in this PR:\r\n\r\n<dl>\r\n<dt>core: convert Pattern<'a> into Pattern<H: Haystack>\r\n<dt>core: move Pattern et al to core::pattern module\r\n<dd>Those two implement the Pattern API and convert str to use it. It\u2019s really mostly just moving code around.\r\n<dt>core: introduce internal core::pattern::{Split,SplitN} types\r\n<dt>core: add core::pattern::EmptyNeedleSearcher internal type\r\n<dd>Those two introduce helper types which help reuse code between str and OsStr implementations.  Split is used in str::split and OsStr::split while EmptyNeedleSearcher is used to handle matching `\"\"` pattern.\r\n<dt>core: add try_next_code_point{,_reverse} internal functions\r\n<dt>core: refactor tests/pattern.rs tests\r\n<dd>Minor refactoring needed for future changes.\r\n<dt>core: add internal core::str_bytes module handling string-like slices\r\n<dt>core: add concept of Flavour to core::str_bytes\r\n<dd>Implements Bytes type as described above and convert str pattern implementations to use it.\r\n<dt>sys: reduce visibility of some internal OsStr-related types\r\n<dd>Honestly I\u2019m a bit confused why this is necessary.\r\n<dt>std: add pattern matching to OsStr\r\n<dd>Implements char and str patterns for OsStr and aforementioned matching methods.  This also includes a demonstration test which shows how command line argument matching can be done with the provided interface.\r\n<dt>core: add core::pattern::Predicate wrapper type\r\n<dt>std: add predicate pattern support to OsStr\r\n<dd>Implements FnMut(char) -> bool pattern for OsStr.  This is done through a separate core::pattern::Predicate type because of orphan rules.  I really don\u2019t like this solution but I couldn\u2019t figure out anything better.\r\n</dl>\r\n\r\nPS. FYI, I have commits which converts core::slice::SlicePattern to the Pattern API implemented in this PR.  Those aren\u2019t included here since they would just distract from the actual changes but if someone is interested they can be found in pattern branch on my fork of the repository.\r\n\r\n[RFC 2295]: https://github.com/rust-lang/rust/issues/49802\r\n", "created_at": "2023-03-19T16:13:12Z", "updated_at": "2023-06-01T02:39:37Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "63f54aa03c9da8ec8dd98bbf97f3293299d0be5c", "assignee": {"login": "joshtriplett", "id": 162737, "node_id": "MDQ6VXNlcjE2MjczNw==", "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshtriplett", "html_url": "https://github.com/joshtriplett", "followers_url": "https://api.github.com/users/joshtriplett/followers", "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}", "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions", "organizations_url": "https://api.github.com/users/joshtriplett/orgs", "repos_url": "https://api.github.com/users/joshtriplett/repos", "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}", "received_events_url": "https://api.github.com/users/joshtriplett/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "joshtriplett", "id": 162737, "node_id": "MDQ6VXNlcjE2MjczNw==", "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshtriplett", "html_url": "https://github.com/joshtriplett", "followers_url": "https://api.github.com/users/joshtriplett/followers", "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}", "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions", "organizations_url": "https://api.github.com/users/joshtriplett/orgs", "repos_url": "https://api.github.com/users/joshtriplett/repos", "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}", "received_events_url": "https://api.github.com/users/joshtriplett/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/109350/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/109350/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/109350/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/e7fe1a23ac81d9306ddbdb622fa61613281ffa8b", "head": {"label": "mina86:pattern-2", "ref": "pattern-2", "sha": "e7fe1a23ac81d9306ddbdb622fa61613281ffa8b", "user": {"login": "mina86", "id": 32383, "node_id": "MDQ6VXNlcjMyMzgz", "avatar_url": "https://avatars.githubusercontent.com/u/32383?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mina86", "html_url": "https://github.com/mina86", "followers_url": "https://api.github.com/users/mina86/followers", "following_url": "https://api.github.com/users/mina86/following{/other_user}", "gists_url": "https://api.github.com/users/mina86/gists{/gist_id}", "starred_url": "https://api.github.com/users/mina86/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mina86/subscriptions", "organizations_url": "https://api.github.com/users/mina86/orgs", "repos_url": "https://api.github.com/users/mina86/repos", "events_url": "https://api.github.com/users/mina86/events{/privacy}", "received_events_url": "https://api.github.com/users/mina86/received_events", "type": "User", "site_admin": false}, "repo": {"id": 366788352, "node_id": "MDEwOlJlcG9zaXRvcnkzNjY3ODgzNTI=", "name": "rust", "full_name": "mina86/rust", "private": false, "owner": {"login": "mina86", "id": 32383, "node_id": "MDQ6VXNlcjMyMzgz", "avatar_url": "https://avatars.githubusercontent.com/u/32383?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mina86", "html_url": "https://github.com/mina86", "followers_url": "https://api.github.com/users/mina86/followers", "following_url": "https://api.github.com/users/mina86/following{/other_user}", "gists_url": "https://api.github.com/users/mina86/gists{/gist_id}", "starred_url": "https://api.github.com/users/mina86/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mina86/subscriptions", "organizations_url": "https://api.github.com/users/mina86/orgs", "repos_url": "https://api.github.com/users/mina86/repos", "events_url": "https://api.github.com/users/mina86/events{/privacy}", "received_events_url": "https://api.github.com/users/mina86/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/mina86/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/mina86/rust", "forks_url": "https://api.github.com/repos/mina86/rust/forks", "keys_url": "https://api.github.com/repos/mina86/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/mina86/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/mina86/rust/teams", "hooks_url": "https://api.github.com/repos/mina86/rust/hooks", "issue_events_url": "https://api.github.com/repos/mina86/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/mina86/rust/events", "assignees_url": "https://api.github.com/repos/mina86/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/mina86/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/mina86/rust/tags", "blobs_url": "https://api.github.com/repos/mina86/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/mina86/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/mina86/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/mina86/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/mina86/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/mina86/rust/languages", "stargazers_url": "https://api.github.com/repos/mina86/rust/stargazers", "contributors_url": "https://api.github.com/repos/mina86/rust/contributors", "subscribers_url": "https://api.github.com/repos/mina86/rust/subscribers", "subscription_url": "https://api.github.com/repos/mina86/rust/subscription", "commits_url": "https://api.github.com/repos/mina86/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/mina86/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/mina86/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/mina86/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/mina86/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/mina86/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/mina86/rust/merges", "archive_url": "https://api.github.com/repos/mina86/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/mina86/rust/downloads", "issues_url": "https://api.github.com/repos/mina86/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/mina86/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/mina86/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/mina86/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/mina86/rust/labels{/name}", "releases_url": "https://api.github.com/repos/mina86/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/mina86/rust/deployments", "created_at": "2021-05-12T16:55:48Z", "updated_at": "2021-05-12T16:55:49Z", "pushed_at": "2023-05-05T20:15:19Z", "git_url": "git://github.com/mina86/rust.git", "ssh_url": "git@github.com:mina86/rust.git", "clone_url": "https://github.com/mina86/rust.git", "svn_url": "https://github.com/mina86/rust", "homepage": "https://www.rust-lang.org", "size": 910600, "stargazers_count": 0, "watchers_count": 0, "language": null, "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "4b94c232192b0fa0314b5afa18e366356e210c4c", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T14:23:45Z", "pushed_at": "2023-06-20T14:36:51Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 931034, "stargazers_count": 82773, "watchers_count": 82773, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10966, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9631, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10966, "open_issues": 9631, "watchers": 82773, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/109350"}, "html": {"href": "https://github.com/rust-lang/rust/pull/109350"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/109350"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/109350/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/109350/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/109350/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/e7fe1a23ac81d9306ddbdb622fa61613281ffa8b"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 22, "review_comments": 0, "maintainer_can_modify": true, "commits": 12, "additions": 6463, "deletions": 1783, "changed_files": 20}