{"url": "https://api.github.com/repos/rust-lang/rust/pulls/100899", "id": 1033563486, "node_id": "PR_kwDOAAsO6M49mu1e", "html_url": "https://github.com/rust-lang/rust/pull/100899", "diff_url": "https://github.com/rust-lang/rust/pull/100899.diff", "patch_url": "https://github.com/rust-lang/rust/pull/100899.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/100899", "number": 100899, "state": "closed", "locked": false, "title": "Discussion: Support for representing `Allocation`s with bytes that aren't owned `Box<[u8]>`", "user": {"login": "emarteca", "id": 4440419, "node_id": "MDQ6VXNlcjQ0NDA0MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/4440419?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emarteca", "html_url": "https://github.com/emarteca", "followers_url": "https://api.github.com/users/emarteca/followers", "following_url": "https://api.github.com/users/emarteca/following{/other_user}", "gists_url": "https://api.github.com/users/emarteca/gists{/gist_id}", "starred_url": "https://api.github.com/users/emarteca/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emarteca/subscriptions", "organizations_url": "https://api.github.com/users/emarteca/orgs", "repos_url": "https://api.github.com/users/emarteca/repos", "events_url": "https://api.github.com/users/emarteca/events{/privacy}", "received_events_url": "https://api.github.com/users/emarteca/received_events", "type": "User", "site_admin": false}, "body": "Support for representing `Allocation`s with bytes that aren't owned `Box<[u8]>` (specifically, for being able to use `Allocation`s to represent pointers to foreign memory).\r\n\r\n**Note**: this PR builds on top of [an earlier PR](https://github.com/rust-lang/rust/pull/100467) which aligns the `bytes` field of `Allocation` so that it is aligned to the `align` parameter specified. We are going to implement [@RalfJung 's suggestion](https://github.com/rust-lang/rust/pull/100467#discussion_r950847697) of parameterizing the `Allocation` on the type of bytes so that the unsafe code in the manual alignment can be kept out of the compiler.\r\n\r\nWe're hoping to get feedback on our approach for supporting references to foreign memory in `Allocation`s with this PR. \r\n\r\n#### Main changes in this PR are to:\r\n* [`allocation.rs`](https://github.com/emarteca/rust/blob/2aabbbea4d8c7c55df16a2d97cab2a5f2242e477/compiler/rustc_middle/src/mir/interpret/allocation.rs), where we add some new data structures to represent this memory (described below)\r\n* adding a new function [`allocate_ptr_raw_addr`](https://github.com/emarteca/rust/blob/2aabbbea4d8c7c55df16a2d97cab2a5f2242e477/compiler/rustc_const_eval/src/interpret/memory.rs#L206) to the `Memory`, so that we can create Allocations referencing foreign memory.\r\n\r\n#### New data structures to represent foreign bytes\r\nThe current structure of `Allocation`s is such that they own their bytes, as a `Box<[u8]>`.  This won\u2019t work for bytes in foreign memory, that are not even owned by the Rust program executing. With this PR, we change the `bytes` field of an `Allocation` to instead be of type `AllocBytes`, which is:\r\n```\r\npub enum AllocBytes {\r\n    /// Owned, boxed slice of [u8].\r\n    Boxed(Box<[u8]>),\r\n    /// Address, size of the type stored, and length of the allocation.\r\n    /// This is used for representing pointers to bytes that belong to a \r\n    /// foreign process (such as pointers into C memory, passed back to Rust\r\n    /// through an FFI call).\r\n    Addr(AddrAllocBytes),\r\n}\r\n```\r\nThe `AllocBytes::Boxed` corresponds to the normal, owned bytes. \r\n\r\n`AddrAllocBytes` is another new type that represents a section of memory, starting at a particular address, and of a specified length. This is how we represent bytes in an `Allocation` that can't be owned, since they belong to a foreign process -- in particular, we are using this to store pointers to C memory passed back from C FFI calls in Miri.\r\n```\r\npub struct AddrAllocBytes {\r\n    /// Address of the beginning of the bytes.\r\n    pub addr: u64,\r\n    /// Size of the type of the data being stored in these bytes.\r\n    pub type_size: usize,\r\n    /// Length of the bytes, in multiples of `type_size`; \r\n    /// it's in a `RefCell` since it can change depending on how it's used\r\n    /// in the program. UNSAFE\r\n    pub len: std::cell::RefCell<usize>,\r\n}\r\n```\r\n\r\n#### Why are we doing this? \r\nWe are working on adding support for the C FFI in Miri, and these changes allow us to represent pointers to C memory in Miri.\r\nThis design is described in [our design doc](https://hackmd.io/eFY7Jyl6QGeGKQlJvBp6pw?view#Passing-pointers-to-C-memory-back-to-Miri).\r\n", "created_at": "2022-08-23T02:29:56Z", "updated_at": "2022-08-26T22:05:20Z", "closed_at": "2022-08-26T22:05:19Z", "merged_at": null, "merge_commit_sha": "147ddad9cfe7d655d4410e26b96df87fe6ec38f9", "assignee": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/100899/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/100899/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/100899/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/2aabbbea4d8c7c55df16a2d97cab2a5f2242e477", "head": {"label": "emarteca:c-pointers", "ref": "c-pointers", "sha": "2aabbbea4d8c7c55df16a2d97cab2a5f2242e477", "user": {"login": "emarteca", "id": 4440419, "node_id": "MDQ6VXNlcjQ0NDA0MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/4440419?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emarteca", "html_url": "https://github.com/emarteca", "followers_url": "https://api.github.com/users/emarteca/followers", "following_url": "https://api.github.com/users/emarteca/following{/other_user}", "gists_url": "https://api.github.com/users/emarteca/gists{/gist_id}", "starred_url": "https://api.github.com/users/emarteca/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emarteca/subscriptions", "organizations_url": "https://api.github.com/users/emarteca/orgs", "repos_url": "https://api.github.com/users/emarteca/repos", "events_url": "https://api.github.com/users/emarteca/events{/privacy}", "received_events_url": "https://api.github.com/users/emarteca/received_events", "type": "User", "site_admin": false}, "repo": {"id": 519292085, "node_id": "R_kgDOHvPEtQ", "name": "rust", "full_name": "emarteca/rust", "private": false, "owner": {"login": "emarteca", "id": 4440419, "node_id": "MDQ6VXNlcjQ0NDA0MTk=", "avatar_url": "https://avatars.githubusercontent.com/u/4440419?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emarteca", "html_url": "https://github.com/emarteca", "followers_url": "https://api.github.com/users/emarteca/followers", "following_url": "https://api.github.com/users/emarteca/following{/other_user}", "gists_url": "https://api.github.com/users/emarteca/gists{/gist_id}", "starred_url": "https://api.github.com/users/emarteca/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emarteca/subscriptions", "organizations_url": "https://api.github.com/users/emarteca/orgs", "repos_url": "https://api.github.com/users/emarteca/repos", "events_url": "https://api.github.com/users/emarteca/events{/privacy}", "received_events_url": "https://api.github.com/users/emarteca/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/emarteca/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/emarteca/rust", "forks_url": "https://api.github.com/repos/emarteca/rust/forks", "keys_url": "https://api.github.com/repos/emarteca/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/emarteca/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/emarteca/rust/teams", "hooks_url": "https://api.github.com/repos/emarteca/rust/hooks", "issue_events_url": "https://api.github.com/repos/emarteca/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/emarteca/rust/events", "assignees_url": "https://api.github.com/repos/emarteca/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/emarteca/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/emarteca/rust/tags", "blobs_url": "https://api.github.com/repos/emarteca/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/emarteca/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/emarteca/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/emarteca/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/emarteca/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/emarteca/rust/languages", "stargazers_url": "https://api.github.com/repos/emarteca/rust/stargazers", "contributors_url": "https://api.github.com/repos/emarteca/rust/contributors", "subscribers_url": "https://api.github.com/repos/emarteca/rust/subscribers", "subscription_url": "https://api.github.com/repos/emarteca/rust/subscription", "commits_url": "https://api.github.com/repos/emarteca/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/emarteca/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/emarteca/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/emarteca/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/emarteca/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/emarteca/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/emarteca/rust/merges", "archive_url": "https://api.github.com/repos/emarteca/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/emarteca/rust/downloads", "issues_url": "https://api.github.com/repos/emarteca/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/emarteca/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/emarteca/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/emarteca/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/emarteca/rust/labels{/name}", "releases_url": "https://api.github.com/repos/emarteca/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/emarteca/rust/deployments", "created_at": "2022-07-29T17:10:31Z", "updated_at": "2022-08-24T20:25:06Z", "pushed_at": "2022-11-09T22:24:17Z", "git_url": "git://github.com/emarteca/rust.git", "ssh_url": "git@github.com:emarteca/rust.git", "clone_url": "https://github.com/emarteca/rust.git", "svn_url": "https://github.com/emarteca/rust", "homepage": "https://www.rust-lang.org", "size": 942583, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "8818b00b634ee48e7617d9beb48c4d7bc6967f06", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T05:47:10Z", "pushed_at": "2023-06-20T05:32:43Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 930404, "stargazers_count": 82764, "watchers_count": 82764, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10964, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9633, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10964, "open_issues": 9633, "watchers": 82764, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/100899"}, "html": {"href": "https://github.com/rust-lang/rust/pull/100899"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/100899"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/100899/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/100899/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/100899/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/2aabbbea4d8c7c55df16a2d97cab2a5f2242e477"}}, "author_association": "NONE", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 6, "review_comments": 0, "maintainer_can_modify": false, "commits": 19, "additions": 242, "deletions": 30, "changed_files": 3}