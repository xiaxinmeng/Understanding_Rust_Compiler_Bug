{"url": "https://api.github.com/repos/rust-lang/rust/pulls/85646", "id": 651649471, "node_id": "MDExOlB1bGxSZXF1ZXN0NjUxNjQ5NDcx", "html_url": "https://github.com/rust-lang/rust/pull/85646", "diff_url": "https://github.com/rust-lang/rust/pull/85646.diff", "patch_url": "https://github.com/rust-lang/rust/pull/85646.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/85646", "number": 85646, "state": "closed", "locked": false, "title": "MIR opt: separate constant predecessors of a switch", "user": {"login": "Moxinilian", "id": 30992420, "node_id": "MDQ6VXNlcjMwOTkyNDIw", "avatar_url": "https://avatars.githubusercontent.com/u/30992420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Moxinilian", "html_url": "https://github.com/Moxinilian", "followers_url": "https://api.github.com/users/Moxinilian/followers", "following_url": "https://api.github.com/users/Moxinilian/following{/other_user}", "gists_url": "https://api.github.com/users/Moxinilian/gists{/gist_id}", "starred_url": "https://api.github.com/users/Moxinilian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Moxinilian/subscriptions", "organizations_url": "https://api.github.com/users/Moxinilian/orgs", "repos_url": "https://api.github.com/users/Moxinilian/repos", "events_url": "https://api.github.com/users/Moxinilian/events{/privacy}", "received_events_url": "https://api.github.com/users/Moxinilian/received_events", "type": "User", "site_admin": false}, "body": "For each block S ending with a switch, this pass copies S for each of S's predecessors that seem to assign the value being switched over as a const. This is done using a somewhat simple heuristic to determine what seems to be a const transitively. \r\n\r\nMore precisely, this is what the pass does:\r\n- find a block that ends in a switch\r\n- track if there is an unique place set before the current basic block that determines the result of the switch (this is the part that resolves switching over discriminants)\r\n- if there is, iterate over the parents that have a reasonable terminator and find if the found determining place is likely to be (transitively) set from a const within that parent block\r\n- if so, add the corresponding edge to a vector of edges to duplicate\r\n- once this is done, iterate over the found edges: copy the target block and replace the reference to the target block in the origin block with the new block\r\n\r\nThis pass is not optimal and could probably duplicate in more cases, but the intention was mostly to address cases like in #85133 or #85365, to avoid creating new enums that get destroyed immediately afterwards (notably making the new try v2 `?` desugar zero-cost).\r\n\r\nA benefit of this pass working the way it does is that it is easy to ensure its correctness: the worst that can happen is for it to needlessly copy a basic block, which is likely to be destroyed by cleanup passes afterwards. The complex parts where aliasing matters are only heuristics and the hard work is left to further passes like ConstProp.\r\n\r\n# LLVM blocker\r\n\r\nUnfortunately, I believe it would be unwise to enable this optimization by default for now. Indeed, currently switch lowering passes like SimplifyCFG in LLVM lose the information on the set of possible variant values, which means it tends to actually generate worse code with this optimization enabled. A fix would have to be done in LLVM itself. This is something I also want to look into. I have opened [a bug report at the LLVM bug tracker](https://bugs.llvm.org/show_bug.cgi?id=50455).\r\n\r\nWhen this is done, I hope we can enable this pass by default. It should be fairly fast and I think it is beneficial in many cases. Notably, it should be a sound alternative to simplify-arm-identity. By the way, ConstProp only seems to pick up the optimization in functions that are not generic. This is however most likely an issue in ConstProp that I will look into afterwards.\r\n\r\nThis is my first contribution to rustc, and I would like to thank everyone on the Zulip mir-opt chat for the help and support, and especially @scottmcm for the guidance.", "created_at": "2021-05-24T21:37:22Z", "updated_at": "2021-07-25T16:18:04Z", "closed_at": "2021-07-25T16:18:01Z", "merged_at": "2021-07-25T16:18:01Z", "merge_commit_sha": "70f74719a92ef52bc28610ba04b7e98ada035ec9", "assignee": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 583437191, "node_id": "MDU6TGFiZWw1ODM0MzcxOTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-bors", "name": "S-waiting-on-bors", "color": "d3dddd", "default": false, "description": "Status: Waiting on bors to run and complete tests. Bors will change the label on completion."}, {"id": 1223998418, "node_id": "MDU6TGFiZWwxMjIzOTk4NDE4", "url": "https://api.github.com/repos/rust-lang/rust/labels/merged-by-bors", "name": "merged-by-bors", "color": "dae4e4", "default": false, "description": "This PR was explicitly merged by bors"}], "milestone": {"url": "https://api.github.com/repos/rust-lang/rust/milestones/85", "html_url": "https://github.com/rust-lang/rust/milestone/85", "labels_url": "https://api.github.com/repos/rust-lang/rust/milestones/85/labels", "id": 7000387, "node_id": "MI_kwDOAAsO6M4AatFD", "number": 85, "title": "1.56.0", "description": "", "creator": {"login": "rustbot", "id": 47979223, "node_id": "MDQ6VXNlcjQ3OTc5MjIz", "avatar_url": "https://avatars.githubusercontent.com/u/47979223?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbot", "html_url": "https://github.com/rustbot", "followers_url": "https://api.github.com/users/rustbot/followers", "following_url": "https://api.github.com/users/rustbot/following{/other_user}", "gists_url": "https://api.github.com/users/rustbot/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbot/subscriptions", "organizations_url": "https://api.github.com/users/rustbot/orgs", "repos_url": "https://api.github.com/users/rustbot/repos", "events_url": "https://api.github.com/users/rustbot/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbot/received_events", "type": "User", "site_admin": false}, "open_issues": 2, "closed_issues": 625, "state": "closed", "created_at": "2021-07-24T07:40:14Z", "updated_at": "2022-04-26T15:23:54Z", "due_on": null, "closed_at": "2021-10-22T02:37:55Z"}, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/85646/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/85646/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/85646/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/a77e2ad5338e0c417dd5c4f5958b8aab526322d6", "head": {"label": "Moxinilian:separate-const-switch", "ref": "separate-const-switch", "sha": "a77e2ad5338e0c417dd5c4f5958b8aab526322d6", "user": {"login": "Moxinilian", "id": 30992420, "node_id": "MDQ6VXNlcjMwOTkyNDIw", "avatar_url": "https://avatars.githubusercontent.com/u/30992420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Moxinilian", "html_url": "https://github.com/Moxinilian", "followers_url": "https://api.github.com/users/Moxinilian/followers", "following_url": "https://api.github.com/users/Moxinilian/following{/other_user}", "gists_url": "https://api.github.com/users/Moxinilian/gists{/gist_id}", "starred_url": "https://api.github.com/users/Moxinilian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Moxinilian/subscriptions", "organizations_url": "https://api.github.com/users/Moxinilian/orgs", "repos_url": "https://api.github.com/users/Moxinilian/repos", "events_url": "https://api.github.com/users/Moxinilian/events{/privacy}", "received_events_url": "https://api.github.com/users/Moxinilian/received_events", "type": "User", "site_admin": false}, "repo": {"id": 366112807, "node_id": "MDEwOlJlcG9zaXRvcnkzNjYxMTI4MDc=", "name": "rust", "full_name": "Moxinilian/rust", "private": false, "owner": {"login": "Moxinilian", "id": 30992420, "node_id": "MDQ6VXNlcjMwOTkyNDIw", "avatar_url": "https://avatars.githubusercontent.com/u/30992420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Moxinilian", "html_url": "https://github.com/Moxinilian", "followers_url": "https://api.github.com/users/Moxinilian/followers", "following_url": "https://api.github.com/users/Moxinilian/following{/other_user}", "gists_url": "https://api.github.com/users/Moxinilian/gists{/gist_id}", "starred_url": "https://api.github.com/users/Moxinilian/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Moxinilian/subscriptions", "organizations_url": "https://api.github.com/users/Moxinilian/orgs", "repos_url": "https://api.github.com/users/Moxinilian/repos", "events_url": "https://api.github.com/users/Moxinilian/events{/privacy}", "received_events_url": "https://api.github.com/users/Moxinilian/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/Moxinilian/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/Moxinilian/rust", "forks_url": "https://api.github.com/repos/Moxinilian/rust/forks", "keys_url": "https://api.github.com/repos/Moxinilian/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/Moxinilian/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/Moxinilian/rust/teams", "hooks_url": "https://api.github.com/repos/Moxinilian/rust/hooks", "issue_events_url": "https://api.github.com/repos/Moxinilian/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/Moxinilian/rust/events", "assignees_url": "https://api.github.com/repos/Moxinilian/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/Moxinilian/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/Moxinilian/rust/tags", "blobs_url": "https://api.github.com/repos/Moxinilian/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/Moxinilian/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/Moxinilian/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/Moxinilian/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/Moxinilian/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/Moxinilian/rust/languages", "stargazers_url": "https://api.github.com/repos/Moxinilian/rust/stargazers", "contributors_url": "https://api.github.com/repos/Moxinilian/rust/contributors", "subscribers_url": "https://api.github.com/repos/Moxinilian/rust/subscribers", "subscription_url": "https://api.github.com/repos/Moxinilian/rust/subscription", "commits_url": "https://api.github.com/repos/Moxinilian/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/Moxinilian/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/Moxinilian/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/Moxinilian/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/Moxinilian/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/Moxinilian/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/Moxinilian/rust/merges", "archive_url": "https://api.github.com/repos/Moxinilian/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/Moxinilian/rust/downloads", "issues_url": "https://api.github.com/repos/Moxinilian/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/Moxinilian/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/Moxinilian/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/Moxinilian/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/Moxinilian/rust/labels{/name}", "releases_url": "https://api.github.com/repos/Moxinilian/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/Moxinilian/rust/deployments", "created_at": "2021-05-10T16:48:54Z", "updated_at": "2021-12-25T19:40:17Z", "pushed_at": "2022-11-17T20:58:27Z", "git_url": "git://github.com/Moxinilian/rust.git", "ssh_url": "git@github.com:Moxinilian/rust.git", "clone_url": "https://github.com/Moxinilian/rust.git", "svn_url": "https://github.com/Moxinilian/rust", "homepage": "https://www.rust-lang.org", "size": 1005225, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "b8be3162d734f3583b240977615f3e1bae6b364a", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T06:07:21Z", "pushed_at": "2023-06-19T06:15:17Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 919635, "stargazers_count": 82734, "watchers_count": 82734, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10953, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9628, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10953, "open_issues": 9628, "watchers": 82734, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/85646"}, "html": {"href": "https://github.com/rust-lang/rust/pull/85646"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/85646"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/85646/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/85646/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/85646/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/a77e2ad5338e0c417dd5c4f5958b8aab526322d6"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "comments": 21, "review_comments": 26, "maintainer_can_modify": false, "commits": 1, "additions": 1055, "deletions": 0, "changed_files": 9}