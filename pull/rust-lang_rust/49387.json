{"url": "https://api.github.com/repos/rust-lang/rust/pulls/49387", "id": 177511510, "node_id": "MDExOlB1bGxSZXF1ZXN0MTc3NTExNTEw", "html_url": "https://github.com/rust-lang/rust/pull/49387", "diff_url": "https://github.com/rust-lang/rust/pull/49387.diff", "patch_url": "https://github.com/rust-lang/rust/pull/49387.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/49387", "number": 49387, "state": "closed", "locked": false, "title": "Implement a sandbox for environment variables and files", "user": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "body": "This PR introduces some simple sandboxing for process environment variables and for include files (collectively \"system environment\").\r\n\r\nThis is primarily to allow a build system to more precisely control the inputs to rustc which may affect the generated output. Rust has two mechanisms by which an input source can access ambient properties of rustc's system environment: `env!()` and `option_env!()` for reading environment variables, and `include!()`/`include_str!()`/`include_bytes!()` for reading arbitrary files.\r\n\r\n(This PR specifically does not intend to address any actual security concerns, since there are many other avenues that it does not attempt to control, such as compiler plugins/proc macros. However, it does help with unintentional problems which could result in later security problems if unaddressed.)\r\n\r\n## Environment Variables\r\n\r\nrustc allows source code to directly access its process environment variables via the `env!()` and `optional_env!()` (pseudo-)macros. This poses a few of problems:\r\n- the build system has no idea what variables the code is using for the purposes of tracking its inputs\r\n- code can read arbitrary contents from arbitrary variables, which may pose unwanted information leakage (from build environment to final deployment environment, for example)\r\n- it combines the environment rustc needs for its own operation (`PATH` and `LD_LIBRARY_PATH`, for example) with environment the compiled code might want, and doesn't allow them to be set independently\r\n\r\nWe introduce the following new command-line options to allow the apparent environment to be controlled at a fine-grain level:\r\n- `--env-clear` - completely empty the logical environment visible to `env!()`/`optional_env!()`, causing them to all fail/return `None`. Without any other options, this will completely disable environment variable access.\r\n- `--env-allow NAME` - allow a specific environment variable to be read from the process environment\r\n- `--env-define NAME=VAL` - define a logical environment variable. This does not need to be present in the actual process environment, or if it is, its value is overridden\r\n\r\nBy default, the environment is completely open, leaving the existing behaviour unchanged. Once one of the options above is specified, accesses to environment variable become controlled accordingly.\r\n\r\n## Paths\r\n\r\nRust allows arbitrary other files to be directly included, either as more Rust source code  (`include!()`), a text string (`include_str!()`) or arbitrary binary data (`include_bytes!()`). These macros take a raw string which is used as a path which may be absolute - they therefore allow any file that rustc has permission to access to be used in the compiled output.\r\n\r\n(This differs from separating a crate into multiple source files, as those files are always relative to the top-level `lib.rs`/`main.rs` source.)\r\n\r\nThis causes a couple of problems:\r\n- the build system can't know or constrain what files are actually inputs to the compiler\r\n- the code can't unintentionally leak state from the build environment to the deployment environment\r\n\r\nTo implement this, we introduce a couple of command-line options: \r\n- `--clear-include-prefixes` - clear all allowable prefixes, effectively disabling all `include*!()` macros\r\n- `--include-prefix PATH` - add `PATH` to the set of valid prefixes. All included paths must match one of the valid path prefixes before it can be opened.\r\n\r\nAll paths are canonicalized before matching, so they must exist at the time they're specified.\r\n\r\nBy default, all path prefixes are valid, leaving the current behaviour unchanged. They are only constrained once one of the options above are specified.\r\n\r\nNote that a \"path prefix\" can be an entire pathname, allowing these options to explicitly specify which individual files may be included.\r\n\r\n## Rustfmt\r\nRustfmt uses the `ParseSess::with_span_handler()` constructor, so I've updated it to use a default (unlimited) sandbox in https://github.com/rust-lang-nursery/rustfmt/pull/2566.", "created_at": "2018-03-26T17:14:02Z", "updated_at": "2021-03-10T16:27:24Z", "closed_at": "2018-07-10T17:28:14Z", "merged_at": null, "merge_commit_sha": "3b71b8bcd37e488915f63d90ac0cb5628014bcc5", "assignee": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 762300676, "node_id": "MDU6TGFiZWw3NjIzMDA2NzY=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-blocked", "name": "S-blocked", "color": "d3dddd", "default": false, "description": "Status: marked as blocked \u274c on something else such as an RFC or other implementation work."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/49387/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/49387/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/49387/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/dc1ed74c3359e57aff255b6eff2fb65553e80d22", "head": {"label": "jsgf:rustc-env-sb", "ref": "rustc-env-sb", "sha": "dc1ed74c3359e57aff255b6eff2fb65553e80d22", "user": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "repo": {"id": 65047958, "node_id": "MDEwOlJlcG9zaXRvcnk2NTA0Nzk1OA==", "name": "rust", "full_name": "jsgf/rust", "private": false, "owner": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/jsgf/rust", "description": "A safe, concurrent, practical language.", "fork": true, "url": "https://api.github.com/repos/jsgf/rust", "forks_url": "https://api.github.com/repos/jsgf/rust/forks", "keys_url": "https://api.github.com/repos/jsgf/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/jsgf/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/jsgf/rust/teams", "hooks_url": "https://api.github.com/repos/jsgf/rust/hooks", "issue_events_url": "https://api.github.com/repos/jsgf/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/jsgf/rust/events", "assignees_url": "https://api.github.com/repos/jsgf/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/jsgf/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/jsgf/rust/tags", "blobs_url": "https://api.github.com/repos/jsgf/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/jsgf/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/jsgf/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/jsgf/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/jsgf/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/jsgf/rust/languages", "stargazers_url": "https://api.github.com/repos/jsgf/rust/stargazers", "contributors_url": "https://api.github.com/repos/jsgf/rust/contributors", "subscribers_url": "https://api.github.com/repos/jsgf/rust/subscribers", "subscription_url": "https://api.github.com/repos/jsgf/rust/subscription", "commits_url": "https://api.github.com/repos/jsgf/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/jsgf/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/jsgf/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/jsgf/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/jsgf/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/jsgf/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/jsgf/rust/merges", "archive_url": "https://api.github.com/repos/jsgf/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/jsgf/rust/downloads", "issues_url": "https://api.github.com/repos/jsgf/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/jsgf/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/jsgf/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/jsgf/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/jsgf/rust/labels{/name}", "releases_url": "https://api.github.com/repos/jsgf/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/jsgf/rust/deployments", "created_at": "2016-08-05T20:46:12Z", "updated_at": "2022-04-17T02:30:08Z", "pushed_at": "2023-02-22T18:35:27Z", "git_url": "git://github.com/jsgf/rust.git", "ssh_url": "git@github.com:jsgf/rust.git", "clone_url": "https://github.com/jsgf/rust.git", "svn_url": "https://github.com/jsgf/rust", "homepage": "https://www.rust-lang.org", "size": 1066318, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "6eb4f1d03601d262f4a10fd350d9d31fb27a2d94", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T05:25:49Z", "pushed_at": "2023-06-20T05:32:43Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 930404, "stargazers_count": 82763, "watchers_count": 82763, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10964, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9633, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10964, "open_issues": 9633, "watchers": 82763, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/49387"}, "html": {"href": "https://github.com/rust-lang/rust/pull/49387"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/49387"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/49387/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/49387/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/49387/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/dc1ed74c3359e57aff255b6eff2fb65553e80d22"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 15, "review_comments": 0, "maintainer_can_modify": false, "commits": 6, "additions": 498, "deletions": 15, "changed_files": 22}