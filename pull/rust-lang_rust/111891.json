{"url": "https://api.github.com/repos/rust-lang/rust/pulls/111891", "id": 1362137626, "node_id": "PR_kwDOAAsO6M5RMJIa", "html_url": "https://github.com/rust-lang/rust/pull/111891", "diff_url": "https://github.com/rust-lang/rust/pull/111891.diff", "patch_url": "https://github.com/rust-lang/rust/pull/111891.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/111891", "number": 111891, "state": "open", "locked": false, "title": "feat: `riscv-interrupt-{m,s}` calling conventions", "user": {"login": "sethp", "id": 241129, "node_id": "MDQ6VXNlcjI0MTEyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/241129?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sethp", "html_url": "https://github.com/sethp", "followers_url": "https://api.github.com/users/sethp/followers", "following_url": "https://api.github.com/users/sethp/following{/other_user}", "gists_url": "https://api.github.com/users/sethp/gists{/gist_id}", "starred_url": "https://api.github.com/users/sethp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sethp/subscriptions", "organizations_url": "https://api.github.com/users/sethp/orgs", "repos_url": "https://api.github.com/users/sethp/repos", "events_url": "https://api.github.com/users/sethp/events{/privacy}", "received_events_url": "https://api.github.com/users/sethp/received_events", "type": "User", "site_admin": false}, "body": "Similar to prior support added for the mips430, avr, and x86 targets this change implements the rough equivalent of clang's [`__attribute__((interrupt))`][clang-attr] for riscv targets, enabling e.g.\r\n\r\n```rust\r\nstatic mut CNT: usize = 0;\r\n\r\npub extern \"riscv-interrupt-m\" fn isr_m() {\r\n    unsafe {\r\n        CNT += 1;\r\n    }\r\n}\r\n```\r\n\r\nto produce highly effective assembly like:\r\n\r\n```asm\r\npub extern \"riscv-interrupt-m\" fn isr_m() {\r\n420003a0:       1141                    addi    sp,sp,-16\r\n    unsafe {\r\n        CNT += 1;\r\n420003a2:       c62a                    sw      a0,12(sp)\r\n420003a4:       c42e                    sw      a1,8(sp)\r\n420003a6:       3fc80537                lui     a0,0x3fc80\r\n420003aa:       63c52583                lw      a1,1596(a0) # 3fc8063c <_ZN12esp_riscv_rt3CNT17hcec3e3a214887d53E.0>\r\n420003ae:       0585                    addi    a1,a1,1\r\n420003b0:       62b52e23                sw      a1,1596(a0)\r\n    }\r\n}\r\n420003b4:       4532                    lw      a0,12(sp)\r\n420003b6:       45a2                    lw      a1,8(sp)\r\n420003b8:       0141                    addi    sp,sp,16\r\n420003ba:       30200073                mret\r\n```\r\n\r\n(disassembly via `riscv64-unknown-elf-objdump -C -S --disassemble ./esp32c3-hal/target/riscv32imc-unknown-none-elf/release/examples/gpio_interrupt`)\r\n\r\nThis outcome is superior to hand-coded interrupt routines which, lacking visibility into any non-assembly body of the interrupt handler, have to be very conservative and save the [entire CPU state to the stack frame][full-frame-save]. By instead asking LLVM to only save the registers that it uses, we defer the decision to the tool with the best context: it can more accurately account for the cost of spills if it knows that every additional register used is already at the cost of an implicit spill.\r\n\r\nAt the LLVM level, this is apparently [implemented by] marking every register as \"[callee-save],\" matching the semantics of an interrupt handler nicely (it has to leave the CPU state just as it found it after its `{m|s}ret`).\r\n\r\nThis approach is not suitable for every interrupt handler, as it makes no attempt to e.g. save the state in a user-accessible stack frame. For a full discussion of those challenges and tradeoffs, please refer to [the interrupt calling conventions RFC][rfc].\r\n\r\nInside rustc, this implementation differs from prior art because LLVM does not expose the \"all-saved\" function flavor as a calling convention directly, instead preferring to use an attribute that allows for differentiating between \"machine-mode\" and \"superivsor-mode\" interrupts.\r\n\r\nFinally, some effort has been made to guide those who may not yet be aware of the differences between machine-mode and supervisor-mode interrupts as to why no `riscv-interrupt` calling convention is exposed through rustc, and similarly for why `riscv-interrupt-u` makes no appearance (as it would complicate future LLVM upgrades).\r\n\r\n[clang-attr]: https://clang.llvm.org/docs/AttributeReference.html#interrupt-risc-v\r\n[full-frame-save]: https://github.com/esp-rs/esp-riscv-rt/blob/9281af2ecffe13e40992917316f36920c26acaf3/src/lib.rs#L440-L469\r\n[implemented by]: https://github.com/llvm/llvm-project/blob/b7fb2a3fec7c187d58a6d338ab512d9173bca987/llvm/lib/Target/RISCV/RISCVRegisterInfo.cpp#L61-L67\r\n[callee-save]: https://github.com/llvm/llvm-project/blob/973f1fe7a8591c7af148e573491ab68cc15b6ecf/llvm/lib/Target/RISCV/RISCVCallingConv.td#L30-L37\r\n[rfc]: https://github.com/rust-lang/rfcs/pull/3246", "created_at": "2023-05-23T22:41:27Z", "updated_at": "2023-06-20T02:20:00Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "a426fad5dc028cc7804df9ed7780406d1d2a6e2b", "assignee": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 120005, "node_id": "MDU6TGFiZWwxMjAwMDU=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-testsuite", "name": "A-testsuite", "color": "f7e101", "default": false, "description": "Area: The testsuite used to check the correctness of rustc"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}, {"id": 593503757, "node_id": "MDU6TGFiZWw1OTM1MDM3NTc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-infra", "name": "T-infra", "color": "bfd4f2", "default": false, "description": "Relevant to the infrastructure team, which will review and decide on the PR/issue."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/111891/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/111891/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111891/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/c546991b0df259ebb48587eed1ab37321cd4dfc1", "head": {"label": "rustbox:feat/riscv-isr-cconv", "ref": "feat/riscv-isr-cconv", "sha": "c546991b0df259ebb48587eed1ab37321cd4dfc1", "user": {"login": "rustbox", "id": 7800961, "node_id": "MDEyOk9yZ2FuaXphdGlvbjc4MDA5NjE=", "avatar_url": "https://avatars.githubusercontent.com/u/7800961?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbox", "html_url": "https://github.com/rustbox", "followers_url": "https://api.github.com/users/rustbox/followers", "following_url": "https://api.github.com/users/rustbox/following{/other_user}", "gists_url": "https://api.github.com/users/rustbox/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbox/subscriptions", "organizations_url": "https://api.github.com/users/rustbox/orgs", "repos_url": "https://api.github.com/users/rustbox/repos", "events_url": "https://api.github.com/users/rustbox/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbox/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 644411294, "node_id": "R_kgDOJmjvng", "name": "rust", "full_name": "rustbox/rust", "private": false, "owner": {"login": "rustbox", "id": 7800961, "node_id": "MDEyOk9yZ2FuaXphdGlvbjc4MDA5NjE=", "avatar_url": "https://avatars.githubusercontent.com/u/7800961?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rustbox", "html_url": "https://github.com/rustbox", "followers_url": "https://api.github.com/users/rustbox/followers", "following_url": "https://api.github.com/users/rustbox/following{/other_user}", "gists_url": "https://api.github.com/users/rustbox/gists{/gist_id}", "starred_url": "https://api.github.com/users/rustbox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rustbox/subscriptions", "organizations_url": "https://api.github.com/users/rustbox/orgs", "repos_url": "https://api.github.com/users/rustbox/repos", "events_url": "https://api.github.com/users/rustbox/events{/privacy}", "received_events_url": "https://api.github.com/users/rustbox/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rustbox/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/rustbox/rust", "forks_url": "https://api.github.com/repos/rustbox/rust/forks", "keys_url": "https://api.github.com/repos/rustbox/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rustbox/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rustbox/rust/teams", "hooks_url": "https://api.github.com/repos/rustbox/rust/hooks", "issue_events_url": "https://api.github.com/repos/rustbox/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rustbox/rust/events", "assignees_url": "https://api.github.com/repos/rustbox/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rustbox/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rustbox/rust/tags", "blobs_url": "https://api.github.com/repos/rustbox/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rustbox/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rustbox/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rustbox/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rustbox/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rustbox/rust/languages", "stargazers_url": "https://api.github.com/repos/rustbox/rust/stargazers", "contributors_url": "https://api.github.com/repos/rustbox/rust/contributors", "subscribers_url": "https://api.github.com/repos/rustbox/rust/subscribers", "subscription_url": "https://api.github.com/repos/rustbox/rust/subscription", "commits_url": "https://api.github.com/repos/rustbox/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rustbox/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rustbox/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rustbox/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rustbox/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rustbox/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rustbox/rust/merges", "archive_url": "https://api.github.com/repos/rustbox/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rustbox/rust/downloads", "issues_url": "https://api.github.com/repos/rustbox/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rustbox/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rustbox/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rustbox/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rustbox/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rustbox/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rustbox/rust/deployments", "created_at": "2023-05-23T13:12:13Z", "updated_at": "2023-05-23T13:12:13Z", "pushed_at": "2023-05-26T15:40:39Z", "git_url": "git://github.com/rustbox/rust.git", "ssh_url": "git@github.com:rustbox/rust.git", "clone_url": "https://github.com/rustbox/rust.git", "svn_url": "https://github.com/rustbox/rust", "homepage": "https://www.rust-lang.org", "size": 963216, "stargazers_count": 0, "watchers_count": 0, "language": null, "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "917b0b6c70f078cb08bbb0080c9379e4487353c3", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-21T00:15:03Z", "pushed_at": "2023-06-21T01:02:33Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 931095, "stargazers_count": 82793, "watchers_count": 82793, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10969, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9633, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10969, "open_issues": 9633, "watchers": 82793, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111891"}, "html": {"href": "https://github.com/rust-lang/rust/pull/111891"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/111891"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/111891/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111891/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111891/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/c546991b0df259ebb48587eed1ab37321cd4dfc1"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": true, "rebaseable": true, "mergeable_state": "blocked", "merged_by": null, "comments": 12, "review_comments": 0, "maintainer_can_modify": false, "commits": 7, "additions": 622, "deletions": 60, "changed_files": 29}