{"url": "https://api.github.com/repos/rust-lang/rust/pulls/19434", "id": 25247748, "node_id": "MDExOlB1bGxSZXF1ZXN0MjUyNDc3NDg=", "html_url": "https://github.com/rust-lang/rust/pull/19434", "diff_url": "https://github.com/rust-lang/rust/pull/19434.diff", "patch_url": "https://github.com/rust-lang/rust/pull/19434.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/19434", "number": 19434, "state": "closed", "locked": false, "title": "[WIP] Don't rely on the type of `lhs` when type checking `lhs OP rhs`", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "body": "Tweaks the binary operator dispatch algorithm to not rely on the full resolution of the type of the LHS.\n\nCloses #8280\nCloses #19035\n\n---\n\nThis is an overview of the current type checking algorithm vs the new algorithm introduced in this PR:\n### Current\n- Check `lhs`\n  - (i.e. `check_expr(lhs)`)\n- Fully resolve the type of `lhs` (**compiler error** if can't fully resolve)\n  - (i.e. `lhs_ty = structurally_resolved_type(lhs)`)\n  - This is the cause of #8280\n- If `lhs_ty` is integer and `OP` is bit-shift\n  - Enforce that `rhs_ty` is a subtype of `uint`\n- Categorize `lhs_ty` and `OP`, if `lhs_ty OP lhs_ty` is a built-in operation\n  - (i.e. `is_binopable(lhs_ty, op)` returns true)\n  - This is the cause of #19035\n  - Watch out for SIMD comparison, make `rhs_ty` a subtype of `lhs_ty` and \"write\" the type of `lhs OP rhs` expression\n- Raise compile error if OP is `&&` or `||`\n- Otherwise operator is overloaded, proceed with trait dispatch\n### New (this PR)\n- Check _both_ `lhs` and `rhs`\n  - (i.e. `check_expr(lhs|rhs)`)\n- _Try_ to fully resolve `lhs` _and_ `rhs`\n- If both got fully resolved\n  - (i.e. iff both `try_structurally_resolved_type(lhs|rhs)` return `Some`)\n  - If _both_ `lhs_ty` and `rhs_ty` are integers and `OP` is bit-shift\n    - Enforce that `rhs_ty` is a subtype of `uint`\n  - Categorize `lhs_ty`, `rhs_ty` and `OP`, if `lhs_ty` _and_ `rhs_ty` have the same category and `lhs OP rhs` is a built-in operation\n    - (i.e. `is_builtin_binop(cx, lhs_ty, op)` returns true)\n    - Watch out for SIMD comparison and write type of `lhs OP rhs` expression\n- Raise compile error if OP is `&&` or `||`\n- Otherwise operator is overloaded, proceed with trait dispatch\n\n---\n\nThis PR passes `make check` as it is, but it comes with two new issues:\n- The \"reborrow adjustment\" trick we use to make `&'a T == &'b T` work even though only `&'a T == &'a T` (_note_ same lifetime `'a`) should work ... well, it no longer works (or it doesn't work in most cases). However, this is not a real problem, because with #19167 (overloaded `==` operator), we can now `impl PartialEq<&'b T> for &'a T` to take care references of with different lifetimes.\n- The most aggravating issue is an increase in the verbosity and decrease in the quality of the error messages related to binary operators. Consider the following code:\n\n``` rust\nstruct Foo;\n\n#[deriving(PartialEq)]\nstruct Bar(Foo);\n\nfn main() {}\n```\n\nWhich now generates the following error message:\n\n``` rust\nderiving.rs:4:12: 4:16 error: binary operation `==` cannot be applied to type `Foo`\nderiving.rs:4 struct Bar(Foo);\n                         ^~~~\nnote: in expansion of #[deriving]\nderiving.rs:3:1: 3:23 note: expansion site\nderiving.rs:4:12: 4:16 error: binary operation `&&` cannot be applied to type `bool`\nderiving.rs:4 struct Bar(Foo);\n                         ^~~~\nnote: in expansion of #[deriving]\nderiving.rs:3:1: 3:23 note: expansion site\nderiving.rs:4:12: 4:16 error: binary operation `==` cannot be applied to type `Foo`\nderiving.rs:4 struct Bar(Foo);\n                         ^~~~\nnote: in expansion of #[deriving]\nderiving.rs:3:1: 3:23 note: expansion site\nderiving.rs:4:12: 4:16 error: binary operation `!=` cannot be applied to type `Foo`\nderiving.rs:4 struct Bar(Foo);\n                         ^~~~\nnote: in expansion of #[deriving]\nderiving.rs:3:1: 3:23 note: expansion site\nderiving.rs:4:12: 4:16 \"\nderiving.rs:4 struct Bar(Foo);\n                         ^~~~\nnote: in expansion of #[deriving]\nderiving.rs:3:1: 3:23 note: expansion site\nderiving.rs:4:12: 4:16 error: binary operation `!=` cannot be applied to type `Foo`\nderiving.rs:4 struct Bar(Foo);\n                         ^~~~\nnote: in expansion of #[deriving]\nderiving.rs:3:1: 3:23 note: expansion site\nerror: aborting due to 6 previous errors\n```\n- The error message \"binary operation `==` cannot be applied to type `Foo`\" (and its `!=` brother) should appear only once.\n- The error message \"binary operation `==` cannot be applied to type `Foo`\", although it sounds absurd, it's actually a real error, just that the message it's bad. That message it's actually referring to the operation `bool && [Type Error]` where `[Type Error]` is the type of `Foo == Foo` (which can't be resolved, since `Foo` doesn't implement `PartialEq`).\n\n@nikomatsakis Thoughts? I think I can fix/improve the error messages, but I'd like to know what you think about the approach and whether the \"reborrow adjustment\" can/should be fixed or not.\n", "created_at": "2014-12-01T05:06:30Z", "updated_at": "2015-02-17T15:53:50Z", "closed_at": "2015-01-11T04:15:34Z", "merged_at": null, "merge_commit_sha": "455372f603eb85f0b1bac97ec8ef518bf00b7b77", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/19434/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/19434/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/19434/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/a043797771f8f4f2bb7551baef9e01210396bc1e", "head": {"label": "japaric:lhs-ops", "ref": "lhs-ops", "sha": "a043797771f8f4f2bb7551baef9e01210396bc1e", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "repo": {"id": 17873870, "node_id": "MDEwOlJlcG9zaXRvcnkxNzg3Mzg3MA==", "name": "rust", "full_name": "japaric/rust", "private": false, "owner": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/japaric/rust", "description": "a safe, concurrent, practical language", "fork": true, "url": "https://api.github.com/repos/japaric/rust", "forks_url": "https://api.github.com/repos/japaric/rust/forks", "keys_url": "https://api.github.com/repos/japaric/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/japaric/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/japaric/rust/teams", "hooks_url": "https://api.github.com/repos/japaric/rust/hooks", "issue_events_url": "https://api.github.com/repos/japaric/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/japaric/rust/events", "assignees_url": "https://api.github.com/repos/japaric/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/japaric/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/japaric/rust/tags", "blobs_url": "https://api.github.com/repos/japaric/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/japaric/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/japaric/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/japaric/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/japaric/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/japaric/rust/languages", "stargazers_url": "https://api.github.com/repos/japaric/rust/stargazers", "contributors_url": "https://api.github.com/repos/japaric/rust/contributors", "subscribers_url": "https://api.github.com/repos/japaric/rust/subscribers", "subscription_url": "https://api.github.com/repos/japaric/rust/subscription", "commits_url": "https://api.github.com/repos/japaric/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/japaric/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/japaric/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/japaric/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/japaric/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/japaric/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/japaric/rust/merges", "archive_url": "https://api.github.com/repos/japaric/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/japaric/rust/downloads", "issues_url": "https://api.github.com/repos/japaric/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/japaric/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/japaric/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/japaric/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/japaric/rust/labels{/name}", "releases_url": "https://api.github.com/repos/japaric/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/japaric/rust/deployments", "created_at": "2014-03-18T16:51:45Z", "updated_at": "2020-01-15T15:08:04Z", "pushed_at": "2022-06-27T10:37:14Z", "git_url": "git://github.com/japaric/rust.git", "ssh_url": "git@github.com:japaric/rust.git", "clone_url": "https://github.com/japaric/rust.git", "svn_url": "https://github.com/japaric/rust", "homepage": "http://www.rust-lang.org", "size": 837392, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "222a1eb7e80101de182142dc264cdcd81c894b2c", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T02:32:08Z", "pushed_at": "2023-06-20T02:02:30Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 930398, "stargazers_count": 82760, "watchers_count": 82760, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10961, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9626, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10961, "open_issues": 9626, "watchers": 82760, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/19434"}, "html": {"href": "https://github.com/rust-lang/rust/pull/19434"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/19434"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/19434/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/19434/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/19434/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/a043797771f8f4f2bb7551baef9e01210396bc1e"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 6, "review_comments": 0, "maintainer_can_modify": false, "commits": 4, "additions": 583, "deletions": 291, "changed_files": 56}