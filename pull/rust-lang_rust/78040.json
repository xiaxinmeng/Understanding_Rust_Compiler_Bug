{"url": "https://api.github.com/repos/rust-lang/rust/pulls/78040", "id": 505231832, "node_id": "MDExOlB1bGxSZXF1ZXN0NTA1MjMxODMy", "html_url": "https://github.com/rust-lang/rust/pull/78040", "diff_url": "https://github.com/rust-lang/rust/pull/78040.diff", "patch_url": "https://github.com/rust-lang/rust/pull/78040.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/78040", "number": 78040, "state": "closed", "locked": false, "title": "[WIP] Working expression optimization, and some improvements to branch-level source coverage", "user": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "body": "This is a draft work in progress.\r\n\r\nIt looks like it is working as I would expect. All existing tests pass. (There are a few small changes, improving the coverage from the last PR.)\r\n\r\nMost of the work is in the MIR `transform/instrument_coverage.rs`. I expanded this a lot, and it's too long right now, so before any serious code reviews, please wait for an update where I'll do some code restructuring to origanize things better. I'll most likely split this into a few separate files.\r\n\r\nI'll add more details soon, to describe the major changes.\r\n\r\nNote this PR includes some significant additional debugging capabilities, to help myself and any future developer working on coverage improvements or issues.\r\n\r\nIn particular, there's a new Graphviz (.dot file) output for the coverage graph (the `BasicCoverageBlock` control flow graph) that provides ways to get some very good insight into the relationships between the MIR, the coverage graph BCBs, coverage spans, and counters. (There are also some cool debugging options, available via environment variable, to alter how some data in the graph appears.)\r\n\r\nAnd the code for this Graphviz view is actually generic... it can be used by any implementation of the Rust `Graph` traits.\r\n\r\nFinally (for now), I also now output information from `llvm-cov` that shows the actual counters and spans it found in the coverage map, and their counts (from the `--debug` flag). I found this to be enormously helpful in debugging some coverage issues, so I kept it in the test results as well for additional context.\r\n\r\n@tmandry @wesleywiser \r\n\r\nr? @tmandry \r\n\r\nHere's an example of the new coverage graph:\r\n\r\n* Within each `BasicCoverageBlock` (BCB), you can see each `CoverageSpan` and its contributing statements (MIR `Statement`s and/or `Terminator`s)\r\n* Each `CoverageSpan` has a `Counter` or and `Expression`, and `Expression`s show their Add/Subtract operation with nested operations. (This can be changed to show the Counter and Expression IDs instead, or in addition to, the BCB.)\r\n* The terminators of all MIR `BasicBlock`s in the BCB, including one final `Terminator`\r\n* If an \"edge counter\" is required (because we need to count an edge between blocks, in some cases) the edge's Counter or Expression is shown next to its label. (Not shown in the example below.) (FYI, Edge Counters are converted into a new MIR `BasicBlock` with `Goto`)\r\n\r\n<img width=\"1116\" alt=\"Screen Shot 2020-10-17 at 12 23 29 AM\" src=\"https://user-images.githubusercontent.com/3827298/96331095-616cb480-100f-11eb-8212-60f2d433e2d8.png\">\r\n", "created_at": "2020-10-17T07:13:01Z", "updated_at": "2020-10-23T08:59:35Z", "closed_at": "2020-10-23T08:59:35Z", "merged_at": null, "merge_commit_sha": "400e4728fc9a0c8604ee5621eff99435eb1576ad", "assignee": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/78040/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/78040/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/78040/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/17c1f1488eaace86884b7a544f44d8dc991f7ca9", "head": {"label": "richkadel:llvm-coverage-counters-2.0.3", "ref": "llvm-coverage-counters-2.0.3", "sha": "17c1f1488eaace86884b7a544f44d8dc991f7ca9", "user": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "repo": {"id": 249778902, "node_id": "MDEwOlJlcG9zaXRvcnkyNDk3Nzg5MDI=", "name": "rust", "full_name": "richkadel/rust", "private": false, "owner": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/richkadel/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/richkadel/rust", "forks_url": "https://api.github.com/repos/richkadel/rust/forks", "keys_url": "https://api.github.com/repos/richkadel/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/richkadel/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/richkadel/rust/teams", "hooks_url": "https://api.github.com/repos/richkadel/rust/hooks", "issue_events_url": "https://api.github.com/repos/richkadel/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/richkadel/rust/events", "assignees_url": "https://api.github.com/repos/richkadel/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/richkadel/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/richkadel/rust/tags", "blobs_url": "https://api.github.com/repos/richkadel/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/richkadel/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/richkadel/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/richkadel/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/richkadel/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/richkadel/rust/languages", "stargazers_url": "https://api.github.com/repos/richkadel/rust/stargazers", "contributors_url": "https://api.github.com/repos/richkadel/rust/contributors", "subscribers_url": "https://api.github.com/repos/richkadel/rust/subscribers", "subscription_url": "https://api.github.com/repos/richkadel/rust/subscription", "commits_url": "https://api.github.com/repos/richkadel/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/richkadel/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/richkadel/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/richkadel/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/richkadel/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/richkadel/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/richkadel/rust/merges", "archive_url": "https://api.github.com/repos/richkadel/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/richkadel/rust/downloads", "issues_url": "https://api.github.com/repos/richkadel/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/richkadel/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/richkadel/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/richkadel/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/richkadel/rust/labels{/name}", "releases_url": "https://api.github.com/repos/richkadel/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/richkadel/rust/deployments", "created_at": "2020-03-24T17:52:41Z", "updated_at": "2021-03-24T16:21:08Z", "pushed_at": "2021-12-01T15:35:14Z", "git_url": "git://github.com/richkadel/rust.git", "ssh_url": "git@github.com:richkadel/rust.git", "clone_url": "https://github.com/richkadel/rust.git", "svn_url": "https://github.com/richkadel/rust", "homepage": "https://www.rust-lang.org", "size": 731050, "stargazers_count": 1, "watchers_count": 1, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 1, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 1, "open_issues": 0, "watchers": 1, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "19356453cbfb734bc60a1853c10e3095d05e0342", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T14:57:12Z", "pushed_at": "2023-06-20T15:01:15Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 931034, "stargazers_count": 82775, "watchers_count": 82775, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10967, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9634, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10967, "open_issues": 9634, "watchers": 82775, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/78040"}, "html": {"href": "https://github.com/rust-lang/rust/pull/78040"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/78040"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/78040/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/78040/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/78040/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/17c1f1488eaace86884b7a544f44d8dc991f7ca9"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 7, "review_comments": 0, "maintainer_can_modify": false, "commits": 18, "additions": 12777, "deletions": 2085, "changed_files": 204}