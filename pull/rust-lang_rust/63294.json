{"url": "https://api.github.com/repos/rust-lang/rust/pulls/63294", "id": 304366717, "node_id": "MDExOlB1bGxSZXF1ZXN0MzA0MzY2NzE3", "html_url": "https://github.com/rust-lang/rust/pull/63294", "diff_url": "https://github.com/rust-lang/rust/pull/63294.diff", "patch_url": "https://github.com/rust-lang/rust/pull/63294.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/63294", "number": 63294, "state": "closed", "locked": false, "title": "tests for async/await drop order", "user": {"login": "alsuren", "id": 254647, "node_id": "MDQ6VXNlcjI1NDY0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/254647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alsuren", "html_url": "https://github.com/alsuren", "followers_url": "https://api.github.com/users/alsuren/followers", "following_url": "https://api.github.com/users/alsuren/following{/other_user}", "gists_url": "https://api.github.com/users/alsuren/gists{/gist_id}", "starred_url": "https://api.github.com/users/alsuren/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alsuren/subscriptions", "organizations_url": "https://api.github.com/users/alsuren/orgs", "repos_url": "https://api.github.com/users/alsuren/repos", "events_url": "https://api.github.com/users/alsuren/events{/privacy}", "received_events_url": "https://api.github.com/users/alsuren/received_events", "type": "User", "site_admin": false}, "body": "This is just me helping out with https://github.com/rust-lang/rust/issues/62121 where I can.\r\n\r\nI'm also going to use this as a public place to collect my thoughts about what has already been done and what hasn't (adding comments to the dropbox paper doc was quickly getting spammy).\r\n\r\nI've tried to keep my commit messages similar to the line items on https://paper.dropbox.com/doc/async.await-Call-for-Tests--AiKouT0L41mSnK1741s~TiiRAg-nMyZGrra7dz9KcFRMLKJy as possible.\r\n\r\nA bunch of my tests are likely to be either redundant with other tests, or lower quality than other tests that people are writing. A reasonable approach might be to tell me which commits you want to keep and I'll throw away the rest of them.\r\n\r\nThe part from the dropbox paper doc that I'm concentrating on here is:\r\n(items marked with `?` are ones that I can't immediately think of how to test, so I will leave for other people. Items with checkboxes are things that I have done or will try to do next)\r\n\r\n### Dynamic semantics\r\n- `async`/`await` with unusual locals:\r\n    - ? partially uninhabited\r\n    - ? conditionally initialized\r\n    - ~drop impls~ already done in src/test/ui/async-await/drop-order/*\r\n    - ? nested drop impls\r\n    - ~partially moved (e.g., `let x = (vec![], vec![]); drop(x.0); foo.await; drop(x.1);`)~ see  https://github.com/rust-lang/rust/pull/63310 \r\n- Control flow:\r\n    - basic\r\n    - complex\r\n- [x] `.await` while holding variables of different sizes\r\n- (possibly) drop order\r\n    - [x] including drop order for locals when a future is dropped part-way through execution\r\n         - Parameters' drop order is covered in my commit f40190a\r\n    - ~An async fn version of `dynamic-drop.rs`~ \r\n        - already done by matthewjasper in https://github.com/rust-lang/rust/pull/62193/files\r\n- ? interaction with const eval, promoteds, and temporaries\r\n- [x] drop the resulting future and check that local variables and parameters are dropped in the expected order (interaction with cancellation, in other words)\r\n    - also in f40190a\r\n\r\nExplanation of commits:\r\n\r\n* 0a1bdd4 is the simplest place I could think of to explicitly test `.await` while holding variables of different sizes. I'm pretty sure that this will end up being redundant with something else, so I'm happy to drop it.\r\n* f40190a is a copy-paste from `drop-order-for-async-fn-parameters.rs` with `NeverReady.await` dumped on the end of each testcase. \r\n    * Normally I don't like copy-paste-based tests, but `drop-order-for-async-fn-parameters-by-ref-binding.rs` is also copy-paste, so I thought it might be okay.\r\n    * [x] I'm a bit sad that this doesn't cover non-parameter locals, but I think it should be easy enough to extend in that direction, so I might have a crack at that tomorrow.\r\n* c4940e0f90 makes a bunch of local variables and moves them into either `{}` blocks or `async move {}` blocks, checking for any surprising differences.\r\n    * I have tried to give the test functions descriptive names\r\n    * I have not duplicated the tests for methods with/without self.\r\n    * I think that all of these tests could be rewritten to be clearer if I could write down the expected drop order next to each test.", "created_at": "2019-08-05T16:02:55Z", "updated_at": "2019-08-07T04:28:06Z", "closed_at": "2019-08-07T04:28:06Z", "merged_at": "2019-08-07T04:28:06Z", "merge_commit_sha": "c4940e0f90d7d0e1784ade2b9e1ccc7ae7acfd4a", "assignee": {"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "cramertj", "id": 5963049, "node_id": "MDQ6VXNlcjU5NjMwNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5963049?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cramertj", "html_url": "https://github.com/cramertj", "followers_url": "https://api.github.com/users/cramertj/followers", "following_url": "https://api.github.com/users/cramertj/following{/other_user}", "gists_url": "https://api.github.com/users/cramertj/gists{/gist_id}", "starred_url": "https://api.github.com/users/cramertj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cramertj/subscriptions", "organizations_url": "https://api.github.com/users/cramertj/orgs", "repos_url": "https://api.github.com/users/cramertj/repos", "events_url": "https://api.github.com/users/cramertj/events{/privacy}", "received_events_url": "https://api.github.com/users/cramertj/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 583437191, "node_id": "MDU6TGFiZWw1ODM0MzcxOTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-bors", "name": "S-waiting-on-bors", "color": "d3dddd", "default": false, "description": "Status: Waiting on bors to run and complete tests. Bors will change the label on completion."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/63294/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/63294/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/63294/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/c4940e0f90d7d0e1784ade2b9e1ccc7ae7acfd4a", "head": {"label": "alsuren:async-tests", "ref": "async-tests", "sha": "c4940e0f90d7d0e1784ade2b9e1ccc7ae7acfd4a", "user": {"login": "alsuren", "id": 254647, "node_id": "MDQ6VXNlcjI1NDY0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/254647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alsuren", "html_url": "https://github.com/alsuren", "followers_url": "https://api.github.com/users/alsuren/followers", "following_url": "https://api.github.com/users/alsuren/following{/other_user}", "gists_url": "https://api.github.com/users/alsuren/gists{/gist_id}", "starred_url": "https://api.github.com/users/alsuren/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alsuren/subscriptions", "organizations_url": "https://api.github.com/users/alsuren/orgs", "repos_url": "https://api.github.com/users/alsuren/repos", "events_url": "https://api.github.com/users/alsuren/events{/privacy}", "received_events_url": "https://api.github.com/users/alsuren/received_events", "type": "User", "site_admin": false}, "repo": {"id": 200675183, "node_id": "MDEwOlJlcG9zaXRvcnkyMDA2NzUxODM=", "name": "rust", "full_name": "alsuren/rust", "private": false, "owner": {"login": "alsuren", "id": 254647, "node_id": "MDQ6VXNlcjI1NDY0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/254647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alsuren", "html_url": "https://github.com/alsuren", "followers_url": "https://api.github.com/users/alsuren/followers", "following_url": "https://api.github.com/users/alsuren/following{/other_user}", "gists_url": "https://api.github.com/users/alsuren/gists{/gist_id}", "starred_url": "https://api.github.com/users/alsuren/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alsuren/subscriptions", "organizations_url": "https://api.github.com/users/alsuren/orgs", "repos_url": "https://api.github.com/users/alsuren/repos", "events_url": "https://api.github.com/users/alsuren/events{/privacy}", "received_events_url": "https://api.github.com/users/alsuren/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/alsuren/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/alsuren/rust", "forks_url": "https://api.github.com/repos/alsuren/rust/forks", "keys_url": "https://api.github.com/repos/alsuren/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/alsuren/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/alsuren/rust/teams", "hooks_url": "https://api.github.com/repos/alsuren/rust/hooks", "issue_events_url": "https://api.github.com/repos/alsuren/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/alsuren/rust/events", "assignees_url": "https://api.github.com/repos/alsuren/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/alsuren/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/alsuren/rust/tags", "blobs_url": "https://api.github.com/repos/alsuren/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/alsuren/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/alsuren/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/alsuren/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/alsuren/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/alsuren/rust/languages", "stargazers_url": "https://api.github.com/repos/alsuren/rust/stargazers", "contributors_url": "https://api.github.com/repos/alsuren/rust/contributors", "subscribers_url": "https://api.github.com/repos/alsuren/rust/subscribers", "subscription_url": "https://api.github.com/repos/alsuren/rust/subscription", "commits_url": "https://api.github.com/repos/alsuren/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/alsuren/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/alsuren/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/alsuren/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/alsuren/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/alsuren/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/alsuren/rust/merges", "archive_url": "https://api.github.com/repos/alsuren/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/alsuren/rust/downloads", "issues_url": "https://api.github.com/repos/alsuren/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/alsuren/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/alsuren/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/alsuren/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/alsuren/rust/labels{/name}", "releases_url": "https://api.github.com/repos/alsuren/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/alsuren/rust/deployments", "created_at": "2019-08-05T14:49:21Z", "updated_at": "2020-06-20T20:04:20Z", "pushed_at": "2020-06-21T16:28:47Z", "git_url": "git://github.com/alsuren/rust.git", "ssh_url": "git@github.com:alsuren/rust.git", "clone_url": "https://github.com/alsuren/rust.git", "svn_url": "https://github.com/alsuren/rust", "homepage": "https://www.rust-lang.org", "size": 537583, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 2, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 2, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "4be067558962c004b638e4c6f162d50f7c0c98b6", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T13:19:04Z", "pushed_at": "2023-06-19T12:54:45Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 920473, "stargazers_count": 82747, "watchers_count": 82747, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9632, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9632, "watchers": 82747, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/63294"}, "html": {"href": "https://github.com/rust-lang/rust/pull/63294"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/63294"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/63294/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/63294/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/63294/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/c4940e0f90d7d0e1784ade2b9e1ccc7ae7acfd4a"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": true, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "comments": 6, "review_comments": 0, "maintainer_can_modify": false, "commits": 4, "additions": 501, "deletions": 0, "changed_files": 3}