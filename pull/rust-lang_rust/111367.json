{"url": "https://api.github.com/repos/rust-lang/rust/pulls/111367", "id": 1342766137, "node_id": "PR_kwDOAAsO6M5QCPw5", "html_url": "https://github.com/rust-lang/rust/pull/111367", "diff_url": "https://github.com/rust-lang/rust/pull/111367.diff", "patch_url": "https://github.com/rust-lang/rust/pull/111367.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/111367", "number": 111367, "state": "open", "locked": false, "title": "Faster UTF-8 string validation", "user": {"login": "oliver-giersch", "id": 19815381, "node_id": "MDQ6VXNlcjE5ODE1Mzgx", "avatar_url": "https://avatars.githubusercontent.com/u/19815381?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oliver-giersch", "html_url": "https://github.com/oliver-giersch", "followers_url": "https://api.github.com/users/oliver-giersch/followers", "following_url": "https://api.github.com/users/oliver-giersch/following{/other_user}", "gists_url": "https://api.github.com/users/oliver-giersch/gists{/gist_id}", "starred_url": "https://api.github.com/users/oliver-giersch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oliver-giersch/subscriptions", "organizations_url": "https://api.github.com/users/oliver-giersch/orgs", "repos_url": "https://api.github.com/users/oliver-giersch/repos", "events_url": "https://api.github.com/users/oliver-giersch/events{/privacy}", "received_events_url": "https://api.github.com/users/oliver-giersch/received_events", "type": "User", "site_admin": false}, "body": "This PR rewrites much of the UTF-8 validation code, optimizing it in particular for validating ASCII strings. This does not mean, there is an artificial bias towards pure ASCII strings, just that this path is particularly optimized. These optimizations come from 2 primary directions:\r\n\r\n- Checking larger blocks (up to 8 words at a time) and the code for checking blocks is deliberately written to facilitate auto-vectorization using up to 512-bit SIMD instructions (on x86-64).\r\n- Reducing the amount of superfluous checks. E.g., in the current version, when a non-ASCII byte is detected in a (at most 2-word) block, all bytes in that block are checked individually *again*, meaning up to `2 * mem::size_of::<usize>() - 1` have to be checked twice. In the new version, the same block is checked again using word-wise operations, so that fewer bytes have to be checked individually. This is particularly important due to the larger block sizes.\r\n\r\nThe code for checking detected non-ASCII bytes/byte-sequences remains relatively unaltered, so now great differences are to be expected for non-ASCII strings. I evaluated the changes using 6 benchmarks, validating different string sizes ranging from 27 to ~200k bytes, the results for which can be inspected [here](https://oliver-giersch.github.io/fast-utf8/). The best performance improvement is ~2x faster, the worst is ~17.5% slower (for short strings on a Raspberry Pi 4 with a relatively small regression in absolute terms).\r\n\r\nSince UTF-8 validation is a pretty fundamental operation in Rust, these changes should ideally be evaluated on more platforms, since I could only run these benchmarks on systems I had access to, which were 3 different `x86-64` systems and one `aarch64`. Any help here would definitely appreciated, the benchmarking code can be found [here](https://github.com/oliver-giersch/fast-utf8), in a separate repo.\r\n\r\nNote: I found, that the performance on `aarch64` could be further improved by using a specialized version of the `has_non_ascii_byte` function like this:\r\n\r\n```rust\r\n#[cfg(not(target_feature = \"avx\"))]\r\n#[inline(always)]\r\nconst fn has_non_ascii_byte<const N: usize>(block: &[usize; N]) -> bool {\r\n    let mut i = 0;\r\n    while i < N {\r\n        if block[i] & NONASCII_MASK > 0 {\r\n            return true;\r\n        }\r\n        i += 1;\r\n    }\r\n\r\n    false\r\n}\r\n```\r\n\r\nI eventually decided against including this in the PR, since it is fairly arbitrary and overall probably dependent on which optimization passes are implemented differently by LLVM for different architectures and I have no idea how this would affect other platforms I have not myself evaluated.", "created_at": "2023-05-08T20:42:48Z", "updated_at": "2023-05-09T22:25:26Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "0a9c1c517fd1187d7549bca7bb39e12748feb23a", "assignee": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 583436937, "node_id": "MDU6TGFiZWw1ODM0MzY5Mzc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-author", "name": "S-waiting-on-author", "color": "d3dddd", "default": false, "description": "Status: This is awaiting some action (such as code changes or more information) from the author."}, {"id": 2011781731, "node_id": "MDU6TGFiZWwyMDExNzgxNzMx", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs", "name": "T-libs", "color": "bfd4f2", "default": false, "description": "Relevant to the library team, which will review and decide on the PR/issue."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/111367/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/111367/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111367/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/07060bee33cf0be366eebd110e5da852e6bcc392", "head": {"label": "oliver-giersch:faster_utf8_validation", "ref": "faster_utf8_validation", "sha": "07060bee33cf0be366eebd110e5da852e6bcc392", "user": {"login": "oliver-giersch", "id": 19815381, "node_id": "MDQ6VXNlcjE5ODE1Mzgx", "avatar_url": "https://avatars.githubusercontent.com/u/19815381?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oliver-giersch", "html_url": "https://github.com/oliver-giersch", "followers_url": "https://api.github.com/users/oliver-giersch/followers", "following_url": "https://api.github.com/users/oliver-giersch/following{/other_user}", "gists_url": "https://api.github.com/users/oliver-giersch/gists{/gist_id}", "starred_url": "https://api.github.com/users/oliver-giersch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oliver-giersch/subscriptions", "organizations_url": "https://api.github.com/users/oliver-giersch/orgs", "repos_url": "https://api.github.com/users/oliver-giersch/repos", "events_url": "https://api.github.com/users/oliver-giersch/events{/privacy}", "received_events_url": "https://api.github.com/users/oliver-giersch/received_events", "type": "User", "site_admin": false}, "repo": {"id": 634791100, "node_id": "R_kgDOJdYkvA", "name": "rust", "full_name": "oliver-giersch/rust", "private": false, "owner": {"login": "oliver-giersch", "id": 19815381, "node_id": "MDQ6VXNlcjE5ODE1Mzgx", "avatar_url": "https://avatars.githubusercontent.com/u/19815381?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oliver-giersch", "html_url": "https://github.com/oliver-giersch", "followers_url": "https://api.github.com/users/oliver-giersch/followers", "following_url": "https://api.github.com/users/oliver-giersch/following{/other_user}", "gists_url": "https://api.github.com/users/oliver-giersch/gists{/gist_id}", "starred_url": "https://api.github.com/users/oliver-giersch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oliver-giersch/subscriptions", "organizations_url": "https://api.github.com/users/oliver-giersch/orgs", "repos_url": "https://api.github.com/users/oliver-giersch/repos", "events_url": "https://api.github.com/users/oliver-giersch/events{/privacy}", "received_events_url": "https://api.github.com/users/oliver-giersch/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/oliver-giersch/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/oliver-giersch/rust", "forks_url": "https://api.github.com/repos/oliver-giersch/rust/forks", "keys_url": "https://api.github.com/repos/oliver-giersch/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/oliver-giersch/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/oliver-giersch/rust/teams", "hooks_url": "https://api.github.com/repos/oliver-giersch/rust/hooks", "issue_events_url": "https://api.github.com/repos/oliver-giersch/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/oliver-giersch/rust/events", "assignees_url": "https://api.github.com/repos/oliver-giersch/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/oliver-giersch/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/oliver-giersch/rust/tags", "blobs_url": "https://api.github.com/repos/oliver-giersch/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/oliver-giersch/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/oliver-giersch/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/oliver-giersch/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/oliver-giersch/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/oliver-giersch/rust/languages", "stargazers_url": "https://api.github.com/repos/oliver-giersch/rust/stargazers", "contributors_url": "https://api.github.com/repos/oliver-giersch/rust/contributors", "subscribers_url": "https://api.github.com/repos/oliver-giersch/rust/subscribers", "subscription_url": "https://api.github.com/repos/oliver-giersch/rust/subscription", "commits_url": "https://api.github.com/repos/oliver-giersch/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/oliver-giersch/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/oliver-giersch/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/oliver-giersch/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/oliver-giersch/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/oliver-giersch/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/oliver-giersch/rust/merges", "archive_url": "https://api.github.com/repos/oliver-giersch/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/oliver-giersch/rust/downloads", "issues_url": "https://api.github.com/repos/oliver-giersch/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/oliver-giersch/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/oliver-giersch/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/oliver-giersch/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/oliver-giersch/rust/labels{/name}", "releases_url": "https://api.github.com/repos/oliver-giersch/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/oliver-giersch/rust/deployments", "created_at": "2023-05-01T07:44:06Z", "updated_at": "2023-05-08T20:02:15Z", "pushed_at": "2023-05-09T08:48:36Z", "git_url": "git://github.com/oliver-giersch/rust.git", "ssh_url": "git@github.com:oliver-giersch/rust.git", "clone_url": "https://github.com/oliver-giersch/rust.git", "svn_url": "https://github.com/oliver-giersch/rust", "homepage": "https://www.rust-lang.org", "size": 903509, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "7e7483d26e3cec7a44ef00cf7ae6c9c8c918bec6", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-21T00:15:03Z", "pushed_at": "2023-06-21T00:31:23Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 931095, "stargazers_count": 82793, "watchers_count": 82793, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10969, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9632, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10969, "open_issues": 9632, "watchers": 82793, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111367"}, "html": {"href": "https://github.com/rust-lang/rust/pull/111367"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/111367"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/111367/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111367/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111367/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/07060bee33cf0be366eebd110e5da852e6bcc392"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": true, "rebaseable": true, "mergeable_state": "blocked", "merged_by": null, "comments": 19, "review_comments": 11, "maintainer_can_modify": true, "commits": 3, "additions": 259, "deletions": 128, "changed_files": 1}