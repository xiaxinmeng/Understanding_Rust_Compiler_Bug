{"url": "https://api.github.com/repos/rust-lang/rust/pulls/86024", "id": 662465398, "node_id": "MDExOlB1bGxSZXF1ZXN0NjYyNDY1Mzk4", "html_url": "https://github.com/rust-lang/rust/pull/86024", "diff_url": "https://github.com/rust-lang/rust/pull/86024.diff", "patch_url": "https://github.com/rust-lang/rust/pull/86024.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/86024", "number": 86024, "state": "closed", "locked": false, "title": "Adding the `expect` attribute (RFC 2383)", "user": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "body": "This is a draft implementation of the `expect` attribute as defined in [RFC 2383](https://rust-lang.github.io/rfcs/2383-lint-reasons.html). It basically allows to allow a lint but cause a lint message itself if no lint has been triggered in the defined scope.\r\n\r\n### Example:\r\n```rust\r\n// check-pass\r\n\r\n#![feature(lint_reasons)]\r\n\r\n#[expect(unused_mut)]\r\n#[expect(unused_variables)]\r\nfn main() {\r\n    let x = 0;\r\n}\r\n```\r\n\r\n**Output**:\r\n```txt,ignore\r\nwarning: this lint expectation is unfulfilled\r\n  --> $DIR/trigger_lint.rs:5:1\r\n   |\r\nLL | #[expect(unused_mut)]\r\n   | ^^^^^^^^^^^^^^^^^^^^^\r\n   |\r\n   = note: `#[warn(unfulfilled_lint_expectation)]` on by default\r\n\r\nwarning: 1 warning emitted\r\n```\r\n\r\n### Implementation\r\n\r\nRust now has a new lint level called `Expect`. This indicates that a diagnostic should be emitted to the context, but it will not be passed to the user. It is instead saved inside `rustc_error::HandlerInner` during `rustc_error::HandlerInner::emit_diagnostic(diag)`. This suppresses all lint message with the level expect. (Some lints in rustc and Clippy have a specific check to see if they are allowed in the current scope. Adding a new level allows the addition of the feature without changing such implementations)\r\n\r\nLint expectations have to be checked after all lint passes have been completed. This is done in a new `check_expect_lint` query. It works similar to the `LintLevelMapBuilder` like a stack machine. Here is an example:\r\n\r\n```rs\r\n// Push A on the stack\r\n// Stack [] -> [A]\r\n#[expect(A)]\r\nfn some_function() {\r\n    // Push B on the stack\r\n    // Stack [A] -> [A, B]\r\n    #[expect(B)]\r\n    let x = 0;\r\n    // Pop B from the stack\r\n    //   - consume all issued B's in the scope\r\n    //   - issue a warning if no B has been encountered\r\n    // Stack [A, B] -> [A]\r\n\r\n    // Nothing pushed on the stack\r\n    // Stack [A] -> [A]\r\n    println!(\"{}\", a); \r\n    // Nothing popped off the stack\r\n    // Stack [A] -> [A]\r\n}\r\n// Pop A from the stack\r\n//   - consume all issued A's in the scope\r\n//   - issue a warning if no A has been encountered\r\n// Stack [A] -> []\r\n```\r\n\r\n### TODOs I need help with\r\n\r\n* [ ] Adapt documentation\r\n* [ ] Add tests for tools (make sure that `#[expect(clippy::nice)]` issues a warning, when Clippy runs) \r\n* [ ] Test with incremental compilation\r\n* [ ] Deal with macros correctly (The current implementation strait up ignores the existence of macros)\r\n\r\n### Open questions\r\n1. The RFC discussion included a suggestion to change the `expect` attribute to something else. (Initiated by `@lcrec` [here](https://github.com/rust-lang/rfcs/pull/2383#issuecomment-378424091), suggestion from `@scottmcm` to use `#[should_lint(...)]` [here](https://github.com/rust-lang/rfcs/pull/2383#issuecomment-378648877)). No real conclusion was drawn on that point from my understanding. Is this still open for discussion, or was this discarded with the merge of the RFC?\r\n2. I've renamed the lint from the proposed name `expectation_missing` to `unfulfilled_lint_expectation`. The name was marked as *\"name open to change\"* Is this okay with everyone, or should the name be changed back?\r\n3. New: How should the expect attribute deal with the new `force-warn` lint level?\r\n\r\n---\r\n\r\nI know that this is quite a chunk of code. I sadly don't see a simple way of splitting it up into smaller batches without having partial implementations with loose ends in the compiler. The changes are now split up into 5 commits, with each of them focussing on one area of this implementation. \r\n\r\nr? @nikomatsakis as you mentored me in the issue :)\r\n\r\nMentoring/Implementation issue: #85549\r\n\r\nRFC tracking issue: #54503", "created_at": "2021-06-05T14:35:40Z", "updated_at": "2021-08-07T00:17:11Z", "closed_at": "2021-08-07T00:16:02Z", "merged_at": null, "merge_commit_sha": "c484aad7b8b874f27f578e12e82133da02ef9593", "assignee": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}], "milestone": null, "draft": true, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/86024/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/86024/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/86024/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/43e8b58b37e1ada7e67b4484e4f2e2ed128a93c6", "head": {"label": "xFrednet:54503-expect-lint-attribute", "ref": "54503-expect-lint-attribute", "sha": "43e8b58b37e1ada7e67b4484e4f2e2ed128a93c6", "user": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "repo": {"id": 369299402, "node_id": "MDEwOlJlcG9zaXRvcnkzNjkyOTk0MDI=", "name": "rust", "full_name": "xFrednet/rust", "private": false, "owner": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/xFrednet/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/xFrednet/rust", "forks_url": "https://api.github.com/repos/xFrednet/rust/forks", "keys_url": "https://api.github.com/repos/xFrednet/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/xFrednet/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/xFrednet/rust/teams", "hooks_url": "https://api.github.com/repos/xFrednet/rust/hooks", "issue_events_url": "https://api.github.com/repos/xFrednet/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/xFrednet/rust/events", "assignees_url": "https://api.github.com/repos/xFrednet/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/xFrednet/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/xFrednet/rust/tags", "blobs_url": "https://api.github.com/repos/xFrednet/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/xFrednet/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/xFrednet/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/xFrednet/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/xFrednet/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/xFrednet/rust/languages", "stargazers_url": "https://api.github.com/repos/xFrednet/rust/stargazers", "contributors_url": "https://api.github.com/repos/xFrednet/rust/contributors", "subscribers_url": "https://api.github.com/repos/xFrednet/rust/subscribers", "subscription_url": "https://api.github.com/repos/xFrednet/rust/subscription", "commits_url": "https://api.github.com/repos/xFrednet/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/xFrednet/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/xFrednet/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/xFrednet/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/xFrednet/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/xFrednet/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/xFrednet/rust/merges", "archive_url": "https://api.github.com/repos/xFrednet/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/xFrednet/rust/downloads", "issues_url": "https://api.github.com/repos/xFrednet/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/xFrednet/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/xFrednet/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/xFrednet/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/xFrednet/rust/labels{/name}", "releases_url": "https://api.github.com/repos/xFrednet/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/xFrednet/rust/deployments", "created_at": "2021-05-20T18:14:44Z", "updated_at": "2022-01-01T17:57:04Z", "pushed_at": "2023-05-08T15:48:14Z", "git_url": "git://github.com/xFrednet/rust.git", "ssh_url": "git@github.com:xFrednet/rust.git", "clone_url": "https://github.com/xFrednet/rust.git", "svn_url": "https://github.com/xFrednet/rust", "homepage": "https://www.rust-lang.org", "size": 912642, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "7069a8c2b78c5d23205de1cabb4c2a65229dbd8f", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T06:22:53Z", "pushed_at": "2023-06-19T06:22:45Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 919635, "stargazers_count": 82735, "watchers_count": 82735, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10953, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9628, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10953, "open_issues": 9628, "watchers": 82735, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/86024"}, "html": {"href": "https://github.com/rust-lang/rust/pull/86024"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/86024"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/86024/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/86024/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/86024/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/43e8b58b37e1ada7e67b4484e4f2e2ed128a93c6"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 16, "review_comments": 14, "maintainer_can_modify": false, "commits": 6, "additions": 899, "deletions": 38, "changed_files": 33}