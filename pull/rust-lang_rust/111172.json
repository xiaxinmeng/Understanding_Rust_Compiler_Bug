{"url": "https://api.github.com/repos/rust-lang/rust/pulls/111172", "id": 1337715995, "node_id": "PR_kwDOAAsO6M5Pu-0b", "html_url": "https://github.com/rust-lang/rust/pull/111172", "diff_url": "https://github.com/rust-lang/rust/pull/111172.diff", "patch_url": "https://github.com/rust-lang/rust/pull/111172.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/111172", "number": 111172, "state": "open", "locked": false, "title": "`-Z trait-solver=next`: Deduplicate region constraints in query responses", "user": {"login": "ndrewxie", "id": 32971598, "node_id": "MDQ6VXNlcjMyOTcxNTk4", "avatar_url": "https://avatars.githubusercontent.com/u/32971598?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ndrewxie", "html_url": "https://github.com/ndrewxie", "followers_url": "https://api.github.com/users/ndrewxie/followers", "following_url": "https://api.github.com/users/ndrewxie/following{/other_user}", "gists_url": "https://api.github.com/users/ndrewxie/gists{/gist_id}", "starred_url": "https://api.github.com/users/ndrewxie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ndrewxie/subscriptions", "organizations_url": "https://api.github.com/users/ndrewxie/orgs", "repos_url": "https://api.github.com/users/ndrewxie/repos", "events_url": "https://api.github.com/users/ndrewxie/events{/privacy}", "received_events_url": "https://api.github.com/users/ndrewxie/received_events", "type": "User", "site_admin": false}, "body": "An attempt at fixing #109764 . \r\n\r\nThis is a MVP version, so I'm opening a PR primarily so others can review and critique it (is this correct protocol? or should a work-in-progress like this be handled differently?). I'm sure there's many points where my implementation is incorrect, but right now it **does** compile all the snippets provided in the issue (which I put into 1 test file called dedup-vars), and doesn't break any other code (at least, nothing that's detected by any tests :P)\r\n\r\nRight now, I'm deduplicating the *output* of canonicalizing the Response - is this correct?\r\n\r\nThe idea is as follows:\r\n- Identify which variables can be deduplicated (i.e. merged if the constraints that involve them are isomorphic). For this version, I assumed that any variable that isn't in the root universe is dedupable, as canonicalization *should* compress all universes nameable from the caller to the root universe - correct?\r\n- For each constraint (region constraints and member constraints), extract all the variables that are present, in order. This logic is handled by constraint-walker.rs. The question is, am I extracting the variables from the constraints correctly (or am I missing some)?\r\n- For each constraint, we then create a \"prototypical\" version of the constraint, which is formed by replacing all variables with a dummy var. Constraints are considered structurally equal if their prototypical version is the same, i.e. they differ only in variables\r\n- The constraint variables, as well as sets of structurally equal constraints is then fed into a dedup solver, which looks for isomorphisms between sets of constraints. The solver returns a set of constraints that can be removed, as well as a set of variables that can be removed\r\n- The constraints and variables returned by the solver are then deleted. My question here is, does the order of constraints (as they're stored in `.outlives` and `.member_constraints`) matter? Right now, I'm not making any effort to preserve this order, but if it's needed I suppose I could do so, it'll just be less clean\r\n- Variable universes are \"compressed\" - this is given in the function compress_variables in dedup_solver/mod.rs. As variables are removed, they leave \"holes\" of unused universes, so I pack the universes in the remaining variables to fill this hole (minimizing the maximum universe in the vars). Is the idea of this sound, or is there something more subtle to universes that I'm missing?\r\n\r\n\r\nAlso just a quick question, what exactly is opaque_types? I couldn't find much documentation about it, and reading the code didn't give any significant clues... Should this deduplication handle that in some way?", "created_at": "2023-05-04T03:28:42Z", "updated_at": "2023-05-29T17:48:48Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "8e70f4dfc6edc283bc8aeb2992db7669182f08c5", "assignee": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 583426710, "node_id": "MDU6TGFiZWw1ODM0MjY3MTA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-review", "name": "S-waiting-on-review", "color": "d3dddd", "default": false, "description": "Status: Awaiting review from the assignee but also interested parties."}, {"id": 4806740265, "node_id": "LA_kwDOAAsO6M8AAAABHoEJKQ", "url": "https://api.github.com/repos/rust-lang/rust/labels/WG-trait-system-refactor", "name": "WG-trait-system-refactor", "color": "c2e0c6", "default": false, "description": "The Rustc Trait System Refactor Initiative"}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/111172/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/111172/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/111172/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/67fbe17e064329a886479ddb34676c2c4099f261", "head": {"label": "ndrewxie:dedup", "ref": "dedup", "sha": "67fbe17e064329a886479ddb34676c2c4099f261", "user": {"login": "ndrewxie", "id": 32971598, "node_id": "MDQ6VXNlcjMyOTcxNTk4", "avatar_url": "https://avatars.githubusercontent.com/u/32971598?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ndrewxie", "html_url": "https://github.com/ndrewxie", "followers_url": "https://api.github.com/users/ndrewxie/followers", "following_url": "https://api.github.com/users/ndrewxie/following{/other_user}", "gists_url": "https://api.github.com/users/ndrewxie/gists{/gist_id}", "starred_url": "https://api.github.com/users/ndrewxie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ndrewxie/subscriptions", "organizations_url": "https://api.github.com/users/ndrewxie/orgs", "repos_url": "https://api.github.com/users/ndrewxie/repos", "events_url": "https://api.github.com/users/ndrewxie/events{/privacy}", "received_events_url": "https://api.github.com/users/ndrewxie/received_events", "type": "User", "site_admin": false}, "repo": {"id": 624216867, "node_id": "R_kgDOJTTLIw", "name": "rust", "full_name": "ndrewxie/rust", "private": false, "owner": {"login": "ndrewxie", "id": 32971598, "node_id": "MDQ6VXNlcjMyOTcxNTk4", "avatar_url": "https://avatars.githubusercontent.com/u/32971598?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ndrewxie", "html_url": "https://github.com/ndrewxie", "followers_url": "https://api.github.com/users/ndrewxie/followers", "following_url": "https://api.github.com/users/ndrewxie/following{/other_user}", "gists_url": "https://api.github.com/users/ndrewxie/gists{/gist_id}", "starred_url": "https://api.github.com/users/ndrewxie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ndrewxie/subscriptions", "organizations_url": "https://api.github.com/users/ndrewxie/orgs", "repos_url": "https://api.github.com/users/ndrewxie/repos", "events_url": "https://api.github.com/users/ndrewxie/events{/privacy}", "received_events_url": "https://api.github.com/users/ndrewxie/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/ndrewxie/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/ndrewxie/rust", "forks_url": "https://api.github.com/repos/ndrewxie/rust/forks", "keys_url": "https://api.github.com/repos/ndrewxie/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/ndrewxie/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/ndrewxie/rust/teams", "hooks_url": "https://api.github.com/repos/ndrewxie/rust/hooks", "issue_events_url": "https://api.github.com/repos/ndrewxie/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/ndrewxie/rust/events", "assignees_url": "https://api.github.com/repos/ndrewxie/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/ndrewxie/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/ndrewxie/rust/tags", "blobs_url": "https://api.github.com/repos/ndrewxie/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/ndrewxie/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/ndrewxie/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/ndrewxie/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/ndrewxie/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/ndrewxie/rust/languages", "stargazers_url": "https://api.github.com/repos/ndrewxie/rust/stargazers", "contributors_url": "https://api.github.com/repos/ndrewxie/rust/contributors", "subscribers_url": "https://api.github.com/repos/ndrewxie/rust/subscribers", "subscription_url": "https://api.github.com/repos/ndrewxie/rust/subscription", "commits_url": "https://api.github.com/repos/ndrewxie/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/ndrewxie/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/ndrewxie/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/ndrewxie/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/ndrewxie/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/ndrewxie/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/ndrewxie/rust/merges", "archive_url": "https://api.github.com/repos/ndrewxie/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/ndrewxie/rust/downloads", "issues_url": "https://api.github.com/repos/ndrewxie/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/ndrewxie/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/ndrewxie/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/ndrewxie/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/ndrewxie/rust/labels{/name}", "releases_url": "https://api.github.com/repos/ndrewxie/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/ndrewxie/rust/deployments", "created_at": "2023-04-06T01:53:16Z", "updated_at": "2023-04-06T02:08:39Z", "pushed_at": "2023-06-12T02:45:16Z", "git_url": "git://github.com/ndrewxie/rust.git", "ssh_url": "git@github.com:ndrewxie/rust.git", "clone_url": "https://github.com/ndrewxie/rust.git", "svn_url": "https://github.com/ndrewxie/rust", "homepage": "https://www.rust-lang.org", "size": 875776, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "source"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "089677eb32af83318467325edbef9b64053df532", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T15:52:25Z", "pushed_at": "2023-06-20T15:52:40Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 931034, "stargazers_count": 82780, "watchers_count": 82780, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10968, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9625, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10968, "open_issues": 9625, "watchers": 82780, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111172"}, "html": {"href": "https://github.com/rust-lang/rust/pull/111172"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/111172"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/111172/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111172/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/111172/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/67fbe17e064329a886479ddb34676c2c4099f261"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": null, "rebaseable": null, "mergeable_state": "unknown", "merged_by": null, "comments": 17, "review_comments": 6, "maintainer_can_modify": true, "commits": 16, "additions": 901, "deletions": 5, "changed_files": 7}