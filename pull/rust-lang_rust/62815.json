{"url": "https://api.github.com/repos/rust-lang/rust/pulls/62815", "id": 299512852, "node_id": "MDExOlB1bGxSZXF1ZXN0Mjk5NTEyODUy", "html_url": "https://github.com/rust-lang/rust/pull/62815", "diff_url": "https://github.com/rust-lang/rust/pull/62815.diff", "patch_url": "https://github.com/rust-lang/rust/pull/62815.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/62815", "number": 62815, "state": "closed", "locked": false, "title": "[WIP] Impl Debug, Hash, PartialEq, Eq, PartialOrd, Ord, Default for closures", "user": {"login": "luca-barbieri", "id": 298418, "node_id": "MDQ6VXNlcjI5ODQxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/298418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luca-barbieri", "html_url": "https://github.com/luca-barbieri", "followers_url": "https://api.github.com/users/luca-barbieri/followers", "following_url": "https://api.github.com/users/luca-barbieri/following{/other_user}", "gists_url": "https://api.github.com/users/luca-barbieri/gists{/gist_id}", "starred_url": "https://api.github.com/users/luca-barbieri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luca-barbieri/subscriptions", "organizations_url": "https://api.github.com/users/luca-barbieri/orgs", "repos_url": "https://api.github.com/users/luca-barbieri/repos", "events_url": "https://api.github.com/users/luca-barbieri/events{/privacy}", "received_events_url": "https://api.github.com/users/luca-barbieri/received_events", "type": "User", "site_admin": false}, "body": "This pull request implements these traits for closures in addition to the Copy and Clone that the compiler already supports, as well as allowing crates to implement their custom traits for closures.\r\n\r\n# Motivation\r\n\r\nAs for motivation, there is the \"serde_closure\" crate that does this by re-implementing closures with a macro (except it can't automatically detect upvars), and in general Debug is useful for debugging, while the other traits are useful to determine whether instances of a closure are equal, which can allow to avoid re-calling the closure and instead using a memoized result (when the API requires the closure to be a pure function): this is useful for instance for React-like WebAssembly frameworks where a component may take as props closures that generate subcomponents and that should not be called again if props is set to props equal to the old props (which requires an impl of Eq for closures).\r\n\r\n# Implementation\r\n\r\nThis code uses a clever technique that allows to add this feature with minimal effort and maximal flexibility:\r\n1. Each closure now implements a Closure trait\r\n2. The Closure impl has an Inner associated type that consists of a tuple with the same layout of the closure (we use a tuple of the upvars followed by the new marker LayoutAs<T>)\r\n3. We add blanket impls of Debug, Hash, PartialEq, Eq, PartialOrd, Ord, Default for T: Closure conditional on <T as Closure>::Inner implementing the traits (we special-case the Closure trait in coherence.rs to make this work).\r\n4. This results in the already existing implementations for tuples being reused for closures\r\n\r\nThe advantage of this strategy is that it does not require any code to generate implementations of specific \r\ntraits, and allows to implement custom traits on closures without changing the compiler.\r\n\r\n# Drawbacks\r\n\r\nThe first drawback is that we inherit the tuple length limit on the impls. However, that needs to be fixed for tuples anyway, and the fix will fix closures as well.\r\n\r\nAnother apparent drawback that should however not be an issue is that we expose closures as tuples, allowing code to know about the upvar types. Since we use a special layout marker that includes the closure type and that can't be instantiated otherwise, this does not limit the ability to do profile-guided layout or in general to change closure layout in an arbitrary way. Also, closures are semantically a tuple of their upvars so exposing this should not be a problem.\r\n\r\nWe also expose an ordering of the upvars. However, there is a canonical ordering, which is the order of the source code position of the first mention of the upvar, that I hope the compiler is currently using and if so there seems to be no reason to change it.\r\n\r\n# Alternatives\r\n\r\nAdapting the #[derive] code is not easily possible because it's broken (generates incorrect type bounds) and because it's based on the AST, and in that phase we don't even know what the upvars are.\r\n\r\nGenerating MIR like for the Clone shim is possible, but it requires ad-hoc code and wouldn't allow to implement for instance the serde traits without adding even more ad-hoc code to the compiler; on the other hand, the approach in this pull request allows to reuse trait implementations for tuples.\r\n\r\n# Shortcomings\r\n\r\nThe current implementation seems to work but has:\r\n- No feature gating, immediately stable\r\n- No RFC\r\n- No tests\r\n\r\n# Conclusion\r\n\r\nLet me know if this is considered a viable approach, and whether you would like a feature gate, RFC, or tests.\r\n", "created_at": "2019-07-19T23:17:12Z", "updated_at": "2019-08-28T18:14:57Z", "closed_at": "2019-08-28T18:14:57Z", "merged_at": null, "merge_commit_sha": "3fb28669256d39c96e97e74a80e799efc6204ff0", "assignee": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 122406831, "node_id": "MDU6TGFiZWwxMjI0MDY4MzE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/A-closures", "name": "A-closures", "color": "f7e101", "default": false, "description": "Area: closures (`|args| { .. }`)"}, {"id": 211668019, "node_id": "MDU6TGFiZWwyMTE2NjgwMTk=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-lang", "name": "T-lang", "color": "bfd4f2", "default": false, "description": "Relevant to the language team, which will review and decide on the PR/issue."}, {"id": 211668062, "node_id": "MDU6TGFiZWwyMTE2NjgwNjI=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-libs-api", "name": "T-libs-api", "color": "bfd4f2", "default": false, "description": "Relevant to the library API team, which will review and decide on the PR/issue."}, {"id": 627350354, "node_id": "MDU6TGFiZWw2MjczNTAzNTQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-inactive", "name": "S-inactive", "color": "d3dddd", "default": false, "description": "Status: Inactive and waiting on the author. This is often applied to closed PRs."}, {"id": 1089771154, "node_id": "MDU6TGFiZWwxMDg5NzcxMTU0", "url": "https://api.github.com/repos/rust-lang/rust/labels/needs-rfc", "name": "needs-rfc", "color": "fceb9f", "default": false, "description": "This change is large or controversial enough that it should have an (e-)RFC accepted before doing it"}], "milestone": null, "draft": true, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/62815/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/62815/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/62815/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/e2d5489cb6c53b259e002a38dc4d87714e1bc243", "head": {"label": "luca-barbieri:closure_traits", "ref": "closure_traits", "sha": "e2d5489cb6c53b259e002a38dc4d87714e1bc243", "user": {"login": "luca-barbieri", "id": 298418, "node_id": "MDQ6VXNlcjI5ODQxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/298418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luca-barbieri", "html_url": "https://github.com/luca-barbieri", "followers_url": "https://api.github.com/users/luca-barbieri/followers", "following_url": "https://api.github.com/users/luca-barbieri/following{/other_user}", "gists_url": "https://api.github.com/users/luca-barbieri/gists{/gist_id}", "starred_url": "https://api.github.com/users/luca-barbieri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luca-barbieri/subscriptions", "organizations_url": "https://api.github.com/users/luca-barbieri/orgs", "repos_url": "https://api.github.com/users/luca-barbieri/repos", "events_url": "https://api.github.com/users/luca-barbieri/events{/privacy}", "received_events_url": "https://api.github.com/users/luca-barbieri/received_events", "type": "User", "site_admin": false}, "repo": {"id": 197373588, "node_id": "MDEwOlJlcG9zaXRvcnkxOTczNzM1ODg=", "name": "rust", "full_name": "luca-barbieri/rust", "private": false, "owner": {"login": "luca-barbieri", "id": 298418, "node_id": "MDQ6VXNlcjI5ODQxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/298418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luca-barbieri", "html_url": "https://github.com/luca-barbieri", "followers_url": "https://api.github.com/users/luca-barbieri/followers", "following_url": "https://api.github.com/users/luca-barbieri/following{/other_user}", "gists_url": "https://api.github.com/users/luca-barbieri/gists{/gist_id}", "starred_url": "https://api.github.com/users/luca-barbieri/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luca-barbieri/subscriptions", "organizations_url": "https://api.github.com/users/luca-barbieri/orgs", "repos_url": "https://api.github.com/users/luca-barbieri/repos", "events_url": "https://api.github.com/users/luca-barbieri/events{/privacy}", "received_events_url": "https://api.github.com/users/luca-barbieri/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/luca-barbieri/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": true, "url": "https://api.github.com/repos/luca-barbieri/rust", "forks_url": "https://api.github.com/repos/luca-barbieri/rust/forks", "keys_url": "https://api.github.com/repos/luca-barbieri/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/luca-barbieri/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/luca-barbieri/rust/teams", "hooks_url": "https://api.github.com/repos/luca-barbieri/rust/hooks", "issue_events_url": "https://api.github.com/repos/luca-barbieri/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/luca-barbieri/rust/events", "assignees_url": "https://api.github.com/repos/luca-barbieri/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/luca-barbieri/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/luca-barbieri/rust/tags", "blobs_url": "https://api.github.com/repos/luca-barbieri/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/luca-barbieri/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/luca-barbieri/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/luca-barbieri/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/luca-barbieri/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/luca-barbieri/rust/languages", "stargazers_url": "https://api.github.com/repos/luca-barbieri/rust/stargazers", "contributors_url": "https://api.github.com/repos/luca-barbieri/rust/contributors", "subscribers_url": "https://api.github.com/repos/luca-barbieri/rust/subscribers", "subscription_url": "https://api.github.com/repos/luca-barbieri/rust/subscription", "commits_url": "https://api.github.com/repos/luca-barbieri/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/luca-barbieri/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/luca-barbieri/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/luca-barbieri/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/luca-barbieri/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/luca-barbieri/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/luca-barbieri/rust/merges", "archive_url": "https://api.github.com/repos/luca-barbieri/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/luca-barbieri/rust/downloads", "issues_url": "https://api.github.com/repos/luca-barbieri/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/luca-barbieri/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/luca-barbieri/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/luca-barbieri/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/luca-barbieri/rust/labels{/name}", "releases_url": "https://api.github.com/repos/luca-barbieri/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/luca-barbieri/rust/deployments", "created_at": "2019-07-17T11:09:36Z", "updated_at": "2020-04-03T18:02:44Z", "pushed_at": "2020-04-10T20:43:31Z", "git_url": "git://github.com/luca-barbieri/rust.git", "ssh_url": "git@github.com:luca-barbieri/rust.git", "clone_url": "https://github.com/luca-barbieri/rust.git", "svn_url": "https://github.com/luca-barbieri/rust", "homepage": "https://www.rust-lang.org", "size": 504618, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "e3cebcb3bd4ffaf86bb0cdfd2af5b7e698717b01", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T10:22:09Z", "pushed_at": "2023-06-19T11:26:02Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 920473, "stargazers_count": 82742, "watchers_count": 82742, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9630, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9630, "watchers": 82742, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/62815"}, "html": {"href": "https://github.com/rust-lang/rust/pull/62815"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/62815"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/62815/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/62815/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/62815/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/e2d5489cb6c53b259e002a38dc4d87714e1bc243"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 16, "review_comments": 0, "maintainer_can_modify": false, "commits": 1, "additions": 320, "deletions": 14, "changed_files": 12}