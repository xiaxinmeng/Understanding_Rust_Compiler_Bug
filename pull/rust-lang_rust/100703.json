{"url": "https://api.github.com/repos/rust-lang/rust/pulls/100703", "id": 1029365819, "node_id": "PR_kwDOAAsO6M49WuA7", "html_url": "https://github.com/rust-lang/rust/pull/100703", "diff_url": "https://github.com/rust-lang/rust/pull/100703.diff", "patch_url": "https://github.com/rust-lang/rust/pull/100703.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/100703", "number": 100703, "state": "open", "locked": false, "title": "[WIP]: raw-dylib support for apple targets", "user": {"login": "roblabla", "id": 1069318, "node_id": "MDQ6VXNlcjEwNjkzMTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1069318?v=4", "gravatar_id": "", "url": "https://api.github.com/users/roblabla", "html_url": "https://github.com/roblabla", "followers_url": "https://api.github.com/users/roblabla/followers", "following_url": "https://api.github.com/users/roblabla/following{/other_user}", "gists_url": "https://api.github.com/users/roblabla/gists{/gist_id}", "starred_url": "https://api.github.com/users/roblabla/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/roblabla/subscriptions", "organizations_url": "https://api.github.com/users/roblabla/orgs", "repos_url": "https://api.github.com/users/roblabla/repos", "events_url": "https://api.github.com/users/roblabla/events{/privacy}", "received_events_url": "https://api.github.com/users/roblabla/received_events", "type": "User", "site_admin": false}, "body": "CC #58713\r\n\r\nThis PR adds macos support to raw-dylib. This works by generating a `.tbd` file for each library using LLVM's TextAPI functions, and linking against them. `.tbd` files are an official Apple format representing the exports of a dylib as YAML, whose format is documented [here](https://github.com/apple-opensource/tapi/blob/master/docs/TBD.rst). LLVM's TextAPI provides an easy-to-use API to produce (and consume) those files.\r\n\r\nApple targets bring several complications to the raw-dylib support:\r\n\r\n## No runtime dylib search path\r\n\r\n`dyld`, the mach-o loader, does not have a default search path to find the shared libraries (or dylibs). Instead, there are five ways to define a shared lib:\r\n\r\n- Absolute path (`/usr/lib/libEndpointSecurity.dylib`): This is how system deps usually end up in a macho. You get an absolute path like \r\n- Relative path: Those get loaded relative to the current working directory. This is almost always wrong.\r\n- `@loader_path/libEndpointSecurity.dylib`: These are loaded relative to the entity that caused the shared lib to load (the mach-o binary or intermediate shared lib). This can be useful when storing libs next to the binary, or plugins next to a lib.\r\n- `@executable_path/libEndpointSecurity.dylib`: Similar to the above, but always relative to the binary.\r\n- `@rpath/libEndpointSecurity.dylib`: RPATH is the closest thing to a search path, but is hardcoded in the mach-o. Essentially, a mach-o will have an `LC_RPATH` load command that specifies the list of paths to look into for libs. By default, the linker does *not* set an RPATH.\r\n\r\nCurrently, we just use whatever is in `link(name)`. The user may specify the full name in the `#[link(name)]`, e.g.\r\n\r\n```rust\r\n#[link(name = \"/usr/lib/libEndpointSecurity.dylib\", kind = \"raw-dylib\", modifiers = \"+verbatim\")]\r\nextern \"C\" { /* ... */ }\r\n```\r\n\r\nAn alternative solution could be to have a separate attribute for the directory, like `#[link(name = \"EndpointSecurity\", install_path = \"/usr/lib\", kind = \"raw-dylib\")]`.\r\n\r\n## `ar` files\r\n\r\nUnlike Windows `lib` files, which can contain `.dll` files containing the symbols to import along with the `.obj` files, macOS (and indeed, linux) `ar` archives do not have a way to specify external symbol dependencies (at least, not that I'm aware!). Those have to be specified separately to the final linking step.\r\n\r\nTo work around this issue, we cheat a bit. When building an `rlib`, the `tbd` is inserted *into* the `rlib`, so it can be extracted and linked against during the final linking step. This is... not exactly elegant. But it works and was the easiest solution I could think of. \r\n\r\nCurrently, the `link(name)` attribute is used as the filename to use when storing the `ar` archive (meaning, our `ar` archive will have a file named `/usr/lib/libEndpointSecurity.dylib.tbd`. It may be worth adding a prefix to the filename or something?\r\n\r\n## Additional attributes\r\n\r\nMach-O additionally encodes two pieces of information with every shared library in its LC_LOAD_DYLIB command: the `current_version`, and the `compatibility_version`. `compatibility_version` in particular is used by `dyld` to figure out if the dylib on the system is new enough to link properly with the current application.\r\n\r\nThis PR currently sets both of those to 0 - and that seems to work well enough, at least for my use-cases. But we could imagine adding new attributes for them if they're necessary.\r\n\r\n# Status\r\n\r\nThis PR *works*, but is still kinda prototypical. I need to add some unit tests to ensure it works in a vast variety of scenarios (unfortunately, a lot of the windows tests don't work as-is for macos due to the above limitations). The goal here is mostly to get feedback on the current approach, maybe get some ideas bouncing on if there's another way to approach the issues here.\r\n\r\nCC @joshtriplett ", "created_at": "2022-08-17T22:54:17Z", "updated_at": "2023-02-23T06:41:43Z", "closed_at": null, "merged_at": null, "merge_commit_sha": "6b2b3c01374ca3d51ee537d0900ca29af8531b1c", "assignee": null, "assignees": [], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 123111, "node_id": "MDU6TGFiZWwxMjMxMTE=", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-macos", "name": "O-macos", "color": "6e6ec0", "default": false, "description": "Operating system: macOS"}, {"id": 38105576, "node_id": "MDU6TGFiZWwzODEwNTU3Ng==", "url": "https://api.github.com/repos/rust-lang/rust/labels/O-ios", "name": "O-ios", "color": "6e6ec0", "default": false, "description": "Operating system: iOS"}, {"id": 211668100, "node_id": "MDU6TGFiZWwyMTE2NjgxMDA=", "url": "https://api.github.com/repos/rust-lang/rust/labels/T-compiler", "name": "T-compiler", "color": "bfd4f2", "default": false, "description": "Relevant to the compiler team, which will review and decide on the PR/issue."}, {"id": 583436937, "node_id": "MDU6TGFiZWw1ODM0MzY5Mzc=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-waiting-on-author", "name": "S-waiting-on-author", "color": "d3dddd", "default": false, "description": "Status: This is awaiting some action (such as code changes or more information) from the author."}], "milestone": null, "draft": true, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/100703/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/100703/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/100703/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/9eb2cdf8bd15f6224b28245f4f1d0043561f5c85", "head": {"label": "roblabla:raw-dylib-macos", "ref": "raw-dylib-macos", "sha": "9eb2cdf8bd15f6224b28245f4f1d0043561f5c85", "user": {"login": "roblabla", "id": 1069318, "node_id": "MDQ6VXNlcjEwNjkzMTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1069318?v=4", "gravatar_id": "", "url": "https://api.github.com/users/roblabla", "html_url": "https://github.com/roblabla", "followers_url": "https://api.github.com/users/roblabla/followers", "following_url": "https://api.github.com/users/roblabla/following{/other_user}", "gists_url": "https://api.github.com/users/roblabla/gists{/gist_id}", "starred_url": "https://api.github.com/users/roblabla/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/roblabla/subscriptions", "organizations_url": "https://api.github.com/users/roblabla/orgs", "repos_url": "https://api.github.com/users/roblabla/repos", "events_url": "https://api.github.com/users/roblabla/events{/privacy}", "received_events_url": "https://api.github.com/users/roblabla/received_events", "type": "User", "site_admin": false}, "repo": {"id": 97513058, "node_id": "MDEwOlJlcG9zaXRvcnk5NzUxMzA1OA==", "name": "rust", "full_name": "roblabla/rust", "private": false, "owner": {"login": "roblabla", "id": 1069318, "node_id": "MDQ6VXNlcjEwNjkzMTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1069318?v=4", "gravatar_id": "", "url": "https://api.github.com/users/roblabla", "html_url": "https://github.com/roblabla", "followers_url": "https://api.github.com/users/roblabla/followers", "following_url": "https://api.github.com/users/roblabla/following{/other_user}", "gists_url": "https://api.github.com/users/roblabla/gists{/gist_id}", "starred_url": "https://api.github.com/users/roblabla/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/roblabla/subscriptions", "organizations_url": "https://api.github.com/users/roblabla/orgs", "repos_url": "https://api.github.com/users/roblabla/repos", "events_url": "https://api.github.com/users/roblabla/events{/privacy}", "received_events_url": "https://api.github.com/users/roblabla/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/roblabla/rust", "description": "A safe, concurrent, practical language.", "fork": true, "url": "https://api.github.com/repos/roblabla/rust", "forks_url": "https://api.github.com/repos/roblabla/rust/forks", "keys_url": "https://api.github.com/repos/roblabla/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/roblabla/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/roblabla/rust/teams", "hooks_url": "https://api.github.com/repos/roblabla/rust/hooks", "issue_events_url": "https://api.github.com/repos/roblabla/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/roblabla/rust/events", "assignees_url": "https://api.github.com/repos/roblabla/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/roblabla/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/roblabla/rust/tags", "blobs_url": "https://api.github.com/repos/roblabla/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/roblabla/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/roblabla/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/roblabla/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/roblabla/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/roblabla/rust/languages", "stargazers_url": "https://api.github.com/repos/roblabla/rust/stargazers", "contributors_url": "https://api.github.com/repos/roblabla/rust/contributors", "subscribers_url": "https://api.github.com/repos/roblabla/rust/subscribers", "subscription_url": "https://api.github.com/repos/roblabla/rust/subscription", "commits_url": "https://api.github.com/repos/roblabla/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/roblabla/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/roblabla/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/roblabla/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/roblabla/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/roblabla/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/roblabla/rust/merges", "archive_url": "https://api.github.com/repos/roblabla/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/roblabla/rust/downloads", "issues_url": "https://api.github.com/repos/roblabla/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/roblabla/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/roblabla/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/roblabla/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/roblabla/rust/labels{/name}", "releases_url": "https://api.github.com/repos/roblabla/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/roblabla/rust/deployments", "created_at": "2017-07-17T19:14:00Z", "updated_at": "2019-03-21T10:50:30Z", "pushed_at": "2022-12-04T17:09:08Z", "git_url": "git://github.com/roblabla/rust.git", "ssh_url": "git@github.com:roblabla/rust.git", "clone_url": "https://github.com/roblabla/rust.git", "svn_url": "https://github.com/roblabla/rust", "homepage": "https://www.rust-lang.org", "size": 929962, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "999ac5f7770bff68bd65f490990d32c3ec1faaa6", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-20T05:47:10Z", "pushed_at": "2023-06-20T05:32:43Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 930404, "stargazers_count": 82764, "watchers_count": 82764, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10964, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9633, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10964, "open_issues": 9633, "watchers": 82764, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/100703"}, "html": {"href": "https://github.com/rust-lang/rust/pull/100703"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/100703"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/100703/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/100703/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/100703/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/9eb2cdf8bd15f6224b28245f4f1d0043561f5c85"}}, "author_association": "CONTRIBUTOR", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 11, "review_comments": 0, "maintainer_can_modify": true, "commits": 2, "additions": 172, "deletions": 33, "changed_files": 5}