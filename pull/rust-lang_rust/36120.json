{"url": "https://api.github.com/repos/rust-lang/rust/pulls/36120", "id": 83177800, "node_id": "MDExOlB1bGxSZXF1ZXN0ODMxNzc4MDA=", "html_url": "https://github.com/rust-lang/rust/pull/36120", "diff_url": "https://github.com/rust-lang/rust/pull/36120.diff", "patch_url": "https://github.com/rust-lang/rust/pull/36120.patch", "issue_url": "https://api.github.com/repos/rust-lang/rust/issues/36120", "number": 36120, "state": "closed", "locked": false, "title": "[WIP] internal lld linker", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "body": "this commit embeds lld, the LLVM linker, into rustc. If the `-Z use-lld`\nflag is passed to rustc, then rustc will use lld (via a library call),\ninstead of an external linker like cc, to link a Rust executable.\n\nThis has been tested in three different ways: \n- Linking Hello World, but the `-pie` flag had to be omitted:\n\nNote that lld doesn't implicitly pass libraries (-lc) or startup\nobject (crt1.o) like cc does, so one has to manually pass these to lld\nvia `-C link-args`:\n\n```\n$ rustc -Z use-lld \\\n        -C link-args='-dynamic-linker /lib64/ld-linux-x86-64.so.2 -L/usr/lib/gcc/x86_64-linux-gnu/5 -L/usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/crt1.o /usr/lib/x86_64-linux-gnu/crti.o /usr/lib/x86_64-linux-gnu/crtn.o'\n        hello.rs\n\n$ ./hello\nHello world!\n```\n- Linking a Rust program with zero C dependencies, i.e. a Rust \"kernel\".\n  Basically, I grabbed the \"Hello, world\" program from Intermezzos chapter 3 [1](http://intermezzos.github.io/book/booting-up.html)\n  and turned it into a Cargo project [2](https://github.com/japaric/eighty-six/tree/lld2) then proceeded to link it using lld.\n\nThis linked correctly and after turning the executable into a ISO image,\nit also worked perfectly under QEMU!\n- Linking A bare metal program for the Cortex-M3 microcontroller.\n\nThis didn't require a toolchain (`arm-none-eabi-gcc`) or startup files\n(`newlib`). This test has been turned into a run-make test for this feature.\n### Extra notes\n\nI've only tested ELF executables, not dylibs, MachO or COFF.\n\nlld supports ELFs, MachO and COFF formats. So in theory, with an\ninternal lld we could drop the dependency on a external linker pretty\nmuch on all the platforms we support.\n\nRelevant news: \"lld now implements almost all of the functionality\nnecessary to function as a system linker for FreeBSD/amd64\" -- FreeBSD\nfolk @ LLVM mailing list [3](http://lists.llvm.org/pipermail/llvm-dev/2016-August/103998.html). The e-mail also mentions that\nsupport for other archs is not quite ready for prime time.\n\n---\n\nThe question is: Would it make sense to start slowly integrating lld\ninto rustc _right now_? It would land behind an unstable flag '-Z\nuse-lld' and we could print a warning message about it being\nexperimental whenever the flag is used.\n\nScenarios where it could be advantageous to not depend on a external\nlinker:\n- Building bare-metal/C-free programs, e.g. x86 kernel\n  development (already shown to work), embedded (microcontroller) ARM\n  programs (once lld supports Thumb). Today, to build C-free Rust\n  programs you still need a C linker (cc). Would be nice to drop the\n  dependency on cc if you are not going to compile C code.\n- @Diggsey mention that lld + the arm-musl targets effectively means one\n  can cross compile ARM binaries without relying on anything external:\n  no need for arm-gcc or arm-glibc. Just `rustup target add $T` and\n  `cargo build --target $T` and you are done. This scenario hasn't been\n  tested though.\n\nDownsides:\n- lld is still being actively developed. some architectures have limited\n  support and features like linker scripts are not on parity with ld\n  yet. However, as mentioned above, the FreeBSD folks have had success\n  using it as a system linker on x86_64. At least, that architecture\n  appears to be reaching stability.\n- Maintenance. Upgrading LLVM means also having upgrading lld as those\n  need to be keep in sync or lld won't compile. This cuts both ways: if\n  we want to upgrade lld to support some new feature or fix some bug,\n  it's likely we'll have to upgrade LLVM as well -- this possibly means\n  updating LLVM more often.\n\nP.S. This a PoC; the implementation is a mess/hack. It would have to be\ncleaned up before merging it.\n\ncc #9367\ncc @alexcrichton @brson\n", "created_at": "2016-08-29T22:18:25Z", "updated_at": "2020-08-29T02:47:22Z", "closed_at": "2016-10-31T20:32:27Z", "merged_at": null, "merge_commit_sha": "a6591a09550a778743f5bdf383a028c11c68e066", "assignee": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}], "requested_reviewers": [], "requested_teams": [], "labels": [{"id": 627350354, "node_id": "MDU6TGFiZWw2MjczNTAzNTQ=", "url": "https://api.github.com/repos/rust-lang/rust/labels/S-inactive", "name": "S-inactive", "color": "d3dddd", "default": false, "description": "Status: Inactive and waiting on the author. This is often applied to closed PRs."}], "milestone": null, "draft": false, "commits_url": "https://api.github.com/repos/rust-lang/rust/pulls/36120/commits", "review_comments_url": "https://api.github.com/repos/rust-lang/rust/pulls/36120/comments", "review_comment_url": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}", "comments_url": "https://api.github.com/repos/rust-lang/rust/issues/36120/comments", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/a4620cc466f391504b26d4cfc91c8b09f893cabc", "head": {"label": "japaric:lld", "ref": "lld", "sha": "a4620cc466f391504b26d4cfc91c8b09f893cabc", "user": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "repo": {"id": 17873870, "node_id": "MDEwOlJlcG9zaXRvcnkxNzg3Mzg3MA==", "name": "rust", "full_name": "japaric/rust", "private": false, "owner": {"login": "japaric", "id": 5018213, "node_id": "MDQ6VXNlcjUwMTgyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5018213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/japaric", "html_url": "https://github.com/japaric", "followers_url": "https://api.github.com/users/japaric/followers", "following_url": "https://api.github.com/users/japaric/following{/other_user}", "gists_url": "https://api.github.com/users/japaric/gists{/gist_id}", "starred_url": "https://api.github.com/users/japaric/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/japaric/subscriptions", "organizations_url": "https://api.github.com/users/japaric/orgs", "repos_url": "https://api.github.com/users/japaric/repos", "events_url": "https://api.github.com/users/japaric/events{/privacy}", "received_events_url": "https://api.github.com/users/japaric/received_events", "type": "User", "site_admin": false}, "html_url": "https://github.com/japaric/rust", "description": "a safe, concurrent, practical language", "fork": true, "url": "https://api.github.com/repos/japaric/rust", "forks_url": "https://api.github.com/repos/japaric/rust/forks", "keys_url": "https://api.github.com/repos/japaric/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/japaric/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/japaric/rust/teams", "hooks_url": "https://api.github.com/repos/japaric/rust/hooks", "issue_events_url": "https://api.github.com/repos/japaric/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/japaric/rust/events", "assignees_url": "https://api.github.com/repos/japaric/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/japaric/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/japaric/rust/tags", "blobs_url": "https://api.github.com/repos/japaric/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/japaric/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/japaric/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/japaric/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/japaric/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/japaric/rust/languages", "stargazers_url": "https://api.github.com/repos/japaric/rust/stargazers", "contributors_url": "https://api.github.com/repos/japaric/rust/contributors", "subscribers_url": "https://api.github.com/repos/japaric/rust/subscribers", "subscription_url": "https://api.github.com/repos/japaric/rust/subscription", "commits_url": "https://api.github.com/repos/japaric/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/japaric/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/japaric/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/japaric/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/japaric/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/japaric/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/japaric/rust/merges", "archive_url": "https://api.github.com/repos/japaric/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/japaric/rust/downloads", "issues_url": "https://api.github.com/repos/japaric/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/japaric/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/japaric/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/japaric/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/japaric/rust/labels{/name}", "releases_url": "https://api.github.com/repos/japaric/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/japaric/rust/deployments", "created_at": "2014-03-18T16:51:45Z", "updated_at": "2020-01-15T15:08:04Z", "pushed_at": "2022-06-27T10:37:14Z", "git_url": "git://github.com/japaric/rust.git", "ssh_url": "git@github.com:japaric/rust.git", "clone_url": "https://github.com/japaric/rust.git", "svn_url": "https://github.com/japaric/rust", "homepage": "http://www.rust-lang.org", "size": 837392, "stargazers_count": 0, "watchers_count": 0, "language": "Rust", "has_issues": false, "has_projects": true, "has_downloads": true, "has_wiki": true, "has_pages": false, "has_discussions": false, "forks_count": 0, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 0, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": [], "visibility": "public", "forks": 0, "open_issues": 0, "watchers": 0, "default_branch": "master"}}, "base": {"label": "rust-lang:master", "ref": "master", "sha": "d1acabeaa204db9235d9e72c5bae4cfaa82da763", "user": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "repo": {"id": 724712, "node_id": "MDEwOlJlcG9zaXRvcnk3MjQ3MTI=", "name": "rust", "full_name": "rust-lang/rust", "private": false, "owner": {"login": "rust-lang", "id": 5430905, "node_id": "MDEyOk9yZ2FuaXphdGlvbjU0MzA5MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/5430905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rust-lang", "html_url": "https://github.com/rust-lang", "followers_url": "https://api.github.com/users/rust-lang/followers", "following_url": "https://api.github.com/users/rust-lang/following{/other_user}", "gists_url": "https://api.github.com/users/rust-lang/gists{/gist_id}", "starred_url": "https://api.github.com/users/rust-lang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rust-lang/subscriptions", "organizations_url": "https://api.github.com/users/rust-lang/orgs", "repos_url": "https://api.github.com/users/rust-lang/repos", "events_url": "https://api.github.com/users/rust-lang/events{/privacy}", "received_events_url": "https://api.github.com/users/rust-lang/received_events", "type": "Organization", "site_admin": false}, "html_url": "https://github.com/rust-lang/rust", "description": "Empowering everyone to build reliable and efficient software.", "fork": false, "url": "https://api.github.com/repos/rust-lang/rust", "forks_url": "https://api.github.com/repos/rust-lang/rust/forks", "keys_url": "https://api.github.com/repos/rust-lang/rust/keys{/key_id}", "collaborators_url": "https://api.github.com/repos/rust-lang/rust/collaborators{/collaborator}", "teams_url": "https://api.github.com/repos/rust-lang/rust/teams", "hooks_url": "https://api.github.com/repos/rust-lang/rust/hooks", "issue_events_url": "https://api.github.com/repos/rust-lang/rust/issues/events{/number}", "events_url": "https://api.github.com/repos/rust-lang/rust/events", "assignees_url": "https://api.github.com/repos/rust-lang/rust/assignees{/user}", "branches_url": "https://api.github.com/repos/rust-lang/rust/branches{/branch}", "tags_url": "https://api.github.com/repos/rust-lang/rust/tags", "blobs_url": "https://api.github.com/repos/rust-lang/rust/git/blobs{/sha}", "git_tags_url": "https://api.github.com/repos/rust-lang/rust/git/tags{/sha}", "git_refs_url": "https://api.github.com/repos/rust-lang/rust/git/refs{/sha}", "trees_url": "https://api.github.com/repos/rust-lang/rust/git/trees{/sha}", "statuses_url": "https://api.github.com/repos/rust-lang/rust/statuses/{sha}", "languages_url": "https://api.github.com/repos/rust-lang/rust/languages", "stargazers_url": "https://api.github.com/repos/rust-lang/rust/stargazers", "contributors_url": "https://api.github.com/repos/rust-lang/rust/contributors", "subscribers_url": "https://api.github.com/repos/rust-lang/rust/subscribers", "subscription_url": "https://api.github.com/repos/rust-lang/rust/subscription", "commits_url": "https://api.github.com/repos/rust-lang/rust/commits{/sha}", "git_commits_url": "https://api.github.com/repos/rust-lang/rust/git/commits{/sha}", "comments_url": "https://api.github.com/repos/rust-lang/rust/comments{/number}", "issue_comment_url": "https://api.github.com/repos/rust-lang/rust/issues/comments{/number}", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/{+path}", "compare_url": "https://api.github.com/repos/rust-lang/rust/compare/{base}...{head}", "merges_url": "https://api.github.com/repos/rust-lang/rust/merges", "archive_url": "https://api.github.com/repos/rust-lang/rust/{archive_format}{/ref}", "downloads_url": "https://api.github.com/repos/rust-lang/rust/downloads", "issues_url": "https://api.github.com/repos/rust-lang/rust/issues{/number}", "pulls_url": "https://api.github.com/repos/rust-lang/rust/pulls{/number}", "milestones_url": "https://api.github.com/repos/rust-lang/rust/milestones{/number}", "notifications_url": "https://api.github.com/repos/rust-lang/rust/notifications{?since,all,participating}", "labels_url": "https://api.github.com/repos/rust-lang/rust/labels{/name}", "releases_url": "https://api.github.com/repos/rust-lang/rust/releases{/id}", "deployments_url": "https://api.github.com/repos/rust-lang/rust/deployments", "created_at": "2010-06-16T20:39:03Z", "updated_at": "2023-06-19T10:22:09Z", "pushed_at": "2023-06-19T10:41:44Z", "git_url": "git://github.com/rust-lang/rust.git", "ssh_url": "git@github.com:rust-lang/rust.git", "clone_url": "https://github.com/rust-lang/rust.git", "svn_url": "https://github.com/rust-lang/rust", "homepage": "https://www.rust-lang.org", "size": 919641, "stargazers_count": 82742, "watchers_count": 82742, "language": "Rust", "has_issues": true, "has_projects": true, "has_downloads": true, "has_wiki": false, "has_pages": false, "has_discussions": false, "forks_count": 10956, "mirror_url": null, "archived": false, "disabled": false, "open_issues_count": 9630, "license": {"key": "other", "name": "Other", "spdx_id": "NOASSERTION", "url": null, "node_id": "MDc6TGljZW5zZTA="}, "allow_forking": true, "is_template": false, "web_commit_signoff_required": false, "topics": ["compiler", "hacktoberfest", "language", "rust"], "visibility": "public", "forks": 10956, "open_issues": 9630, "watchers": 82742, "default_branch": "master"}}, "_links": {"self": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/36120"}, "html": {"href": "https://github.com/rust-lang/rust/pull/36120"}, "issue": {"href": "https://api.github.com/repos/rust-lang/rust/issues/36120"}, "comments": {"href": "https://api.github.com/repos/rust-lang/rust/issues/36120/comments"}, "review_comments": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/36120/comments"}, "review_comment": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/rust-lang/rust/pulls/36120/commits"}, "statuses": {"href": "https://api.github.com/repos/rust-lang/rust/statuses/a4620cc466f391504b26d4cfc91c8b09f893cabc"}}, "author_association": "MEMBER", "auto_merge": null, "active_lock_reason": null, "merged": false, "mergeable": false, "rebaseable": false, "mergeable_state": "dirty", "merged_by": null, "comments": 46, "review_comments": 0, "maintainer_can_modify": false, "commits": 9, "additions": 557, "deletions": 17, "changed_files": 28}